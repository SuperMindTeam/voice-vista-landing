var _y=Object.defineProperty;var xy=(zt,Tt,rt)=>Tt in zt?_y(zt,Tt,{enumerable:!0,configurable:!0,writable:!0,value:rt}):zt[Tt]=rt;var ae=(zt,Tt,rt)=>xy(zt,typeof Tt!="symbol"?Tt+"":Tt,rt);(function(){"use strict";function zt(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function Tt(s){if(Object.prototype.hasOwnProperty.call(s,"__esModule"))return s;var e=s.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(s).forEach(function(i){var n=Object.getOwnPropertyDescriptor(s,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return s[i]}})}),t}var rt={};function Ra(s,e){if(s==null)return{};var t,i,n=function(a,o){if(a==null)return{};var l={};for(var c in a)if({}.hasOwnProperty.call(a,c)){if(o.indexOf(c)!==-1)continue;l[c]=a[c]}return l}(s,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(s);for(i=0;i<r.length;i++)t=r[i],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(s,t)&&(n[t]=s[t])}return n}function qe(s,e){if(!(s instanceof e))throw new TypeError("Cannot call a class as a function")}function fe(s){return fe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},fe(s)}function Pa(s){var e=function(t,i){if(fe(t)!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var r=n.call(t,i);if(fe(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(s,"string");return fe(e)=="symbol"?e:e+""}function Da(s,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(s,Pa(i.key),i)}}function Ke(s,e,t){return e&&Da(s.prototype,e),t&&Da(s,t),Object.defineProperty(s,"prototype",{writable:!1}),s}function us(s,e){if(e&&(fe(e)=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(s)}function at(s){return at=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},at(s)}function Ui(s,e){return Ui=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},Ui(s,e)}function ds(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,writable:!0,configurable:!0}}),Object.defineProperty(s,"prototype",{writable:!1}),e&&Ui(s,e)}function ft(s,e,t){return(e=Pa(e))in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}function Oa(s,e,t,i,n,r,a){try{var o=s[r](a),l=o.value}catch(c){return void t(c)}o.done?e(l):Promise.resolve(l).then(i,n)}function Z(s){return function(){var e=this,t=arguments;return new Promise(function(i,n){var r=s.apply(e,t);function a(l){Oa(r,i,n,a,o,"next",l)}function o(l){Oa(r,i,n,a,o,"throw",l)}a(void 0)})}}function Ma(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=Array(e);t<e;t++)i[t]=s[t];return i}function Me(s,e){return function(t){if(Array.isArray(t))return t}(s)||function(t,i){var n=t==null?null:typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(n!=null){var r,a,o,l,c=[],u=!0,d=!1;try{if(o=(n=n.call(t)).next,i===0){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=o.call(n)).done)&&(c.push(r.value),c.length!==i);u=!0);}catch(f){d=!0,a=f}finally{try{if(!u&&n.return!=null&&(l=n.return(),Object(l)!==l))return}finally{if(d)throw a}}return c}}(s,e)||function(t,i){if(t){if(typeof t=="string")return Ma(t,i);var n={}.toString.call(t).slice(8,-1);return n==="Object"&&t.constructor&&(n=t.constructor.name),n==="Map"||n==="Set"?Array.from(t):n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ma(t,i):void 0}}(s,e)||function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function wh(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Fa,wn={exports:{}},mi=typeof Reflect=="object"?Reflect:null,Na=mi&&typeof mi.apply=="function"?mi.apply:function(s,e,t){return Function.prototype.apply.call(s,e,t)};Fa=mi&&typeof mi.ownKeys=="function"?mi.ownKeys:Object.getOwnPropertySymbols?function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:function(s){return Object.getOwnPropertyNames(s)};var Ua=Number.isNaN||function(s){return s!=s};function ye(){ye.init.call(this)}wn.exports=ye,wn.exports.once=function(s,e){return new Promise(function(t,i){function n(a){s.removeListener(e,r),i(a)}function r(){typeof s.removeListener=="function"&&s.removeListener("error",n),t([].slice.call(arguments))}Ha(s,e,r,{once:!0}),e!=="error"&&function(a,o,l){typeof a.on=="function"&&Ha(a,"error",o,l)}(s,n,{once:!0})})},ye.EventEmitter=ye,ye.prototype._events=void 0,ye.prototype._eventsCount=0,ye.prototype._maxListeners=void 0;var Ba=10;function hs(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}function $a(s){return s._maxListeners===void 0?ye.defaultMaxListeners:s._maxListeners}function ja(s,e,t,i){var n,r,a,o;if(hs(t),(r=s._events)===void 0?(r=s._events=Object.create(null),s._eventsCount=0):(r.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),r=s._events),a=r[e]),a===void 0)a=r[e]=t,++s._eventsCount;else if(typeof a=="function"?a=r[e]=i?[t,a]:[a,t]:i?a.unshift(t):a.push(t),(n=$a(s))>0&&a.length>n&&!a.warned){a.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=s,l.type=e,l.count=a.length,o=l,console&&console.warn&&console.warn(o)}return s}function Lh(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ga(s,e,t){var i={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},n=Lh.bind(i);return n.listener=t,i.wrapFn=n,n}function Va(s,e,t){var i=s._events;if(i===void 0)return[];var n=i[e];return n===void 0?[]:typeof n=="function"?t?[n.listener||n]:[n]:t?function(r){for(var a=new Array(r.length),o=0;o<a.length;++o)a[o]=r[o].listener||r[o];return a}(n):Ka(n,n.length)}function qa(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}function Ka(s,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=s[i];return t}function Ha(s,e,t,i){if(typeof s.on=="function")i.once?s.once(e,t):s.on(e,t);else{if(typeof s.addEventListener!="function")throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s);s.addEventListener(e,function n(r){i.once&&s.removeEventListener(e,n),t(r)})}}Object.defineProperty(ye,"defaultMaxListeners",{enumerable:!0,get:function(){return Ba},set:function(s){if(typeof s!="number"||s<0||Ua(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");Ba=s}}),ye.init=function(){this._events!==void 0&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},ye.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||Ua(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this},ye.prototype.getMaxListeners=function(){return $a(this)},ye.prototype.emit=function(s){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var i=s==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var r;if(e.length>0&&(r=e[0]),r instanceof Error)throw r;var a=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw a.context=r,a}var o=n[s];if(o===void 0)return!1;if(typeof o=="function")Na(o,this,e);else{var l=o.length,c=Ka(o,l);for(t=0;t<l;++t)Na(c[t],this,e)}return!0},ye.prototype.addListener=function(s,e){return ja(this,s,e,!1)},ye.prototype.on=ye.prototype.addListener,ye.prototype.prependListener=function(s,e){return ja(this,s,e,!0)},ye.prototype.once=function(s,e){return hs(e),this.on(s,Ga(this,s,e)),this},ye.prototype.prependOnceListener=function(s,e){return hs(e),this.prependListener(s,Ga(this,s,e)),this},ye.prototype.removeListener=function(s,e){var t,i,n,r,a;if(hs(e),(i=this._events)===void 0)return this;if((t=i[s])===void 0)return this;if(t===e||t.listener===e)--this._eventsCount==0?this._events=Object.create(null):(delete i[s],i.removeListener&&this.emit("removeListener",s,t.listener||e));else if(typeof t!="function"){for(n=-1,r=t.length-1;r>=0;r--)if(t[r]===e||t[r].listener===e){a=t[r].listener,n=r;break}if(n<0)return this;n===0?t.shift():function(o,l){for(;l+1<o.length;l++)o[l]=o[l+1];o.pop()}(t,n),t.length===1&&(i[s]=t[0]),i.removeListener!==void 0&&this.emit("removeListener",s,a||e)}return this},ye.prototype.off=ye.prototype.removeListener,ye.prototype.removeAllListeners=function(s){var e,t,i;if((t=this._events)===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[s]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete t[s]),this;if(arguments.length===0){var n,r=Object.keys(t);for(i=0;i<r.length;++i)(n=r[i])!=="removeListener"&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(typeof(e=t[s])=="function")this.removeListener(s,e);else if(e!==void 0)for(i=e.length-1;i>=0;i--)this.removeListener(s,e[i]);return this},ye.prototype.listeners=function(s){return Va(this,s,!0)},ye.prototype.rawListeners=function(s){return Va(this,s,!1)},ye.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):qa.call(s,e)},ye.prototype.listenerCount=qa,ye.prototype.eventNames=function(){return this._eventsCount>0?Fa(this._events):[]};var Ln=wn.exports,fs=wh(Ln),Ya=Object.prototype.hasOwnProperty;function Wa(s,e,t){for(t of s.keys())if(Fe(t,e))return t}function Fe(s,e){var t,i,n;if(s===e)return!0;if(s&&e&&(t=s.constructor)===e.constructor){if(t===Date)return s.getTime()===e.getTime();if(t===RegExp)return s.toString()===e.toString();if(t===Array){if((i=s.length)===e.length)for(;i--&&Fe(s[i],e[i]););return i===-1}if(t===Set){if(s.size!==e.size)return!1;for(i of s)if((n=i)&&typeof n=="object"&&!(n=Wa(e,n))||!e.has(n))return!1;return!0}if(t===Map){if(s.size!==e.size)return!1;for(i of s)if((n=i[0])&&typeof n=="object"&&!(n=Wa(e,n))||!Fe(i[1],e.get(n)))return!1;return!0}if(t===ArrayBuffer)s=new Uint8Array(s),e=new Uint8Array(e);else if(t===DataView){if((i=s.byteLength)===e.byteLength)for(;i--&&s.getInt8(i)===e.getInt8(i););return i===-1}if(ArrayBuffer.isView(s)){if((i=s.byteLength)===e.byteLength)for(;i--&&s[i]===e[i];);return i===-1}if(!t||typeof s=="object"){for(t in i=0,s)if(Ya.call(s,t)&&++i&&!Ya.call(e,t)||!(t in e)||!Fe(s[t],e[t]))return!1;return Object.keys(e).length===i}}return s!=s&&e!=e}const kh={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},za={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},Ie={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},Ne={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},Ot={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"};class F{static getFirstMatch(e,t){const i=t.match(e);return i&&i.length>0&&i[1]||""}static getSecondMatch(e,t){const i=t.match(e);return i&&i.length>1&&i[2]||""}static matchAndReturnConst(e,t,i){if(e.test(t))return i}static getWindowsVersionName(e){switch(e){case"NT":return"NT";case"XP":case"NT 5.1":return"XP";case"NT 5.0":return"2000";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}static getMacOSVersionName(e){const t=e.split(".").splice(0,2).map(i=>parseInt(i,10)||0);if(t.push(0),t[0]===10)switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}}static getAndroidVersionName(e){const t=e.split(".").splice(0,2).map(i=>parseInt(i,10)||0);if(t.push(0),!(t[0]===1&&t[1]<5))return t[0]===1&&t[1]<6?"Cupcake":t[0]===1&&t[1]>=6?"Donut":t[0]===2&&t[1]<2?"Eclair":t[0]===2&&t[1]===2?"Froyo":t[0]===2&&t[1]>2?"Gingerbread":t[0]===3?"Honeycomb":t[0]===4&&t[1]<1?"Ice Cream Sandwich":t[0]===4&&t[1]<4?"Jelly Bean":t[0]===4&&t[1]>=4?"KitKat":t[0]===5?"Lollipop":t[0]===6?"Marshmallow":t[0]===7?"Nougat":t[0]===8?"Oreo":t[0]===9?"Pie":void 0}static getVersionPrecision(e){return e.split(".").length}static compareVersions(e,t,i=!1){const n=F.getVersionPrecision(e),r=F.getVersionPrecision(t);let a=Math.max(n,r),o=0;const l=F.map([e,t],c=>{const u=a-F.getVersionPrecision(c),d=c+new Array(u+1).join(".0");return F.map(d.split("."),f=>new Array(20-f.length).join("0")+f).reverse()});for(i&&(o=a-Math.min(n,r)),a-=1;a>=o;){if(l[0][a]>l[1][a])return 1;if(l[0][a]===l[1][a]){if(a===o)return 0;a-=1}else if(l[0][a]<l[1][a])return-1}}static map(e,t){const i=[];let n;if(Array.prototype.map)return Array.prototype.map.call(e,t);for(n=0;n<e.length;n+=1)i.push(t(e[n]));return i}static find(e,t){let i,n;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(i=0,n=e.length;i<n;i+=1){const r=e[i];if(t(r,i))return r}}static assign(e,...t){const i=e;let n,r;if(Object.assign)return Object.assign(e,...t);for(n=0,r=t.length;n<r;n+=1){const a=t[n];typeof a=="object"&&a!==null&&Object.keys(a).forEach(o=>{i[o]=a[o]})}return e}static getBrowserAlias(e){return kh[e]}static getBrowserTypeByAlias(e){return za[e]||""}}const Se=/version\/(\d+(\.?_?\d+)+)/i,Ch=[{test:[/googlebot/i],describe(s){const e={name:"Googlebot"},t=F.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/opera/i],describe(s){const e={name:"Opera"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/opr\/|opios/i],describe(s){const e={name:"Opera"},t=F.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/SamsungBrowser/i],describe(s){const e={name:"Samsung Internet for Android"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/Whale/i],describe(s){const e={name:"NAVER Whale Browser"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/MZBrowser/i],describe(s){const e={name:"MZ Browser"},t=F.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/focus/i],describe(s){const e={name:"Focus"},t=F.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/swing/i],describe(s){const e={name:"Swing"},t=F.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/coast/i],describe(s){const e={name:"Opera Coast"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe(s){const e={name:"Opera Touch"},t=F.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/yabrowser/i],describe(s){const e={name:"Yandex Browser"},t=F.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/ucbrowser/i],describe(s){const e={name:"UC Browser"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/Maxthon|mxios/i],describe(s){const e={name:"Maxthon"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/epiphany/i],describe(s){const e={name:"Epiphany"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/puffin/i],describe(s){const e={name:"Puffin"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/sleipnir/i],describe(s){const e={name:"Sleipnir"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/k-meleon/i],describe(s){const e={name:"K-Meleon"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/micromessenger/i],describe(s){const e={name:"WeChat"},t=F.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/qqbrowser/i],describe(s){const e={name:/qqbrowserlite/i.test(s)?"QQ Browser Lite":"QQ Browser"},t=F.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/msie|trident/i],describe(s){const e={name:"Internet Explorer"},t=F.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/\sedg\//i],describe(s){const e={name:"Microsoft Edge"},t=F.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/edg([ea]|ios)/i],describe(s){const e={name:"Microsoft Edge"},t=F.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/vivaldi/i],describe(s){const e={name:"Vivaldi"},t=F.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/seamonkey/i],describe(s){const e={name:"SeaMonkey"},t=F.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/sailfish/i],describe(s){const e={name:"Sailfish"},t=F.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,s);return t&&(e.version=t),e}},{test:[/silk/i],describe(s){const e={name:"Amazon Silk"},t=F.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/phantom/i],describe(s){const e={name:"PhantomJS"},t=F.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/slimerjs/i],describe(s){const e={name:"SlimerJS"},t=F.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(s){const e={name:"BlackBerry"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/(web|hpw)[o0]s/i],describe(s){const e={name:"WebOS Browser"},t=F.getFirstMatch(Se,s)||F.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/bada/i],describe(s){const e={name:"Bada"},t=F.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/tizen/i],describe(s){const e={name:"Tizen"},t=F.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/qupzilla/i],describe(s){const e={name:"QupZilla"},t=F.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/firefox|iceweasel|fxios/i],describe(s){const e={name:"Firefox"},t=F.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/electron/i],describe(s){const e={name:"Electron"},t=F.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/MiuiBrowser/i],describe(s){const e={name:"Miui"},t=F.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/chromium/i],describe(s){const e={name:"Chromium"},t=F.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/chrome|crios|crmo/i],describe(s){const e={name:"Chrome"},t=F.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/GSA/i],describe(s){const e={name:"Google Search"},t=F.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test(s){const e=!s.test(/like android/i),t=s.test(/android/i);return e&&t},describe(s){const e={name:"Android Browser"},t=F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/playstation 4/i],describe(s){const e={name:"PlayStation 4"},t=F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/safari|applewebkit/i],describe(s){const e={name:"Safari"},t=F.getFirstMatch(Se,s);return t&&(e.version=t),e}},{test:[/.*/i],describe(s){const e=s.search("\\(")!==-1?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:F.getFirstMatch(e,s),version:F.getSecondMatch(e,s)}}}];var Rh=[{test:[/Roku\/DVP/],describe(s){const e=F.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,s);return{name:Ne.Roku,version:e}}},{test:[/windows phone/i],describe(s){const e=F.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,s);return{name:Ne.WindowsPhone,version:e}}},{test:[/windows /i],describe(s){const e=F.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,s),t=F.getWindowsVersionName(e);return{name:Ne.Windows,version:e,versionName:t}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(s){const e={name:Ne.iOS},t=F.getSecondMatch(/(Version\/)(\d[\d.]+)/,s);return t&&(e.version=t),e}},{test:[/macintosh/i],describe(s){const e=F.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,s).replace(/[_\s]/g,"."),t=F.getMacOSVersionName(e),i={name:Ne.MacOS,version:e};return t&&(i.versionName=t),i}},{test:[/(ipod|iphone|ipad)/i],describe(s){const e=F.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,s).replace(/[_\s]/g,".");return{name:Ne.iOS,version:e}}},{test(s){const e=!s.test(/like android/i),t=s.test(/android/i);return e&&t},describe(s){const e=F.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,s),t=F.getAndroidVersionName(e),i={name:Ne.Android,version:e};return t&&(i.versionName=t),i}},{test:[/(web|hpw)[o0]s/i],describe(s){const e=F.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,s),t={name:Ne.WebOS};return e&&e.length&&(t.version=e),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(s){const e=F.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,s)||F.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,s)||F.getFirstMatch(/\bbb(\d+)/i,s);return{name:Ne.BlackBerry,version:e}}},{test:[/bada/i],describe(s){const e=F.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,s);return{name:Ne.Bada,version:e}}},{test:[/tizen/i],describe(s){const e=F.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,s);return{name:Ne.Tizen,version:e}}},{test:[/linux/i],describe:()=>({name:Ne.Linux})},{test:[/CrOS/],describe:()=>({name:Ne.ChromeOS})},{test:[/PlayStation 4/],describe(s){const e=F.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,s);return{name:Ne.PlayStation4,version:e}}}],Ph=[{test:[/googlebot/i],describe:()=>({type:"bot",vendor:"Google"})},{test:[/huawei/i],describe(s){const e=F.getFirstMatch(/(can-l01)/i,s)&&"Nova",t={type:Ie.mobile,vendor:"Huawei"};return e&&(t.model=e),t}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:()=>({type:Ie.tablet,vendor:"Nexus"})},{test:[/ipad/i],describe:()=>({type:Ie.tablet,vendor:"Apple",model:"iPad"})},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:()=>({type:Ie.tablet,vendor:"Apple",model:"iPad"})},{test:[/kftt build/i],describe:()=>({type:Ie.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"})},{test:[/silk/i],describe:()=>({type:Ie.tablet,vendor:"Amazon"})},{test:[/tablet(?! pc)/i],describe:()=>({type:Ie.tablet})},{test(s){const e=s.test(/ipod|iphone/i),t=s.test(/like (ipod|iphone)/i);return e&&!t},describe(s){const e=F.getFirstMatch(/(ipod|iphone)/i,s);return{type:Ie.mobile,vendor:"Apple",model:e}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:()=>({type:Ie.mobile,vendor:"Nexus"})},{test:[/[^-]mobi/i],describe:()=>({type:Ie.mobile})},{test:s=>s.getBrowserName(!0)==="blackberry",describe:()=>({type:Ie.mobile,vendor:"BlackBerry"})},{test:s=>s.getBrowserName(!0)==="bada",describe:()=>({type:Ie.mobile})},{test:s=>s.getBrowserName()==="windows phone",describe:()=>({type:Ie.mobile,vendor:"Microsoft"})},{test(s){const e=Number(String(s.getOSVersion()).split(".")[0]);return s.getOSName(!0)==="android"&&e>=3},describe:()=>({type:Ie.tablet})},{test:s=>s.getOSName(!0)==="android",describe:()=>({type:Ie.mobile})},{test:s=>s.getOSName(!0)==="macos",describe:()=>({type:Ie.desktop,vendor:"Apple"})},{test:s=>s.getOSName(!0)==="windows",describe:()=>({type:Ie.desktop})},{test:s=>s.getOSName(!0)==="linux",describe:()=>({type:Ie.desktop})},{test:s=>s.getOSName(!0)==="playstation 4",describe:()=>({type:Ie.tv})},{test:s=>s.getOSName(!0)==="roku",describe:()=>({type:Ie.tv})}],Dh=[{test:s=>s.getBrowserName(!0)==="microsoft edge",describe(s){if(/\sedg\//i.test(s))return{name:Ot.Blink};const e=F.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,s);return{name:Ot.EdgeHTML,version:e}}},{test:[/trident/i],describe(s){const e={name:Ot.Trident},t=F.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:s=>s.test(/presto/i),describe(s){const e={name:Ot.Presto},t=F.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test(s){const e=s.test(/gecko/i),t=s.test(/like gecko/i);return e&&!t},describe(s){const e={name:Ot.Gecko},t=F.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/(apple)?webkit\/537\.36/i],describe:()=>({name:Ot.Blink})},{test:[/(apple)?webkit/i],describe(s){const e={name:Ot.WebKit},t=F.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}}];class Ja{constructor(e,t=!1){if(e==null||e==="")throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},t!==!0&&this.parse()}getUA(){return this._ua}test(e){return e.test(this._ua)}parseBrowser(){this.parsedResult.browser={};const e=F.find(Ch,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(i=>this.test(i));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.browser=e.describe(this.getUA())),this.parsedResult.browser}getBrowser(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()}getBrowserName(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""}getBrowserVersion(){return this.getBrowser().version}getOS(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()}parseOS(){this.parsedResult.os={};const e=F.find(Rh,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(i=>this.test(i));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.os=e.describe(this.getUA())),this.parsedResult.os}getOSName(e){const{name:t}=this.getOS();return e?String(t).toLowerCase()||"":t||""}getOSVersion(){return this.getOS().version}getPlatform(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()}getPlatformType(e=!1){const{type:t}=this.getPlatform();return e?String(t).toLowerCase()||"":t||""}parsePlatform(){this.parsedResult.platform={};const e=F.find(Ph,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(i=>this.test(i));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.platform=e.describe(this.getUA())),this.parsedResult.platform}getEngine(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()}getEngineName(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""}parseEngine(){this.parsedResult.engine={};const e=F.find(Dh,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(i=>this.test(i));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.engine=e.describe(this.getUA())),this.parsedResult.engine}parse(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this}getResult(){return F.assign({},this.parsedResult)}satisfies(e){const t={};let i=0;const n={};let r=0;if(Object.keys(e).forEach(a=>{const o=e[a];typeof o=="string"?(n[a]=o,r+=1):typeof o=="object"&&(t[a]=o,i+=1)}),i>0){const a=Object.keys(t),o=F.find(a,c=>this.isOS(c));if(o){const c=this.satisfies(t[o]);if(c!==void 0)return c}const l=F.find(a,c=>this.isPlatform(c));if(l){const c=this.satisfies(t[l]);if(c!==void 0)return c}}if(r>0){const a=Object.keys(n),o=F.find(a,l=>this.isBrowser(l,!0));if(o!==void 0)return this.compareVersion(n[o])}}isBrowser(e,t=!1){const i=this.getBrowserName().toLowerCase();let n=e.toLowerCase();const r=F.getBrowserTypeByAlias(n);return t&&r&&(n=r.toLowerCase()),n===i}compareVersion(e){let t=[0],i=e,n=!1;const r=this.getBrowserVersion();if(typeof r=="string")return e[0]===">"||e[0]==="<"?(i=e.substr(1),e[1]==="="?(n=!0,i=e.substr(2)):t=[],e[0]===">"?t.push(1):t.push(-1)):e[0]==="="?i=e.substr(1):e[0]==="~"&&(n=!0,i=e.substr(1)),t.indexOf(F.compareVersions(r,i,n))>-1}isOS(e){return this.getOSName(!0)===String(e).toLowerCase()}isPlatform(e){return this.getPlatformType(!0)===String(e).toLowerCase()}isEngine(e){return this.getEngineName(!0)===String(e).toLowerCase()}is(e,t=!1){return this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)}some(e=[]){return e.some(t=>this.is(t))}}/*!
 * Bowser - a browser detector
 * https://github.com/lancedikson/bowser
 * MIT License | (c) Dustin Diaz 2012-2015
 * MIT License | (c) Denis Demchenko 2015-2019
 */class Oh{static getParser(e,t=!1){if(typeof e!="string")throw new Error("UserAgent should be a string");return new Ja(e,t)}static parse(e){return new Ja(e).getResult()}static get BROWSER_MAP(){return za}static get ENGINE_MAP(){return Ot}static get OS_MAP(){return Ne}static get PLATFORMS_MAP(){return Ie}}function ps(){return Date.now()+Math.random().toString()}function Bi(){throw new Error("Method must be implemented in subclass")}function Qa(s,e){return e!=null&&e.proxyUrl?e.proxyUrl+(e.proxyUrl.slice(-1)==="/"?"":"/")+s.substring(8):s}function gs(s){return s!=null&&s.callObjectBundleUrlOverride?s.callObjectBundleUrlOverride:Qa("https://c.daily.co/call-machine/versioned/".concat("0.79.0","/static/call-machine-object-bundle.js"),s)}function ms(s){try{new URL(s)}catch{return!1}return!0}const be=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,Jt="8.55.0",ge=globalThis;function vs(s,e,t){const i=ge,n=i.__SENTRY__=i.__SENTRY__||{},r=n[Jt]=n[Jt]||{};return r[s]||(r[s]=e())}const Qt=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,kn=["debug","info","warn","error","log","assert","trace"],ys={};function $i(s){if(!("console"in ge))return s();const e=ge.console,t={},i=Object.keys(ys);i.forEach(n=>{const r=ys[n];t[n]=e[n],e[n]=r});try{return s()}finally{i.forEach(n=>{e[n]=t[n]})}}const se=vs("logger",function(){let s=!1;const e={enable:()=>{s=!0},disable:()=>{s=!1},isEnabled:()=>s};return Qt?kn.forEach(t=>{e[t]=(...i)=>{s&&$i(()=>{ge.console[t](`Sentry Logger [${t}]:`,...i)})}}):kn.forEach(t=>{e[t]=()=>{}}),e}),Xt="?",Xa=/\(error: (.*)\)/,Za=/captureMessage|captureException/;function Ss(s){return s[s.length-1]||{}}const eo="<anonymous>";function Mt(s){try{return s&&typeof s=="function"&&s.name||eo}catch{return eo}}function to(s){const e=s.exception;if(e){const t=[];try{return e.values.forEach(i=>{i.stacktrace.frames&&t.push(...i.stacktrace.frames)}),t}catch{return}}}const Es={},io={};function Zt(s,e){Es[s]=Es[s]||[],Es[s].push(e)}function ei(s,e){if(!io[s]){io[s]=!0;try{e()}catch(t){Qt&&se.error(`Error while instrumenting ${s}`,t)}}}function ot(s,e){const t=s&&Es[s];if(t)for(const i of t)try{i(e)}catch(n){Qt&&se.error(`Error while triggering instrumentation handler.
Type: ${s}
Name: ${Mt(i)}
Error:`,n)}}let Cn=null;function Mh(){Cn=ge.onerror,ge.onerror=function(s,e,t,i,n){return ot("error",{column:i,error:n,line:t,msg:s,url:e}),!!Cn&&Cn.apply(this,arguments)},ge.onerror.__SENTRY_INSTRUMENTED__=!0}let Rn=null;function Fh(){Rn=ge.onunhandledrejection,ge.onunhandledrejection=function(s){return ot("unhandledrejection",s),!Rn||Rn.apply(this,arguments)},ge.onunhandledrejection.__SENTRY_INSTRUMENTED__=!0}function bs(){return Pn(ge),ge}function Pn(s){const e=s.__SENTRY__=s.__SENTRY__||{};return e.version=e.version||Jt,e[Jt]=e[Jt]||{}}const so=Object.prototype.toString;function Dn(s){switch(so.call(s)){case"[object Error]":case"[object Exception]":case"[object DOMException]":case"[object WebAssembly.Exception]":return!0;default:return ti(s,Error)}}function vi(s,e){return so.call(s)===`[object ${e}]`}function no(s){return vi(s,"ErrorEvent")}function ro(s){return vi(s,"DOMError")}function _t(s){return vi(s,"String")}function On(s){return typeof s=="object"&&s!==null&&"__sentry_template_string__"in s&&"__sentry_template_values__"in s}function Mn(s){return s===null||On(s)||typeof s!="object"&&typeof s!="function"}function yi(s){return vi(s,"Object")}function Ts(s){return typeof Event<"u"&&ti(s,Event)}function _s(s){return!!(s&&s.then&&typeof s.then=="function")}function ti(s,e){try{return s instanceof e}catch{return!1}}function ao(s){return!(typeof s!="object"||s===null||!s.__isVue&&!s._isVue)}const Fn=ge;function oo(s,e={}){if(!s)return"<unknown>";try{let t=s;const i=5,n=[];let r=0,a=0;const o=" > ",l=o.length;let c;const u=Array.isArray(e)?e:e.keyAttrs,d=!Array.isArray(e)&&e.maxStringLength||80;for(;t&&r++<i&&(c=Nh(t,u),!(c==="html"||r>1&&a+n.length*l+c.length>=d));)n.push(c),a+=c.length,t=t.parentNode;return n.reverse().join(o)}catch{return"<unknown>"}}function Nh(s,e){const t=s,i=[];if(!t||!t.tagName)return"";if(Fn.HTMLElement&&t instanceof HTMLElement&&t.dataset){if(t.dataset.sentryComponent)return t.dataset.sentryComponent;if(t.dataset.sentryElement)return t.dataset.sentryElement}i.push(t.tagName.toLowerCase());const n=e&&e.length?e.filter(a=>t.getAttribute(a)).map(a=>[a,t.getAttribute(a)]):null;if(n&&n.length)n.forEach(a=>{i.push(`[${a[0]}="${a[1]}"]`)});else{t.id&&i.push(`#${t.id}`);const a=t.className;if(a&&_t(a)){const o=a.split(/\s+/);for(const l of o)i.push(`.${l}`)}}const r=["aria-label","type","name","title","alt"];for(const a of r){const o=t.getAttribute(a);o&&i.push(`[${a}="${o}"]`)}return i.join("")}function Si(s,e=0){return typeof s!="string"||e===0||s.length<=e?s:`${s.slice(0,e)}...`}function lo(s,e){if(!Array.isArray(s))return"";const t=[];for(let i=0;i<s.length;i++){const n=s[i];try{ao(n)?t.push("[VueViewModel]"):t.push(String(n))}catch{t.push("[value cannot be serialized]")}}return t.join(e)}function Uh(s,e,t=!1){return!!_t(s)&&(vi(e,"RegExp")?e.test(s):!!_t(e)&&(t?s===e:s.includes(e)))}function xs(s,e=[],t=!1){return e.some(i=>Uh(s,i,t))}function He(s,e,t){if(!(e in s))return;const i=s[e],n=t(i);typeof n=="function"&&co(n,i);try{s[e]=n}catch{Qt&&se.log(`Failed to replace method "${e}" in object`,s)}}function ii(s,e,t){try{Object.defineProperty(s,e,{value:t,writable:!0,configurable:!0})}catch{Qt&&se.log(`Failed to add non-enumerable property "${e}" to object`,s)}}function co(s,e){try{const t=e.prototype||{};s.prototype=e.prototype=t,ii(s,"__sentry_original__",e)}catch{}}function Nn(s){return s.__sentry_original__}function uo(s){if(Dn(s))return{message:s.message,name:s.name,stack:s.stack,...fo(s)};if(Ts(s)){const e={type:s.type,target:ho(s.target),currentTarget:ho(s.currentTarget),...fo(s)};return typeof CustomEvent<"u"&&ti(s,CustomEvent)&&(e.detail=s.detail),e}return s}function ho(s){try{return e=s,typeof Element<"u"&&ti(e,Element)?oo(s):Object.prototype.toString.call(s)}catch{return"<unknown>"}var e}function fo(s){if(typeof s=="object"&&s!==null){const e={};for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(e[t]=s[t]);return e}return{}}function Qe(s){return Un(s,new Map)}function Un(s,e){if(function(t){if(!yi(t))return!1;try{const i=Object.getPrototypeOf(t).constructor.name;return!i||i==="Object"}catch{return!0}}(s)){const t=e.get(s);if(t!==void 0)return t;const i={};e.set(s,i);for(const n of Object.getOwnPropertyNames(s))s[n]!==void 0&&(i[n]=Un(s[n],e));return i}if(Array.isArray(s)){const t=e.get(s);if(t!==void 0)return t;const i=[];return e.set(s,i),s.forEach(n=>{i.push(Un(n,e))}),i}return s}function ji(){return Date.now()/1e3}const xt=function(){const{performance:s}=ge;if(!s||!s.now)return ji;const e=Date.now()-s.now(),t=s.timeOrigin==null?e:s.timeOrigin;return()=>(t+s.now())/1e3}();function Xe(){const s=ge,e=s.crypto||s.msCrypto;let t=()=>16*Math.random();try{if(e&&e.randomUUID)return e.randomUUID().replace(/-/g,"");e&&e.getRandomValues&&(t=()=>{const i=new Uint8Array(1);return e.getRandomValues(i),i[0]})}catch{}return("10000000100040008000"+1e11).replace(/[018]/g,i=>(i^(15&t())>>i/4).toString(16))}function po(s){return s.exception&&s.exception.values?s.exception.values[0]:void 0}function Ft(s){const{message:e,event_id:t}=s;if(e)return e;const i=po(s);return i?i.type&&i.value?`${i.type}: ${i.value}`:i.type||i.value||t||"<unknown>":t||"<unknown>"}function Bn(s,e,t){const i=s.exception=s.exception||{},n=i.values=i.values||[],r=n[0]=n[0]||{};r.value||(r.value=e||""),r.type||(r.type="Error")}function Ei(s,e){const t=po(s);if(!t)return;const i=t.mechanism;if(t.mechanism={type:"generic",handled:!0,...i,...e},e&&"data"in e){const n={...i&&i.data,...e.data};t.mechanism.data=n}}function go(s){if(function(e){try{return e.__sentry_captured__}catch{}}(s))return!0;try{ii(s,"__sentry_captured__",!0)}catch{}return!1}var At;function si(s){return new Ze(e=>{e(s)})}function As(s){return new Ze((e,t)=>{t(s)})}(()=>{const{performance:s}=ge;!s||!s.now||(s.now(),s.timing&&s.timing.navigationStart)})(),function(s){s[s.PENDING=0]="PENDING",s[s.RESOLVED=1]="RESOLVED",s[s.REJECTED=2]="REJECTED"}(At||(At={}));class Ze{constructor(e){Ze.prototype.__init.call(this),Ze.prototype.__init2.call(this),Ze.prototype.__init3.call(this),Ze.prototype.__init4.call(this),this._state=At.PENDING,this._handlers=[];try{e(this._resolve,this._reject)}catch(t){this._reject(t)}}then(e,t){return new Ze((i,n)=>{this._handlers.push([!1,r=>{if(e)try{i(e(r))}catch(a){n(a)}else i(r)},r=>{if(t)try{i(t(r))}catch(a){n(a)}else n(r)}]),this._executeHandlers()})}catch(e){return this.then(t=>t,e)}finally(e){return new Ze((t,i)=>{let n,r;return this.then(a=>{r=!1,n=a,e&&e()},a=>{r=!0,n=a,e&&e()}).then(()=>{r?i(n):t(n)})})}__init(){this._resolve=e=>{this._setResult(At.RESOLVED,e)}}__init2(){this._reject=e=>{this._setResult(At.REJECTED,e)}}__init3(){this._setResult=(e,t)=>{this._state===At.PENDING&&(_s(t)?t.then(this._resolve,this._reject):(this._state=e,this._value=t,this._executeHandlers()))}}__init4(){this._executeHandlers=()=>{if(this._state===At.PENDING)return;const e=this._handlers.slice();this._handlers=[],e.forEach(t=>{t[0]||(this._state===At.RESOLVED&&t[1](this._value),this._state===At.REJECTED&&t[2](this._value),t[0]=!0)})}}}function Bh(s){const e=xt(),t={sid:Xe(),init:!0,timestamp:e,started:e,duration:0,status:"ok",errors:0,ignoreDuration:!1,toJSON:()=>function(i){return Qe({sid:`${i.sid}`,init:i.init,started:new Date(1e3*i.started).toISOString(),timestamp:new Date(1e3*i.timestamp).toISOString(),status:i.status,errors:i.errors,did:typeof i.did=="number"||typeof i.did=="string"?`${i.did}`:void 0,duration:i.duration,abnormal_mechanism:i.abnormal_mechanism,attrs:{release:i.release,environment:i.environment,ip_address:i.ipAddress,user_agent:i.userAgent}})}(t)};return s&&bi(t,s),t}function bi(s,e={}){if(e.user&&(!s.ipAddress&&e.user.ip_address&&(s.ipAddress=e.user.ip_address),s.did||e.did||(s.did=e.user.id||e.user.email||e.user.username)),s.timestamp=e.timestamp||xt(),e.abnormal_mechanism&&(s.abnormal_mechanism=e.abnormal_mechanism),e.ignoreDuration&&(s.ignoreDuration=e.ignoreDuration),e.sid&&(s.sid=e.sid.length===32?e.sid:Xe()),e.init!==void 0&&(s.init=e.init),!s.did&&e.did&&(s.did=`${e.did}`),typeof e.started=="number"&&(s.started=e.started),s.ignoreDuration)s.duration=void 0;else if(typeof e.duration=="number")s.duration=e.duration;else{const t=s.timestamp-s.started;s.duration=t>=0?t:0}e.release&&(s.release=e.release),e.environment&&(s.environment=e.environment),!s.ipAddress&&e.ipAddress&&(s.ipAddress=e.ipAddress),!s.userAgent&&e.userAgent&&(s.userAgent=e.userAgent),typeof e.errors=="number"&&(s.errors=e.errors),e.status&&(s.status=e.status)}function mo(){return Xe()}function $n(){return Xe().substring(16)}function Is(s,e,t=2){if(!e||typeof e!="object"||t<=0)return e;if(s&&e&&Object.keys(e).length===0)return s;const i={...s};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(i[n]=Is(i[n],e[n],t-1));return i}const jn="_sentrySpan";function vo(s,e){e?ii(s,jn,e):delete s[jn]}function yo(s){return s[jn]}class Gn{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext={traceId:mo(),spanId:$n()}}clone(){const e=new Gn;return e._breadcrumbs=[...this._breadcrumbs],e._tags={...this._tags},e._extra={...this._extra},e._contexts={...this._contexts},this._contexts.flags&&(e._contexts.flags={values:[...this._contexts.flags.values]}),e._user=this._user,e._level=this._level,e._session=this._session,e._transactionName=this._transactionName,e._fingerprint=this._fingerprint,e._eventProcessors=[...this._eventProcessors],e._requestSession=this._requestSession,e._attachments=[...this._attachments],e._sdkProcessingMetadata={...this._sdkProcessingMetadata},e._propagationContext={...this._propagationContext},e._client=this._client,e._lastEventId=this._lastEventId,vo(e,yo(this)),e}setClient(e){this._client=e}setLastEventId(e){this._lastEventId=e}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&bi(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}getRequestSession(){return this._requestSession}setRequestSession(e){return this._requestSession=e,this}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this._tags={...this._tags,[e]:t},this._notifyScopeListeners(),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return t===null?delete this._contexts[e]:this._contexts[e]=t,this._notifyScopeListeners(),this}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;const t=typeof e=="function"?e(this):e,[i,n]=t instanceof Nt?[t.getScopeData(),t.getRequestSession()]:yi(t)?[e,e.requestSession]:[],{tags:r,extra:a,user:o,contexts:l,level:c,fingerprint:u=[],propagationContext:d}=i||{};return this._tags={...this._tags,...r},this._extra={...this._extra,...a},this._contexts={...this._contexts,...l},o&&Object.keys(o).length&&(this._user=o),c&&(this._level=c),u.length&&(this._fingerprint=u),d&&(this._propagationContext=d),n&&(this._requestSession=n),this}clear(){return this._breadcrumbs=[],this._tags={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._requestSession=void 0,this._session=void 0,vo(this,void 0),this._attachments=[],this.setPropagationContext({traceId:mo()}),this._notifyScopeListeners(),this}addBreadcrumb(e,t){const i=typeof t=="number"?t:100;if(i<=0)return this;const n={timestamp:ji(),...e};return this._breadcrumbs.push(n),this._breadcrumbs.length>i&&(this._breadcrumbs=this._breadcrumbs.slice(-i),this._client&&this._client.recordDroppedEvent("buffer_overflow","log_item")),this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:yo(this)}}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata=Is(this._sdkProcessingMetadata,e,2),this}setPropagationContext(e){return this._propagationContext={spanId:$n(),...e},this}getPropagationContext(){return this._propagationContext}captureException(e,t){const i=t&&t.event_id?t.event_id:Xe();if(!this._client)return se.warn("No client configured on scope - will not capture exception!"),i;const n=new Error("Sentry syntheticException");return this._client.captureException(e,{originalException:e,syntheticException:n,...t,event_id:i},this),i}captureMessage(e,t,i){const n=i&&i.event_id?i.event_id:Xe();if(!this._client)return se.warn("No client configured on scope - will not capture message!"),n;const r=new Error(e);return this._client.captureMessage(e,t,{originalException:e,syntheticException:r,...i,event_id:n},this),n}captureEvent(e,t){const i=t&&t.event_id?t.event_id:Xe();return this._client?(this._client.captureEvent(e,{...t,event_id:i},this),i):(se.warn("No client configured on scope - will not capture event!"),i)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(e=>{e(this)}),this._notifyingListeners=!1)}}const Nt=Gn;class $h{constructor(e,t){let i,n;i=e||new Nt,n=t||new Nt,this._stack=[{scope:i}],this._isolationScope=n}withScope(e){const t=this._pushScope();let i;try{i=e(t)}catch(n){throw this._popScope(),n}return _s(i)?i.then(n=>(this._popScope(),n),n=>{throw this._popScope(),n}):(this._popScope(),i)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const e=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:e}),e}_popScope(){return!(this._stack.length<=1)&&!!this._stack.pop()}}function Ti(){const s=Pn(bs());return s.stack=s.stack||new $h(vs("defaultCurrentScope",()=>new Nt),vs("defaultIsolationScope",()=>new Nt))}function jh(s){return Ti().withScope(s)}function Gh(s,e){const t=Ti();return t.withScope(()=>(t.getStackTop().scope=s,e(s)))}function So(s){return Ti().withScope(()=>s(Ti().getIsolationScope()))}function Vn(s){const e=Pn(s);return e.acs?e.acs:{withIsolationScope:So,withScope:jh,withSetScope:Gh,withSetIsolationScope:(t,i)=>So(i),getCurrentScope:()=>Ti().getScope(),getIsolationScope:()=>Ti().getIsolationScope()}}function ni(){return Vn(bs()).getCurrentScope()}function Gi(){return Vn(bs()).getIsolationScope()}function De(){return ni().getClient()}function Vh(s){const e=s.getPropagationContext(),{traceId:t,spanId:i,parentSpanId:n}=e;return Qe({trace_id:t,span_id:i,parent_span_id:n})}function qh(s){const e=s._sentryMetrics;if(!e)return;const t={};for(const[,[i,n]]of e)(t[i]||(t[i]=[])).push(Qe(n));return t}const Kh=/^sentry-/;function Hh(s){const e=function(i){if(!(!i||!_t(i)&&!Array.isArray(i)))return Array.isArray(i)?i.reduce((n,r)=>{const a=Eo(r);return Object.entries(a).forEach(([o,l])=>{n[o]=l}),n},{}):Eo(i)}(s);if(!e)return;const t=Object.entries(e).reduce((i,[n,r])=>(n.match(Kh)&&(i[n.slice(7)]=r),i),{});return Object.keys(t).length>0?t:void 0}function Eo(s){return s.split(",").map(e=>e.split("=").map(t=>decodeURIComponent(t.trim()))).reduce((e,[t,i])=>(t&&i&&(e[t]=i),e),{})}let bo=!1;function Yh(s){const{spanId:e,traceId:t,isRemote:i}=s.spanContext();return Qe({parent_span_id:i?e:qn(s).parent_span_id,span_id:i?$n():e,trace_id:t})}function To(s){return typeof s=="number"?_o(s):Array.isArray(s)?s[0]+s[1]/1e9:s instanceof Date?_o(s.getTime()):xt()}function _o(s){return s>9999999999?s/1e3:s}function qn(s){if(function(e){return typeof e.getSpanJSON=="function"}(s))return s.getSpanJSON();try{const{spanId:e,traceId:t}=s.spanContext();if(function(i){const n=i;return!!(n.attributes&&n.startTime&&n.name&&n.endTime&&n.status)}(s)){const{attributes:i,startTime:n,name:r,endTime:a,parentSpanId:o,status:l}=s;return Qe({span_id:e,trace_id:t,data:i,description:r,parent_span_id:o,start_timestamp:To(n),timestamp:To(a)||void 0,status:Wh(l),op:i["sentry.op"],origin:i["sentry.origin"],_metrics_summary:qh(s)})}return{span_id:e,trace_id:t}}catch{return{}}}function Wh(s){if(s&&s.code!==0)return s.code===1?"ok":s.message||"unknown_error"}function xo(s){return s._sentryRootSpan||s}function zh(){bo||($i(()=>{console.warn("[Sentry] Deprecation warning: Returning null from `beforeSendSpan` will be disallowed from SDK version 9.0.0 onwards. The callback will only support mutating spans. To drop certain spans, configure the respective integrations directly.")}),bo=!0)}const Kn="production";function Ao(s,e){const t=e.getOptions(),{publicKey:i}=e.getDsn()||{},n=Qe({environment:t.environment||Kn,release:t.release,public_key:i,trace_id:s});return e.emit("createDsc",n),n}function Jh(s){const e=De();if(!e)return{};const t=xo(s),i=t._frozenDsc;if(i)return i;const n=t.spanContext().traceState,r=n&&n.get("sentry.dsc"),a=r&&Hh(r);if(a)return a;const o=Ao(s.spanContext().traceId,e),l=qn(t),c=l.data||{},u=c["sentry.sample_rate"];u!=null&&(o.sample_rate=`${u}`);const d=c["sentry.source"],f=l.description;return d!=="url"&&f&&(o.transaction=f),function(g){if(typeof __SENTRY_TRACING__=="boolean"&&!__SENTRY_TRACING__)return!1;const p=De(),v=p&&p.getOptions();return!!v&&(v.enableTracing||"tracesSampleRate"in v||"tracesSampler"in v)}()&&(o.sampled=String(function(g){const{traceFlags:p}=g.spanContext();return p===1}(t))),e.emit("createDsc",o,t),o}const Qh=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+)?)?@)([\w.-]+)(?::(\d+))?\/(.+)/;function ws(s,e=!1){const{host:t,path:i,pass:n,port:r,projectId:a,protocol:o,publicKey:l}=s;return`${o}://${l}${e&&n?`:${n}`:""}@${t}${r?`:${r}`:""}/${i&&`${i}/`}${a}`}function Io(s){return{protocol:s.protocol,publicKey:s.publicKey||"",pass:s.pass||"",host:s.host,port:s.port||"",path:s.path||"",projectId:s.projectId}}function Xh(s){const e=typeof s=="string"?function(t){const i=Qh.exec(t);if(!i)return void $i(()=>{console.error(`Invalid Sentry Dsn: ${t}`)});const[n,r,a="",o="",l="",c=""]=i.slice(1);let u="",d=c;const f=d.split("/");if(f.length>1&&(u=f.slice(0,-1).join("/"),d=f.pop()),d){const g=d.match(/^\d+/);g&&(d=g[0])}return Io({host:o,pass:a,path:u,projectId:d,port:l,protocol:n,publicKey:r})}(s):Io(s);if(e&&function(t){if(!Qt)return!0;const{port:i,projectId:n,protocol:r}=t;return!(["protocol","publicKey","host","projectId"].find(a=>!t[a]&&(se.error(`Invalid Sentry Dsn: ${a} missing`),!0))||(n.match(/^\d+$/)?function(a){return a==="http"||a==="https"}(r)?i&&isNaN(parseInt(i,10))&&(se.error(`Invalid Sentry Dsn: Invalid port ${i}`),1):(se.error(`Invalid Sentry Dsn: Invalid protocol ${r}`),1):(se.error(`Invalid Sentry Dsn: Invalid projectId ${n}`),1)))}(e))return e}function It(s,e=100,t=1/0){try{return Hn("",s,e,t)}catch(i){return{ERROR:`**non-serializable** (${i})`}}}function wo(s,e=3,t=102400){const i=It(s,e);return n=i,function(r){return~-encodeURI(r).split(/%..|./).length}(JSON.stringify(n))>t?wo(s,e-1,t):i;var n}function Hn(s,e,t=1/0,i=1/0,n=function(){const r=typeof WeakSet=="function",a=r?new WeakSet:[];return[function(o){if(r)return!!a.has(o)||(a.add(o),!1);for(let l=0;l<a.length;l++)if(a[l]===o)return!0;return a.push(o),!1},function(o){if(r)a.delete(o);else for(let l=0;l<a.length;l++)if(a[l]===o){a.splice(l,1);break}}]}()){const[r,a]=n;if(e==null||["boolean","string"].includes(typeof e)||typeof e=="number"&&Number.isFinite(e))return e;const o=function(g,p){try{if(g==="domain"&&p&&typeof p=="object"&&p._events)return"[Domain]";if(g==="domainEmitter")return"[DomainEmitter]";if(typeof global<"u"&&p===global)return"[Global]";if(typeof window<"u"&&p===window)return"[Window]";if(typeof document<"u"&&p===document)return"[Document]";if(ao(p))return"[VueViewModel]";if(yi(v=p)&&"nativeEvent"in v&&"preventDefault"in v&&"stopPropagation"in v)return"[SyntheticEvent]";if(typeof p=="number"&&!Number.isFinite(p))return`[${p}]`;if(typeof p=="function")return`[Function: ${Mt(p)}]`;if(typeof p=="symbol")return`[${String(p)}]`;if(typeof p=="bigint")return`[BigInt: ${String(p)}]`;const S=function(b){const I=Object.getPrototypeOf(b);return I?I.constructor.name:"null prototype"}(p);return/^HTML(\w*)Element$/.test(S)?`[HTMLElement: ${S}]`:`[object ${S}]`}catch(S){return`**non-serializable** (${S})`}var v}(s,e);if(!o.startsWith("[object "))return o;if(e.__sentry_skip_normalization__)return e;const l=typeof e.__sentry_override_normalization_depth__=="number"?e.__sentry_override_normalization_depth__:t;if(l===0)return o.replace("object ","");if(r(e))return"[Circular ~]";const c=e;if(c&&typeof c.toJSON=="function")try{return Hn("",c.toJSON(),l-1,i,n)}catch{}const u=Array.isArray(e)?[]:{};let d=0;const f=uo(e);for(const g in f){if(!Object.prototype.hasOwnProperty.call(f,g))continue;if(d>=i){u[g]="[MaxProperties ~]";break}const p=f[g];u[g]=Hn(g,p,l-1,i,n),d++}return a(e),u}function Vi(s,e=[]){return[s,e]}function Zh(s,e){const[t,i]=s;return[t,[...i,e]]}function Lo(s,e){const t=s[1];for(const i of t)if(e(i,i[0].type))return!0;return!1}function Yn(s){return ge.__SENTRY__&&ge.__SENTRY__.encodePolyfill?ge.__SENTRY__.encodePolyfill(s):new TextEncoder().encode(s)}function ef(s){const[e,t]=s;let i=JSON.stringify(e);function n(r){typeof i=="string"?i=typeof r=="string"?i+r:[Yn(i),r]:i.push(typeof r=="string"?Yn(r):r)}for(const r of t){const[a,o]=r;if(n(`
${JSON.stringify(a)}
`),typeof o=="string"||o instanceof Uint8Array)n(o);else{let l;try{l=JSON.stringify(o)}catch{l=JSON.stringify(It(o))}n(l)}}return typeof i=="string"?i:function(r){const a=r.reduce((c,u)=>c+u.length,0),o=new Uint8Array(a);let l=0;for(const c of r)o.set(c,l),l+=c.length;return o}(i)}function tf(s){const e=typeof s.data=="string"?Yn(s.data):s.data;return[Qe({type:"attachment",length:e.length,filename:s.filename,content_type:s.contentType,attachment_type:s.attachmentType}),e]}const sf={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default",profile:"profile",profile_chunk:"profile",replay_event:"replay",replay_recording:"replay",check_in:"monitor",feedback:"feedback",span:"span",statsd:"metric_bucket",raw_security:"security"};function ko(s){return sf[s]}function Co(s){if(!s||!s.sdk)return;const{name:e,version:t}=s.sdk;return{name:e,version:t}}function nf(s,e,t,i){const n=Co(t),r=s.type&&s.type!=="replay_event"?s.type:"event";(function(o,l){l&&(o.sdk=o.sdk||{},o.sdk.name=o.sdk.name||l.name,o.sdk.version=o.sdk.version||l.version,o.sdk.integrations=[...o.sdk.integrations||[],...l.integrations||[]],o.sdk.packages=[...o.sdk.packages||[],...l.packages||[]])})(s,t&&t.sdk);const a=function(o,l,c,u){const d=o.sdkProcessingMetadata&&o.sdkProcessingMetadata.dynamicSamplingContext;return{event_id:o.event_id,sent_at:new Date().toISOString(),...l&&{sdk:l},...!!c&&u&&{dsn:ws(u)},...d&&{trace:Qe({...d})}}}(s,n,i,e);return delete s.sdkProcessingMetadata,Vi(a,[[{type:r},s]])}function Wn(s,e,t,i=0){return new Ze((n,r)=>{const a=s[i];if(e===null||typeof a!="function")n(e);else{const o=a({...e},t);be&&a.id&&o===null&&se.log(`Event processor "${a.id}" dropped event`),_s(o)?o.then(l=>Wn(s,l,t,i+1).then(n)).then(null,r):Wn(s,o,t,i+1).then(n).then(null,r)}})}let Ls,Ro,zn;function rf(s,e){const{fingerprint:t,span:i,breadcrumbs:n,sdkProcessingMetadata:r}=e;(function(a,o){const{extra:l,tags:c,user:u,contexts:d,level:f,transactionName:g}=o,p=Qe(l);p&&Object.keys(p).length&&(a.extra={...p,...a.extra});const v=Qe(c);v&&Object.keys(v).length&&(a.tags={...v,...a.tags});const S=Qe(u);S&&Object.keys(S).length&&(a.user={...S,...a.user});const b=Qe(d);b&&Object.keys(b).length&&(a.contexts={...b,...a.contexts}),f&&(a.level=f),g&&a.type!=="transaction"&&(a.transaction=g)})(s,e),i&&function(a,o){a.contexts={trace:Yh(o),...a.contexts},a.sdkProcessingMetadata={dynamicSamplingContext:Jh(o),...a.sdkProcessingMetadata};const l=xo(o),c=qn(l).description;c&&!a.transaction&&a.type==="transaction"&&(a.transaction=c)}(s,i),function(a,o){a.fingerprint=a.fingerprint?Array.isArray(a.fingerprint)?a.fingerprint:[a.fingerprint]:[],o&&(a.fingerprint=a.fingerprint.concat(o)),a.fingerprint&&!a.fingerprint.length&&delete a.fingerprint}(s,t),function(a,o){const l=[...a.breadcrumbs||[],...o];a.breadcrumbs=l.length?l:void 0}(s,n),function(a,o){a.sdkProcessingMetadata={...a.sdkProcessingMetadata,...o}}(s,r)}function Po(s,e){const{extra:t,tags:i,user:n,contexts:r,level:a,sdkProcessingMetadata:o,breadcrumbs:l,fingerprint:c,eventProcessors:u,attachments:d,propagationContext:f,transactionName:g,span:p}=e;ks(s,"extra",t),ks(s,"tags",i),ks(s,"user",n),ks(s,"contexts",r),s.sdkProcessingMetadata=Is(s.sdkProcessingMetadata,o,2),a&&(s.level=a),g&&(s.transactionName=g),p&&(s.span=p),l.length&&(s.breadcrumbs=[...s.breadcrumbs,...l]),c.length&&(s.fingerprint=[...s.fingerprint,...c]),u.length&&(s.eventProcessors=[...s.eventProcessors,...u]),d.length&&(s.attachments=[...s.attachments,...d]),s.propagationContext={...s.propagationContext,...f}}function ks(s,e,t){s[e]=Is(s[e],t,1)}function af(s,e,t,i,n,r){const{normalizeDepth:a=3,normalizeMaxBreadth:o=1e3}=s,l={...e,event_id:e.event_id||t.event_id||Xe(),timestamp:e.timestamp||ji()},c=t.integrations||s.integrations.map(p=>p.name);(function(p,v){const{environment:S,release:b,dist:I,maxValueLength:w=250}=v;p.environment=p.environment||S||Kn,!p.release&&b&&(p.release=b),!p.dist&&I&&(p.dist=I),p.message&&(p.message=Si(p.message,w));const _=p.exception&&p.exception.values&&p.exception.values[0];_&&_.value&&(_.value=Si(_.value,w));const T=p.request;T&&T.url&&(T.url=Si(T.url,w))})(l,s),function(p,v){v.length>0&&(p.sdk=p.sdk||{},p.sdk.integrations=[...p.sdk.integrations||[],...v])}(l,c),n&&n.emit("applyFrameMetadata",e),e.type===void 0&&function(p,v){const S=function(b){const I=ge._sentryDebugIds;if(!I)return{};const w=Object.keys(I);return zn&&w.length===Ro||(Ro=w.length,zn=w.reduce((_,T)=>{Ls||(Ls={});const C=Ls[T];if(C)_[C[0]]=C[1];else{const A=b(T);for(let k=A.length-1;k>=0;k--){const D=A[k],R=D&&D.filename,N=I[T];if(R&&N){_[R]=N,Ls[T]=[R,N];break}}}return _},{})),zn}(v);try{p.exception.values.forEach(b=>{b.stacktrace.frames.forEach(I=>{S&&I.filename&&(I.debug_id=S[I.filename])})})}catch{}}(l,s.stackParser);const u=function(p,v){if(!v)return p;const S=p?p.clone():new Nt;return S.update(v),S}(i,t.captureContext);t.mechanism&&Ei(l,t.mechanism);const d=n?n.getEventProcessors():[],f=vs("globalScope",()=>new Nt).getScopeData();r&&Po(f,r.getScopeData()),u&&Po(f,u.getScopeData());const g=[...t.attachments||[],...f.attachments];return g.length&&(t.attachments=g),rf(l,f),Wn([...d,...f.eventProcessors],l,t).then(p=>(p&&function(v){const S={};try{v.exception.values.forEach(I=>{I.stacktrace.frames.forEach(w=>{w.debug_id&&(w.abs_path?S[w.abs_path]=w.debug_id:w.filename&&(S[w.filename]=w.debug_id),delete w.debug_id)})})}catch{}if(Object.keys(S).length===0)return;v.debug_meta=v.debug_meta||{},v.debug_meta.images=v.debug_meta.images||[];const b=v.debug_meta.images;Object.entries(S).forEach(([I,w])=>{b.push({type:"sourcemap",code_file:I,debug_id:w})})}(p),typeof a=="number"&&a>0?function(v,S,b){if(!v)return null;const I={...v,...v.breadcrumbs&&{breadcrumbs:v.breadcrumbs.map(w=>({...w,...w.data&&{data:It(w.data,S,b)}}))},...v.user&&{user:It(v.user,S,b)},...v.contexts&&{contexts:It(v.contexts,S,b)},...v.extra&&{extra:It(v.extra,S,b)}};return v.contexts&&v.contexts.trace&&I.contexts&&(I.contexts.trace=v.contexts.trace,v.contexts.trace.data&&(I.contexts.trace.data=It(v.contexts.trace.data,S,b))),v.spans&&(I.spans=v.spans.map(w=>({...w,...w.data&&{data:It(w.data,S,b)}}))),v.contexts&&v.contexts.flags&&I.contexts&&(I.contexts.flags=It(v.contexts.flags,3,b)),I}(p,a,o):p))}function Ay(s){}function Do(s,e){return ni().captureEvent(s,e)}function Oo(s){const e=De(),t=Gi(),i=ni(),{release:n,environment:r=Kn}=e&&e.getOptions()||{},{userAgent:a}=ge.navigator||{},o=Bh({release:n,environment:r,user:i.getUser()||t.getUser(),...a&&{userAgent:a},...s}),l=t.getSession();return l&&l.status==="ok"&&bi(l,{status:"exited"}),Mo(),t.setSession(o),i.setSession(o),o}function Mo(){const s=Gi(),e=ni(),t=e.getSession()||s.getSession();t&&function(i,n){let r={};i.status==="ok"&&(r={status:"exited"}),bi(i,r)}(t),Fo(),s.setSession(),e.setSession()}function Fo(){const s=Gi(),e=ni(),t=De(),i=e.getSession()||s.getSession();i&&t&&t.captureSession(i)}function No(s=!1){s?Mo():Fo()}function of(s,e,t){return e||`${function(i){return`${function(n){const r=n.protocol?`${n.protocol}:`:"",a=n.port?`:${n.port}`:"";return`${r}//${n.host}${a}${n.path?`/${n.path}`:""}/api/`}(i)}${i.projectId}/envelope/`}(s)}?${function(i,n){const r={sentry_version:"7"};return i.publicKey&&(r.sentry_key=i.publicKey),n&&(r.sentry_client=`${n.name}/${n.version}`),new URLSearchParams(r).toString()}(s,t)}`}const Uo=[];function Bo(s,e){for(const t of e)t&&t.afterAllSetup&&t.afterAllSetup(s)}function $o(s,e,t){if(t[e.name])be&&se.log(`Integration skipped because it was already installed: ${e.name}`);else{if(t[e.name]=e,Uo.indexOf(e.name)===-1&&typeof e.setupOnce=="function"&&(e.setupOnce(),Uo.push(e.name)),e.setup&&typeof e.setup=="function"&&e.setup(s),typeof e.preprocessEvent=="function"){const i=e.preprocessEvent.bind(e);s.on("preprocessEvent",(n,r)=>i(n,r,s))}if(typeof e.processEvent=="function"){const i=e.processEvent.bind(e),n=Object.assign((r,a)=>i(r,a,s),{id:e.name});s.addEventProcessor(n)}be&&se.log(`Integration installed: ${e.name}`)}}class lt extends Error{constructor(e,t="warn"){super(e),this.message=e,this.logLevel=t}}const jo="Not capturing exception because it's already been captured.";class lf{constructor(e){if(this._options=e,this._integrations={},this._numProcessing=0,this._outcomes={},this._hooks={},this._eventProcessors=[],e.dsn?this._dsn=Xh(e.dsn):be&&se.warn("No DSN provided, client will not send events."),this._dsn){const i=of(this._dsn,e.tunnel,e._metadata?e._metadata.sdk:void 0);this._transport=e.transport({tunnel:this._options.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...e.transportOptions,url:i})}const t=["enableTracing","tracesSampleRate","tracesSampler"].find(i=>i in e&&e[i]==null);t&&$i(()=>{console.warn(`[Sentry] Deprecation warning: \`${t}\` is set to undefined, which leads to tracing being enabled. In v9, a value of \`undefined\` will result in tracing being disabled.`)})}captureException(e,t,i){const n=Xe();if(go(e))return be&&se.log(jo),n;const r={event_id:n,...t};return this._process(this.eventFromException(e,r).then(a=>this._captureEvent(a,r,i))),r.event_id}captureMessage(e,t,i,n){const r={event_id:Xe(),...i},a=On(e)?e:String(e),o=Mn(e)?this.eventFromMessage(a,t,r):this.eventFromException(e,r);return this._process(o.then(l=>this._captureEvent(l,r,n))),r.event_id}captureEvent(e,t,i){const n=Xe();if(t&&t.originalException&&go(t.originalException))return be&&se.log(jo),n;const r={event_id:n,...t},a=(e.sdkProcessingMetadata||{}).capturedSpanScope;return this._process(this._captureEvent(e,r,a||i)),r.event_id}captureSession(e){typeof e.release!="string"?be&&se.warn("Discarded session because of missing or non-string release"):(this.sendSession(e),bi(e,{init:!1}))}getDsn(){return this._dsn}getOptions(){return this._options}getSdkMetadata(){return this._options._metadata}getTransport(){return this._transport}flush(e){const t=this._transport;return t?(this.emit("flush"),this._isClientDoneProcessing(e).then(i=>t.flush(e).then(n=>i&&n))):si(!0)}close(e){return this.flush(e).then(t=>(this.getOptions().enabled=!1,this.emit("close"),t))}getEventProcessors(){return this._eventProcessors}addEventProcessor(e){this._eventProcessors.push(e)}init(){(this._isEnabled()||this._options.integrations.some(({name:e})=>e.startsWith("Spotlight")))&&this._setupIntegrations()}getIntegrationByName(e){return this._integrations[e]}addIntegration(e){const t=this._integrations[e.name];$o(this,e,this._integrations),t||Bo(this,[e])}sendEvent(e,t={}){this.emit("beforeSendEvent",e,t);let i=nf(e,this._dsn,this._options._metadata,this._options.tunnel);for(const r of t.attachments||[])i=Zh(i,tf(r));const n=this.sendEnvelope(i);n&&n.then(r=>this.emit("afterSendEvent",e,r),null)}sendSession(e){const t=function(i,n,r,a){const o=Co(r);return Vi({sent_at:new Date().toISOString(),...o&&{sdk:o},...!!a&&n&&{dsn:ws(n)}},["aggregates"in i?[{type:"sessions"},i]:[{type:"session"},i.toJSON()]])}(e,this._dsn,this._options._metadata,this._options.tunnel);this.sendEnvelope(t)}recordDroppedEvent(e,t,i){if(this._options.sendClientReports){const n=typeof i=="number"?i:1,r=`${e}:${t}`;be&&se.log(`Recording outcome: "${r}"${n>1?` (${n} times)`:""}`),this._outcomes[r]=(this._outcomes[r]||0)+n}}on(e,t){const i=this._hooks[e]=this._hooks[e]||[];return i.push(t),()=>{const n=i.indexOf(t);n>-1&&i.splice(n,1)}}emit(e,...t){const i=this._hooks[e];i&&i.forEach(n=>n(...t))}sendEnvelope(e){return this.emit("beforeEnvelope",e),this._isEnabled()&&this._transport?this._transport.send(e).then(null,t=>(be&&se.error("Error while sending envelope:",t),t)):(be&&se.error("Transport disabled"),si({}))}_setupIntegrations(){const{integrations:e}=this._options;this._integrations=function(t,i){const n={};return i.forEach(r=>{r&&$o(t,r,n)}),n}(this,e),Bo(this,e)}_updateSessionFromEvent(e,t){let i=t.level==="fatal",n=!1;const r=t.exception&&t.exception.values;if(r){n=!0;for(const o of r){const l=o.mechanism;if(l&&l.handled===!1){i=!0;break}}}const a=e.status==="ok";(a&&e.errors===0||a&&i)&&(bi(e,{...i&&{status:"crashed"},errors:e.errors||Number(n||i)}),this.captureSession(e))}_isClientDoneProcessing(e){return new Ze(t=>{let i=0;const n=setInterval(()=>{this._numProcessing==0?(clearInterval(n),t(!0)):(i+=1,e&&i>=e&&(clearInterval(n),t(!1)))},1)})}_isEnabled(){return this.getOptions().enabled!==!1&&this._transport!==void 0}_prepareEvent(e,t,i=ni(),n=Gi()){const r=this.getOptions(),a=Object.keys(this._integrations);return!t.integrations&&a.length>0&&(t.integrations=a),this.emit("preprocessEvent",e,t),e.type||n.setLastEventId(e.event_id||t.event_id),af(r,e,t,i,this,n).then(o=>{if(o===null)return o;o.contexts={trace:Vh(i),...o.contexts};const l=function(c,u){const d=u.getPropagationContext();return d.dsc||Ao(d.traceId,c)}(this,i);return o.sdkProcessingMetadata={dynamicSamplingContext:l,...o.sdkProcessingMetadata},o})}_captureEvent(e,t={},i){return this._processEvent(e,t,i).then(n=>n.event_id,n=>{be&&(n instanceof lt&&n.logLevel==="log"?se.log(n.message):se.warn(n))})}_processEvent(e,t,i){const n=this.getOptions(),{sampleRate:r}=n,a=Vo(e),o=Go(e),l=e.type||"error",c=`before send for type \`${l}\``,u=r===void 0?void 0:function(g){if(typeof g=="boolean")return Number(g);const p=typeof g=="string"?parseFloat(g):g;if(!(typeof p!="number"||isNaN(p)||p<0||p>1))return p;be&&se.warn(`[Tracing] Given sample rate is invalid. Sample rate must be a boolean or a number between 0 and 1. Got ${JSON.stringify(g)} of type ${JSON.stringify(typeof g)}.`)}(r);if(o&&typeof u=="number"&&Math.random()>u)return this.recordDroppedEvent("sample_rate","error",e),As(new lt(`Discarding event because it's not included in the random sample (sampling rate = ${r})`,"log"));const d=l==="replay_event"?"replay":l,f=(e.sdkProcessingMetadata||{}).capturedSpanIsolationScope;return this._prepareEvent(e,t,i,f).then(g=>{if(g===null)throw this.recordDroppedEvent("event_processor",d,e),new lt("An event processor returned `null`, will not send event.","log");if(t.data&&t.data.__sentry__===!0)return g;const p=function(v,S,b,I){const{beforeSend:w,beforeSendTransaction:_,beforeSendSpan:T}=S;if(Go(b)&&w)return w(b,I);if(Vo(b)){if(b.spans&&T){const C=[];for(const A of b.spans){const k=T(A);k?C.push(k):(zh(),v.recordDroppedEvent("before_send","span"))}b.spans=C}if(_){if(b.spans){const C=b.spans.length;b.sdkProcessingMetadata={...b.sdkProcessingMetadata,spanCountBeforeProcessing:C}}return _(b,I)}}return b}(this,n,g,t);return function(v,S){const b=`${S} must return \`null\` or a valid event.`;if(_s(v))return v.then(I=>{if(!yi(I)&&I!==null)throw new lt(b);return I},I=>{throw new lt(`${S} rejected with ${I}`)});if(!yi(v)&&v!==null)throw new lt(b);return v}(p,c)}).then(g=>{if(g===null){if(this.recordDroppedEvent("before_send",d,e),a){const S=1+(e.spans||[]).length;this.recordDroppedEvent("before_send","span",S)}throw new lt(`${c} returned \`null\`, will not send event.`,"log")}const p=i&&i.getSession();if(!a&&p&&this._updateSessionFromEvent(p,g),a){const S=(g.sdkProcessingMetadata&&g.sdkProcessingMetadata.spanCountBeforeProcessing||0)-(g.spans?g.spans.length:0);S>0&&this.recordDroppedEvent("before_send","span",S)}const v=g.transaction_info;if(a&&v&&g.transaction!==e.transaction){const S="custom";g.transaction_info={...v,source:S}}return this.sendEvent(g,t),g}).then(null,g=>{throw g instanceof lt?g:(this.captureException(g,{data:{__sentry__:!0},originalException:g}),new lt(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.
Reason: ${g}`))})}_process(e){this._numProcessing++,e.then(t=>(this._numProcessing--,t),t=>(this._numProcessing--,t))}_clearOutcomes(){const e=this._outcomes;return this._outcomes={},Object.entries(e).map(([t,i])=>{const[n,r]=t.split(":");return{reason:n,category:r,quantity:i}})}_flushOutcomes(){be&&se.log("Flushing outcomes...");const e=this._clearOutcomes();if(e.length===0)return void(be&&se.log("No outcomes to send"));if(!this._dsn)return void(be&&se.log("No dsn provided, will not send outcomes"));be&&se.log("Sending outcomes:",e);const t=(i=e,Vi((n=this._options.tunnel&&ws(this._dsn))?{dsn:n}:{},[[{type:"client_report"},{timestamp:r||ji(),discarded_events:i}]]));var i,n,r;this.sendEnvelope(t)}}function Go(s){return s.type===void 0}function Vo(s){return s.type==="transaction"}function cf(s){const e=[];function t(i){return e.splice(e.indexOf(i),1)[0]||Promise.resolve(void 0)}return{$:e,add:function(i){if(!(s===void 0||e.length<s))return As(new lt("Not adding Promise because buffer limit was reached."));const n=i();return e.indexOf(n)===-1&&e.push(n),n.then(()=>t(n)).then(null,()=>t(n).then(null,()=>{})),n},drain:function(i){return new Ze((n,r)=>{let a=e.length;if(!a)return n(!0);const o=setTimeout(()=>{i&&i>0&&n(!1)},i);e.forEach(l=>{si(l).then(()=>{--a||(clearTimeout(o),n(!0))},r)})})}}}function uf(s,{statusCode:e,headers:t},i=Date.now()){const n={...s},r=t&&t["x-sentry-rate-limits"],a=t&&t["retry-after"];if(r)for(const o of r.trim().split(",")){const[l,c,,,u]=o.split(":",5),d=parseInt(l,10),f=1e3*(isNaN(d)?60:d);if(c)for(const g of c.split(";"))g==="metric_bucket"&&u&&!u.split(";").includes("custom")||(n[g]=i+f);else n.all=i+f}else a?n.all=i+function(o,l=Date.now()){const c=parseInt(`${o}`,10);if(!isNaN(c))return 1e3*c;const u=Date.parse(`${o}`);return isNaN(u)?6e4:u-l}(a,i):e===429&&(n.all=i+6e4);return n}function df(s,e,t=cf(s.bufferSize||64)){let i={};return{send:function(n){const r=[];if(Lo(n,(l,c)=>{const u=ko(c);if(function(d,f,g=Date.now()){return function(p,v){return p[v]||p.all||0}(d,f)>g}(i,u)){const d=qo(l,c);s.recordDroppedEvent("ratelimit_backoff",u,d)}else r.push(l)}),r.length===0)return si({});const a=Vi(n[0],r),o=l=>{Lo(a,(c,u)=>{const d=qo(c,u);s.recordDroppedEvent(l,ko(u),d)})};return t.add(()=>e({body:ef(a)}).then(l=>(l.statusCode!==void 0&&(l.statusCode<200||l.statusCode>=300)&&be&&se.warn(`Sentry responded with status code ${l.statusCode} to sent event.`),i=uf(i,l),l),l=>{throw o("network_error"),l})).then(l=>l,l=>{if(l instanceof lt)return be&&se.error("Skipped sending event because buffer is full."),o("queue_overflow"),si({});throw l})},flush:n=>t.drain(n)}}function qo(s,e){if(e==="event"||e==="transaction")return Array.isArray(s)?s[1]:void 0}const hf=100;function ri(s,e){const t=De(),i=Gi();if(!t)return;const{beforeBreadcrumb:n=null,maxBreadcrumbs:r=hf}=t.getOptions();if(r<=0)return;const a={timestamp:ji(),...s},o=n?$i(()=>n(a,e)):a;o!==null&&(t.emit&&t.emit("beforeAddBreadcrumb",o,e),i.addBreadcrumb(o,r))}let Ko;const Ho=new WeakMap,ff=()=>({name:"FunctionToString",setupOnce(){Ko=Function.prototype.toString;try{Function.prototype.toString=function(...s){const e=Nn(this),t=Ho.has(De())&&e!==void 0?e:this;return Ko.apply(t,s)}}catch{}},setup(s){Ho.set(s,!0)}}),pf=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/,/^ResizeObserver loop completed with undelivered notifications.$/,/^Cannot redefine property: googletag$/,"undefined is not an object (evaluating 'a.L')",`can't redefine non-configurable property "solana"`,"vv().getRestrictions is not a function. (In 'vv().getRestrictions(1,a)', 'vv().getRestrictions' is undefined)","Can't find variable: _AutofillCallbackHandler",/^Non-Error promise rejection captured with value: Object Not Found Matching Id:\d+, MethodName:simulateEvent, ParamCount:\d+$/],gf=(s={})=>({name:"InboundFilters",processEvent(e,t,i){const n=i.getOptions(),r=function(a={},o={}){return{allowUrls:[...a.allowUrls||[],...o.allowUrls||[]],denyUrls:[...a.denyUrls||[],...o.denyUrls||[]],ignoreErrors:[...a.ignoreErrors||[],...o.ignoreErrors||[],...a.disableErrorDefaults?[]:pf],ignoreTransactions:[...a.ignoreTransactions||[],...o.ignoreTransactions||[]],ignoreInternal:a.ignoreInternal===void 0||a.ignoreInternal}}(s,n);return function(a,o){return o.ignoreInternal&&function(l){try{return l.exception.values[0].type==="SentryError"}catch{}return!1}(a)?(be&&se.warn(`Event dropped due to being internal Sentry Error.
Event: ${Ft(a)}`),!0):function(l,c){return l.type||!c||!c.length?!1:function(u){const d=[];u.message&&d.push(u.message);let f;try{f=u.exception.values[u.exception.values.length-1]}catch{}return f&&f.value&&(d.push(f.value),f.type&&d.push(`${f.type}: ${f.value}`)),d}(l).some(u=>xs(u,c))}(a,o.ignoreErrors)?(be&&se.warn(`Event dropped due to being matched by \`ignoreErrors\` option.
Event: ${Ft(a)}`),!0):function(l){return l.type||!l.exception||!l.exception.values||l.exception.values.length===0?!1:!l.message&&!l.exception.values.some(c=>c.stacktrace||c.type&&c.type!=="Error"||c.value)}(a)?(be&&se.warn(`Event dropped due to not having an error message, error type or stacktrace.
Event: ${Ft(a)}`),!0):function(l,c){if(l.type!=="transaction"||!c||!c.length)return!1;const u=l.transaction;return!!u&&xs(u,c)}(a,o.ignoreTransactions)?(be&&se.warn(`Event dropped due to being matched by \`ignoreTransactions\` option.
Event: ${Ft(a)}`),!0):function(l,c){if(!c||!c.length)return!1;const u=Cs(l);return!!u&&xs(u,c)}(a,o.denyUrls)?(be&&se.warn(`Event dropped due to being matched by \`denyUrls\` option.
Event: ${Ft(a)}.
Url: ${Cs(a)}`),!0):function(l,c){if(!c||!c.length)return!0;const u=Cs(l);return!u||xs(u,c)}(a,o.allowUrls)?!1:(be&&se.warn(`Event dropped due to not being matched by \`allowUrls\` option.
Event: ${Ft(a)}.
Url: ${Cs(a)}`),!0)}(e,r)?null:e}});function Cs(s){try{let e;try{e=s.exception.values[0].stacktrace.frames}catch{}return e?function(t=[]){for(let i=t.length-1;i>=0;i--){const n=t[i];if(n&&n.filename!=="<anonymous>"&&n.filename!=="[native code]")return n.filename||null}return null}(e):null}catch{return be&&se.error(`Cannot extract url for event ${Ft(s)}`),null}}function mf(s,e,t=250,i,n,r,a){if(!(r.exception&&r.exception.values&&a&&ti(a.originalException,Error)))return;const o=r.exception.values.length>0?r.exception.values[r.exception.values.length-1]:void 0;var l,c;o&&(r.exception.values=(l=Jn(s,e,n,a.originalException,i,r.exception.values,o,0),c=t,l.map(u=>(u.value&&(u.value=Si(u.value,c)),u))))}function Jn(s,e,t,i,n,r,a,o){if(r.length>=t+1)return r;let l=[...r];if(ti(i[n],Error)){Yo(a,o);const c=s(e,i[n]),u=l.length;Wo(c,n,u,o),l=Jn(s,e,t,i[n],n,[c,...l],c,u)}return Array.isArray(i.errors)&&i.errors.forEach((c,u)=>{if(ti(c,Error)){Yo(a,o);const d=s(e,c),f=l.length;Wo(d,`errors[${u}]`,f,o),l=Jn(s,e,t,c,n,[d,...l],d,f)}}),l}function Yo(s,e){s.mechanism=s.mechanism||{type:"generic",handled:!0},s.mechanism={...s.mechanism,...s.type==="AggregateError"&&{is_exception_group:!0},exception_id:e}}function Wo(s,e,t,i){s.mechanism=s.mechanism||{type:"generic",handled:!0},s.mechanism={...s.mechanism,type:"chained",source:e,exception_id:t,parent_id:i}}function Qn(s){if(!s)return{};const e=s.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!e)return{};const t=e[6]||"",i=e[8]||"";return{host:e[4],path:e[5],protocol:e[2],search:t,hash:i,relative:e[5]+t+i}}function vf(){"console"in ge&&kn.forEach(function(s){s in ge.console&&He(ge.console,s,function(e){return ys[s]=e,function(...t){ot("console",{args:t,level:s});const i=ys[s];i&&i.apply(ge.console,t)}})})}function yf(s){return s==="warn"?"warning":["fatal","error","warning","log","info","debug"].includes(s)?s:"log"}const Sf=()=>{let s;return{name:"Dedupe",processEvent(e){if(e.type)return e;try{if(function(t,i){return i?!!(function(n,r){const a=n.message,o=r.message;return!(!a&&!o||a&&!o||!a&&o||a!==o||!Jo(n,r)||!zo(n,r))}(t,i)||function(n,r){const a=Qo(r),o=Qo(n);return!(!a||!o||a.type!==o.type||a.value!==o.value||!Jo(n,r)||!zo(n,r))}(t,i)):!1}(e,s))return be&&se.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{}return s=e}}};function zo(s,e){let t=to(s),i=to(e);if(!t&&!i)return!0;if(t&&!i||!t&&i||i.length!==t.length)return!1;for(let n=0;n<i.length;n++){const r=i[n],a=t[n];if(r.filename!==a.filename||r.lineno!==a.lineno||r.colno!==a.colno||r.function!==a.function)return!1}return!0}function Jo(s,e){let t=s.fingerprint,i=e.fingerprint;if(!t&&!i)return!0;if(t&&!i||!t&&i)return!1;try{return t.join("")===i.join("")}catch{return!1}}function Qo(s){return s.exception&&s.exception.values&&s.exception.values[0]}function Xo(s){return s===void 0?void 0:s>=400&&s<500?"warning":s>=500?"error":void 0}const Xn=ge;function Zn(s){return s&&/^function\s+\w+\(\)\s+\{\s+\[native code\]\s+\}$/.test(s.toString())}function Ef(){if(typeof EdgeRuntime=="string")return!0;if(!function(){if(!("fetch"in Xn))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch{return!1}}())return!1;if(Zn(Xn.fetch))return!0;let s=!1;const e=Xn.document;if(e&&typeof e.createElement=="function")try{const t=e.createElement("iframe");t.hidden=!0,e.head.appendChild(t),t.contentWindow&&t.contentWindow.fetch&&(s=Zn(t.contentWindow.fetch)),e.head.removeChild(t)}catch(t){Qt&&se.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",t)}return s}function bf(s,e){const t="fetch";Zt(t,s),ei(t,()=>function(i,n=!1){n&&!Ef()||He(ge,"fetch",function(r){return function(...a){const o=new Error,{method:l,url:c}=function(d){if(d.length===0)return{method:"GET",url:""};if(d.length===2){const[g,p]=d;return{url:Zo(g),method:er(p,"method")?String(p.method).toUpperCase():"GET"}}const f=d[0];return{url:Zo(f),method:er(f,"method")?String(f.method).toUpperCase():"GET"}}(a),u={args:a,fetchData:{method:l,url:c},startTimestamp:1e3*xt(),virtualError:o};return i||ot("fetch",{...u}),r.apply(ge,a).then(async d=>(i?i(d):ot("fetch",{...u,endTimestamp:1e3*xt(),response:d}),d),d=>{throw ot("fetch",{...u,endTimestamp:1e3*xt(),error:d}),Dn(d)&&d.stack===void 0&&(d.stack=o.stack,ii(d,"framesToPop",1)),d})}})}(void 0,e))}function er(s,e){return!!s&&typeof s=="object"&&!!s[e]}function Zo(s){return typeof s=="string"?s:s?er(s,"url")?s.url:s.toString?s.toString():"":""}const Rs=ge,ke=ge;let tr=0;function el(){return tr>0}function _i(s,e={}){if(!function(i){return typeof i=="function"}(s))return s;try{const i=s.__sentry_wrapped__;if(i)return typeof i=="function"?i:s;if(Nn(s))return s}catch{return s}const t=function(...i){try{const n=i.map(r=>_i(r,e));return s.apply(this,n)}catch(n){throw tr++,setTimeout(()=>{tr--}),function(...r){const a=Vn(bs());if(r.length===2){const[o,l]=r;return o?a.withSetScope(o,l):a.withScope(l)}a.withScope(r[0])}(r=>{var a;r.addEventProcessor(o=>(e.mechanism&&(Bn(o,void 0),Ei(o,e.mechanism)),o.extra={...o.extra,arguments:i},o)),a=n,ni().captureException(a,void 0)}),n}};try{for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}catch{}co(t,s),ii(s,"__sentry_wrapped__",t);try{Object.getOwnPropertyDescriptor(t,"name").configurable&&Object.defineProperty(t,"name",{get:()=>s.name})}catch{}return t}const Ps=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__;function ir(s,e){const t=nr(s,e),i={type:xf(e),value:Af(e)};return t.length&&(i.stacktrace={frames:t}),i.type===void 0&&i.value===""&&(i.value="Unrecoverable error caught"),i}function Tf(s,e,t,i){const n=De(),r=n&&n.getOptions().normalizeDepth,a=function(c){for(const u in c)if(Object.prototype.hasOwnProperty.call(c,u)){const d=c[u];if(d instanceof Error)return d}}(e),o={__serialized__:wo(e,r)};if(a)return{exception:{values:[ir(s,a)]},extra:o};const l={exception:{values:[{type:Ts(e)?e.constructor.name:i?"UnhandledRejection":"Error",value:If(e,{isUnhandledRejection:i})}]},extra:o};if(t){const c=nr(s,t);c.length&&(l.exception.values[0].stacktrace={frames:c})}return l}function sr(s,e){return{exception:{values:[ir(s,e)]}}}function nr(s,e){const t=e.stacktrace||e.stack||"",i=function(r){return r&&_f.test(r.message)?1:0}(e),n=function(r){return typeof r.framesToPop=="number"?r.framesToPop:0}(e);try{return s(t,i,n)}catch{}return[]}const _f=/Minified React error #\d+;/i;function tl(s){return typeof WebAssembly<"u"&&WebAssembly.Exception!==void 0&&s instanceof WebAssembly.Exception}function xf(s){const e=s&&s.name;return!e&&tl(s)?s.message&&Array.isArray(s.message)&&s.message.length==2?s.message[0]:"WebAssembly.Exception":e}function Af(s){const e=s&&s.message;return e?e.error&&typeof e.error.message=="string"?e.error.message:tl(s)&&Array.isArray(s.message)&&s.message.length==2?s.message[1]:e:"No error message"}function rr(s,e,t,i,n){let r;if(no(e)&&e.error)return sr(s,e.error);if(ro(e)||vi(e,"DOMException")){const a=e;if("stack"in e)r=sr(s,e);else{const o=a.name||(ro(a)?"DOMError":"DOMException"),l=a.message?`${o}: ${a.message}`:o;r=ar(s,l,t,i),Bn(r,l)}return"code"in a&&(r.tags={...r.tags,"DOMException.code":`${a.code}`}),r}return Dn(e)?sr(s,e):yi(e)||Ts(e)?(r=Tf(s,e,t,n),Ei(r,{synthetic:!0}),r):(r=ar(s,e,t,i),Bn(r,`${e}`),Ei(r,{synthetic:!0}),r)}function ar(s,e,t,i){const n={};if(i&&t){const r=nr(s,t);r.length&&(n.exception={values:[{value:e,stacktrace:{frames:r}}]}),Ei(n,{synthetic:!0})}if(On(e)){const{__sentry_template_string__:r,__sentry_template_values__:a}=e;return n.logentry={message:r,params:a},n}return n.message=e,n}function If(s,{isUnhandledRejection:e}){const t=function(n,r=40){const a=Object.keys(uo(n));a.sort();const o=a[0];if(!o)return"[object has no keys]";if(o.length>=r)return Si(o,r);for(let l=a.length;l>0;l--){const c=a.slice(0,l).join(", ");if(!(c.length>r))return l===a.length?c:Si(c,r)}return""}(s),i=e?"promise rejection":"exception";return no(s)?`Event \`ErrorEvent\` captured as ${i} with message \`${s.message}\``:Ts(s)?`Event \`${function(n){try{const r=Object.getPrototypeOf(n);return r?r.constructor.name:void 0}catch{}}(s)}\` (type=${s.type}) captured as ${i}`:`Object captured as ${i} with keys: ${t}`}class wf extends lf{constructor(e){const t={parentSpanIsAlwaysRootSpan:!0,...e};(function(i,n,r=[n],a="npm"){const o=i._metadata||{};o.sdk||(o.sdk={name:`sentry.javascript.${n}`,packages:r.map(l=>({name:`${a}:@sentry/${l}`,version:Jt})),version:Jt}),i._metadata=o})(t,"browser",["browser"],ke.SENTRY_SDK_SOURCE||"npm"),super(t),t.sendClientReports&&ke.document&&ke.document.addEventListener("visibilitychange",()=>{ke.document.visibilityState==="hidden"&&this._flushOutcomes()})}eventFromException(e,t){return function(i,n,r,a){const o=rr(i,n,r&&r.syntheticException||void 0,a);return Ei(o),o.level="error",r&&r.event_id&&(o.event_id=r.event_id),si(o)}(this._options.stackParser,e,t,this._options.attachStacktrace)}eventFromMessage(e,t="info",i){return function(n,r,a="info",o,l){const c=ar(n,r,o&&o.syntheticException||void 0,l);return c.level=a,o&&o.event_id&&(c.event_id=o.event_id),si(c)}(this._options.stackParser,e,t,i,this._options.attachStacktrace)}captureUserFeedback(e){if(!this._isEnabled())return void(Ps&&se.warn("SDK not enabled, will not capture user feedback."));const t=function(i,{metadata:n,tunnel:r,dsn:a}){const o={event_id:i.event_id,sent_at:new Date().toISOString(),...n&&n.sdk&&{sdk:{name:n.sdk.name,version:n.sdk.version}},...!!r&&!!a&&{dsn:ws(a)}};return Vi(o,[function(c){return[{type:"user_report"},c]}(i)])}(e,{metadata:this.getSdkMetadata(),dsn:this.getDsn(),tunnel:this.getOptions().tunnel});this.sendEnvelope(t)}_prepareEvent(e,t,i){return e.platform=e.platform||"javascript",super._prepareEvent(e,t,i)}}const Lf=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,Ue=ge;let il,or,lr,Ds;function kf(){if(!Ue.document)return;const s=ot.bind(null,"dom"),e=sl(s,!0);Ue.document.addEventListener("click",e,!1),Ue.document.addEventListener("keypress",e,!1),["EventTarget","Node"].forEach(t=>{const i=Ue[t],n=i&&i.prototype;n&&n.hasOwnProperty&&n.hasOwnProperty("addEventListener")&&(He(n,"addEventListener",function(r){return function(a,o,l){if(a==="click"||a=="keypress")try{const c=this.__sentry_instrumentation_handlers__=this.__sentry_instrumentation_handlers__||{},u=c[a]=c[a]||{refCount:0};if(!u.handler){const d=sl(s);u.handler=d,r.call(this,a,d,l)}u.refCount++}catch{}return r.call(this,a,o,l)}}),He(n,"removeEventListener",function(r){return function(a,o,l){if(a==="click"||a=="keypress")try{const c=this.__sentry_instrumentation_handlers__||{},u=c[a];u&&(u.refCount--,u.refCount<=0&&(r.call(this,a,u.handler,l),u.handler=void 0,delete c[a]),Object.keys(c).length===0&&delete this.__sentry_instrumentation_handlers__)}catch{}return r.call(this,a,o,l)}}))})}function sl(s,e=!1){return t=>{if(!t||t._sentryCaptured)return;const i=function(r){try{return r.target}catch{return null}}(t);if(function(r,a){return r==="keypress"&&(!a||!a.tagName||a.tagName!=="INPUT"&&a.tagName!=="TEXTAREA"&&!a.isContentEditable)}(t.type,i))return;ii(t,"_sentryCaptured",!0),i&&!i._sentryId&&ii(i,"_sentryId",Xe());const n=t.type==="keypress"?"input":t.type;(function(r){if(r.type!==or)return!1;try{if(!r.target||r.target._sentryId!==lr)return!1}catch{}return!0})(t)||(s({event:t,name:n,global:e}),or=t.type,lr=i?i._sentryId:void 0),clearTimeout(il),il=Ue.setTimeout(()=>{lr=void 0,or=void 0},1e3)}}function nl(s){const e="history";Zt(e,s),ei(e,Cf)}function Cf(){if(!function(){const t=Rs.chrome,i=t&&t.app&&t.app.runtime,n="history"in Rs&&!!Rs.history.pushState&&!!Rs.history.replaceState;return!i&&n}())return;const s=Ue.onpopstate;function e(t){return function(...i){const n=i.length>2?i[2]:void 0;if(n){const r=Ds,a=String(n);Ds=a,ot("history",{from:r,to:a})}return t.apply(this,i)}}Ue.onpopstate=function(...t){const i=Ue.location.href,n=Ds;if(Ds=i,ot("history",{from:n,to:i}),s)try{return s.apply(this,t)}catch{}},He(Ue.history,"pushState",e),He(Ue.history,"replaceState",e)}const Os={};function rl(s){Os[s]=void 0}const qi="__sentry_xhr_v3__";function Rf(){if(!Ue.XMLHttpRequest)return;const s=XMLHttpRequest.prototype;s.open=new Proxy(s.open,{apply(e,t,i){const n=new Error,r=1e3*xt(),a=_t(i[0])?i[0].toUpperCase():void 0,o=function(c){if(_t(c))return c;try{return c.toString()}catch{}}(i[1]);if(!a||!o)return e.apply(t,i);t[qi]={method:a,url:o,request_headers:{}},a==="POST"&&o.match(/sentry_key/)&&(t.__sentry_own_request__=!0);const l=()=>{const c=t[qi];if(c&&t.readyState===4){try{c.status_code=t.status}catch{}ot("xhr",{endTimestamp:1e3*xt(),startTimestamp:r,xhr:t,virtualError:n})}};return"onreadystatechange"in t&&typeof t.onreadystatechange=="function"?t.onreadystatechange=new Proxy(t.onreadystatechange,{apply:(c,u,d)=>(l(),c.apply(u,d))}):t.addEventListener("readystatechange",l),t.setRequestHeader=new Proxy(t.setRequestHeader,{apply(c,u,d){const[f,g]=d,p=u[qi];return p&&_t(f)&&_t(g)&&(p.request_headers[f.toLowerCase()]=g),c.apply(u,d)}}),e.apply(t,i)}}),s.send=new Proxy(s.send,{apply(e,t,i){const n=t[qi];return n?(i[0]!==void 0&&(n.body=i[0]),ot("xhr",{startTimestamp:1e3*xt(),xhr:t}),e.apply(t,i)):e.apply(t,i)}})}function Pf(s,e=function(t){const i=Os[t];if(i)return i;let n=Ue[t];if(Zn(n))return Os[t]=n.bind(Ue);const r=Ue.document;if(r&&typeof r.createElement=="function")try{const a=r.createElement("iframe");a.hidden=!0,r.head.appendChild(a);const o=a.contentWindow;o&&o[t]&&(n=o[t]),r.head.removeChild(a)}catch(a){Lf&&se.warn(`Could not create sandbox iframe for ${t} check, bailing to window.${t}: `,a)}return n&&(Os[t]=n.bind(Ue))}("fetch")){let t=0,i=0;return df(s,function(n){const r=n.body.length;t+=r,i++;const a={body:n.body,method:"POST",referrerPolicy:"origin",headers:s.headers,keepalive:t<=6e4&&i<15,...s.fetchOptions};if(!e)return rl("fetch"),As("No fetch implementation available");try{return e(s.url,a).then(o=>(t-=r,i--,{statusCode:o.status,headers:{"x-sentry-rate-limits":o.headers.get("X-Sentry-Rate-Limits"),"retry-after":o.headers.get("Retry-After")}}))}catch(o){return rl("fetch"),t-=r,i--,As(o)}})}function cr(s,e,t,i){const n={filename:s,function:e==="<anonymous>"?Xt:e,in_app:!0};return t!==void 0&&(n.lineno=t),i!==void 0&&(n.colno=i),n}const Df=/^\s*at (\S+?)(?::(\d+))(?::(\d+))\s*$/i,Of=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,Mf=/\((\S*)(?::(\d+))(?::(\d+))\)/,Ff=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,Nf=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,Uf=function(...s){const e=s.sort((t,i)=>t[0]-i[0]).map(t=>t[1]);return(t,i=0,n=0)=>{const r=[],a=t.split(`
`);for(let o=i;o<a.length;o++){const l=a[o];if(l.length>1024)continue;const c=Xa.test(l)?l.replace(Xa,"$1"):l;if(!c.match(/\S*Error: /)){for(const u of e){const d=u(c);if(d){r.push(d);break}}if(r.length>=50+n)break}}return function(o){if(!o.length)return[];const l=Array.from(o);return/sentryWrapped/.test(Ss(l).function||"")&&l.pop(),l.reverse(),Za.test(Ss(l).function||"")&&(l.pop(),Za.test(Ss(l).function||"")&&l.pop()),l.slice(0,50).map(c=>({...c,filename:c.filename||Ss(l).filename,function:c.function||Xt}))}(r.slice(n))}}([30,s=>{const e=Df.exec(s);if(e){const[,i,n,r]=e;return cr(i,Xt,+n,+r)}const t=Of.exec(s);if(t){if(t[2]&&t[2].indexOf("eval")===0){const r=Mf.exec(t[2]);r&&(t[2]=r[1],t[3]=r[2],t[4]=r[3])}const[i,n]=al(t[1]||Xt,t[2]);return cr(n,i,t[3]?+t[3]:void 0,t[4]?+t[4]:void 0)}}],[50,s=>{const e=Ff.exec(s);if(e){if(e[3]&&e[3].indexOf(" > eval")>-1){const n=Nf.exec(e[3]);n&&(e[1]=e[1]||"eval",e[3]=n[1],e[4]=n[2],e[5]="")}let t=e[3],i=e[1]||Xt;return[i,t]=al(i,t),cr(t,i,e[4]?+e[4]:void 0,e[5]?+e[5]:void 0)}}]),al=(s,e)=>{const t=s.indexOf("safari-extension")!==-1,i=s.indexOf("safari-web-extension")!==-1;return t||i?[s.indexOf("@")!==-1?s.split("@")[0]:Xt,t?`safari-extension:${e}`:`safari-web-extension:${e}`]:[s,e]},ol=1024,Bf=(s={})=>{const e={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...s};return{name:"Breadcrumbs",setup(t){var i;e.console&&function(n){const r="console";Zt(r,n),ei(r,vf)}(function(n){return function(r){if(De()!==n)return;const a={category:"console",data:{arguments:r.args,logger:"console"},level:yf(r.level),message:lo(r.args," ")};if(r.level==="assert"){if(r.args[0]!==!1)return;a.message=`Assertion failed: ${lo(r.args.slice(1)," ")||"console.assert"}`,a.data.arguments=r.args.slice(1)}ri(a,{input:r.args,level:r.level})}}(t)),e.dom&&(i=function(n,r){return function(a){if(De()!==n)return;let o,l,c=typeof r=="object"?r.serializeAttribute:void 0,u=typeof r=="object"&&typeof r.maxStringLength=="number"?r.maxStringLength:void 0;u&&u>ol&&(Ps&&se.warn(`\`dom.maxStringLength\` cannot exceed 1024, but a value of ${u} was configured. Sentry will use 1024 instead.`),u=ol),typeof c=="string"&&(c=[c]);try{const f=a.event,g=function(p){return!!p&&!!p.target}(f)?f.target:f;o=oo(g,{keyAttrs:c,maxStringLength:u}),l=function(p){if(!Fn.HTMLElement)return null;let v=p;for(let S=0;S<5;S++){if(!v)return null;if(v instanceof HTMLElement){if(v.dataset.sentryComponent)return v.dataset.sentryComponent;if(v.dataset.sentryElement)return v.dataset.sentryElement}v=v.parentNode}return null}(g)}catch{o="<unknown>"}if(o.length===0)return;const d={category:`ui.${a.name}`,message:o};l&&(d.data={"ui.component_name":l}),ri(d,{event:a.event,name:a.name,global:a.global})}}(t,e.dom),Zt("dom",i),ei("dom",kf)),e.xhr&&function(n){Zt("xhr",n),ei("xhr",Rf)}(function(n){return function(r){if(De()!==n)return;const{startTimestamp:a,endTimestamp:o}=r,l=r.xhr[qi];if(!a||!o||!l)return;const{method:c,url:u,status_code:d,body:f}=l,g={method:c,url:u,status_code:d},p={xhr:r.xhr,input:f,startTimestamp:a,endTimestamp:o};ri({category:"xhr",data:g,type:"http",level:Xo(d)},p)}}(t)),e.fetch&&bf(function(n){return function(r){if(De()!==n)return;const{startTimestamp:a,endTimestamp:o}=r;if(o&&(!r.fetchData.url.match(/sentry_key/)||r.fetchData.method!=="POST"))if(r.error)ri({category:"fetch",data:r.fetchData,level:"error",type:"http"},{data:r.error,input:r.args,startTimestamp:a,endTimestamp:o});else{const l=r.response,c={...r.fetchData,status_code:l&&l.status},u={input:r.args,response:l,startTimestamp:a,endTimestamp:o};ri({category:"fetch",data:c,type:"http",level:Xo(c.status_code)},u)}}}(t)),e.history&&nl(function(n){return function(r){if(De()!==n)return;let a=r.from,o=r.to;const l=Qn(ke.location.href);let c=a?Qn(a):void 0;const u=Qn(o);c&&c.path||(c=l),l.protocol===u.protocol&&l.host===u.host&&(o=u.relative),l.protocol===c.protocol&&l.host===c.host&&(a=c.relative),ri({category:"navigation",data:{from:a,to:o}})}}(t)),e.sentry&&t.on("beforeSendEvent",function(n){return function(r){De()===n&&ri({category:"sentry."+(r.type==="transaction"?"transaction":"event"),event_id:r.event_id,level:r.level,message:Ft(r)},{event:r})}}(t))}}},$f=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","BroadcastChannel","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","SharedWorker","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],jf=(s={})=>{const e={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,...s};return{name:"BrowserApiErrors",setupOnce(){e.setTimeout&&He(ke,"setTimeout",ll),e.setInterval&&He(ke,"setInterval",ll),e.requestAnimationFrame&&He(ke,"requestAnimationFrame",Gf),e.XMLHttpRequest&&"XMLHttpRequest"in ke&&He(XMLHttpRequest.prototype,"send",Vf);const t=e.eventTarget;t&&(Array.isArray(t)?t:$f).forEach(qf)}}};function ll(s){return function(...e){const t=e[0];return e[0]=_i(t,{mechanism:{data:{function:Mt(s)},handled:!1,type:"instrument"}}),s.apply(this,e)}}function Gf(s){return function(e){return s.apply(this,[_i(e,{mechanism:{data:{function:"requestAnimationFrame",handler:Mt(s)},handled:!1,type:"instrument"}})])}}function Vf(s){return function(...e){const t=this;return["onload","onerror","onprogress","onreadystatechange"].forEach(i=>{i in t&&typeof t[i]=="function"&&He(t,i,function(n){const r={mechanism:{data:{function:i,handler:Mt(n)},handled:!1,type:"instrument"}},a=Nn(n);return a&&(r.mechanism.data.handler=Mt(a)),_i(n,r)})}),s.apply(this,e)}}function qf(s){const e=ke[s],t=e&&e.prototype;t&&t.hasOwnProperty&&t.hasOwnProperty("addEventListener")&&(He(t,"addEventListener",function(i){return function(n,r,a){try{typeof r.handleEvent=="function"&&(r.handleEvent=_i(r.handleEvent,{mechanism:{data:{function:"handleEvent",handler:Mt(r),target:s},handled:!1,type:"instrument"}}))}catch{}return i.apply(this,[n,_i(r,{mechanism:{data:{function:"addEventListener",handler:Mt(r),target:s},handled:!1,type:"instrument"}}),a])}}),He(t,"removeEventListener",function(i){return function(n,r,a){try{const o=r.__sentry_wrapped__;o&&i.call(this,n,o,a)}catch{}return i.call(this,n,r,a)}}))}const Kf=()=>({name:"BrowserSession",setupOnce(){ke.document!==void 0?(Oo({ignoreDuration:!0}),No(),nl(({from:s,to:e})=>{s!==void 0&&s!==e&&(Oo({ignoreDuration:!0}),No())})):Ps&&se.warn("Using the `browserSessionIntegration` in non-browser environments is not supported.")}}),Hf=(s={})=>{const e={onerror:!0,onunhandledrejection:!0,...s};return{name:"GlobalHandlers",setupOnce(){Error.stackTraceLimit=50},setup(t){e.onerror&&(function(i){(function(n){const r="error";Zt(r,n),ei(r,Mh)})(n=>{const{stackParser:r,attachStacktrace:a}=ul();if(De()!==i||el())return;const{msg:o,url:l,line:c,column:u,error:d}=n,f=function(g,p,v,S){const b=g.exception=g.exception||{},I=b.values=b.values||[],w=I[0]=I[0]||{},_=w.stacktrace=w.stacktrace||{},T=_.frames=_.frames||[],C=S,A=v,k=_t(p)&&p.length>0?p:function(){try{return Fn.document.location.href}catch{return""}}();return T.length===0&&T.push({colno:C,filename:k,function:Xt,in_app:!0,lineno:A}),g}(rr(r,d||o,void 0,a,!1),l,c,u);f.level="error",Do(f,{originalException:d,mechanism:{handled:!1,type:"onerror"}})})}(t),cl("onerror")),e.onunhandledrejection&&(function(i){(function(n){const r="unhandledrejection";Zt(r,n),ei(r,Fh)})(n=>{const{stackParser:r,attachStacktrace:a}=ul();if(De()!==i||el())return;const o=function(c){if(Mn(c))return c;try{if("reason"in c)return c.reason;if("detail"in c&&"reason"in c.detail)return c.detail.reason}catch{}return c}(n),l=Mn(o)?{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(o)}`}]}}:rr(r,o,void 0,a,!0);l.level="error",Do(l,{originalException:o,mechanism:{handled:!1,type:"onunhandledrejection"}})})}(t),cl("onunhandledrejection"))}}};function cl(s){Ps&&se.log(`Global Handler attached: ${s}`)}function ul(){const s=De();return s&&s.getOptions()||{stackParser:()=>[],attachStacktrace:!1}}const Yf=()=>({name:"HttpContext",preprocessEvent(s){if(!ke.navigator&&!ke.location&&!ke.document)return;const e=s.request&&s.request.url||ke.location&&ke.location.href,{referrer:t}=ke.document||{},{userAgent:i}=ke.navigator||{},n={...s.request&&s.request.headers,...t&&{Referer:t},...i&&{"User-Agent":i}},r={...s.request,...e&&{url:e},headers:n};s.request=r}}),Wf=(s={})=>{const e=s.limit||5,t=s.key||"cause";return{name:"LinkedErrors",preprocessEvent(i,n,r){const a=r.getOptions();mf(ir,a.stackParser,a.maxValueLength,t,e,i,n)}}};var ur="new",dl="loading",hl="loaded",Ms="joining-meeting",Ut="joined-meeting",Bt="left-meeting",wt="error",zf="blocked",Jf="off",Qf="sendable",Xf="loading",Zf="interrupted",fl="playable",Fs="unknown",pl="full",ep="lobby",tp="none",gl="base",ip="*",sp="ejected",np="nbf-room",rp="nbf-token",ap="exp-room",op="exp-token",dr="no-room",lp="meeting-full",ml="end-of-life",cp="not-allowed",vl="connection-error",up="cam-in-use",dp="mic-in-use",hp="cam-mic-in-use",fp="permissions",pp="undefined-mediadevices",gp="not-found",mp="constraints",vp="unknown",yl="iframe-ready-for-launch-config",Sl="iframe-launch-config",El="theme-updated",bl="loading",Tl="load-attempt-failed",hr="loaded",_l="started-camera",xl="camera-error",Al="joining-meeting",Il="joined-meeting",wl="left-meeting",Ll="participant-joined",kl="participant-updated",Cl="participant-left",Rl="participant-counts-updated",Pl="access-state-updated",Dl="meeting-session-summary-updated",Ol="meeting-session-state-updated",yp="meeting-session-data-error",Ml="waiting-participant-added",Fl="waiting-participant-updated",Nl="waiting-participant-removed",Ul="track-started",Bl="track-stopped",$l="transcription-started",jl="transcription-stopped",Gl="transcription-error",fr="recording-started",pr="recording-stopped",Vl="recording-stats",ql="recording-error",Kl="recording-upload-completed",Hl="recording-data",Yl="app-message",Wl="transcription-message",zl="remote-media-player-started",Jl="remote-media-player-updated",Ql="remote-media-player-stopped",Xl="local-screen-share-started",Zl="local-screen-share-stopped",ec="local-screen-share-canceled",tc="active-speaker-change",ic="active-speaker-mode-change",sc="network-quality-change",nc="network-connection",rc="cpu-load-change",ac="face-counts-updated",Ki="fullscreen",Hi="exited-fullscreen",oc="live-streaming-started",lc="live-streaming-updated",cc="live-streaming-stopped",uc="live-streaming-error",dc="lang-updated",hc="receive-settings-updated",gr="input-settings-updated",mr="nonfatal-error",vr="error",yr=4096,fc=102400,Sr="iframe-call-message",pc="local-screen-start",gc="daily-method-update-live-streaming-endpoints",Ns="transmit-log",Lt="daily-custom-track",Us={NONE:"none",BGBLUR:"background-blur",BGIMAGE:"background-image",FACE_DETECTION:"face-detection"},mc={NONE:"none",NOISE_CANCELLATION:"noise-cancellation"},Er={PLAY:"play",PAUSE:"pause"},br=["jpg","png","jpeg"],Sp="add-endpoints",Ep="remove-endpoints",vc="sip-call-transfer";function et(){return!he()&&typeof window<"u"&&window.navigator&&window.navigator.userAgent?window.navigator.userAgent:""}function he(){return typeof navigator<"u"&&navigator.product&&navigator.product==="ReactNative"}function yc(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia}function bp(){return!!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)&&(function(s,e){if(!s||!e)return!0;switch(s){case"Chrome":return e.major>=75;case"Safari":return RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection")&&!(e.major===13&&e.minor===0&&e.point===0);case"Firefox":return e.major>=67}return!0}(ai(),Bs())||he())}function Sc(){if(he()||!document)return!1;var s=document.createElement("iframe");return!!s.requestFullscreen||!!s.webkitRequestFullscreen}var Tr="none",Tp="software",_p="hardware",xp=function(){try{var s,e=document.createElement("canvas"),t=!1;(s=e.getContext("webgl2",{failIfMajorPerformanceCaveat:!0}))||(t=!0,s=e.getContext("webgl2"));var i=s!=null;return e.remove(),i?t?Tp:_p:Tr}catch{return Tr}}();function Ec(){var s=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return!he()&&xp!==Tr&&(s?function(){return xc()?!1:["Chrome","Firefox"].includes(ai())}():function(){if(xc())return!1;var e=ai();if(e==="Safari"){var t=xr();if(t.major<15||t.major===15&&t.minor<4)return!1}return e==="Chrome"?_r().major>=77:e==="Firefox"?Ar().major>=97:["Chrome","Firefox","Safari"].includes(e)}())}function bc(){if(he()||_c()||typeof AudioWorkletNode>"u")return!1;switch(ai()){case"Chrome":case"Firefox":return!0;case"Safari":var s=Bs();return s.major>17||s.major===17&&s.minor>=4}return!1}function Tc(){return yc()&&!function(){var s,e=ai();if(!et())return!0;switch(e){case"Chrome":return(s=_r()).major&&s.major>0&&s.major<75;case"Firefox":return(s=Ar()).major<91;case"Safari":return(s=xr()).major<13||s.major===13&&s.minor<1;default:return!0}}()}function _c(){return et().match(/Linux; Android/)}function xc(){var s,e=et(),t=e.match(/Mac/)&&(!he()&&typeof window<"u"&&(s=window)!==null&&s!==void 0&&(s=s.navigator)!==null&&s!==void 0&&s.maxTouchPoints?window.navigator.maxTouchPoints:0)>=5;return!!(e.match(/Mobi/)||e.match(/Android/)||t)||!!et().match(/DailyAnd\//)||void 0}function ai(){if(typeof window<"u"){var s=et();return Ac()?"Safari":s.indexOf("Edge")>-1?"Edge":s.match(/Chrome\//)?"Chrome":s.indexOf("Safari")>-1||Ic()?"Safari":s.indexOf("Firefox")>-1?"Firefox":s.indexOf("MSIE")>-1||s.indexOf(".NET")>-1?"IE":"Unknown Browser"}}function Bs(){switch(ai()){case"Chrome":return _r();case"Safari":return xr();case"Firefox":return Ar();case"Edge":return function(){var s=0,e=0;if(typeof window<"u"){var t=et().match(/Edge\/(\d+).(\d+)/);if(t)try{s=parseInt(t[1]),e=parseInt(t[2])}catch{}}return{major:s,minor:e}}()}}function _r(){var s=0,e=0,t=0,i=0,n=!1;if(typeof window<"u"){var r=et(),a=r.match(/Chrome\/(\d+).(\d+).(\d+).(\d+)/);if(a)try{s=parseInt(a[1]),e=parseInt(a[2]),t=parseInt(a[3]),i=parseInt(a[4]),n=r.indexOf("OPR/")>-1}catch{}}return{major:s,minor:e,build:t,patch:i,opera:n}}function Ac(){return!!et().match(/iPad|iPhone|iPod/i)&&yc()}function Ic(){return et().indexOf("AppleWebKit/605.1.15")>-1}function xr(){var s=0,e=0,t=0;if(typeof window<"u"){var i=et().match(/Version\/(\d+).(\d+)(.(\d+))?/);if(i)try{s=parseInt(i[1]),e=parseInt(i[2]),t=parseInt(i[4])}catch{}else(Ac()||Ic())&&(s=14,e=0,t=3)}return{major:s,minor:e,point:t}}function Ar(){var s=0,e=0;if(typeof window<"u"){var t=et().match(/Firefox\/(\d+).(\d+)/);if(t)try{s=parseInt(t[1]),e=parseInt(t[2])}catch{}}return{major:s,minor:e}}var wc=function(){return Ke(function s(){qe(this,s)},[{key:"addListenerForMessagesFromCallMachine",value:function(s,e,t){Bi()}},{key:"addListenerForMessagesFromDailyJs",value:function(s,e,t){Bi()}},{key:"sendMessageToCallMachine",value:function(s,e,t,i){Bi()}},{key:"sendMessageToDailyJs",value:function(s,e){Bi()}},{key:"removeListener",value:function(s){Bi()}}])}();function Lc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function Ir(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Lc(Object(t),!0).forEach(function(i){ft(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Lc(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}function kc(){try{var s=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(kc=function(){return!!s})()}var Ap=function(){function s(){var e,t,i,n;return qe(this,s),t=this,i=at(i=s),(e=us(t,kc()?Reflect.construct(i,[],at(t).constructor):i.apply(t,n)))._wrappedListeners={},e._messageCallbacks={},e}return ds(s,wc),Ke(s,[{key:"addListenerForMessagesFromCallMachine",value:function(e,t,i){var n=this,r=function(a){if(a.data&&a.data.what==="iframe-call-message"&&(!a.data.callClientId||a.data.callClientId===t)&&(!a.data.from||a.data.from!=="module")){var o=Ir({},a.data);if(delete o.from,o.callbackStamp&&n._messageCallbacks[o.callbackStamp]){var l=o.callbackStamp;n._messageCallbacks[l].call(i,o),delete n._messageCallbacks[l]}delete o.what,delete o.callbackStamp,e.call(i,o)}};this._wrappedListeners[e]=r,window.addEventListener("message",r)}},{key:"addListenerForMessagesFromDailyJs",value:function(e,t,i){var n=function(r){var a;if(!(!r.data||r.data.what!==Sr||!r.data.action||r.data.from&&r.data.from!=="module"||r.data.callClientId&&t&&r.data.callClientId!==t||r!=null&&(a=r.data)!==null&&a!==void 0&&a.callFrameId)){var o=r.data;e.call(i,o)}};this._wrappedListeners[e]=n,window.addEventListener("message",n)}},{key:"sendMessageToCallMachine",value:function(e,t,i,n){if(!i)throw new Error("undefined callClientId. Are you trying to use a DailyCall instance previously destroyed?");var r=Ir({},e);if(r.what=Sr,r.from="module",r.callClientId=i,t){var a=ps();this._messageCallbacks[a]=t,r.callbackStamp=a}var o=n?n.contentWindow:window,l=this._callMachineTargetOrigin(n);l&&o.postMessage(r,l)}},{key:"sendMessageToDailyJs",value:function(e,t){e.what=Sr,e.callClientId=t,e.from="embedded",window.postMessage(e,this._targetOriginFromWindowLocation())}},{key:"removeListener",value:function(e){var t=this._wrappedListeners[e];t&&(window.removeEventListener("message",t),delete this._wrappedListeners[e])}},{key:"forwardPackagedMessageToCallMachine",value:function(e,t,i){var n=Ir({},e);n.callClientId=i;var r=t?t.contentWindow:window,a=this._callMachineTargetOrigin(t);a&&r.postMessage(n,a)}},{key:"addListenerForPackagedMessagesFromCallMachine",value:function(e,t){var i=function(n){if(n.data&&n.data.what==="iframe-call-message"&&(!n.data.callClientId||n.data.callClientId===t)&&(!n.data.from||n.data.from!=="module")){var r=n.data;e(r)}};return this._wrappedListeners[e]=i,window.addEventListener("message",i),e}},{key:"removeListenerForPackagedMessagesFromCallMachine",value:function(e){var t=this._wrappedListeners[e];t&&(window.removeEventListener("message",t),delete this._wrappedListeners[e])}},{key:"_callMachineTargetOrigin",value:function(e){return e?e.src?new URL(e.src).origin:void 0:this._targetOriginFromWindowLocation()}},{key:"_targetOriginFromWindowLocation",value:function(){return window.location.protocol==="file:"?"*":window.location.origin}}])}();function Cc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function Rc(){try{var s=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Rc=function(){return!!s})()}var Ip=function(){function s(){var e,t,i,n;return qe(this,s),t=this,i=at(i=s),e=us(t,Rc()?Reflect.construct(i,[],at(t).constructor):i.apply(t,n)),global.callMachineToDailyJsEmitter=global.callMachineToDailyJsEmitter||new Ln.EventEmitter,global.dailyJsToCallMachineEmitter=global.dailyJsToCallMachineEmitter||new Ln.EventEmitter,e._wrappedListeners={},e._messageCallbacks={},e}return ds(s,wc),Ke(s,[{key:"addListenerForMessagesFromCallMachine",value:function(e,t,i){this._addListener(e,global.callMachineToDailyJsEmitter,t,i,"received call machine message")}},{key:"addListenerForMessagesFromDailyJs",value:function(e,t,i){this._addListener(e,global.dailyJsToCallMachineEmitter,t,i,"received daily-js message")}},{key:"sendMessageToCallMachine",value:function(e,t,i){this._sendMessage(e,global.dailyJsToCallMachineEmitter,i,t,"sending message to call machine")}},{key:"sendMessageToDailyJs",value:function(e,t){this._sendMessage(e,global.callMachineToDailyJsEmitter,t,null,"sending message to daily-js")}},{key:"removeListener",value:function(e){var t=this._wrappedListeners[e];t&&(global.callMachineToDailyJsEmitter.removeListener("message",t),global.dailyJsToCallMachineEmitter.removeListener("message",t),delete this._wrappedListeners[e])}},{key:"_addListener",value:function(e,t,i,n,r){var a=this,o=function(l){if(l.callClientId===i){if(l.callbackStamp&&a._messageCallbacks[l.callbackStamp]){var c=l.callbackStamp;a._messageCallbacks[c].call(n,l),delete a._messageCallbacks[c]}e.call(n,l)}};this._wrappedListeners[e]=o,t.addListener("message",o)}},{key:"_sendMessage",value:function(e,t,i,n,r){var a=function(l){for(var c=1;c<arguments.length;c++){var u=arguments[c]!=null?arguments[c]:{};c%2?Cc(Object(u),!0).forEach(function(d){ft(l,d,u[d])}):Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(u)):Cc(Object(u)).forEach(function(d){Object.defineProperty(l,d,Object.getOwnPropertyDescriptor(u,d))})}return l}({},e);if(a.callClientId=i,n){var o=ps();this._messageCallbacks[o]=n,a.callbackStamp=o}t.emit("message",a)}}])}(),wr="replace",Lr="shallow-merge",Pc=[wr,Lr],wp=function(){function s(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e.data,i=e.mergeStrategy,n=i===void 0?wr:i;qe(this,s),s._validateMergeStrategy(n),s._validateData(t,n),this.mergeStrategy=n,this.data=t}return Ke(s,[{key:"isNoOp",value:function(){return s.isNoOpUpdate(this.data,this.mergeStrategy)}}],[{key:"isNoOpUpdate",value:function(e,t){return Object.keys(e).length===0&&t===Lr}},{key:"_validateMergeStrategy",value:function(e){if(!Pc.includes(e))throw Error("Unrecognized mergeStrategy provided. Options are: [".concat(Pc,"]"))}},{key:"_validateData",value:function(e,t){if(!function(o){if(o==null||fe(o)!=="object")return!1;var l=Object.getPrototypeOf(o);return l==null||l===Object.prototype}(e))throw Error("Meeting session data must be a plain (map-like) object");var i;try{if(i=JSON.stringify(e),t===wr){var n=JSON.parse(i);Fe(n,e)||console.warn("The meeting session data provided will be modified when serialized.",n,e)}else if(t===Lr){for(var r in e)if(Object.hasOwnProperty.call(e,r)&&e[r]!==void 0){var a=JSON.parse(JSON.stringify(e[r]));Fe(e[r],a)||console.warn("At least one key in the meeting session data provided will be modified when serialized.",a,e[r])}}}catch(o){throw Error("Meeting session data must be serializable to JSON: ".concat(o))}if(i.length>fc)throw Error("Meeting session data is too large (".concat(i.length," characters). Maximum size suppported is ").concat(fc,"."))}}])}();function Dc(){try{var s=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Dc=function(){return!!s})()}function kr(s){var e=typeof Map=="function"?new Map:void 0;return kr=function(t){if(t===null||!function(n){try{return Function.toString.call(n).indexOf("[native code]")!==-1}catch{return typeof n=="function"}}(t))return t;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(e!==void 0){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return function(n,r,a){if(Dc())return Reflect.construct.apply(null,arguments);var o=[null];o.push.apply(o,r);var l=new(n.bind.apply(n,o));return a&&Ui(l,a.prototype),l}(t,arguments,at(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),Ui(i,t)},kr(s)}function Oc(){try{var s=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Oc=function(){return!!s})()}function Mc(s){var e,t=(e=window._daily)===null||e===void 0?void 0:e.pendings;if(t){var i=t.indexOf(s);i!==-1&&t.splice(i,1)}}var Lp=function(){return Ke(function s(e){qe(this,s),this._currentLoad=null,this._callClientId=e},[{key:"load",value:function(){var s,e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;if(this.loaded)return window._daily.instances[this._callClientId].callMachine.reset(),void i(!0);s=this._callClientId,window._daily.pendings.push(s),this._currentLoad&&this._currentLoad.cancel(),this._currentLoad=new kp(t,function(){i(!1)},function(r,a){a||Mc(e._callClientId),n(r,a)}),this._currentLoad.start()}},{key:"cancel",value:function(){this._currentLoad&&this._currentLoad.cancel(),Mc(this._callClientId)}},{key:"loaded",get:function(){return this._currentLoad&&this._currentLoad.succeeded}}])}(),kp=function(){return Ke(function s(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;qe(this,s),this._attemptsRemaining=3,this._currentAttempt=null,this._dailyConfig=e,this._successCallback=t,this._failureCallback=i},[{key:"start",value:function(){var s=this;if(!this._currentAttempt){var e=function(t){s._currentAttempt.cancelled||(s._attemptsRemaining--,s._failureCallback(t,s._attemptsRemaining>0),s._attemptsRemaining<=0||setTimeout(function(){s._currentAttempt.cancelled||(s._currentAttempt=new Fc(s._dailyConfig,s._successCallback,e),s._currentAttempt.start())},3e3))};this._currentAttempt=new Fc(this._dailyConfig,this._successCallback,e),this._currentAttempt.start()}}},{key:"cancel",value:function(){this._currentAttempt&&this._currentAttempt.cancel()}},{key:"cancelled",get:function(){return this._currentAttempt&&this._currentAttempt.cancelled}},{key:"succeeded",get:function(){return this._currentAttempt&&this._currentAttempt.succeeded}}])}(),Cr=function(){function s(){return qe(this,s),e=this,i=arguments,t=at(t=s),us(e,Oc()?Reflect.construct(t,i||[],at(e).constructor):t.apply(e,i));var e,t,i}return ds(s,kr(Error)),Ke(s)}(),$s=2e4,Fc=function(){return Ke(function e(t,i,n){qe(this,e),this._loadAttemptImpl=he()||!t.avoidEval?new Cp(t,i,n):new Rp(t,i,n)},[{key:"start",value:(s=Z(function*(){return this._loadAttemptImpl.start()}),function(){return s.apply(this,arguments)})},{key:"cancel",value:function(){this._loadAttemptImpl.cancel()}},{key:"cancelled",get:function(){return this._loadAttemptImpl.cancelled}},{key:"succeeded",get:function(){return this._loadAttemptImpl.succeeded}}]);var s}(),Cp=function(){return Ke(function n(r,a,o){qe(this,n),this.cancelled=!1,this.succeeded=!1,this._networkTimedOut=!1,this._networkTimeout=null,this._iosCache=typeof iOSCallObjectBundleCache<"u"&&iOSCallObjectBundleCache,this._refetchHeaders=null,this._dailyConfig=r,this._successCallback=a,this._failureCallback=o},[{key:"start",value:(i=Z(function*(){var n=gs(this._dailyConfig);!(yield this._tryLoadFromIOSCache(n))&&this._loadFromNetwork(n)}),function(){return i.apply(this,arguments)})},{key:"cancel",value:function(){clearTimeout(this._networkTimeout),this.cancelled=!0}},{key:"_tryLoadFromIOSCache",value:(t=Z(function*(n){if(!this._iosCache)return!1;try{var r=yield this._iosCache.get(n);return!!this.cancelled||!!r&&(r.code?(Function('"use strict";'+r.code)(),this.succeeded=!0,this._successCallback(),!0):(this._refetchHeaders=r.refetchHeaders,!1))}catch{return!1}}),function(n){return t.apply(this,arguments)})},{key:"_loadFromNetwork",value:(e=Z(function*(n){var r=this;this._networkTimeout=setTimeout(function(){r._networkTimedOut=!0,r._failureCallback({msg:"Timed out (>".concat($s," ms) when loading call object bundle ").concat(n),type:"timeout"})},$s);try{var a=this._refetchHeaders?{headers:this._refetchHeaders}:{},o=yield fetch(n,a);if(clearTimeout(this._networkTimeout),this.cancelled||this._networkTimedOut)throw new Cr;var l=yield this._getBundleCodeFromResponse(n,o);if(this.cancelled)throw new Cr;Function('"use strict";'+l)(),this._iosCache&&this._iosCache.set(n,l,o.headers),this.succeeded=!0,this._successCallback()}catch(c){if(clearTimeout(this._networkTimeout),c instanceof Cr||this.cancelled||this._networkTimedOut)return;this._failureCallback({msg:"Failed to load call object bundle ".concat(n,": ").concat(c),type:c.message})}}),function(n){return e.apply(this,arguments)})},{key:"_getBundleCodeFromResponse",value:(s=Z(function*(n,r){if(r.ok)return yield r.text();if(this._iosCache&&r.status===304)return(yield this._iosCache.renew(n,r.headers)).code;throw new Error("Received ".concat(r.status," response"))}),function(n,r){return s.apply(this,arguments)})}]);var s,e,t,i}(),Rp=function(){return Ke(function s(e,t,i){qe(this,s),this.cancelled=!1,this.succeeded=!1,this._dailyConfig=e,this._successCallback=t,this._failureCallback=i,this._attemptId=ps(),this._networkTimeout=null,this._scriptElement=null},[{key:"start",value:function(){window._dailyCallMachineLoadWaitlist||(window._dailyCallMachineLoadWaitlist=new Set);var s=gs(this._dailyConfig);(typeof document>"u"?"undefined":fe(document))==="object"?this._startLoading(s):this._failureCallback({msg:"Call object bundle must be loaded in a DOM/web context",type:"missing context"})}},{key:"cancel",value:function(){this._stopLoading(),this.cancelled=!0}},{key:"_startLoading",value:function(s){var e=this;this._signUpForCallMachineLoadWaitlist(),this._networkTimeout=setTimeout(function(){e._stopLoading(),e._failureCallback({msg:"Timed out (>".concat($s," ms) when loading call object bundle ").concat(s),type:"timeout"})},$s);var t=document.getElementsByTagName("head")[0],i=document.createElement("script");this._scriptElement=i,i.onload=function(){e._stopLoading(),e.succeeded=!0,e._successCallback()},i.onerror=function(n){e._stopLoading(),e._failureCallback({msg:"Failed to load call object bundle ".concat(n.target.src),type:n.message})},i.src=s,t.appendChild(i)}},{key:"_stopLoading",value:function(){this._withdrawFromCallMachineLoadWaitlist(),clearTimeout(this._networkTimeout),this._scriptElement&&(this._scriptElement.onload=null,this._scriptElement.onerror=null)}},{key:"_signUpForCallMachineLoadWaitlist",value:function(){window._dailyCallMachineLoadWaitlist.add(this._attemptId)}},{key:"_withdrawFromCallMachineLoadWaitlist",value:function(){window._dailyCallMachineLoadWaitlist.delete(this._attemptId)}}])}(),js=function(s,e,t){return Dp(s.local,e,t)===!0},Pp=function(s,e,t){return s.local.streams&&s.local.streams[e]&&s.local.streams[e].stream&&s.local.streams[e].stream["get".concat(t==="video"?"Video":"Audio","Tracks")]()[0]},xi=function(s,e,t,i){var n=Op(s,e,t,i);return n&&n.pendingTrack},Dp=function(s,e,t){if(!s)return!1;var i=function(r){switch(r){case"avatar":return!0;case"staged":return r;default:return!!r}},n=s.public.subscribedTracks;return n&&n[e]?["cam-audio","cam-video","screen-video","screen-audio","rmpAudio","rmpVideo"].indexOf(t)===-1&&n[e].custom?[!0,"staged"].includes(n[e].custom)?i(n[e].custom):i(n[e].custom[t]):i(n[e][t]):!n||i(n.ALL)},Op=function(s,e,t,i){var n=Object.values(s.streams||{}).filter(function(r){return r.participantId===e&&r.type===t&&r.pendingTrack&&r.pendingTrack.kind===i}).sort(function(r,a){return new Date(a.starttime)-new Date(r.starttime)});return n&&n[0]},Mp=function(s,e){var t=s.local.public.customTracks;if(t&&t[e])return t[e].track};function Nc(s,e){for(var t=e.getState(),i=0,n=["cam","screen"];i<n.length;i++)for(var r=n[i],a=0,o=["video","audio"];a<o.length;a++){var l=o[a],c=r==="cam"?l:"screen".concat(l.charAt(0).toUpperCase()+l.slice(1)),u=s.tracks[c];if(u){var d=s.local?Pp(t,r,l):xi(t,s.session_id,r,l);u.state==="playable"&&(u.track=d),u.persistentTrack=d}}}function Uc(s,e){try{var t=e.getState();for(var i in s.tracks)if(!Fp(i)){var n=s.tracks[i].kind;if(n){var r=s.tracks[i];if(r){var a=s.local?Mp(t,i):xi(t,s.session_id,i,n);r.state==="playable"&&(s.tracks[i].track=a),r.persistentTrack=a}}else console.error("unknown type for custom track")}}catch(o){console.error(o)}}function Fp(s){return["video","audio","screenVideo","screenAudio"].includes(s)}function Bc(s,e,t){var i=t.getState();if(s.local){if(s.audio)try{s.audioTrack=i.local.streams.cam.stream.getAudioTracks()[0],s.audioTrack||(s.audio=!1)}catch{}if(s.video)try{s.videoTrack=i.local.streams.cam.stream.getVideoTracks()[0],s.videoTrack||(s.video=!1)}catch{}if(s.screen)try{s.screenVideoTrack=i.local.streams.screen.stream.getVideoTracks()[0],s.screenAudioTrack=i.local.streams.screen.stream.getAudioTracks()[0],s.screenVideoTrack||s.screenAudioTrack||(s.screen=!1)}catch{}}else{var n=!0;try{var r=i.participants[s.session_id];r&&r.public&&r.public.rtcType&&r.public.rtcType.impl==="peer-to-peer"&&r.private&&!["connected","completed"].includes(r.private.peeringState)&&(n=!1)}catch(u){console.error(u)}if(!n)return s.audio=!1,s.audioTrack=!1,s.video=!1,s.videoTrack=!1,s.screen=!1,void(s.screenTrack=!1);try{if(i.streams,s.audio&&js(i,s.session_id,"cam-audio")){var a=xi(i,s.session_id,"cam","audio");a&&(e&&e.audioTrack&&e.audioTrack.id===a.id?s.audioTrack=a:a.muted||(s.audioTrack=a)),s.audioTrack||(s.audio=!1)}if(s.video&&js(i,s.session_id,"cam-video")){var o=xi(i,s.session_id,"cam","video");o&&(e&&e.videoTrack&&e.videoTrack.id===o.id?s.videoTrack=o:o.muted||(s.videoTrack=o)),s.videoTrack||(s.video=!1)}if(s.screen&&js(i,s.session_id,"screen-audio")){var l=xi(i,s.session_id,"screen","audio");l&&(e&&e.screenAudioTrack&&e.screenAudioTrack.id===l.id?s.screenAudioTrack=l:l.muted||(s.screenAudioTrack=l))}if(s.screen&&js(i,s.session_id,"screen-video")){var c=xi(i,s.session_id,"screen","video");c&&(e&&e.screenVideoTrack&&e.screenVideoTrack.id===c.id?s.screenVideoTrack=c:c.muted||(s.screenVideoTrack=c))}s.screenVideoTrack||s.screenAudioTrack||(s.screen=!1)}catch(u){console.error("unexpected error matching up tracks",u)}}}function Np(s,e){var t=typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=function(l,c){if(l){if(typeof l=="string")return $c(l,c);var u={}.toString.call(l).slice(8,-1);return u==="Object"&&l.constructor&&(u=l.constructor.name),u==="Map"||u==="Set"?Array.from(l):u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u)?$c(l,c):void 0}}(s))||e){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r,a=!0,o=!1;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return a=l.done,l},e:function(l){o=!0,r=l},f:function(){try{a||t.return==null||t.return()}finally{if(o)throw r}}}}function $c(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=Array(e);t<e;t++)i[t]=s[t];return i}var pt=new Map,Ai=null;function Up(s,e){var t=typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=function(l,c){if(l){if(typeof l=="string")return jc(l,c);var u={}.toString.call(l).slice(8,-1);return u==="Object"&&l.constructor&&(u=l.constructor.name),u==="Map"||u==="Set"?Array.from(l):u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u)?jc(l,c):void 0}}(s))||e){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r,a=!0,o=!1;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return a=l.done,l},e:function(l){o=!0,r=l},f:function(){try{a||t.return==null||t.return()}finally{if(o)throw r}}}}function jc(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=Array(e);t<e;t++)i[t]=s[t];return i}var gt=new Map,Yi=null;function Bp(s){Gc()?function(e){pt.has(e)||(pt.set(e,{}),navigator.mediaDevices.enumerateDevices().then(function(t){pt.has(e)&&(pt.get(e).lastDevicesString=JSON.stringify(t),Ai||(Ai=function(){var i=Z(function*(){var n,r=yield navigator.mediaDevices.enumerateDevices(),a=Np(pt.keys());try{for(a.s();!(n=a.n()).done;){var o=n.value,l=JSON.stringify(r);l!==pt.get(o).lastDevicesString&&(pt.get(o).lastDevicesString=l,o(r))}}catch(c){a.e(c)}finally{a.f()}});return function(){return i.apply(this,arguments)}}(),navigator.mediaDevices.addEventListener("devicechange",Ai)))}).catch(function(){}))}(s):function(e){gt.has(e)||(gt.set(e,{}),navigator.mediaDevices.enumerateDevices().then(function(t){gt.has(e)&&(gt.get(e).lastDevicesString=JSON.stringify(t),Yi||(Yi=setInterval(Z(function*(){var i,n=yield navigator.mediaDevices.enumerateDevices(),r=Up(gt.keys());try{for(r.s();!(i=r.n()).done;){var a=i.value,o=JSON.stringify(n);o!==gt.get(a).lastDevicesString&&(gt.get(a).lastDevicesString=o,a(n))}}catch(l){r.e(l)}finally{r.f()}}),3e3)))}))}(s)}function $p(s){Gc()?function(e){pt.has(e)&&(pt.delete(e),pt.size===0&&Ai&&(navigator.mediaDevices.removeEventListener("devicechange",Ai),Ai=null))}(s):function(e){gt.has(e)&&(gt.delete(e),gt.size===0&&Yi&&(clearInterval(Yi),Yi=null))}(s)}function Gc(){var s;return he()||((s=navigator.mediaDevices)===null||s===void 0?void 0:s.ondevicechange)!==void 0}var jp=new Set;function Gp(s,e){return s&&s.readyState==="live"&&!function(t,i){return t.muted&&!jp.has(t.id)}(s)}function Vc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function $t(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Vc(Object(t),!0).forEach(function(i){ft(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Vc(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}var Wi=Object.freeze({VIDEO:"video",AUDIO:"audio",SCREEN_VIDEO:"screenVideo",SCREEN_AUDIO:"screenAudio",CUSTOM_VIDEO:"customVideo",CUSTOM_AUDIO:"customAudio"}),Vp=Object.freeze({PARTICIPANTS:"participants",STREAMING:"streaming",TRANSCRIPTION:"transcription"}),zi=Object.values(Wi),qc=["v","a","sv","sa","cv","ca"];Object.freeze(zi.reduce(function(s,e,t){return s[e]=qc[t],s},{})),Object.freeze(qc.reduce(function(s,e,t){return s[e]=zi[t],s},{}));var qp=[Wi.VIDEO,Wi.AUDIO,Wi.SCREEN_VIDEO,Wi.SCREEN_AUDIO],Kc=Object.values(Vp),Hc=["p","s","t"];Object.freeze(Kc.reduce(function(s,e,t){return s[e]=Hc[t],s},{})),Object.freeze(Hc.reduce(function(s,e,t){return s[e]=Kc[t],s},{}));var Kp=function(){function s(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e.base,i=e.byUserId,n=e.byParticipantId;qe(this,s),this.base=t,this.byUserId=i,this.byParticipantId=n}return Ke(s,[{key:"clone",value:function(){var e=new s;if(this.base instanceof Re?e.base=this.base.clone():e.base=this.base,this.byUserId!==void 0)for(var t in e.byUserId={},this.byUserId){var i=this.byUserId[t];e.byUserId[t]=i instanceof Re?i.clone():i}if(this.byParticipantId!==void 0)for(var n in e.byParticipantId={},this.byParticipantId){var r=this.byParticipantId[n];e.byParticipantId[n]=r instanceof Re?r.clone():r}return e}},{key:"toJSONObject",value:function(){var e={};if(typeof this.base=="boolean"?e.base=this.base:this.base instanceof Re&&(e.base=this.base.toJSONObject()),this.byUserId!==void 0)for(var t in e.byUserId={},this.byUserId){var i=this.byUserId[t];e.byUserId[t]=i instanceof Re?i.toJSONObject():i}if(this.byParticipantId!==void 0)for(var n in e.byParticipantId={},this.byParticipantId){var r=this.byParticipantId[n];e.byParticipantId[n]=r instanceof Re?r.toJSONObject():r}return e}},{key:"toMinifiedJSONObject",value:function(){var e={};if(this.base!==void 0&&(typeof this.base=="boolean"?e.b=this.base:e.b=this.base.toMinifiedJSONObject()),this.byUserId!==void 0)for(var t in e.u={},this.byUserId){var i=this.byUserId[t];e.u[t]=typeof i=="boolean"?i:i.toMinifiedJSONObject()}if(this.byParticipantId!==void 0)for(var n in e.p={},this.byParticipantId){var r=this.byParticipantId[n];e.p[n]=typeof r=="boolean"?r:r.toMinifiedJSONObject()}return e}},{key:"normalize",value:function(){return this.base instanceof Re&&(this.base=this.base.normalize()),this.byUserId&&(this.byUserId=Object.fromEntries(Object.entries(this.byUserId).map(function(e){var t=Me(e,2),i=t[0],n=t[1];return[i,n instanceof Re?n.normalize():n]}))),this.byParticipantId&&(this.byParticipantId=Object.fromEntries(Object.entries(this.byParticipantId).map(function(e){var t=Me(e,2),i=t[0],n=t[1];return[i,n instanceof Re?n.normalize():n]}))),this}}],[{key:"fromJSONObject",value:function(e){var t,i,n;if(e.base!==void 0&&(t=typeof e.base=="boolean"?e.base:Re.fromJSONObject(e.base)),e.byUserId!==void 0)for(var r in i={},e.byUserId){var a=e.byUserId[r];i[r]=typeof a=="boolean"?a:Re.fromJSONObject(a)}if(e.byParticipantId!==void 0)for(var o in n={},e.byParticipantId){var l=e.byParticipantId[o];n[o]=typeof l=="boolean"?l:Re.fromJSONObject(l)}return new s({base:t,byUserId:i,byParticipantId:n})}},{key:"fromMinifiedJSONObject",value:function(e){var t,i,n;if(e.b!==void 0&&(t=typeof e.b=="boolean"?e.b:Re.fromMinifiedJSONObject(e.b)),e.u!==void 0)for(var r in i={},e.u){var a=e.u[r];i[r]=typeof a=="boolean"?a:Re.fromMinifiedJSONObject(a)}if(e.p!==void 0)for(var o in n={},e.p){var l=e.p[o];n[o]=typeof l=="boolean"?l:Re.fromMinifiedJSONObject(l)}return new s({base:t,byUserId:i,byParticipantId:n})}},{key:"validateJSONObject",value:function(e){if(fe(e)!=="object")return[!1,"canReceive must be an object"];for(var t=["base","byUserId","byParticipantId"],i=0,n=Object.keys(e);i<n.length;i++){var r=n[i];if(!t.includes(r))return[!1,"canReceive can only contain keys (".concat(t.join(", "),")")];if(r==="base"){var a=Me(Re.validateJSONObject(e.base,!0),2),o=a[0],l=a[1];if(!o)return[!1,l]}else{if(fe(e[r])!=="object")return[!1,"invalid (non-object) value for field '".concat(r,"' in canReceive")];for(var c=0,u=Object.values(e[r]);c<u.length;c++){var d=u[c],f=Me(Re.validateJSONObject(d),2),g=f[0],p=f[1];if(!g)return[!1,p]}}}return[!0]}}])}(),Re=function(){function s(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e.video,i=e.audio,n=e.screenVideo,r=e.screenAudio,a=e.customVideo,o=e.customAudio;qe(this,s),this.video=t,this.audio=i,this.screenVideo=n,this.screenAudio=r,this.customVideo=a,this.customAudio=o}return Ke(s,[{key:"clone",value:function(){var e=new s;return this.video!==void 0&&(e.video=this.video),this.audio!==void 0&&(e.audio=this.audio),this.screenVideo!==void 0&&(e.screenVideo=this.screenVideo),this.screenAudio!==void 0&&(e.screenAudio=this.screenAudio),this.customVideo!==void 0&&(e.customVideo=$t({},this.customVideo)),this.customAudio!==void 0&&(e.customAudio=$t({},this.customAudio)),e}},{key:"toJSONObject",value:function(){var e={};return this.video!==void 0&&(e.video=this.video),this.audio!==void 0&&(e.audio=this.audio),this.screenVideo!==void 0&&(e.screenVideo=this.screenVideo),this.screenAudio!==void 0&&(e.screenAudio=this.screenAudio),this.customVideo!==void 0&&(e.customVideo=$t({},this.customVideo)),this.customAudio!==void 0&&(e.customAudio=$t({},this.customAudio)),e}},{key:"toMinifiedJSONObject",value:function(){var e={};return this.video!==void 0&&(e.v=this.video),this.audio!==void 0&&(e.a=this.audio),this.screenVideo!==void 0&&(e.sv=this.screenVideo),this.screenAudio!==void 0&&(e.sa=this.screenAudio),this.customVideo!==void 0&&(e.cv=$t({},this.customVideo)),this.customAudio!==void 0&&(e.ca=$t({},this.customAudio)),e}},{key:"normalize",value:function(){function e(t,i){return t&&Object.keys(t).length===1&&t["*"]===i}return!(this.video!==!0||this.audio!==!0||this.screenVideo!==!0||this.screenAudio!==!0||!e(this.customVideo,!0)||!e(this.customAudio,!0))||(this.video!==!1||this.audio!==!1||this.screenVideo!==!1||this.screenAudio!==!1||!e(this.customVideo,!1)||!e(this.customAudio,!1))&&this}}],[{key:"fromBoolean",value:function(e){return new s({video:e,audio:e,screenVideo:e,screenAudio:e,customVideo:{"*":e},customAudio:{"*":e}})}},{key:"fromJSONObject",value:function(e){return new s({video:e.video,audio:e.audio,screenVideo:e.screenVideo,screenAudio:e.screenAudio,customVideo:e.customVideo!==void 0?$t({},e.customVideo):void 0,customAudio:e.customAudio!==void 0?$t({},e.customAudio):void 0})}},{key:"fromMinifiedJSONObject",value:function(e){return new s({video:e.v,audio:e.a,screenVideo:e.sv,screenAudio:e.sa,customVideo:e.cv,customAudio:e.ca})}},{key:"validateJSONObject",value:function(e,t){if(typeof e=="boolean")return[!0];if(fe(e)!=="object")return[!1,"invalid (non-object, non-boolean) value in canReceive"];for(var i=Object.keys(e),n=0,r=i;n<r.length;n++){var a=r[n];if(!zi.includes(a))return[!1,"invalid media type '".concat(a,"' in canReceive")];if(qp.includes(a)){if(typeof e[a]!="boolean")return[!1,"invalid (non-boolean) value for media type '".concat(a,"' in canReceive")]}else{if(fe(e[a])!=="object")return[!1,"invalid (non-object) value for media type '".concat(a,"' in canReceive")];for(var o=0,l=Object.values(e[a]);o<l.length;o++)if(typeof l[o]!="boolean")return[!1,"invalid (non-boolean) value for entry within '".concat(a,"' in canReceive")];if(t&&e[a]["*"]===void 0)return[!1,`canReceive "base" permission must specify "*" as an entry within '`.concat(a,"'")]}}return t&&i.length!==zi.length?[!1,'canReceive "base" permission must specify all media types: '.concat(zi.join(", ")," (or be set to a boolean shorthand)")]:[!0]}}])}(),Hp=["result"],Yp=["preserveIframe"];function Yc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function Y(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Yc(Object(t),!0).forEach(function(i){ft(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Yc(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}function Wc(){try{var s=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Wc=function(){return!!s})()}function zc(s,e){var t=typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=function(l,c){if(l){if(typeof l=="string")return Jc(l,c);var u={}.toString.call(l).slice(8,-1);return u==="Object"&&l.constructor&&(u=l.constructor.name),u==="Map"||u==="Set"?Array.from(l):u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u)?Jc(l,c):void 0}}(s))||e){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r,a=!0,o=!1;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return a=l.done,l},e:function(l){o=!0,r=l},f:function(){try{a||t.return==null||t.return()}finally{if(o)throw r}}}}function Jc(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=Array(e);t<e;t++)i[t]=s[t];return i}var oi={},Qc="video",Wp="voice",Xc=he()?{data:{}}:{data:{},topology:"none"},Zc={present:0,hidden:0},eu={maxBitrate:{min:1e5,max:25e5},maxFramerate:{min:1,max:30},scaleResolutionDownBy:{min:1,max:8}},Rr=Object.keys(eu),tu=["state","volume","simulcastEncodings"],iu={androidInCallNotification:{title:"string",subtitle:"string",iconName:"string",disableForCustomOverride:"boolean"},disableAutoDeviceManagement:{audio:"boolean",video:"boolean"}},Gs={id:{iconPath:"string",iconPathDarkMode:"string",label:"string",tooltip:"string",visualState:"'default' | 'sidebar-open' | 'active'"}},Pr={id:{allow:"string",controlledBy:"'*' | 'owners' | string[]",csp:"string",iconURL:"string",label:"string",loading:"'eager' | 'lazy'",location:"'main' | 'sidebar'",name:"string",referrerPolicy:"string",sandbox:"string",src:"string",srcdoc:"string",shared:"string[] | 'owners' | boolean"}},li={customIntegrations:{validate:du,help:cu()},customTrayButtons:{validate:uu,help:"customTrayButtons should be a dictionary of the type ".concat(JSON.stringify(Gs))},url:{validate:function(s){return typeof s=="string"},help:"url should be a string"},baseUrl:{validate:function(s){return typeof s=="string"},help:"baseUrl should be a string"},token:{validate:function(s){return typeof s=="string"},help:"token should be a string",queryString:"t"},dailyConfig:{validate:function(s,e){try{return e.validateDailyConfig(s),!0}catch(t){console.error("Failed to validate dailyConfig",t)}return!1},help:"Unsupported dailyConfig. Check error logs for detailed info."},reactNativeConfig:{validate:function(s){return hu(s,iu)},help:"reactNativeConfig should look like ".concat(JSON.stringify(iu),", all fields optional")},lang:{validate:function(s){return["da","de","en-us","en","es","fi","fr","it","jp","ka","nl","no","pl","pt","pt-BR","ru","sv","tr","user"].includes(s)},help:"language not supported. Options are: da, de, en-us, en, es, fi, fr, it, jp, ka, nl, no, pl, pt, pt-BR, ru, sv, tr, user"},userName:!0,userData:{validate:function(s){try{return su(s),!0}catch(e){return console.error(e),!1}},help:"invalid userData type provided"},startVideoOff:!0,startAudioOff:!0,allowLocalVideo:!0,allowLocalAudio:!0,activeSpeakerMode:!0,showLeaveButton:!0,showLocalVideo:!0,showParticipantsBar:!0,showFullscreenButton:!0,showUserNameChangeUI:!0,iframeStyle:!0,customLayout:!0,cssFile:!0,cssText:!0,bodyClass:!0,videoSource:{validate:function(s,e){if(typeof s=="boolean")return e._preloadCache.allowLocalVideo=s,!0;var t;if(s instanceof MediaStreamTrack)e._sharedTracks.videoTrack=s,t={customTrack:Lt};else{if(delete e._sharedTracks.videoTrack,typeof s!="string")return console.error("videoSource must be a MediaStreamTrack, boolean, or a string"),!1;t={deviceId:s}}return e._updatePreloadCacheInputSettings({video:{settings:t}},!1),!0}},audioSource:{validate:function(s,e){if(typeof s=="boolean")return e._preloadCache.allowLocalAudio=s,!0;var t;if(s instanceof MediaStreamTrack)e._sharedTracks.audioTrack=s,t={customTrack:Lt};else{if(delete e._sharedTracks.audioTrack,typeof s!="string")return console.error("audioSource must be a MediaStreamTrack, boolean, or a string"),!1;t={deviceId:s}}return e._updatePreloadCacheInputSettings({audio:{settings:t}},!1),!0}},subscribeToTracksAutomatically:{validate:function(s,e){return e._preloadCache.subscribeToTracksAutomatically=s,!0}},theme:{validate:function(s){var e=["accent","accentText","background","backgroundAccent","baseText","border","mainAreaBg","mainAreaBgAccent","mainAreaText","supportiveText"],t=function(i){for(var n=0,r=Object.keys(i);n<r.length;n++){var a=r[n];if(!e.includes(a))return console.error('unsupported color "'.concat(a,'". Valid colors: ').concat(e.join(", "))),!1;if(!i[a].match(/^#[0-9a-f]{6}|#[0-9a-f]{3}$/i))return console.error("".concat(a,' theme color should be provided in valid hex color format. Received: "').concat(i[a],'"')),!1}return!0};return fe(s)==="object"&&("light"in s&&"dark"in s||"colors"in s)?"light"in s&&"dark"in s?"colors"in s.light?"colors"in s.dark?t(s.light.colors)&&t(s.dark.colors):(console.error('Dark theme is missing "colors" property.',s),!1):(console.error('Light theme is missing "colors" property.',s),!1):t(s.colors):(console.error('Theme must contain either both "light" and "dark" properties, or "colors".',s),!1)},help:"unsupported theme configuration. Check error logs for detailed info."},layoutConfig:{validate:function(s){if("grid"in s){var e=s.grid;if("maxTilesPerPage"in e){if(!Number.isInteger(e.maxTilesPerPage))return console.error("grid.maxTilesPerPage should be an integer. You passed ".concat(e.maxTilesPerPage,".")),!1;if(e.maxTilesPerPage>49)return console.error("grid.maxTilesPerPage can't be larger than 49 without sacrificing browser performance. Please contact us at https://www.daily.co/contact to talk about your use case."),!1}if("minTilesPerPage"in e){if(!Number.isInteger(e.minTilesPerPage))return console.error("grid.minTilesPerPage should be an integer. You passed ".concat(e.minTilesPerPage,".")),!1;if(e.minTilesPerPage<1)return console.error("grid.minTilesPerPage can't be lower than 1."),!1;if("maxTilesPerPage"in e&&e.minTilesPerPage>e.maxTilesPerPage)return console.error("grid.minTilesPerPage can't be higher than grid.maxTilesPerPage."),!1}}return!0},help:"unsupported layoutConfig. Check error logs for detailed info."},receiveSettings:{validate:function(s){return nu(s,{allowAllParticipantsKey:!1})},help:lu({allowAllParticipantsKey:!1})},sendSettings:{validate:function(s,e){return!!function(t,i){try{return i.validateUpdateSendSettings(t),!0}catch(n){return console.error("Failed to validate send settings",n),!1}}(s,e)&&(e._preloadCache.sendSettings=s,!0)},help:"Invalid sendSettings provided. Check error logs for detailed info."},inputSettings:{validate:function(s,e){var t;return!!ru(s)&&(e._inputSettings||(e._inputSettings={}),au(s,(t=e.properties)===null||t===void 0?void 0:t.dailyConfig,e._sharedTracks),e._updatePreloadCacheInputSettings(s,!0),!0)},help:Mr()},layout:{validate:function(s){return s==="custom-v1"||s==="browser"||s==="none"},help:'layout may only be set to "custom-v1"',queryString:"layout"},emb:{queryString:"emb"},embHref:{queryString:"embHref"},dailyJsVersion:{queryString:"dailyJsVersion"},proxy:{queryString:"proxy"},strictMode:!0,allowMultipleCallInstances:!0},Vs={styles:{validate:function(s){for(var e in s)if(e!=="cam"&&e!=="screen")return!1;if(s.cam){for(var t in s.cam)if(t!=="div"&&t!=="video")return!1}if(s.screen){for(var i in s.screen)if(i!=="div"&&i!=="video")return!1}return!0},help:"styles format should be a subset of: { cam: {div: {}, video: {}}, screen: {div: {}, video: {}} }"},setSubscribedTracks:{validate:function(s,e){if(e._preloadCache.subscribeToTracksAutomatically)return!1;var t=[!0,!1,"staged"];if(t.includes(s)||!he()&&s==="avatar")return!0;var i=["audio","video","screenAudio","screenVideo","rmpAudio","rmpVideo"],n=function(r){var a=arguments.length>1&&arguments[1]!==void 0&&arguments[1];for(var o in r)if(o==="custom"){if(!t.includes(r[o])&&!n(r[o],!0))return!1}else{var l=!a&&!i.includes(o),c=!t.includes(r[o]);if(l||c)return!1}return!0};return n(s)},help:"setSubscribedTracks cannot be used when setSubscribeToTracksAutomatically is enabled, and should be of the form: "+"true".concat(he()?"":" | 'avatar'"," | false | 'staged' | { [audio: true|false|'staged'], [video: true|false|'staged'], [screenAudio: true|false|'staged'], [screenVideo: true|false|'staged'] }")},setAudio:!0,setVideo:!0,setScreenShare:{validate:function(s){return s===!1},help:"setScreenShare must be false, as it's only meant for stopping remote participants' screen shares"},eject:!0,updatePermissions:{validate:function(s){for(var e=0,t=Object.entries(s);e<t.length;e++){var i=Me(t[e],2),n=i[0],r=i[1];switch(n){case"hasPresence":if(typeof r!="boolean")return!1;break;case"canSend":if(r instanceof Set||r instanceof Array||Array.isArray(r)){var a,o=["video","audio","screenVideo","screenAudio","customVideo","customAudio"],l=zc(r);try{for(l.s();!(a=l.n()).done;){var c=a.value;if(!o.includes(c))return!1}}catch(b){l.e(b)}finally{l.f()}}else if(typeof r!="boolean")return!1;(r instanceof Array||Array.isArray(r))&&(s.canSend=new Set(r));break;case"canReceive":var u=Me(Kp.validateJSONObject(r),2),d=u[0],f=u[1];if(!d)return console.error(f),!1;break;case"canAdmin":if(r instanceof Set||r instanceof Array||Array.isArray(r)){var g,p=["participants","streaming","transcription"],v=zc(r);try{for(v.s();!(g=v.n()).done;){var S=g.value;if(!p.includes(S))return!1}}catch(b){v.e(b)}finally{v.f()}}else if(typeof r!="boolean")return!1;(r instanceof Array||Array.isArray(r))&&(s.canAdmin=new Set(r));break;default:return!1}}return!0},help:"updatePermissions can take hasPresence, canSend, canReceive, and canAdmin permissions. hasPresence must be a boolean. canSend can be a boolean or an Array or Set of media types (video, audio, screenVideo, screenAudio, customVideo, customAudio). canReceive must be an object specifying base, byUserId, and/or byParticipantId fields (see documentation for more details). canAdmin can be a boolean or an Array or Set of admin types (participants, streaming, transcription)."}};Promise.any||(Promise.any=function(){var s=Z(function*(e){return new Promise(function(t,i){var n=[];e.forEach(function(r){return Promise.resolve(r).then(function(a){t(a)}).catch(function(a){n.push(a),n.length===e.length&&i(n)})})})});return function(e){return s.apply(this,arguments)}}());var zp=function(){function s(h){var y,m,x,L,O,U,$=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(qe(this,s),x=this,L=at(L=s),ft(m=us(x,Wc()?Reflect.construct(L,[],at(x).constructor):L.apply(x,O)),"startListeningForDeviceChanges",function(){Bp(m.handleDeviceChange)}),ft(m,"stopListeningForDeviceChanges",function(){$p(m.handleDeviceChange)}),ft(m,"handleDeviceChange",function(re){re=re.map(function(le){return JSON.parse(JSON.stringify(le))}),m.emitDailyJSEvent({action:"available-devices-updated",availableDevices:re})}),ft(m,"handleNativeAppStateChange",function(){var re=Z(function*(le){if(le==="destroyed")return console.warn("App has been destroyed before leaving the meeting. Cleaning up all the resources!"),void(yield m.destroy());var Ve=le==="active";m.disableReactNativeAutoDeviceManagement("video")||(Ve?m.camUnmutedBeforeLosingNativeActiveState&&m.setLocalVideo(!0):(m.camUnmutedBeforeLosingNativeActiveState=m.localVideo(),m.camUnmutedBeforeLosingNativeActiveState&&m.setLocalVideo(!1)))});return function(le){return re.apply(this,arguments)}}()),ft(m,"handleNativeAudioFocusChange",function(re){m.disableReactNativeAutoDeviceManagement("audio")||(m._hasNativeAudioFocus=re,m.toggleParticipantAudioBasedOnNativeAudioFocus(),m._hasNativeAudioFocus?m.micUnmutedBeforeLosingNativeAudioFocus&&m.setLocalAudio(!0):(m.micUnmutedBeforeLosingNativeAudioFocus=m.localAudio(),m.setLocalAudio(!1)))}),ft(m,"handleNativeSystemScreenCaptureStop",function(){m.stopScreenShare()}),m.strictMode=$.strictMode===void 0||$.strictMode,m.allowMultipleCallInstances=(y=$.allowMultipleCallInstances)!==null&&y!==void 0&&y,Object.keys(oi).length&&(m._logDuplicateInstanceAttempt(),!m.allowMultipleCallInstances)){if(m.strictMode)throw new Error("Duplicate DailyIframe instances are not allowed");console.warn("Using strictMode: false to allow multiple call instances is now deprecated. Set `allowMultipleCallInstances: true`")}if(window._daily||(window._daily={pendings:[],instances:{}}),m.callClientId=ps(),oi[(U=m).callClientId]=U,window._daily.instances[m.callClientId]={},m._sharedTracks={},window._daily.instances[m.callClientId].tracks=m._sharedTracks,$.dailyJsVersion=s.version(),m._iframe=h,m._callObjectMode=$.layout==="none"&&!m._iframe,m._preloadCache={subscribeToTracksAutomatically:!0,outputDeviceId:null,inputSettings:null,sendSettings:null,videoTrackForNetworkConnectivityTest:null,videoTrackForConnectionQualityTest:null},$.showLocalVideo!==void 0?m._callObjectMode?console.error("showLocalVideo is not available in call object mode"):m._showLocalVideo=!!$.showLocalVideo:m._showLocalVideo=!0,$.showParticipantsBar!==void 0?m._callObjectMode?console.error("showParticipantsBar is not available in call object mode"):m._showParticipantsBar=!!$.showParticipantsBar:m._showParticipantsBar=!0,$.customIntegrations!==void 0?m._callObjectMode?console.error("customIntegrations is not available in call object mode"):m._customIntegrations=$.customIntegrations:m._customIntegrations={},$.customTrayButtons!==void 0?m._callObjectMode?console.error("customTrayButtons is not available in call object mode"):m._customTrayButtons=$.customTrayButtons:m._customTrayButtons={},$.activeSpeakerMode!==void 0?m._callObjectMode?console.error("activeSpeakerMode is not available in call object mode"):m._activeSpeakerMode=!!$.activeSpeakerMode:m._activeSpeakerMode=!1,$.receiveSettings?m._callObjectMode?m._receiveSettings=$.receiveSettings:console.error("receiveSettings is only available in call object mode"):m._receiveSettings={},m.validateProperties($),m.properties=Y({},$),m._inputSettings||(m._inputSettings={}),m._callObjectLoader=m._callObjectMode?new Lp(m.callClientId):null,m._callState=ur,m._isPreparingToJoin=!1,m._accessState={access:Fs},m._meetingSessionSummary={},m._finalSummaryOfPrevSession={},m._meetingSessionState=Fr(Xc,m._callObjectMode),m._nativeInCallAudioMode=Qc,m._participants={},m._isScreenSharing=!1,m._participantCounts=Zc,m._rmpPlayerState={},m._waitingParticipants={},m._network={threshold:"good",quality:100,networkState:"unknown",stats:{}},m._activeSpeaker={},m._localAudioLevel=0,m._isLocalAudioLevelObserverRunning=!1,m._remoteParticipantsAudioLevel={},m._isRemoteParticipantsAudioLevelObserverRunning=!1,m._maxAppMessageSize=yr,m._messageChannel=he()?new Ip:new Ap,m._iframe&&(m._iframe.requestFullscreen?m._iframe.addEventListener("fullscreenchange",function(){document.fullscreenElement===m._iframe?(m.emitDailyJSEvent({action:Ki}),m.sendMessageToCallMachine({action:Ki})):(m.emitDailyJSEvent({action:Hi}),m.sendMessageToCallMachine({action:Hi}))}):m._iframe.webkitRequestFullscreen&&m._iframe.addEventListener("webkitfullscreenchange",function(){document.webkitFullscreenElement===m._iframe?(m.emitDailyJSEvent({action:Ki}),m.sendMessageToCallMachine({action:Ki})):(m.emitDailyJSEvent({action:Hi}),m.sendMessageToCallMachine({action:Hi}))})),he()){var H=m.nativeUtils();H.addAudioFocusChangeListener&&H.removeAudioFocusChangeListener&&H.addAppStateChangeListener&&H.removeAppStateChangeListener&&H.addSystemScreenCaptureStopListener&&H.removeSystemScreenCaptureStopListener||console.warn("expected (add|remove)(AudioFocusChange|AppActiveStateChange|SystemScreenCaptureStop)Listener to be available in React Native"),m._hasNativeAudioFocus=!0,H.addAudioFocusChangeListener(m.handleNativeAudioFocusChange),H.addAppStateChangeListener(m.handleNativeAppStateChange),H.addSystemScreenCaptureStopListener(m.handleNativeSystemScreenCaptureStop)}return m._callObjectMode&&m.startListeningForDeviceChanges(),m._messageChannel.addListenerForMessagesFromCallMachine(m.handleMessageFromCallMachine,m.callClientId,m),m}return ds(s,fs),Ke(s,[{key:"destroy",value:(X=Z(function*(){var h;try{yield this.leave()}catch{}var y=this._iframe;if(y){var m=y.parentElement;m&&m.removeChild(y)}if(this._messageChannel.removeListener(this.handleMessageFromCallMachine),he()){var x=this.nativeUtils();x.removeAudioFocusChangeListener(this.handleNativeAudioFocusChange),x.removeAppStateChangeListener(this.handleNativeAppStateChange),x.removeSystemScreenCaptureStopListener(this.handleNativeSystemScreenCaptureStop)}this._callObjectMode&&this.stopListeningForDeviceChanges(),this.resetMeetingDependentVars(),this._destroyed=!0,this.emitDailyJSEvent({action:"call-instance-destroyed"}),delete oi[this.callClientId],!((h=window)===null||h===void 0||(h=h._daily)===null||h===void 0)&&h.instances&&delete window._daily.instances[this.callClientId],this.strictMode&&(this.callClientId=void 0)}),function(){return X.apply(this,arguments)})},{key:"isDestroyed",value:function(){return!!this._destroyed}},{key:"loadCss",value:function(h){var y=h.bodyClass,m=h.cssFile,x=h.cssText;return ue(),this.sendMessageToCallMachine({action:"load-css",cssFile:this.absoluteUrl(m),bodyClass:y,cssText:x}),this}},{key:"iframe",value:function(){return ue(),this._iframe}},{key:"meetingState",value:function(){return this._callState}},{key:"accessState",value:function(){return ct(this._callObjectMode,"accessState()"),this._accessState}},{key:"participants",value:function(){return this._participants}},{key:"participantCounts",value:function(){return this._participantCounts}},{key:"waitingParticipants",value:function(){return ct(this._callObjectMode,"waitingParticipants()"),this._waitingParticipants}},{key:"validateParticipantProperties",value:function(h,y){for(var m in y){if(!Vs[m])throw new Error("unrecognized updateParticipant property ".concat(m));if(Vs[m].validate&&!Vs[m].validate(y[m],this,this._participants[h]))throw new Error(Vs[m].help)}}},{key:"updateParticipant",value:function(h,y){return this._participants.local&&this._participants.local.session_id===h&&(h="local"),h&&y&&(this.validateParticipantProperties(h,y),this.sendMessageToCallMachine({action:"update-participant",id:h,properties:y})),this}},{key:"updateParticipants",value:function(h){var y=this._participants.local&&this._participants.local.session_id;for(var m in h)m===y&&(m="local"),m&&h[m]&&this.validateParticipantProperties(m,h[m]);return this.sendMessageToCallMachine({action:"update-participants",participants:h}),this}},{key:"updateWaitingParticipant",value:(ie=Z(function*(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",m=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(ct(this._callObjectMode,"updateWaitingParticipant()"),Ee(this._callState,"updateWaitingParticipant()"),typeof y!="string"||fe(m)!=="object")throw new Error("updateWaitingParticipant() must take an id string and a updates object");return new Promise(function(x,L){h.sendMessageToCallMachine({action:"daily-method-update-waiting-participant",id:y,updates:m},function(O){O.error&&L(O.error),O.id||L(new Error("unknown error in updateWaitingParticipant()")),x({id:O.id})})})}),function(){return ie.apply(this,arguments)})},{key:"updateWaitingParticipants",value:(B=Z(function*(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(ct(this._callObjectMode,"updateWaitingParticipants()"),Ee(this._callState,"updateWaitingParticipants()"),fe(y)!=="object")throw new Error("updateWaitingParticipants() must take a mapping between ids and update objects");return new Promise(function(m,x){h.sendMessageToCallMachine({action:"daily-method-update-waiting-participants",updatesById:y},function(L){L.error&&x(L.error),L.ids||x(new Error("unknown error in updateWaitingParticipants()")),m({ids:L.ids})})})}),function(){return B.apply(this,arguments)})},{key:"requestAccess",value:(G=Z(function*(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},m=y.access,x=m===void 0?{level:pl}:m,L=y.name,O=L===void 0?"":L;return ct(this._callObjectMode,"requestAccess()"),Ee(this._callState,"requestAccess()"),new Promise(function(U,$){h.sendMessageToCallMachine({action:"daily-method-request-access",access:x,name:O},function(H){H.error&&$(H.error),H.access||$(new Error("unknown error in requestAccess()")),U({access:H.access,granted:H.granted})})})}),function(){return G.apply(this,arguments)})},{key:"localAudio",value:function(){return this._participants.local?!["blocked","off"].includes(this._participants.local.tracks.audio.state):null}},{key:"localVideo",value:function(){return this._participants.local?!["blocked","off"].includes(this._participants.local.tracks.video.state):null}},{key:"setLocalAudio",value:function(h){var y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return"forceDiscardTrack"in y&&(he()?(console.warn("forceDiscardTrack option not supported in React Native; ignoring"),y={}):h&&(console.warn("forceDiscardTrack option only supported when calling setLocalAudio(false); ignoring"),y={})),this.sendMessageToCallMachine({action:"local-audio",state:h,options:y}),this}},{key:"localScreenAudio",value:function(){return this._participants.local?!["blocked","off"].includes(this._participants.local.tracks.screenAudio.state):null}},{key:"localScreenVideo",value:function(){return this._participants.local?!["blocked","off"].includes(this._participants.local.tracks.screenVideo.state):null}},{key:"updateScreenShare",value:function(h){if(this._isScreenSharing)return this.sendMessageToCallMachine({action:"local-screen-update",options:h}),this;console.warn("There is no screen share in progress. Try calling startScreenShare first.")}},{key:"setLocalVideo",value:function(h){return this.sendMessageToCallMachine({action:"local-video",state:h}),this}},{key:"_setAllowLocalAudio",value:function(h){if(this._preloadCache.allowLocalAudio=h,this._callMachineInitialized)return this.sendMessageToCallMachine({action:"set-allow-local-audio",state:h}),this}},{key:"_setAllowLocalVideo",value:function(h){if(this._preloadCache.allowLocalVideo=h,this._callMachineInitialized)return this.sendMessageToCallMachine({action:"set-allow-local-video",state:h}),this}},{key:"getReceiveSettings",value:(pe=Z(function*(h){var y=this,m=(arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}).showInheritedValues,x=m!==void 0&&m;if(ct(this._callObjectMode,"getReceiveSettings()"),!this._callMachineInitialized)return this._receiveSettings;switch(fe(h)){case"string":return new Promise(function(L){y.sendMessageToCallMachine({action:"get-single-participant-receive-settings",id:h,showInheritedValues:x},function(O){L(O.receiveSettings)})});case"undefined":return this._receiveSettings;default:throw new Error('first argument to getReceiveSettings() must be a participant id (or "base"), or there should be no arguments')}}),function(h){return pe.apply(this,arguments)})},{key:"updateReceiveSettings",value:(K=Z(function*(h){var y=this;if(ct(this._callObjectMode,"updateReceiveSettings()"),!nu(h,{allowAllParticipantsKey:!0}))throw new Error(lu({allowAllParticipantsKey:!0}));return Ee(this._callState,"updateReceiveSettings()","To specify receive settings earlier, use the receiveSettings config property."),new Promise(function(m){y.sendMessageToCallMachine({action:"update-receive-settings",receiveSettings:h},function(x){m({receiveSettings:x.receiveSettings})})})}),function(h){return K.apply(this,arguments)})},{key:"_prepInputSettingsForSharing",value:function(h,y){if(h){var m={};if(h.audio){var x,L,O;h.audio.settings&&(!Object.keys(h.audio.settings).length&&y||(m.audio={settings:Y({},h.audio.settings)})),y&&(x=m.audio)!==null&&x!==void 0&&(x=x.settings)!==null&&x!==void 0&&x.customTrack&&(m.audio.settings={customTrack:this._sharedTracks.audioTrack});var U=((L=h.audio.processor)===null||L===void 0?void 0:L.type)==="none"&&((O=h.audio.processor)===null||O===void 0?void 0:O._isDefaultWhenNone);if(h.audio.processor&&!U){var $=Y({},h.audio.processor);delete $._isDefaultWhenNone,m.audio=Y(Y({},m.audio),{},{processor:$})}}if(h.video){var H,re,le;h.video.settings&&(!Object.keys(h.video.settings).length&&y||(m.video={settings:Y({},h.video.settings)})),y&&(H=m.video)!==null&&H!==void 0&&(H=H.settings)!==null&&H!==void 0&&H.customTrack&&(m.video.settings={customTrack:this._sharedTracks.videoTrack});var Ve=((re=h.video.processor)===null||re===void 0?void 0:re.type)==="none"&&((le=h.video.processor)===null||le===void 0?void 0:le._isDefaultWhenNone);if(h.video.processor&&!Ve){var Yt=Y({},h.video.processor);delete Yt._isDefaultWhenNone,m.video=Y(Y({},m.video),{},{processor:Yt})}}return m}}},{key:"getInputSettings",value:function(){var h=this;return ue(),new Promise(function(y){y(h._getInputSettings())})}},{key:"_getInputSettings",value:function(){var h,y,m,x,L,O,U={processor:{type:"none",_isDefaultWhenNone:!0}};this._inputSettings?(h=((m=this._inputSettings)===null||m===void 0?void 0:m.video)||U,y=((x=this._inputSettings)===null||x===void 0?void 0:x.audio)||U):(h=((L=this._preloadCache)===null||L===void 0||(L=L.inputSettings)===null||L===void 0?void 0:L.video)||U,y=((O=this._preloadCache)===null||O===void 0||(O=O.inputSettings)===null||O===void 0?void 0:O.audio)||U);var $={audio:y,video:h};return this._prepInputSettingsForSharing($,!0)}},{key:"_updatePreloadCacheInputSettings",value:function(h,y){var m=this._inputSettings||{},x={};if(h.video){var L,O,U;x.video={},h.video.settings?(x.video.settings={},y||h.video.settings.customTrack||(U=m.video)===null||U===void 0||!U.settings?x.video.settings=h.video.settings:x.video.settings=Y(Y({},m.video.settings),h.video.settings),Object.keys(x.video.settings).length||delete x.video.settings):(L=m.video)!==null&&L!==void 0&&L.settings&&(x.video.settings=m.video.settings),h.video.processor?x.video.processor=h.video.processor:(O=m.video)!==null&&O!==void 0&&O.processor&&(x.video.processor=m.video.processor)}else m.video&&(x.video=m.video);if(h.audio){var $,H,re;x.audio={},h.audio.settings?(x.audio.settings={},y||h.audio.settings.customTrack||(re=m.audio)===null||re===void 0||!re.settings?x.audio.settings=h.audio.settings:x.audio.settings=Y(Y({},m.audio.settings),h.audio.settings),Object.keys(x.audio.settings).length||delete x.audio.settings):($=m.audio)!==null&&$!==void 0&&$.settings&&(x.audio.settings=m.audio.settings),h.audio.processor?x.audio.processor=h.audio.processor:(H=m.audio)!==null&&H!==void 0&&H.processor&&(x.audio.processor=m.audio.processor)}else m.audio&&(x.audio=m.audio);this._maybeUpdateInputSettings(x)}},{key:"_devicesFromInputSettings",value:function(h){var y,m,x=(h==null||(y=h.video)===null||y===void 0||(y=y.settings)===null||y===void 0?void 0:y.deviceId)||null,L=(h==null||(m=h.audio)===null||m===void 0||(m=m.settings)===null||m===void 0?void 0:m.deviceId)||null,O=this._preloadCache.outputDeviceId||null;return{camera:x?{deviceId:x}:{},mic:L?{deviceId:L}:{},speaker:O?{deviceId:O}:{}}}},{key:"updateInputSettings",value:(z=Z(function*(h){var y=this;return ue(),ru(h)?h.video||h.audio?(au(h,this.properties.dailyConfig,this._sharedTracks),this._callObjectMode&&!this._callMachineInitialized?(this._updatePreloadCacheInputSettings(h,!0),this._getInputSettings()):new Promise(function(m,x){y.sendMessageToCallMachine({action:"update-input-settings",inputSettings:h},function(L){if(L.error)x(L.error);else{if(L.returnPreloadCache)return y._updatePreloadCacheInputSettings(h,!0),void m(y._getInputSettings());y._maybeUpdateInputSettings(L.inputSettings),m(y._prepInputSettingsForSharing(L.inputSettings,!0))}})})):this._getInputSettings():(console.error(Mr()),Promise.reject(Mr()))}),function(h){return z.apply(this,arguments)})},{key:"setBandwidth",value:function(h){var y=h.kbs,m=h.trackConstraints;if(ue(),this._callMachineInitialized)return this.sendMessageToCallMachine({action:"set-bandwidth",kbs:y,trackConstraints:m}),this}},{key:"getDailyLang",value:function(){var h=this;if(ue(),this._callMachineInitialized)return new Promise(function(y){h.sendMessageToCallMachine({action:"get-daily-lang"},function(m){delete m.action,delete m.callbackStamp,y(m)})})}},{key:"setDailyLang",value:function(h){return ue(),this.sendMessageToCallMachine({action:"set-daily-lang",lang:h}),this}},{key:"setProxyUrl",value:function(h){return this.sendMessageToCallMachine({action:"set-proxy-url",proxyUrl:h}),this}},{key:"setIceConfig",value:function(h){return this.sendMessageToCallMachine({action:"set-ice-config",iceConfig:h}),this}},{key:"meetingSessionSummary",value:function(){return[Bt,wt].includes(this._callState)?this._finalSummaryOfPrevSession:this._meetingSessionSummary}},{key:"getMeetingSession",value:(ee=Z(function*(){var h=this;return console.warn("getMeetingSession() is deprecated: use meetingSessionSummary(), which will return immediately"),Ee(this._callState,"getMeetingSession()"),new Promise(function(y){h.sendMessageToCallMachine({action:"get-meeting-session"},function(m){delete m.action,delete m.callbackStamp,y(m)})})}),function(){return ee.apply(this,arguments)})},{key:"meetingSessionState",value:function(){return Ee(this._callState,"meetingSessionState"),this._meetingSessionState}},{key:"setMeetingSessionData",value:function(h){var y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"replace";ct(this._callObjectMode,"setMeetingSessionData()"),Ee(this._callState,"setMeetingSessionData");try{(function(m,x){new wp({data:m,mergeStrategy:x})})(h,y)}catch(m){throw console.error(m),m}try{this.sendMessageToCallMachine({action:"set-session-data",data:h,mergeStrategy:y})}catch(m){throw new Error("Error setting meeting session data: ".concat(m))}}},{key:"setUserName",value:function(h,y){var m=this;return this.properties.userName=h,new Promise(function(x){m.sendMessageToCallMachine({action:"set-user-name",name:h??"",thisMeetingOnly:he()||!!y&&!!y.thisMeetingOnly},function(L){delete L.action,delete L.callbackStamp,x(L)})})}},{key:"setUserData",value:(q=Z(function*(h){var y=this;try{su(h)}catch(m){throw console.error(m),m}if(this.properties.userData=h,this._callMachineInitialized)return new Promise(function(m){try{y.sendMessageToCallMachine({action:"set-user-data",userData:h},function(x){delete x.action,delete x.callbackStamp,m(x)})}catch(x){throw new Error("Error setting user data: ".concat(x))}})}),function(h){return q.apply(this,arguments)})},{key:"validateAudioLevelInterval",value:function(h){if(h&&(h<100||typeof h!="number"))throw new Error("The interval must be a number greater than or equal to 100 milliseconds.")}},{key:"startLocalAudioLevelObserver",value:function(h){var y=this;if(typeof AudioWorkletNode>"u"&&!he())throw new Error("startLocalAudioLevelObserver() is not supported on this browser");if(this.validateAudioLevelInterval(h),this._callMachineInitialized)return this._isLocalAudioLevelObserverRunning=!0,new Promise(function(m,x){y.sendMessageToCallMachine({action:"start-local-audio-level-observer",interval:h},function(L){y._isLocalAudioLevelObserverRunning=!L.error,L.error?x({error:L.error}):m()})});this._preloadCache.localAudioLevelObserver={enabled:!0,interval:h}}},{key:"isLocalAudioLevelObserverRunning",value:function(){return this._isLocalAudioLevelObserverRunning}},{key:"stopLocalAudioLevelObserver",value:function(){this._preloadCache.localAudioLevelObserver=null,this._localAudioLevel=0,this._isLocalAudioLevelObserverRunning=!1,this.sendMessageToCallMachine({action:"stop-local-audio-level-observer"})}},{key:"startRemoteParticipantsAudioLevelObserver",value:function(h){var y=this;if(this.validateAudioLevelInterval(h),this._callMachineInitialized)return this._isRemoteParticipantsAudioLevelObserverRunning=!0,new Promise(function(m,x){y.sendMessageToCallMachine({action:"start-remote-participants-audio-level-observer",interval:h},function(L){y._isRemoteParticipantsAudioLevelObserverRunning=!L.error,L.error?x({error:L.error}):m()})});this._preloadCache.remoteParticipantsAudioLevelObserver={enabled:!0,interval:h}}},{key:"isRemoteParticipantsAudioLevelObserverRunning",value:function(){return this._isRemoteParticipantsAudioLevelObserverRunning}},{key:"stopRemoteParticipantsAudioLevelObserver",value:function(){this._preloadCache.remoteParticipantsAudioLevelObserver=null,this._remoteParticipantsAudioLevel={},this._isRemoteParticipantsAudioLevelObserverRunning=!1,this.sendMessageToCallMachine({action:"stop-remote-participants-audio-level-observer"})}},{key:"startCamera",value:(W=Z(function*(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(ct(this._callObjectMode,"startCamera()"),Dr(this._callState,this._isPreparingToJoin,"startCamera()","Did you mean to use setLocalAudio() and/or setLocalVideo() instead?"),this.needsLoad())try{yield this.load(y)}catch(m){return Promise.reject(m)}else{if(this._didPreAuth){if(y.url&&y.url!==this.properties.url)return console.error("url in startCamera() is different than the one used in preAuth()"),Promise.reject();if(y.token&&y.token!==this.properties.token)return console.error("token in startCamera() is different than the one used in preAuth()"),Promise.reject()}this.validateProperties(y),this.properties=Y(Y({},this.properties),y)}return new Promise(function(m){h._preloadCache.inputSettings=h._prepInputSettingsForSharing(h._inputSettings,!1),h.sendMessageToCallMachine({action:"start-camera",properties:Ii(h.properties,h.callClientId),preloadCache:Ii(h._preloadCache,h.callClientId)},function(x){m({camera:x.camera,mic:x.mic,speaker:x.speaker})})})}),function(){return W.apply(this,arguments)})},{key:"validateCustomTrack",value:function(h,y,m){if(m&&m.length>50)throw new Error("Custom track `trackName` must not be more than 50 characters");if(y&&y!=="music"&&y!=="speech"&&!(y instanceof Object))throw new Error("Custom track `mode` must be either `music` | `speech` | `DailyMicAudioModeSettings` or `undefined`");if(m&&["cam-audio","cam-video","screen-video","screen-audio","rmpAudio","rmpVideo","customVideoDefaults"].includes(m))throw new Error("Custom track `trackName` must not match a track name already used by daily: cam-audio, cam-video, customVideoDefaults, screen-video, screen-audio, rmpAudio, rmpVideo");if(!(h instanceof MediaStreamTrack))throw new Error("Custom tracks provided must be instances of MediaStreamTrack")}},{key:"startCustomTrack",value:function(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{track,mode,trackName};return ue(),Ee(this._callState,"startCustomTrack()"),this.validateCustomTrack(y.track,y.mode,y.trackName),new Promise(function(m,x){h._sharedTracks.customTrack=y.track,y.track=Lt,h.sendMessageToCallMachine({action:"start-custom-track",properties:y},function(L){L.error?x({error:L.error}):m(L.mediaTag)})})}},{key:"stopCustomTrack",value:function(h){var y=this;return ue(),Ee(this._callState,"stopCustomTrack()"),new Promise(function(m){y.sendMessageToCallMachine({action:"stop-custom-track",mediaTag:h},function(x){m(x.mediaTag)})})}},{key:"setCamera",value:function(h){var y=this;return Ji(),Ks(this._callMachineInitialized,"setCamera()"),new Promise(function(m){y.sendMessageToCallMachine({action:"set-camera",cameraDeviceId:h},function(x){m({device:x.device})})})}},{key:"setAudioDevice",value:(V=Z(function*(h){return Ji(),this.nativeUtils().setAudioDevice(h),{deviceId:yield this.nativeUtils().getAudioDevice()}}),function(h){return V.apply(this,arguments)})},{key:"cycleCamera",value:function(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return new Promise(function(m){h.sendMessageToCallMachine({action:"cycle-camera",properties:y},function(x){m({device:x.device})})})}},{key:"cycleMic",value:function(){var h=this;return ue(),new Promise(function(y){h.sendMessageToCallMachine({action:"cycle-mic"},function(m){y({device:m.device})})})}},{key:"getCameraFacingMode",value:function(){var h=this;return Ji(),new Promise(function(y){h.sendMessageToCallMachine({action:"get-camera-facing-mode"},function(m){y(m.facingMode)})})}},{key:"setInputDevicesAsync",value:(N=Z(function*(h){var y=this,m=h.audioDeviceId,x=h.videoDeviceId,L=h.audioSource,O=h.videoSource;if(ue(),L!==void 0&&(m=L),O!==void 0&&(x=O),typeof m=="boolean"&&(this._setAllowLocalAudio(m),m=void 0),typeof x=="boolean"&&(this._setAllowLocalVideo(x),x=void 0),!m&&!x)return yield this.getInputDevices();var U={};return m&&(m instanceof MediaStreamTrack?(this._sharedTracks.audioTrack=m,m=Lt,U.audio={settings:{customTrack:m}}):(delete this._sharedTracks.audioTrack,U.audio={settings:{deviceId:m}})),x&&(x instanceof MediaStreamTrack?(this._sharedTracks.videoTrack=x,x=Lt,U.video={settings:{customTrack:x}}):(delete this._sharedTracks.videoTrack,U.video={settings:{deviceId:x}})),this._callObjectMode&&this.needsLoad()?(this._updatePreloadCacheInputSettings(U,!1),this._devicesFromInputSettings(this._inputSettings)):new Promise(function($){y.sendMessageToCallMachine({action:"set-input-devices",audioDeviceId:m,videoDeviceId:x},function(H){if(delete H.action,delete H.callbackStamp,H.returnPreloadCache)return y._updatePreloadCacheInputSettings(U,!1),void $(y._devicesFromInputSettings(y._inputSettings));$(H)})})}),function(h){return N.apply(this,arguments)})},{key:"setOutputDeviceAsync",value:(R=Z(function*(h){var y=this,m=h.outputDeviceId;return ue(),m&&(this._preloadCache.outputDeviceId=m),this._callObjectMode&&this.needsLoad()?this._devicesFromInputSettings(this._inputSettings):new Promise(function(x){y.sendMessageToCallMachine({action:"set-output-device",outputDeviceId:m},function(L){delete L.action,delete L.callbackStamp,L.returnPreloadCache?x(y._devicesFromInputSettings(y._inputSettings)):x(L)})})}),function(h){return R.apply(this,arguments)})},{key:"getInputDevices",value:(D=Z(function*(){var h=this;return this._callObjectMode&&this.needsLoad()?this._devicesFromInputSettings(this._inputSettings):new Promise(function(y){h.sendMessageToCallMachine({action:"get-input-devices"},function(m){m.returnPreloadCache?y(h._devicesFromInputSettings(h._inputSettings)):y({camera:m.camera,mic:m.mic,speaker:m.speaker})})})}),function(){return D.apply(this,arguments)})},{key:"nativeInCallAudioMode",value:function(){return Ji(),this._nativeInCallAudioMode}},{key:"setNativeInCallAudioMode",value:function(h){if(Ji(),[Qc,Wp].includes(h)){if(h!==this._nativeInCallAudioMode)return this._nativeInCallAudioMode=h,!this.disableReactNativeAutoDeviceManagement("audio")&&qs(this._callState,this._isPreparingToJoin)&&this.nativeUtils().setAudioMode(this._nativeInCallAudioMode),this}else console.error("invalid in-call audio mode specified: ",h)}},{key:"preAuth",value:(k=Z(function*(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(ct(this._callObjectMode,"preAuth()"),Dr(this._callState,this._isPreparingToJoin,"preAuth()"),this.needsLoad()&&(yield this.load(y)),!y.url)throw new Error("preAuth() requires at least a url to be provided");return this.validateProperties(y),this.properties=Y(Y({},this.properties),y),new Promise(function(m,x){h._preloadCache.inputSettings=h._prepInputSettingsForSharing(h._inputSettings,!1),h.sendMessageToCallMachine({action:"daily-method-preauth",properties:Ii(h.properties,h.callClientId),preloadCache:Ii(h._preloadCache,h.callClientId)},function(L){return L.error?x(L.error):L.access?(h._didPreAuth=!0,void m({access:L.access})):x(new Error("unknown error in preAuth()"))})})}),function(){return k.apply(this,arguments)})},{key:"load",value:(A=Z(function*(h){var y=this;if(this.needsLoad()){if(this._destroyed&&(this._logUseAfterDestroy(),this.strictMode))throw new Error("Use after destroy");if(h&&(this.validateProperties(h),this.properties=Y(Y({},this.properties),h)),!this._callObjectMode&&!this.properties.url)throw new Error("can't load iframe meeting because url property isn't set");return this._updateCallState(dl),this.emitDailyJSEvent({action:bl}),this._callObjectMode?new Promise(function(m,x){y._callObjectLoader.cancel();var L=Date.now();y._callObjectLoader.load(y.properties.dailyConfig,function(O){y._bundleLoadTime=O?"no-op":Date.now()-L,y._updateCallState(hl),O&&y.emitDailyJSEvent({action:hr}),m()},function(O,U){if(y.emitDailyJSEvent({action:Tl}),!U){y._updateCallState(wt),y.resetMeetingDependentVars();var $={action:vr,errorMsg:O.msg,error:{type:"connection-error",msg:"Failed to load call object bundle.",details:{on:"load",sourceError:O,bundleUrl:gs(y.properties.dailyConfig)}}};y._maybeSendToSentry($),y.emitDailyJSEvent($),x(O.msg)}})}):(this._iframe.src=Qa(this.assembleMeetingUrl(),this.properties.dailyConfig),new Promise(function(m,x){y._loadedCallback=function(L){y._callState!==wt?(y._updateCallState(hl),(y.properties.cssFile||y.properties.cssText)&&y.loadCss(y.properties),m()):x(L)}}))}}),function(h){return A.apply(this,arguments)})},{key:"join",value:(C=Z(function*(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._testCallInProgress&&this.stopTestCallQuality();var m=!1;if(this.needsLoad()){this.updateIsPreparingToJoin(!0);try{yield this.load(y)}catch(x){return this.updateIsPreparingToJoin(!1),Promise.reject(x)}}else{if(m=!(!this.properties.cssFile&&!this.properties.cssText),this._didPreAuth){if(y.url&&y.url!==this.properties.url)return console.error("url in join() is different than the one used in preAuth()"),this.updateIsPreparingToJoin(!1),Promise.reject();if(y.token&&y.token!==this.properties.token)return console.error("token in join() is different than the one used in preAuth()"),this.updateIsPreparingToJoin(!1),Promise.reject()}if(y.url&&!this._callObjectMode&&y.url&&y.url!==this.properties.url)return console.error("url in join() is different than the one used in load() (".concat(this.properties.url," -> ").concat(y.url,")")),this.updateIsPreparingToJoin(!1),Promise.reject();this.validateProperties(y),this.properties=Y(Y({},this.properties),y)}return y.showLocalVideo!==void 0&&(this._callObjectMode?console.error("showLocalVideo is not available in callObject mode"):this._showLocalVideo=!!y.showLocalVideo),y.showParticipantsBar!==void 0&&(this._callObjectMode?console.error("showParticipantsBar is not available in callObject mode"):this._showParticipantsBar=!!y.showParticipantsBar),this._callState===Ut||this._callState===Ms?(console.warn("already joined meeting, call leave() before joining again"),void this.updateIsPreparingToJoin(!1)):(this._updateCallState(Ms,!1),this.emitDailyJSEvent({action:Al}),this._preloadCache.inputSettings=this._prepInputSettingsForSharing(this._inputSettings||{},!1),this.sendMessageToCallMachine({action:"join-meeting",properties:Ii(this.properties,this.callClientId),preloadCache:Ii(this._preloadCache,this.callClientId)}),new Promise(function(x,L){h._joinedCallback=function(O,U){if(h._callState!==wt){if(h._updateCallState(Ut),O)for(var $ in O){if(h._callObjectMode){var H=h._callMachine().store;Nc(O[$],H),Uc(O[$],H),Bc(O[$],h._participants[$],H)}h._participants[$]=Y({},O[$]),h.toggleParticipantAudioBasedOnNativeAudioFocus()}m&&h.loadCss(h.properties),x(O)}else L(U)}}))}),function(){return C.apply(this,arguments)})},{key:"leave",value:(T=Z(function*(){var h=this;return this._testCallInProgress&&this.stopTestCallQuality(),new Promise(function(y){h._callState===Bt||h._callState===wt?y():h._callObjectLoader&&!h._callObjectLoader.loaded?(h._callObjectLoader.cancel(),h._updateCallState(Bt),h.resetMeetingDependentVars(),h.emitDailyJSEvent({action:Bt}),y()):(h._resolveLeave=y,h.sendMessageToCallMachine({action:"leave-meeting"}))})}),function(){return T.apply(this,arguments)})},{key:"startScreenShare",value:(_=Z(function*(){var h=this,y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Ks(this._callMachineInitialized,"startScreenShare()"),y.screenVideoSendSettings&&this._validateVideoSendSettings("screenVideo",y.screenVideoSendSettings),y.mediaStream&&(this._sharedTracks.screenMediaStream=y.mediaStream,y.mediaStream=Lt),typeof DailyNativeUtils<"u"&&DailyNativeUtils.isIOS!==void 0&&DailyNativeUtils.isIOS){var m=this.nativeUtils();if(yield m.isScreenBeingCaptured())return void this.emitDailyJSEvent({action:mr,type:"screen-share-error",errorMsg:"Could not start the screen sharing. The screen is already been captured!"});m.setSystemScreenCaptureStartCallback(function(){m.setSystemScreenCaptureStartCallback(null),h.sendMessageToCallMachine({action:pc,captureOptions:y})}),m.presentSystemScreenCapturePrompt()}else this.sendMessageToCallMachine({action:pc,captureOptions:y})}),function(){return _.apply(this,arguments)})},{key:"stopScreenShare",value:function(){Ks(this._callMachineInitialized,"stopScreenShare()"),this.sendMessageToCallMachine({action:"local-screen-stop"})}},{key:"startRecording",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},y=h.type;if(y&&y!=="cloud"&&y!=="raw-tracks"&&y!=="local")throw new Error("invalid type: ".concat(y,", allowed values 'cloud', 'raw-tracks', or 'local'"));this.sendMessageToCallMachine(Y({action:"local-recording-start"},h))}},{key:"updateRecording",value:function(h){var y=h.layout,m=y===void 0?{preset:"default"}:y,x=h.instanceId;this.sendMessageToCallMachine({action:"daily-method-update-recording",layout:m,instanceId:x})}},{key:"stopRecording",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.sendMessageToCallMachine(Y({action:"local-recording-stop"},h))}},{key:"startLiveStreaming",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.sendMessageToCallMachine(Y({action:"daily-method-start-live-streaming"},h))}},{key:"updateLiveStreaming",value:function(h){var y=h.layout,m=y===void 0?{preset:"default"}:y,x=h.instanceId;this.sendMessageToCallMachine({action:"daily-method-update-live-streaming",layout:m,instanceId:x})}},{key:"addLiveStreamingEndpoints",value:function(h){var y=h.endpoints,m=h.instanceId;this.sendMessageToCallMachine({action:gc,endpointsOp:Sp,endpoints:y,instanceId:m})}},{key:"removeLiveStreamingEndpoints",value:function(h){var y=h.endpoints,m=h.instanceId;this.sendMessageToCallMachine({action:gc,endpointsOp:Ep,endpoints:y,instanceId:m})}},{key:"stopLiveStreaming",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.sendMessageToCallMachine(Y({action:"daily-method-stop-live-streaming"},h))}},{key:"validateDailyConfig",value:function(h){h.camSimulcastEncodings&&(console.warn("camSimulcastEncodings is deprecated. Use sendSettings, found in DailyCallOptions, to provide camera simulcast settings."),this.validateSimulcastEncodings(h.camSimulcastEncodings)),h.screenSimulcastEncodings&&console.warn("screenSimulcastEncodings is deprecated. Use sendSettings, found in DailyCallOptions, to provide screen simulcast settings."),_c()&&h.noAutoDefaultDeviceChange&&console.warn("noAutoDefaultDeviceChange is not supported on Android, and will be ignored.")}},{key:"validateSimulcastEncodings",value:function(h){var y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null,m=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(h){if(!(h instanceof Array||Array.isArray(h)))throw new Error("encodings must be an Array");if(!gu(h.length,1,3))throw new Error("encodings must be an Array with between 1 to ".concat(3," layers"));for(var x=0;x<h.length;x++){var L=h[x];for(var O in this._validateEncodingLayerHasValidProperties(L),L)if(Rr.includes(O)){if(typeof L[O]!="number")throw new Error("".concat(O," must be a number"));if(y){var U=y[O],$=U.min,H=U.max;if(!gu(L[O],$,H))throw new Error("".concat(O," value not in range. valid range: ").concat($," to ").concat(H))}}else if(!["active","scalabilityMode"].includes(O))throw new Error("Invalid key ".concat(O,", valid keys are:")+Object.values(Rr));if(m&&!L.hasOwnProperty("maxBitrate"))throw new Error("maxBitrate is not specified")}}}},{key:"startRemoteMediaPlayer",value:(w=Z(function*(h){var y=this,m=h.url,x=h.settings,L=x===void 0?{state:Er.PLAY}:x;try{(function(O){if(typeof O!="string")throw new Error('url parameter must be "string" type')})(m),pu(L),function(O){for(var U in O)if(!tu.includes(U))throw new Error("Invalid key ".concat(U,", valid keys are: ").concat(tu));O.simulcastEncodings&&this.validateSimulcastEncodings(O.simulcastEncodings,eu,!0)}(L)}catch(O){throw console.error("invalid argument Error: ".concat(O)),console.error(`startRemoteMediaPlayer arguments must be of the form:
  { url: "playback url",
  settings?:
  {state: "play"|"pause", simulcastEncodings?: [{}] } }`),O}return new Promise(function(O,U){y.sendMessageToCallMachine({action:"daily-method-start-remote-media-player",url:m,settings:L},function($){$.error?U({error:$.error,errorMsg:$.errorMsg}):O({session_id:$.session_id,remoteMediaPlayerState:{state:$.state,settings:$.settings}})})})}),function(h){return w.apply(this,arguments)})},{key:"stopRemoteMediaPlayer",value:(I=Z(function*(h){var y=this;if(typeof h!="string")throw new Error(" remotePlayerID must be of type string");return new Promise(function(m,x){y.sendMessageToCallMachine({action:"daily-method-stop-remote-media-player",session_id:h},function(L){L.error?x({error:L.error,errorMsg:L.errorMsg}):m()})})}),function(h){return I.apply(this,arguments)})},{key:"updateRemoteMediaPlayer",value:(b=Z(function*(h){var y=this,m=h.session_id,x=h.settings;try{pu(x)}catch(L){throw console.error("invalid argument Error: ".concat(L)),console.error(`updateRemoteMediaPlayer arguments must be of the form:
  session_id: "participant session",
  { settings?: {state: "play"|"pause"} }`),L}return new Promise(function(L,O){y.sendMessageToCallMachine({action:"daily-method-update-remote-media-player",session_id:m,settings:x},function(U){U.error?O({error:U.error,errorMsg:U.errorMsg}):L({session_id:U.session_id,remoteMediaPlayerState:{state:U.state,settings:U.settings}})})})}),function(h){return b.apply(this,arguments)})},{key:"startTranscription",value:function(h){Ee(this._callState,"startTranscription()"),this.sendMessageToCallMachine(Y({action:"daily-method-start-transcription"},h))}},{key:"updateTranscription",value:function(h){if(Ee(this._callState,"updateTranscription()"),!h)throw new Error("updateTranscription Error: options is mandatory");if(fe(h)!=="object")throw new Error("updateTranscription Error: options must be object type");if(h.participants&&!Array.isArray(h.participants))throw new Error("updateTranscription Error: participants must be an array");this.sendMessageToCallMachine(Y({action:"daily-method-update-transcription"},h))}},{key:"stopTranscription",value:function(h){if(Ee(this._callState,"stopTranscription()"),h&&fe(h)!=="object")throw new Error("stopTranscription Error: options must be object type");if(h&&!h.instanceId)throw new Error('"instanceId" not provided');this.sendMessageToCallMachine(Y({action:"daily-method-stop-transcription"},h))}},{key:"startDialOut",value:(S=Z(function*(h){var y=this;Ee(this._callState,"startDialOut()");var m=function(x){if(x){if(!Array.isArray(x))throw new Error("Error starting dial out: audio codec must be an array");if(x.length<=0)throw new Error("Error starting dial out: audio codec array specified but empty");x.forEach(function(L){if(typeof L!="string")throw new Error("Error starting dial out: audio codec must be a string");if(L!=="OPUS"&&L!=="PCMU"&&L!=="PCMA"&&L!=="G722")throw new Error("Error starting dial out: audio codec must be one of OPUS, PCMU, PCMA, G722")})}};if(!h.sipUri&&!h.phoneNumber)throw new Error("Error starting dial out: either a sip uri or phone number must be provided");if(h.sipUri&&h.phoneNumber)throw new Error("Error starting dial out: only one of sip uri or phone number must be provided");if(h.sipUri){if(typeof h.sipUri!="string")throw new Error("Error starting dial out: sipUri must be a string");if(!h.sipUri.startsWith("sip:"))throw new Error("Error starting dial out: Invalid SIP URI, must start with 'sip:'");if(h.video&&typeof h.video!="boolean")throw new Error("Error starting dial out: video must be a boolean value");(function(x){if(x&&(m(x.audio),x.video)){if(!Array.isArray(x.video))throw new Error("Error starting dial out: video codec must be an array");if(x.video.length<=0)throw new Error("Error starting dial out: video codec array specified but empty");x.video.forEach(function(L){if(typeof L!="string")throw new Error("Error starting dial out: video codec must be a string");if(L!=="H264"&&L!=="VP8")throw new Error("Error starting dial out: video codec must be H264 or VP8")})}})(h.codecs)}if(h.phoneNumber){if(typeof h.phoneNumber!="string")throw new Error("Error starting dial out: phoneNumber must be a string");if(!/^\+\d{1,}$/.test(h.phoneNumber))throw new Error("Error starting dial out: Invalid phone number, must be valid phone number as per E.164");h.codecs&&m(h.codecs.audio)}if(h.callerId){if(typeof h.callerId!="string")throw new Error("Error starting dial out: callerId must be a string");if(h.sipUri)throw new Error("Error starting dial out: callerId not allowed with sipUri")}if(h.displayName){if(typeof h.displayName!="string")throw new Error("Error starting dial out: displayName must be a string");if(h.displayName.length>=200)throw new Error("Error starting dial out: displayName length must be less than 200")}if(h.userId){if(typeof h.userId!="string")throw new Error("Error starting dial out: userId must be a string");if(h.userId.length>36)throw new Error("Error starting dial out: userId length must be less than or equal to 36")}return new Promise(function(x,L){y.sendMessageToCallMachine(Y({action:"dialout-start"},h),function(O){O.error?L(O.error):x(O)})})}),function(h){return S.apply(this,arguments)})},{key:"stopDialOut",value:function(h){var y=this;return Ee(this._callState,"stopDialOut()"),new Promise(function(m,x){y.sendMessageToCallMachine(Y({action:"dialout-stop"},h),function(L){L.error?x(L.error):m(L)})})}},{key:"sipCallTransfer",value:(v=Z(function*(h){var y=this;if(Ee(this._callState,"sipCallTransfer()"),!h)throw new Error("sipCallTransfer() requires a sessionId and toEndPoint");return h.useSipRefer=!1,fu(h,"sipCallTransfer"),new Promise(function(m,x){y.sendMessageToCallMachine(Y({action:vc},h),function(L){L.error?x(L.error):m(L)})})}),function(h){return v.apply(this,arguments)})},{key:"sipRefer",value:(p=Z(function*(h){var y=this;if(Ee(this._callState,"sipRefer()"),!h)throw new Error("sessionId and toEndPoint are mandatory parameter");return h.useSipRefer=!0,fu(h,"sipRefer"),new Promise(function(m,x){y.sendMessageToCallMachine(Y({action:vc},h),function(L){L.error?x(L.error):m(L)})})}),function(h){return p.apply(this,arguments)})},{key:"sendDTMF",value:(g=Z(function*(h){var y=this;return Ee(this._callState,"sendDTMF()"),function(m){var x=m.sessionId,L=m.tones;if(!x||!L)throw new Error("sessionId and tones are mandatory parameter");if(typeof x!="string"||typeof L!="string")throw new Error("sessionId and tones should be of string type");if(L.length>20)throw new Error("tones string must be upto 20 characters");var O=/[^0-9A-D*#]/g,U=L.match(O);if(U&&U[0])throw new Error("".concat(U[0]," is not valid DTMF tone"))}(h),new Promise(function(m,x){y.sendMessageToCallMachine(Y({action:"send-dtmf"},h),function(L){L.error?x(L.error):m(L)})})}),function(h){return g.apply(this,arguments)})},{key:"getNetworkStats",value:function(){var h=this;return this._callState!==Ut?Promise.resolve(Y({stats:{latest:{}}},this._network)):new Promise(function(y){h.sendMessageToCallMachine({action:"get-calc-stats"},function(m){y(Y(Y({},h._network),{},{stats:m.stats}))})})}},{key:"testWebsocketConnectivity",value:(f=Z(function*(){var h=this;if(Or(this._testCallInProgress,"testWebsocketConnectivity()"),this.needsLoad())try{yield this.load()}catch(y){return Promise.reject(y)}return new Promise(function(y,m){h.sendMessageToCallMachine({action:"test-websocket-connectivity"},function(x){x.error?m(x.error):y(x.results)})})}),function(){return f.apply(this,arguments)})},{key:"abortTestWebsocketConnectivity",value:function(){this.sendMessageToCallMachine({action:"abort-test-websocket-connectivity"})}},{key:"_validateVideoTrackForNetworkTests",value:function(h){return h?h instanceof MediaStreamTrack?!!Gp(h)||(console.error("Video track is not playable. This test needs a live video track."),!1):(console.error("Video track needs to be of type `MediaStreamTrack`."),!1):(console.error("Missing video track. You must provide a video track in order to run this test."),!1)}},{key:"testCallQuality",value:(d=Z(function*(){var h=this;ue(),ct(this._callObjectMode,"testCallQuality()"),Ks(this._callMachineInitialized,"testCallQuality()",null,!0),Dr(this._callState,this._isPreparingToJoin,"testCallQuality()");var y=this._testCallAlreadyInProgress,m=function(L){y||(h._testCallInProgress=L)};if(m(!0),this.needsLoad())try{var x=this._callState;yield this.load(),this._callState=x}catch(L){return m(!1),Promise.reject(L)}return new Promise(function(L){h.sendMessageToCallMachine({action:"test-call-quality",dailyJsVersion:h.properties.dailyJsVersion},function(O){var U=O.results,$=U.result,H=Ra(U,Hp);if($==="failed"){var re,le=Y({},H);(re=H.error)!==null&&re!==void 0&&re.details?(H.error.details=JSON.parse(H.error.details),le.error=Y(Y({},le.error),{},{details:Y({},le.error.details)}),le.error.details.duringTest="testCallQuality"):(le.error=le.error?Y({},le.error):{},le.error.details={duringTest:"testCallQuality"}),h._maybeSendToSentry(le)}m(!1),L(Y({result:$},H))})})}),function(){return d.apply(this,arguments)})},{key:"stopTestCallQuality",value:function(){this.sendMessageToCallMachine({action:"stop-test-call-quality"})}},{key:"testConnectionQuality",value:(u=Z(function*(h){var y;he()?(console.warn("testConnectionQuality() is deprecated: use testPeerToPeerCallQuality() instead"),y=yield this.testPeerToPeerCallQuality(h)):(console.warn("testConnectionQuality() is deprecated: use testCallQuality() instead"),y=yield this.testCallQuality());var m={result:y.result,secondsElapsed:y.secondsElapsed};return y.data&&(m.data={maxRTT:y.data.maxRoundTripTime,packetLoss:y.data.avgRecvPacketLoss}),m}),function(h){return u.apply(this,arguments)})},{key:"testPeerToPeerCallQuality",value:(c=Z(function*(h){var y=this;if(Or(this._testCallInProgress,"testPeerToPeerCallQuality()"),this.needsLoad())try{yield this.load()}catch(L){return Promise.reject(L)}var m=h.videoTrack,x=h.duration;if(!this._validateVideoTrackForNetworkTests(m))throw new Error("Video track error");return this._sharedTracks.videoTrackForConnectionQualityTest=m,new Promise(function(L,O){y.sendMessageToCallMachine({action:"test-p2p-call-quality",duration:x},function(U){U.error?O(U.error):L(U.results)})})}),function(h){return c.apply(this,arguments)})},{key:"stopTestConnectionQuality",value:function(){he()?(console.warn("stopTestConnectionQuality() is deprecated: use testPeerToPeerCallQuality() and stopTestPeerToPeerCallQuality() instead"),this.stopTestPeerToPeerCallQuality()):(console.warn("stopTestConnectionQuality() is deprecated: use testCallQuality() and stopTestCallQuality() instead"),this.stopTestCallQuality())}},{key:"stopTestPeerToPeerCallQuality",value:function(){this.sendMessageToCallMachine({action:"stop-test-p2p-call-quality"})}},{key:"testNetworkConnectivity",value:(l=Z(function*(h){var y=this;if(Or(this._testCallInProgress,"testNetworkConnectivity()"),this.needsLoad())try{yield this.load()}catch(m){return Promise.reject(m)}if(!this._validateVideoTrackForNetworkTests(h))throw new Error("Video track error");return this._sharedTracks.videoTrackForNetworkConnectivityTest=h,new Promise(function(m,x){y.sendMessageToCallMachine({action:"test-network-connectivity"},function(L){L.error?x(L.error):m(L.results)})})}),function(h){return l.apply(this,arguments)})},{key:"abortTestNetworkConnectivity",value:function(){this.sendMessageToCallMachine({action:"abort-test-network-connectivity"})}},{key:"getCpuLoadStats",value:function(){var h=this;return new Promise(function(y){h._callState===Ut?h.sendMessageToCallMachine({action:"get-cpu-load-stats"},function(m){y(m.cpuStats)}):y({cpuLoadState:void 0,cpuLoadStateReason:void 0,stats:{}})})}},{key:"_validateEncodingLayerHasValidProperties",value:function(h){var y;if(!(((y=Object.keys(h))===null||y===void 0?void 0:y.length)>0))throw new Error("Empty encoding is not allowed. At least one of these valid keys should be specified:"+Object.values(Rr))}},{key:"_validateVideoSendSettings",value:function(h,y){var m=h==="screenVideo"?["default-screen-video","detail-optimized","motion-optimized","motion-and-detail-balanced"]:["default-video","bandwidth-optimized","bandwidth-and-quality-balanced","quality-optimized","adaptive-2-layers","adaptive-3-layers"],x="Video send settings should be either an object or one of the supported presets: ".concat(m.join());if(typeof y=="string"){if(!m.includes(y))throw new Error(x)}else{if(fe(y)!=="object")throw new Error(x);if(!y.maxQuality&&!y.encodings&&y.allowAdaptiveLayers===void 0)throw new Error("Video send settings must contain at least maxQuality, allowAdaptiveLayers or encodings attribute");if(y.maxQuality&&["low","medium","high"].indexOf(y.maxQuality)===-1)throw new Error("maxQuality must be either low, medium or high");if(y.encodings){var L=!1;switch(Object.keys(y.encodings).length){case 1:L=!y.encodings.low;break;case 2:L=!y.encodings.low||!y.encodings.medium;break;case 3:L=!y.encodings.low||!y.encodings.medium||!y.encodings.high;break;default:L=!0}if(L)throw new Error("Encodings must be defined as: low, low and medium, or low, medium and high.");y.encodings.low&&this._validateEncodingLayerHasValidProperties(y.encodings.low),y.encodings.medium&&this._validateEncodingLayerHasValidProperties(y.encodings.medium),y.encodings.high&&this._validateEncodingLayerHasValidProperties(y.encodings.high)}}}},{key:"validateUpdateSendSettings",value:function(h){var y=this;if(!h||Object.keys(h).length===0)throw new Error("Send settings must contain at least information for one track!");Object.entries(h).forEach(function(m){var x=Me(m,2),L=x[0],O=x[1];y._validateVideoSendSettings(L,O)})}},{key:"updateSendSettings",value:function(h){var y=this;return this.validateUpdateSendSettings(h),this.needsLoad()?(this._preloadCache.sendSettings=h,{sendSettings:this._preloadCache.sendSettings}):new Promise(function(m,x){y.sendMessageToCallMachine({action:"update-send-settings",sendSettings:h},function(L){L.error?x(L.error):m(L.sendSettings)})})}},{key:"getSendSettings",value:function(){return this._sendSettings||this._preloadCache.sendSettings}},{key:"getLocalAudioLevel",value:function(){return this._localAudioLevel}},{key:"getRemoteParticipantsAudioLevel",value:function(){return this._remoteParticipantsAudioLevel}},{key:"getActiveSpeaker",value:function(){return ue(),this._activeSpeaker}},{key:"setActiveSpeakerMode",value:function(h){return ue(),this.sendMessageToCallMachine({action:"set-active-speaker-mode",enabled:h}),this}},{key:"activeSpeakerMode",value:function(){return ue(),this._activeSpeakerMode}},{key:"subscribeToTracksAutomatically",value:function(){return this._preloadCache.subscribeToTracksAutomatically}},{key:"setSubscribeToTracksAutomatically",value:function(h){return Ee(this._callState,"setSubscribeToTracksAutomatically()","Use the subscribeToTracksAutomatically configuration property."),this._preloadCache.subscribeToTracksAutomatically=h,this.sendMessageToCallMachine({action:"daily-method-subscribe-to-tracks-automatically",enabled:h}),this}},{key:"enumerateDevices",value:(o=Z(function*(){var h=this;if(this._callObjectMode){var y=yield navigator.mediaDevices.enumerateDevices();return ai()==="Firefox"&&Bs().major>115&&Bs().major<123&&(y=y.filter(function(m){return m.kind!=="audiooutput"})),{devices:y.map(function(m){var x=JSON.parse(JSON.stringify(m));if(!he()&&m.kind==="videoinput"&&m.getCapabilities){var L,O=m.getCapabilities();x.facing=(O==null||(L=O.facingMode)===null||L===void 0?void 0:L.length)>=1?O.facingMode[0]:void 0}return x})}}return new Promise(function(m){h.sendMessageToCallMachine({action:"enumerate-devices"},function(x){m({devices:x.devices})})})}),function(){return o.apply(this,arguments)})},{key:"sendAppMessage",value:function(h){var y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"*";if(Ee(this._callState,"sendAppMessage()"),JSON.stringify(h).length>this._maxAppMessageSize)throw new Error("Message data too large. Max size is "+this._maxAppMessageSize);return this.sendMessageToCallMachine({action:"app-msg",data:h,to:y}),this}},{key:"addFakeParticipant",value:function(h){return ue(),Ee(this._callState,"addFakeParticipant()"),this.sendMessageToCallMachine(Y({action:"add-fake-participant"},h)),this}},{key:"setShowNamesMode",value:function(h){return Ye(this._callObjectMode,"setShowNamesMode()"),ue(),h&&h!=="always"&&h!=="never"?(console.error('setShowNamesMode argument should be "always", "never", or false'),this):(this.sendMessageToCallMachine({action:"set-show-names",mode:h}),this)}},{key:"setShowLocalVideo",value:function(){var h=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return Ye(this._callObjectMode,"setShowLocalVideo()"),ue(),Ee(this._callState,"setShowLocalVideo()"),typeof h!="boolean"?(console.error("setShowLocalVideo only accepts a boolean value"),this):(this.sendMessageToCallMachine({action:"set-show-local-video",show:h}),this._showLocalVideo=h,this)}},{key:"showLocalVideo",value:function(){return Ye(this._callObjectMode,"showLocalVideo()"),ue(),this._showLocalVideo}},{key:"setShowParticipantsBar",value:function(){var h=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return Ye(this._callObjectMode,"setShowParticipantsBar()"),ue(),Ee(this._callState,"setShowParticipantsBar()"),typeof h!="boolean"?(console.error("setShowParticipantsBar only accepts a boolean value"),this):(this.sendMessageToCallMachine({action:"set-show-participants-bar",show:h}),this._showParticipantsBar=h,this)}},{key:"showParticipantsBar",value:function(){return Ye(this._callObjectMode,"showParticipantsBar()"),ue(),this._showParticipantsBar}},{key:"customIntegrations",value:function(){return ue(),Ye(this._callObjectMode,"customIntegrations()"),this._customIntegrations}},{key:"setCustomIntegrations",value:function(h){return ue(),Ye(this._callObjectMode,"setCustomIntegrations()"),Ee(this._callState,"setCustomIntegrations()"),du(h)?(this.sendMessageToCallMachine({action:"set-custom-integrations",integrations:h}),this._customIntegrations=h,this):this}},{key:"startCustomIntegrations",value:function(h){var y=this;if(ue(),Ye(this._callObjectMode,"startCustomIntegrations()"),Ee(this._callState,"startCustomIntegrations()"),Array.isArray(h)&&h.some(function(L){return typeof L!="string"})||!Array.isArray(h)&&typeof h!="string")return console.error("startCustomIntegrations() only accepts string | string[]"),this;var m=typeof h=="string"?[h]:h,x=m.filter(function(L){return!(L in y._customIntegrations)});return x.length?(console.error(`Can't find custom integration(s): "`.concat(x.join(", "),'"')),this):(this.sendMessageToCallMachine({action:"start-custom-integrations",ids:m}),this)}},{key:"stopCustomIntegrations",value:function(h){var y=this;if(ue(),Ye(this._callObjectMode,"stopCustomIntegrations()"),Ee(this._callState,"stopCustomIntegrations()"),Array.isArray(h)&&h.some(function(L){return typeof L!="string"})||!Array.isArray(h)&&typeof h!="string")return console.error("stopCustomIntegrations() only accepts string | string[]"),this;var m=typeof h=="string"?[h]:h,x=m.filter(function(L){return!(L in y._customIntegrations)});return x.length?(console.error(`Can't find custom integration(s): "`.concat(x.join(", "),'"')),this):(this.sendMessageToCallMachine({action:"stop-custom-integrations",ids:m}),this)}},{key:"customTrayButtons",value:function(){return Ye(this._callObjectMode,"customTrayButtons()"),ue(),this._customTrayButtons}},{key:"updateCustomTrayButtons",value:function(h){return Ye(this._callObjectMode,"updateCustomTrayButtons()"),ue(),Ee(this._callState,"updateCustomTrayButtons()"),uu(h)?(this.sendMessageToCallMachine({action:"update-custom-tray-buttons",btns:h}),this._customTrayButtons=h,this):(console.error("updateCustomTrayButtons only accepts a dictionary of the type ".concat(JSON.stringify(Gs))),this)}},{key:"theme",value:function(){return Ye(this._callObjectMode,"theme()"),this.properties.theme}},{key:"setTheme",value:function(h){var y=this;return Ye(this._callObjectMode,"setTheme()"),new Promise(function(m,x){try{y.validateProperties({theme:h}),y.properties.theme=Y({},h),y.sendMessageToCallMachine({action:"set-theme",theme:y.properties.theme});try{y.emitDailyJSEvent({action:El,theme:y.properties.theme})}catch(L){console.log("could not emit 'theme-updated'",L)}m(y.properties.theme)}catch(L){x(L)}})}},{key:"requestFullscreen",value:(a=Z(function*(){if(ue(),this._iframe&&!document.fullscreenElement&&Sc())try{(yield this._iframe.requestFullscreen)?this._iframe.requestFullscreen():this._iframe.webkitRequestFullscreen()}catch(h){console.log("could not make video call fullscreen",h)}}),function(){return a.apply(this,arguments)})},{key:"exitFullscreen",value:function(){ue(),document.fullscreenElement?document.exitFullscreen():document.webkitFullscreenElement&&document.webkitExitFullscreen()}},{key:"getSidebarView",value:(r=Z(function*(){var h=this;return this._callObjectMode?(console.error("getSidebarView is not available in callObject mode"),Promise.resolve(null)):new Promise(function(y){h.sendMessageToCallMachine({action:"get-sidebar-view"},function(m){y(m.view)})})}),function(){return r.apply(this,arguments)})},{key:"setSidebarView",value:function(h){return this._callObjectMode?(console.error("setSidebarView is not available in callObject mode"),this):(this.sendMessageToCallMachine({action:"set-sidebar-view",view:h}),this)}},{key:"room",value:(n=Z(function*(){var h=this,y=(arguments.length>0&&arguments[0]!==void 0?arguments[0]:{}).includeRoomConfigDefaults,m=y===void 0||y;return this._accessState.access===Fs||this.needsLoad()?this.properties.url?{roomUrlPendingJoin:this.properties.url}:null:new Promise(function(x){h.sendMessageToCallMachine({action:"lib-room-info",includeRoomConfigDefaults:m},function(L){delete L.action,delete L.callbackStamp,x(L)})})}),function(){return n.apply(this,arguments)})},{key:"geo",value:(i=Z(function*(){try{var h=yield fetch("https://gs.daily.co/_ks_/x-swsl/:");return{current:(yield h.json()).geo}}catch(y){return console.error("geo lookup failed",y),{current:""}}}),function(){return i.apply(this,arguments)})},{key:"setNetworkTopology",value:(t=Z(function*(h){var y=this;return ue(),Ee(this._callState,"setNetworkTopology()"),new Promise(function(m,x){y.sendMessageToCallMachine({action:"set-network-topology",opts:h},function(L){L.error?x({error:L.error}):m({workerId:L.workerId})})})}),function(h){return t.apply(this,arguments)})},{key:"getNetworkTopology",value:(e=Z(function*(){var h=this;return new Promise(function(y,m){h.needsLoad()&&y({topology:"none"}),h.sendMessageToCallMachine({action:"get-network-topology"},function(x){x.error?m({error:x.error}):y({topology:x.topology})})})}),function(){return e.apply(this,arguments)})},{key:"setPlayNewParticipantSound",value:function(h){if(ue(),typeof h!="number"&&h!==!0&&h!==!1)throw new Error("argument to setShouldPlayNewParticipantSound should be true, false, or a number, but is ".concat(h));this.sendMessageToCallMachine({action:"daily-method-set-play-ding",arg:h})}},{key:"on",value:function(h,y){return fs.prototype.on.call(this,h,y)}},{key:"once",value:function(h,y){return fs.prototype.once.call(this,h,y)}},{key:"off",value:function(h,y){return fs.prototype.off.call(this,h,y)}},{key:"validateProperties",value:function(h){var y,m;if(h!=null&&(y=h.dailyConfig)!==null&&y!==void 0&&y.userMediaAudioConstraints){var x,L;he()||console.warn("userMediaAudioConstraints is deprecated. You can override constraints with inputSettings.audio.settings, found in DailyCallOptions.");var O=h.inputSettings||{};O.audio=((x=h.inputSettings)===null||x===void 0?void 0:x.audio)||{},O.audio.settings=((L=h.inputSettings)===null||L===void 0||(L=L.audio)===null||L===void 0?void 0:L.settings)||{},O.audio.settings=Y(Y({},O.audio.settings),h.dailyConfig.userMediaAudioConstraints),h.inputSettings=O,delete h.dailyConfig.userMediaAudioConstraints}if(h!=null&&(m=h.dailyConfig)!==null&&m!==void 0&&m.userMediaVideoConstraints){var U,$;he()||console.warn("userMediaVideoConstraints is deprecated. You can override constraints with inputSettings.video.settings, found in DailyCallOptions.");var H=h.inputSettings||{};H.video=((U=h.inputSettings)===null||U===void 0?void 0:U.video)||{},H.video.settings=(($=h.inputSettings)===null||$===void 0||($=$.video)===null||$===void 0?void 0:$.settings)||{},H.video.settings=Y(Y({},H.video.settings),h.dailyConfig.userMediaVideoConstraints),h.inputSettings=H,delete h.dailyConfig.userMediaVideoConstraints}for(var re in h){if(!li[re])throw new Error("unrecognized property '".concat(re,"'"));if(li[re].validate&&!li[re].validate(h[re],this))throw new Error("property '".concat(re,"': ").concat(li[re].help))}}},{key:"assembleMeetingUrl",value:function(){var h,y,m=Y(Y({},this.properties),{},{emb:this.callClientId,embHref:encodeURIComponent(window.location.href),proxy:(h=this.properties.dailyConfig)!==null&&h!==void 0&&h.proxyUrl?encodeURIComponent((y=this.properties.dailyConfig)===null||y===void 0?void 0:y.proxyUrl):void 0}),x=m.url.match(/\?/)?"&":"?";return m.url+x+Object.keys(li).filter(function(L){return li[L].queryString&&m[L]!==void 0}).map(function(L){return"".concat(li[L].queryString,"=").concat(m[L])}).join("&")}},{key:"needsLoad",value:function(){return[ur,dl,Bt,wt].includes(this._callState)}},{key:"sendMessageToCallMachine",value:function(h,y){if(this._destroyed&&(this._logUseAfterDestroy(),this.strictMode))throw new Error("Use after destroy");this._messageChannel.sendMessageToCallMachine(h,y,this.callClientId,this._iframe)}},{key:"forwardPackagedMessageToCallMachine",value:function(h){this._messageChannel.forwardPackagedMessageToCallMachine(h,this._iframe,this.callClientId)}},{key:"addListenerForPackagedMessagesFromCallMachine",value:function(h){return this._messageChannel.addListenerForPackagedMessagesFromCallMachine(h,this.callClientId)}},{key:"removeListenerForPackagedMessagesFromCallMachine",value:function(h){this._messageChannel.removeListenerForPackagedMessagesFromCallMachine(h)}},{key:"handleMessageFromCallMachine",value:function(h){switch(h.action){case yl:this.sendMessageToCallMachine(Y({action:Sl},this.properties));break;case"call-machine-initialized":this._callMachineInitialized=!0;var y={action:Ns,level:"log",code:1011,stats:{event:"bundle load",time:this._bundleLoadTime==="no-op"?0:this._bundleLoadTime,preLoaded:this._bundleLoadTime==="no-op",url:gs(this.properties.dailyConfig)}};this.sendMessageToCallMachine(y),this._delayDuplicateInstanceLog&&this._logDuplicateInstanceAttempt();break;case hr:this._loadedCallback&&(this._loadedCallback(),this._loadedCallback=null),this.emitDailyJSEvent(h);break;case Il:var m,x=Y({},h);delete x.internal,this._maxAppMessageSize=((m=h.internal)===null||m===void 0?void 0:m._maxAppMessageSize)||yr,this._joinedCallback&&(this._joinedCallback(h.participants),this._joinedCallback=null),this.emitDailyJSEvent(x);break;case Ll:case kl:if(this._callState===Bt)return;if(h.participant&&h.participant.session_id){var L=h.participant.local?"local":h.participant.session_id;if(this._callObjectMode){var O=this._callMachine().store;Nc(h.participant,O),Uc(h.participant,O),Bc(h.participant,this._participants[L],O)}try{this.maybeParticipantTracksStopped(this._participants[L],h.participant),this.maybeParticipantTracksStarted(this._participants[L],h.participant),this.maybeEventRecordingStopped(this._participants[L],h.participant),this.maybeEventRecordingStarted(this._participants[L],h.participant)}catch(gi){console.error("track events error",gi)}this.compareEqualForParticipantUpdateEvent(h.participant,this._participants[L])||(this._participants[L]=Y({},h.participant),this.toggleParticipantAudioBasedOnNativeAudioFocus(),this.emitDailyJSEvent(h))}break;case Cl:if(h.participant&&h.participant.session_id){var U=this._participants[h.participant.session_id];U&&this.maybeParticipantTracksStopped(U,null),delete this._participants[h.participant.session_id],this.emitDailyJSEvent(h)}break;case Rl:Fe(this._participantCounts,h.participantCounts)||(this._participantCounts=h.participantCounts,this.emitDailyJSEvent(h));break;case Pl:var $={access:h.access};h.awaitingAccess&&($.awaitingAccess=h.awaitingAccess),Fe(this._accessState,$)||(this._accessState=$,this.emitDailyJSEvent(h));break;case Dl:if(h.meetingSession){this._meetingSessionSummary=h.meetingSession,this.emitDailyJSEvent(h);var H=Y(Y({},h),{},{action:"meeting-session-updated"});this.emitDailyJSEvent(H)}break;case vr:var re;this._iframe&&!h.preserveIframe&&(this._iframe.src=""),this._updateCallState(wt),this.resetMeetingDependentVars(),this._loadedCallback&&(this._loadedCallback(h.errorMsg),this._loadedCallback=null),h.preserveIframe;var le=Ra(h,Yp);le!=null&&(re=le.error)!==null&&re!==void 0&&re.details&&(le.error.details=JSON.parse(le.error.details)),this._maybeSendToSentry(h),this._joinedCallback&&(this._joinedCallback(null,le),this._joinedCallback=null),this.emitDailyJSEvent(le);break;case wl:this._callState!==wt&&this._updateCallState(Bt),this.resetMeetingDependentVars(),this._resolveLeave&&(this._resolveLeave(),this._resolveLeave=null),this.emitDailyJSEvent(h);break;case"selected-devices-updated":h.devices&&this.emitDailyJSEvent(h);break;case sc:var Ve=h.state,Yt=h.threshold,ce=h.quality,de=Ve.state,xe=Ve.reasons;de===this._network.networkState&&Fe(xe,this._network.networkStateReasons)&&Yt===this._network.threshold&&ce===this._network.quality||(this._network.networkState=de,this._network.networkStateReasons=xe,this._network.quality=ce,this._network.threshold=Yt,h.networkState=de,xe.length&&(h.networkStateReasons=xe),delete h.state,this.emitDailyJSEvent(h));break;case rc:h&&h.cpuLoadState&&this.emitDailyJSEvent(h);break;case ac:h&&h.faceCounts!==void 0&&this.emitDailyJSEvent(h);break;case tc:var Be=h.activeSpeaker;this._activeSpeaker.peerId!==Be.peerId&&(this._activeSpeaker.peerId=Be.peerId,this.emitDailyJSEvent({action:h.action,activeSpeaker:this._activeSpeaker}));break;case"show-local-video-changed":if(this._callObjectMode)return;var Pe=h.show;this._showLocalVideo=Pe,this.emitDailyJSEvent({action:h.action,show:Pe});break;case ic:var ht=h.enabled;this._activeSpeakerMode!==ht&&(this._activeSpeakerMode=ht,this.emitDailyJSEvent({action:h.action,enabled:this._activeSpeakerMode}));break;case Ml:case Fl:case Nl:this._waitingParticipants=h.allWaitingParticipants,this.emitDailyJSEvent({action:h.action,participant:h.participant});break;case hc:Fe(this._receiveSettings,h.receiveSettings)||(this._receiveSettings=h.receiveSettings,this.emitDailyJSEvent({action:h.action,receiveSettings:h.receiveSettings}));break;case gr:this._maybeUpdateInputSettings(h.inputSettings);break;case"send-settings-updated":Fe(this._sendSettings,h.sendSettings)||(this._sendSettings=h.sendSettings,this._preloadCache.sendSettings=null,this.emitDailyJSEvent({action:h.action,sendSettings:h.sendSettings}));break;case"local-audio-level":this._localAudioLevel=h.audioLevel,this._preloadCache.localAudioLevelObserver=null,this.emitDailyJSEvent(h);break;case"remote-participants-audio-level":this._remoteParticipantsAudioLevel=h.participantsAudioLevel,this._preloadCache.remoteParticipantsAudioLevelObserver=null,this.emitDailyJSEvent(h);break;case zl:var Je=h.session_id;this._rmpPlayerState[Je]=h.playerState,this.emitDailyJSEvent(h);break;case Ql:delete this._rmpPlayerState[h.session_id],this.emitDailyJSEvent(h);break;case Jl:var Wt=h.session_id,pi=this._rmpPlayerState[Wt];pi&&this.compareEqualForRMPUpdateEvent(pi,h.remoteMediaPlayerState)||(this._rmpPlayerState[Wt]=h.remoteMediaPlayerState,this.emitDailyJSEvent(h));break;case"custom-button-click":case"sidebar-view-changed":this.emitDailyJSEvent(h);break;case Ol:var In=this._meetingSessionState.topology!==(h.meetingSessionState&&h.meetingSessionState.topology);this._meetingSessionState=Fr(h.meetingSessionState,this._callObjectMode),(this._callObjectMode||In)&&this.emitDailyJSEvent(h);break;case Xl:this._isScreenSharing=!0,this.emitDailyJSEvent(h);break;case Zl:case ec:this._isScreenSharing=!1,this.emitDailyJSEvent(h);break;case fr:case pr:case Vl:case ql:case Kl:case $l:case jl:case Gl:case _l:case xl:case Yl:case Wl:case"test-completed":case nc:case Hl:case oc:case lc:case cc:case uc:case mr:case dc:case"dialin-ready":case"dialin-connected":case"dialin-error":case"dialin-stopped":case"dialin-warning":case"dialout-connected":case"dialout-answered":case"dialout-error":case"dialout-stopped":case"dialout-warning":this.emitDailyJSEvent(h);break;case"request-fullscreen":this.requestFullscreen();break;case"request-exit-fullscreen":this.exitFullscreen()}}},{key:"maybeEventRecordingStopped",value:function(h,y){var m="record";h&&(y.local||y[m]!==!1||h[m]===y[m]||this.emitDailyJSEvent({action:pr}))}},{key:"maybeEventRecordingStarted",value:function(h,y){var m="record";h&&(y.local||y[m]!==!0||h[m]===y[m]||this.emitDailyJSEvent({action:fr}))}},{key:"_trackStatePlayable",value:function(h){return!(!h||h.state!==fl)}},{key:"_trackChanged",value:function(h,y){return(h==null?void 0:h.id)!==(y==null?void 0:y.id)}},{key:"maybeEventTrackStopped",value:function(h,y,m){var x,L,O=(x=y==null?void 0:y.tracks[h])!==null&&x!==void 0?x:null,U=(L=m==null?void 0:m.tracks[h])!==null&&L!==void 0?L:null,$=O==null?void 0:O.track;if($){var H=this._trackStatePlayable(O),re=this._trackStatePlayable(U),le=this._trackChanged($,U==null?void 0:U.track);H&&(re&&!le||this.emitDailyJSEvent({action:Bl,track:$,participant:m??y,type:h}))}}},{key:"maybeEventTrackStarted",value:function(h,y,m){var x,L,O=(x=y==null?void 0:y.tracks[h])!==null&&x!==void 0?x:null,U=(L=m==null?void 0:m.tracks[h])!==null&&L!==void 0?L:null,$=U==null?void 0:U.track;if($){var H=this._trackStatePlayable(O),re=this._trackStatePlayable(U),le=this._trackChanged(O==null?void 0:O.track,$);re&&(H&&!le||this.emitDailyJSEvent({action:Ul,track:$,participant:m,type:h}))}}},{key:"maybeParticipantTracksStopped",value:function(h,y){if(h)for(var m in h.tracks)this.maybeEventTrackStopped(m,h,y)}},{key:"maybeParticipantTracksStarted",value:function(h,y){if(y)for(var m in y.tracks)this.maybeEventTrackStarted(m,h,y)}},{key:"compareEqualForRMPUpdateEvent",value:function(h,y){var m,x;return h.state===y.state&&((m=h.settings)===null||m===void 0?void 0:m.volume)===((x=y.settings)===null||x===void 0?void 0:x.volume)}},{key:"emitDailyJSEvent",value:function(h){try{h.callClientId=this.callClientId,this.emit(h.action,h)}catch(y){console.log("could not emit",h,y)}}},{key:"compareEqualForParticipantUpdateEvent",value:function(h,y){return!!Fe(h,y)&&(!h.videoTrack||!y.videoTrack||h.videoTrack.id===y.videoTrack.id&&h.videoTrack.muted===y.videoTrack.muted&&h.videoTrack.enabled===y.videoTrack.enabled)&&(!h.audioTrack||!y.audioTrack||h.audioTrack.id===y.audioTrack.id&&h.audioTrack.muted===y.audioTrack.muted&&h.audioTrack.enabled===y.audioTrack.enabled)}},{key:"nativeUtils",value:function(){return he()?typeof DailyNativeUtils>"u"?(console.warn("in React Native, DailyNativeUtils is expected to be available"),null):DailyNativeUtils:null}},{key:"updateIsPreparingToJoin",value:function(h){this._updateCallState(this._callState,h)}},{key:"_updateCallState",value:function(h){var y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this._isPreparingToJoin;if(h!==this._callState||y!==this._isPreparingToJoin){var m=this._callState,x=this._isPreparingToJoin;this._callState=h,this._isPreparingToJoin=y;var L=this._callState===Ut;this.updateShowAndroidOngoingMeetingNotification(L);var O=qs(m,x),U=qs(this._callState,this._isPreparingToJoin);O!==U&&(this.updateKeepDeviceAwake(U),this.updateDeviceAudioMode(U),this.updateNoOpRecordingEnsuringBackgroundContinuity(U))}}},{key:"resetMeetingDependentVars",value:function(){this._participants={},this._participantCounts=Zc,this._waitingParticipants={},this._activeSpeaker={},this._activeSpeakerMode=!1,this._didPreAuth=!1,this._accessState={access:Fs},this._finalSummaryOfPrevSession=this._meetingSessionSummary,this._meetingSessionSummary={},this._meetingSessionState=Fr(Xc,this._callObjectMode),this._isScreenSharing=!1,this._receiveSettings={},this._inputSettings=void 0,this._sendSettings={},this._localAudioLevel=0,this._isLocalAudioLevelObserverRunning=!1,this._remoteParticipantsAudioLevel={},this._isRemoteParticipantsAudioLevelObserverRunning=!1,this._maxAppMessageSize=yr,this._callMachineInitialized=!1,this._bundleLoadTime=void 0,this._preloadCache}},{key:"updateKeepDeviceAwake",value:function(h){he()&&this.nativeUtils().setKeepDeviceAwake(h,this.callClientId)}},{key:"updateDeviceAudioMode",value:function(h){if(he()&&!this.disableReactNativeAutoDeviceManagement("audio")){var y=h?this._nativeInCallAudioMode:"idle";this.nativeUtils().setAudioMode(y)}}},{key:"updateShowAndroidOngoingMeetingNotification",value:function(h){if(he()&&this.nativeUtils().setShowOngoingMeetingNotification){var y,m,x,L;if(this.properties.reactNativeConfig&&this.properties.reactNativeConfig.androidInCallNotification){var O=this.properties.reactNativeConfig.androidInCallNotification;y=O.title,m=O.subtitle,x=O.iconName,L=O.disableForCustomOverride}L&&(h=!1),this.nativeUtils().setShowOngoingMeetingNotification(h,y,m,x,this.callClientId)}}},{key:"updateNoOpRecordingEnsuringBackgroundContinuity",value:function(h){he()&&this.nativeUtils().enableNoOpRecordingEnsuringBackgroundContinuity&&this.nativeUtils().enableNoOpRecordingEnsuringBackgroundContinuity(h)}},{key:"toggleParticipantAudioBasedOnNativeAudioFocus",value:function(){var h;if(he()){var y=(h=this._callMachine())===null||h===void 0||(h=h.store)===null||h===void 0?void 0:h.getState();for(var m in y==null?void 0:y.streams){var x=y.streams[m];x&&x.pendingTrack&&x.pendingTrack.kind==="audio"&&(x.pendingTrack.enabled=this._hasNativeAudioFocus)}}}},{key:"disableReactNativeAutoDeviceManagement",value:function(h){return this.properties.reactNativeConfig&&this.properties.reactNativeConfig.disableAutoDeviceManagement&&this.properties.reactNativeConfig.disableAutoDeviceManagement[h]}},{key:"absoluteUrl",value:function(h){if(h!==void 0){var y=document.createElement("a");return y.href=h,y.href}}},{key:"sayHello",value:function(){var h="hello, world.";return console.log(h),h}},{key:"_logUseAfterDestroy",value:function(){var h=Object.values(oi)[0];if(this.needsLoad())if(h&&!h.needsLoad()){var y={action:Ns,level:"error",code:this.strictMode?9995:9997};h.sendMessageToCallMachine(y)}else this.strictMode||console.error("You are are attempting to use a call instance that was previously destroyed, which is unsupported. Please remove `strictMode: false` from your constructor properties to enable strict mode to track down and fix this unsupported usage.");else{var m={action:Ns,level:"error",code:this.strictMode?9995:9997};this._messageChannel.sendMessageToCallMachine(m,null,this.callClientId,this._iframe)}}},{key:"_logDuplicateInstanceAttempt",value:function(){for(var h=0,y=Object.values(oi);h<y.length;h++){var m=y[h];m._callMachineInitialized?(m.sendMessageToCallMachine({action:Ns,level:"warn",code:this.allowMultipleCallInstances?9993:9992}),m._delayDuplicateInstanceLog=!1):m._delayDuplicateInstanceLog=!0}}},{key:"_maybeSendToSentry",value:function(h){var y,m,x,L;if(!((y=h.error)!==null&&y!==void 0&&y.type&&(![vl,ml,dr].includes(h.error.type)||h.error.type===dr&&h.error.msg.includes("deleted")))){var O=(m=this.properties)!==null&&m!==void 0&&m.url?new URL(this.properties.url):void 0,U="production";O&&O.host.includes(".staging.daily")&&(U="staging");var $,H,re,le,Ve,Yt=function(Je){const Wt=[gf(),ff(),jf(),Bf(),Hf(),Wf(),Sf(),Yf()];return Je.autoSessionTracking!==!1&&Wt.push(Kf()),Wt}({}).filter(function(Je){return!["BrowserApiErrors","Breadcrumbs","GlobalHandlers"].includes(Je.name)}),ce=new wf({dsn:"https://f10f1c81e5d44a4098416c0867a8b740@o77906.ingest.sentry.io/168844",transport:Pf,stackParser:Uf,integrations:Yt,environment:U}),de=new Nt;if(de.setClient(ce),ce.init(),this.session_id&&de.setExtra("sessionId",this.session_id),this.properties){var xe=Y({},this.properties);xe.userName=xe.userName?"[Filtered]":void 0,xe.userData=xe.userData?"[Filtered]":void 0,xe.token=xe.token?"[Filtered]":void 0,de.setExtra("properties",xe)}if(O){var Be=O.searchParams.get("domain");if(!Be){var Pe=O.host.match(/(.*?)\./);Be=Pe&&Pe[1]||""}Be&&de.setTag("domain",Be)}h.error&&(de.setTag("fatalErrorType",h.error.type),de.setExtra("errorDetails",h.error.details),!(($=h.error.details)===null||$===void 0)&&$.uri&&de.setTag("serverAddress",h.error.details.uri),!((H=h.error.details)===null||H===void 0)&&H.workerGroup&&de.setTag("workerGroup",h.error.details.workerGroup),!((re=h.error.details)===null||re===void 0)&&re.geoGroup&&de.setTag("geoGroup",h.error.details.geoGroup),!((le=h.error.details)===null||le===void 0)&&le.on&&de.setTag("connectionAttempt",h.error.details.on),(Ve=h.error.details)!==null&&Ve!==void 0&&Ve.bundleUrl&&(de.setTag("bundleUrl",h.error.details.bundleUrl),de.setTag("bundleError",h.error.details.sourceError.type))),de.setTags({callMode:this._callObjectMode?he()?"reactNative":(x=this.properties)!==null&&x!==void 0&&(x=x.dailyConfig)!==null&&x!==void 0&&(x=x.callMode)!==null&&x!==void 0&&x.includes("prebuilt")?this.properties.dailyConfig.callMode:"custom":"prebuilt-frame",version:s.version()});var ht=((L=h.error)===null||L===void 0?void 0:L.msg)||h.errorMsg;de.captureException(new Error(ht))}}},{key:"_callMachine",value:function(){var h;return(h=window._daily)===null||h===void 0||(h=h.instances)===null||h===void 0||(h=h[this.callClientId])===null||h===void 0?void 0:h.callMachine}},{key:"_maybeUpdateInputSettings",value:function(h){if(!Fe(this._inputSettings,h)){var y=this._getInputSettings();this._inputSettings=h;var m=this._getInputSettings();Fe(y,m)||this.emitDailyJSEvent({action:gr,inputSettings:m})}}}],[{key:"supportedBrowser",value:function(){if(he())return{supported:!0,mobile:!0,name:"React Native",version:null,supportsScreenShare:!0,supportsSfu:!0,supportsVideoProcessing:!1,supportsAudioProcessing:!1};var h=Oh.getParser(et());return{supported:!!Tc(),mobile:h.getPlatformType()==="mobile",name:h.getBrowserName(),version:h.getBrowserVersion(),supportsFullscreen:!!Sc(),supportsScreenShare:!!bp(),supportsSfu:!!Tc(),supportsVideoProcessing:Ec(),supportsAudioProcessing:bc()}}},{key:"version",value:function(){return"0.79.0"}},{key:"createCallObject",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return h.layout="none",new s(null,h)}},{key:"wrap",value:function(h){var y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(ue(),!h||!h.contentWindow||typeof h.src!="string")throw new Error("DailyIframe::Wrap needs an iframe-like first argument");return y.layout||(y.customLayout?y.layout="custom-v1":y.layout="browser"),new s(h,y)}},{key:"createFrame",value:function(h,y){var m,x;ue(),h&&y?(m=h,x=y):h&&h.append?(m=h,x={}):(m=document.body,x=h||{});var L=x.iframeStyle;L||(L=m===document.body?{position:"fixed",border:"1px solid black",backgroundColor:"white",width:"375px",height:"450px",right:"1em",bottom:"1em"}:{border:0,width:"100%",height:"100%"});var O=document.createElement("iframe");window.navigator&&window.navigator.userAgent.match(/Chrome\/61\./)?O.allow="microphone, camera":O.allow="microphone; camera; autoplay; display-capture; screen-wake-lock",O.style.visibility="hidden",m.appendChild(O),O.style.visibility=null,Object.keys(L).forEach(function(U){return O.style[U]=L[U]}),x.layout||(x.customLayout?x.layout="custom-v1":x.layout="browser");try{return new s(O,x)}catch(U){throw m.removeChild(O),U}}},{key:"createTransparentFrame",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};ue();var y=document.createElement("iframe");return y.allow="microphone; camera; autoplay",y.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
      pointer-events: none;
    `,document.body.appendChild(y),h.layout||(h.layout="custom-v1"),s.wrap(y,h)}},{key:"getCallInstance",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:void 0;return h?oi[h]:Object.values(oi)[0]}}]);var e,t,i,n,r,a,o,l,c,u,d,f,g,p,v,S,b,I,w,_,T,C,A,k,D,R,N,V,W,q,ee,z,K,pe,G,B,ie,X}();function Ii(s,e){var t={};for(var i in s)if(s[i]instanceof MediaStreamTrack)console.warn("MediaStreamTrack found in props or cache.",i),t[i]=Lt;else if(i==="dailyConfig"){if(s[i].modifyLocalSdpHook){var n=window._daily.instances[e].customCallbacks||{};n.modifyLocalSdpHook=s[i].modifyLocalSdpHook,window._daily.instances[e].customCallbacks=n,delete s[i].modifyLocalSdpHook}if(s[i].modifyRemoteSdpHook){var r=window._daily.instances[e].customCallbacks||{};r.modifyRemoteSdpHook=s[i].modifyRemoteSdpHook,window._daily.instances[e].customCallbacks=r,delete s[i].modifyRemoteSdpHook}t[i]=s[i]}else t[i]=s[i];return t}function Ee(s){var e=arguments.length>2?arguments[2]:void 0;if(s!==Ut){var t="".concat(arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method"," only supported after join.");throw e&&(t+=" ".concat(e)),console.error(t),new Error(t)}}function qs(s,e){return[Ms,Ut].includes(s)||e}function Dr(s,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"This daily-js method",i=arguments.length>3?arguments[3]:void 0;if(qs(s,e)){var n="".concat(t," not supported after joining a meeting.");throw i&&(n+=" ".concat(i)),console.error(n),new Error(n)}}function Ks(s){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method",t=arguments.length>2?arguments[2]:void 0;if(!s){var i="".concat(e,arguments.length>3&&arguments[3]!==void 0&&arguments[3]?" requires preAuth() or startCamera() to initialize call state.":" requires preAuth(), startCamera(), or join() to initialize call state.");throw t&&(i+=" ".concat(t)),console.error(i),new Error(i)}}function Or(s){if(s){var e="A pre-call quality test is in progress. Please try ".concat(arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method"," again once testing has completed. Use stopTestCallQuality() to end it early.");throw console.error(e),new Error(e)}}function ct(s){if(!s){var e="".concat(arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method"," is only supported on custom callObject instances");throw console.error(e),new Error(e)}}function Ye(s){if(s){var e="".concat(arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method"," is only supported as part of Daily's Prebuilt");throw console.error(e),new Error(e)}}function ue(){if(he())throw new Error("This daily-js method is not currently supported in React Native")}function Ji(){if(!he())throw new Error("This daily-js method is only supported in React Native")}function su(s){if(s===void 0)return!0;var e;if(typeof s=="string")e=s;else try{e=JSON.stringify(s),Fe(JSON.parse(e),s)||console.warn("The userData provided will be modified when serialized.")}catch(t){throw Error("userData must be serializable to JSON: ".concat(t))}if(e.length>4096)throw Error("userData is too large (".concat(e.length," characters). Maximum size suppported is ").concat(4096,"."));return!0}function nu(s,e){for(var t=e.allowAllParticipantsKey,i=function(d){var f=["local"];return t||f.push("*"),d&&!f.includes(d)},n=function(d){return!!(d.layer===void 0||Number.isInteger(d.layer)&&d.layer>=0||d.layer==="inherit")},r=function(d){return!!d&&!(d.video&&!n(d.video))&&!(d.screenVideo&&!n(d.screenVideo))},a=0,o=Object.entries(s);a<o.length;a++){var l=Me(o[a],2),c=l[0],u=l[1];if(!i(c)||!r(u))return!1}return!0}function ru(s){if(fe(s)!=="object")return!1;for(var e=0,t=Object.entries(s);e<t.length;e++){var i=Me(t[e],2),n=i[0],r=i[1];switch(n){case"video":if(fe(r)!=="object")return!1;for(var a=0,o=Object.entries(r);a<o.length;a++){var l=Me(o[a],2),c=l[0],u=l[1];switch(c){case"processor":if(!Qp(u))return!1;break;case"settings":if(!ou(u))return!1;break;default:return!1}}break;case"audio":if(fe(r)!=="object")return!1;for(var d=0,f=Object.entries(r);d<f.length;d++){var g=Me(f[d],2),p=g[0],v=g[1];switch(p){case"processor":if(!Jp(v))return!1;break;case"settings":if(!ou(v))return!1;break;default:return!1}}break;default:return!1}}return!0}function au(s,e,t){var i,n=[];s.video&&s.video.processor&&(Ec((i=e==null?void 0:e.useLegacyVideoProcessor)!==null&&i!==void 0&&i)||(s.video.settings?delete s.video.processor:delete s.video,n.push("video"))),s.audio&&s.audio.processor&&(bc()||(s.audio.settings?delete s.audio.processor:delete s.audio,n.push("audio"))),n.length>0&&console.error("Ignoring settings for browser- or platform-unsupported input processor(s): ".concat(n.join(", "))),s.audio&&s.audio.settings&&(s.audio.settings.customTrack?(t.audioTrack=s.audio.settings.customTrack,s.audio.settings={customTrack:Lt}):delete t.audioTrack),s.video&&s.video.settings&&(s.video.settings.customTrack?(t.videoTrack=s.video.settings.customTrack,s.video.settings={customTrack:Lt}):delete t.videoTrack)}function Jp(s){if(he())return console.warn("Video processing is not yet supported in React Native"),!1;var e=["type"];return!!s&&fe(s)==="object"&&(Object.keys(s).filter(function(t){return!e.includes(t)}).forEach(function(t){console.warn("invalid key inputSettings -> audio -> processor : ".concat(t)),delete s[t]}),!!function(t){return typeof t!="string"?!1:Object.values(mc).includes(t)?!0:(console.error("inputSettings audio processor type invalid"),!1)}(s.type))}function Qp(s){if(he())return console.warn("Video processing is not yet supported in React Native"),!1;var e=["type","config"];return!s||fe(s)!=="object"||!function(t){return typeof t!="string"?!1:Object.values(Us).includes(t)?!0:(console.error("inputSettings video processor type invalid"),!1)}(s.type)||s.config&&(fe(s.config)!=="object"||!function(t,i){var n=Object.keys(i);if(n.length===0)return!0;var r="invalid object in inputSettings -> video -> processor -> config";switch(t){case Us.BGBLUR:return n.length>1||n[0]!=="strength"?(console.error(r),!1):!(typeof i.strength!="number"||i.strength<=0||i.strength>1||isNaN(i.strength))||(console.error("".concat(r,"; expected: {0 < strength <= 1}, got: ").concat(i.strength)),!1);case Us.BGIMAGE:return!(i.source!==void 0&&!function(a){if(a.source==="default")return a.type="default",!0;if(a.source instanceof ArrayBuffer)return!0;if(ms(a.source))return a.type="url",!!function(c){var u=new URL(c),d=u.pathname;if(u.protocol==="data:")try{var f=d.substring(d.indexOf(":")+1,d.indexOf(";")).split("/")[1];return br.includes(f)}catch(p){return console.error("failed to deduce blob content type",p),!1}var g=d.split(".").at(-1).toLowerCase().trim();return br.includes(g)}(a.source)||(console.error("invalid image type; supported types: [".concat(br.join(", "),"]")),!1);return o=a.source,l=Number(o),isNaN(l)||!Number.isInteger(l)||l<=0||l>10?(console.error("invalid image selection; must be an int, > 0, <= ".concat(10)),!1):(a.type="daily-preselect",!0);var o,l}(i));default:return!0}}(s.type,s.config))?!1:(Object.keys(s).filter(function(t){return!e.includes(t)}).forEach(function(t){console.warn("invalid key inputSettings -> video -> processor : ".concat(t)),delete s[t]}),!0)}function ou(s){return fe(s)==="object"&&(!s.customTrack||s.customTrack instanceof MediaStreamTrack)}function Mr(){var s=Object.values(Us).join(" | "),e=Object.values(mc).join(" | ");return"inputSettings must be of the form: { video?: { processor?: { type: [ ".concat(s," ], config?: {} } }, audio?: { processor: {type: [ ").concat(e," ] } } }")}function lu(s){var e=s.allowAllParticipantsKey;return"receiveSettings must be of the form { [<remote participant id> | ".concat(gl).concat(e?' | "'.concat("*",'"'):"","]: ")+'{ [video: [{ layer: [<non-negative integer> | "inherit"] } | "inherit"]], [screenVideo: [{ layer: [<non-negative integer> | "inherit"] } | "inherit"]] }}}'}function cu(){return"customIntegrations should be an object of type ".concat(JSON.stringify(Pr),".")}function uu(s){if(s&&fe(s)!=="object"||Array.isArray(s))return console.error("customTrayButtons should be an Object of the type ".concat(JSON.stringify(Gs),".")),!1;if(s)for(var e=0,t=Object.entries(s);e<t.length;e++)for(var i=Me(t[e],1)[0],n=0,r=Object.entries(s[i]);n<r.length;n++){var a=Me(r[n],2),o=a[0],l=a[1],c=Gs.id[o];if(!c)return console.error("customTrayButton does not support key ".concat(o)),!1;switch(o){case"iconPath":case"iconPathDarkMode":if(!ms(l))return console.error("customTrayButton ".concat(o," should be a url.")),!1;break;case"visualState":if(!["default","sidebar-open","active"].includes(l))return console.error("customTrayButton ".concat(o," should be ").concat(c,". Got: ").concat(l)),!1;break;default:if(fe(l)!==c)return console.error("customTrayButton ".concat(o," should be a ").concat(c,".")),!1}}return!0}function du(s){if(!s||s&&fe(s)!=="object"||Array.isArray(s))return console.error(cu()),!1;for(var e=function(d){return"".concat(d," should be ").concat(Pr.id[d])},t=function(d,f){return console.error("customIntegration ".concat(d,": ").concat(f))},i=0,n=Object.entries(s);i<n.length;i++){var r=Me(n[i],1)[0];if(!("label"in s[r]))return t(r,"label is required"),!1;if(!("location"in s[r]))return t(r,"location is required"),!1;if(!("src"in s[r])&&!("srcdoc"in s[r]))return t(r,"src or srcdoc is required"),!1;for(var a=0,o=Object.entries(s[r]);a<o.length;a++){var l=Me(o[a],2),c=l[0],u=l[1];switch(c){case"allow":case"csp":case"name":case"referrerPolicy":case"sandbox":if(typeof u!="string")return t(r,e(c)),!1;break;case"iconURL":if(!ms(u))return t(r,"".concat(c," should be a url")),!1;break;case"src":if("srcdoc"in s[r])return t(r,"cannot have both src and srcdoc"),!1;if(!ms(u))return t(r,'src "'.concat(u,'" is not a valid URL')),!1;break;case"srcdoc":if("src"in s[r])return t(r,"cannot have both src and srcdoc"),!1;if(typeof u!="string")return t(r,e(c)),!1;break;case"location":if(!["main","sidebar"].includes(u))return t(r,e(c)),!1;break;case"controlledBy":if(u!=="*"&&u!=="owners"&&(!Array.isArray(u)||u.some(function(d){return typeof d!="string"})))return t(r,e(c)),!1;break;case"shared":if((!Array.isArray(u)||u.some(function(d){return typeof d!="string"}))&&u!=="owners"&&typeof u!="boolean")return t(r,e(c)),!1;break;default:if(!Pr.id[c])return console.error("customIntegration does not support key ".concat(c)),!1}}}return!0}function hu(s,e){if(e===void 0)return!1;switch(fe(e)){case"string":return fe(s)===e;case"object":if(fe(s)!=="object")return!1;for(var t in s)if(!hu(s[t],e[t]))return!1;return!0;default:return!1}}function fu(s,e){var t=s.sessionId,i=s.toEndPoint,n=s.callerId,r=s.useSipRefer;if(!t||!i)throw new Error("".concat(e,"() requires a sessionId and toEndPoint"));if(typeof t!="string"||typeof i!="string")throw new Error("Invalid paramater: sessionId and toEndPoint must be of type string");if(r&&!i.startsWith("sip:"))throw new Error('"toEndPoint" must be a "sip" address');if(!i.startsWith("sip:")&&!i.startsWith("+"))throw new Error("toEndPoint: ".concat(i,' must starts with either "sip:" or "+"'));if(n&&typeof n!="string")throw new Error("callerId must be of type string");if(n&&!i.startsWith("+"))throw new Error("callerId is only valid when transferring to a PSTN number")}function pu(s){if(fe(s)!=="object")throw new Error('RemoteMediaPlayerSettings: must be "object" type');if(s.state&&!Object.values(Er).includes(s.state))throw new Error("Invalid value for RemoteMediaPlayerSettings.state, valid values are: "+JSON.stringify(Er));if(s.volume){if(typeof s.volume!="number")throw new Error('RemoteMediaPlayerSettings.volume: must be "number" type');if(s.volume<0||s.volume>2)throw new Error("RemoteMediaPlayerSettings.volume: must be between 0.0 - 2.0")}}function gu(s,e,t){return!(typeof s!="number"||s<e||s>t)}function Fr(s,e){return s&&!e&&delete s.data,s}const Xp=Tt(Object.freeze(Object.defineProperty({__proto__:null,DAILY_ACCESS_LEVEL_FULL:pl,DAILY_ACCESS_LEVEL_LOBBY:ep,DAILY_ACCESS_LEVEL_NONE:tp,DAILY_ACCESS_UNKNOWN:Fs,DAILY_CAMERA_ERROR_CAM_AND_MIC_IN_USE:hp,DAILY_CAMERA_ERROR_CAM_IN_USE:up,DAILY_CAMERA_ERROR_CONSTRAINTS:mp,DAILY_CAMERA_ERROR_MIC_IN_USE:dp,DAILY_CAMERA_ERROR_NOT_FOUND:gp,DAILY_CAMERA_ERROR_PERMISSIONS:fp,DAILY_CAMERA_ERROR_UNDEF_MEDIADEVICES:pp,DAILY_CAMERA_ERROR_UNKNOWN:vp,DAILY_EVENT_ACCESS_STATE_UPDATED:Pl,DAILY_EVENT_ACTIVE_SPEAKER_CHANGE:tc,DAILY_EVENT_ACTIVE_SPEAKER_MODE_CHANGE:ic,DAILY_EVENT_APP_MSG:Yl,DAILY_EVENT_CAMERA_ERROR:xl,DAILY_EVENT_CPU_LOAD_CHANGE:rc,DAILY_EVENT_ERROR:vr,DAILY_EVENT_EXIT_FULLSCREEN:Hi,DAILY_EVENT_FACE_COUNTS_UPDATED:ac,DAILY_EVENT_FULLSCREEN:Ki,DAILY_EVENT_IFRAME_LAUNCH_CONFIG:Sl,DAILY_EVENT_IFRAME_READY_FOR_LAUNCH_CONFIG:yl,DAILY_EVENT_INPUT_SETTINGS_UPDATED:gr,DAILY_EVENT_JOINED_MEETING:Il,DAILY_EVENT_JOINING_MEETING:Al,DAILY_EVENT_LANG_UPDATED:dc,DAILY_EVENT_LEFT_MEETING:wl,DAILY_EVENT_LIVE_STREAMING_ERROR:uc,DAILY_EVENT_LIVE_STREAMING_STARTED:oc,DAILY_EVENT_LIVE_STREAMING_STOPPED:cc,DAILY_EVENT_LIVE_STREAMING_UPDATED:lc,DAILY_EVENT_LOADED:hr,DAILY_EVENT_LOADING:bl,DAILY_EVENT_LOAD_ATTEMPT_FAILED:Tl,DAILY_EVENT_LOCAL_SCREEN_SHARE_CANCELED:ec,DAILY_EVENT_LOCAL_SCREEN_SHARE_STARTED:Xl,DAILY_EVENT_LOCAL_SCREEN_SHARE_STOPPED:Zl,DAILY_EVENT_MEETING_SESSION_DATA_ERROR:yp,DAILY_EVENT_MEETING_SESSION_STATE_UPDATED:Ol,DAILY_EVENT_MEETING_SESSION_SUMMARY_UPDATED:Dl,DAILY_EVENT_NETWORK_CONNECTION:nc,DAILY_EVENT_NETWORK_QUALITY_CHANGE:sc,DAILY_EVENT_NONFATAL_ERROR:mr,DAILY_EVENT_PARTICIPANT_COUNTS_UPDATED:Rl,DAILY_EVENT_PARTICIPANT_JOINED:Ll,DAILY_EVENT_PARTICIPANT_LEFT:Cl,DAILY_EVENT_PARTICIPANT_UPDATED:kl,DAILY_EVENT_RECEIVE_SETTINGS_UPDATED:hc,DAILY_EVENT_RECORDING_DATA:Hl,DAILY_EVENT_RECORDING_ERROR:ql,DAILY_EVENT_RECORDING_STARTED:fr,DAILY_EVENT_RECORDING_STATS:Vl,DAILY_EVENT_RECORDING_STOPPED:pr,DAILY_EVENT_RECORDING_UPLOAD_COMPLETED:Kl,DAILY_EVENT_REMOTE_MEDIA_PLAYER_STARTED:zl,DAILY_EVENT_REMOTE_MEDIA_PLAYER_STOPPED:Ql,DAILY_EVENT_REMOTE_MEDIA_PLAYER_UPDATED:Jl,DAILY_EVENT_STARTED_CAMERA:_l,DAILY_EVENT_THEME_UPDATED:El,DAILY_EVENT_TRACK_STARTED:Ul,DAILY_EVENT_TRACK_STOPPED:Bl,DAILY_EVENT_TRANSCRIPTION_ERROR:Gl,DAILY_EVENT_TRANSCRIPTION_MSG:Wl,DAILY_EVENT_TRANSCRIPTION_STARTED:$l,DAILY_EVENT_TRANSCRIPTION_STOPPED:jl,DAILY_EVENT_WAITING_PARTICIPANT_ADDED:Ml,DAILY_EVENT_WAITING_PARTICIPANT_REMOVED:Nl,DAILY_EVENT_WAITING_PARTICIPANT_UPDATED:Fl,DAILY_FATAL_ERROR_CONNECTION:vl,DAILY_FATAL_ERROR_EJECTED:sp,DAILY_FATAL_ERROR_EOL:ml,DAILY_FATAL_ERROR_EXP_ROOM:ap,DAILY_FATAL_ERROR_EXP_TOKEN:op,DAILY_FATAL_ERROR_MEETING_FULL:lp,DAILY_FATAL_ERROR_NBF_ROOM:np,DAILY_FATAL_ERROR_NBF_TOKEN:rp,DAILY_FATAL_ERROR_NOT_ALLOWED:cp,DAILY_FATAL_ERROR_NO_ROOM:dr,DAILY_RECEIVE_SETTINGS_ALL_PARTICIPANTS_KEY:ip,DAILY_RECEIVE_SETTINGS_BASE_KEY:gl,DAILY_STATE_ERROR:wt,DAILY_STATE_JOINED:Ut,DAILY_STATE_JOINING:Ms,DAILY_STATE_LEFT:Bt,DAILY_STATE_NEW:ur,DAILY_TRACK_STATE_BLOCKED:zf,DAILY_TRACK_STATE_INTERRUPTED:Zf,DAILY_TRACK_STATE_LOADING:Xf,DAILY_TRACK_STATE_OFF:Jf,DAILY_TRACK_STATE_PLAYABLE:fl,DAILY_TRACK_STATE_SENDABLE:Qf,default:zp},Symbol.toStringTag,{value:"Module"})));var Hs={exports:{}},mu;function Zp(){if(mu)return Hs.exports;mu=1;var s=typeof Reflect=="object"?Reflect:null,e=s&&typeof s.apply=="function"?s.apply:function(T,C,A){return Function.prototype.apply.call(T,C,A)},t;s&&typeof s.ownKeys=="function"?t=s.ownKeys:Object.getOwnPropertySymbols?t=function(T){return Object.getOwnPropertyNames(T).concat(Object.getOwnPropertySymbols(T))}:t=function(T){return Object.getOwnPropertyNames(T)};function i(_){console&&console.warn&&console.warn(_)}var n=Number.isNaN||function(T){return T!==T};function r(){r.init.call(this)}Hs.exports=r,Hs.exports.once=b,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._eventsCount=0,r.prototype._maxListeners=void 0;var a=10;function o(_){if(typeof _!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof _)}Object.defineProperty(r,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(_){if(typeof _!="number"||_<0||n(_))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+_+".");a=_}}),r.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},r.prototype.setMaxListeners=function(T){if(typeof T!="number"||T<0||n(T))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+T+".");return this._maxListeners=T,this};function l(_){return _._maxListeners===void 0?r.defaultMaxListeners:_._maxListeners}r.prototype.getMaxListeners=function(){return l(this)},r.prototype.emit=function(T){for(var C=[],A=1;A<arguments.length;A++)C.push(arguments[A]);var k=T==="error",D=this._events;if(D!==void 0)k=k&&D.error===void 0;else if(!k)return!1;if(k){var R;if(C.length>0&&(R=C[0]),R instanceof Error)throw R;var N=new Error("Unhandled error."+(R?" ("+R.message+")":""));throw N.context=R,N}var V=D[T];if(V===void 0)return!1;if(typeof V=="function")e(V,this,C);else for(var W=V.length,q=p(V,W),A=0;A<W;++A)e(q[A],this,C);return!0};function c(_,T,C,A){var k,D,R;if(o(C),D=_._events,D===void 0?(D=_._events=Object.create(null),_._eventsCount=0):(D.newListener!==void 0&&(_.emit("newListener",T,C.listener?C.listener:C),D=_._events),R=D[T]),R===void 0)R=D[T]=C,++_._eventsCount;else if(typeof R=="function"?R=D[T]=A?[C,R]:[R,C]:A?R.unshift(C):R.push(C),k=l(_),k>0&&R.length>k&&!R.warned){R.warned=!0;var N=new Error("Possible EventEmitter memory leak detected. "+R.length+" "+String(T)+" listeners added. Use emitter.setMaxListeners() to increase limit");N.name="MaxListenersExceededWarning",N.emitter=_,N.type=T,N.count=R.length,i(N)}return _}r.prototype.addListener=function(T,C){return c(this,T,C,!1)},r.prototype.on=r.prototype.addListener,r.prototype.prependListener=function(T,C){return c(this,T,C,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(_,T,C){var A={fired:!1,wrapFn:void 0,target:_,type:T,listener:C},k=u.bind(A);return k.listener=C,A.wrapFn=k,k}r.prototype.once=function(T,C){return o(C),this.on(T,d(this,T,C)),this},r.prototype.prependOnceListener=function(T,C){return o(C),this.prependListener(T,d(this,T,C)),this},r.prototype.removeListener=function(T,C){var A,k,D,R,N;if(o(C),k=this._events,k===void 0)return this;if(A=k[T],A===void 0)return this;if(A===C||A.listener===C)--this._eventsCount===0?this._events=Object.create(null):(delete k[T],k.removeListener&&this.emit("removeListener",T,A.listener||C));else if(typeof A!="function"){for(D=-1,R=A.length-1;R>=0;R--)if(A[R]===C||A[R].listener===C){N=A[R].listener,D=R;break}if(D<0)return this;D===0?A.shift():v(A,D),A.length===1&&(k[T]=A[0]),k.removeListener!==void 0&&this.emit("removeListener",T,N||C)}return this},r.prototype.off=r.prototype.removeListener,r.prototype.removeAllListeners=function(T){var C,A,k;if(A=this._events,A===void 0)return this;if(A.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):A[T]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete A[T]),this;if(arguments.length===0){var D=Object.keys(A),R;for(k=0;k<D.length;++k)R=D[k],R!=="removeListener"&&this.removeAllListeners(R);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(C=A[T],typeof C=="function")this.removeListener(T,C);else if(C!==void 0)for(k=C.length-1;k>=0;k--)this.removeListener(T,C[k]);return this};function f(_,T,C){var A=_._events;if(A===void 0)return[];var k=A[T];return k===void 0?[]:typeof k=="function"?C?[k.listener||k]:[k]:C?S(k):p(k,k.length)}r.prototype.listeners=function(T){return f(this,T,!0)},r.prototype.rawListeners=function(T){return f(this,T,!1)},r.listenerCount=function(_,T){return typeof _.listenerCount=="function"?_.listenerCount(T):g.call(_,T)},r.prototype.listenerCount=g;function g(_){var T=this._events;if(T!==void 0){var C=T[_];if(typeof C=="function")return 1;if(C!==void 0)return C.length}return 0}r.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function p(_,T){for(var C=new Array(T),A=0;A<T;++A)C[A]=_[A];return C}function v(_,T){for(;T+1<_.length;T++)_[T]=_[T+1];_.pop()}function S(_){for(var T=new Array(_.length),C=0;C<T.length;++C)T[C]=_[C].listener||_[C];return T}function b(_,T){return new Promise(function(C,A){function k(R){_.removeListener(T,D),A(R)}function D(){typeof _.removeListener=="function"&&_.removeListener("error",k),C([].slice.call(arguments))}w(_,T,D,{once:!0}),T!=="error"&&I(_,k,{once:!0})})}function I(_,T,C){typeof _.on=="function"&&w(_,"error",T,C)}function w(_,T,C,A){if(typeof _.on=="function")A.once?_.once(T,C):_.on(T,C);else if(typeof _.addEventListener=="function")_.addEventListener(T,function k(D){A.once&&_.removeEventListener(T,k),C(D)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof _)}return Hs.exports}var Qi={},kt={},vu;function eg(){if(vu)return kt;vu=1,Object.defineProperty(kt,"__esModule",{value:!0}),kt.Api=kt.HttpClient=kt.ContentType=void 0;var s;(function(i){i.Json="application/json",i.FormData="multipart/form-data",i.UrlEncoded="application/x-www-form-urlencoded",i.Text="text/plain"})(s||(kt.ContentType=s={}));class e{constructor(n={}){ae(this,"baseUrl","https://api.vapi.ai");ae(this,"securityData",null);ae(this,"securityWorker");ae(this,"abortControllers",new Map);ae(this,"customFetch",(...n)=>fetch(...n));ae(this,"baseApiParams",{credentials:"same-origin",headers:{},redirect:"follow",referrerPolicy:"no-referrer"});ae(this,"setSecurityData",n=>{this.securityData=n});ae(this,"contentFormatters",{[s.Json]:n=>n!==null&&(typeof n=="object"||typeof n=="string")?JSON.stringify(n):n,[s.Text]:n=>n!==null&&typeof n!="string"?JSON.stringify(n):n,[s.FormData]:n=>Object.keys(n||{}).reduce((r,a)=>{const o=n[a];return r.append(a,o instanceof Blob?o:typeof o=="object"&&o!==null?JSON.stringify(o):`${o}`),r},new FormData),[s.UrlEncoded]:n=>this.toQueryString(n)});ae(this,"createAbortSignal",n=>{if(this.abortControllers.has(n)){const a=this.abortControllers.get(n);return a?a.signal:void 0}const r=new AbortController;return this.abortControllers.set(n,r),r.signal});ae(this,"abortRequest",n=>{const r=this.abortControllers.get(n);r&&(r.abort(),this.abortControllers.delete(n))});ae(this,"request",async({body:n,secure:r,path:a,type:o,query:l,format:c,baseUrl:u,cancelToken:d,...f})=>{const g=(typeof r=="boolean"?r:this.baseApiParams.secure)&&this.securityWorker&&await this.securityWorker(this.securityData)||{},p=this.mergeRequestParams(f,g),v=l&&this.toQueryString(l),S=this.contentFormatters[o||s.Json],b=c||p.format;return this.customFetch(`${u||this.baseUrl||""}${a}${v?`?${v}`:""}`,{...p,headers:{...p.headers||{},...o&&o!==s.FormData?{"Content-Type":o}:{}},signal:(d?this.createAbortSignal(d):p.signal)||null,body:typeof n>"u"||n===null?null:S(n)}).then(async I=>{const w=I;w.data=null,w.error=null;const _=b?await I[b]().then(T=>(w.ok?w.data=T:w.error=T,w)).catch(T=>(w.error=T,w)):w;if(d&&this.abortControllers.delete(d),!I.ok)throw _;return _})});Object.assign(this,n)}encodeQueryParam(n,r){return`${encodeURIComponent(n)}=${encodeURIComponent(typeof r=="number"?r:`${r}`)}`}addQueryParam(n,r){return this.encodeQueryParam(r,n[r])}addArrayQueryParam(n,r){return n[r].map(o=>this.encodeQueryParam(r,o)).join("&")}toQueryString(n){const r=n||{};return Object.keys(r).filter(o=>typeof r[o]<"u").map(o=>Array.isArray(r[o])?this.addArrayQueryParam(r,o):this.addQueryParam(r,o)).join("&")}addQueryParams(n){const r=this.toQueryString(n);return r?`?${r}`:""}mergeRequestParams(n,r){return{...this.baseApiParams,...n,...r||{},headers:{...this.baseApiParams.headers||{},...n.headers||{},...r&&r.headers||{}}}}}kt.HttpClient=e;class t extends e{constructor(){super(...arguments);ae(this,"call",{callControllerCreate:(r,a={})=>this.request({path:"/call",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),callControllerFindAll:(r,a={})=>this.request({path:"/call",method:"GET",query:r,secure:!0,format:"json",...a}),callControllerFindOne:(r,a={})=>this.request({path:`/call/${r}`,method:"GET",secure:!0,format:"json",...a}),callControllerUpdate:(r,a,o={})=>this.request({path:`/call/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),callControllerDeleteCallData:(r,a={})=>this.request({path:`/call/${r}`,method:"DELETE",secure:!0,format:"json",...a}),callControllerCreatePhoneCall:(r,a={})=>this.request({path:"/call/phone",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),callControllerCreateWebCall:(r,a={})=>this.request({path:"/call/web",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a})});ae(this,"v2",{callControllerExportCalls:(r,a={})=>this.request({path:"/v2/call/export",method:"GET",query:r,secure:!0,...a}),callControllerFindAllPaginated:(r,a={})=>this.request({path:"/v2/call",method:"GET",query:r,secure:!0,format:"json",...a}),callControllerFindAllMetadataPaginated:(r,a={})=>this.request({path:"/v2/call/metadata",method:"GET",query:r,secure:!0,format:"json",...a}),assistantControllerFindAllPaginated:(r,a={})=>this.request({path:"/v2/assistant",method:"GET",query:r,secure:!0,format:"json",...a}),phoneNumberControllerFindAllPaginated:(r,a={})=>this.request({path:"/v2/phone-number",method:"GET",query:r,secure:!0,format:"json",...a})});ae(this,"chat",{chatControllerListChats:(r,a={})=>this.request({path:"/chat",method:"GET",query:r,secure:!0,format:"json",...a}),chatControllerCreateChat:(r,a={})=>this.request({path:"/chat",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),chatControllerGetChat:(r,a={})=>this.request({path:`/chat/${r}`,method:"GET",secure:!0,format:"json",...a}),chatControllerDeleteChat:(r,a={})=>this.request({path:`/chat/${r}`,method:"DELETE",secure:!0,format:"json",...a}),chatControllerCreateOpenAiChat:(r,a={})=>this.request({path:"/chat/responses",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a})});ae(this,"session",{sessionControllerCreate:(r,a={})=>this.request({path:"/session",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),sessionControllerFindAllPaginated:(r,a={})=>this.request({path:"/session",method:"GET",query:r,secure:!0,format:"json",...a}),sessionControllerFindOne:(r,a={})=>this.request({path:`/session/${r}`,method:"GET",secure:!0,format:"json",...a}),sessionControllerUpdate:(r,a,o={})=>this.request({path:`/session/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),sessionControllerRemove:(r,a={})=>this.request({path:`/session/${r}`,method:"DELETE",secure:!0,format:"json",...a})});ae(this,"assistant",{assistantControllerCreate:(r,a={})=>this.request({path:"/assistant",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),assistantControllerFindAll:(r,a={})=>this.request({path:"/assistant",method:"GET",query:r,secure:!0,format:"json",...a}),assistantControllerFindOne:(r,a={})=>this.request({path:`/assistant/${r}`,method:"GET",secure:!0,format:"json",...a}),assistantControllerUpdate:(r,a,o={})=>this.request({path:`/assistant/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),assistantControllerReplace:(r,a,o={})=>this.request({path:`/assistant/${r}`,method:"PUT",body:a,secure:!0,type:s.Json,format:"json",...o}),assistantControllerRemove:(r,a={})=>this.request({path:`/assistant/${r}`,method:"DELETE",secure:!0,format:"json",...a}),assistantControllerFindVersions:(r,a,o={})=>this.request({path:`/assistant/${r}/version`,method:"GET",query:a,secure:!0,format:"json",...o})});ae(this,"phoneNumber",{phoneNumberControllerImportTwilio:(r,a={})=>this.request({path:"/phone-number/import/twilio",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),phoneNumberControllerImportVonage:(r,a={})=>this.request({path:"/phone-number/import/vonage",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),phoneNumberControllerCreate:(r,a={})=>this.request({path:"/phone-number",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),phoneNumberControllerFindAll:(r,a={})=>this.request({path:"/phone-number",method:"GET",query:r,secure:!0,format:"json",...a}),phoneNumberControllerFindOne:(r,a={})=>this.request({path:`/phone-number/${r}`,method:"GET",secure:!0,format:"json",...a}),phoneNumberControllerUpdate:(r,a,o={})=>this.request({path:`/phone-number/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),phoneNumberControllerRemove:(r,a={})=>this.request({path:`/phone-number/${r}`,method:"DELETE",secure:!0,format:"json",...a})});ae(this,"tool",{toolControllerCreate:(r,a={})=>this.request({path:"/tool",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),toolControllerFindAll:(r,a={})=>this.request({path:"/tool",method:"GET",query:r,secure:!0,format:"json",...a}),toolControllerFindOne:(r,a={})=>this.request({path:`/tool/${r}`,method:"GET",secure:!0,format:"json",...a}),toolControllerUpdate:(r,a,o={})=>this.request({path:`/tool/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),toolControllerRemove:(r,a={})=>this.request({path:`/tool/${r}`,method:"DELETE",secure:!0,format:"json",...a})});ae(this,"file",{fileControllerCreateDeprecated:(r,a={})=>this.request({path:"/file/upload",method:"POST",body:r,secure:!0,type:s.FormData,format:"json",...a}),fileControllerCreate:(r,a={})=>this.request({path:"/file",method:"POST",body:r,secure:!0,type:s.FormData,format:"json",...a}),fileControllerFindAll:(r={})=>this.request({path:"/file",method:"GET",secure:!0,format:"json",...r}),fileControllerFindOne:(r,a={})=>this.request({path:`/file/${r}`,method:"GET",secure:!0,format:"json",...a}),fileControllerUpdate:(r,a,o={})=>this.request({path:`/file/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),fileControllerRemove:(r,a={})=>this.request({path:`/file/${r}`,method:"DELETE",secure:!0,format:"json",...a})});ae(this,"knowledgeBase",{knowledgeBaseControllerCreate:(r,a={})=>this.request({path:"/knowledge-base",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),knowledgeBaseControllerFindAll:(r,a={})=>this.request({path:"/knowledge-base",method:"GET",query:r,secure:!0,format:"json",...a}),knowledgeBaseControllerFindOne:(r,a={})=>this.request({path:`/knowledge-base/${r}`,method:"GET",secure:!0,format:"json",...a}),knowledgeBaseControllerUpdate:(r,a,o={})=>this.request({path:`/knowledge-base/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),knowledgeBaseControllerRemove:(r,a={})=>this.request({path:`/knowledge-base/${r}`,method:"DELETE",secure:!0,format:"json",...a})});ae(this,"workflow",{workflowControllerFindAll:(r={})=>this.request({path:"/workflow",method:"GET",secure:!0,format:"json",...r}),workflowControllerCreate:(r,a={})=>this.request({path:"/workflow",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),workflowControllerFindOne:(r,a={})=>this.request({path:`/workflow/${r}`,method:"GET",secure:!0,format:"json",...a}),workflowControllerDelete:(r,a={})=>this.request({path:`/workflow/${r}`,method:"DELETE",secure:!0,format:"json",...a}),workflowControllerUpdate:(r,a,o={})=>this.request({path:`/workflow/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o})});ae(this,"squad",{squadControllerCreate:(r,a={})=>this.request({path:"/squad",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),squadControllerFindAll:(r,a={})=>this.request({path:"/squad",method:"GET",query:r,secure:!0,format:"json",...a}),squadControllerFindOne:(r,a={})=>this.request({path:`/squad/${r}`,method:"GET",secure:!0,format:"json",...a}),squadControllerUpdate:(r,a,o={})=>this.request({path:`/squad/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),squadControllerRemove:(r,a={})=>this.request({path:`/squad/${r}`,method:"DELETE",secure:!0,format:"json",...a})});ae(this,"testSuite",{testSuiteControllerFindAllPaginated:(r,a={})=>this.request({path:"/test-suite",method:"GET",query:r,secure:!0,format:"json",...a}),testSuiteControllerCreate:(r,a={})=>this.request({path:"/test-suite",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),testSuiteControllerFindOne:(r,a={})=>this.request({path:`/test-suite/${r}`,method:"GET",secure:!0,format:"json",...a}),testSuiteControllerUpdate:(r,a,o={})=>this.request({path:`/test-suite/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),testSuiteControllerRemove:(r,a={})=>this.request({path:`/test-suite/${r}`,method:"DELETE",secure:!0,format:"json",...a}),testSuiteTestControllerFindAllPaginated:(r,a,o={})=>this.request({path:`/test-suite/${r}/test`,method:"GET",query:a,secure:!0,format:"json",...o}),testSuiteTestControllerCreate:(r,a,o={})=>this.request({path:`/test-suite/${r}/test`,method:"POST",body:a,secure:!0,type:s.Json,format:"json",...o}),testSuiteTestControllerFindOne:(r,a,o={})=>this.request({path:`/test-suite/${r}/test/${a}`,method:"GET",secure:!0,format:"json",...o}),testSuiteTestControllerUpdate:(r,a,o,l={})=>this.request({path:`/test-suite/${r}/test/${a}`,method:"PATCH",body:o,secure:!0,type:s.Json,format:"json",...l}),testSuiteTestControllerRemove:(r,a,o={})=>this.request({path:`/test-suite/${r}/test/${a}`,method:"DELETE",secure:!0,format:"json",...o}),testSuiteRunControllerFindAllPaginated:(r,a,o={})=>this.request({path:`/test-suite/${r}/run`,method:"GET",query:a,secure:!0,format:"json",...o}),testSuiteRunControllerCreate:(r,a,o={})=>this.request({path:`/test-suite/${r}/run`,method:"POST",body:a,secure:!0,type:s.Json,format:"json",...o}),testSuiteRunControllerFindOne:(r,a,o={})=>this.request({path:`/test-suite/${r}/run/${a}`,method:"GET",secure:!0,format:"json",...o}),testSuiteRunControllerUpdate:(r,a,o,l={})=>this.request({path:`/test-suite/${r}/run/${a}`,method:"PATCH",body:o,secure:!0,type:s.Json,format:"json",...l}),testSuiteRunControllerRemove:(r,a,o={})=>this.request({path:`/test-suite/${r}/run/${a}`,method:"DELETE",secure:!0,format:"json",...o})});ae(this,"metrics",{analyticsControllerFindAllDeprecated:(r,a={})=>this.request({path:"/metrics",method:"GET",query:r,secure:!0,format:"json",...a})});ae(this,"analytics",{analyticsControllerQuery:(r,a={})=>this.request({path:"/analytics",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a})});ae(this,"log",{loggingControllerCallLogsQuery:(r,a={})=>this.request({path:"/log",method:"GET",query:r,secure:!0,format:"json",...a}),loggingControllerCallLogsDeleteQuery:(r,a={})=>this.request({path:"/log",method:"DELETE",query:r,secure:!0,...a})});ae(this,"logs",{loggingControllerLogsQuery:(r,a={})=>this.request({path:"/logs",method:"GET",query:r,secure:!0,format:"json",...a}),loggingControllerLogsDeleteQuery:(r,a={})=>this.request({path:"/logs",method:"DELETE",query:r,secure:!0,...a})});ae(this,"org",{orgControllerCreate:(r,a={})=>this.request({path:"/org",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),orgControllerFindAll:(r={})=>this.request({path:"/org",method:"GET",secure:!0,format:"json",...r}),orgControllerFindOne:(r,a={})=>this.request({path:`/org/${r}`,method:"GET",secure:!0,format:"json",...a}),orgControllerUpdate:(r,a,o={})=>this.request({path:`/org/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),orgControllerDeleteOrg:(r,a={})=>this.request({path:`/org/${r}`,method:"DELETE",secure:!0,...a}),orgControllerFindAllUsers:(r,a={})=>this.request({path:`/org/${r}/user`,method:"GET",secure:!0,format:"json",...a}),orgControllerOrgLeave:(r,a={})=>this.request({path:`/org/${r}/leave`,method:"DELETE",secure:!0,...a}),orgControllerOrgRemoveUser:(r,a,o={})=>this.request({path:`/org/${r}/member/${a}/leave`,method:"DELETE",secure:!0,...o}),orgControllerUsersInvite:(r,a,o={})=>this.request({path:`/org/${r}/invite`,method:"POST",body:a,secure:!0,type:s.Json,...o}),orgControllerUserUpdate:(r,a,o={})=>this.request({path:`/org/${r}/role`,method:"PATCH",body:a,secure:!0,type:s.Json,...o}),orgControllerOrgToken:(r,a={})=>this.request({path:`/org/${r}/auth`,method:"GET",secure:!0,format:"json",...a})});ae(this,"token",{tokenControllerCreate:(r,a={})=>this.request({path:"/token",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),tokenControllerFindAll:(r,a={})=>this.request({path:"/token",method:"GET",query:r,secure:!0,format:"json",...a}),tokenControllerFindOne:(r,a={})=>this.request({path:`/token/${r}`,method:"GET",secure:!0,format:"json",...a}),tokenControllerUpdate:(r,a,o={})=>this.request({path:`/token/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),tokenControllerRemove:(r,a={})=>this.request({path:`/token/${r}`,method:"DELETE",secure:!0,format:"json",...a})});ae(this,"credential",{credentialControllerCreate:(r,a={})=>this.request({path:"/credential",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),credentialControllerFindAll:(r,a={})=>this.request({path:"/credential",method:"GET",query:r,secure:!0,format:"json",...a}),credentialControllerFindOne:(r,a={})=>this.request({path:`/credential/${r}`,method:"GET",secure:!0,format:"json",...a}),credentialControllerUpdate:(r,a,o={})=>this.request({path:`/credential/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),credentialControllerRemove:(r,a={})=>this.request({path:`/credential/${r}`,method:"DELETE",secure:!0,format:"json",...a}),credentialControllerGenerateSession:(r,a={})=>this.request({path:"/credential/session",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),credentialControllerHandleWebhook:(r,a={})=>this.request({path:"/credential/webhook",method:"POST",body:r,type:s.Json,...a}),credentialControllerTriggerCredentialAction:(r,a={})=>this.request({path:"/credential/trigger",method:"POST",body:r,secure:!0,type:s.Json,...a})});ae(this,"template",{templateControllerCreate:(r,a={})=>this.request({path:"/template",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),templateControllerFindAll:(r,a={})=>this.request({path:"/template",method:"GET",query:r,secure:!0,format:"json",...a}),templateControllerFindAllPinned:(r={})=>this.request({path:"/template/pinned",method:"GET",secure:!0,format:"json",...r}),templateControllerFindOne:(r,a={})=>this.request({path:`/template/${r}`,method:"GET",secure:!0,format:"json",...a}),templateControllerUpdate:(r,a,o={})=>this.request({path:`/template/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),templateControllerRemove:(r,a={})=>this.request({path:`/template/${r}`,method:"DELETE",secure:!0,format:"json",...a})});ae(this,"voiceLibrary",{voiceLibraryControllerVoiceGetByProvider:(r,a,o={})=>this.request({path:`/voice-library/${r}`,method:"GET",query:a,secure:!0,format:"json",...o}),voiceLibraryControllerVoiceGetAccentsByProvider:(r,a={})=>this.request({path:`/voice-library/${r}/accents`,method:"GET",secure:!0,format:"json",...a}),voiceLibraryControllerVoiceLibrarySyncByProvider:(r,a={})=>this.request({path:`/voice-library/sync/${r}`,method:"POST",secure:!0,format:"json",...a}),voiceLibraryControllerVoiceLibrarySyncDefaultVoices:(r,a={})=>this.request({path:"/voice-library/sync",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),voiceLibraryControllerVoiceLibraryCreateSesameVoice:(r,a={})=>this.request({path:"/voice-library/create-sesame-voice",method:"POST",body:r,secure:!0,type:s.Json,...a})});ae(this,"provider",{providerControllerGetWorkflows:(r,a,o={})=>this.request({path:`/${r}/workflows`,method:"GET",query:a,secure:!0,format:"json",...o}),providerControllerGetWorkflowTriggerHook:(r,a,o={})=>this.request({path:`/${r}/workflows/${a}/hooks`,method:"GET",secure:!0,format:"json",...o}),providerControllerGetLocations:(r,a={})=>this.request({path:`/${r}/locations`,method:"GET",secure:!0,format:"json",...a}),voiceProviderControllerSearchVoices:(r,a,o={})=>this.request({path:`/${r}/voices/search`,method:"GET",query:a,secure:!0,format:"json",...o}),voiceProviderControllerSearchVoice:(r,a,o={})=>this.request({path:`/${r}/voice/search`,method:"GET",query:a,secure:!0,format:"json",...o}),voiceProviderControllerAddVoices:(r,a,o={})=>this.request({path:`/${r}/voices/add`,method:"POST",body:a,secure:!0,type:s.Json,format:"json",...o}),voiceProviderControllerAddVoice:(r,a,o={})=>this.request({path:`/${r}/voice/add`,method:"POST",body:a,secure:!0,type:s.Json,format:"json",...o})});ae(this,"v11Labs",{voiceProviderControllerCloneVoices:(r,a={})=>this.request({path:"/11labs/voice/clone",method:"POST",body:r,secure:!0,type:s.FormData,...a})})}}return kt.Api=t,kt}var yu;function tg(){if(yu)return Qi;yu=1,Object.defineProperty(Qi,"__esModule",{value:!0}),Qi.client=void 0;const s=eg(),e=new s.Api({baseUrl:"https://api.vapi.ai",baseApiParams:{secure:!0},securityWorker:async t=>{if(t)return{headers:{Authorization:`Bearer ${t}`}}}});return Qi.client=e,Qi}var Su;function ig(){if(Su)return rt;Su=1;var s=rt&&rt.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(rt,"__esModule",{value:!0});const e=s(Xp),t=s(Zp()),i=tg();async function n(u,d){u.muted=!1,u.autoplay=!0,d!=null&&(u.srcObject=new MediaStream([d]),await u.play())}async function r(u,d){const f=document.createElement("audio");return f.dataset.participantId=d,document.body.appendChild(f),await n(f,u),f}function a(u){const d=document.querySelector(`audio[data-participant-id="${u}"]`);d==null||d.remove()}function o(u,d,f,g){u.participant.local||d.updateParticipant(u.participant.session_id,{setSubscribedTracks:{audio:!0,video:f||g}})}class l extends t.default{on(d,f){return super.on(d,f),this}once(d,f){return super.once(d,f),this}emit(d,...f){return super.emit(d,...f)}removeListener(d,f){return super.removeListener(d,f),this}removeAllListeners(d){return super.removeAllListeners(d),this}}class c extends l{constructor(f,g,p,v){super();ae(this,"started",!1);ae(this,"call",null);ae(this,"speakingTimeout",null);ae(this,"dailyCallConfig",{});ae(this,"dailyCallObject",{});ae(this,"hasEmittedCallEndedStatus",!1);i.client.baseUrl=g??"https://api.vapi.ai",i.client.setSecurityData(f),this.dailyCallConfig=p??{},this.dailyCallObject=v??{}}cleanup(){var f;this.started=!1,this.hasEmittedCallEndedStatus=!1,(f=this.call)==null||f.destroy(),this.call=null,this.speakingTimeout=null}isMobileDevice(){if(typeof navigator>"u")return!1;const f=navigator.userAgent;return/android|iphone|ipad|ipod|iemobile|blackberry|bada/i.test(f.toLowerCase())}async sleep(f){return new Promise(g=>setTimeout(g,f))}async start(f,g,p,v){var S,b,I,w;if(!f&&!p&&!v)throw new Error("Assistant or Squad or Workflow must be provided.");if(this.started)return null;this.started=!0;try{const _=(await i.client.call.callControllerCreateWebCall({assistant:typeof f=="string"?void 0:f,assistantId:typeof f=="string"?f:void 0,assistantOverrides:g,squad:typeof p=="string"?void 0:p,squadId:typeof p=="string"?p:void 0,workflow:typeof v=="string"?void 0:v,workflowId:typeof v=="string"?v:void 0})).data;this.call&&this.cleanup();const T=((S=_==null?void 0:_.artifactPlan)==null?void 0:S.videoRecordingEnabled)??!1,C=((I=(b=_==null?void 0:_.assistant)==null?void 0:b.voice)==null?void 0:I.provider)==="tavus";if(this.call=e.default.createCallObject({audioSource:this.dailyCallObject.audioSource??!0,videoSource:this.dailyCallObject.videoSource??T,dailyConfig:this.dailyCallConfig}),(w=this.call.iframe())==null||w.style.setProperty("display","none"),this.call.on("left-meeting",()=>{var A;this.emit("call-end"),this.hasEmittedCallEndedStatus||(this.emit("message",{type:"status-update",status:"ended",endedReason:"customer-ended-call"}),this.hasEmittedCallEndedStatus=!0),T&&((A=this.call)==null||A.stopRecording()),this.cleanup()}),this.call.on("error",A=>{var k;this.emit("error",A),T&&((k=this.call)==null||k.stopRecording())}),this.call.on("camera-error",A=>{this.emit("error",A)}),this.call.on("track-started",async A=>{var k,D,R;!A||!A.participant||(k=A.participant)!=null&&k.local||((D=A.participant)==null?void 0:D.user_name)==="Vapi Speaker"&&(A.track.kind==="video"&&this.emit("video",A.track),A.track.kind==="audio"&&await r(A.track,A.participant.session_id),(R=this.call)==null||R.sendAppMessage("playable"))}),this.call.on("participant-joined",A=>{!A||!this.call||o(A,this.call,T,C)}),this.call.on("participant-updated",A=>{A&&this.emit("daily-participant-updated",A.participant)}),this.call.on("participant-left",A=>{A&&a(A.participant.session_id)}),this.isMobileDevice()&&await this.sleep(1e3),await this.call.join({url:_.webCallUrl,subscribeToTracksAutomatically:!1}),T){const A=new Date().getTime();this.call.startRecording({width:1280,height:720,backgroundColor:"#FF1F2D3D",layout:{preset:"default"}}),this.call.on("recording-started",()=>{this.send({type:"control",control:"say-first-message",videoRecordingStartDelaySeconds:(new Date().getTime()-A)/1e3})})}return this.call.startRemoteParticipantsAudioLevelObserver(100),this.call.on("remote-participants-audio-level",A=>{A&&this.handleRemoteParticipantsAudioLevel(A)}),this.call.on("app-message",A=>this.onAppMessage(A)),this.call.on("nonfatal-error",A=>{var k;(A==null?void 0:A.type)==="audio-processor-error"&&((k=this.call)==null||k.updateInputSettings({audio:{processor:{type:"none"}}}).then(()=>{var D;(D=this.call)==null||D.setLocalAudio(!0)}))}),this.call.updateInputSettings({audio:{processor:{type:"noise-cancellation"}}}),_}catch(_){return console.error(_),this.emit("error",_),this.cleanup(),null}}onAppMessage(f){if(f)try{if(f.data==="listening")return this.emit("call-start");try{const g=JSON.parse(f.data);this.emit("message",g),g&&"type"in g&&"status"in g&&g.type==="status-update"&&g.status==="ended"&&(this.hasEmittedCallEndedStatus=!0)}catch(g){console.log("Error parsing message data: ",g)}}catch(g){console.error(g)}}handleRemoteParticipantsAudioLevel(f){const g=Object.values(f.participantsAudioLevel).reduce((v,S)=>v+S,0);this.emit("volume-level",Math.min(1,g/.15)),g>.01&&(this.speakingTimeout?(clearTimeout(this.speakingTimeout),this.speakingTimeout=null):this.emit("speech-start"),this.speakingTimeout=setTimeout(()=>{this.emit("speech-end"),this.speakingTimeout=null},1e3))}stop(){var f;this.started=!1,(f=this.call)==null||f.destroy(),this.call=null}send(f){var g;(g=this.call)==null||g.sendAppMessage(JSON.stringify(f))}setMuted(f){if(!this.call)throw new Error("Call object is not available.");this.call.setLocalAudio(!f)}isMuted(){return this.call?this.call.localAudio()===!1:!1}say(f,g,p){this.send({type:"say",message:f,endCallAfterSpoken:g,interruptionsEnabled:p??!1})}setInputDevicesAsync(f){var g;(g=this.call)==null||g.setInputDevicesAsync(f)}async increaseMicLevel(f){if(!this.call)throw new Error("Call object is not available.");try{const g=await navigator.mediaDevices.getUserMedia({audio:!0}),p=new AudioContext,v=p.createMediaStreamSource(g),S=p.createGain();S.gain.value=f,v.connect(S);const b=p.createMediaStreamDestination();S.connect(b);const[I]=b.stream.getAudioTracks();await this.call.setInputDevicesAsync({audioSource:I})}catch(g){console.error("Error adjusting microphone level:",g)}}setOutputDeviceAsync(f){var g;(g=this.call)==null||g.setOutputDeviceAsync(f)}getDailyCallObject(){return this.call}startScreenSharing(f,g){var p;(p=this.call)==null||p.startScreenShare({displayMediaOptions:f,screenVideoSendSettings:g})}stopScreenSharing(){var f;(f=this.call)==null||f.stopScreenShare()}}return rt.default=c,rt}var sg=ig();const ng=zt(sg),J=Number.isFinite||function(s){return typeof s=="number"&&isFinite(s)},rg=Number.isSafeInteger||function(s){return typeof s=="number"&&Math.abs(s)<=ag},ag=Number.MAX_SAFE_INTEGER||9007199254740991;let te=function(s){return s.NETWORK_ERROR="networkError",s.MEDIA_ERROR="mediaError",s.KEY_SYSTEM_ERROR="keySystemError",s.MUX_ERROR="muxError",s.OTHER_ERROR="otherError",s}({}),M=function(s){return s.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",s.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",s.KEY_SYSTEM_NO_SESSION="keySystemNoSession",s.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",s.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",s.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",s.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",s.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",s.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",s.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",s.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",s.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",s.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",s.MANIFEST_LOAD_ERROR="manifestLoadError",s.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",s.MANIFEST_PARSING_ERROR="manifestParsingError",s.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",s.LEVEL_EMPTY_ERROR="levelEmptyError",s.LEVEL_LOAD_ERROR="levelLoadError",s.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",s.LEVEL_PARSING_ERROR="levelParsingError",s.LEVEL_SWITCH_ERROR="levelSwitchError",s.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",s.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",s.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",s.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",s.FRAG_LOAD_ERROR="fragLoadError",s.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",s.FRAG_DECRYPT_ERROR="fragDecryptError",s.FRAG_PARSING_ERROR="fragParsingError",s.FRAG_GAP="fragGap",s.REMUX_ALLOC_ERROR="remuxAllocError",s.KEY_LOAD_ERROR="keyLoadError",s.KEY_LOAD_TIMEOUT="keyLoadTimeOut",s.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",s.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",s.BUFFER_APPEND_ERROR="bufferAppendError",s.BUFFER_APPENDING_ERROR="bufferAppendingError",s.BUFFER_STALLED_ERROR="bufferStalledError",s.BUFFER_FULL_ERROR="bufferFullError",s.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",s.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",s.ASSET_LIST_LOAD_ERROR="assetListLoadError",s.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",s.ASSET_LIST_PARSING_ERROR="assetListParsingError",s.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",s.INTERNAL_EXCEPTION="internalException",s.INTERNAL_ABORTED="aborted",s.ATTACH_MEDIA_ERROR="attachMediaError",s.UNKNOWN="unknown",s}({}),E=function(s){return s.MEDIA_ATTACHING="hlsMediaAttaching",s.MEDIA_ATTACHED="hlsMediaAttached",s.MEDIA_DETACHING="hlsMediaDetaching",s.MEDIA_DETACHED="hlsMediaDetached",s.MEDIA_ENDED="hlsMediaEnded",s.STALL_RESOLVED="hlsStallResolved",s.BUFFER_RESET="hlsBufferReset",s.BUFFER_CODECS="hlsBufferCodecs",s.BUFFER_CREATED="hlsBufferCreated",s.BUFFER_APPENDING="hlsBufferAppending",s.BUFFER_APPENDED="hlsBufferAppended",s.BUFFER_EOS="hlsBufferEos",s.BUFFERED_TO_END="hlsBufferedToEnd",s.BUFFER_FLUSHING="hlsBufferFlushing",s.BUFFER_FLUSHED="hlsBufferFlushed",s.MANIFEST_LOADING="hlsManifestLoading",s.MANIFEST_LOADED="hlsManifestLoaded",s.MANIFEST_PARSED="hlsManifestParsed",s.LEVEL_SWITCHING="hlsLevelSwitching",s.LEVEL_SWITCHED="hlsLevelSwitched",s.LEVEL_LOADING="hlsLevelLoading",s.LEVEL_LOADED="hlsLevelLoaded",s.LEVEL_UPDATED="hlsLevelUpdated",s.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",s.LEVELS_UPDATED="hlsLevelsUpdated",s.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",s.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",s.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",s.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",s.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",s.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",s.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",s.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",s.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",s.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",s.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",s.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",s.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",s.CUES_PARSED="hlsCuesParsed",s.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",s.INIT_PTS_FOUND="hlsInitPtsFound",s.FRAG_LOADING="hlsFragLoading",s.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",s.FRAG_LOADED="hlsFragLoaded",s.FRAG_DECRYPTED="hlsFragDecrypted",s.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",s.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",s.FRAG_PARSING_METADATA="hlsFragParsingMetadata",s.FRAG_PARSED="hlsFragParsed",s.FRAG_BUFFERED="hlsFragBuffered",s.FRAG_CHANGED="hlsFragChanged",s.FPS_DROP="hlsFpsDrop",s.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",s.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",s.ERROR="hlsError",s.DESTROYING="hlsDestroying",s.KEY_LOADING="hlsKeyLoading",s.KEY_LOADED="hlsKeyLoaded",s.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",s.BACK_BUFFER_REACHED="hlsBackBufferReached",s.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",s.ASSET_LIST_LOADING="hlsAssetListLoading",s.ASSET_LIST_LOADED="hlsAssetListLoaded",s.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",s.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",s.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",s.INTERSTITIAL_STARTED="hlsInterstitialStarted",s.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",s.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",s.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",s.INTERSTITIAL_ENDED="hlsInterstitialEnded",s.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",s.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",s.EVENT_CUE_ENTER="hlsEventCueEnter",s}({});var Ct={AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},oe={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class wi{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class og{constructor(e,t,i,n=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new wi(e),this.fast_=new wi(t),this.defaultTTFB_=n,this.ttfb_=new wi(e)}update(e,t){const{slow_:i,fast_:n,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new wi(e,i.getEstimate(),i.getTotalWeight())),n.halfLife!==t&&(this.fast_=new wi(t,n.getEstimate(),n.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new wi(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,n=e/1e3,r=i/n;this.fast_.sample(n,r),this.slow_.sample(n,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function lg(s,e,t){return(e=ug(e))in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}function Ae(){return Ae=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(s[i]=t[i])}return s},Ae.apply(null,arguments)}function Eu(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function _e(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Eu(Object(t),!0).forEach(function(i){lg(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Eu(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}function cg(s,e){if(typeof s!="object"||!s)return s;var t=s[Symbol.toPrimitive];if(t!==void 0){var i=t.call(s,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(s)}function ug(s){var e=cg(s,"string");return typeof e=="symbol"?e:e+""}class Rt{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=ci,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const ci=function(){},dg={trace:ci,debug:ci,log:ci,warn:ci,info:ci,error:ci};function hg(){return Ae({},dg)}const Te=hg();function Xi(s=!0){return typeof self>"u"?void 0:(s||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function fg(s){return typeof self<"u"&&s===self.ManagedMediaSource}function bu(s,e){const t=Object.keys(s),i=Object.keys(e),n=t.length,r=i.length;return!n||!r||n===r&&!t.some(a=>i.indexOf(a)===-1)}function We(s,e=!1){if(typeof TextDecoder<"u"){const c=new TextDecoder("utf-8").decode(s);if(e){const u=c.indexOf("\0");return u!==-1?c.substring(0,u):c}return c.replace(/\0/g,"")}const t=s.length;let i,n,r,a="",o=0;for(;o<t;){if(i=s[o++],i===0&&e)return a;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(i);break;case 12:case 13:n=s[o++],a+=String.fromCharCode((i&31)<<6|n&63);break;case 14:n=s[o++],r=s[o++],a+=String.fromCharCode((i&15)<<12|(n&63)<<6|(r&63)<<0);break}}return a}const mt={hexDump:function(s){let e="";for(let t=0;t<s.length;t++){let i=s[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}};function pg(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Nr={exports:{}},Tu;function gg(){return Tu||(Tu=1,function(s,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,c,u){if(u=u||{},l=l.trim(),c=c.trim(),!c){if(!u.alwaysNormalize)return l;var d=o.parseURL(l);if(!d)throw new Error("Error trying to parse base URL.");return d.path=o.normalizePath(d.path),o.buildURLFromParts(d)}var f=o.parseURL(c);if(!f)throw new Error("Error trying to parse relative URL.");if(f.scheme)return u.alwaysNormalize?(f.path=o.normalizePath(f.path),o.buildURLFromParts(f)):c;var g=o.parseURL(l);if(!g)throw new Error("Error trying to parse base URL.");if(!g.netLoc&&g.path&&g.path[0]!=="/"){var p=n.exec(g.path);g.netLoc=p[1],g.path=p[2]}g.netLoc&&!g.path&&(g.path="/");var v={scheme:g.scheme,netLoc:f.netLoc,path:null,params:f.params,query:f.query,fragment:f.fragment};if(!f.netLoc&&(v.netLoc=g.netLoc,f.path[0]!=="/"))if(!f.path)v.path=g.path,f.params||(v.params=g.params,f.query||(v.query=g.query));else{var S=g.path,b=S.substring(0,S.lastIndexOf("/")+1)+f.path;v.path=o.normalizePath(b)}return v.path===null&&(v.path=u.alwaysNormalize?o.normalizePath(f.path):f.path),o.buildURLFromParts(v)},parseURL:function(l){var c=i.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(r,"");l.length!==(l=l.replace(a,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};s.exports=o})()}(Nr)),Nr.exports}gg();class mg{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var $e={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};function ze(s){return s.sn!=="initSegment"}const Ys=Math.pow(2,32)-1,vg=[].push,_u={video:1,audio:2,id3:3,text:4};function Le(s){return String.fromCharCode.apply(null,s)}function xu(s,e){const t=s[e]<<8|s[e+1];return t<0?65536+t:t}function Q(s,e){const t=Iu(s,e);return t<0?4294967296+t:t}function Au(s,e){let t=Q(s,e);return t*=Math.pow(2,32),t+=Q(s,e+4),t}function Iu(s,e){return s[e]<<24|s[e+1]<<16|s[e+2]<<8|s[e+3]}function Ur(s,e,t){s[e]=t>>24,s[e+1]=t>>16&255,s[e+2]=t>>8&255,s[e+3]=t&255}function yg(s){const e=s.byteLength;for(let t=0;t<e;){const i=Q(s,t);if(i>8&&s[t+4]===109&&s[t+5]===111&&s[t+6]===111&&s[t+7]===102)return!0;t=i>1?t+i:e}return!1}function ne(s,e){const t=[];if(!e.length)return t;const i=s.byteLength;for(let n=0;n<i;){const r=Q(s,n),a=Le(s.subarray(n+4,n+8)),o=r>1?n+r:i;if(a===e[0])if(e.length===1)t.push(s.subarray(n+8,o));else{const l=ne(s.subarray(n+8,o),e.slice(1));l.length&&vg.apply(t,l)}n=o}return t}function Sg(s){const e=[],t=s[0];let i=8;const n=Q(s,i);i+=4;let r=0,a=0;t===0?(r=Q(s,i),a=Q(s,i+4),i+=8):(r=Au(s,i),a=Au(s,i+8),i+=16),i+=2;let o=s.length+a;const l=xu(s,i);i+=2;for(let c=0;c<l;c++){let u=i;const d=Q(s,u);u+=4;const f=d&2147483647;if((d&2147483648)>>>31===1)return Te.warn("SIDX has hierarchical references (not supported)"),null;const p=Q(s,u);u+=4,e.push({referenceSize:f,subsegmentDuration:p,info:{duration:p/n,start:o,end:o+f-1}}),o+=f,u+=4,i=u}return{earliestPresentationTime:r,timescale:n,version:t,referencesCount:l,references:e}}function wu(s){const e=[],t=ne(s,["moov","trak"]);for(let n=0;n<t.length;n++){const r=t[n],a=ne(r,["tkhd"])[0];if(a){let o=a[0];const l=Q(a,o===0?12:20),c=ne(r,["mdia","mdhd"])[0];if(c){o=c[0];const u=Q(c,o===0?12:20),d=ne(r,["mdia","hdlr"])[0];if(d){const f=Le(d.subarray(8,12)),g={soun:$e.AUDIO,vide:$e.VIDEO}[f],p=ne(r,["mdia","minf","stbl","stsd"])[0],v=Eg(p);g?(e[l]={timescale:u,type:g,stsd:v},e[g]=_e({timescale:u,id:l},v)):e[l]={timescale:u,type:f,stsd:v}}}}}return ne(s,["moov","mvex","trex"]).forEach(n=>{const r=Q(n,4),a=e[r];a&&(a.default={duration:Q(n,12),flags:Q(n,20)})}),e}function Eg(s){const e=s.subarray(8),t=e.subarray(86),i=Le(e.subarray(4,8));let n=i,r;const a=i==="enca"||i==="encv";if(a){const c=ne(e,[i])[0].subarray(i==="enca"?28:78);ne(c,["sinf"]).forEach(d=>{const f=ne(d,["schm"])[0];if(f){const g=Le(f.subarray(4,8));if(g==="cbcs"||g==="cenc"){const p=ne(d,["frma"])[0];p&&(n=Le(p))}}})}const o=n;switch(n){case"avc1":case"avc2":case"avc3":case"avc4":{const l=ne(t,["avcC"])[0];l&&l.length>3&&(n+="."+zs(l[1])+zs(l[2])+zs(l[3]),r=Ws(o==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const l=ne(e,[i])[0],c=ne(l.subarray(28),["esds"])[0];if(c&&c.length>7){let u=4;if(c[u++]!==3)break;u=Br(c,u),u+=2;const d=c[u++];if(d&128&&(u+=2),d&64&&(u+=c[u++]),c[u++]!==4)break;u=Br(c,u);const f=c[u++];if(f===64)n+="."+zs(f);else break;if(u+=12,c[u++]!==5)break;u=Br(c,u);const g=c[u++];let p=(g&248)>>3;p===31&&(p+=1+((g&7)<<3)+((c[u]&224)>>5)),n+="."+p}break}case"hvc1":case"hev1":{const l=ne(t,["hvcC"])[0];if(l&&l.length>12){const c=l[1],u=["","A","B","C"][c>>6],d=c&31,f=Q(l,2),g=(c&32)>>5?"H":"L",p=l[12],v=l.subarray(6,12);n+="."+u+d,n+="."+bg(f).toString(16).toUpperCase(),n+="."+g+p;let S="";for(let b=v.length;b--;){const I=v[b];(I||S)&&(S="."+I.toString(16).toUpperCase()+S)}n+=S}r=Ws(o=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{n=Ws(n,t)||n;break}case"vp09":{const l=ne(t,["vpcC"])[0];if(l&&l.length>6){const c=l[4],u=l[5],d=l[6]>>4&15;n+="."+vt(c)+"."+vt(u)+"."+vt(d)}break}case"av01":{const l=ne(t,["av1C"])[0];if(l&&l.length>2){const c=l[1]>>>5,u=l[1]&31,d=l[2]>>>7?"H":"M",f=(l[2]&64)>>6,g=(l[2]&32)>>5,p=c===2&&f?g?12:10:f?10:8,v=(l[2]&16)>>4,S=(l[2]&8)>>3,b=(l[2]&4)>>2,I=l[2]&3;n+="."+c+"."+vt(u)+d+"."+vt(p)+"."+v+"."+S+b+I+"."+vt(1)+"."+vt(1)+"."+vt(1)+"."+0,r=Ws("dav1",t)}break}}return{codec:n,encrypted:a,supplemental:r}}function Ws(s,e){const t=ne(e,["dvvC"]),i=t.length?t[0]:ne(e,["dvcC"])[0];if(i){const n=i[2]>>1&127,r=i[2]<<5&32|i[3]>>3&31;return s+"."+vt(n)+"."+vt(r)}}function bg(s){let e=0;for(let t=0;t<32;t++)e|=(s>>t&1)<<31-t;return e>>>0}function Br(s,e){const t=e+5;for(;s[e++]&128&&e<t;);return e}function zs(s){return("0"+s.toString(16).toUpperCase()).slice(-2)}function vt(s){return(s<10?"0":"")+s}function Tg(s,e){if(!s||!e)return s;const t=e.keyId;return t&&e.isCommonEncryption&&ne(s,["moov","trak"]).forEach(n=>{const a=ne(n,["mdia","minf","stbl","stsd"])[0].subarray(8);let o=ne(a,["enca"]);const l=o.length>0;l||(o=ne(a,["encv"])),o.forEach(c=>{const u=l?c.subarray(28):c.subarray(78);ne(u,["sinf"]).forEach(f=>{const g=Lu(f);if(g){const p=g.subarray(8,24);p.some(v=>v!==0)||(Te.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${mt.hexDump(p)} -> ${mt.hexDump(t)}`),g.set(t,8))}})})}),s}function Lu(s){const e=ne(s,["schm"])[0];if(e){const t=Le(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return ne(s,["schi","tenc"])[0]}return null}function _g(s,e,t){const i={},n=ne(s,["moof","traf"]);for(let r=0;r<n.length;r++){const a=n[r],o=ne(a,["tfhd"])[0],l=Q(o,4),c=e[l];if(!c)continue;const u=i[l]||(i[l]={start:NaN,duration:0,sampleCount:0,timescale:c.timescale,type:c.type}),d=ne(a,["tfdt"])[0];if(d){const w=d[0];let _=Q(d,4);w===1&&(_===Ys?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(_*=Ys+1,_+=Q(d,8))),J(_)&&(!J(u.start)||_<u.start)&&(u.start=_)}const f=c.default,g=Q(o,0)|(f==null?void 0:f.flags);let p=(f==null?void 0:f.duration)||0;g&8&&(g&2?p=Q(o,12):p=Q(o,8));const v=ne(a,["trun"]);let S=u.start||0,b=0,I=p;for(let w=0;w<v.length;w++){const _=v[w],T=Q(_,4),C=u.sampleCount;u.sampleCount+=T;const A=_[3]&1,k=_[3]&4,D=_[2]&1,R=_[2]&2,N=_[2]&4,V=_[2]&8;let W=8,q=T;for(A&&(W+=4),k&&T&&(!(_[W+1]&1)&&u.keyFrameIndex===void 0&&(u.keyFrameIndex=C),W+=4,D?(I=Q(_,W),W+=4):I=p,R&&(W+=4),V&&(W+=4),S+=I,b+=I,q--);q--;)D?(I=Q(_,W),W+=4):I=p,R&&(W+=4),N&&(_[W+1]&1||u.keyFrameIndex===void 0&&(u.keyFrameIndex=u.sampleCount-(q+1),u.keyFrameStart=S),W+=4),V&&(W+=4),S+=I,b+=I;!b&&p&&(b+=p*T)}u.duration+=b}if(!Object.keys(i).some(r=>i[r].duration)){let r=1/0,a=0;const o=ne(s,["sidx"]);for(let l=0;l<o.length;l++){const c=Sg(o[l]);if(c!=null&&c.references){r=Math.min(r,c.earliestPresentationTime/c.timescale);const u=c.references.reduce((d,f)=>d+f.info.duration||0,0);a=Math.max(a,u+c.earliestPresentationTime/c.timescale)}}a&&J(a)&&Object.keys(i).forEach(l=>{i[l].duration||(i[l].duration=a*i[l].timescale-i[l].start)})}return i}function xg(s,e,t){ne(e,["moof","traf"]).forEach(i=>{ne(i,["tfhd"]).forEach(n=>{const r=Q(n,4),a=s[r];if(!a)return;const o=a.timescale||9e4;ne(i,["tfdt"]).forEach(l=>{const c=l[0],u=t*o;if(u){let d=Q(l,4);if(c===0)d-=u,d=Math.max(d,0),Ur(l,4,d);else{d*=Math.pow(2,32),d+=Q(l,8),d-=u,d=Math.max(d,0);const f=Math.floor(d/(Ys+1)),g=Math.floor(d%(Ys+1));Ur(l,4,f),Ur(l,8,g)}}})})})}function Ag(s){const e={valid:null,remainder:null},t=ne(s,["moof"]);if(t.length<2)return e.remainder=s,e;const i=t[t.length-1];return e.valid=s.slice(0,i.byteOffset-8),e.remainder=s.slice(i.byteOffset-8),e}function tt(s,e){const t=new Uint8Array(s.length+e.length);return t.set(s),t.set(e,s.length),t}function ku(s,e){const t=[],i=e.samples,n=e.timescale,r=e.id;let a=!1;return ne(i,["moof"]).map(l=>{const c=l.byteOffset-8;ne(l,["traf"]).map(d=>{const f=ne(d,["tfdt"]).map(g=>{const p=g[0];let v=Q(g,4);return p===1&&(v*=Math.pow(2,32),v+=Q(g,8)),v/n})[0];return f!==void 0&&(s=f),ne(d,["tfhd"]).map(g=>{const p=Q(g,4),v=Q(g,0)&16777215,S=(v&1)!==0,b=(v&2)!==0,I=(v&8)!==0;let w=0;const _=(v&16)!==0;let T=0;const C=(v&32)!==0;let A=8;p===r&&(S&&(A+=8),b&&(A+=4),I&&(w=Q(g,A),A+=4),_&&(T=Q(g,A),A+=4),C&&(A+=4),e.type==="video"&&(a=Js(e.codec)),ne(d,["trun"]).map(k=>{const D=k[0],R=Q(k,0)&16777215,N=(R&1)!==0;let V=0;const W=(R&4)!==0,q=(R&256)!==0;let ee=0;const z=(R&512)!==0;let K=0;const pe=(R&1024)!==0,G=(R&2048)!==0;let B=0;const ie=Q(k,4);let X=8;N&&(V=Q(k,X),X+=4),W&&(X+=4);let h=V+c;for(let y=0;y<ie;y++){if(q?(ee=Q(k,X),X+=4):ee=w,z?(K=Q(k,X),X+=4):K=T,pe&&(X+=4),G&&(D===0?B=Q(k,X):B=Iu(k,X),X+=4),e.type===$e.VIDEO){let m=0;for(;m<K;){const x=Q(i,h);if(h+=4,Ig(a,i[h])){const L=i.subarray(h,h+x);$r(L,a?2:1,s+B/n,t)}h+=x,m+=x+4}}s+=ee/n}}))})})}),t}function Js(s){if(!s)return!1;const e=s.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function Ig(s,e){if(s){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function $r(s,e,t,i){const n=Cu(s);let r=0;r+=e;let a=0,o=0,l=0;for(;r<n.length;){a=0;do{if(r>=n.length)break;l=n[r++],a+=l}while(l===255);o=0;do{if(r>=n.length)break;l=n[r++],o+=l}while(l===255);const c=n.length-r;let u=r;if(o<c)r+=o;else if(o>c){Te.error(`Malformed SEI payload. ${o} is too small, only ${c} bytes left to parse.`);break}if(a===4){if(n[u++]===181){const f=xu(n,u);if(u+=2,f===49){const g=Q(n,u);if(u+=4,g===1195456820){const p=n[u++];if(p===3){const v=n[u++],S=31&v,b=64&v,I=b?2+S*3:0,w=new Uint8Array(I);if(b){w[0]=v;for(let _=1;_<I;_++)w[_]=n[u++]}i.push({type:p,payloadType:a,pts:t,bytes:w})}}}}}else if(a===5&&o>16){const d=[];for(let p=0;p<16;p++){const v=n[u++].toString(16);d.push(v.length==1?"0"+v:v),(p===3||p===5||p===7||p===9)&&d.push("-")}const f=o-16,g=new Uint8Array(f);for(let p=0;p<f;p++)g[p]=n[u++];i.push({payloadType:a,pts:t,uuid:d.join(""),userData:We(g),userDataBytes:g})}}}function Cu(s){const e=s.byteLength,t=[];let i=1;for(;i<e-2;)s[i]===0&&s[i+1]===0&&s[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return s;const n=e-t.length,r=new Uint8Array(n);let a=0;for(i=0;i<n;a++,i++)a===t[0]&&(a++,t.shift()),r[i]=s[a];return r}function wg(s){const e=s[0];let t="",i="",n=0,r=0,a=0,o=0,l=0,c=0;if(e===0){for(;Le(s.subarray(c,c+1))!=="\0";)t+=Le(s.subarray(c,c+1)),c+=1;for(t+=Le(s.subarray(c,c+1)),c+=1;Le(s.subarray(c,c+1))!=="\0";)i+=Le(s.subarray(c,c+1)),c+=1;i+=Le(s.subarray(c,c+1)),c+=1,n=Q(s,12),r=Q(s,16),o=Q(s,20),l=Q(s,24),c=28}else if(e===1){c+=4,n=Q(s,c),c+=4;const d=Q(s,c);c+=4;const f=Q(s,c);for(c+=4,a=2**32*d+f,rg(a)||(a=Number.MAX_SAFE_INTEGER,Te.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=Q(s,c),c+=4,l=Q(s,c),c+=4;Le(s.subarray(c,c+1))!=="\0";)t+=Le(s.subarray(c,c+1)),c+=1;for(t+=Le(s.subarray(c,c+1)),c+=1;Le(s.subarray(c,c+1))!=="\0";)i+=Le(s.subarray(c,c+1)),c+=1;i+=Le(s.subarray(c,c+1)),c+=1}const u=s.subarray(c,s.byteLength);return{schemeIdUri:t,value:i,timeScale:n,presentationTime:a,presentationTimeDelta:r,eventDuration:o,id:l,payload:u}}function Lg(s,...e){const t=e.length;let i=8,n=t;for(;n--;)i+=e[n].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(s,4),n=0,i=8;n<t;n++)r.set(e[n],i),i+=e[n].byteLength;return r}function kg(s,e,t){if(s.byteLength!==16)throw new RangeError("Invalid system id");let i,n;i=0,n=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const a=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(a.buffer).setUint32(0,t.byteLength,!1),Lg([112,115,115,104],new Uint8Array([i,0,0,0]),s,r,n,a,t||new Uint8Array)}function Cg(s){const e=[];if(s instanceof ArrayBuffer){const t=s.byteLength;let i=0;for(;i+32<t;){const n=new DataView(s,i),r=Rg(n);e.push(r),i+=r.size}}return e}function Rg(s){const e=s.getUint32(0),t=s.byteOffset,i=s.byteLength;if(i<e)return{offset:t,size:i};if(s.getUint32(4)!==1886614376)return{offset:t,size:e};const r=s.getUint32(8)>>>24;if(r!==0&&r!==1)return{offset:t,size:e};const a=s.buffer,o=mt.hexDump(new Uint8Array(a,t+12,16)),l=s.getUint32(28);let c=null,u=null;if(r===0){if(e-32<l||l<22)return{offset:t,size:e};u=new Uint8Array(a,t+32,l)}else if(r===1){if(!l||i<t+32+l*16+16)return{offset:t,size:e};c=[];for(let d=0;d<l;d++)c.push(new Uint8Array(a,t+32+d*16,16))}return{version:r,systemId:o,kids:c,data:u,offset:t,size:e}}const Ru=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),jr={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Pg(s,e){const t=jr[e];return!!t&&!!t[s.slice(0,4)]}function Dg(s,e,t=!0){return!s.split(",").some(i=>!Pu(i,e,t))}function Pu(s,e,t=!0){var i;const n=Xi(t);return(i=n==null?void 0:n.isTypeSupported(Gr(s,e)))!=null?i:!1}function Gr(s,e){return`${e}/mp4;codecs=${s}`}function Du(s){const e=Ru();return s.split(",").reduce((t,i)=>{const r=e&&Js(i)?9:jr.video[i];return r?(r*2+t)/(t?3:2):(jr.audio[i]+t)/(t?2:1)},0)}const Vr={};function Og(s,e=!0){if(Vr[s])return Vr[s];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[s];for(let n=0;n<t.length;n++){var i;if(Pu(t[n],"audio",e))return Vr[s]=t[n],t[n];if(t[n]==="mp3"&&(i=Xi(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return s}const Mg=/flac|opus|mp4a\.40\.34/i;function qr(s,e=!0){return s.replace(Mg,t=>Og(t.toLowerCase(),e))}function Fg(s,e){const t=[];if(s){const i=s.split(",");for(let n=0;n<i.length;n++)Pg(i[n],"video")||t.push(i[n])}return e&&t.push(e),t.join(",")}function Kr(s,e){if(s&&(s.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(s)!==-1))return s;if(e){const t=e.split(",");if(t.length>1){if(s){for(let i=t.length;i--;)if(t[i].substring(0,4)===s.substring(0,4))return t[i]}return t[0]}}return e||s}function Ng(s){if(s.startsWith("av01.")){const e=s.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return s}function Ou(s){const e=Xi(s)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Mu(s){return s.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const Fu={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function Ug(s,e){return{supported:!1,configurations:e,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:s}}const Nu={};function Bg(s,e,t,i,n,r){const a=s.audioCodec?s.audioGroups:null,o=r==null?void 0:r.audioCodec,l=r==null?void 0:r.channels,c=l?parseInt(l):o?1/0:2;let u=null;if(a!=null&&a.length)try{a.length===1&&a[0]?u=e.groups[a[0]].channels:u=a.reduce((d,f)=>{if(f){const g=e.groups[f];if(!g)throw new Error(`Audio track group ${f} not found`);Object.keys(g.channels).forEach(p=>{d[p]=(d[p]||0)+g.channels[p]})}return d},{2:0})}catch{return!0}return s.videoCodec!==void 0&&(s.width>1920&&s.height>1088||s.height>1920&&s.width>1088||s.frameRate>Math.max(i,30)||s.videoRange!=="SDR"&&s.videoRange!==t||s.bitrate>Math.max(n,8e6))||!!u&&J(c)&&Object.keys(u).some(d=>parseInt(d)>c)}function $g(s,e,t){const i=s.videoCodec,n=s.audioCodec;if(!i&&!n||!t)return Promise.resolve(Fu);const r=[];if(i){const a={width:s.width,height:s.height,bitrate:Math.ceil(Math.max(s.bitrate*.9,s.averageBitrate)),framerate:s.frameRate||30},o=s.videoRange;o!=="SDR"&&(a.transferFunction=o.toLowerCase());const l=i.split(","),c=navigator.userAgent;if(l.some(u=>Js(u))&&Ru())return Promise.resolve(Ug(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: (${c})`),r));r.push.apply(r,l.map(u=>({type:"media-source",video:_e(_e({},a),{},{contentType:Gr(Ng(u),"video")})})))}return n&&s.audioGroups&&s.audioGroups.forEach(a=>{var o;a&&((o=e.groups[a])==null||o.tracks.forEach(l=>{if(l.groupId===a){const c=l.channels||"",u=parseFloat(c);J(u)&&u>2&&r.push.apply(r,n.split(",").map(d=>({type:"media-source",audio:{contentType:Gr(d,"audio"),channels:""+u}})))}}))}),Promise.all(r.map(a=>{const o=jg(a);return Nu[o]||(Nu[o]=t.decodingInfo(a))})).then(a=>({supported:!a.some(o=>!o.supported),configurations:r,decodingInfoResults:a})).catch(a=>({supported:!1,configurations:r,decodingInfoResults:[],error:a}))}function jg(s){const{audio:e,video:t}=s,i=t||e;if(i){const n=Mu(i.contentType);if(t)return`r${t.height}x${t.width}f${Math.ceil(t.framerate)}${t.transferFunction||"sd"}_${n}_${Math.ceil(t.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${n}`}return""}const Uu=["NONE","TYPE-0","TYPE-1",null],Gg=["SDR","PQ","HLG"];var Qs={No:"",Yes:"YES",v2:"v2"};function Bu(s){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=s,n=i<e/2;return e&&n?t?Qs.v2:Qs.Yes:Qs.No}class $u{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Xs{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return ju(this._audioGroups,e)}hasSubtitleGroup(e){return ju(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function ju(s,e){return!e||!s?!1:s.indexOf(e)!==-1}function Vg(){if(typeof matchMedia=="function"){const s=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(s.media!==e.media)return s.matches===!0}return!1}function qg(s,e){let t=!1,i=[];if(s&&(t=s!=="SDR",i=[s]),e){i=e.allowedVideoRanges||Gg.slice(0);const n=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:n&&Vg(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}const Kg=s=>{const e=new WeakSet;return(t,i)=>{if(s&&(i=s(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},we=(s,e)=>JSON.stringify(s,Kg(e));function Hg(s,e,t,i,n){const r=Object.keys(s),a=i==null?void 0:i.channels,o=i==null?void 0:i.audioCodec,l=n==null?void 0:n.videoCodec,c=a&&parseInt(a)===2;let u=!1,d=!1,f=1/0,g=1/0,p=1/0,v=1/0,S=0,b=[];const{preferHDR:I,allowedVideoRanges:w}=qg(e,n);for(let k=r.length;k--;){const D=s[r[k]];u||(u=D.channels[2]>0),f=Math.min(f,D.minHeight),g=Math.min(g,D.minFramerate),p=Math.min(p,D.minBitrate),w.filter(N=>D.videoRanges[N]>0).length>0&&(d=!0)}f=J(f)?f:0,g=J(g)?g:0;const _=Math.max(1080,f),T=Math.max(30,g);p=J(p)?p:t,t=Math.max(p,t),d||(e=void 0);const C=r.length>1;return{codecSet:r.reduce((k,D)=>{const R=s[D];if(D===k)return k;if(b=d?w.filter(N=>R.videoRanges[N]>0):[],C){if(R.minBitrate>t)return yt(D,`min bitrate of ${R.minBitrate} > current estimate of ${t}`),k;if(!R.hasDefaultAudio)return yt(D,"no renditions with default or auto-select sound found"),k;if(o&&D.indexOf(o.substring(0,4))%5!==0)return yt(D,`audio codec preference "${o}" not found`),k;if(a&&!c){if(!R.channels[a])return yt(D,`no renditions with ${a} channel sound found (channels options: ${Object.keys(R.channels)})`),k}else if((!o||c)&&u&&R.channels[2]===0)return yt(D,"no renditions with stereo sound found"),k;if(R.minHeight>_)return yt(D,`min resolution of ${R.minHeight} > maximum of ${_}`),k;if(R.minFramerate>T)return yt(D,`min framerate of ${R.minFramerate} > maximum of ${T}`),k;if(!b.some(N=>R.videoRanges[N]>0))return yt(D,`no variants with VIDEO-RANGE of ${we(b)} found`),k;if(l&&D.indexOf(l.substring(0,4))%5!==0)return yt(D,`video codec preference "${l}" not found`),k;if(R.maxScore<S)return yt(D,`max score of ${R.maxScore} < selected max of ${S}`),k}return k&&(Du(D)>=Du(k)||R.fragmentError>s[k].fragmentError)?k:(v=R.minIndex,S=R.maxScore,D)},void 0),videoRanges:b,preferHDR:I,minFramerate:g,minBitrate:p,minIndex:v}}function yt(s,e){Te.log(`[abr] start candidates with "${s}" ignored because ${e}`)}function Yg(s){return s.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const n=t.channels||"2";return i.channels[n]=(i.channels[n]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Wg(s,e,t,i){return s.slice(t,i+1).reduce((n,r,a)=>{if(!r.codecSet)return n;const o=r.audioGroups;let l=n[r.codecSet];l||(n[r.codecSet]=l={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:a,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!o,fragmentError:0}),l.minBitrate=Math.min(l.minBitrate,r.bitrate);const c=Math.min(r.height,r.width);return l.minHeight=Math.min(l.minHeight,c),l.minFramerate=Math.min(l.minFramerate,r.frameRate),l.minIndex=Math.min(l.minIndex,a),l.maxScore=Math.max(l.maxScore,r.score),l.fragmentError+=r.fragmentError,l.videoRanges[r.videoRange]=(l.videoRanges[r.videoRange]||0)+1,o&&o.forEach(u=>{if(!u)return;const d=e.groups[u];d&&(l.hasDefaultAudio=l.hasDefaultAudio||e.hasDefaultAudio?d.hasDefault:d.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(d.channels).forEach(f=>{l.channels[f]=(l.channels[f]||0)+d.channels[f]}))}),n},{})}function Gu(s){if(!s)return s;const{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:r}=s;return{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:r}}function St(s,e,t){if("attrs"in s){const i=e.indexOf(s);if(i!==-1)return i}for(let i=0;i<e.length;i++){const n=e[i];if(ui(s,n,t))return i}return-1}function ui(s,e,t){const{groupId:i,name:n,lang:r,assocLang:a,default:o}=s,l=s.forced;return(i===void 0||e.groupId===i)&&(n===void 0||e.name===n)&&(r===void 0||zg(r,e.lang))&&(r===void 0||e.assocLang===a)&&(o===void 0||e.default===o)&&(l===void 0||e.forced===l)&&(!("characteristics"in s)||Jg(s.characteristics||"",e.characteristics))&&(t===void 0||t(s,e))}function zg(s,e="--"){return s.length===e.length?s===e:s.startsWith(e)||e.startsWith(s)}function Jg(s,e=""){const t=s.split(","),i=e.split(",");return t.length===i.length&&!t.some(n=>i.indexOf(n)===-1)}function di(s,e){const{audioCodec:t,channels:i}=s;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function Qg(s,e,t,i,n){const r=e[i],o=e.reduce((f,g,p)=>{const v=g.uri;return(f[v]||(f[v]=[])).push(p),f},{})[r.uri];o.length>1&&(i=Math.max.apply(Math,o));const l=r.videoRange,c=r.frameRate,u=r.codecSet.substring(0,4),d=Vu(e,i,f=>{if(f.videoRange!==l||f.frameRate!==c||f.codecSet.substring(0,4)!==u)return!1;const g=f.audioGroups,p=t.filter(v=>!g||g.indexOf(v.groupId)!==-1);return St(s,p,n)>-1});return d>-1?d:Vu(e,i,f=>{const g=f.audioGroups,p=t.filter(v=>!g||g.indexOf(v.groupId)!==-1);return St(s,p,n)>-1})}function Vu(s,e,t){for(let i=e;i>-1;i--)if(t(s[i]))return i;for(let i=e+1;i<s.length;i++)if(t(s[i]))return i;return-1}function qu(s,e){var t;return!!s&&s!==((t=e.loadLevelObj)==null?void 0:t.uri)}class Xg extends Rt{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;const{fragCurrent:n,partCurrent:r,hls:a}=this,{autoLevelEnabled:o,media:l}=a;if(!n||!l)return;const c=performance.now(),u=r?r.stats:n.stats,d=r?r.duration:n.duration,f=c-u.loading.start,g=a.minAutoLevel,p=n.level,v=this._nextAutoLevel;if(u.aborted||u.loaded&&u.loaded===u.total||p<=g){this.clearTimer(),this._nextAutoLevel=-1;return}if(!o)return;const S=v>-1&&v!==p,b=!!t||S;if(!b&&(l.paused||!l.playbackRate||!l.readyState))return;const I=a.mainForwardBufferInfo;if(!b&&I===null)return;const w=this.bwEstimator.getEstimateTTFB(),_=Math.abs(l.playbackRate);if(f<=Math.max(w,1e3*(d/(_*2))))return;const T=I?I.len/_:0,C=u.loading.first?u.loading.first-u.loading.start:-1,A=u.loaded&&C>-1,k=this.getBwEstimate(),D=a.levels,R=D[p],N=Math.max(u.loaded,Math.round(d*(n.bitrate||R.averageBitrate)/8));let V=A?f-C:f;V<1&&A&&(V=Math.min(f,u.loaded*8/k));const W=A?u.loaded*1e3/V:0,q=w/1e3,ee=W?(N-u.loaded)/W:N*8/k+q;if(ee<=T)return;const z=W?W*8:k,K=((i=(t==null?void 0:t.details)||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,pe=this.hls.config.abrBandWidthUpFactor;let G=Number.POSITIVE_INFINITY,B;for(B=p-1;B>g;B--){const y=D[B].maxBitrate,m=!D[B].details||K;if(G=this.getTimeToLoadFrag(q,z,d*y,m),G<Math.min(T,d+q))break}if(G>=ee||G>d*10)return;A?this.bwEstimator.sample(f-Math.min(w,C),u.loaded):this.bwEstimator.sampleTTFB(f);const ie=D[B].maxBitrate;this.getBwEstimate()*pe>ie&&this.resetEstimator(ie);const X=this.findBestLevel(ie,g,B,0,T,1,1);X>-1&&(B=X),this.warn(`Fragment ${n.sn}${r?" part "+r.index:""} of level ${p} is loading too slowly;
      Fragment duration: ${n.duration.toFixed(3)}
      Time to underbuffer: ${T.toFixed(3)} s
      Estimated load time for current fragment: ${ee.toFixed(3)} s
      Estimated load time for down switch fragment: ${G.toFixed(3)} s
      TTFB estimate: ${C|0} ms
      Current BW estimate: ${J(k)?k|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${B} @ ${ie|0} bps`),a.nextLoadLevel=a.nextAutoLevel=B,this.clearTimer();const h=()=>{if(this.clearTimer(),this.fragCurrent===n&&this.hls.loadLevel===B&&B>0){const y=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${B>0?"and switching down":""}
      Fragment duration: ${n.duration.toFixed(3)} s
      Time to underbuffer: ${y.toFixed(3)} s`),n.abortRequests(),this.fragCurrent=this.partCurrent=null,B>g){let m=this.findBestLevel(this.hls.levels[g].bitrate,g,B,0,y,1,1);m===-1&&(m=g),this.hls.nextLoadLevel=this.hls.nextAutoLevel=m,this.resetEstimator(this.hls.levels[m].bitrate)}}};S||ee>G*2?h():this.timer=self.setInterval(h,G*1e3),a.trigger(E.FRAG_LOAD_EMERGENCY_ABORTED,{frag:n,part:r,stats:u})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new og(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.FRAG_LOADING,this.onFragLoading,this),e.on(E.FRAG_LOADED,this.onFragLoaded,this),e.on(E.FRAG_BUFFERED,this.onFragBuffered,this),e.on(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(E.LEVEL_LOADED,this.onLevelLoaded,this),e.on(E.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(E.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.FRAG_LOADING,this.onFragLoading,this),e.off(E.FRAG_LOADED,this.onFragLoaded,this),e.off(E.FRAG_BUFFERED,this.onFragBuffered,this),e.off(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(E.LEVEL_LOADED,this.onLevelLoaded,this),e.off(E.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(E.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(E.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var n;this.fragCurrent=i,this.partCurrent=(n=t.part)!=null?n:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case M.BUFFER_ADD_CODEC_ERROR:case M.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case M.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:n,partCurrent:r}=this;if(i&&n&&i.sn===n.sn&&i.level===n.level){const a=performance.now(),o=r?r.stats:i.stats,l=a-o.loading.start,c=o.loading.first?o.loading.first-o.loading.start:-1;if(o.loaded&&c>-1){const d=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(d,c),o.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(e,t,i,n){const r=e+i/t,a=n?e+this.lastLevelLoadSec:0;return r+a}onLevelLoaded(e,t){const i=this.hls.config,{loading:n}=t.stats,r=n.end-n.first;J(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const n=i?i.stats:t.stats;if(t.type===oe.MAIN&&this.bwEstimator.sampleTTFB(n.loading.first-n.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,a=this.hls.levels[t.level],o=(a.loaded?a.loaded.bytes:0)+n.loaded,l=(a.loaded?a.loaded.duration:0)+r;a.loaded={bytes:o,duration:l},a.realBitrate=Math.round(8*o/l)}if(t.bitrateTest){const r={stats:n,frag:t,part:i,id:t.type};this.onFragBuffered(E.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:n}=t,r=n!=null&&n.stats.loaded?n.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const a=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==oe.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),n=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,n,1,1);if(r>-1)return r;const a=this.hls.firstLevel,o=Math.min(Math.max(a,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!n||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const r=i&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const a=this.hls.levels;if(a.length>Math.max(e,r)&&a[e].loadError<=a[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:n,config:r,minAutoLevel:a}=i,o=t?t.duration:e?e.duration:0,l=this.getBwEstimate(),c=this.getStarvationDelay();let u=r.abrBandWidthFactor,d=r.abrBandWidthUpFactor;if(c){const S=this.findBestLevel(l,a,n,c,0,u,d);if(S>=0)return this.rebufferNotice=-1,S}let f=o?Math.min(o,r.maxStarvationDelay):r.maxStarvationDelay;if(!c){const S=this.bitrateTestDelay;S&&(f=(o?Math.min(o,r.maxLoadingDelay):r.maxLoadingDelay)-S,this.info(`bitrate test took ${Math.round(1e3*S)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),u=d=1)}const g=this.findBestLevel(l,a,n,c,f,u,d);if(this.rebufferNotice!==g&&(this.rebufferNotice=g,this.info(`${c?"rebuffering expected":"buffer is empty"}, optimal quality level ${g}`)),g>-1)return g;const p=i.levels[a],v=i.loadLevelObj;return v&&(p==null?void 0:p.bitrate)<v.bitrate?a:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,n=e.mainForwardBufferInfo;return(n?n.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,n,r,a,o){var l;const c=n+r,u=this.lastLoadedFragLevel,d=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:g}=this,{levels:p,allAudioTracks:v,loadLevel:S,config:b}=this.hls;if(p.length===1)return 0;const I=p[d],w=!!((l=this.hls.latestLevelDetails)!=null&&l.live),_=S===-1||u===-1;let T,C="SDR",A=(I==null?void 0:I.frameRate)||0;const{audioPreference:k,videoPreference:D}=b,R=this.audioTracksByGroup||(this.audioTracksByGroup=Yg(v));let N=-1;if(_){if(this.firstSelection!==-1)return this.firstSelection;const z=this.codecTiers||(this.codecTiers=Wg(p,R,t,i)),K=Hg(z,C,e,k,D),{codecSet:pe,videoRanges:G,minFramerate:B,minBitrate:ie,minIndex:X,preferHDR:h}=K;N=X,T=pe,C=h?G[G.length-1]:G[0],A=B,e=Math.max(e,ie),this.log(`picked start tier ${we(K)}`)}else T=I==null?void 0:I.codecSet,C=I==null?void 0:I.videoRange;const V=g?g.duration:f?f.duration:0,W=this.bwEstimator.getEstimateTTFB()/1e3,q=[];for(let z=i;z>=t;z--){var ee;const K=p[z],pe=z>d;if(!K)continue;if(b.useMediaCapabilities&&!K.supportedResult&&!K.supportedPromise){const m=navigator.mediaCapabilities;typeof(m==null?void 0:m.decodingInfo)=="function"&&(Bg(K,R,C,A,e,k)||Js(K.videoCodec))?(K.supportedPromise=$g(K,R,m),K.supportedPromise.then(x=>{if(!this.hls)return;K.supportedResult=x;const L=this.hls.levels,O=L.indexOf(K);x.error?this.warn(`MediaCapabilities decodingInfo error: "${x.error}" for level ${O} ${we(x)}`):x.supported||(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${O} ${we(x)}`),O>-1&&L.length>1&&(this.log(`Removing unsupported level ${O}`),this.hls.removeLevel(O),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))})):K.supportedResult=Fu}if((T&&K.codecSet!==T||C&&K.videoRange!==C||pe&&A>K.frameRate||!pe&&A>0&&A<K.frameRate||K.supportedResult&&!((ee=K.supportedResult.decodingInfoResults)!=null&&ee[0].smooth))&&(!_||z!==N)){q.push(z);continue}const G=K.details,B=(g?G==null?void 0:G.partTarget:G==null?void 0:G.averagetargetduration)||V;let ie;pe?ie=o*e:ie=a*e;const X=V&&n>=V*2&&r===0?K.averageBitrate:K.maxBitrate,h=this.getTimeToLoadFrag(W,ie,X*B,G===void 0);if(ie>=X&&(z===u||K.loadError===0&&K.fragmentError===0)&&(h<=W||!J(h)||w&&!this.bitrateTestDelay||h<c)){const m=this.forcedAutoLevel;return z!==S&&(m===-1||m!==S)&&(q.length&&this.trace(`Skipped level(s) ${q.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${p[q[0]].codecs}" ${p[q[0]].videoRange}; not compatible with "${T}" ${C}`),this.info(`switch candidate:${d}->${z} adjustedbw(${Math.round(ie)})-bitrate=${Math.round(ie-X)} ttfb:${W.toFixed(1)} avgDuration:${B.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${h.toFixed(1)} firstSelection:${_} codecSet:${K.codecSet} videoRange:${K.videoRange} hls.loadLevel:${S}`)),_&&(this.firstSelection=z),z}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}}const Ku={search:function(s,e){let t=0,i=s.length-1,n=null,r=null;for(;t<=i;){n=(t+i)/2|0,r=s[n];const a=e(r);if(a>0)t=n+1;else if(a<0)i=n-1;else return r}return null}};function Zg(s,e,t){if(e===null||!Array.isArray(s)||!s.length||!J(e))return null;const i=s[0].programDateTime;if(e<(i||0))return null;const n=s[s.length-1].endProgramDateTime;if(e>=(n||0))return null;for(let r=0;r<s.length;++r){const a=s[r];if(tm(e,t,a))return a}return null}function Li(s,e,t=0,i=0,n=.005){let r=null;if(s){r=e[1+s.sn-e[0].sn]||null;const o=s.endDTS-t;o>0&&o<15e-7&&(t+=15e-7),r&&s.level!==r.level&&r.end<=s.end&&(r=e[2+s.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(r=e[0]);if(r&&((!s||s.level===r.level)&&Hu(t,i,r)===0||em(r,s,Math.min(n,i))))return r;const a=Ku.search(e,Hu.bind(null,t,i));return a&&(a!==s||!r)?a:r}function em(s,e,t){if(e&&e.start===0&&e.level<s.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((n,r)=>(r[0]==="INF"&&(n+=parseFloat(r[1])),n),t);return s.start<=i}return!1}function Hu(s=0,e=0,t){if(t.start<=s&&t.start+t.duration>s)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=s?1:t.start-i>s&&t.start?-1:0}function tm(s,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>s}function Yu(s,e,t){if(s&&s.startCC<=e&&s.endCC>=e){let i=s.fragments;const{fragmentHint:n}=s;n&&(i=i.concat(n));let r;return Ku.search(i,a=>a.cc<e?1:a.cc>e?-1:(r=a,a.end<=t?1:a.start>t?-1:0)),r||null}return null}function Zs(s){switch(s.details){case M.FRAG_LOAD_TIMEOUT:case M.KEY_LOAD_TIMEOUT:case M.LEVEL_LOAD_TIMEOUT:case M.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Wu(s,e){const t=Zs(e);return s.default[`${t?"timeout":"error"}Retry`]}function Hr(s,e){const t=s.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*s.retryDelayMs,s.maxRetryDelayMs)}function zu(s){return _e(_e({},s),{errorRetry:null,timeoutRetry:null})}function en(s,e,t,i){if(!s)return!1;const n=i==null?void 0:i.code,r=e<s.maxNumRetry&&(im(n)||!!t);return s.shouldRetry?s.shouldRetry(s,e,t,i,r):r}function im(s){return s===0&&navigator.onLine===!1||!!s&&(s<400||s>499)}var Oe={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},ut={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2};class sm extends Rt{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(E.ERROR,this.onError,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(E.ERROR,this.onError,this),e.off(E.ERROR,this.onErrorOut,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===oe.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const n=this.hls,r=t.context;switch(t.details){case M.FRAG_LOAD_ERROR:case M.FRAG_LOAD_TIMEOUT:case M.KEY_LOAD_ERROR:case M.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case M.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=Zi();return}case M.FRAG_GAP:case M.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=Oe.SendAlternateToPenaltyBox;return}case M.LEVEL_EMPTY_ERROR:case M.LEVEL_PARSING_ERROR:{var a,o;const c=t.parent===oe.MAIN?t.level:n.loadLevel;t.details===M.LEVEL_EMPTY_ERROR&&((a=t.context)!=null&&(o=a.levelDetails)!=null&&o.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,c):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,c))}return;case M.LEVEL_LOAD_ERROR:case M.LEVEL_LOAD_TIMEOUT:typeof(r==null?void 0:r.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.level));return;case M.AUDIO_TRACK_LOAD_ERROR:case M.AUDIO_TRACK_LOAD_TIMEOUT:case M.SUBTITLE_LOAD_ERROR:case M.SUBTITLE_TRACK_LOAD_TIMEOUT:if(r){const c=n.loadLevelObj;if(c&&(r.type===Ct.AUDIO_TRACK&&c.hasAudioGroup(r.groupId)||r.type===Ct.SUBTITLE_TRACK&&c.hasSubtitleGroup(r.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.loadLevel),t.errorAction.action=Oe.SendAlternateToPenaltyBox,t.errorAction.flags=ut.MoveAllAlternatesMatchingHost;return}}return;case M.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const c=n.loadLevelObj,u=c==null?void 0:c.attrs["HDCP-LEVEL"];u?t.errorAction={action:Oe.SendAlternateToPenaltyBox,flags:ut.MoveAllAlternatesMatchingHDCP,hdcpLevel:u}:this.keySystemError(t)}return;case M.BUFFER_ADD_CODEC_ERROR:case M.REMUX_ALLOC_ERROR:case M.BUFFER_APPEND_ERROR:if(!t.errorAction){var l;t.errorAction=this.getLevelSwitchAction(t,(l=t.level)!=null?l:n.loadLevel)}return;case M.INTERNAL_EXCEPTION:case M.BUFFER_APPENDING_ERROR:case M.BUFFER_FULL_ERROR:case M.LEVEL_SWITCH_ERROR:case M.BUFFER_STALLED_ERROR:case M.BUFFER_SEEK_OVER_HOLE:case M.BUFFER_NUDGE_ON_STALL:t.errorAction=Zi();return}t.type===te.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,n=Wu(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(en(n,r,Zs(e),e.response))return{action:Oe.RetryRequest,flags:ut.None,retryConfig:n,retryCount:r};const o=this.getLevelSwitchAction(e,t);return n&&(o.retryConfig=n,o.retryCount=r),o}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),n=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:a}=t.config,o=Wu(e.details.startsWith("key")?a:r,e),l=t.levels.reduce((u,d)=>u+d.fragmentError,0);if(n&&(e.details!==M.FRAG_GAP&&n.fragmentError++,en(o,l,Zs(e),e.response)))return{action:Oe.RetryRequest,flags:ut.None,retryConfig:o,retryCount:l};const c=this.getLevelSwitchAction(e,i);return o&&(c.retryConfig=o,c.retryCount=l),c}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const n=this.hls.levels[t];if(n){var r,a;const c=e.details;n.loadError++,c===M.BUFFER_APPEND_ERROR&&n.fragmentError++;let u=-1;const{levels:d,loadLevel:f,minAutoLevel:g,maxAutoLevel:p}=i;!i.autoLevelEnabled&&!i.config.preserveManualLevelOnError&&(i.loadLevel=-1);const v=(r=e.frag)==null?void 0:r.type,b=(v===oe.AUDIO&&c===M.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(c===M.BUFFER_ADD_CODEC_ERROR||c===M.BUFFER_APPEND_ERROR))&&d.some(({audioCodec:C})=>n.audioCodec!==C),w=e.sourceBufferName==="video"&&(c===M.BUFFER_ADD_CODEC_ERROR||c===M.BUFFER_APPEND_ERROR)&&d.some(({codecSet:C,audioCodec:A})=>n.codecSet!==C&&n.audioCodec===A),{type:_,groupId:T}=(a=e.context)!=null?a:{};for(let C=d.length;C--;){const A=(C+f)%d.length;if(A!==f&&A>=g&&A<=p&&d[A].loadError===0){var o,l;const k=d[A];if(c===M.FRAG_GAP&&v===oe.MAIN&&e.frag){const D=d[A].details;if(D){const R=Li(e.frag,D.fragments,e.frag.start);if(R!=null&&R.gap)continue}}else{if(_===Ct.AUDIO_TRACK&&k.hasAudioGroup(T)||_===Ct.SUBTITLE_TRACK&&k.hasSubtitleGroup(T))continue;if(v===oe.AUDIO&&(o=n.audioGroups)!=null&&o.some(D=>k.hasAudioGroup(D))||v===oe.SUBTITLE&&(l=n.subtitleGroups)!=null&&l.some(D=>k.hasSubtitleGroup(D))||b&&n.audioCodec===k.audioCodec||!b&&n.audioCodec!==k.audioCodec||w&&n.codecSet===k.codecSet)continue}u=A;break}}if(u>-1&&i.loadLevel!==u)return e.levelRetry=!0,this.playlistError=0,{action:Oe.SendAlternateToPenaltyBox,flags:ut.None,nextAutoLevel:u}}return{action:Oe.SendAlternateToPenaltyBox,flags:ut.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case Oe.DoNothing:break;case Oe.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==M.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:n,hdcpLevel:r,nextAutoLevel:a}=i;switch(n){case ut.None:this.switchLevel(e,a);break;case ut.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=Uu[Uu.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,a)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===M.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const i=Mu(e.mimeType),n=this.hls.levels;for(let r=n.length;r--;)n[r][`${e.sourceBufferName}Codec`]===i&&this.hls.removeLevel(r)}}}function Zi(s){const e={action:Oe.DoNothing,flags:ut.None};return s&&(e.resolved=!0),e}var it={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"},jt={cbc:0,ctr:1};class nm{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case jt.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case jt.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function rm(s){const e=s.byteLength,t=e&&new DataView(s.buffer).getUint8(e-1);return t?s.slice(0,e-t):s}class am{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let n=0;n<4;n++)i[n]=t.getUint32(n*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,n=i[0],r=i[1],a=i[2],o=i[3],l=this.invSubMix,c=l[0],u=l[1],d=l[2],f=l[3],g=new Uint32Array(256);let p=0,v=0,S=0;for(S=0;S<256;S++)S<128?g[S]=S<<1:g[S]=S<<1^283;for(S=0;S<256;S++){let b=v^v<<1^v<<2^v<<3^v<<4;b=b>>>8^b&255^99,e[p]=b,t[b]=p;const I=g[p],w=g[I],_=g[w];let T=g[b]*257^b*16843008;n[p]=T<<24|T>>>8,r[p]=T<<16|T>>>16,a[p]=T<<8|T>>>24,o[p]=T,T=_*16843009^w*65537^I*257^p*16843008,c[b]=T<<24|T>>>8,u[b]=T<<16|T>>>16,d[b]=T<<8|T>>>24,f[b]=T,p?(p=I^g[g[g[_^I]]],v^=g[g[v]]):p=v=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,n=0;for(;n<t.length&&i;)i=t[n]===this.key[n],n++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const a=this.ksRows=(r+6+1)*4;let o,l;const c=this.keySchedule=new Uint32Array(a),u=this.invKeySchedule=new Uint32Array(a),d=this.sBox,f=this.rcon,g=this.invSubMix,p=g[0],v=g[1],S=g[2],b=g[3];let I,w;for(o=0;o<a;o++){if(o<r){I=c[o]=t[o];continue}w=I,o%r===0?(w=w<<8|w>>>24,w=d[w>>>24]<<24|d[w>>>16&255]<<16|d[w>>>8&255]<<8|d[w&255],w^=f[o/r|0]<<24):r>6&&o%r===4&&(w=d[w>>>24]<<24|d[w>>>16&255]<<16|d[w>>>8&255]<<8|d[w&255]),c[o]=I=(c[o-r]^w)>>>0}for(l=0;l<a;l++)o=a-l,l&3?w=c[o]:w=c[o-4],l<4||o<=4?u[l]=w:u[l]=p[d[w>>>24]]^v[d[w>>>16&255]]^S[d[w>>>8&255]]^b[d[w&255]],u[l]=u[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const n=this.keySize+6,r=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,l=o[0],c=o[1],u=o[2],d=o[3],f=this.uint8ArrayToUint32Array_(i);let g=f[0],p=f[1],v=f[2],S=f[3];const b=new Int32Array(e),I=new Int32Array(b.length);let w,_,T,C,A,k,D,R,N,V,W,q,ee,z;const K=this.networkToHostOrderSwap;for(;t<b.length;){for(N=K(b[t]),V=K(b[t+1]),W=K(b[t+2]),q=K(b[t+3]),A=N^r[0],k=q^r[1],D=W^r[2],R=V^r[3],ee=4,z=1;z<n;z++)w=l[A>>>24]^c[k>>16&255]^u[D>>8&255]^d[R&255]^r[ee],_=l[k>>>24]^c[D>>16&255]^u[R>>8&255]^d[A&255]^r[ee+1],T=l[D>>>24]^c[R>>16&255]^u[A>>8&255]^d[k&255]^r[ee+2],C=l[R>>>24]^c[A>>16&255]^u[k>>8&255]^d[D&255]^r[ee+3],A=w,k=_,D=T,R=C,ee=ee+4;w=a[A>>>24]<<24^a[k>>16&255]<<16^a[D>>8&255]<<8^a[R&255]^r[ee],_=a[k>>>24]<<24^a[D>>16&255]<<16^a[R>>8&255]<<8^a[A&255]^r[ee+1],T=a[D>>>24]<<24^a[R>>16&255]<<16^a[A>>8&255]<<8^a[k&255]^r[ee+2],C=a[R>>>24]<<24^a[A>>16&255]<<16^a[k>>8&255]<<8^a[D&255]^r[ee+3],I[t]=K(w^g),I[t+1]=K(C^p),I[t+2]=K(T^v),I[t+3]=K(_^S),g=N,p=V,v=W,S=q,t=t+4}return I.buffer}}class om{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=lm(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function lm(s){switch(s){case jt.cbc:return"AES-CBC";case jt.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${s}`)}}const cm=16;class Yr{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?rm(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,n){return this.useSoftware?new Promise((r,a)=>{const o=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(o,t,i,n);const l=this.flush();l?r(l.buffer):a(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,n)}softwareDecrypt(e,t,i,n){const{currentIV:r,currentResult:a,remainderData:o}=this;if(n!==jt.cbc||t.byteLength!==16)return Te.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),o&&(e=tt(o,e),this.remainderData=null);const l=this.getValidChunk(e);if(!l.length)return null;r&&(i=r);let c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new am),c.expandKey(t);const u=a;return this.currentResult=c.decrypt(l.buffer,0,i),this.currentIV=l.slice(-16).buffer,u||null}webCryptoDecrypt(e,t,i,n){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,n));this.key=t,this.fastAesKey=new om(this.subtle,t,n)}return this.fastAesKey.expandKey().then(r=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new nm(this.subtle,new Uint8Array(i),n).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(Te.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i,n)))}onWebCryptoError(e,t,i,n){const r=this.enableSoftwareAES;if(r){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,n);const a=this.flush();if(a)return a.buffer}throw new Error("WebCrypto"+(r?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%cm;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(Te.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const Ju=Math.pow(2,17);class um{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new Gt({type:te.NETWORK_ERROR,details:M.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const n=this.config,r=n.fLoader,a=n.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(p=>p[0]==="GAP")){l(Xu(e));return}else e.gap=!1;const c=this.loader=r?new r(n):new a(n),u=Qu(e);e.loader=c;const d=zu(n.fragLoadPolicy.default),f={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:Ju};e.stats=c.stats;const g={onSuccess:(p,v,S,b)=>{this.resetLoader(e,c);let I=p.data;S.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(I.slice(0,16)),I=I.slice(16)),o({frag:e,part:null,payload:I,networkDetails:b})},onError:(p,v,S,b)=>{this.resetLoader(e,c),l(new Gt({type:te.NETWORK_ERROR,details:M.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:_e({url:i,data:void 0},p),error:new Error(`HTTP Error ${p.code} ${p.text}`),networkDetails:S,stats:b}))},onAbort:(p,v,S)=>{this.resetLoader(e,c),l(new Gt({type:te.NETWORK_ERROR,details:M.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:S,stats:p}))},onTimeout:(p,v,S)=>{this.resetLoader(e,c),l(new Gt({type:te.NETWORK_ERROR,details:M.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:S,stats:p}))}};t&&(g.onProgress=(p,v,S,b)=>t({frag:e,part:null,payload:S,networkDetails:b})),c.load(u,f,g)})}loadPart(e,t,i){this.abort();const n=this.config,r=n.fLoader,a=n.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(Xu(e,t));return}const c=this.loader=r?new r(n):new a(n),u=Qu(e,t);e.loader=c;const d=zu(n.fragLoadPolicy.default),f={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Ju};t.stats=c.stats,c.load(u,f,{onSuccess:(g,p,v,S)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const b={frag:e,part:t,payload:g.data,networkDetails:S};i(b),o(b)},onError:(g,p,v,S)=>{this.resetLoader(e,c),l(new Gt({type:te.NETWORK_ERROR,details:M.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:_e({url:u.url,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:v,stats:S}))},onAbort:(g,p,v)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),l(new Gt({type:te.NETWORK_ERROR,details:M.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:v,stats:g}))},onTimeout:(g,p,v)=>{this.resetLoader(e,c),l(new Gt({type:te.NETWORK_ERROR,details:M.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:v,stats:g}))}})})}updateStatsFromPart(e,t){const i=e.stats,n=t.stats,r=n.total;if(i.loaded+=n.loaded,r){const l=Math.round(e.duration/t.duration),c=Math.min(Math.round(i.loaded/r),l),d=(l-c)*Math.round(i.loaded/c);i.total=i.loaded+d}else i.total=Math.max(i.loaded,i.total);const a=i.loading,o=n.loading;a.start?a.first+=o.first-o.start:(a.start=o.start,a.first=o.first),a.end=o.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Qu(s,e=null){const t=e||s,i={frag:s,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},n=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(J(n)&&J(r)){var a;let o=n,l=r;if(s.sn==="initSegment"&&dm((a=s.decryptdata)==null?void 0:a.method)){const c=r-n;c%16&&(l=r+(16-c%16)),n!==0&&(i.resetIV=!0,o=n-16)}i.rangeStart=o,i.rangeEnd=l}return i}function Xu(s,e){const t=new Error(`GAP ${s.gap?"tag":"attribute"} found`),i={type:te.MEDIA_ERROR,details:M.FRAG_GAP,fatal:!1,frag:s,error:t,networkDetails:null};return e&&(i.part=e),(e||s).stats.aborted=!0,new Gt(i)}function dm(s){return s==="AES-128"||s==="AES-256"}class Gt extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class hm extends Rt{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Zu{constructor(e,t,i,n=0,r=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=tn(),this.buffering={audio:tn(),video:tn(),audiovideo:tn()},this.level=e,this.sn=t,this.id=i,this.size=n,this.part=r,this.partial=a}}function tn(){return{start:0,executeStart:0,executeEnd:0,end:0}}const ed={length:0,start:()=>0,end:()=>0};class ve{static isBuffered(e,t){if(e){const i=ve.getBuffered(e);for(let n=i.length;n--;)if(t>=i.start(n)&&t<=i.end(n))return!0}return!1}static bufferedRanges(e){if(e){const t=ve.getBuffered(e);return ve.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const n=ve.bufferedRanges(e);if(n.length)return ve.bufferedInfo(n,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((u,d)=>u.start-d.start||d.end-u.end);let n=-1,r=[];if(i)for(let u=0;u<e.length;u++){t>=e[u].start&&t<=e[u].end&&(n=u);const d=r.length;if(d){const f=r[d-1].end;e[u].start-f<i?e[u].end>f&&(r[d-1].end=e[u].end):r.push(e[u])}else r.push(e[u])}else r=e;let a=0,o,l=t,c=t;for(let u=0;u<r.length;u++){const d=r[u].start,f=r[u].end;if(n===-1&&t>=d&&t<=f&&(n=u),t+i>=d&&t<f)l=d,c=f,a=c-t;else if(t+i<d){o=d;break}}return{len:a,start:l||0,end:c||0,nextStart:o,buffered:e,bufferedIndex:n}}static getBuffered(e){try{return e.buffered||ed}catch(t){return Te.log("failed to get media.buffered",t),ed}}}const fm=/\{\$([a-zA-Z0-9-_]+)\}/g;function pm(s,e){if(s.variableList!==null||s.hasVariableRefs){const t=s.variableList;return e.replace(fm,i=>{const n=i.substring(2,i.length-1),r=t==null?void 0:t[n];return r===void 0?(s.playlistParsingError||(s.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${n}"`)),i):r})}return e}const gm=/^(\d+)x(\d+)$/,td=/(.+?)=(".*?"|.*?)(?:,|$)/g;class es{constructor(e,t){typeof e=="string"&&(e=es.parseAttrList(e,t)),Ae(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let n=0;n<t.length/2;n++)i[n]=parseInt(t.slice(n*2,n*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((n,r)=>(n[r.toLowerCase()]=!0,n),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=gm.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const n={},r='"';for(td.lastIndex=0;(i=td.exec(e))!==null;){const a=i[1].trim();let o=i[2];const l=o.indexOf(r)===0&&o.lastIndexOf(r)===o.length-1;let c=!1;if(l)o=o.slice(1,-1);else switch(a){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":c=!0}if(t&&(l||c))o=pm(t,o);else if(!c&&!l)switch(a){case"CLOSED-CAPTIONS":if(o==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":Te.warn(`${e}: attribute ${a} is missing quotes`)}n[a]=o}return n}}const mm="com.apple.hls.interstitial";class vm{constructor(e,t,i=0){var n;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(t==null?void 0:t.tagAnchor)||null,this.tagOrder=(n=t==null?void 0:t.tagOrder)!=null?n:i,t){const r=t.attr;for(const a in r)if(Object.prototype.hasOwnProperty.call(e,a)&&e[a]!==r[a]){Te.warn(`DATERANGE tag attribute: "${a}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=a;break}e=Ae(new es({}),r,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const r=(t==null?void 0:t.endDate)||new Date(this.attr["END-DATE"]);J(r.getTime())&&(this._endDate=r)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(Te.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(J(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===mm}get isValid(){return!!this.id&&!this._badValueForSameId&&J(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}function ki(s){return s==="AES-128"||s==="AES-256"||s==="AES-256-CTR"}function Wr(s){switch(s){case"AES-128":case"AES-256":return jt.cbc;case"AES-256-CTR":return jt.ctr;default:throw new Error(`invalid full segment method ${s}`)}}function zr(s){return Uint8Array.from(atob(s),e=>e.charCodeAt(0))}function Jr(s){return Uint8Array.from(unescape(encodeURIComponent(s)),e=>e.charCodeAt(0))}function ym(s){const e=Jr(s).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function Sm(s){const e=function(i,n,r){const a=i[n];i[n]=i[r],i[r]=a};e(s,0,3),e(s,1,2),e(s,4,5),e(s,6,7)}function Em(s){const e=s.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),n=i[i.length-1].split(",");if(n.length===2){const r=n[0]==="base64",a=n[1];r?(i.splice(-1,1),t=zr(a)):t=ym(a)}}return t}const sn=typeof self<"u"?self:void 0;var me={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},je={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Qr(s){switch(s){case je.FAIRPLAY:return me.FAIRPLAY;case je.PLAYREADY:return me.PLAYREADY;case je.WIDEVINE:return me.WIDEVINE;case je.CLEARKEY:return me.CLEARKEY}}var nn={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Xr(s){if(s===nn.WIDEVINE)return me.WIDEVINE;if(s===nn.PLAYREADY)return me.PLAYREADY;if(s===nn.CENC||s===nn.CLEARKEY)return me.CLEARKEY}function rn(s){switch(s){case me.FAIRPLAY:return je.FAIRPLAY;case me.PLAYREADY:return je.PLAYREADY;case me.WIDEVINE:return je.WIDEVINE;case me.CLEARKEY:return je.CLEARKEY}}function an(s){const{drmSystems:e,widevineLicenseUrl:t}=s,i=e?[me.FAIRPLAY,me.WIDEVINE,me.PLAYREADY,me.CLEARKEY].filter(n=>!!e[n]):[];return!i[me.WIDEVINE]&&t&&i.push(me.WIDEVINE),i}const id=function(s){return sn!=null&&(s=sn.navigator)!=null&&s.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function bm(s,e,t,i){let n;switch(s){case me.FAIRPLAY:n=["cenc","sinf"];break;case me.WIDEVINE:case me.PLAYREADY:n=["cenc"];break;case me.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${s}`)}return Tm(n,e,t,i)}function Tm(s,e,t,i){return[{initDataTypes:s,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs=${r}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs=${r}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function _m(s){var e;return s.sessionType==="persistent-license"||!!((e=s.sessionTypes)!=null&&e.some(t=>t==="persistent-license"))}function sd(s){const e=new Uint16Array(s.buffer,s.byteOffset,s.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),a=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(a){const o=a.childNodes[0]?a.childNodes[0].nodeValue:a.getAttribute("VALUE");if(o){const l=zr(o).subarray(0,16);return Sm(l),l}}return null}let on={};class ln{static clearKeyUriToKeyIdMap(){on={}}constructor(e,t,i,n=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=n,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!ki(e)}isSupported(){if(this.method){if(ki(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case je.FAIRPLAY:case je.WIDEVINE:case je.PLAYREADY:case je.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(ki(this.method)&&this.uri&&!this.iv){typeof e!="number"&&(Te.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=xm(e);return new ln(this.method,this.uri,"identity",this.keyFormatVersions,i)}const t=Em(this.uri);if(t)switch(this.keyFormat){case je.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case je.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=kg(i,null,t),this.keyId=sd(t);break}default:{let i=t.subarray(0,16);if(i.length!==16){const n=new Uint8Array(16);n.set(i,16-i.length),i=n}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=on[this.uri];if(!i){const n=Object.keys(on).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,n),on[this.uri]=i}this.keyId=i}return this}}function xm(s){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=s>>8*(15-t)&255;return e}function Am(s,e){const t=s.length,i=s[t-1],n=e.live?1/0:e.totalduration,r=Object.keys(e.dateRanges);for(let a=r.length;a--;){const o=e.dateRanges[r[a]],l=o.startDate.getTime();o.tagAnchor=i.ref;for(let c=t;c--;){const u=Im(e,l,s,c,n);if(u!==-1){o.tagAnchor=e.fragments[u].ref;break}}}}function Im(s,e,t,i,n){const r=t[i];if(r){const o=r.programDateTime;if(e>=o||i===0){var a;const l=(((a=t[i+1])==null?void 0:a.start)||n)-r.start;if(e<=o+l*1e3){const c=t[i].sn-s.startSN,u=s.fragments;if(u.length>t.length){const f=(t[i+1]||u[u.length-1]).sn-s.startSN;for(let g=f;g>c;g--){const p=u[g].programDateTime;if(e>=p&&e<p+u[g].duration*1e3)return g}}return c}}}return-1}function wm(s,e,t){s.rawProgramDateTime?t.push(s):e!=null&&e.programDateTime&&(s.programDateTime=e.endProgramDateTime)}function Zr(s,e){const t=e.startPTS;if(J(t)){let i=0,n;e.sn>s.sn?(i=t-s.start,n=s):(i=s.start-t,n=e),n.duration!==i&&n.setDuration(i)}else e.sn>s.sn?s.cc===e.cc&&s.minEndPTS?e.setStart(s.start+(s.minEndPTS-s.start)):e.setStart(s.start+s.duration):e.setStart(Math.max(s.start-e.duration,0))}function nd(s,e,t,i,n,r){i-t<=0&&(Te.warn("Fragment should have a positive duration",e),i=t+e.duration,r=n+e.duration);let o=t,l=i;const c=e.startPTS,u=e.endPTS;if(J(c)){const S=Math.abs(c-t);J(e.deltaPTS)?e.deltaPTS=Math.max(S,e.deltaPTS):e.deltaPTS=S,o=Math.max(t,c),t=Math.min(t,c),n=Math.min(n,e.startDTS),l=Math.min(i,u),i=Math.max(i,u),r=Math.max(r,e.endDTS)}const d=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=o,e.startDTS=n,e.endPTS=i,e.minEndPTS=l,e.endDTS=r;const f=e.sn;if(!s||f<s.startSN||f>s.endSN)return 0;let g;const p=f-s.startSN,v=s.fragments;for(v[p]=e,g=p;g>0;g--)Zr(v[g],v[g-1]);for(g=p;g<v.length-1;g++)Zr(v[g],v[g+1]);return s.fragmentHint&&Zr(v[v.length-1],s.fragmentHint),s.PTSKnown=s.alignedSliding=!0,d}function Lm(s,e){if(s===e)return;let t=null;const i=s.fragments;for(let l=i.length-1;l>=0;l--){const c=i[l].initSegment;if(c){t=c;break}}s.fragmentHint&&delete s.fragmentHint.endPTS;let n;Rm(s,e,(l,c,u,d)=>{if(!e.startCC&&c.cc!==l.cc){var f,g;const p=l.cc-c.cc;for(let v=u;v<d.length;v++)d[v].cc+=p;e.startCC=(f=(g=od(s,e.startSN-1))==null?void 0:g.cc)!=null?f:d[0].cc,e.endCC=d[d.length-1].cc}J(l.startPTS)&&J(l.endPTS)&&(c.setStart(c.startPTS=l.startPTS),c.startDTS=l.startDTS,c.maxStartPTS=l.maxStartPTS,c.endPTS=l.endPTS,c.endDTS=l.endDTS,c.minEndPTS=l.minEndPTS,c.setDuration(l.endPTS-l.startPTS),c.duration&&(n=c),e.PTSKnown=e.alignedSliding=!0),l.hasStreams&&(c.elementaryStreams=l.elementaryStreams),c.loader=l.loader,l.hasStats&&(c.stats=l.stats),l.initSegment&&(c.initSegment=l.initSegment,t=l.initSegment)});const r=e.fragments,a=e.fragmentHint?r.concat(e.fragmentHint):r;if(t&&a.forEach(l=>{var c;l&&(!l.initSegment||l.initSegment.relurl===((c=t)==null?void 0:c.relurl))&&(l.initSegment=t)}),e.skippedSegments)if(e.deltaUpdateFailed=r.some(l=>!l),e.deltaUpdateFailed){Te.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=e.skippedSegments;l--;)r.shift();e.startSN=r[0].sn}else{e.endCC=r[r.length-1].cc,e.canSkipDateRanges&&(e.dateRanges=km(s.dateRanges,e));const l=s.fragments.filter(c=>c.rawProgramDateTime);if(s.hasProgramDateTime&&!e.hasProgramDateTime)for(let c=1;c<a.length;c++)a[c].programDateTime===null&&wm(a[c],a[c-1],l);Am(l,e)}Cm(s.partList,e.partList,(l,c)=>{c.elementaryStreams=l.elementaryStreams,c.stats=l.stats}),n?nd(e,n,n.startPTS,n.endPTS,n.startDTS,n.endDTS):ad(s,e),r.length&&(e.totalduration=e.edge-r[0].start),e.driftStartTime=s.driftStartTime,e.driftStart=s.driftStart;const o=e.advancedDateTime;if(e.advanced&&o){const l=e.edge;e.driftStart||(e.driftStartTime=o,e.driftStart=l),e.driftEndTime=o,e.driftEnd=l}else e.driftEndTime=s.driftEndTime,e.driftEnd=s.driftEnd,e.advancedDateTime=s.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=s.requestScheduled)}function km(s,e){const{dateRanges:t,recentlyRemovedDateranges:i}=e,n=Ae({},s);i&&i.forEach(o=>{delete n[o]});const a=Object.keys(n).length;return a&&Object.keys(t).forEach(o=>{const l=n[o],c=new vm(t[o].attr,l);c.isValid?(n[o]=c,l||(c.tagOrder+=a)):Te.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${we(t[o].attr)}"`)}),n}function Cm(s,e,t){if(s&&e){let i=0;for(let n=0,r=s.length;n<=r;n++){const a=s[n],o=e[n+i];a&&o&&a.index===o.index&&a.fragment.sn===o.fragment.sn?t(a,o):i--}}}function Rm(s,e,t){const i=e.skippedSegments,n=Math.max(s.startSN,e.startSN)-e.startSN,r=(s.fragmentHint?1:0)+(i?e.endSN:Math.min(s.endSN,e.endSN))-e.startSN,a=e.startSN-s.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=s.fragmentHint?s.fragments.concat(s.fragmentHint):s.fragments;for(let c=n;c<=r;c++){const u=l[a+c];let d=o[c];if(i&&!d&&u&&(d=e.fragments[c]=u),u&&d){if(t(u,d,c,o),u.url&&u.url!==d.url){e.playlistParsingError=rd(`media sequence mismatch ${d.sn}:`,s,e,u,d);return}else if(u.cc!==d.cc){e.playlistParsingError=rd(`discontinuity sequence mismatch (${u.cc}!=${d.cc})`,s,e,u,d);return}}}}function rd(s,e,t,i,n){return new Error(`${s} ${n.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function ad(s,e,t=!0){const i=e.startSN+e.skippedSegments-s.startSN,n=s.fragments,r=i>=0;let a=0;if(r&&i<n.length)a=n[i].start;else if(r&&e.startSN===s.endSN+1)a=s.fragmentEnd;else if(r&&t)a=s.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)a=s.fragmentStart;else return;ea(e,a)}function ea(s,e){if(e){const t=s.fragments;for(let i=s.skippedSegments;i<t.length;i++)t[i].addStart(e);s.fragmentHint&&s.fragmentHint.addStart(e)}}function Pm(s,e=1/0){let t=1e3*s.targetduration;if(s.updated){const i=s.fragments;if(i.length&&t*4>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function od(s,e,t){if(!s)return null;let i=s.fragments[e-s.startSN];return i||(i=s.fragmentHint,i&&i.sn===e)?i:e<s.startSN&&t&&t.sn===e?t:null}function ld(s,e,t){return s?cd(s.partList,e,t):null}function cd(s,e,t){if(s)for(let i=s.length;i--;){const n=s[i];if(n.index===t&&n.fragment.sn===e)return n}return null}function Dm(s){s.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(n=>{n.level=t,n.initSegment&&(n.initSegment.level=t)})})}function ts(s,e){for(let i=0,n=s.length;i<n;i++){var t;if(((t=s[i])==null?void 0:t.cc)===e)return s[i]}return null}function Om(s,e){return!!(s&&e.startCC<s.endCC&&e.endCC>s.startCC)}function ud(s,e){if(s){const t=s.start+e;s.start=s.startPTS=t,s.endPTS=t+s.duration}}function dd(s,e){const t=e.fragments;for(let i=0,n=t.length;i<n;i++)ud(t[i],s);e.fragmentHint&&ud(e.fragmentHint,s),e.alignedSliding=!0}function Mm(s,e){s&&(hd(e,s),!e.alignedSliding&&s&&cn(e,s),!e.alignedSliding&&s&&!e.skippedSegments&&ad(s,e,!1))}function hd(s,e){if(!Om(e,s))return;const t=Math.min(e.endCC,s.endCC),i=ts(e.fragments,t),n=ts(s.fragments,t);if(!i||!n)return;Te.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const r=i.start-n.start;dd(r,s)}function cn(s,e){if(!s.hasProgramDateTime||!e.hasProgramDateTime)return;const t=s.fragments,i=e.fragments;if(!t.length||!i.length)return;let n,r;const a=Math.min(e.endCC,s.endCC);e.startCC<a&&s.startCC<a&&(n=ts(i,a),r=ts(t,a)),(!n||!r)&&(n=i[Math.floor(i.length/2)],r=ts(t,n.cc)||t[Math.floor(t.length/2)]);const o=n.programDateTime,l=r.programDateTime;if(!o||!l)return;const c=(l-o)/1e3-(r.start-n.start);dd(c,s)}const Fm={toString:function(s){let e="";const t=s.length;for(let i=0;i<t;i++)e+=`[${s.start(i).toFixed(3)}-${s.end(i).toFixed(3)}]`;return e}},j={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class fd extends hm{constructor(e,t,i,n,r){super(n,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=j.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:a,fragCurrent:o,media:l,mediaBuffer:c,state:u}=this,d=l?l.currentTime:0,f=ve.bufferInfo(c||l,d,a.maxBufferHole);if(this.log(`media seeking to ${J(d)?d.toFixed(3):d}, state: ${u}`),this.state===j.ENDED)this.resetLoadingState();else if(o){const g=a.maxFragLookUpTolerance,p=o.start-g,v=o.start+o.duration+g;if(!f.len||v<f.start||p>f.end){const S=d>v;(d<p||S)&&(S&&o.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),o.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(l){this.fragmentTracker.removeFragmentsInRange(d,1/0,this.playlistType,!0);const g=this.lastCurrentTime;if(d>g&&(this.lastCurrentTime=d),!this.loadingParts){const p=Math.max(f.end,d),v=this.shouldLoadParts(this.getLevelDetails(),p);v&&(this.log(`LL-Part loading ON after seeking to ${d.toFixed(2)} with buffer @${p.toFixed(2)}`),this.loadingParts=v)}}!this.hls.hasEnoughToStart&&!f.len&&(this.log(`setting startPosition to ${d} because of seek before start`),this.nextLoadPosition=this.startPosition=d),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=r,this.hls=e,this.fragmentLoader=new um(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Yr(e.config)}registerListeners(){const{hls:e}=this;e.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(E.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===j.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=j.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,n=this.config.timelineOffset||0;if(i<=n)return!1;const r=e.buffered;this.config.maxBufferHole&&r&&r.length>1&&(e=ve.bufferedInfo(r,e.start,0));const a=e.nextStart;if(a&&a>n&&a<t.edge||this.media.currentTime<e.start)return!1;const l=t.partList;if(l!=null&&l.length){const u=l[l.length-1];return ve.isBuffered(this.media,u.start+u.duration/2)}const c=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(c)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);const n=this.config;this.levels&&n.autoStartLoad&&this.state===j.STOPPED&&this.startLoad(n.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(n!==null){if(n.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),n.removeEventListener("seeking",this.onMediaSeeking),n.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=j.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const n=r=>{const a=r.frag;if(this.fragContextChanged(a)){this.warn(`${a.type} sn: ${a.sn}${r.part?" part: "+r.part.index:""} of ${this.fragInfo(a,!1,r.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(a);return}a.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,n).then(r=>{if(!r)return;const a=this.state,o=r.frag;if(this.fragContextChanged(o)){(a===j.FRAG_LOADING||!this.fragCurrent&&a===j.PARSING)&&(this.fragmentTracker.removeFragment(o),this.state=j.IDLE);return}"payload"in r&&(this.log(`Loaded ${o.type} sn: ${o.sn} of ${this.playlistLabel()} ${o.level}`),this.hls.trigger(E.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===j.STOPPED||this.state===j.ERROR||(this.warn(`Frag error: ${(r==null?void 0:r.message)||r}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===it.APPENDING){const r=e.type,a=this.getFwdBufferInfo(this.mediaBuffer,r),o=Math.max(e.duration,a?a.len:this.config.maxBufferLength),l=this.backtrackFragment;((l?e.sn-l.sn:0)===1||this.reduceMaxBufferLength(o,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===it.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return(t==null?void 0:t.live)&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const n={startOffset:e,endOffset:t,type:i};this.hls.trigger(E.BUFFER_FLUSHING,n)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{const n=i==null?void 0:i.frag;if(!n||this.fragContextChanged(n)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:n}=this,{frag:r,payload:a}=i,o=r.decryptdata;if(a&&a.byteLength>0&&o!=null&&o.key&&o.iv&&ki(o.method)){const l=self.performance.now();return this.decrypter.decrypt(new Uint8Array(a),o.key.buffer,o.iv.buffer,Wr(o.method)).catch(c=>{throw n.trigger(E.ERROR,{type:te.MEDIA_ERROR,details:M.FRAG_DECRYPT_ERROR,fatal:!1,error:c,reason:c.message,frag:r}),c}).then(c=>{const u=self.performance.now();return n.trigger(E.FRAG_DECRYPTED,{frag:r,payload:c,stats:{tstart:l,tdecrypt:u}}),i.payload=c,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===j.STOPPED||this.state===j.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==j.STOPPED&&(this.state=j.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?Fm.toString(ve.getBuffered(i)):"(detached)"})`),ze(e)){var n;if(e.type!==oe.SUBTITLE){const a=e.elementaryStreams;if(!Object.keys(a).some(o=>!!a[o])){this.state=j.IDLE;return}}const r=(n=this.levels)==null?void 0:n[e.level];r!=null&&r.fragmentError&&(this.log(`Resetting level fragment error count of ${r.fragmentError} on frag buffered`),r.fragmentError=0)}this.state=j.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:n,partsLoaded:r}=e,a=!r||r.length===0||r.some(l=>!l),o=new Zu(i.level,i.sn,i.stats.chunkCount+1,0,n?n.index:-1,!a);t.flush(o)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,n){var r;this.fragCurrent=e;const a=t==null?void 0:t.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let o=null;e.encrypted&&!((r=e.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${e.sn} of [${a.startSN}-${a.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=j.KEY_LOADING,this.fragCurrent=e,o=this.keyLoader.load(e).then(d=>{if(!this.fragContextChanged(d.frag))return this.hls.trigger(E.KEY_LOADED,d),this.state===j.KEY_LOADING&&(this.state=j.IDLE),d}),this.hls.trigger(E.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):e.encrypted||(o=this.keyLoader.loadClear(e,a.encryptedFragments),o&&this.log("[eme] blocking frag load until media-keys acquired"));const l=this.fragPrevious;if(ze(e)&&(!l||e.sn!==l.sn)){const d=this.shouldLoadParts(t.details,e.end);d!==this.loadingParts&&(this.log(`LL-Part loading ${d?"ON":"OFF"} loading sn ${l==null?void 0:l.sn}->${e.sn}`),this.loadingParts=d)}if(i=Math.max(e.start,i||0),this.loadingParts&&ze(e)){const d=a.partList;if(d&&n){i>e.end&&a.fragmentHint&&(e=a.fragmentHint);const f=this.getNextPart(d,e,i);if(f>-1){const g=d[f];e=this.fragCurrent=g.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${g.index} (${f}/${d.length-1}) of ${this.fragInfo(e,!1,g)}) cc: ${e.cc} [${a.startSN}-${a.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=g.start+g.duration,this.state=j.FRAG_LOADING;let p;return o?p=o.then(v=>!v||this.fragContextChanged(v.frag)?null:this.doFragPartsLoad(e,g,t,n)).catch(v=>this.handleFragLoadError(v)):p=this.doFragPartsLoad(e,g,t,n).catch(v=>this.handleFragLoadError(v)),this.hls.trigger(E.FRAG_LOADING,{frag:e,part:g,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):p}else if(!e.url||this.loadedEndOfParts(d,i))return Promise.resolve(null)}}if(ze(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${a?"["+a.startSN+"-"+a.endSN+"]":""}, target: ${parseFloat(i.toFixed(3))}`),J(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=j.FRAG_LOADING;const c=this.config.progressive;let u;return c&&o?u=o.then(d=>!d||this.fragContextChanged(d==null?void 0:d.frag)?null:this.fragmentLoader.load(e,n)).catch(d=>this.handleFragLoadError(d)):u=Promise.all([this.fragmentLoader.load(e,c?n:void 0),o]).then(([d])=>(!c&&d&&n&&n(d),d)).catch(d=>this.handleFragLoadError(d)),this.hls.trigger(E.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):u}doFragPartsLoad(e,t,i,n){return new Promise((r,a)=>{var o;const l=[],c=(o=i.details)==null?void 0:o.partList,u=d=>{this.fragmentLoader.loadPart(e,d,n).then(f=>{l[d.index]=f;const g=f.part;this.hls.trigger(E.FRAG_LOADED,f);const p=ld(i.details,e.sn,d.index+1)||cd(c,e.sn,d.index+1);if(p)u(p);else return r({frag:e,part:g,partsLoaded:l})}).catch(a)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===M.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(E.ERROR,t)}else this.hls.trigger(E.ERROR,{type:te.OTHER_ERROR,details:M.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==j.PARSING){!this.fragCurrent&&this.state!==j.STOPPED&&this.state!==j.ERROR&&(this.state=j.IDLE);return}const{frag:i,part:n,level:r}=t,a=self.performance.now();i.stats.parsing.end=a,n&&(n.stats.parsing.end=a);const o=this.getLevelDetails(),c=o&&i.sn>o.endSN||this.shouldLoadParts(o,i.end);c!==this.loadingParts&&(this.log(`LL-Part loading ${c?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=c),this.updateLevelTiming(i,n,r,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e!=null&&e.partList){var i;const r=e.partList[0],a=r.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=a){var n;if((this.hls.hasEnoughToStart?((n=this.media)==null?void 0:n.currentTime)||this.lastCurrentTime:this.getLoadPosition())>r.start-r.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:n,sn:r,part:a}=e;if(!(t!=null&&t[n]))return this.warn(`Levels object was unset while buffering fragment ${r} of ${this.playlistLabel()} ${n}. The current chunk will not be buffered.`),null;const o=t[n],l=o.details,c=a>-1?ld(l,r,a):null,u=c?c.fragment:od(l,r,i);return u?(i&&i!==u&&(u.stats=i.stats),{frag:u,part:c,level:o}):null}bufferFragmentData(e,t,i,n,r){var a;if(!e||this.state!==j.PARSING)return;const{data1:o,data2:l}=e;let c=o;if(o&&l&&(c=tt(o,l)),!((a=c)!=null&&a.length))return;const u={type:e.type,frag:t,part:i,chunkMeta:n,parent:t.type,data:c};if(this.hls.trigger(E.BUFFER_APPENDING,u),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!ve.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,n=ve.bufferInfo(t,i,0),r=e.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),o=Math.max(Math.min(e.start-a,n.end-a),i+a);e.start-o>a&&this.flushMainBuffer(o,e.start)}getFwdBufferInfo(e,t){var i;const n=this.getLoadPosition();if(!J(n))return null;const a=this.lastCurrentTime>n||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,n,t,a)}getFwdBufferInfoAtPos(e,t,i,n){const r=ve.bufferInfo(e,t,n);if(r.len===0&&r.nextStart!==void 0){const a=this.fragmentTracker.getBufferedFrag(t,i);if(a&&(r.nextStart<=a.end||a.gap)){const o=Math.max(Math.min(r.nextStart,a.end)-t,n);return ve.bufferInfo(e,t,o)}}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,n=Math.max(Math.min(e-t,i.maxBufferLength),t),r=Math.max(e-t*3,i.maxMaxBufferLength/2,n);return r>=n?(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0):!1}getAppendedFrag(e,t=oe.MAIN){var i;const n=(i=this.fragmentTracker)==null?void 0:i.getAppendedFrag(e,t);return n&&"fragment"in n?n.fragment:n}getNextFragment(e,t){const i=t.fragments,n=i.length;if(!n)return null;const{config:r}=this,a=i[0].start,o=r.lowLatencyMode&&!!t.partList;let l=null;if(t.live){const d=r.initialLiveManifestSize;if(n<d)return this.warn(`Not enough fragments to start playback (have: ${n}, need: ${d})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<a){var c;o&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),l=this.getInitialLiveFragment(t);const f=this.hls.startPosition,g=this.hls.liveSyncPosition,p=l?(f!==-1&&f>=a?f:g)||l.start:e;this.log(`Setting startPosition to ${p} to match start frag at live edge. mainStart: ${f} liveSyncPosition: ${g} frag.start: ${(c=l)==null?void 0:c.start}`),this.startPosition=this.nextLoadPosition=p}}else e<=a&&(l=i[0]);if(!l){const d=this.loadingParts?t.partEnd:t.fragmentEnd;l=this.getFragmentAtPosition(e,d,t)}let u=this.filterReplacedPrimary(l,t);if(!u&&l){const d=l.sn-t.startSN;u=this.filterReplacedPrimary(i[d+1]||null,t)}return this.mapToInitFragWhenRequired(u)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===it.OK||i===it.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,n,r){let a=null;if(e.gap&&(a=this.getNextFragment(this.nextLoadPosition,t),a&&!a.gap&&i.nextStart)){const o=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,n,0);if(o!==null&&i.len+o.len>=r){const l=a.sn;return this.loopSn!==l&&(this.log(`buffer full after gaps in "${n}" playlist starting at sn: ${l}`),this.loopSn=l),null}}return this.loopSn=void 0,a}get primaryPrefetch(){if(pd(this.hls.config)){var e,t;if((e=this.hls.interstitialsManager)==null||(t=e.playingItem)==null?void 0:t.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(pd(this.hls.config)&&e.type!==oe.SUBTITLE){const i=this.hls.interstitialsManager,n=i==null?void 0:i.bufferingItem;if(n){const a=n.event;if(a){if(a.appendInPlace||Math.abs(e.start-n.start)>1||n.start===0)return null}else if(e.end<=n.start&&(t==null?void 0:t.live)===!1||e.start>n.end&&n.nextEvent&&(n.nextEvent.appendInPlace||e.start-n.end>1))return null}const r=i==null?void 0:i.playerQueue;if(r)for(let a=r.length;a--;){const o=r[a].interstitial;if(o.appendInPlace&&e.start>=o.startTime&&e.end<=o.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let n=-1,r=!1,a=!0;for(let o=0,l=e.length;o<l;o++){const c=e[o];if(a=a&&!c.independent,n>-1&&i<c.start)break;const u=c.loaded;u?n=-1:(r||c.independent||a)&&c.fragment===t&&(n=o),r=u}return n}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e){const t=e.fragments,i=this.fragPrevious;let n=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),n=Zg(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const a=t[r-e.startSN];i.cc===a.cc&&(n=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${n.sn}`))}n||(n=Yu(e,i.cc,i.end),n&&this.log(`Live playlist, switching playlist, load frag with same CC: ${n.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(n=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}getFragmentAtPosition(e,t,i){const{config:n}=this;let{fragPrevious:r}=this,{fragments:a,endSN:o}=i;const{fragmentHint:l}=i,{maxFragLookUpTolerance:c}=n,u=i.partList,d=!!(this.loadingParts&&u!=null&&u.length&&l);d&&l&&!this.bitrateTest&&u[u.length-1].fragment.sn===l.sn&&(a=a.concat(l),o=l.sn);let f;if(e<t){var g;const v=e<this.lastCurrentTime||e>t-c||(g=this.media)!=null&&g.paused||!this.startFragRequested?0:c;f=Li(r,a,e,v)}else f=a[a.length-1];if(f){const p=f.sn-i.startSN,v=this.fragmentTracker.getState(f);if((v===it.OK||v===it.PARTIAL&&f.gap)&&(r=f),r&&f.sn===r.sn&&(!d||u[0].fragment.sn>f.sn||!i.live&&!d)&&r&&f.level===r.level){const b=a[p+1];f.sn<o&&this.fragmentTracker.getState(b)!==it.OK?f=b:f=null}}return f}alignPlaylists(e,t,i){const n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;const r=e.fragmentStart,a=!t,o=e.alignedSliding&&J(r);if(a||!o&&!r){Mm(i,e);const l=e.fragmentStart;return this.log(`Live playlist sliding: ${l.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${n}`),l}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const n=this.timelineOffset;if(i===-1){const r=this.startTimeOffset!==null,a=r?this.startTimeOffset:e.startTimeOffset;a!==null&&J(a)?(i=t+a,a<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${a} found in ${r?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+n}this.nextLoadPosition=i+n}getLoadPosition(){var e;const{media:t}=this;let i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&ze(e)&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==j.FRAG_LOADING_WAITING_RETRY)&&(this.state=j.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const p=this.getCurrentContext(t.chunkMeta);p&&(t.frag=p.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var n;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(n=this.fragCurrent)==null?void 0:n.url}`);return}const r=t.details===M.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const a=t.errorAction,{action:o,flags:l,retryCount:c=0,retryConfig:u}=a||{},d=!!a&&!!u,f=d&&o===Oe.RetryRequest,g=d&&!a.resolved&&l===ut.MoveAllAlternatesMatchingHost;if(!f&&g&&ze(i)&&!i.endList)this.resetFragmentErrors(e),this.treatAsGap(i),a.resolved=!0;else if((f||g)&&c<u.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const p=Hr(u,c);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${c+1}/${u.maxNumRetry} in ${p}ms`),a.resolved=!0,this.retryDate=self.performance.now()+p,this.state=j.FRAG_LOADING_WAITING_RETRY}else if(u&&a)if(this.resetFragmentErrors(e),c<u.maxNumRetry)!r&&o!==Oe.RemoveAlternatePermanently&&(a.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${c})`);return}else o===Oe.SendAlternateToPenaltyBox?this.state=j.WAITING_LEVEL:this.state=j.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===j.PARSING||this.state===j.PARSED){const t=e.frag,i=e.parent,n=this.getFwdBufferInfo(this.mediaBuffer,i),r=n&&n.len>.5;r&&this.reduceMaxBufferLength(n.len,(t==null?void 0:t.duration)||10);const a=!r;return a&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),a}return!1}resetFragmentErrors(e){e===oe.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==j.STOPPED&&(this.state=j.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const n=ve.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,i),this.state===j.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==j.STOPPED&&(this.state=j.IDLE)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,n){const r=i.details;if(!r){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,c)=>{const u=e.elementaryStreams[c];if(u){const d=u.endPTS-u.startPTS;if(d<=0)return this.warn(`Could not parse fragment ${e.sn} ${c} duration reliably (${d})`),l||!1;const f=n?0:nd(r,e,u.startPTS,u.endPTS,u.startDTS,u.endDTS);return this.hls.trigger(E.LEVEL_PTS_UPDATED,{details:r,level:i,drift:f,type:c,frag:e,start:u.startPTS,end:u.endPTS}),!0}return l},!1)){var o;if(i.fragmentError===0&&this.treatAsGap(e,i),((o=this.transmuxer)==null?void 0:o.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(E.ERROR,{type:te.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=j.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(E.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===oe.MAIN?"level":"track"}fragInfo(e,t=!0,i){var n,r;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((n=t&&!i?e.startPTS:(i||e).start)!=null?n:NaN).toFixed(3)}-${((r=t&&!i?e.endPTS:(i||e).end)!=null?r:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function pd(s){return!!s.interstitialsController&&s.enableInterstitialPlayback!==!1}class Nm{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=Um(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function Um(s,e){const t=new Uint8Array(e);let i=0;for(let n=0;n<s.length;n++){const r=s[n];t.set(r,i),i+=r.length}return t}var ta={exports:{}},gd;function Bm(){return gd||(gd=1,function(s){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function n(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function r(l,c,u,d,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var g=new n(u,d||l,f),p=t?t+c:c;return l._events[p]?l._events[p].fn?l._events[p]=[l._events[p],g]:l._events[p].push(g):(l._events[p]=g,l._eventsCount++),l}function a(l,c){--l._eventsCount===0?l._events=new i:delete l._events[c]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],u,d;if(this._eventsCount===0)return c;for(d in u=this._events)e.call(u,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},o.prototype.listeners=function(c){var u=t?t+c:c,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var f=0,g=d.length,p=new Array(g);f<g;f++)p[f]=d[f].fn;return p},o.prototype.listenerCount=function(c){var u=t?t+c:c,d=this._events[u];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,u,d,f,g,p){var v=t?t+c:c;if(!this._events[v])return!1;var S=this._events[v],b=arguments.length,I,w;if(S.fn){switch(S.once&&this.removeListener(c,S.fn,void 0,!0),b){case 1:return S.fn.call(S.context),!0;case 2:return S.fn.call(S.context,u),!0;case 3:return S.fn.call(S.context,u,d),!0;case 4:return S.fn.call(S.context,u,d,f),!0;case 5:return S.fn.call(S.context,u,d,f,g),!0;case 6:return S.fn.call(S.context,u,d,f,g,p),!0}for(w=1,I=new Array(b-1);w<b;w++)I[w-1]=arguments[w];S.fn.apply(S.context,I)}else{var _=S.length,T;for(w=0;w<_;w++)switch(S[w].once&&this.removeListener(c,S[w].fn,void 0,!0),b){case 1:S[w].fn.call(S[w].context);break;case 2:S[w].fn.call(S[w].context,u);break;case 3:S[w].fn.call(S[w].context,u,d);break;case 4:S[w].fn.call(S[w].context,u,d,f);break;default:if(!I)for(T=1,I=new Array(b-1);T<b;T++)I[T-1]=arguments[T];S[w].fn.apply(S[w].context,I)}}return!0},o.prototype.on=function(c,u,d){return r(this,c,u,d,!1)},o.prototype.once=function(c,u,d){return r(this,c,u,d,!0)},o.prototype.removeListener=function(c,u,d,f){var g=t?t+c:c;if(!this._events[g])return this;if(!u)return a(this,g),this;var p=this._events[g];if(p.fn)p.fn===u&&(!f||p.once)&&(!d||p.context===d)&&a(this,g);else{for(var v=0,S=[],b=p.length;v<b;v++)(p[v].fn!==u||f&&!p[v].once||d&&p[v].context!==d)&&S.push(p[v]);S.length?this._events[g]=S.length===1?S[0]:S:a(this,g)}return this},o.prototype.removeAllListeners=function(c){var u;return c?(u=t?t+c:c,this._events[u]&&a(this,u)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,s.exports=o}(ta)),ta.exports}var $m=Bm(),md=pg($m);const un="1.6.4",Ci={};function jm(){return typeof __HLS_WORKER_BUNDLE__=="function"}function Gm(){const s=Ci[un];if(s)return s.clientCount++,s;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),n={worker:new self.Worker(t),objectURL:t,clientCount:1};return Ci[un]=n,n}function Vm(s){const e=Ci[s];if(e)return e.clientCount++,e;const t=new self.URL(s,self.location.href).href,n={worker:new self.Worker(t),scriptURL:t,clientCount:1};return Ci[s]=n,n}function qm(s){const e=Ci[s||un];if(e&&e.clientCount--===1){const{worker:i,objectURL:n}=e;delete Ci[s||un],n&&self.URL.revokeObjectURL(n),i.terminate()}}function vd(s,e){return e+10<=s.length&&s[e]===51&&s[e+1]===68&&s[e+2]===73&&s[e+3]<255&&s[e+4]<255&&s[e+6]<128&&s[e+7]<128&&s[e+8]<128&&s[e+9]<128}function ia(s,e){return e+10<=s.length&&s[e]===73&&s[e+1]===68&&s[e+2]===51&&s[e+3]<255&&s[e+4]<255&&s[e+6]<128&&s[e+7]<128&&s[e+8]<128&&s[e+9]<128}function dn(s,e){let t=0;return t=(s[e]&127)<<21,t|=(s[e+1]&127)<<14,t|=(s[e+2]&127)<<7,t|=s[e+3]&127,t}function is(s,e){const t=e;let i=0;for(;ia(s,e);){i+=10;const n=dn(s,e+6);i+=n,vd(s,e+10)&&(i+=10),e+=i}if(i>0)return s.subarray(t,t+i)}function Km(s,e,t,i){const n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],r=e[t+2],a=r>>2&15;if(a>12){const g=new Error(`invalid ADTS sampling index:${a}`);s.emit(E.ERROR,E.ERROR,{type:te.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,fatal:!0,error:g,reason:g.message});return}const o=(r>>6&3)+1,l=e[t+3]>>6&3|(r&1)<<2,c="mp4a.40."+o,u=n[a];let d=a;(o===5||o===29)&&(d-=3);const f=[o<<3|(d&14)>>1,(d&1)<<7|l<<3];return Te.log(`manifest codec:${i}, parsed codec:${c}, channels:${l}, rate:${u} (ADTS object type:${o} sampling index:${a})`),{config:f,samplerate:u,channelCount:l,codec:c,parsedCodec:c,manifestCodec:i}}function yd(s,e){return s[e]===255&&(s[e+1]&246)===240}function Sd(s,e){return s[e+1]&1?7:9}function sa(s,e){return(s[e+3]&3)<<11|s[e+4]<<3|(s[e+5]&224)>>>5}function Hm(s,e){return e+5<s.length}function hn(s,e){return e+1<s.length&&yd(s,e)}function Ym(s,e){return Hm(s,e)&&yd(s,e)&&sa(s,e)<=s.length-e}function Wm(s,e){if(hn(s,e)){const t=Sd(s,e);if(e+t>=s.length)return!1;const i=sa(s,e);if(i<=t)return!1;const n=e+i;return n===s.length||hn(s,n)}return!1}function Ed(s,e,t,i,n){if(!s.samplerate){const r=Km(e,t,i,n);if(!r)return;Ae(s,r)}}function bd(s){return 1024*9e4/s}function zm(s,e){const t=Sd(s,e);if(e+t<=s.length){const i=sa(s,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function Td(s,e,t,i,n){const r=bd(s.samplerate),a=i+n*r,o=zm(e,t);let l;if(o){const{frameLength:d,headerLength:f}=o,g=f+d,p=Math.max(0,t+g-e.length);p?(l=new Uint8Array(g-f),l.set(e.subarray(t+f,e.length),0)):l=e.subarray(t+f,t+g);const v={unit:l,pts:a};return p||s.samples.push(v),{sample:v,length:g,missing:p}}const c=e.length-t;return l=new Uint8Array(c),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:a},length:c,missing:-1}}function Jm(s,e){return ia(s,e)&&dn(s,e+6)+10<=s.length-e}function Qm(s){return s instanceof ArrayBuffer?s:s.byteOffset==0&&s.byteLength==s.buffer.byteLength?s.buffer:new Uint8Array(s).buffer}function na(s,e=0,t=1/0){return Xm(s,e,t,Uint8Array)}function Xm(s,e,t,i){const n=Zm(s);let r=1;"BYTES_PER_ELEMENT"in i&&(r=i.BYTES_PER_ELEMENT);const a=e0(s)?s.byteOffset:0,o=(a+s.byteLength)/r,l=(a+e)/r,c=Math.floor(Math.max(0,Math.min(l,o))),u=Math.floor(Math.min(c+Math.max(t,0),o));return new i(n,c,u-c)}function Zm(s){return s instanceof ArrayBuffer?s:s.buffer}function e0(s){return s&&s.buffer instanceof ArrayBuffer&&s.byteLength!==void 0&&s.byteOffset!==void 0}function t0(s){const e={key:s.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(s.size<2)return;if(s.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const i=s.data.subarray(1).indexOf(0);if(i===-1)return;const n=We(na(s.data,1,i)),r=s.data[2+i],a=s.data.subarray(3+i).indexOf(0);if(a===-1)return;const o=We(na(s.data,3+i,a));let l;return n==="-->"?l=We(na(s.data,4+i+a)):l=Qm(s.data.subarray(4+i+a)),e.mimeType=n,e.pictureType=r,e.description=o,e.data=l,e}function i0(s){if(s.size<2)return;const e=We(s.data,!0),t=new Uint8Array(s.data.subarray(e.length+1));return{key:s.type,info:e,data:t.buffer}}function s0(s){if(s.size<2)return;if(s.type==="TXXX"){let t=1;const i=We(s.data.subarray(t),!0);t+=i.length+1;const n=We(s.data.subarray(t));return{key:s.type,info:i,data:n}}const e=We(s.data.subarray(1));return{key:s.type,info:"",data:e}}function n0(s){if(s.type==="WXXX"){if(s.size<2)return;let t=1;const i=We(s.data.subarray(t),!0);t+=i.length+1;const n=We(s.data.subarray(t));return{key:s.type,info:i,data:n}}const e=We(s.data);return{key:s.type,info:"",data:e}}function r0(s){return s.type==="PRIV"?i0(s):s.type[0]==="W"?n0(s):s.type==="APIC"?t0(s):s0(s)}function a0(s){const e=String.fromCharCode(s[0],s[1],s[2],s[3]),t=dn(s,4),i=10;return{type:e,size:t,data:s.subarray(i,i+t)}}const fn=10,o0=10;function l0(s){let e=0;const t=[];for(;ia(s,e);){const i=dn(s,e+6);s[e+5]>>6&1&&(e+=fn),e+=fn;const n=e+i;for(;e+o0<n;){const r=a0(s.subarray(e)),a=r0(r);a&&t.push(a),e+=r.size+fn}vd(s,e)&&(e+=fn)}return t}function c0(s){return s&&s.key==="PRIV"&&s.info==="com.apple.streaming.transportStreamTimestamp"}function u0(s){if(s.data.byteLength===8){const e=new Uint8Array(s.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function ra(s){const e=l0(s);for(let t=0;t<e.length;t++){const i=e[t];if(c0(i))return u0(i)}}let Ri=function(s){return s.audioId3="org.id3",s.dateRange="com.apple.quicktime.HLS",s.emsg="https://aomedia.org/emsg/ID3",s.misbklv="urn:misb:KLV:bin:1910.1",s}({});function Et(s="",e=9e4){return{type:s,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class aa{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=tt(this.cachedData,e),this.cachedData=null);let i=is(e,0),n=i?i.length:0,r;const a=this._audioTrack,o=this._id3Track,l=i?ra(i):void 0,c=e.length;for((this.basePTS===null||this.frameIndex===0&&J(l))&&(this.basePTS=d0(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Ri.audioId3,duration:Number.POSITIVE_INFINITY});n<c;){if(this.canParse(e,n)){const u=this.appendFrame(a,e,n);u?(this.frameIndex++,this.lastPTS=u.sample.pts,n+=u.length,r=n):n=c}else Jm(e,n)?(i=is(e,n),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Ri.audioId3,duration:Number.POSITIVE_INFINITY}),n+=i.length,r=n):n++;if(n===c&&r!==c){const u=e.slice(r);this.cachedData?this.cachedData=tt(this.cachedData,u):this.cachedData=u}}return{audioTrack:a,videoTrack:Et(),id3Track:o,textTrack:Et()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Et(),id3Track:this._id3Track,textTrack:Et()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const d0=(s,e,t)=>{if(J(s))return s*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};let pn=null;const h0=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],f0=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],p0=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],g0=[0,1,1,4];function _d(s,e,t,i,n){if(t+24>e.length)return;const r=xd(e,t);if(r&&t+r.frameLength<=e.length){const a=r.samplesPerFrame*9e4/r.sampleRate,o=i+n*a,l={unit:e.subarray(t,t+r.frameLength),pts:o,dts:o};return s.config=[],s.channelCount=r.channelCount,s.samplerate=r.sampleRate,s.samples.push(l),{sample:l,length:r.frameLength,missing:0}}}function xd(s,e){const t=s[e+1]>>3&3,i=s[e+1]>>1&3,n=s[e+2]>>4&15,r=s[e+2]>>2&3;if(t!==1&&n!==0&&n!==15&&r!==3){const a=s[e+2]>>1&1,o=s[e+3]>>6,l=t===3?3-i:i===3?3:4,c=h0[l*14+n-1]*1e3,d=f0[(t===3?0:t===2?1:2)*3+r],f=o===3?1:2,g=p0[t][i],p=g0[i],v=g*8*p,S=Math.floor(g*c/d+a)*p;if(pn===null){const w=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);pn=w?parseInt(w[1]):0}return!!pn&&pn<=87&&i===2&&c>=224e3&&o===0&&(s[e+3]=s[e+3]|128),{sampleRate:d,channelCount:f,frameLength:S,samplesPerFrame:v}}}function oa(s,e){return s[e]===255&&(s[e+1]&224)===224&&(s[e+1]&6)!==0}function Ad(s,e){return e+1<s.length&&oa(s,e)}function m0(s,e){return oa(s,e)&&4<=s.length-e}function Id(s,e){if(e+1<s.length&&oa(s,e)){const i=xd(s,e);let n=4;i!=null&&i.frameLength&&(n=i.frameLength);const r=e+n;return r===s.length||Ad(s,r)}return!1}class v0 extends aa{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=is(e,0);let n=(i==null?void 0:i.length)||0;if(Id(e,n))return!1;for(let r=e.length;n<r;n++)if(Wm(e,n))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return Ym(e,t)}appendFrame(e,t,i){Ed(e,this.observer,t,i,e.manifestCodec);const n=Td(e,t,i,this.basePTS,this.frameIndex);if(n&&n.missing===0)return n}}const wd=(s,e)=>{let t=0,i=5;e+=i;const n=new Uint32Array(1),r=new Uint32Array(1),a=new Uint8Array(1);for(;i>0;){a[0]=s[e];const o=Math.min(i,8),l=8-o;r[0]=4278190080>>>24+l<<l,n[0]=(a[0]&r[0])>>l,t=t?t<<o|n[0]:n[0],e+=1,i-=o}return t};class y0 extends aa{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const n=Ld(e,t,i,this.basePTS,this.frameIndex);if(n!==-1)return{sample:e.samples[e.samples.length-1],length:n,missing:0}}static probe(e){if(!e)return!1;const t=is(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&ra(t)!==void 0&&wd(e,i)<16}}function Ld(s,e,t,i,n){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const r=e[t+4]>>6;if(r>=3)return-1;const o=[48e3,44100,32e3][r],l=e[t+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+r]*2;if(t+u>e.length)return-1;const d=e[t+6]>>5;let f=0;d===2?f+=2:(d&1&&d!==1&&(f+=2),d&4&&(f+=2));const g=(e[t+6]<<8|e[t+7])>>12-f&1,v=[2,1,2,3,3,4,4,5][d]+g,S=e[t+5]>>3,b=e[t+5]&7,I=new Uint8Array([r<<6|S<<1|b>>2,(b&3)<<6|d<<3|g<<2|l>>4,l<<4&224]),w=1536/o*9e4,_=i+n*w,T=e.subarray(t,t+u);return s.config=I,s.channelCount=v,s.samplerate=o,s.samples.push({unit:T,pts:_}),u}class S0 extends aa{resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=is(e,0);let i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&ra(t)!==void 0&&wd(e,i)<=16)return!1;for(let n=e.length;i<n;i++)if(Id(e,i))return Te.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return m0(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return _d(e,t,i,this.basePTS,this.frameIndex)}}const E0=/\/emsg[-/]ID3/i;class b0{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,n){const r=this.videoTrack=Et("video",1),a=this.audioTrack=Et("audio",1),o=this.txtTrack=Et("text",1);if(this.id3Track=Et("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=wu(e);if(l.video){const{id:c,timescale:u,codec:d,supplemental:f}=l.video;r.id=c,r.timescale=o.timescale=u,r.codec=d,r.supplemental=f}if(l.audio){const{id:c,timescale:u,codec:d}=l.audio;a.id=c,a.timescale=u,a.codec=d}o.id=_u.text,r.sampleDuration=0,r.duration=a.duration=n}resetContiguity(){this.remainderData=null}static probe(e){return yg(e)}demux(e,t){this.timeOffset=t;let i=e;const n=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=tt(this.remainderData,e));const o=Ag(i);this.remainderData=o.remainder,n.samples=o.valid||new Uint8Array}else n.samples=i;const a=this.extractID3Track(n,t);return r.samples=ku(t,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const n=this.extractID3Track(t,this.timeOffset);return i.samples=ku(e,t),{videoTrack:t,audioTrack:Et(),id3Track:n,textTrack:Et()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const n=ne(e.samples,["emsg"]);n&&n.forEach(r=>{const a=wg(r);if(E0.test(a.schemeIdUri)){const o=kd(a,t);let l=a.eventDuration===4294967295?Number.POSITIVE_INFINITY:a.eventDuration/a.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=a.payload;i.samples.push({data:c,len:c.byteLength,dts:o,pts:o,type:Ri.emsg,duration:l})}else if(this.config.enableEmsgKLVMetadata&&a.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const o=kd(a,t);i.samples.push({data:a.payload,len:a.payload.byteLength,dts:o,pts:o,type:Ri.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function kd(s,e){return J(s.presentationTime)?s.presentationTime/s.timeScale:e+s.presentationTimeDelta/s.timeScale}class T0{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Yr(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,jt.cbc)}decryptAacSample(e,t,i){const n=e[t].unit;if(n.length<=16)return;const r=n.subarray(16,n.length-n.length%16),a=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(a).then(o=>{const l=new Uint8Array(o);n.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let n=0;for(let r=32;r<e.length-16;r+=160,n+=16)i.set(e.subarray(r,r+16),n);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let n=0;for(let r=32;r<e.length-16;r+=160,n+=16)e.set(i.subarray(n,n+16),r);return e}decryptAvcSample(e,t,i,n,r){const a=Cu(r.data),o=this.getAvcEncryptedData(a);this.decryptBuffer(o.buffer).then(l=>{r.data=this.getAvcDecryptedUnit(a,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,n)})}decryptAvcSamples(e,t,i,n){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){n();return}const r=e[t].units;for(;!(i>=r.length);i++){const a=r[i];if(!(a.data.length<=48||a.type!==1&&a.type!==5)&&(this.decryptAvcSample(e,t,i,n,a),!this.decrypter.isSync()))return}}}}class Cd{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,n;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;n=r[r.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,n=i.length;if(n){const r=i[n-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){const n=t.byteLength;let r=e.naluState||0;const a=r,o=[];let l=0,c,u,d,f=-1,g=0;for(r===-1&&(f=0,g=this.getNALuType(t,0),r=0,l=1);l<n;){if(c=t[l++],!r){r=c?0:1;continue}if(r===1){r=c?0:2;continue}if(!c)r=3;else if(c===1){if(u=l-r-1,f>=0){const p={data:t.subarray(f,u),type:g};o.push(p)}else{const p=this.getLastNalUnit(e.samples);p&&(a&&l<=4-a&&p.state&&(p.data=p.data.subarray(0,p.data.byteLength-a)),u>0&&(p.data=tt(p.data,t.subarray(0,u)),p.state=0))}l<n?(d=this.getNALuType(t,l),f=l,g=d,r=0):r=-1}else r=0}if(f>=0&&r>=0){const p={data:t.subarray(f,n),type:g,state:r};o.push(p)}if(o.length===0){const p=this.getLastNalUnit(e.samples);p&&(p.data=tt(p.data,t))}return e.naluState=r,o}}class ss{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,n=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");n.set(e.subarray(i,i+r)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&Te.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class Rd extends Cd{parsePES(e,t,i,n){const r=this.parseNALu(e,i.data,n);let a=this.VideoSample,o,l=!1;i.data=null,a&&r.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(c=>{var u,d;switch(c.type){case 1:{let v=!1;o=!0;const S=c.data;if(l&&S.length>4){const b=this.readSliceType(S);(b===2||b===4||b===7||b===9)&&(v=!0)}if(v){var f;(f=a)!=null&&f.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null)}a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.frame=!0,a.key=v;break}case 5:o=!0,(u=a)!=null&&u.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 6:{o=!0,$r(c.data,1,i.pts,t.samples);break}case 7:{var g,p;o=!0,l=!0;const v=c.data,S=this.readSPS(v);if(!e.sps||e.width!==S.width||e.height!==S.height||((g=e.pixelRatio)==null?void 0:g[0])!==S.pixelRatio[0]||((p=e.pixelRatio)==null?void 0:p[1])!==S.pixelRatio[1]){e.width=S.width,e.height=S.height,e.pixelRatio=S.pixelRatio,e.sps=[v];const b=v.subarray(1,4);let I="avc1.";for(let w=0;w<3;w++){let _=b[w].toString(16);_.length<2&&(_="0"+_),I+=_}e.codec=I}break}case 8:o=!0,e.pps=[c.data];break;case 9:o=!0,e.audFound=!0,(d=a)!=null&&d.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:o=!0;break;default:o=!1;break}a&&o&&a.units.push(c)}),n&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new ss(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,n=8,r;for(let a=0;a<e;a++)n!==0&&(r=t.readEG(),n=(i+r+256)%256),i=n===0?i:n}readSPS(e){const t=new ss(e);let i=0,n=0,r=0,a=0,o,l,c;const u=t.readUByte.bind(t),d=t.readBits.bind(t),f=t.readUEG.bind(t),g=t.readBoolean.bind(t),p=t.skipBits.bind(t),v=t.skipEG.bind(t),S=t.skipUEG.bind(t),b=this.skipScalingList.bind(this);u();const I=u();if(d(5),p(3),u(),S(),I===100||I===110||I===122||I===244||I===44||I===83||I===86||I===118||I===128){const k=f();if(k===3&&p(1),S(),S(),p(1),g())for(l=k!==3?8:12,c=0;c<l;c++)g()&&(c<6?b(16,t):b(64,t))}S();const w=f();if(w===0)f();else if(w===1)for(p(1),v(),v(),o=f(),c=0;c<o;c++)v();S(),p(1);const _=f(),T=f(),C=d(1);C===0&&p(1),p(1),g()&&(i=f(),n=f(),r=f(),a=f());let A=[1,1];if(g()&&g())switch(u()){case 1:A=[1,1];break;case 2:A=[12,11];break;case 3:A=[10,11];break;case 4:A=[16,11];break;case 5:A=[40,33];break;case 6:A=[24,11];break;case 7:A=[20,11];break;case 8:A=[32,11];break;case 9:A=[80,33];break;case 10:A=[18,11];break;case 11:A=[15,11];break;case 12:A=[64,33];break;case 13:A=[160,99];break;case 14:A=[4,3];break;case 15:A=[3,2];break;case 16:A=[2,1];break;case 255:{A=[u()<<8|u(),u()<<8|u()];break}}return{width:Math.ceil((_+1)*16-i*2-n*2),height:(2-C)*(T+1)*16-(C?2:4)*(r+a),pixelRatio:A}}}class Pd extends Cd{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,n){const r=this.parseNALu(e,i.data,n);let a=this.VideoSample,o,l=!1;i.data=null,a&&r.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(c=>{var u,d;switch(c.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),a.frame=!0,o=!0;break;case 16:case 17:case 18:case 21:if(o=!0,l){var f;(f=a)!=null&&f.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null)}a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 19:case 20:o=!0,(u=a)!=null&&u.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 39:o=!0,$r(c.data,2,i.pts,t.samples);break;case 32:o=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=Ae(e.params,this.readVPS(c.data)),this.initVPS=c.data),e.vps=[c.data];break;case 33:if(o=!0,l=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],c.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const g=this.readSPS(c.data);e.width=g.width,e.height=g.height,e.pixelRatio=g.pixelRatio,e.codec=g.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const p in g.params)e.params[p]=g.params[p]}this.pushParameterSet(e.sps,c.data,e.vps),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0;break;case 34:if(o=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const g=this.readPPS(c.data);for(const p in g)e.params[p]=g[p]}this.pushParameterSet(e.pps,c.data,e.vps)}break;case 35:o=!0,e.audFound=!0,(d=a)!=null&&d.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:o=!1;break}a&&o&&a.units.push(c)}),n&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let n=0;n<e.byteLength;n++)n>=2&&e[n]===3&&e[n-1]===0&&e[n-2]===0||(t[i]=e[n],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new ss(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const i=t.readBits(3),n=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:n}}readSPS(e){const t=new ss(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const n=t.readBits(2),r=t.readBoolean(),a=t.readBits(5),o=t.readUByte(),l=t.readUByte(),c=t.readUByte(),u=t.readUByte(),d=t.readUByte(),f=t.readUByte(),g=t.readUByte(),p=t.readUByte(),v=t.readUByte(),S=t.readUByte(),b=t.readUByte(),I=[],w=[];for(let ce=0;ce<i;ce++)I.push(t.readBoolean()),w.push(t.readBoolean());if(i>0)for(let ce=i;ce<8;ce++)t.readBits(2);for(let ce=0;ce<i;ce++)I[ce]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),w[ce]&&t.readUByte();t.readUEG();const _=t.readUEG();_==3&&t.skipBits(1);const T=t.readUEG(),C=t.readUEG(),A=t.readBoolean();let k=0,D=0,R=0,N=0;A&&(k+=t.readUEG(),D+=t.readUEG(),R+=t.readUEG(),N+=t.readUEG());const V=t.readUEG(),W=t.readUEG(),q=t.readUEG(),ee=t.readBoolean();for(let ce=ee?0:i;ce<=i;ce++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let de=0;de<4;de++)for(let xe=0;xe<(de===3?2:6);xe++)if(!t.readBoolean())t.readUEG();else{const Pe=Math.min(64,1<<4+(de<<1));de>1&&t.readEG();for(let ht=0;ht<Pe;ht++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const pe=t.readUEG();let G=0;for(let ce=0;ce<pe;ce++){let de=!1;if(ce!==0&&(de=t.readBoolean()),de){ce===pe&&t.readUEG(),t.readBoolean(),t.readUEG();let xe=0;for(let Be=0;Be<=G;Be++){const Pe=t.readBoolean();let ht=!1;Pe||(ht=t.readBoolean()),(Pe||ht)&&xe++}G=xe}else{const xe=t.readUEG(),Be=t.readUEG();G=xe+Be;for(let Pe=0;Pe<xe;Pe++)t.readUEG(),t.readBoolean();for(let Pe=0;Pe<Be;Pe++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const ce=t.readUEG();for(let de=0;de<ce;de++){for(let xe=0;xe<q+4;xe++)t.readBits(1);t.readBits(1)}}let ie=0,X=1,h=1,y=!0,m=1,x=0;t.readBoolean(),t.readBoolean();let L=!1;if(t.readBoolean()){if(t.readBoolean()){const Je=t.readUByte(),Wt=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],pi=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Je>0&&Je<16?(X=Wt[Je-1],h=pi[Je-1]):Je===255&&(X=t.readBits(16),h=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),L=t.readBoolean(),L&&(k+=t.readUEG(),D+=t.readUEG(),R+=t.readUEG(),N+=t.readUEG()),t.readBoolean()&&(m=t.readBits(32),x=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const pi=t.readBoolean(),In=t.readBoolean();let gi=!1;(pi||In)&&(gi=t.readBoolean(),gi&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),gi&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let xh=0;xh<=i;xh++){y=t.readBoolean();const Ty=y||t.readBoolean();let Ah=!1;Ty?t.readEG():Ah=t.readBoolean();const Ih=Ah?1:t.readUEG()+1;if(pi)for(let cs=0;cs<Ih;cs++)t.readUEG(),t.readUEG(),gi&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(In)for(let cs=0;cs<Ih;cs++)t.readUEG(),t.readUEG(),gi&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),ie=t.readUEG())}let U=T,$=C;if(A||L){let ce=1,de=1;_===1?ce=de=2:_==2&&(ce=2),U=T-ce*D-ce*k,$=C-de*N-de*R}const H=n?["A","B","C"][n]:"",re=o<<24|l<<16|c<<8|u;let le=0;for(let ce=0;ce<32;ce++)le=(le|(re>>ce&1)<<31-ce)>>>0;let Ve=le.toString(16);return a===1&&Ve==="2"&&(Ve="6"),{codecString:`hvc1.${H}${a}.${Ve}.${r?"H":"L"}${b}.B0`,params:{general_tier_flag:r,general_profile_idc:a,general_profile_space:n,general_profile_compatibility_flags:[o,l,c,u],general_constraint_indicator_flags:[d,f,g,p,v,S],general_level_idc:b,bit_depth:V+8,bit_depth_luma_minus8:V,bit_depth_chroma_minus8:W,min_spatial_segmentation_idc:ie,chroma_format_idc:_,frame_rate:{fixed:y,fps:x/m}},width:U,height:$,pixelRatio:[X,h]}}readPPS(e){const t=new ss(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const n=t.readBoolean(),r=t.readBoolean();let a=1;return r&&n?a=0:r?a=3:n&&(a=2),{parallelismType:a}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const Ce=188;class Vt{constructor(e,t,i,n){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.videoParser=null}static probe(e,t){const i=Vt.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){const t=e.length;let i=Math.min(Ce*5,t-Ce)+1,n=0;for(;n<i;){let r=!1,a=-1,o=0;for(let l=n;l<t;l+=Ce)if(e[l]===71&&(t-l===Ce||e[l+Ce]===71)){if(o++,a===-1&&(a=l,a!==0&&(i=Math.min(a+Ce*99,e.length-Ce)+1)),r||(r=la(e,l)===0),r&&o>1&&(a===0&&o>2||l+Ce>i))return a}else{if(o)return-1;break}n++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:_u[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,n){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Vt.createTrack("video"),this._videoTrack.duration=n,this._audioTrack=Vt.createTrack("audio",n),this._id3Track=Vt.createTrack("id3"),this._txtTrack=Vt.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,n=!1){i||(this.sampleAes=null);let r;const a=this._videoTrack,o=this._audioTrack,l=this._id3Track,c=this._txtTrack;let u=a.pid,d=a.pesData,f=o.pid,g=l.pid,p=o.pesData,v=l.pesData,S=null,b=this.pmtParsed,I=this._pmtId,w=e.length;if(this.remainderData&&(e=tt(this.remainderData,e),w=e.length,this.remainderData=null),w<Ce&&!n)return this.remainderData=e,{audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};const _=Math.max(0,Vt.syncOffset(e));w-=(w-_)%Ce,w<e.byteLength&&!n&&(this.remainderData=new Uint8Array(e.buffer,w,e.buffer.byteLength-w));let T=0;for(let A=_;A<w;A+=Ce)if(e[A]===71){const k=!!(e[A+1]&64),D=la(e,A),R=(e[A+3]&48)>>4;let N;if(R>1){if(N=A+5+e[A+4],N===A+Ce)continue}else N=A+4;switch(D){case u:if(k){if(d&&(r=Pi(d,this.logger))){if(this.videoParser===null)switch(a.segmentCodec){case"avc":this.videoParser=new Rd;break;case"hevc":this.videoParser=new Pd;break}this.videoParser!==null&&this.videoParser.parsePES(a,c,r,!1)}d={data:[],size:0}}d&&(d.data.push(e.subarray(N,A+Ce)),d.size+=A+Ce-N);break;case f:if(k){if(p&&(r=Pi(p,this.logger)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,r);break;case"mp3":this.parseMPEGPES(o,r);break;case"ac3":this.parseAC3PES(o,r);break}p={data:[],size:0}}p&&(p.data.push(e.subarray(N,A+Ce)),p.size+=A+Ce-N);break;case g:k&&(v&&(r=Pi(v,this.logger))&&this.parseID3PES(l,r),v={data:[],size:0}),v&&(v.data.push(e.subarray(N,A+Ce)),v.size+=A+Ce-N);break;case 0:k&&(N+=e[N]+1),I=this._pmtId=_0(e,N);break;case I:{k&&(N+=e[N]+1);const V=x0(e,N,this.typeSupported,i,this.observer,this.logger);u=V.videoPid,u>0&&(a.pid=u,a.segmentCodec=V.segmentVideoCodec),f=V.audioPid,f>0&&(o.pid=f,o.segmentCodec=V.segmentAudioCodec),g=V.id3Pid,g>0&&(l.pid=g),S!==null&&!b&&(this.logger.warn(`MPEG-TS PMT found at ${A} after unknown PID '${S}'. Backtracking to sync byte @${_} to parse all TS packets.`),S=null,A=_-188),b=this.pmtParsed=!0;break}case 17:case 8191:break;default:S=D;break}}else T++;T>0&&ca(this.observer,new Error(`Found ${T} TS packet/s that do not start with 0x47`),void 0,this.logger),a.pesData=d,o.pesData=p,l.pesData=v;const C={audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};return n&&this.extractRemainingSamples(C),C}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:n,textTrack:r}=e,a=i.pesData,o=t.pesData,l=n.pesData;let c;if(a&&(c=Pi(a,this.logger))){if(this.videoParser===null)switch(i.segmentCodec){case"avc":this.videoParser=new Rd;break;case"hevc":this.videoParser=new Pd;break}this.videoParser!==null&&(this.videoParser.parsePES(i,r,c,!0),i.pesData=null)}else i.pesData=a;if(o&&(c=Pi(o,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,c);break;case"mp3":this.parseMPEGPES(t,c);break;case"ac3":this.parseAC3PES(t,c);break}t.pesData=null}else o!=null&&o.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=o;l&&(c=Pi(l,this.logger))?(this.parseID3PES(n,c),n.pesData=null):n.pesData=l}demuxSampleAes(e,t,i){const n=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new T0(this.observer,this.config,t);return this.decrypt(n,r)}decrypt(e,t){return new Promise(i=>{const{audioTrack:n,videoTrack:r}=e;n.samples&&n.segmentCodec==="aac"?t.decryptAacSamples(n.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const n=this.aacOverFlow;let r=t.data;if(n){this.aacOverFlow=null;const d=n.missing,f=n.sample.unit.byteLength;if(d===-1)r=tt(n.sample.unit,r);else{const g=f-d;n.sample.unit.set(r.subarray(0,d),g),e.samples.push(n.sample),i=n.missing}}let a,o;for(a=i,o=r.length;a<o-1&&!hn(r,a);a++);if(a!==i){let d;const f=a<o-1;if(f?d=`AAC PES did not start with ADTS header,offset:${a}`:d="No ADTS header found in AAC PES",ca(this.observer,new Error(d),f,this.logger),!f)return}Ed(e,this.observer,r,a,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(n){const d=bd(e.samplerate);l=n.sample.pts+d}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,u;for(;a<o;)if(u=Td(e,r,a,l,c),a+=u.length,u.missing){this.aacOverFlow=u;break}else for(c++;a<o-1&&!hn(r,a);a++);}parseMPEGPES(e,t){const i=t.data,n=i.length;let r=0,a=0;const o=t.pts;if(o===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<n;)if(Ad(i,a)){const l=_d(e,i,a,o,r);if(l)a+=l.length,r++;else break}else a++}parseAC3PES(e,t){{const i=t.data,n=t.pts;if(n===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let a=0,o=0,l;for(;o<r&&(l=Ld(e,i,o,n,a++))>0;)o+=l}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=Ae({},t,{type:this._videoTrack?Ri.emsg:Ri.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function la(s,e){return((s[e+1]&31)<<8)+s[e+2]}function _0(s,e){return(s[e+10]&31)<<8|s[e+11]}function x0(s,e,t,i,n,r){const a={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},o=(s[e+1]&15)<<8|s[e+2],l=e+3+o-4,c=(s[e+10]&15)<<8|s[e+11];for(e+=12+c;e<l;){const u=la(s,e),d=(s[e+3]&15)<<8|s[e+4];switch(s[e]){case 207:if(!i){ua("ADTS AAC",r);break}case 15:a.audioPid===-1&&(a.audioPid=u);break;case 21:a.id3Pid===-1&&(a.id3Pid=u);break;case 219:if(!i){ua("H.264",r);break}case 27:a.videoPid===-1&&(a.videoPid=u);break;case 3:case 4:!t.mpeg&&!t.mp3?r.log("MPEG audio found, not supported in this browser"):a.audioPid===-1&&(a.audioPid=u,a.segmentAudioCodec="mp3");break;case 193:if(!i){ua("AC-3",r);break}case 129:t.ac3?a.audioPid===-1&&(a.audioPid=u,a.segmentAudioCodec="ac3"):r.log("AC-3 audio found, not supported in this browser");break;case 6:if(a.audioPid===-1&&d>0){let f=e+5,g=d;for(;g>2;){switch(s[f]){case 106:t.ac3!==!0?r.log("AC-3 audio found, not supported in this browser for now"):(a.audioPid=u,a.segmentAudioCodec="ac3");break}const v=s[f+1]+2;f+=v,g-=v}}break;case 194:case 135:return ca(n,new Error("Unsupported EC-3 in M2TS found"),void 0,r),a;case 36:a.videoPid===-1&&(a.videoPid=u,a.segmentVideoCodec="hevc",r.log("HEVC in M2TS found"));break}e+=d+5}return a}function ca(s,e,t,i){i.warn(`parsing error: ${e.message}`),s.emit(E.ERROR,E.ERROR,{type:te.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function ua(s,e){e.log(`${s} with AES-128-CBC encryption found in unencrypted stream`)}function Pi(s,e){let t=0,i,n,r,a,o;const l=s.data;if(!s||s.size===0)return null;for(;l[0].length<19&&l.length>1;)l[0]=tt(l[0],l[1]),l.splice(1,1);if(i=l[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(n=(i[4]<<8)+i[5],n&&n>s.size-6)return null;const u=i[7];u&192&&(a=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,u&64?(o=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,a-o>60*9e4&&(e.warn(`${Math.round((a-o)/9e4)}s delta between PTS and DTS, align them`),a=o)):o=a),r=i[8];let d=r+9;if(s.size<=d)return null;s.size-=d;const f=new Uint8Array(s.size);for(let g=0,p=l.length;g<p;g++){i=l[g];let v=i.byteLength;if(d)if(d>v){d-=v;continue}else i=i.subarray(d),v-=d,d=0;f.set(i,t),t+=v}return n&&(n-=r+3),{data:f,pts:a,dts:o,len:n}}return null}class A0{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const qt=Math.pow(2,32)-1;class P{static init(){P.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in P.types)P.types.hasOwnProperty(e)&&(P.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);P.HDLR_TYPES={video:t,audio:i};const n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);P.STTS=P.STSC=P.STCO=r,P.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),P.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),P.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),P.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const a=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);P.FTYP=P.box(P.types.ftyp,a,l,a,o),P.DINF=P.box(P.types.dinf,P.box(P.types.dref,n))}static box(e,...t){let i=8,n=t.length;const r=n;for(;n--;)i+=t[n].byteLength;const a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=i&255,a.set(e,4),n=0,i=8;n<r;n++)a.set(t[n],i),i+=t[n].byteLength;return a}static hdlr(e){return P.box(P.types.hdlr,P.HDLR_TYPES[e])}static mdat(e){return P.box(P.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(qt+1)),n=Math.floor(t%(qt+1));return P.box(P.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,85,196,0,0]))}static mdia(e){return P.box(P.types.mdia,P.mdhd(e.timescale||0,e.duration||0),P.hdlr(e.type),P.minf(e))}static mfhd(e){return P.box(P.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?P.box(P.types.minf,P.box(P.types.smhd,P.SMHD),P.DINF,P.stbl(e)):P.box(P.types.minf,P.box(P.types.vmhd,P.VMHD),P.DINF,P.stbl(e))}static moof(e,t,i){return P.box(P.types.moof,P.mfhd(e),P.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=P.trak(e[t]);return P.box.apply(null,[P.types.moov,P.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(P.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=P.trex(e[t]);return P.box.apply(null,[P.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(qt+1)),n=Math.floor(t%(qt+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return P.box(P.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let n,r;for(n=0;n<t.length;n++)r=t[n].flags,i[n+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return P.box(P.types.sdtp,i)}static stbl(e){return P.box(P.types.stbl,P.stsd(e),P.box(P.types.stts,P.STTS),P.box(P.types.stsc,P.STSC),P.box(P.types.stsz,P.STSZ),P.box(P.types.stco,P.STCO))}static avc1(e){let t=[],i=[],n,r,a;for(n=0;n<e.sps.length;n++)r=e.sps[n],a=r.byteLength,t.push(a>>>8&255),t.push(a&255),t=t.concat(Array.prototype.slice.call(r));for(n=0;n<e.pps.length;n++)r=e.pps[n],a=r.byteLength,i.push(a>>>8&255),i.push(a&255),i=i.concat(Array.prototype.slice.call(r));const o=P.box(P.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,c=e.height,u=e.pixelRatio[0],d=e.pixelRatio[1];return P.box(P.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,P.box(P.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),P.box(P.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,d>>24,d>>16&255,d>>8&255,d&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return P.box(P.types.mp4a,P.audioStsd(e),P.box(P.types.esds,P.esds(e)))}static mp3(e){return P.box(P.types[".mp3"],P.audioStsd(e))}static ac3(e){return P.box(P.types["ac-3"],P.audioStsd(e),P.box(P.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return P.box(P.types.stsd,P.STSD,P.mp4a(e));if(t==="ac3"&&e.config)return P.box(P.types.stsd,P.STSD,P.ac3(e));if(t==="mp3"&&e.codec==="mp3")return P.box(P.types.stsd,P.STSD,P.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return P.box(P.types.stsd,P.STSD,P.avc1(e));if(t==="hevc"&&e.vps)return P.box(P.types.stsd,P.STSD,P.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),n=e.width||0,r=e.height||0,a=Math.floor(i/(qt+1)),o=Math.floor(i%(qt+1));return P.box(P.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,n&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=P.sdtp(e),n=e.id,r=Math.floor(t/(qt+1)),a=Math.floor(t%(qt+1));return P.box(P.types.traf,P.box(P.types.tfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255])),P.box(P.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,a>>24,a>>16&255,a>>8&255,a&255])),P.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,P.box(P.types.trak,P.tkhd(e),P.mdia(e))}static trex(e){const t=e.id;return P.box(P.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],n=i.length,r=12+16*n,a=new Uint8Array(r);let o,l,c,u,d,f;for(t+=8+r,a.set([e.type==="video"?1:0,0,15,1,n>>>24&255,n>>>16&255,n>>>8&255,n&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),o=0;o<n;o++)l=i[o],c=l.duration,u=l.size,d=l.flags,f=l.cts,a.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,d.degradPrio&61440,d.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*o);return P.box(P.types.trun,a)}static initSegment(e){P.types||P.init();const t=P.moov(e);return tt(P.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],n=4,r=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),n-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let a=r.length;for(let p=0;p<i.length;p+=1){a+=3;for(let v=0;v<i[p].length;v+=1)a+=2+i[p][v].length}const o=new Uint8Array(a);o.set(r,0),a=r.length;const l=i.length-1;for(let p=0;p<i.length;p+=1){o.set(new Uint8Array([32+p|(p===l?128:0),0,i[p].length]),a),a+=3;for(let v=0;v<i[p].length;v+=1)o.set(new Uint8Array([i[p][v].length>>8,i[p][v].length&255]),a),a+=2,o.set(i[p][v],a),a+=i[p][v].length}const c=P.box(P.types.hvcC,o),u=e.width,d=e.height,f=e.pixelRatio[0],g=e.pixelRatio[1];return P.box(P.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,d>>8&255,d&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,P.box(P.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),P.box(P.types.pasp,new Uint8Array([f>>24,f>>16&255,f>>8&255,f&255,g>>24,g>>16&255,g>>8&255,g&255])))}}P.types=void 0,P.HDLR_TYPES=void 0,P.STTS=void 0,P.STSC=void 0,P.STCO=void 0,P.STSZ=void 0,P.VMHD=void 0,P.SMHD=void 0,P.STSD=void 0,P.FTYP=void 0,P.DINF=void 0;const Dd=9e4;function da(s,e,t=1,i=!1){const n=s*e*t;return i?Math.round(n):n}function I0(s,e,t=1,i=!1){return da(s,e,1/t,i)}function ns(s,e=!1){return da(s,1e3,1/Dd,e)}function w0(s,e=1){return da(s,Dd,1/e)}const L0=10*1e3,k0=1024,C0=1152,R0=1536;let Di=null,ha=null;function Od(s,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:s?2:1,isNonSync:s?0:1}}}class gn{constructor(e,t,i,n){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.ISGenerated=!1,Di===null){const a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Di=a?parseInt(a[1]):0}if(ha===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);ha=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,n=e.reduce((r,a)=>{let o=a.pts,l=o-r;return l<-4294967296&&(t=!0,o=st(o,i),l=o-r),l>0?r:o},i);return t&&this.logger.debug("PTS rollover detected"),n}remux(e,t,i,n,r,a,o,l){let c,u,d,f,g,p,v=r,S=r;const b=e.pid>-1,I=t.pid>-1,w=t.samples.length,_=e.samples.length>0,T=o&&w>0||w>1;if((!b||_)&&(!I||T)||this.ISGenerated||o){if(this.ISGenerated){var A,k,D,R;const q=this.videoTrackConfig;(q&&(t.width!==q.width||t.height!==q.height||((A=t.pixelRatio)==null?void 0:A[0])!==((k=q.pixelRatio)==null?void 0:k[0])||((D=t.pixelRatio)==null?void 0:D[1])!==((R=q.pixelRatio)==null?void 0:R[1]))||!q&&T||this.nextAudioPts===null&&_)&&this.resetInitSegment()}this.ISGenerated||(d=this.generateIS(e,t,r,a));const N=this.isVideoContiguous;let V=-1,W;if(T&&(V=P0(t.samples),!N&&this.config.forceKeyFrameOnDiscontinuity))if(p=!0,V>0){this.logger.warn(`[mp4-remuxer]: Dropped ${V} out of ${w} video samples due to a missing keyframe`);const q=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(V),t.dropped+=V,S+=(t.samples[0].pts-q)/t.inputTimeScale,W=S}else V===-1&&(this.logger.warn(`[mp4-remuxer]: No keyframe found out of ${w} video samples`),p=!1);if(this.ISGenerated){if(_&&T){const q=this.getVideoStartPts(t.samples),z=(st(e.samples[0].pts,q)-q)/t.inputTimeScale;v+=Math.max(0,z),S+=Math.max(0,-z)}if(_){if(e.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(e,t,r,a)),u=this.remuxAudio(e,v,this.isAudioContiguous,a,I||T||l===oe.AUDIO?S:void 0),T){const q=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(e,t,r,a)),c=this.remuxVideo(t,S,N,q)}}else T&&(c=this.remuxVideo(t,S,N,0));c&&(c.firstKeyFrame=V,c.independent=V!==-1,c.firstKeyFramePTS=W)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(g=Md(i,r,this._initPTS,this._initDTS)),n.samples.length&&(f=Fd(n,r,this._initPTS))),{audio:u,video:c,initSegment:d,independent:p,text:f,id3:g}}generateIS(e,t,i,n){const r=e.samples,a=t.samples,o=this.typeSupported,l={},c=this._initPTS;let u=!c||n,d="audio/mp4",f,g,p,v;if(u&&(f=g=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":o.mpeg?(d="audio/mpeg",e.codec=""):o.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}l.audio={id:"audio",container:d,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):P.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(v=e.id,p=e.inputTimeScale,!c||p!==c.timescale?f=g=r[0].pts-Math.round(p*i):u=!1)}if(t.sps&&t.pps&&a.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:P.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(v=t.id,p=t.inputTimeScale,!c||p!==c.timescale){const S=this.getVideoStartPts(a),b=Math.round(p*i);g=Math.min(g,st(a[0].dts,S)-b),f=Math.min(f,S-b)}else u=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:f,timescale:p},this._initDTS={baseTime:g,timescale:p}):f=p=void 0,{tracks:l,initPTS:f,timescale:p,trackId:v}}remuxVideo(e,t,i,n){const r=e.inputTimeScale,a=e.samples,o=[],l=a.length,c=this._initPTS;let u=this.nextAvcDts,d=8,f=this.videoSampleDuration,g,p,v=Number.POSITIVE_INFINITY,S=Number.NEGATIVE_INFINITY,b=!1;if(!i||u===null){const G=t*r,B=a[0].pts-st(a[0].dts,a[0].pts);Di&&u!==null&&Math.abs(G-B-u)<15e3?i=!0:u=G-B}const I=c.baseTime*r/c.timescale;for(let G=0;G<l;G++){const B=a[G];B.pts=st(B.pts-I,u),B.dts=st(B.dts-I,u),B.dts<a[G>0?G-1:G].dts&&(b=!0)}b&&a.sort(function(G,B){const ie=G.dts-B.dts,X=G.pts-B.pts;return ie||X}),g=a[0].dts,p=a[a.length-1].dts;const w=p-g,_=w?Math.round(w/(l-1)):f||e.inputTimeScale/30;if(i){const G=g-u,B=G>_,ie=G<-1;if((B||ie)&&(B?this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${ns(G,!0)} ms (${G}dts) hole between fragments detected at ${t.toFixed(3)}`):this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${ns(-G,!0)} ms (${G}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!ie||u>=a[0].pts||Di)){g=u;const X=a[0].pts-G;if(B)a[0].dts=g,a[0].pts=X;else{let h=!0;for(let y=0;y<a.length&&!(a[y].dts>X&&h);y++){const m=a[y].pts;if(a[y].dts-=G,a[y].pts-=G,y<a.length-1){const x=a[y+1].pts,L=a[y].pts,O=x<=L,U=x<=m;h=O==U}}}this.logger.log(`Video: Initial PTS/DTS adjusted: ${ns(X,!0)}/${ns(g,!0)}, delta: ${ns(G,!0)} ms`)}}g=Math.max(0,g);let T=0,C=0,A=g;for(let G=0;G<l;G++){const B=a[G],ie=B.units,X=ie.length;let h=0;for(let y=0;y<X;y++)h+=ie[y].data.length;C+=h,T+=X,B.length=h,B.dts<A?(B.dts=A,A+=_/4|0||1):A=B.dts,v=Math.min(B.pts,v),S=Math.max(B.pts,S)}p=a[l-1].dts;const k=C+4*T+8;let D;try{D=new Uint8Array(k)}catch(G){this.observer.emit(E.ERROR,E.ERROR,{type:te.MUX_ERROR,details:M.REMUX_ALLOC_ERROR,fatal:!1,error:G,bytes:k,reason:`fail allocating video mdat ${k}`});return}const R=new DataView(D.buffer);R.setUint32(0,k),D.set(P.types.mdat,4);let N=!1,V=Number.POSITIVE_INFINITY,W=Number.POSITIVE_INFINITY,q=Number.NEGATIVE_INFINITY,ee=Number.NEGATIVE_INFINITY;for(let G=0;G<l;G++){const B=a[G],ie=B.units;let X=0;for(let m=0,x=ie.length;m<x;m++){const L=ie[m],O=L.data,U=L.data.byteLength;R.setUint32(d,U),d+=4,D.set(O,d),d+=U,X+=4+U}let h;if(G<l-1)f=a[G+1].dts-B.dts,h=a[G+1].pts-B.pts;else{const m=this.config,x=G>0?B.dts-a[G-1].dts:_;if(h=G>0?B.pts-a[G-1].pts:_,m.stretchShortVideoTrack&&this.nextAudioPts!==null){const L=Math.floor(m.maxBufferHole*r),O=(n?v+n*r:this.nextAudioPts)-B.pts;O>L?(f=O-x,f<0?f=x:N=!0,this.logger.log(`[mp4-remuxer]: It is approximately ${O/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=x}else f=x}const y=Math.round(B.pts-B.dts);V=Math.min(V,f),q=Math.max(q,f),W=Math.min(W,h),ee=Math.max(ee,h),o.push(Od(B.key,f,X,y))}if(o.length){if(Di){if(Di<70){const G=o[0].flags;G.dependsOn=2,G.isNonSync=0}}else if(ha&&ee-W<q-V&&_/q<.025&&o[0].cts===0){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let G=g;for(let B=0,ie=o.length;B<ie;B++){const X=G+o[B].duration,h=G+o[B].cts;if(B<ie-1){const y=X+o[B+1].cts;o[B].duration=y-h}else o[B].duration=B?o[B-1].duration:_;o[B].cts=0,G=X}}}f=N||!f?_:f,this.nextAvcDts=u=p+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const pe={data1:P.moof(e.sequenceNumber++,g,Ae(e,{samples:o})),data2:D,startPTS:v/r,endPTS:(S+f)/r,startDTS:g/r,endDTS:u/r,type:"video",hasAudio:!1,hasVideo:!0,nb:o.length,dropped:e.dropped};return e.samples=[],e.dropped=0,pe}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return C0;case"ac3":return R0;default:return k0}}remuxAudio(e,t,i,n,r){const a=e.inputTimeScale,o=e.samplerate?e.samplerate:a,l=a/o,c=this.getSamplesPerFrame(e),u=c*l,d=this._initPTS,f=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,g=[],p=r!==void 0;let v=e.samples,S=f?0:8,b=this.nextAudioPts||-1;const I=t*a,w=d.baseTime*a/d.timescale;if(this.isAudioContiguous=i=i||v.length&&b>0&&(n&&Math.abs(I-b)<9e3||Math.abs(st(v[0].pts-w,I)-b)<20*u),v.forEach(function(z){z.pts=st(z.pts-w,I)}),!i||b<0){if(v=v.filter(z=>z.pts>=0),!v.length)return;r===0?b=0:n&&!p?b=Math.max(0,I):b=v[0].pts}if(e.segmentCodec==="aac"){const z=this.config.maxAudioFramesDrift;for(let K=0,pe=b;K<v.length;K++){const G=v[K],B=G.pts,ie=B-pe,X=Math.abs(1e3*ie/a);if(ie<=-z*u&&p)K===0&&(this.logger.warn(`Audio frame @ ${(B/a).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*ie/a)} ms.`),this.nextAudioPts=b=pe=B);else if(ie>=z*u&&X<L0&&p){let h=Math.round(ie/u);pe=B-h*u,pe<0&&(h--,pe+=u),K===0&&(this.nextAudioPts=b=pe),this.logger.warn(`[mp4-remuxer]: Injecting ${h} audio frame @ ${(pe/a).toFixed(3)}s due to ${Math.round(1e3*ie/a)} ms gap.`);for(let y=0;y<h;y++){const m=Math.max(pe,0);let x=A0.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);x||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),x=G.unit.subarray()),v.splice(K,0,{unit:x,pts:m}),pe+=u,K++}}G.pts=pe,pe+=u}}let _=null,T=null,C,A=0,k=v.length;for(;k--;)A+=v[k].unit.byteLength;for(let z=0,K=v.length;z<K;z++){const pe=v[z],G=pe.unit;let B=pe.pts;if(T!==null){const X=g[z-1];X.duration=Math.round((B-T)/l)}else if(i&&e.segmentCodec==="aac"&&(B=b),_=B,A>0){A+=S;try{C=new Uint8Array(A)}catch(X){this.observer.emit(E.ERROR,E.ERROR,{type:te.MUX_ERROR,details:M.REMUX_ALLOC_ERROR,fatal:!1,error:X,bytes:A,reason:`fail allocating audio mdat ${A}`});return}f||(new DataView(C.buffer).setUint32(0,A),C.set(P.types.mdat,4))}else return;C.set(G,S);const ie=G.byteLength;S+=ie,g.push(Od(!0,c,ie,0)),T=B}const D=g.length;if(!D)return;const R=g[g.length-1];this.nextAudioPts=b=T+l*R.duration;const N=f?new Uint8Array(0):P.moof(e.sequenceNumber++,_/l,Ae({},e,{samples:g}));e.samples=[];const V=_/a,W=b/a,ee={data1:N,data2:C,startPTS:V,endPTS:W,startDTS:V,endDTS:W,type:"audio",hasAudio:!0,hasVideo:!1,nb:D};return this.isAudioContiguous=!0,ee}}function st(s,e){let t;if(e===null)return s;for(e<s?t=-8589934592:t=8589934592;Math.abs(s-e)>4294967296;)s+=t;return s}function P0(s){for(let e=0;e<s.length;e++)if(s[e].key)return e;return-1}function Md(s,e,t,i){const n=s.samples.length;if(!n)return;const r=s.inputTimeScale;for(let o=0;o<n;o++){const l=s.samples[o];l.pts=st(l.pts-t.baseTime*r/t.timescale,e*r)/r,l.dts=st(l.dts-i.baseTime*r/i.timescale,e*r)/r}const a=s.samples;return s.samples=[],{samples:a}}function Fd(s,e,t){const i=s.samples.length;if(!i)return;const n=s.inputTimeScale;for(let a=0;a<i;a++){const o=s.samples[a];o.pts=st(o.pts-t.baseTime*n/t.timescale,e*n)/n}s.samples.sort((a,o)=>a.pts-o.pts);const r=s.samples;return s.samples=[],{samples:r}}class D0{constructor(e,t,i,n){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1,this.logger=n}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,i,n){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(Tg(e,n)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const n=this.initData=wu(e);n.audio&&(t=Nd(n.audio,$e.AUDIO,this.logger)),n.video&&(i=Nd(n.video,$e.VIDEO,this.logger));const r={};n.audio&&n.video?r.audiovideo={container:"video/mp4",codec:t+","+i,supplemental:n.video.supplemental,initSegment:e,id:"main"}:n.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:n.video?r.video={container:"video/mp4",codec:i,supplemental:n.video.supplemental,initSegment:e,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,n,r,a){var o,l;let{initPTS:c,lastEndTime:u}=this;const d={audio:void 0,video:void 0,text:n,id3:i,initSegment:void 0};J(u)||(u=this.lastEndTime=r||0);const f=t.samples;if(!(f!=null&&f.length))return d;const g={initPTS:void 0,timescale:void 0,trackId:void 0};let p=this.initData;if((o=p)!=null&&o.length||(this.generateInitSegment(f),p=this.initData),!((l=p)!=null&&l.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),d;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);const v=_g(f,p,this.logger),S=p.audio?v[p.audio.id]:null,b=p.video?v[p.video.id]:null,I=mn(b,1/0),w=mn(S,1/0),_=mn(b,0,!0),T=mn(S,0,!0);let C,A=r,k=0;if(S&&(!b||!c&&w<I||c&&c.trackId===p.audio.id)?(g.trackId=p.audio.id,C=S,k=T-w):b&&(g.trackId=p.video.id,C=b,k=_-I),C){const z=C.timescale;A=C.start/z,g.timescale=z,c||(g.initPTS=C.start-r*z,this.initPTS=c={baseTime:g.initPTS,timescale:z,trackId:g.trackId})}(a||!c)&&(O0(c,A,r,k)||g.timescale!==c.timescale)&&(g.initPTS=A-r,c&&c.timescale===1&&this.logger.warn(`Adjusting initPTS @${r} from ${c.baseTime/c.timescale} to ${g.initPTS}`),this.initPTS=c={baseTime:g.initPTS,timescale:1});const D=e?A-c.baseTime/c.timescale:u;xg(p,f,c.baseTime/c.timescale);const R=D+k;k>0?this.lastEndTime=R:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const N=!!p.audio,V=!!p.video;let W="";N&&(W+="audio"),V&&(W+="video");const q={data1:f,startPTS:D,startDTS:D,endPTS:R,endDTS:R,type:W,hasAudio:N,hasVideo:V,nb:1,dropped:0};d.audio=N&&!V?q:void 0,d.video=V?q:void 0;const ee=b==null?void 0:b.sampleCount;if(ee){const z=b.keyFrameIndex,K=z!==-1;q.nb=ee,q.dropped=z===0||this.isVideoContiguous?0:K?z:ee,q.independent=K,q.firstKeyFrame=z,K&&b.keyFrameStart&&(q.firstKeyFramePTS=b.keyFrameStart-c.baseTime/c.timescale),this.isVideoContiguous||(d.independent=K),this.isVideoContiguous||(this.isVideoContiguous=K),q.dropped&&this.logger.warn(`fmp4 does not start with IDR: firstIDR ${z}/${ee} dropped: ${q.dropped} pts: ${q.firstKeyFramePTS||"NA"}`)}return d.initSegment=g,d.id3=Md(i,r,c,c),n.samples.length&&(d.text=Fd(n,r,c)),d}}function mn(s,e,t=!1){return(s==null?void 0:s.start)!==void 0?(s.start+(t?s.duration:0))/s.timescale:e}function O0(s,e,t,i){if(s===null)return!0;const n=Math.max(i,1),r=e-s.baseTime/s.timescale;return Math.abs(r-t)>n}function Nd(s,e,t){const i=s==null?void 0:s.codec;return i&&i.length>4?i:e===$e.AUDIO?i==="ec-3"||i==="ac-3"||i==="alac"?i:i==="fLaC"||i==="Opus"?qr(i,!1):(t.warn(`Unhandled audio codec "${i}" in mp4 MAP`),i||"mp4a"):(t.warn(`Unhandled video codec "${i}" in mp4 MAP`),i||"avc1")}let Pt;try{Pt=self.performance.now.bind(self.performance)}catch{Pt=Date.now}const vn=[{demux:b0,remux:D0},{demux:Vt,remux:gn},{demux:v0,remux:gn},{demux:S0,remux:gn}];vn.splice(2,0,{demux:y0,remux:gn});class Ud{constructor(e,t,i,n,r,a){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=r,this.logger=a}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,n){const r=i.transmuxing;r.executeStart=Pt();let a=new Uint8Array(e);const{currentTransmuxState:o,transmuxConfig:l}=this;n&&(this.currentTransmuxState=n);const{contiguous:c,discontinuity:u,trackSwitch:d,accurateTimeOffset:f,timeOffset:g,initSegmentChange:p}=n||o,{audioCodec:v,videoCodec:S,defaultInitPts:b,duration:I,initSegmentData:w}=l,_=M0(a,t);if(_&&ki(_.method)){const k=this.getDecrypter(),D=Wr(_.method);if(k.isSync()){let R=k.softwareDecrypt(a,_.key.buffer,_.iv.buffer,D);if(i.part>-1){const V=k.flush();R=V&&V.buffer}if(!R)return r.executeEnd=Pt(),fa(i);a=new Uint8Array(R)}else return this.asyncResult=!0,this.decryptionPromise=k.webCryptoDecrypt(a,_.key.buffer,_.iv.buffer,D).then(R=>{const N=this.push(R,null,i);return this.decryptionPromise=null,N}),this.decryptionPromise}const T=this.needsProbing(u,d);if(T){const k=this.configureTransmuxer(a);if(k)return this.logger.warn(`[transmuxer] ${k.message}`),this.observer.emit(E.ERROR,E.ERROR,{type:te.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,fatal:!1,error:k,reason:k.message}),r.executeEnd=Pt(),fa(i)}(u||d||p||T)&&this.resetInitSegment(w,v,S,I,t),(u||p||T)&&this.resetInitialTimestamp(b),c||this.resetContiguity();const C=this.transmux(a,_,g,f,i);this.asyncResult=yn(C);const A=this.currentTransmuxState;return A.contiguous=!0,A.discontinuity=!1,A.trackSwitch=!1,r.executeEnd=Pt(),C}flush(e){const t=e.transmuxing;t.executeStart=Pt();const{decrypter:i,currentTransmuxState:n,decryptionPromise:r}=this;if(r)return this.asyncResult=!0,r.then(()=>this.flush(e));const a=[],{timeOffset:o}=n;if(i){const d=i.flush();d&&a.push(this.push(d.buffer,null,e))}const{demuxer:l,remuxer:c}=this;if(!l||!c){t.executeEnd=Pt();const d=[fa(e)];return this.asyncResult?Promise.resolve(d):d}const u=l.flush(o);return yn(u)?(this.asyncResult=!0,u.then(d=>(this.flushRemux(a,d,e),a))):(this.flushRemux(a,u,e),this.asyncResult?Promise.resolve(a):a)}flushRemux(e,t,i){const{audioTrack:n,videoTrack:r,id3Track:a,textTrack:o}=t,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===oe.MAIN?"level":"track"} ${i.level}`);const u=this.remuxer.remux(n,r,a,o,c,l,!0,this.id);e.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=Pt()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,n,r){const{demuxer:a,remuxer:o}=this;!a||!o||(a.resetInitSegment(e,t,i,n),o.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,n,r){let a;return t&&t.method==="SAMPLE-AES"?a=this.transmuxSampleAes(e,t,i,n,r):a=this.transmuxUnencrypted(e,i,n,r),a}transmuxUnencrypted(e,t,i,n){const{audioTrack:r,videoTrack:a,id3Track:o,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,a,o,l,t,i,!1,this.id),chunkMeta:n}}transmuxSampleAes(e,t,i,n,r){return this.demuxer.demuxSampleAes(e,t,i).then(a=>({remuxResult:this.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,i,n,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:n}=this;let r;for(let d=0,f=vn.length;d<f;d++){var a;if((a=vn[d].demux)!=null&&a.probe(e,this.logger)){r=vn[d];break}}if(!r)return new Error("Failed to find demuxer by probing fragment data");const o=this.demuxer,l=this.remuxer,c=r.remux,u=r.demux;(!l||!(l instanceof c))&&(this.remuxer=new c(i,t,n,this.logger)),(!o||!(o instanceof u))&&(this.demuxer=new u(i,t,n,this.logger),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Yr(this.config)),e}}function M0(s,e){let t=null;return s.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const fa=s=>({remuxResult:{},chunkMeta:s});function yn(s){return"then"in s&&s.then instanceof Function}class F0{constructor(e,t,i,n,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=n,this.defaultInitPts=r||null}}class N0{constructor(e,t,i,n,r,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=r,this.initSegmentChange=a}}let Bd=0;class U0{constructor(e,t,i,n){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=Bd++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=l=>{const c=l.data,u=this.hls;if(!(!u||!(c!=null&&c.event)||c.instanceNo!==this.instanceNo))switch(c.event){case"init":{var d;const f=(d=this.workerContext)==null?void 0:d.objectURL;f&&self.URL.revokeObjectURL(f);break}case"transmuxComplete":{this.handleTransmuxComplete(c.data);break}case"flush":{this.onFlush(c.data);break}case"workerLog":{u.logger[c.data.logType]&&u.logger[c.data.logType](c.data.message);break}default:{c.data=c.data||{},c.data.frag=this.frag,c.data.part=this.part,c.data.id=this.id,u.trigger(c.event,c.data);break}}},this.onWorkerError=l=>{if(!this.hls)return;const c=new Error(`${l.message}  (${l.filename}:${l.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(E.ERROR,{type:te.OTHER_ERROR,details:M.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:c})};const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=n;const a=(l,c)=>{c=c||{},c.frag=this.frag||void 0,l===E.ERROR&&(c=c,c.parent=this.id,c.part=this.part,this.error=c.error),this.hls.trigger(l,c)};this.observer=new md,this.observer.on(E.FRAG_DECRYPTED,a),this.observer.on(E.ERROR,a);const o=Ou(r.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const l=this.hls.logger;if(r.workerPath||jm()){try{r.workerPath?(l.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=Vm(r.workerPath)):(l.log(`injecting Web Worker for "${t}"`),this.workerContext=Gm());const{worker:u}=this.workerContext;u.addEventListener("message",this.onWorkerMessage),u.addEventListener("error",this.onWorkerError),u.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:o,id:t,config:we(r)})}catch(u){l.warn(`Error setting up "${t}" Web Worker, fallback to inline`,u),this.terminateWorker(),this.error=null,this.transmuxer=new Ud(this.observer,o,r,"",t,e.logger)}return}}this.transmuxer=new Ud(this.observer,o,r,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=Bd++;const t=this.hls.config,i=Ou(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:we(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),qm(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,n,r,a,o,l,c,u){var d,f;c.transmuxing.start=self.performance.now();const{instanceNo:g,transmuxer:p}=this,v=a?a.start:r.start,S=r.decryptdata,b=this.frag,I=!(b&&r.cc===b.cc),w=!(b&&c.level===b.level),_=b?c.sn-b.sn:-1,T=this.part?c.part-this.part.index:-1,C=_===0&&c.id>1&&c.id===(b==null?void 0:b.stats.chunkCount),A=!w&&(_===1||_===0&&(T===1||C&&T<=0)),k=self.performance.now();(w||_||r.stats.parsing.start===0)&&(r.stats.parsing.start=k),a&&(T||!A)&&(a.stats.parsing.start=k);const D=!(b&&((d=r.initSegment)==null?void 0:d.url)===((f=b.initSegment)==null?void 0:f.url)),R=new N0(I,A,l,w,v,D);if(!A||I||D){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${r.type} sn: ${c.sn}${c.part>-1?" part: "+c.part:""} ${this.id===oe.MAIN?"level":"track"}: ${c.level} id: ${c.id}
        discontinuity: ${I}
        trackSwitch: ${w}
        contiguous: ${A}
        accurateTimeOffset: ${l}
        timeOffset: ${v}
        initSegmentChange: ${D}`);const N=new F0(i,n,t,o,u);this.configureTransmuxer(N)}if(this.frag=r,this.part=a,this.workerContext)this.workerContext.worker.postMessage({instanceNo:g,cmd:"demux",data:e,decryptdata:S,chunkMeta:c,state:R},e instanceof ArrayBuffer?[e]:[]);else if(p){const N=p.push(e,S,c,R);yn(N)?N.then(V=>{this.handleTransmuxComplete(V)}).catch(V=>{this.transmuxerError(V,c,"transmuxer-interface push error")}):this.handleTransmuxComplete(N)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const n=i.flush(e);yn(n)?n.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")}):this.handleFlushResult(n,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(E.ERROR,{type:te.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const $d=100;class B0 extends fd{constructor(e,t,i){super(e,t,i,"audio-stream-controller",oe.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(E.LEVEL_LOADED,this.onLevelLoaded,this),e.on(E.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(E.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(E.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(E.BUFFER_RESET,this.onBufferReset,this),e.on(E.BUFFER_CREATED,this.onBufferCreated,this),e.on(E.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(E.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(E.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(E.FRAG_LOADING,this.onFragLoading,this),e.on(E.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(E.LEVEL_LOADED,this.onLevelLoaded,this),e.off(E.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(E.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(E.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(E.BUFFER_RESET,this.onBufferReset,this),e.off(E.BUFFER_CREATED,this.onBufferCreated,this),e.off(E.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(E.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(E.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(E.FRAG_LOADING,this.onFragLoading,this),e.off(E.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:r}){if(i===oe.MAIN){const a=t.cc,o=this.fragCurrent;if(this.initPTS[a]={baseTime:n,timescale:r},this.log(`InitPTS for cc: ${a} found from main: ${n}/${r}`),this.mainAnchor=t,this.state===j.WAITING_INIT_PTS){const l=this.waitingData;(!l&&!this.loadingParts||l&&l.frag.cc!==a)&&this.syncWithAnchor(t,l==null?void 0:l.frag)}else!this.hls.hasEnoughToStart&&o&&o.cc!==a?(o.abortRequests(),this.syncWithAnchor(t,o)):this.state===j.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var i;const n=((i=this.mainFragLoading)==null?void 0:i.frag)||null;if(t&&(n==null?void 0:n.cc)===t.cc)return;const r=(n||e).cc,a=this.getLevelDetails(),o=this.getLoadPosition(),l=Yu(a,r,o);l&&(this.log(`Waiting fragment cc (${t==null?void 0:t.cc}) cancelled because video is at cc ${e.cc}`),this.startFragRequested=!1,this.nextLoadPosition=l.start,this.resetLoadingState(),this.state===j.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=j.STOPPED;return}const i=this.lastCurrentTime;this.stopLoad(),this.setInterval($d),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=j.IDLE):this.state=j.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case j.IDLE:this.doTickIdle();break;case j.WAITING_TRACK:{const{levels:t,trackId:i}=this,n=t==null?void 0:t[i],r=n==null?void 0:n.details;if(r&&!this.waitForLive(n)){if(this.waitForCdnTuneIn(r))break;this.state=j.WAITING_INIT_PTS}break}case j.FRAG_LOADING_WAITING_RETRY:{var e;const t=performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:n,trackId:r}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((n==null?void 0:n[r])||null),this.state=j.IDLE}break}case j.WAITING_INIT_PTS:{const t=this.waitingData;if(t){const{frag:i,part:n,cache:r,complete:a}=t,o=this.mainAnchor;if(this.initPTS[i.cc]!==void 0){this.waitingData=null,this.state=j.FRAG_LOADING;const l=r.flush().buffer,c={frag:i,part:n,payload:l,networkDetails:null};this._handleFragmentLoadProgress(c),a&&super._handleFragmentLoadComplete(c)}else o&&o.cc!==t.frag.cc&&this.syncWithAnchor(o,t.frag)}else this.state=j.IDLE}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:n,trackId:r}=this,a=t.config;if(!this.buffering||!n&&!this.primaryPrefetch&&(this.startFragRequested||!a.startFragPrefetch)||!(i!=null&&i[r]))return;const o=i[r],l=o.details;if(!l||this.waitForLive(o)||this.waitForCdnTuneIn(l)){this.state=j.WAITING_TRACK,this.startFragRequested=!1;return}const c=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&c&&(this.bufferFlushed=!1,this.afterBufferFlushed(c,$e.AUDIO,oe.AUDIO));const u=this.getFwdBufferInfo(c,oe.AUDIO);if(u===null)return;if(!this.switchingTrack&&this._streamEnded(u,l)){t.trigger(E.BUFFER_EOS,{type:"audio"}),this.state=j.ENDED;return}const d=u.len,f=t.maxBufferLength,g=l.fragments,p=g[0].start,v=this.getLoadPosition(),S=this.flushing?v:u.end;if(this.switchingTrack&&n){const w=v;l.PTSKnown&&w<p&&(u.end>p||u.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=p+.05)}if(d>=f&&!this.switchingTrack&&S<g[g.length-1].start)return;let b=this.getNextFragment(S,l);if(b&&this.isLoopLoading(b,S)&&(b=this.getNextFragmentLoopLoading(b,l,u,oe.MAIN,f)),!b){this.bufferFlushed=!0;return}let I=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&I&&ze(b)&&!b.endList&&(!l.live||!this.loadingParts&&S<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(I)===it.OK&&(this.mainFragLoading=I=null),I&&ze(I))){if(b.start>I.end){const _=this.fragmentTracker.getFragAtPos(S,oe.MAIN);_&&_.end>I.end&&(I=_,this.mainFragLoading={frag:_,targetBufferTime:null})}if(b.start>I.end)return}this.loadFragment(b,o,S)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new Xs(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:n}=this;n&&(n.abortRequests(),this.removeUnbufferedFrags(n.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==j.STOPPED&&(this.setInterval($d),this.state=j.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(E.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:n}=this,{details:r,id:a,groupId:o,track:l}=t;if(!n){this.warn(`Audio tracks reset while loading track ${a} "${l.name}" of "${o}"`);return}const c=this.mainDetails;if(!c||r.endCC>c.endCC||c.expired){this.cachedTrackLoadedData=t,this.state!==j.STOPPED&&(this.state=j.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${a} "${l.name}" of "${o}" loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const u=n[a];let d=0;if(r.live||(i=u.details)!=null&&i.live){if(this.checkLiveUpdate(r),r.deltaUpdateFailed)return;if(u.details){var f;d=this.alignPlaylists(r,u.details,(f=this.levelLastLoaded)==null?void 0:f.details)}r.alignedSliding||(hd(r,c),r.alignedSliding||cn(r,c),d=r.fragmentStart)}u.details=r,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(c,d),this.hls.trigger(E.AUDIO_TRACK_UPDATED,{details:r,id:a,groupId:t.groupId}),this.state===j.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=j.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:r}=e,{config:a,trackId:o,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const c=l[o];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const u=c.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const d=a.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let f=this.transmuxer;f||(f=this.transmuxer=new U0(this.hls,oe.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const g=this.initPTS[i.cc],p=(t=i.initSegment)==null?void 0:t.data;if(g!==void 0){const S=n?n.index:-1,b=S!==-1,I=new Zu(i.level,i.sn,i.stats.chunkCount,r.byteLength,S,b);f.push(r,p,d,"",i,n,u.totalduration,!1,I,g)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${o}`);const{cache:v}=this.waitingData=this.waitingData||{frag:i,part:n,cache:new Nm,complete:!1};v.push(new Uint8Array(r)),this.state!==j.STOPPED&&(this.state=j.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===oe.MAIN&&ze(t.frag)&&(this.mainFragLoading=t,this.state===j.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:i,part:n}=t;if(i.type!==oe.AUDIO){!this.audioOnly&&i.type===oe.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(ze(i)){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(E.AUDIO_TRACK_SWITCHED,_e({},r)))}this.fragBufferedComplete(i,n),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=j.ERROR;return}switch(t.details){case M.FRAG_GAP:case M.FRAG_PARSING_ERROR:case M.FRAG_DECRYPT_ERROR:case M.FRAG_LOAD_ERROR:case M.FRAG_LOAD_TIMEOUT:case M.KEY_LOAD_ERROR:case M.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(oe.AUDIO,t);break;case M.AUDIO_TRACK_LOAD_ERROR:case M.AUDIO_TRACK_LOAD_TIMEOUT:case M.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===j.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===Ct.AUDIO_TRACK&&(this.state=j.IDLE);break;case M.BUFFER_ADD_CODEC_ERROR:case M.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.resetLoadingState();break;case M.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case M.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==$e.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==$e.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===j.ENDED&&(this.state=j.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,oe.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:n}=this,{remuxResult:r,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:u}=o,{details:d}=u,{audio:f,text:g,id3:p,initSegment:v}=r;if(this.fragContextChanged(l)||!d){this.fragmentTracker.removeFragment(l);return}if(this.state=j.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),v!=null&&v.tracks){const S=l.initSegment||l;this._bufferInitSegment(u,v.tracks,S,a),n.trigger(E.FRAG_PARSING_INIT_SEGMENT,{frag:S,id:i,tracks:v.tracks})}if(f){const{startPTS:S,endPTS:b,startDTS:I,endDTS:w}=f;c&&(c.elementaryStreams[$e.AUDIO]={startPTS:S,endPTS:b,startDTS:I,endDTS:w}),l.setElementaryStreamInfo($e.AUDIO,S,b,I,w),this.bufferFragmentData(f,l,c,a)}if(p!=null&&(t=p.samples)!=null&&t.length){const S=Ae({id:i,frag:l,details:d},p);n.trigger(E.FRAG_PARSING_METADATA,S)}if(g){const S=Ae({id:i,frag:l,details:d},g);n.trigger(E.FRAG_PARSING_USERDATA,S)}}_bufferInitSegment(e,t,i,n){if(this.state!==j.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const r=t.audio;r.id=oe.AUDIO;const a=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${a}/${r.codec}]`),a&&a.split(",").length===1&&(r.levelCodec=a),this.hls.trigger(E.BUFFER_CODECS,t);const o=r.initSegment;if(o!=null&&o.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:n,parent:i.type,data:o};this.hls.trigger(E.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);if(this.switchingTrack||n===it.NOT_LOADED||n===it.PARTIAL){var r;if(!ze(e))this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=j.WAITING_INIT_PTS;const a=this.mainDetails;a&&a.fragmentStart!==t.details.fragmentStart&&cn(t.details,a)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:o}=this.bufferedTrack;ui({name:t,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:o},e,di)||(qu(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(E.AUDIO_TRACK_SWITCHED,_e({},e))}}class jd extends Rt{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const n=t==null?void 0:t.renditionReports;if(n){let r=-1;for(let a=0;a<n.length;a++){const o=n[a];let l;try{l=new self.URL(o.URI,t.url).href}catch(c){this.warn(`Could not construct new URL for Rendition Report: ${c}`),l=o.URI||""}if(l===e){r=a;break}else l===e.substring(0,l.length)&&(r=a)}if(r!==-1){const a=n[r],o=parseInt(a["LAST-MSN"])||(t==null?void 0:t.lastPartSn);let l=parseInt(a["LAST-PART"])||(t==null?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const u=Math.min(t.age-t.partTarget,t.targetduration);l>=0&&u>t.partTarget&&(l+=1)}const c=i&&Bu(i);return new $u(o,l>=0?l:void 0,c)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){const{details:n,stats:r}=t,a=self.performance.now(),o=r.loading.first?Math.max(0,a-r.loading.first):0;n.advancedDateTime=Date.now()-o;const l=this.hls.config.timelineOffset;if(l!==n.appliedTimelineOffset){const u=Math.max(l||0,0);n.appliedTimelineOffset=u,n.fragments.forEach(d=>{d.start=d.playlistOffset+u})}if(n.live||i!=null&&i.live){const u="levelInfo"in t?t.levelInfo:t.track;if(n.reloaded(i),i&&n.fragments.length>0){Lm(i,n);const I=n.playlistParsingError;if(I){this.warn(I);const w=this.hls;if(!w.config.ignorePlaylistParsingErrors){var c;const{networkDetails:_}=t;w.trigger(E.ERROR,{type:te.NETWORK_ERROR,details:M.LEVEL_PARSING_ERROR,fatal:!1,url:n.url,error:I,reason:I.message,level:t.level||void 0,parent:(c=n.fragments[0])==null?void 0:c.type,networkDetails:_,stats:r});return}n.playlistParsingError=null}}n.requestScheduled===-1&&(n.requestScheduled=r.loading.start);const d=this.hls.mainForwardBufferInfo,f=d?d.end-d.len:0,g=(n.edge-f)*1e3,p=Pm(n,g);if(n.requestScheduled+p<a?n.requestScheduled=a:n.requestScheduled+=p,this.log(`live playlist ${e} ${n.advanced?"REFRESHED "+n.lastPartSn+"-"+n.lastPartIndex:n.updated?"UPDATED":"MISSED"}`),!this.canLoad||!n.live)return;let v,S,b;if(n.canBlockReload&&n.endSN&&n.advanced){const I=this.hls.config.lowLatencyMode,w=n.lastPartSn,_=n.endSN,T=n.lastPartIndex,C=T!==-1,A=w===_;C?A?(S=_+1,b=I?0:T):(S=w,b=I?T+1:n.maxPartIndex):S=_+1;const k=n.age,D=k+n.ageHeader;let R=Math.min(D-n.partTarget,n.targetduration*1.5);if(R>0){if(D>n.targetduration*3)this.log(`Playlist last advanced ${k.toFixed(2)}s ago. Omitting segment and part directives.`),S=void 0,b=void 0;else if(i!=null&&i.tuneInGoal&&D-n.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${R} with playlist age: ${n.age}`),R=0;else{const N=Math.floor(R/n.targetduration);if(S+=N,b!==void 0){const V=Math.round(R%n.targetduration/n.partTarget);b+=V}this.log(`CDN Tune-in age: ${n.ageHeader}s last advanced ${k.toFixed(2)}s goal: ${R} skip sn ${N} to part ${b}`)}n.tuneInGoal=R}if(v=this.getDeliveryDirectives(n,t.deliveryDirectives,S,b),I||!A){n.requestScheduled=a,this.loadingPlaylist(u,v);return}}else(n.canBlockReload||n.canSkipUntil)&&(v=this.getDeliveryDirectives(n,t.deliveryDirectives,S,b));v&&S!==void 0&&n.canBlockReload&&(n.requestScheduled=r.loading.first+Math.max(p-o*2,p/2)),this.scheduleLoading(u,v,n)}else this.clearTimer()}scheduleLoading(e,t,i){const n=i||e.details;if(!n){this.loadingPlaylist(e,t);return}const r=self.performance.now(),a=n.requestScheduled;if(r>=a){this.loadingPlaylist(e,t);return}const o=a-r;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(o)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),o)}getDeliveryDirectives(e,t,i,n){let r=Bu(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,n=t.part,r=Qs.No),new $u(i,n,r)}checkRetry(e){const t=e.details,i=Zs(e),n=e.errorAction,{action:r,retryCount:a=0,retryConfig:o}=n||{},l=!!n&&!!o&&(r===Oe.RetryRequest||!n.resolved&&r===Oe.SendAlternateToPenaltyBox);if(l){var c;if(a>=o.maxNumRetry)return!1;if(i&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const u=Hr(o,a);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" in ${u}ms`)}e.levelRetry=!0,n.resolved=!0}return l}}function Gd(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!rs(s[t].attrs,e[t].attrs))return!1;return!0}function rs(s,e,t){const i=s["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(n=>s[n]!==e[n])}function pa(s,e){return e.label.toLowerCase()===s.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(s.lang||"").toLowerCase())}class $0 extends jd{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.LEVEL_LOADING,this.onLevelLoading,this),e.on(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(E.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.LEVEL_LOADING,this.onLevelLoading,this),e.off(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(E.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(E.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:n,details:r}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==n){this.warn(`Audio track with id:${i} and group:${n} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Audio track ${i} "${a.name}" lang:${a.lang} group:${n} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,n=this.groupIds;let r=this.currentTrack;if(!i||(n==null?void 0:n.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(n==null?void 0:n.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(f=>!i||i.indexOf(f.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(f=>f.default)&&(this.selectDefaultTrack=!1),o.forEach((f,g)=>{f.id=g});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const l=this.hls.config.audioPreference;if(!r&&l){const f=St(l,o,di);if(f>-1)r=o[f];else{const g=St(l,this.tracks);r=this.tracks[g]}}let c=this.findTrackId(r);c===-1&&r&&(c=this.findTrackId(null));const u={audioTracks:o};this.log(`Updating audio tracks, ${o.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(E.AUDIO_TRACKS_UPDATED,u);const d=this.trackId;if(c!==-1&&d===-1)this.setAudioTrack(c);else if(o.length&&d===-1){var a;const f=new Error(`No audio track selected for current audio group-ID(s): ${(a=this.groupIds)==null?void 0:a.join(",")} track count: ${o.length}`);this.warn(f.message),this.hls.trigger(E.ERROR,{type:te.MEDIA_ERROR,details:M.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:f})}}}onError(e,t){t.fatal||!t.context||t.context.type===Ct.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const n=this.currentTrack;if(n&&ui(e,n,di))return n;const r=St(e,this.tracksInGroup,di);if(r>-1){const a=this.tracksInGroup[r];return this.setAudioTrack(r),a}else if(n){let a=t.loadLevel;a===-1&&(a=t.firstAutoLevel);const o=Qg(e,t.levels,i,a,di);if(o===-1)return null;t.nextLoadLevel=o}if(e.channels||e.audioCodec){const a=St(e,i);if(a>-1)return i[a]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e],r=n.details&&!n.details.live;if(e===this.trackId&&n===i&&r||(this.log(`Switching to audio-track ${e} "${n.name}" lang:${n.lang} group:${n.groupId} channels:${n.channels}`),this.trackId=e,this.currentTrack=n,this.hls.trigger(E.AUDIO_TRACK_SWITCHING,_e({},n)),r))return;const a=this.switchParams(n.url,i==null?void 0:i.details,n.details);this.loadPlaylist(a)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(!(this.selectDefaultTrack&&!n.default)&&(!e||ui(e,n,di)))return i}if(e){const{name:i,lang:n,assocLang:r,characteristics:a,audioCodec:o,channels:l}=e;for(let c=0;c<t.length;c++){const u=t[c];if(ui({name:i,lang:n,assocLang:r,characteristics:a,audioCodec:o,channels:l},u,di))return c}for(let c=0;c<t.length;c++){const u=t[c];if(rs(e.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<t.length;c++){const u=t[c];if(rs(e.attrs,u.attrs,["LANGUAGE"]))return c}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&qu(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,r=this.getUrlWithDirectives(e.url,t),a=e.details,o=a==null?void 0:a.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${n}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${o&&a.live?" age "+o.toFixed(1)+(a.type&&" "+a.type||""):""} ${r}`),this.hls.trigger(E.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:n,deliveryDirectives:t||null,track:e})}}class j0{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;const n=this.queues[t];n.push(e),n.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const n=t[0];try{n.execute()}catch(r){var i;if(n.onError(r),this.queues===null||this.tracks===null)return;const a=(i=this.tracks[e])==null?void 0:i.buffer;a!=null&&a.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=(t=this.tracks)==null?void 0:t[e],n=i==null?void 0:i.buffer;return n?`SourceBuffer${n.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}}const Vd=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,qd="HlsJsTrackRemovedError";class G0 extends Error{constructor(e){super(e),this.name=qd}}class V0 extends Rt{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var n;this.hls&&((n=this.mediaSource)==null?void 0:n.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{const{media:n,mediaSource:r}=this;i&&this.log("Media source opened"),!(!n||!r)&&(r.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(E.MEDIA_ATTACHED,{media:n,mediaSource:r}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:n}=this;i!==n&&this.error(`Media element src was set while attaching MediaSource (${n} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=fg(Xi(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.BUFFER_RESET,this.onBufferReset,this),e.on(E.BUFFER_APPENDING,this.onBufferAppending,this),e.on(E.BUFFER_CODECS,this.onBufferCodecs,this),e.on(E.BUFFER_EOS,this.onBufferEos,this),e.on(E.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(E.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(E.FRAG_PARSED,this.onFragParsed,this),e.on(E.FRAG_CHANGED,this.onFragChanged,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.BUFFER_RESET,this.onBufferReset,this),e.off(E.BUFFER_APPENDING,this.onBufferAppending,this),e.off(E.BUFFER_CODECS,this.onBufferCodecs,this),e.off(E.BUFFER_EOS,this.onBufferEos,this),e.off(E.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(E.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(E.FRAG_PARSED,this.onFragParsed,this),e.off(E.FRAG_CHANGED,this.onFragChanged,this),e.off(E.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const r=this.isUpdating();r||this.operationQueue.removeBlockers();const a=this.isQueued();(r||a)&&this.warn(`Transfering MediaSource with${a?" operations in queue":""}${r?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const n=this.transferData;return!this.sourceBufferCount&&n&&n.mediaSource===t?Ae(i,n.tracks):this.sourceBuffers.forEach(r=>{const[a]=r;a&&(i[a]=Ae({},this.tracks[a]),this.removeBuffer(a)),r[0]=r[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsTotal=n,this.log(`${n} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&n&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media,n=Xi(this.appendSource);if(this.transferData=this.overrides=void 0,i&&n){const r=!!t.mediaSource;(r||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const a=this.mediaSource=t.mediaSource||new n;if(this.assignMediaSource(a),r)this._objectUrl=i.src,this.attachTransferred();else{const o=this._objectUrl=self.URL.createObjectURL(a);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&a instanceof l,Kd(i),q0(i,o),i.load()}catch{i.src=o}else i.src=o}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,n=t.tracks,r=n?Object.keys(n):null,a=r?r.length:0,o=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(n&&r&&a){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${we(i,(l,c)=>l==="initSegment"?void 0:c)};
transfer tracks: ${we(n,(l,c)=>l==="initSegment"?void 0:c)}}`),!bu(n,i)){t.mediaSource=null,t.tracks=void 0;const l=e.currentTime,c=this.details,u=Math.max(l,(c==null?void 0:c.fragments[0].start)||0);if(u-l>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${l} -> ${u}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(n)}"->"${Object.keys(i)}") start time: ${u} currentTime: ${l}`),this.onMediaDetaching(E.MEDIA_DETACHING,{}),this.onMediaAttaching(E.MEDIA_ATTACHING,t),e.currentTime=u;return}this.transferData=void 0,r.forEach(l=>{const c=l,u=n[c];if(u){const d=u.buffer;if(d){const f=this.fragmentTracker,g=u.id;if(f.hasFragments(g)||f.hasParts(g)){const S=ve.getBuffered(d);f.detectEvictedFragments(c,S,g,null,!0)}const p=ga(c),v=[c,d];this.sourceBuffers[p]=v,d.updating&&this.operationQueue&&this.operationQueue.prependBlocker(c),this.trackSourceBuffer(c,u)}}}),o(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),o()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:n,mediaSource:r,_objectUrl:a}=this;if(r){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([o])=>{o&&this.removeBuffer(o)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const o=r.readyState==="open";try{const l=r.sourceBuffers;for(let c=l.length;c--;)o&&l[c].abort(),r.removeSourceBuffer(l[c]);o&&r.endOfStream()}catch(l){this.warn(`onMediaDetaching: ${l.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(r.removeEventListener("startstreaming",this._onStartStreaming),r.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}n&&(n.removeEventListener("emptied",this._onMediaEmptied),i||(a&&self.URL.revokeObjectURL(a),this.mediaSrc===a?(n.removeAttribute("src"),this.appendSource&&Kd(n),n.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(E.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var n;(n=this.mediaSource)!=null&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(r){this.warn(`onBufferReset ${e}`,r)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[ga(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new j0(this.tracks)}onBufferCodecs(e,t){const i=this.tracks,n=Object.keys(t);this.log(`BUFFER_CODECS: "${n}" (current SB count ${this.sourceBufferCount})`);const r="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),a=!r&&this.sourceBufferCount&&this.media&&n.some(o=>!i[o]);if(r||a){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${n}" SourceBuffers`);return}n.forEach(o=>{var l,c,u;const d=t[o],{id:f,codec:g,levelCodec:p,container:v,metadata:S,supplemental:b}=d;let I=i[o];const w=(l=this.transferData)==null||(c=l.tracks)==null?void 0:c[o],_=w!=null&&w.buffer?w:I,T=(_==null?void 0:_.pendingCodec)||(_==null?void 0:_.codec),C=_==null?void 0:_.levelCodec;I||(I=i[o]={buffer:void 0,listeners:[],codec:g,supplemental:b,container:v,levelCodec:p,metadata:S,id:f});const A=Kr(T,C),k=A==null?void 0:A.replace(Vd,"$1");let D=Kr(g,p);const R=(u=D)==null?void 0:u.replace(Vd,"$1");D&&A&&k!==R&&(o.slice(0,5)==="audio"&&(D=qr(D,this.appendSource)),this.log(`switching codec ${T} to ${D}`),D!==(I.pendingCodec||I.codec)&&(I.pendingCodec=D),I.container=v,this.appendChangeType(o,v,D))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const n=`${t};codecs=${i}`,r={label:`change-type=${n}`,execute:()=>{const a=this.tracks[e];if(a){const o=a.buffer;o!=null&&o.changeType&&(this.log(`changing ${e} sourceBuffer type to ${n}`),o.changeType(n),a.codec=i,a.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn(`Failed to change ${e} SourceBuffer type`,a)}};this.append(r,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,n=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,oe.MAIN))==null?void 0:t.gap)===!0)return;const a={label:"block-audio",execute:()=>{var o;const l=this.tracks.video;(this.lastVideoAppendEnd>n||l!=null&&l.buffer&&ve.isBuffered(l.buffer,n)||((o=this.fragmentTracker.getAppendedFrag(n,oe.MAIN))==null?void 0:o.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn("Error executing block-audio operation",o)}};this.blockedAudioAppend={op:a,frag:e},this.append(a,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:n,type:r,parent:a,frag:o,part:l,chunkMeta:c}=t,u=c.buffering[r],d=o.sn,f=self.performance.now();u.start=f;const g=o.stats.buffering,p=l?l.stats.buffering:null;g.start===0&&(g.start=f),p&&p.start===0&&(p.start=f);const v=i.audio;let S=!1;r==="audio"&&(v==null?void 0:v.container)==="audio/mpeg"&&(S=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const b=this.tracks.video,I=b==null?void 0:b.buffer;if(I&&d!=="initSegment"){const T=l||o,C=this.blockedAudioAppend;if(r==="audio"&&a!=="main"&&!this.blockedAudioAppend){const k=T.start+T.duration*.05,D=I.buffered,R=this.currentOp("video");!D.length&&!R?this.blockAudio(T):!R&&!ve.isBuffered(I,k)&&this.lastVideoAppendEnd<k&&this.blockAudio(T)}else if(r==="video"){const A=T.end;if(C){const k=C.frag.start;(A>k||A<this.lastVideoAppendEnd||ve.isBuffered(I,k))&&this.unblockAudio()}this.lastVideoAppendEnd=A}}const w=(l||o).start,_={label:`append-${r}`,execute:()=>{if(u.executeStart=self.performance.now(),S){const T=this.tracks[r];if(T){const C=T.buffer;if(C){const A=w-C.timestampOffset;Math.abs(A)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${w} (delta: ${A}) sn: ${d})`),C.timestampOffset=w)}}}this.appendExecutor(n,r)},onStart:()=>{},onComplete:()=>{const T=self.performance.now();u.executeEnd=u.end=T,g.first===0&&(g.first=T),p&&p.first===0&&(p.first=T);const C={};this.sourceBuffers.forEach(([A,k])=>{A&&(C[A]=ve.getBuffered(k))}),this.appendErrors[r]=0,r==="audio"||r==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(E.BUFFER_APPENDED,{type:r,frag:o,part:l,chunkMeta:c,parent:o.type,timeRanges:C})},onError:T=>{var C;const A={type:te.MEDIA_ERROR,parent:o.type,details:M.BUFFER_APPEND_ERROR,sourceBufferName:r,frag:o,part:l,chunkMeta:c,error:T,err:T,fatal:!1},k=(C=this.media)==null?void 0:C.error;if(T.code===DOMException.QUOTA_EXCEEDED_ERR)A.details=M.BUFFER_FULL_ERROR;else if(T.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!k)A.errorAction=Zi(!0);else if(T.name===qd&&this.sourceBufferCount===0)A.errorAction=Zi(!0);else{const D=++this.appendErrors[r];this.warn(`Failed ${D}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${r}" sourceBuffer (${k||"no media error"})`),(D>=this.hls.config.appendErrorMaxRetry||k)&&(A.fatal=!0)}this.hls.trigger(E.ERROR,A)}};this.append(_,r,this.isPending(this.tracks[r]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(E.BUFFER_FLUSHED,{type:e})},onError:n=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,n)}}}onBufferFlushing(e,t){const{type:i,startOffset:n,endOffset:r}=t;i?this.append(this.getFlushOp(i,n,r),i):this.sourceBuffers.forEach(([a])=>{a&&this.append(this.getFlushOp(a,n,r),a)})}onFragParsed(e,t){const{frag:i,part:n}=t,r=[],a=n?n.elementaryStreams:i.elementaryStreams;a[$e.AUDIOVIDEO]?r.push("audiovideo"):(a[$e.AUDIO]&&r.push("audio"),a[$e.VIDEO]&&r.push("video"));const o=()=>{const l=self.performance.now();i.stats.buffering.end=l,n&&(n.stats.buffering.end=l);const c=n?n.stats:i.stats;this.hls.trigger(E.FRAG_BUFFERED,{frag:i,part:n,stats:c,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(o,r).catch(l=>{this.warn(`Fragment buffered callback ${l}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t,i;return e&&(!((t=this.tracks[e])!=null&&t.ended)||((i=this.tracks[e])==null?void 0:i.ending))})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([a])=>{if(a){const o=this.tracks[a];(!t.type||t.type===a)&&(o.ending=!0,o.ended||(o.ended=!0,this.log(`${a} buffer reached EOS`)))}});const n=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([a])=>{var o;return a&&!((o=this.tracks[a])!=null&&o.ended)})&&(n?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:a}=this;if(!a||a.readyState!=="open"){a&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${a.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),a.endOfStream(),this.hls.trigger(E.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(E.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){const e=this.getDurationAndRange();e&&this.blockUntilOpen(()=>this.updateMediaSource(e))}onError(e,t){if(t.details===M.BUFFER_APPEND_ERROR&&t.frag){var i;const n=(i=t.errorAction)==null?void 0:i.nextAutoLevel;J(n)&&n!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;const n=e.config,r=i.currentTime,a=t.levelTargetDuration,o=t.live&&n.liveBackBufferLength!==null?n.liveBackBufferLength:n.backBufferLength;if(J(o)&&o>=0){const l=Math.max(o,a),c=Math.floor(r/a)*a-l;this.flushBackBuffer(r,a,c)}if(J(n.frontBufferFlushThreshold)&&n.frontBufferFlushThreshold>0){const l=Math.max(n.maxBufferLength,n.frontBufferFlushThreshold),c=Math.max(l,a),u=Math.floor(r/a)*a+c;this.flushFrontBuffer(r,a,u)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([n,r])=>{if(r){const o=ve.getBuffered(r);if(o.length>0&&i>o.start(0)){var a;this.hls.trigger(E.BACK_BUFFER_REACHED,{bufferEnd:i});const l=this.tracks[n];if((a=this.details)!=null&&a.live)this.hls.trigger(E.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l!=null&&l.ended){this.log(`Cannot flush ${n} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(E.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:n})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([n,r])=>{if(r){const a=ve.getBuffered(r),o=a.length;if(o<2)return;const l=a.start(o-1),c=a.end(o-1);if(i>l||e>=l&&e<=c)return;this.hls.trigger(E.BUFFER_FLUSHING,{startOffset:l,endOffset:1/0,type:n})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||(i==null?void 0:i.readyState)!=="open")return null;const n=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&t.live&&i.setLiveSeekableRange){const c=Math.max(0,t.fragmentStart),u=Math.max(c,n);return{duration:1/0,start:c,end:u}}return{duration:1/0}}const r=(e=this.overrides)==null?void 0:e.duration;if(r)return J(r)?{duration:r}:null;const a=this.media.duration,o=J(i.duration)?i.duration:0;return n>o&&n>a||!J(a)?{duration:n}:null}updateMediaSource({duration:e,start:t,end:i}){const n=this.mediaSource;!this.media||!n||n.readyState!=="open"||(n.duration!==e&&(J(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),n.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${n.duration}. Setting seekable range to ${t}-${i}.`),n.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${we(i)}`),this.tracksReady){var n;const r=(n=this.transferData)==null?void 0:n.tracks;r&&Object.keys(r).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const n=this.tracks[t];e[t]={buffer:i,container:n.container,codec:n.codec,supplemental:n.supplemental,levelCodec:n.levelCodec,id:n.id,metadata:n.metadata}}}),this.hls.trigger(E.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(E.ERROR,{type:te.MEDIA_ERROR,details:M.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const r in e){const a=r,o=e[a];if(this.isPending(o)){const l=this.getTrackCodec(o,a),c=`${o.container};codecs=${l}`;o.codec=l,this.log(`creating sourceBuffer(${c})${this.currentOp(a)?" Queued":""} ${we(o)}`);try{const u=i.addSourceBuffer(c),d=ga(a),f=[a,u];t[d]=f,o.buffer=u}catch(u){var n;this.error(`error while trying to add sourceBuffer: ${u.message}`),this.shiftAndExecuteNext(a),(n=this.operationQueue)==null||n.removeBlockers(),delete this.tracks[a],this.hls.trigger(E.ERROR,{type:te.MEDIA_ERROR,details:M.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:u,sourceBufferName:a,mimeType:c,parent:o.id});return}this.trackSourceBuffer(a,o)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let n=e.codec;i&&(t==="video"||t==="audiovideo")&&Dg(i,"video")&&(n=Fg(n,i));const r=Kr(n,e.levelCodec);return r?t.slice(0,5)==="audio"?qr(r,this.appendSource):r:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const n=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:n,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(r,a)=>{const o=a.removedRanges;o!=null&&o.length&&this.hls.trigger(E.BUFFER_FLUSHED,{type:r})})}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i==null?void 0:i.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const n=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${n}`,t),this.hls.trigger(E.ERROR,{type:te.MEDIA_ERROR,details:M.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});const r=this.currentOp(e);r&&r.onError(n)}removeExecutor(e,t,i){const{media:n,mediaSource:r}=this,a=this.tracks[e],o=a==null?void 0:a.buffer;if(!n||!r||!o){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const l=J(n.duration)?n.duration:1/0,c=J(r.duration)?r.duration:1/0,u=Math.max(0,t),d=Math.min(i,l,c);d>u&&(!a.ending||a.ended)?(a.ended=!1,this.log(`Removing [${u},${d}] from the ${e} SourceBuffer`),o.remove(u,d)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],n=i==null?void 0:i.buffer;if(!n)throw new G0(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,n.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,n=t.map(a=>this.appendBlocker(a));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(n).then(a=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;const n=(i=this.tracks[t])==null?void 0:i.buffer;!n||n.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const n=this.tracks[e];if(!n)return;const r=n.buffer;if(!r)return;const a=i.bind(this,e);n.listeners.push({event:t,listener:a}),r.addEventListener(t,a)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(n=>{i.removeEventListener(n.event,n.listener)}),t.listeners.length=0)}}function Kd(s){const e=s.querySelectorAll("source");[].slice.call(e).forEach(t=>{s.removeChild(t)})}function q0(s,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,s.appendChild(t)}function ga(s){return s==="audio"?1:0}class ma{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(E.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(E.BUFFER_CODECS,this.onBufferCodecs,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(E.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(E.BUFFER_CODECS,this.onBufferCodecs,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&J(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((n,r)=>this.isLevelAllowed(n)&&r<=e);return this.clientRect=null,ma.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const n=(o,l)=>l?o.width!==l.width||o.height!==l.height:!0;let r=e.length-1;const a=Math.max(t,i);for(let o=0;o<e.length;o+=1){const l=e[o];if((l.width>=a||l.height>=a)&&n(l,e[o+1])){r=o;break}}return r}}const Ge={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},K0={HLS:"h"},as={OBJECT:"CMCD-Object",REQUEST:"CMCD-Request",SESSION:"CMCD-Session",STATUS:"CMCD-Status"},H0={[as.OBJECT]:["br","d","ot","tb"],[as.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[as.SESSION]:["cid","pr","sf","sid","st","v"],[as.STATUS]:["bs","rtp"]};class Oi{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof Oi?i:new Oi(i))),this.value=e,this.params=t}}const Y0="Dict";function W0(s){return Array.isArray(s)?JSON.stringify(s):s instanceof Map?"Map{}":s instanceof Set?"Set{}":typeof s=="object"?JSON.stringify(s):String(s)}function z0(s,e,t,i){return new Error(`failed to ${s} "${W0(e)}" as ${t}`,{cause:i})}function bt(s,e,t){return z0("serialize",s,e,t)}class Hd{constructor(e){this.description=e}}const Yd="Bare Item",J0="Boolean";function Q0(s){if(typeof s!="boolean")throw bt(s,J0);return s?"?1":"?0"}function X0(s){return btoa(String.fromCharCode(...s))}const Z0="Byte Sequence";function ev(s){if(ArrayBuffer.isView(s)===!1)throw bt(s,Z0);return`:${X0(s)}:`}const tv="Integer";function iv(s){return s<-999999999999999||999999999999999<s}function Wd(s){if(iv(s))throw bt(s,tv);return s.toString()}function sv(s){return`@${Wd(s.getTime()/1e3)}`}function zd(s,e){if(s<0)return-zd(-s,e);const t=Math.pow(10,e);if(Math.abs(s*t%1-.5)<Number.EPSILON){const n=Math.floor(s*t);return(n%2===0?n:n+1)/t}else return Math.round(s*t)/t}const nv="Decimal";function rv(s){const e=zd(s,3);if(Math.floor(Math.abs(e)).toString().length>12)throw bt(s,nv);const t=e.toString();return t.includes(".")?t:`${t}.0`}const av="String",ov=/[\x00-\x1f\x7f]+/;function lv(s){if(ov.test(s))throw bt(s,av);return`"${s.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function cv(s){return s.description||s.toString().slice(7,-1)}const uv="Token";function Jd(s){const e=cv(s);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw bt(e,uv);return e}function va(s){switch(typeof s){case"number":if(!J(s))throw bt(s,Yd);return Number.isInteger(s)?Wd(s):rv(s);case"string":return lv(s);case"symbol":return Jd(s);case"boolean":return Q0(s);case"object":if(s instanceof Date)return sv(s);if(s instanceof Uint8Array)return ev(s);if(s instanceof Hd)return Jd(s);default:throw bt(s,Yd)}}const dv="Key";function ya(s){if(/^[a-z*][a-z0-9\-_.*]*$/.test(s)===!1)throw bt(s,dv);return s}function Sa(s){return s==null?"":Object.entries(s).map(([e,t])=>t===!0?`;${ya(e)}`:`;${ya(e)}=${va(t)}`).join("")}function Qd(s){return s instanceof Oi?`${va(s.value)}${Sa(s.params)}`:va(s)}function hv(s){return`(${s.value.map(Qd).join(" ")})${Sa(s.params)}`}function fv(s,e={whitespace:!0}){if(typeof s!="object")throw bt(s,Y0);const t=s instanceof Map?s.entries():Object.entries(s),i=e!=null&&e.whitespace?" ":"";return Array.from(t).map(([n,r])=>{r instanceof Oi||(r=new Oi(r));let a=ya(n);return r.value===!0?a+=Sa(r.params):(a+="=",Array.isArray(r.value)?a+=hv(r):a+=Qd(r)),a}).join(`,${i}`)}function pv(s,e){return fv(s,e)}function gv(s){return s==="ot"||s==="sf"||s==="st"}function mv(s){return typeof s=="number"?J(s):s!=null&&s!==""&&s!==!1}function vv(s,e){const t=new URL(s),i=new URL(e);if(t.origin!==i.origin)return s;const n=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;n[0]===r[0];)n.shift(),r.shift();for(;r.length;)r.shift(),n.unshift("..");return n.join("/")}const Sn=s=>Math.round(s),yv=(s,e)=>(e!=null&&e.baseUrl&&(s=vv(s,e.baseUrl)),encodeURIComponent(s)),En=s=>Sn(s/100)*100,Sv={br:Sn,d:Sn,bl:En,dl:En,mtp:En,nor:yv,rtp:En,tb:Sn};function Ev(s,e){const t={};if(s==null||typeof s!="object")return t;const i=Object.keys(s).sort(),n=Ae({},Sv,e==null?void 0:e.formatters),r=e==null?void 0:e.filter;return i.forEach(a=>{if(r!=null&&r(a))return;let o=s[a];const l=n[a];l&&(o=l(o,e)),!(a==="v"&&o===1)&&(a=="pr"&&o===1||mv(o)&&(gv(a)&&typeof o=="string"&&(o=new Hd(o)),t[a]=o))}),t}function Xd(s,e={}){return s?pv(Ev(s,e),Ae({whitespace:!1},e)):""}function bv(s,e={}){const t={};if(!s)return t;const i=Object.entries(s),n=Object.entries(H0).concat(Object.entries((e==null?void 0:e.customHeaderMap)||{})),r=i.reduce((a,o)=>{var l,c;const[u,d]=o,f=((l=n.find(g=>g[1].includes(u)))===null||l===void 0?void 0:l[0])||as.REQUEST;return(c=a[f])!==null&&c!==void 0||(a[f]={}),a[f][u]=d,a},{});return Object.entries(r).reduce((a,[o,l])=>(a[o]=Xd(l,e),a),t)}function Tv(s,e,t){return Ae(s,bv(e,t))}const _v="CMCD";function xv(s,e={}){if(!s)return"";const t=Xd(s,e);return`${_v}=${encodeURIComponent(t)}`}const Zd=/CMCD=[^&#]+/;function Av(s,e,t){const i=xv(e,t);if(!i)return s;if(Zd.test(s))return s.replace(Zd,i);const n=s.includes("?")?"&":"?";return`${s}${n}${i}`}class Iv{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=n=>{try{this.apply(n,{ot:Ge.MANIFEST,su:!this.initialized})}catch(r){this.hls.logger.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=n=>{try{const{frag:r,part:a}=n,o=this.hls.levels[r.level],l=this.getObjectType(r),c={d:(a||r).duration*1e3,ot:l};(l===Ge.VIDEO||l===Ge.AUDIO||l==Ge.MUXED)&&(c.br=o.bitrate/1e3,c.tb=this.getTopBandwidth(l)/1e3,c.bl=this.getBufferLength(l));const u=a?this.getNextPart(a):this.getNextFrag(r);u!=null&&u.url&&u.url!==r.url&&(c.nor=u.url),this.apply(n,c)}catch(r){this.hls.logger.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(E.MEDIA_DETACHED,this.onMediaDetached,this),e.on(E.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(E.MEDIA_DETACHED,this.onMediaDetached,this),e.off(E.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,n;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(n=t.tracks.video)==null?void 0:n.buffer}createData(){var e;return{v:1,sf:K0.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){Ae(t,this.createData());const i=t.ot===Ge.INIT||t.ot===Ge.VIDEO||t.ot===Ge.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:n}=this;n&&(t=Object.keys(t).reduce((a,o)=>(n.includes(o)&&(a[o]=t[o]),a),{}));const r={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),Tv(e.headers,t,r)):e.url=Av(e.url,t,r)}getNextFrag(e){var t;const i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){const n=e.sn-i.startSN;return i.fragments[n+1]}}getNextPart(e){var t,i;const{index:n,fragment:r}=e,a=(t=this.hls.levels[r.level])==null||(i=t.details)==null?void 0:i.partList;if(a){const{sn:o}=r;for(let l=a.length-1;l>=0;l--){const c=a[l];if(c.index===n&&c.fragment.sn===o)return a[l+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return Ge.TIMED_TEXT;if(e.sn==="initSegment")return Ge.INIT;if(t==="audio")return Ge.AUDIO;if(t==="main")return this.hls.audioTracks.length?Ge.VIDEO:Ge.MUXED}getTopBandwidth(e){let t=0,i;const n=this.hls;if(e===Ge.AUDIO)i=n.audioTracks;else{const r=n.maxAutoLevel,a=r>-1?r+1:n.levels.length;i=n.levels.slice(0,a)}return i.forEach(r=>{r.bitrate>t&&(t=r.bitrate)}),t>0?t:NaN}getBufferLength(e){const t=this.media,i=e===Ge.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:ve.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,a,o){t(r),this.loader.load(r,a,o)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,a,o){t(r),this.loader.load(r,a,o)}}}}const wv=3e5;class Lv extends Rt{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===Oe.SendAlternateToPenaltyBox&&i.flags===ut.MoveAllAlternatesMatchingHost){const n=this.levels;let r=this._pathwayPriority,a=this.pathwayId;if(t.context){const{groupId:o,pathwayId:l,type:c}=t.context;o&&n?a=this.getPathwayForGroupId(o,c,a):l&&(a=l)}a in this.penalizedPathways||(this.penalizedPathways[a]=performance.now()),!r&&n&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==a),i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${a} levels: ${n&&n.length} priorities: ${we(r)} penalized: ${we(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const i=this.penalizedPathways,n=performance.now();Object.keys(i).forEach(r=>{n-i[r]>wv&&delete i[r]});for(let r=0;r<e.length;r++){const a=e[r];if(a in i)continue;if(a===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(t=this.getLevelsForPathway(a),t.length>0){this.log(`Setting Pathway to "${a}"`),this.pathwayId=a,Dm(t),this.hls.trigger(E.LEVELS_UPDATED,{levels:t});const c=this.hls.levels[o];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=o);break}}}getPathwayForGroupId(e,t,i){const n=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<n.length;r++)if(t===Ct.AUDIO_TRACK&&n[r].hasAudioGroup(e)||t===Ct.SUBTITLE_TRACK&&n[r].hasSubtitleGroup(e))return n[r].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},n={};e.forEach(r=>{const{ID:a,"BASE-ID":o,"URI-REPLACEMENT":l}=r;if(t.some(u=>u.pathwayId===a))return;const c=this.getLevelsForPathway(o).map(u=>{const d=new es(u.attrs);d["PATHWAY-ID"]=a;const f=d.AUDIO&&`${d.AUDIO}_clone_${a}`,g=d.SUBTITLES&&`${d.SUBTITLES}_clone_${a}`;f&&(i[d.AUDIO]=f,d.AUDIO=f),g&&(n[d.SUBTITLES]=g,d.SUBTITLES=g);const p=th(u.uri,d["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),v=new Xs({attrs:d,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:p,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let S=1;S<u.audioGroups.length;S++)v.addGroupId("audio",`${u.audioGroups[S]}_clone_${a}`);if(u.subtitleGroups)for(let S=1;S<u.subtitleGroups.length;S++)v.addGroupId("text",`${u.subtitleGroups[S]}_clone_${a}`);return v});t.push(...c),eh(this.audioTracks,i,l,a),eh(this.subtitleTracks,n,l,a)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let n;try{n=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(n.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;n.searchParams.set("_HLS_pathway",this.pathwayId),n.searchParams.set("_HLS_throughput",""+u)}const r={responseType:"json",url:n.href},a=t.steeringManifestLoadPolicy.default,o=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(u,d,f,g)=>{this.log(`Loaded steering manifest: "${n}"`);const p=u.data;if((p==null?void 0:p.VERSION)!==1){this.log(`Steering VERSION ${p.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=p.TTL;const{"RELOAD-URI":v,"PATHWAY-CLONES":S,"PATHWAY-PRIORITY":b}=p;if(v)try{this.uri=new self.URL(v,n).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${v}`);return}this.scheduleRefresh(this.uri||f.url),S&&this.clonePathways(S);const I={steeringManifest:p,url:n.toString()};this.hls.trigger(E.STEERING_MANIFEST_LOADED,I),b&&this.updatePathwayPriority(b)},onError:(u,d,f,g)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${d.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${d.url} no longer available`);return}let p=this.timeToLoad*1e3;if(u.code===429){const v=this.loader;if(typeof(v==null?void 0:v.getResponseHeader)=="function"){const S=v.getResponseHeader("Retry-After");S&&(p=parseFloat(S)*1e3)}this.log(`Steering manifest ${d.url} rate limited`);return}this.scheduleRefresh(this.uri||d.url,p)},onTimeout:(u,d,f)=>{this.log(`Timeout loading steering manifest (${d.url})`),this.scheduleRefresh(this.uri||d.url)}};this.log(`Requesting steering manifest: ${n}`),this.loader.load(r,l,c)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const n=(i=this.hls)==null?void 0:i.media;if(n&&!n.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function eh(s,e,t,i){s&&Object.keys(e).forEach(n=>{const r=s.filter(a=>a.groupId===n).map(a=>{const o=Ae({},a);return o.details=void 0,o.attrs=new es(o.attrs),o.url=o.attrs.URI=th(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),o.groupId=o.attrs["GROUP-ID"]=e[n],o.attrs["PATHWAY-ID"]=i,o});s.push(...r)})}function th(s,e,t,i){const{HOST:n,PARAMS:r,[t]:a}=i;let o;e&&(o=a==null?void 0:a[e],o&&(s=o));const l=new self.URL(s);return n&&!o&&(l.host=n),r&&Object.keys(r).sort().forEach(c=>{c&&l.searchParams.set(c,r[c])}),l.href}function Kt(s,e,t){hi(s,e,t),s.addEventListener(e,t)}function hi(s,e,t){s.removeEventListener(e,t)}class Mi extends Rt{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=Mi.CDMCleanupPromise?[Mi.CDMCleanupPromise]:[],this.onMediaEncrypted=t=>{const{initDataType:i,initData:n}=t,r=`"${t.type}" event: init data type: "${i}"`;if(this.debug(r),n!==null){if(!this.keyFormatPromise){let a=Object.keys(this.keySystemAccessPromises);a.length||(a=an(this.config));const o=a.map(rn).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(o)}this.keyFormatPromise.then(a=>{const o=Qr(a);let l,c;if(i==="sinf"){if(o!==me.FAIRPLAY){this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${i}" for selected key-system ${o}`);return}const p=Le(new Uint8Array(n));try{const v=zr(JSON.parse(p).sinf),S=Lu(v);if(!S)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=new Uint8Array(S.subarray(8,24)),c=me.FAIRPLAY}catch(v){this.warn(`${r} Failed to parse sinf: ${v}`);return}}else{if(o!==me.WIDEVINE&&o!==me.PLAYREADY){this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${i}" for selected key-system ${o}`);return}const p=Cg(n),v=p.filter(b=>!!b.systemId&&Xr(b.systemId)===o);v.length>1&&this.warn(`${r} Using first of ${v.length} pssh found for selected key-system ${o}`);const S=v[0];if(!S){p.length===0||p.some(b=>!b.systemId)?this.warn(`${r} contains incomplete or invalid pssh data`):this.log(`ignoring ${r} for ${p.map(b=>Xr(b.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(c=Xr(S.systemId),S.version===0&&S.data)if(c===me.WIDEVINE){const b=S.data.length-22;l=new Uint8Array(S.data.subarray(b,b+16))}else c===me.PLAYREADY&&(l=sd(S.data))}if(!c||!l)return;const u=mt.hexDump(l),{keyIdToKeySessionPromise:d,mediaKeySessions:f}=this;let g=d[u];for(let p=0;p<f.length;p++){const v=f[p],S=v.decryptdata;if(!S.keyId)continue;const b=mt.hexDump(S.keyId);if(u===b||S.uri.replace(/-/g,"").indexOf(u)!==-1){if(g=d[b],S.pssh)break;delete d[b],S.pssh=new Uint8Array(n),S.keyId=l,g=d[u]=g.then(()=>this.generateRequestWithPreferredKeySession(v,i,n,"encrypted-event-key-match")),g.catch(I=>this.handleError(I));break}}if(!g){if(c!==o){this.log(`Ignoring "${t.type}" event with ${c} init data for selected key-system ${o}`);return}g=d[u]=this.getKeySystemSelectionPromise([c]).then(({keySystem:p,mediaKeys:v})=>{var S;this.throwIfDestroyed();const b=new ln("ISO-23001-7",u,(S=rn(p))!=null?S:"");return b.pssh=new Uint8Array(n),b.keyId=l,this.attemptSetMediaKeys(p,v).then(()=>{this.throwIfDestroyed();const I=this.createMediaKeySessionContext({decryptdata:b,keySystem:p,mediaKeys:v});return this.generateRequestWithPreferredKeySession(I,i,n,"encrypted-event-no-match")})}),g.catch(p=>this.handleError(p))}})}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(E.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(E.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(E.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(E.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(E.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(E.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(E.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(E.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,n=t[e];if(n)return n.licenseUrl;if(e===me.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(a,o,l)=>!!a&&l.indexOf(a)===o,n=t.map(a=>a.audioCodec).filter(i),r=t.map(a=>a.videoCodec).filter(i);return n.length+r.length===0&&r.push("avc1.42e01e"),new Promise((a,o)=>{const l=c=>{const u=c.shift();this.getMediaKeysPromise(u,n,r).then(d=>a({keySystem:u,mediaKeys:d})).catch(d=>{c.length?l(c):d instanceof nt?o(d):o(new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_NO_ACCESS,error:d,fatal:!0},d.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let n=`Configured requestMediaKeySystemAccess is not a function ${i}`;return id===null&&self.location.protocol==="http:"&&(n=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(n))}return i(e,t)}getMediaKeysPromise(e,t,i){const n=bm(e,t,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[e];let a=r==null?void 0:r.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${we(n)}`),a=this.requestMediaKeySystemAccess(e,n);const o=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const c=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),o.mediaKeys=l.createMediaKeys().then(u=>(this.log(`Media-keys created for "${e}"`),o.hasMediaKeys=!0,c.then(d=>d?this.setMediaKeysServerCertificate(u,e,d):u))),o.mediaKeys.catch(u=>{this.error(`Failed to create media-keys for "${e}"}: ${u}`)}),o.mediaKeys})}return a.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${mt.hexDump(e.keyId||[])}`);const n=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:n,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),n=this.getKeyIdString(t),r="cenc";this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(i,r,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return mt.hexDump(e.keyId)}updateKeySession(e,t){var i;const n=e.mediaKeysSession;return this.log(`Updating key-session "${n.sessionId}" for keyID ${mt.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),n.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>rn(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:t,mediaKeys:i})=>this.attemptSetMediaKeys(t,i))}selectKeySystem(e){return new Promise((t,i)=>this.getKeySystemSelectionPromise(e).then(({keySystem:n})=>{const r=rn(n);r?t(r):i(new Error(`Unable to find format for key-system "${n}"`))}).catch(i))}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=an(this.config),i=e.map(Qr).filter(n=>!!n&&t.indexOf(n)!==-1);return this.selectKeySystem(i)}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),n=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${n}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.getKeySystemForKeyPromise(t).then(({keySystem:o,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${n}`),this.attemptSetMediaKeys(o,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:o,mediaKeys:l,decryptdata:t}))))),(this.keyIdToKeySessionPromise[i]=r.then(o=>{const l="cenc",c=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(o,l,c,"playlist-key")})).catch(o=>this.handleError(o))),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof nt?this.hls.trigger(E.ERROR,e.data):this.hls.trigger(E.ERROR,{type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const n=Qr(e.keyFormat),r=n?[n]:an(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=an(this.config)),e.length===0)throw new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${we({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaKeys===t)return Promise.resolve();const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const n=Promise.all(i).then(()=>{if(!this.media)throw this.mediaKeys=null,new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.mediaKeys=t,this.setMediaKeysQueue.push(n),n.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(n),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,n){var r,a;const o=(r=this.config.drmSystems)==null||(a=r[e.keySystem])==null?void 0:a.generateRequest;if(o)try{const p=o.call(this.hls,t,i,e);if(!p)throw new Error("Invalid response from configured generateRequest filter");t=p.initDataType,i=p.initData?p.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(p){var l;if(this.warn(p.message),(l=this.hls)!=null&&l.config.debug)throw p}if(i===null)return this.log(`Skipping key-session request for "${n}" (no initData)`),Promise.resolve(e);const c=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${n}": ${c} (init data type: ${t} length: ${i?i.byteLength:null})`);const u=new md,d=e._onmessage=p=>{const v=e.mediaKeysSession;if(!v){u.emit("error",new Error("invalid state"));return}const{messageType:S,message:b}=p;this.log(`"${S}" message event for session "${v.sessionId}" message size: ${b.byteLength}`),S==="license-request"||S==="license-renewal"?this.renewLicense(e,b).catch(I=>{u.eventNames().length?u.emit("error",I):this.handleError(I)}):S==="license-release"?e.keySystem===me.FAIRPLAY&&(this.updateKeySession(e,Jr("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${S}"`)},f=e._onkeystatuseschange=p=>{if(!e.mediaKeysSession){u.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const S=e.keyStatus;u.emit("keyStatus",S),S==="expired"&&(this.warn(`${e.keySystem} expired for key ${c}`),this.renewKeySession(e))};Kt(e.mediaKeysSession,"message",d),Kt(e.mediaKeysSession,"keystatuseschange",f);const g=new Promise((p,v)=>{u.on("error",v),u.on("keyStatus",S=>{S.startsWith("usable")?p():S==="output-restricted"?v(new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):S==="internal-error"?v(new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${S}"`)):S==="expired"?v(new Error("key expired while generating request")):this.warn(`unhandled key status change "${S}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var p;this.log(`Request generated for key-session "${(p=e.mediaKeysSession)==null?void 0:p.sessionId}" keyId: ${c}`)}).catch(p=>{throw new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_NO_SESSION,error:p,fatal:!1},`Error generating key-session request: ${p}`)}).then(()=>g).catch(p=>{throw u.removeAllListeners(),this.removeSession(e),p}).then(()=>(u.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{if(typeof i=="string"&&typeof t=="object"){const n=i;i=t,t=n}this.log(`key status change "${t}" for keyStatuses keyId: ${mt.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${mt.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,n=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((a,o)=>{const l={responseType:"arraybuffer",url:r},c=t.certLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(f,g,p,v)=>{a(f.data)},onError:(f,g,p,v)=>{o(new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:p,response:_e({url:l.url,data:void 0},f)},`"${e}" certificate request failed (${r}). Status: ${f.code} (${f.text})`))},onTimeout:(f,g,p)=>{o(new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:p,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(f,g,p)=>{o(new Error("aborted"))}};n.load(l,u,d)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((n,r)=>{e.setServerCertificate(i).then(a=>{this.log(`setServerCertificate ${a?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${t}"`),n(e)}).catch(a=>{r(new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:!0},a.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(n=>{throw new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:n,fatal:!0},n.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const n=new DOMParser().parseFromString(i,"application/xml"),r=n.querySelectorAll("HttpHeader");if(r.length>0){let u;for(let d=0,f=r.length;d<f;d++){var a,o;u=r[d];const g=(a=u.querySelector("name"))==null?void 0:a.textContent,p=(o=u.querySelector("value"))==null?void 0:o.textContent;g&&p&&e.setRequestHeader(g,p)}}const l=n.querySelector("Challenge"),c=l==null?void 0:l.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return Jr(atob(c))}setupLicenseXHR(e,t,i,n){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,n)}).catch(a=>{if(!i.decryptdata)throw a;return e.open("POST",t,!0),r.call(this.hls,e,t,i,n)}).then(a=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:a||n})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:n}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((n,r)=>{const a=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${a}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let l=o.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,o,a,e)}catch(u){this.error(u)}n(l)}else{const l=i.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||o.status>=400&&o.status<500)r(new nt({type:te.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:a,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${a}). Status: ${o.status} (${o.statusText})`));else{const u=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(e,t).then(n,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,this.setupLicenseXHR(o,a,e,t).then(({xhr:l,licenseChallenge:c})=>{e.keySystem==me.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c)})})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,Kt(i,"encrypted",this.onMediaEncrypted),Kt(i,"waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(hi(e,"encrypted",this.onMediaEncrypted),hi(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;if(this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},!this.mediaKeys&&!this.mediaKeySessions.length)return;const t=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,ln.clearKeyUriToKeyIdMap();const n=i.length;Mi.CDMCleanupPromise=Promise.all(i.map(r=>this.removeSession(r)).concat(t==null||(e=t.setMediaKeys(null))==null?void 0:e.catch(r=>{var a;this.log(`Could not clear media keys: ${r}`),(a=this.hls)==null||a.trigger(E.ERROR,{type:te.OTHER_ERROR,details:M.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${r}`)})}))).catch(r=>{var a;this.log(`Could not close sessions and clear media keys: ${r}`),(a=this.hls)==null||a.trigger(E.ERROR,{type:te.OTHER_ERROR,details:M.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${r}`)})}).then(()=>{n&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((n,r)=>(n.indexOf(r.keyFormat)===-1&&n.push(r.keyFormat),n),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const n=this.mediaKeySessions.indexOf(e);n>-1&&this.mediaKeySessions.splice(n,1);const{drmSystemOptions:r}=this.config;return(_m(r)?new Promise((o,l)=>{self.setTimeout(()=>l(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(o)}):Promise.resolve()).catch(o=>{var l;this.log(`Could not remove session: ${o}`),(l=this.hls)==null||l.trigger(E.ERROR,{type:te.OTHER_ERROR,details:M.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${o}`)})}).then(()=>t.close()).catch(o=>{var l;this.log(`Could not close session: ${o}`),(l=this.hls)==null||l.trigger(E.ERROR,{type:te.OTHER_ERROR,details:M.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${o}`)})})}}}Mi.CDMCleanupPromise=void 0;class nt extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}class kv{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(E.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(E.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const n=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=n,n&&typeof n.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const n=performance.now();if(t){if(this.lastTime){const r=n-this.lastTime,a=i-this.lastDroppedFrames,o=t-this.lastDecodedFrames,l=1e3*a/r,c=this.hls;if(c.trigger(E.FPS_DROP,{currentDropped:a,currentDecoded:o,totalDroppedFrames:i}),l>0&&a>c.config.fpsDroppedMonitoringThreshold*o){let u=c.currentLevel;c.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=u)&&(u=u-1,c.trigger(E.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:c.currentLevel}),c.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=n,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function Cv(s,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=s,e.dispatchEvent(t)}function ih(s,e){const t=s.mode;if(t==="disabled"&&(s.mode="hidden"),s.cues&&!s.cues.getCueById(e.id))try{if(s.addCue(e),!s.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){Te.debug(`[texttrack-utils]: ${i}`);try{const n=new self.TextTrackCue(e.startTime,e.endTime,e.text);n.id=e.id,s.addCue(n)}catch(n){Te.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${n}`)}}t==="disabled"&&(s.mode=t)}function os(s,e){const t=s.mode;if(t==="disabled"&&(s.mode="hidden"),s.cues)for(let i=s.cues.length;i--;)s.removeCue(s.cues[i]);t==="disabled"&&(s.mode=t)}function sh(s,e,t,i){const n=s.mode;if(n==="disabled"&&(s.mode="hidden"),s.cues&&s.cues.length>0){const r=Pv(s.cues,e,t);for(let a=0;a<r.length;a++)s.removeCue(r[a])}n==="disabled"&&(s.mode=n)}function Rv(s,e){if(e<=s[0].startTime)return 0;const t=s.length-1;if(e>s[t].endTime)return-1;let i=0,n=t,r;for(;i<=n;)if(r=Math.floor((n+i)/2),e<s[r].startTime)n=r-1;else if(e>s[r].startTime&&i<t)i=r+1;else return r;return s[i].startTime-e<e-s[n].startTime?i:n}function Pv(s,e,t){const i=[],n=Rv(s,e);if(n>-1)for(let r=n,a=s.length;r<a;r++){const o=s[r];if(o.startTime>=e&&o.endTime<=t)i.push(o);else if(o.startTime>t)return i}return i}function bn(s){const e=[];for(let t=0;t<s.length;t++){const i=s[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(s[t])}return e}class Dv extends jd{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=bn(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}const n=this.findTrackForTextTrack(t);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.LEVEL_LOADING,this.onLevelLoading,this),e.on(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(E.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.LEVEL_LOADING,this.onLevelLoading,this),e.off(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(E.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(E.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const n=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,n)return;bn(i.textTracks).forEach(a=>{os(a)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:n,details:r}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==n){this.warn(`Subtitle track with id:${i} and group:${n} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Subtitle track ${i} "${a.name}" lang:${a.lang} group:${n} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,n=this.groupIds;let r=this.currentTrack;if(!i||(n==null?void 0:n.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(n==null?void 0:n.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(u=>u.default)&&(this.selectDefaultTrack=!1),a.forEach((u,d)=>{u.id=d});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const o=this.hls.config.subtitlePreference;if(!r&&o){this.selectDefaultTrack=!1;const u=St(o,a);if(u>-1)r=a[u];else{const d=St(o,this.tracks);r=this.tracks[d]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const c={subtitleTracks:a};this.log(`Updating subtitle tracks, ${a.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(E.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let n=0;n<t.length;n++){const r=t[n];if(!(i&&!r.default||!i&&!e)&&(!e||ui(r,e)))return n}if(e){for(let n=0;n<t.length;n++){const r=t[n];if(rs(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const r=t[n];if(rs(e.attrs,r.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(pa(n,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Ct.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&ui(e,i))return i;const n=St(e,this.tracksInGroup);if(n>-1){const r=this.tracksInGroup[n];return this.setSubtitleTrack(n),r}else{if(i)return null;{const r=St(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,r=this.getUrlWithDirectives(e.url,t),a=e.details,o=a==null?void 0:a.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${n}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${o&&a.live?" age "+o.toFixed(1)+(a.type&&" "+a.type||""):""} ${r}`),this.hls.trigger(E.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:n,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=bn(e.textTracks),i=this.currentTrack;let n;if(i&&(n=t.filter(r=>pa(i,r))[0],n||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==n&&(r.mode="disabled")}),n){const r=this.subtitleDisplay?"showing":"hidden";n.mode!==r&&(n.mode=r)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!J(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e]||null;if(this.trackId=e,this.currentTrack=n,this.toggleTrackModes(),!n){this.hls.trigger(E.SUBTITLE_TRACK_SWITCH,{id:e});return}const r=!!n.details&&!n.details.live;if(e===this.trackId&&n===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(n?` "${n.name}" lang:${n.lang} group:${n.groupId}`:""));const{id:a,groupId:o="",name:l,type:c,url:u}=n;this.hls.trigger(E.SUBTITLE_TRACK_SWITCH,{id:a,groupId:o,name:l,type:c,url:u});const d=this.switchParams(n.url,i==null?void 0:i.details,n.details);this.loadPlaylist(d)}}function ls(s){let e=5381,t=s.length;for(;t;)e=e*33^s.charCodeAt(--t);return(e>>>0).toString()}const Fi=.025;let Tn=function(s){return s[s.Point=0]="Point",s[s.Range=1]="Range",s}({});function Ov(s,e,t){return`${s.identifier}-${t+1}-${ls(e)}`}class Mv{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const i=this.playoutLimit;return e<=0||isNaN(i)?!1:i===0?!0:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>i}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return Ea(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,i=Ea(t,e);return t-i<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=J(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return Ea(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<Fi))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?Tn.Range:Tn.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return Fv(this)}}function Ea(s,e){return s-e.start<e.duration/2&&!(Math.abs(s-(e.start+e.duration))<Fi)?e.start:e.start+e.duration}function nh(s,e,t){const i=new self.URL(s,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function ba(s,e){for(;(t=s.assetList[++e])!=null&&t.error;)var t;return e}function Fv(s){return`["${s.identifier}" ${s.cue.pre?"<pre>":s.cue.post?"<post>":""}${s.timelineStart.toFixed(2)}-${s.resumeTime.toFixed(2)}]`}function Ni(s){const e=s.timelineStart,t=s.duration||0;return`["${s.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class Nv{constructor(e,t,i,n){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls.trigger(E.PLAYOUT_LIMIT_REACHED,{})};const r=this.hls=new e(t);this.interstitial=i,this.assetItem=n;let a=n.uri;try{a=nh(a,t.primarySessionId).href}catch{}r.loadSource(a);const o=()=>{this.hasDetails=!0};r.once(E.LEVEL_LOADED,o),r.once(E.AUDIO_TRACK_LOADED,o),r.once(E.SUBTITLE_TRACK_LOADED,o),r.on(E.MEDIA_ATTACHING,(l,{media:c})=>{this.removeMediaListeners(),this.mediaAttached=c,this.interstitial.playoutLimit&&(c.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&r.on(E.BUFFER_APPENDED,()=>{const d=this.bufferedEnd;this.reachedPlayout(d)&&(this._bufferedEosTime=d,r.trigger(E.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){var e;return((e=this.interstitial)==null?void 0:e.appendInPlace)||!1}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;const i=this.timelineOffset,n=ve.bufferInfo(e,i,0);return this.getAssetTime(n.end)>=this._bufferedEosTime-.02}reachedPlayout(e){const i=this.interstitial.playoutLimit;return this.startOffset+e>=i}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=ve.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;return e||0}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}resetDetails(){const e=this.hls;if(this.hasDetails){e.stopLoad();const t=i=>delete i.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,i){this.hls.on(e,t)}once(e,t,i){this.hls.once(e,t)}off(e,t,i){this.hls.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${Ni(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const rh=.033;class Uv extends Rt{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,n)=>e<=n.startOffset&&t>n.startOffset?(delete n.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const n=this.items;if(n)for(n[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(r=n[i])!=null&&r.event;){var r;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let n=0;n<i.length;n++){let r=i[n];if(t&&t!=="primary"&&(r=r[t]),e===r.start||e>r.start&&e<r.end)return n}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let n=e;n<=t&&i[n];n++){const r=i[n].event;if(r!=null&&r.restrictions.jump&&!r.appendInPlace)return n}return-1}findEventIndex(e){const t=this.items;if(t)for(let n=t.length;n--;){var i;if(((i=t[n].event)==null?void 0:i.identifier)===e)return n}return-1}findAssetIndex(e,t){const i=e.assetList,n=i.length;if(n>1)for(let r=0;r<n;r++){const a=i[r];if(!a.error){const o=a.timelineStart;if(t===o||t>o&&t<o+(a.duration||0))return r}}return 0}get assetIdAtEnd(){var e,t;const i=(e=this.items)==null||(t=e[this.length-1])==null?void 0:t.event;if(i){const n=i.assetList,r=n[n.length-1];if(r)return r.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:n}=i,r=this.events,a=this.parseDateRanges(n,{url:i.url},t),o=Object.keys(n),l=r?r.filter(c=>!o.includes(c.identifier)):[];a.length&&a.sort((c,u)=>{const d=c.cue.pre,f=c.cue.post,g=u.cue.pre,p=u.cue.post;if(d&&!g)return-1;if(g&&!d||f&&!p)return 1;if(p&&!f)return-1;if(!d&&!g&&!f&&!p){const v=c.startTime,S=u.startTime;if(v!==S)return v-S}return c.dateRange.tagOrder-u.dateRange.tagOrder}),this.events=a,l.forEach(c=>{this.removeEvent(c)}),this.updateSchedule(e,l)}updateSchedule(e,t=[]){const i=this.events||[];if(i.length||t.length||this.length<2){const n=this.items,r=this.parseSchedule(i,e);(t.length||(n==null?void 0:n.length)!==r.length||r.some((o,l)=>Math.abs(o.playout.start-n[l].playout.start)>.005||Math.abs(o.playout.end-n[l].playout.end)>.005))&&(this.items=r,this.onScheduleUpdate(t,n))}}parseDateRanges(e,t,i){const n=[],r=Object.keys(e);for(let a=0;a<r.length;a++){const o=r[a],l=e[o];if(l.isInterstitial){let c=this.eventMap[o];c?c.setDateRange(l):(c=new Mv(l,t),this.eventMap[o]=c,i===!1&&(c.appendInPlace=i)),n.push(c)}}return n}parseSchedule(e,t){const i=[],n=t.main.details,r=n.live?1/0:n.edge;let a=0;if(e=e.filter(l=>!l.error&&!(l.cue.once&&l.hasPlayed)),e.length){this.resolveOffsets(e,t);let l=0,c=0;if(e.forEach((u,d)=>{const f=u.cue.pre,g=u.cue.post,p=e[d-1]||null,v=u.appendInPlace,S=g?r:u.startOffset,b=u.duration,I=u.timelineOccupancy===Tn.Range?b:0,w=u.resumptionOffset,_=(p==null?void 0:p.startTime)===S,T=S+u.cumulativeDuration;let C=v?T+b:S+w;if(f||!g&&S<=0){const k=c;c+=I,u.timelineStart=T;const D=a;a+=b,i.push({event:u,start:T,end:C,playout:{start:D,end:a},integrated:{start:k,end:c}})}else if(S<=r){if(!_){const R=S-l;if(R>rh){const N=l,V=c;c+=R;const W=a;a+=R;const q={previousEvent:e[d-1]||null,nextEvent:u,start:N,end:N+R,playout:{start:W,end:a},integrated:{start:V,end:c}};i.push(q)}else R>0&&p&&(p.cumulativeDuration+=R,i[i.length-1].end=S)}g&&(C=T),u.timelineStart=T;const k=c;c+=I;const D=a;a+=b,i.push({event:u,start:T,end:C,playout:{start:D,end:a},integrated:{start:k,end:c}})}else return;const A=u.resumeTime;g||A>r?l=r:l=A}),l<r){var o;const u=l,d=c,f=r-l;c+=f;const g=a;a+=f,i.push({previousEvent:((o=i[i.length-1])==null?void 0:o.event)||null,nextEvent:null,start:l,end:u+f,playout:{start:g,end:a},integrated:{start:d,end:c}})}this.setDurations(r,a,c)}else i.push({previousEvent:null,nextEvent:null,start:0,end:r,playout:{start:0,end:r},integrated:{start:0,end:r}}),this.setDurations(r,r,r);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,n=i.live?1/0:i.edge;let r=0,a=-1;e.forEach((o,l)=>{const c=o.cue.pre,u=o.cue.post,d=c?0:u?n:o.startTime;this.updateAssetDurations(o),a===d?o.cumulativeDuration=r:(r=0,a=d),!u&&o.snapOptions.in&&(o.resumeAnchor=Li(null,i.fragments,o.startOffset+o.resumptionOffset,0,0)||void 0),o.appendInPlace&&!o.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(o,t)||(o.appendInPlace=!1)),!o.appendInPlace&&l+1<e.length&&e[l+1].startTime-e[l].resumeTime<rh&&(e[l+1].appendInPlace=!1,e[l+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${o}`));const g=J(o.resumeOffset)?o.resumeOffset:o.duration;r+=g})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,n=e.startTime+e.resumptionOffset;return Math.abs(i-n)>Fi?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${n}`),!1):t?!Object.keys(t).some(a=>{const o=t[a].details,l=o.edge;if(i>=l)return this.log(`"${e.identifier}" resumption ${i} past ${a} playlist end ${l}`),!1;const c=Li(null,o.fragments,i);if(!c)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${a} playlist (${o.fragStart}-${o.fragmentEnd})`),!0;const u=a==="audio"?.175:0;return Math.abs(c.start-i)<Fi+u||Math.abs(c.end-i)<Fi+u?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${a} fragment bounds (${c.start}-${c.end} sn: ${c.sn} cc: ${c.cc})`),!0)}):(this.log(`"${e.identifier}" resumption ${i} can not be aligned with media (none selected)`),!1)}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,n=!1,r=!1;e.assetList.forEach((a,o)=>{const l=t+i;a.startOffset=i,a.timelineStart=l,n||(n=a.duration===null),r||(r=!!a.error);const c=a.error?0:a.duration||0;i+=c}),n&&!r?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function Ht(s){return`[${s.event?'"'+s.event.identifier+'"':"primary"}: ${s.start.toFixed(2)}-${s.end.toFixed(2)}]`}class Bv{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let n;try{n=nh(i,this.hls.sessionId,e.baseUrl)}catch(f){const g=this.assignAssetListError(e,M.ASSET_LIST_LOAD_ERROR,f,i);this.hls.trigger(E.ERROR,g);return}t&&n.protocol!=="data:"&&n.searchParams.set("_HLS_start_offset",""+t);const r=this.hls.config,a=r.loader,o=new a(r),l={responseType:"json",url:n.href},c=r.interstitialAssetListLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(f,g,p,v)=>{const S=f.data,b=S==null?void 0:S.ASSETS;if(!Array.isArray(b)){const I=this.assignAssetListError(e,M.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),p.url,g,v);this.hls.trigger(E.ERROR,I);return}e.assetListResponse=S,this.hls.trigger(E.ASSET_LIST_LOADED,{event:e,assetListResponse:S,networkDetails:v})},onError:(f,g,p,v)=>{const S=this.assignAssetListError(e,M.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${f.code} ${f.text} (${g.url})`),g.url,v,p);this.hls.trigger(E.ERROR,S)},onTimeout:(f,g,p)=>{const v=this.assignAssetListError(e,M.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${g.url})`),g.url,f,p);this.hls.trigger(E.ERROR,v)}};return o.load(l,u,d),this.hls.trigger(E.ASSET_LIST_LOADING,{event:e}),o}assignAssetListError(e,t,i,n,r,a){return e.error=i,{type:te.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:n,error:i,networkDetails:a,stats:r}}}function ah(s){s==null||s.play().catch(()=>{})}class $v extends Rt{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;const n=i-this.timelinePos;if(Math.abs(n)<1/7056e5)return;const a=n<=-.01;this.timelinePos=i,this.bufferedPos=i;const o=this.playingItem;if(!o){this.checkBuffer();return}if(a&&this.schedule.resetErrorsInRange(i,i-n)&&this.updateSchedule(),this.checkBuffer(),a&&i<o.start||i>=o.end){var l;const f=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(o)&&(l=this.media)!=null&&l.paused&&(this.shouldPlay=!1),!a){const g=this.findItemIndex(o);if(f>g){const p=this.schedule.findJumpRestrictedIndex(g+1,f);if(p>g){this.setSchedulePosition(p);return}}}this.setSchedulePosition(f);return}const c=this.playingAsset;if(!c){if(this.playingLastItem&&this.isInterstitial(o)){const f=o.event.assetList[0];f&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,f))}return}const u=c.timelineStart,d=c.duration||0;(a&&i<u||i>=u+d)&&this.setScheduleToAssetAtTime(i,c)},this.onTimeupdate=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;const n=this.playingItem;if(!n||this.playingLastItem)return;if(i>=n.end){this.timelinePos=n.end;const o=this.findItemIndex(n);this.setSchedulePosition(o+1)}const r=this.playingAsset;if(!r)return;const a=r.timelineStart+(r.duration||0);i>=a&&this.setScheduleToAssetAtTime(i,r)},this.onScheduleUpdate=(i,n)=>{const r=this.schedule,a=this.playingItem,o=r.events||[],l=r.items||[],c=r.durations,u=i.map(p=>p.identifier),d=!!(o.length||u.length);(d||n)&&this.log(`INTERSTITIALS_UPDATED (${o.length}): ${o}
Schedule: ${l.map(p=>Ht(p))} pos: ${this.timelinePos}`),u.length&&this.log(`Removed events ${u}`),this.playerQueue.forEach(p=>{if(p.interstitial.appendInPlace){const v=p.assetItem.timelineStart,S=p.timelineOffset-v;if(S)try{p.timelineOffset=v}catch(b){Math.abs(S)>Fi&&this.warn(`${b} ("${p.assetId}" ${p.timelineOffset}->${v})`)}}});let f=null;if(a){const p=this.updateItem(a,this.timelinePos);this.itemsMatch(a,p)&&(this.playingItem=p,this.waitingItem=this.endedItem=null,f=()=>this.trimInPlace(p,a))}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const g=this.bufferingItem;if(g){const p=this.updateItem(g,this.bufferedPos);this.itemsMatch(g,p)?(this.bufferingItem=p,f||(f=()=>this.trimInPlace(p,g))):g.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(g.event,null))}if(i.forEach(p=>{p.assetList.forEach(v=>{this.clearAssetPlayer(v.identifier,null)})}),d||n){if(this.hls.trigger(E.INTERSTITIALS_UPDATED,{events:o.slice(0),schedule:l.slice(0),durations:c,removedIds:u}),this.isInterstitial(a)&&u.includes(a.event.identifier)){this.warn(`Interstitial "${a.event.identifier}" removed while playing`),this.primaryFallback(a.event);return}f&&f(),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new Bv(e),this.schedule=new Uv(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(E.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(E.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(E.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(E.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(E.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(E.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(E.BUFFER_APPENDED,this.onBufferAppended,this),e.on(E.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(E.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(E.MEDIA_ENDED,this.onMediaEnded,this),e.on(E.ERROR,this.onError,this),e.on(E.DESTROYING,this.onDestroying,this)}unregisterListeners(){const e=this.hls;e&&(e.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(E.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(E.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(E.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(E.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(E.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(E.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(E.BUFFER_CODECS,this.onBufferCodecs,this),e.off(E.BUFFER_APPENDED,this.onBufferAppended,this),e.off(E.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(E.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(E.MEDIA_ENDED,this.onMediaEnded,this),e.off(E.ERROR,this.onError,this),e.off(E.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){hi(e,"play",this.onPlay),hi(e,"pause",this.onPause),hi(e,"seeking",this.onSeeking),hi(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;Kt(i,"seeking",this.onSeeking),Kt(i,"timeupdate",this.onTimeupdate),Kt(i,"play",this.onPlay),Kt(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,n=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!n){this.clearScheduleState();const r=this.findItemIndex(i);this.setSchedulePosition(r)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(this.media=null,!i&&(n&&this.removeMediaListeners(n),this.detachedData)){const r=this.getBufferingPlayer();r&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,r.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=d=>d&&e.getAssetPlayer(d.identifier),n=(d,f,g,p,v)=>{if(d){let S=d[f].start;const b=d.event;if(b){if(f==="playout"||b.timelineOccupancy!==Tn.Point){const I=i(g);(I==null?void 0:I.interstitial)===b&&(S+=I.assetItem.startOffset+I[v])}}else{const I=p==="bufferedPos"?a():e[p];S+=I-d.start}return S}return 0},r=(d,f)=>{if(d!==0&&f!=="primary"&&e.schedule.length){var g;const p=e.schedule.findItemIndexAtTime(d),v=(g=e.schedule.items)==null?void 0:g[p];if(v){const S=v[f].start-v.start;return d+S}}return d},a=()=>{const d=e.bufferedPos;return d===Number.MAX_VALUE?o("primary"):Math.max(d,0)},o=d=>{var f;return(f=e.primaryDetails)!=null&&f.live?e.primaryDetails.edge:e.schedule.durations[d]},l=(d,f)=>{var g,p;const v=e.effectivePlayingItem;if(v!=null&&(g=v.event)!=null&&g.restrictions.skip)return;e.log(`seek to ${d} "${f}"`);const S=e.effectivePlayingItem,b=e.schedule.findItemIndexAtTime(d,f),I=(p=e.schedule.items)==null?void 0:p[b],w=e.getBufferingPlayer(),_=w==null?void 0:w.interstitial,T=_==null?void 0:_.appendInPlace,C=S&&e.itemsMatch(S,I);if(S&&(T||C)){const k=i(e.playingAsset),D=(k==null?void 0:k.media)||e.primaryMedia;if(D){const R=f==="primary"?D.currentTime:n(S,f,e.playingAsset,"timelinePos","currentTime"),N=d-R,V=(T?R:D.currentTime)+N;if(V>=0&&(!k||T||V<=k.duration)){D.currentTime=V;return}}}if(I){let k=d;if(f!=="primary"){const R=I[f].start,N=d-R;k=I.start+N}const D=!e.isInterstitial(I);if((!e.isInterstitial(S)||S.event.appendInPlace)&&(D||I.event.appendInPlace)){const R=e.media||(T?w==null?void 0:w.media:null);R&&(R.currentTime=k)}else if(S){const R=e.findItemIndex(S);if(b>R){const V=e.schedule.findJumpRestrictedIndex(R+1,b);if(V>R){e.setSchedulePosition(V);return}}let N=0;if(D)e.timelinePos=k,e.checkBuffer();else{var A;const V=I==null||(A=I.event)==null?void 0:A.assetList;if(V){const W=d-(I[f]||I).start;for(let q=V.length;q--;){const ee=V[q];if(ee.duration&&W>=ee.startOffset&&W<ee.startOffset+ee.duration){N=q;break}}}}e.setSchedulePosition(b,N)}}},c=()=>{const d=e.effectivePlayingItem;if(e.isInterstitial(d))return d;const f=t();return e.isInterstitial(f)?f:null},u={get currentTime(){const d=c(),f=e.effectivePlayingItem;return f&&f===d?n(f,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-f.playout.start:0},set currentTime(d){const f=c(),g=e.effectivePlayingItem;g&&g===f&&l(d+g.playout.start,"playout")},get duration(){const d=c();return d?d.playout.end-d.playout.start:0},get assetPlayers(){var d;const f=(d=c())==null?void 0:d.event.assetList;return f?f.map(g=>e.getAssetPlayer(g.identifier)):[]},get playingIndex(){var d;const f=(d=c())==null?void 0:d.event;return f&&e.effectivePlayingAsset?f.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return c()}};this.manager={get events(){var d,f;return((d=e.schedule)==null||(f=d.events)==null?void 0:f.slice(0))||[]},get schedule(){var d,f;return((d=e.schedule)==null||(f=d.items)==null?void 0:f.slice(0))||[]},get interstitialPlayer(){return c()?u:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const d=t();return e.findItemIndex(d)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const d=e.effectivePlayingItem;return e.findItemIndex(d)},primary:{get bufferedEnd(){return a()},get currentTime(){const d=e.timelinePos;return d>0?d:0},set currentTime(d){l(d,"primary")},get duration(){return o("primary")},get seekableStart(){var d;return((d=e.primaryDetails)==null?void 0:d.fragmentStart)||0}},integrated:{get bufferedEnd(){return n(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return n(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(d){l(d,"integrated")},get duration(){return o("integrated")},get seekableStart(){var d;return r(((d=e.primaryDetails)==null?void 0:d.fragmentStart)||0,"integrated")}},skip:()=>{const d=e.effectivePlayingItem,f=d==null?void 0:d.event;if(f&&!f.restrictions.skip){const g=e.findItemIndex(d);if(f.appendInPlace){const p=d.playout.start+d.event.duration;l(p+.001,"playout")}else e.advanceAfterAssetEnded(f,g,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t,i;if(this.mediaSelection===null)return;const n=this.waitingItem||this.playingItem;if(this.isInterstitial(n)&&!n.event.appendInPlace)return;let r=this.media;!r&&(e=this.bufferingItem)!=null&&(t=e.event)!=null&&t.appendInPlace&&(r=this.primaryMedia);const a=(i=r)==null?void 0:i.currentTime;if(!(a===void 0||!J(a)))return a}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,n=e.media;if(i&&n===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&n){this.detachedData={media:n};return}const r=e.transferMedia();this.log(`transfer MediaSource from ${e} ${we(r)}`),this.detachedData=r}else t&&n&&(this.shouldPlay||(this.shouldPlay=!n.paused))}transferMediaTo(e,t){var i,n;if(e.media===t)return;let r=null;const a=this.hls,o=e!==a,l=o&&e.interstitial.appendInPlace,c=(i=this.detachedData)==null?void 0:i.mediaSource;let u;if(a.media)l&&(r=a.transferMedia(),this.detachedData=r),u="Primary";else if(c){const g=this.getBufferingPlayer();g?(r=g.transferMedia(),u=`${g}`):u="detached MediaSource"}else u="detached media";if(!r){if(c)r=this.detachedData,this.log(`using detachedData: MediaSource ${we(r)}`);else if(!this.detachedData||a.media===t){const g=this.playerQueue;g.length>1&&g.forEach(p=>{if(o&&p.interstitial.appendInPlace!==l){const v=p.interstitial;this.clearInterstitial(p.interstitial,null),v.appendInPlace=!1,v.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${v}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const d=r&&"mediaSource"in r&&((n=r.mediaSource)==null?void 0:n.readyState)!=="closed",f=d&&r?r:t;if(this.log(`${d?"transfering MediaSource":"attaching media"} to ${o?e:"Primary"} from ${u}`),f===r){const g=o&&e.assetId===this.schedule.assetIdAtEnd;f.overrides={duration:this.schedule.duration,endOfStream:!o||g,cueRemoval:!o}}e.attachMedia(f)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const i=this.timelinePos,n=this.effectivePlayingItem;if(i===-1){const r=this.hls.startPosition;if(this.timelinePos=r,t.length&&t[0].cue.pre){const a=e.findEventIndex(t[0].identifier);this.setSchedulePosition(a)}else if(r>=0||!this.primaryLive){const a=this.timelinePos=r>0?r:0,o=e.findItemIndexAtTime(a);this.setSchedulePosition(o)}}else if(n&&!this.playingItem){const r=e.findItemIndex(n);this.setSchedulePosition(r)}}advanceAfterAssetEnded(e,t,i){const n=ba(e,i);if(!e.isAssetPastPlayoutLimit(n))this.setSchedulePosition(t,n);else{const r=this.schedule.items;if(r){const a=t+1,o=r.length;if(a>=o){this.setSchedulePosition(-1);return}const l=e.resumeTime;this.timelinePos<l&&(this.timelinePos=l,this.checkBuffer()),this.setSchedulePosition(a)}}}setScheduleToAssetAtTime(e,t){const i=this.schedule,n=t.parentIdentifier,r=i.getEvent(n);if(r){const a=i.findEventIndex(n),o=i.findAssetIndex(r,e);this.advanceAfterAssetEnded(r,a,o-1)}}setSchedulePosition(e,t){const i=this.schedule.items;if(!i||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${t}`);const n=e>=0?i[e]:null,r=this.playingItem,a=this.playingLastItem;if(this.isInterstitial(r)){var o;const c=r.event,u=this.playingAsset,d=u==null?void 0:u.identifier,f=d?this.getAssetPlayer(d):null;if(f&&d&&(!this.eventItemsMatch(r,n)||t!==void 0&&d!==((o=c.assetList)==null?void 0:o[t].identifier))){var l;const g=c.findAssetIndex(u);this.log(`INTERSTITIAL_ASSET_ENDED ${g+1}/${c.assetList.length} ${Ni(u)}`),this.endedAsset=u,this.playingAsset=null,this.hls.trigger(E.INTERSTITIAL_ASSET_ENDED,{asset:u,assetListIndex:g,event:c,schedule:i.slice(0),scheduleIndex:e,player:f}),this.retreiveMediaSource(d,n),f.media&&!((l=this.detachedData)!=null&&l.mediaSource)&&f.detachMedia()}if(!this.eventItemsMatch(r,n)&&(this.endedItem=r,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${c} ${Ht(r)}`),c.hasPlayed=!0,this.hls.trigger(E.INTERSTITIAL_ENDED,{event:c,schedule:i.slice(0),scheduleIndex:e}),c.cue.once)){this.updateSchedule();const g=this.schedule.items;if(n&&g){const p=this.schedule.findItemIndex(n);this.advanceSchedule(p,g,t,r,a)}return}}this.advanceSchedule(e,i,t,r,a)}advanceSchedule(e,t,i,n,r){const a=e>=0?t[e]:null,o=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(c=>{const u=c.interstitial,d=this.schedule.findEventIndex(u.identifier);(d<e||d>e+1)&&this.clearInterstitial(u,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);const c=a.event;if(i===void 0){i=this.schedule.findAssetIndex(c,this.timelinePos);const g=ba(c,i-1);if(c.isAssetPastPlayoutLimit(g)){this.advanceAfterAssetEnded(c,e,i);return}i=g}const u=this.waitingItem;this.assetsBuffered(a,o)||this.setBufferingItem(a);let d=this.preloadAssets(c,i);if(this.eventItemsMatch(a,u||n)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${Ht(a)} ${c.appendInPlace?"append in place":""}`),this.hls.trigger(E.INTERSTITIAL_STARTED,{event:c,schedule:t.slice(0),scheduleIndex:e})),!c.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${c}`);return}if(c.assetListLoader&&(c.assetListLoader.destroy(),c.assetListLoader=void 0),!o){this.log(`Waiting for attachMedia to start Interstitial ${c}`);return}this.waitingItem=this.endedItem=null,this.playingItem=a;const f=c.assetList[i];if(!f){const g=t[e+1],p=this.media;g&&p&&!this.isInterstitial(g)&&p.currentTime<g.start&&(p.currentTime=this.timelinePos=g.start),this.advanceAfterAssetEnded(c,e,i||0);return}if(d||(d=this.getAssetPlayer(f.identifier)),d===null||d.destroyed){const g=c.assetList.length;this.warn(`asset ${i+1}/${g} player destroyed ${c}`),d=this.createAssetPlayer(c,f,i)}if(!this.eventItemsMatch(a,this.bufferingItem)&&c.appendInPlace&&this.isAssetBuffered(f))return;this.startAssetPlayer(d,i,t,e,o),this.shouldPlay&&ah(d.media)}else a!==null?(this.resumePrimary(a,e,n),this.shouldPlay&&ah(this.hls.media)):r&&this.isInterstitial(n)&&(this.endedItem=null,this.playingItem=n,n.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e,t;return(e=this.mediaSelection)==null||(t=e.main)==null?void 0:t.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var n;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Ht(e)}`),!((n=this.detachedData)!=null&&n.mediaSource)){let a=this.timelinePos;(a<e.start||a>=e.end)&&(a=this.getPrimaryResumption(e,t),this.timelinePos=a),this.attachPrimary(a,e)}if(!i)return;const r=this.schedule.items;r&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${Ht(e)}`),this.hls.trigger(E.INTERSTITIALS_PRIMARY_RESUMED,{schedule:r.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const n=this.primaryDetails;if(t===0)return this.hls.startPosition;if(n&&(i<n.fragmentStart||i>n.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:ve.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const n=this.primaryMedia;if(!n)return;const r=this.hls;r.media?this.checkBuffer():(this.transferMediaTo(r,n),i&&this.startLoadingPrimaryAt(e,i)),i||(this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const n=this.hls;!n.loadingEnabled||!n.media||Math.abs((((i=n.mainForwardBufferInfo)==null?void 0:i.start)||n.media.currentTime)-e)>.5?n.startLoad(e,t):n.bufferingEnabled||n.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(E.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(E.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1)return;const i=this.hls.levels[t.level],n=_e(_e({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=n,this.schedule.parseInterstitialDateRanges(n,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=_e(_e({},this.altSelection),{},{audio:i});return}const r=_e(_e({},n),{},{audio:i});this.mediaSelection=r}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=_e(_e({},this.altSelection),{},{subtitles:i});return}const r=_e(_e({},n),{},{subtitles:i});this.mediaSelection=r}onAudioTrackSwitching(e,t){const i=Gu(t);this.playerQueue.forEach(n=>n.hls.setAudioOption(t)||n.hls.setAudioOption(i))}onSubtitleTrackSwitch(e,t){const i=Gu(t);this.playerQueue.forEach(n=>n.hls.setSubtitleOption(t)||t.id!==-1&&n.hls.setSubtitleOption(i))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const n=this.timelinePos;this.bufferedPos=n,this.checkBuffer()}}onBufferedToEnd(e){const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let n=0;n<t.length;n++){const r=t[n];if(r.cue.post){var i;const a=this.schedule.findEventIndex(r.identifier),o=(i=this.schedule.items)==null?void 0:i[a];this.isInterstitial(o)&&this.eventItemsMatch(o,this.bufferingItem)&&this.bufferedToItem(o,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){const i=this.schedule.items;if(e&&i){const n=this.findItemIndex(e,t);return i[n]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((r,a)=>{e.event.isAssetPastPlayoutLimit(a)&&this.clearAssetPlayer(r.identifier,null)});const i=e.end+.25,n=ve.bufferInfo(this.primaryMedia,i,0);(n.end>i||(n.nextStart||0)>i)&&(this.attachPrimary(i,null),this.flushFrontBuffer(i))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e?this.schedule.findItemIndex(e,t):-1}updateSchedule(){const e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){const t=this.schedule.items;if(!t)return;const i=ve.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,t,e)}updateBufferedPos(e,t,i){const n=this.schedule,r=this.bufferingItem;if(this.bufferedPos>e)return;if(t.length===1&&this.itemsMatch(t[0],r)){this.bufferedPos=e;return}const a=this.playingItem,o=this.findItemIndex(a);let l=n.findItemIndexAtTime(e);if(this.bufferedPos<e){var c,u;const d=this.findItemIndex(r),f=Math.min(d+1,t.length-1),g=t[f];if((l===-1&&r&&e>=r.end||(c=g.event)!=null&&c.appendInPlace&&e+.01>=g.start)&&(l=f),f-o>1&&(r==null||(u=r.event)==null?void 0:u.appendInPlace)===!1)return;if(this.bufferedPos=e,l>d&&l>o)this.bufferedToItem(g);else{const p=this.primaryDetails;this.primaryLive&&p&&e>p.edge-p.targetduration&&g.start<p.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(g)&&this.preloadAssets(g.event,0)}}else i&&a&&!this.itemsMatch(a,r)&&(l===o?this.bufferedToItem(a):l===o+1&&this.bufferedToItem(t[l]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(n=>{const r=this.getAssetPlayer(n.identifier);return!(r!=null&&r.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(this.itemsMatch(e,t))this.bufferingItem!==e&&(this.bufferingItem=e);else{const{items:n,events:r}=i;if(!n||!r)return t;const a=this.isInterstitial(e),o=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const l=o?o.remaining:t?t.end-this.timelinePos:0;this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${Ht(e)}`+(t?` (${l.toFixed(2)} remaining)`:"")),this.playbackDisabled||(a?e.event.assetList.forEach(c=>{const u=this.getAssetPlayer(c.identifier);u&&u.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(c=>c.pauseBuffering()))),this.hls.trigger(E.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:r.slice(0),schedule:n.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;const n=this.detachedData;n?n.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,n=i.assetList.length===0&&!i.assetListLoader,r=i.cue.once;if(n||!r){const a=this.preloadAssets(i,t);if(a!=null&&a.interstitial.appendInPlace){const o=i.assetList[t],l=this.primaryMedia;o&&l&&this.bufferAssetPlayer(a,l)}}}preloadAssets(e,t){const i=e.assetUrl,n=e.assetList.length,r=n===0&&!e.assetListLoader,a=e.cue.once;if(r){const l=e.timelineStart;if(e.appendInPlace){var o;const f=this.playingItem;!this.isInterstitial(f)&&(f==null||(o=f.nextEvent)==null?void 0:o.identifier)===e.identifier&&this.flushFrontBuffer(l+.25)}let c,u=0;if(!this.playingItem&&this.primaryLive&&(u=this.hls.startPosition,u===-1&&(u=this.hls.liveSyncPosition||0)),u&&!(e.cue.pre||e.cue.post)){const f=u-l;f>0&&(c=Math.round(f*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:n} ${e}${c?` live-start: ${u} start-offset: ${c}`:""}`),i)return this.createAsset(e,0,0,l,e.duration,i);const d=this.assetListLoader.loadAssetList(e,c);d&&(e.assetListLoader=d)}else if(!a&&n){for(let l=t;l<n;l++){const c=e.assetList[l],u=this.getAssetPlayerQueueIndex(c.identifier);(u===-1||this.playerQueue[u].destroyed)&&!c.error&&this.createAssetPlayer(e,c,l)}return this.getAssetPlayer(e.assetList[t].identifier)}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(n=>{this.hls.trigger(E.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:n})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,n,r,a){const o={parentIdentifier:e.identifier,identifier:Ov(e,a,t),duration:r,startOffset:i,timelineStart:n,uri:a};return this.createAssetPlayer(e,o,t)}createAssetPlayer(e,t,i){const n=this.hls,r=n.userConfig;let a=r.videoPreference;const o=n.loadLevelObj||n.levels[n.currentLevel];(a||o)&&(a=Ae({},a),o.videoCodec&&(a.videoCodec=o.videoCodec),o.videoRange&&(a.allowedVideoRanges=[o.videoRange]));const l=n.audioTracks[n.audioTrack],c=n.subtitleTracks[n.subtitleTrack];let u=0;if(this.primaryLive||e.appendInPlace){const w=this.timelinePos-t.timelineStart;if(w>1){const _=t.duration;_&&w<_&&(u=w)}}const d=t.identifier,f=_e(_e({},r),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:n.sessionId,assetPlayerId:d,abrEwmaDefaultEstimate:n.bandwidthEstimate,interstitialsController:void 0,startPosition:u,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:a,audioPreference:l||r.audioPreference,subtitlePreference:c||r.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(f.timelineOffset=t.timelineStart));const g=f.cmcd;g!=null&&g.sessionId&&g.contentId&&(f.cmcd=Ae({},g,{contentId:ls(t.uri)})),this.getAssetPlayer(d)&&this.warn(`Duplicate date range identifier ${e} and asset ${d}`);const p=new Nv(this.HlsPlayerClass,f,e,t);this.playerQueue.push(p),e.assetList[i]=t;const v=w=>{if(w.live){const C=new Error(`Interstitials MUST be VOD assets ${e}`),A={fatal:!0,type:te.OTHER_ERROR,details:M.INTERSTITIAL_ASSET_ITEM_ERROR,error:C};this.handleAssetItemError(A,e,this.schedule.findEventIndex(e.identifier),i,C.message);return}const _=w.edge-w.fragmentStart,T=t.duration;(T===null||_>T)&&(this.log(`Interstitial asset "${d}" duration change ${T} > ${_}`),t.duration=_,this.updateSchedule())};p.on(E.LEVEL_UPDATED,(w,{details:_})=>v(_)),p.on(E.LEVEL_PTS_UPDATED,(w,{details:_})=>v(_));const S=(w,_)=>{const T=this.getAssetPlayer(d);if(T&&_.tracks){T.off(E.BUFFER_CODECS,S),T.tracks=_.tracks;const C=this.primaryMedia;this.bufferingAsset===T.assetItem&&C&&!T.media&&this.bufferAssetPlayer(T,C)}};p.on(E.BUFFER_CODECS,S);const b=()=>{var w;const _=this.getAssetPlayer(d);if(this.log(`buffered to end of asset ${_}`),!_)return;const T=this.schedule.findEventIndex(e.identifier),C=(w=this.schedule.items)==null?void 0:w[T];if(this.isInterstitial(C)){const k=e.findAssetIndex(t),D=ba(e,k);if(!e.isAssetPastPlayoutLimit(D))this.bufferedToItem(C,D);else{var A;const R=(A=this.schedule.items)==null?void 0:A[T+1];R&&this.bufferedToItem(R)}}};p.on(E.BUFFERED_TO_END,b);const I=w=>()=>{if(!this.getAssetPlayer(d))return;this.shouldPlay=!0;const T=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,T,w)};return p.once(E.MEDIA_ENDED,I(i)),p.once(E.PLAYOUT_LIMIT_REACHED,I(1/0)),p.on(E.ERROR,(w,_)=>{const T=this.getAssetPlayer(d);if(_.details===M.BUFFER_STALLED_ERROR){if(T!=null&&T.media){const C=T.currentTime,A=T.duration-C;C&&e.appendInPlace&&A/T.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${d} ${e} at ${T.media.currentTime}`),b()):(this.warn(`Stalled at ${C} of ${C+A} in asset ${d} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}return}this.handleAssetItemError(_,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${_.error} ${e}`)}),p.on(E.DESTROYING,()=>{if(!this.getAssetPlayer(d))return;const _=new Error(`Asset player destroyed unexpectedly ${d}`),T={fatal:!0,type:te.OTHER_ERROR,details:M.INTERSTITIAL_ASSET_ITEM_ERROR,error:_};this.handleAssetItemError(T,e,this.schedule.findEventIndex(e.identifier),i,_.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${Ni(t)}`),this.hls.trigger(E.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:p}),p}clearInterstitial(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)}),e.reset()}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);const i=this.playerQueue[t];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(i!==-1){this.log(`clear asset player "${e}" toSegment: ${t&&Ht(t)}`);const n=this.playerQueue[i];this.transferMediaFromPlayer(n,t),this.playerQueue.splice(i,1),n.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,n,r){const{interstitial:a,assetItem:o,assetId:l}=e,c=a.assetList.length,u=this.playingAsset;this.endedAsset=null,this.playingAsset=o,(!u||u.identifier!==l)&&(u&&(this.clearAssetPlayer(u.identifier,i[n]),delete u.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${c} ${Ni(o)}`),this.hls.trigger(E.INTERSTITIAL_ASSET_STARTED,{asset:o,assetListIndex:t,event:a,schedule:i.slice(0),scheduleIndex:n,player:e})),this.bufferAssetPlayer(e,r)}bufferAssetPlayer(e,t){var i,n;const{interstitial:r,assetItem:a}=e,o=this.schedule.findEventIndex(r.identifier),l=(i=this.schedule.items)==null?void 0:i[o];if(!l)return;this.setBufferingItem(l),this.bufferingAsset=a;const c=this.getBufferingPlayer();if(c===e)return;const u=r.appendInPlace;if(u&&(c==null?void 0:c.interstitial.appendInPlace)===!1)return;const d=(c==null?void 0:c.tracks)||((n=this.detachedData)==null?void 0:n.tracks)||this.requiredTracks;if(u&&a!==this.playingAsset){if(!e.tracks)return;if(d&&!bu(d,e.tracks)){const f=new Error(`Asset ${Ni(a)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(d)}')`),g={fatal:!0,type:te.OTHER_ERROR,details:M.INTERSTITIAL_ASSET_ITEM_ERROR,error:f},p=r.findAssetIndex(a);this.handleAssetItemError(g,r,o,p,f.message);return}}this.transferMediaTo(e,t)}handleAssetItemError(e,t,i,n,r){if(e.details===M.BUFFER_STALLED_ERROR)return;const a=t.assetList[n];this.warn(`INTERSTITIAL_ASSET_ERROR ${a&&Ni(a)} ${e.error}`);const o=a==null?void 0:a.identifier,l=this.getAssetPlayerQueueIndex(o),c=this.playerQueue[l]||null,u=this.schedule.items,d=Ae({},e,{fatal:!1,errorAction:Zi(!0),asset:a,assetListIndex:n,event:t,schedule:u,scheduleIndex:i,player:c});if(this.hls.trigger(E.INTERSTITIAL_ASSET_ERROR,d),!e.fatal)return;const f=this.playingAsset,g=new Error(r);if(a&&(this.clearAssetPlayer(o,null),a.error=g),!t.assetList.some(p=>!p.error))t.error=g;else if(t.appendInPlace){for(let p=n;p<t.assetList.length;p++)this.resetAssetPlayer(t.assetList[p].identifier);this.updateSchedule()}t.error?this.primaryFallback(t):f&&f.identifier===o&&this.advanceAfterAssetEnded(t,i,n)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;if(this.updateSchedule(),i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${i?Ht(i):"<none>"} error: ${e.error}`);let n=this.timelinePos;n===-1&&(n=this.hls.startPosition);const r=this.updateItem(i,n);this.itemsMatch(i,r)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));const a=this.schedule.findItemIndexAtTime(n);this.setSchedulePosition(a)}else this.checkStart()}onAssetListLoaded(e,t){var i;const n=t.event,r=n.identifier,a=t.assetListResponse.ASSETS;if(!this.schedule.hasEvent(r))return;const o=n.timelineStart,l=n.duration;let c=0;a.forEach((p,v)=>{const S=parseFloat(p.DURATION);this.createAsset(n,v,c,o+c,S,p.URI),c+=S}),n.duration=c,this.log(`Loaded asset-list with duration: ${c} (was: ${l}) ${n}`);const u=this.waitingItem,d=(u==null?void 0:u.event.identifier)===r;this.updateSchedule();const f=(i=this.bufferingItem)==null?void 0:i.event;if(d){var g;const p=this.schedule.findEventIndex(r),v=(g=this.schedule.items)==null?void 0:g[p];if(v){if(!this.playingItem&&this.timelinePos>v.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==p){n.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${n}`),this.primaryFallback(n);return}this.setBufferingItem(v)}this.setSchedulePosition(p)}else if((f==null?void 0:f.identifier)===r&&f.appendInPlace){const p=n.assetList[0],v=this.getAssetPlayer(p.identifier),S=this.primaryMedia;p&&v&&S&&this.bufferAssetPlayer(v,S)}}onError(e,t){switch(t.details){case M.ASSET_LIST_PARSING_ERROR:case M.ASSET_LIST_LOAD_ERROR:case M.ASSET_LIST_LOAD_TIMEOUT:{const i=t.interstitial;i&&this.primaryFallback(i);break}case M.BUFFER_STALLED_ERROR:{this.onTimeupdate(),this.checkBuffer(!0);break}}}}const oh=500;class jv extends fd{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",oe.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(E.LEVEL_LOADED,this.onLevelLoaded,this),e.on(E.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(E.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(E.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(E.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(E.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(E.LEVEL_LOADED,this.onLevelLoaded,this),e.off(E.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(E.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(E.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(E.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(E.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=j.IDLE,this.setInterval(oh),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:n}=t;if(ze(i)&&(this.fragPrevious=i),this.state=j.IDLE,!n)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let a;const o=i.start;for(let c=0;c<r.length;c++)if(o>=r[c].start&&o<=r[c].end){a=r[c];break}const l=i.start+i.duration;a?a.end=l:(a={start:o,end:l},r.push(a)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:n}=t;if(i===0&&n!==Number.POSITIVE_INFINITY){const r=n-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(a=>{for(let o=0;o<a.length;){if(a[o].end<=r){a.shift();continue}else if(a[o].start<r)a[o].start=r;else break;o++}}),this.fragmentTracker.removeFragmentsInRange(i,r,oe.SUBTITLE)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===oe.SUBTITLE&&(t.details===M.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==j.STOPPED&&(this.state=j.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&Gd(this.levels,t)){this.levels=t.map(i=>new Xs(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const n=new Xs(i);return this.tracksBuffered[n.id]=[],n}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,oe.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const n=this.levels[this.currentTrackId];n!=null&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.state!==j.STOPPED&&this.setInterval(oh)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:n,levels:r}=this,{details:a,id:o}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${o}`);return}const l=r[o];if(o>=r.length||!l)return;this.log(`Subtitle track ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(a.live||(i=l.details)!=null&&i.live){const d=this.mainDetails;if(a.deltaUpdateFailed||!d)return;const f=d.fragments[0];if(!l.details)a.hasProgramDateTime&&d.hasProgramDateTime?(cn(a,d),c=a.fragmentStart):f&&(c=f.start,ea(a,c));else{var u;c=this.alignPlaylists(a,l.details,(u=this.levelLastLoaded)==null?void 0:u.details),c===0&&f&&(c=f.start,ea(a,c))}}l.details=a,this.levelLastLoaded=l,o===n&&(this.hls.trigger(E.SUBTITLE_TRACK_UPDATED,{details:a,id:o,groupId:t.groupId}),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===j.IDLE&&(Li(null,a.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,n=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&n!=null&&n.key&&n.iv&&ki(n.method)){const a=performance.now();this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer,Wr(n.method)).catch(o=>{throw r.trigger(E.ERROR,{type:te.MEDIA_ERROR,details:M.FRAG_DECRYPT_ERROR,fatal:!1,error:o,reason:o.message,frag:t}),o}).then(o=>{const l=performance.now();r.trigger(E.FRAG_DECRYPTED,{frag:t,payload:o,stats:{tstart:a,tdecrypt:l}})}).catch(o=>{this.warn(`${o.name}: ${o.message}`),this.state=j.IDLE})}}doTick(){if(!this.media){this.state=j.IDLE;return}if(this.state===j.IDLE){const{currentTrackId:e,levels:t}=this,i=t==null?void 0:t[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;const{config:n}=this,r=this.getLoadPosition(),a=ve.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,n.maxBufferHole),{end:o,len:l}=a,c=i.details,u=this.hls.maxBufferLength+c.levelTargetDuration;if(l>u)return;const d=c.fragments,f=d.length,g=c.edge;let p=null;const v=this.fragPrevious;if(o<g){const I=n.maxFragLookUpTolerance,w=o>g-I?0:I;p=Li(v,d,Math.max(d[0].start,o),w),!p&&v&&v.start<d[0].start&&(p=d[0])}else p=d[f-1];if(p=this.filterReplacedPrimary(p,i.details),!p)return;const S=p.sn-c.startSN,b=d[S-1];if(b&&b.cc===p.cc&&this.fragmentTracker.getState(b)===it.NOT_LOADED&&(p=b),this.fragmentTracker.getState(p)===it.NOT_LOADED){const I=this.mapToInitFragWhenRequired(p);I&&this.loadFragment(I,i,o)}}}loadFragment(e,t,i){ze(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new Gv(this.tracksBuffered[this.currentTrackId]||[])}}class Gv{constructor(e){this.buffered=void 0;const t=(i,n,r)=>{if(n=n>>>0,n>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${r})`);return e[n][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const Vv={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},lh=s=>String.fromCharCode(Vv[s]||s),dt=15,Dt=100,qv={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Kv={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Hv={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Yv={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Wv=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class zv{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;Te.log(`${this.time} [${e}] ${i}`)}}}const fi=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class ch{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const n=t[i];e.hasOwnProperty(n)&&(this[n]=e[n])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Jv{constructor(){this.uchar=" ",this.penState=new ch}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class Qv{constructor(e){this.chars=[],this.pos=0,this.currPenState=new ch,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<Dt;t++)this.chars.push(new Jv);this.logger=e}equals(e){for(let t=0;t<Dt;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<Dt;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<Dt;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Dt&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Dt)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=lh(e);if(this.pos>=Dt){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<Dt;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<Dt;i++){const n=this.chars[i].uchar;n!==" "&&(t=!1),e.push(n)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Ta{constructor(e){this.rows=[],this.currRow=dt-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<dt;t++)this.rows.push(new Qv(e));this.logger=e}reset(){for(let e=0;e<dt;e++)this.rows[e].clear();this.currRow=dt-1}equals(e){let t=!0;for(let i=0;i<dt;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<dt;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<dt;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+we(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let o=0;o<dt;o++)this.rows[o].clear();const r=this.currRow+1-this.nrRollUpRows,a=this.lastOutputScreen;if(a){const o=a.rows[r].cueStartTime,l=this.logger.time;if(o!==null&&l!==null&&o<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(a.rows[r+c])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,a=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[a].penState.foreground}const n={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+we(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",n=-1;for(let r=0;r<dt;r++){const a=this.rows[r].getTextString();a&&(n=r+1,e?t.push("Row "+n+": '"+a+"'"):t.push(a.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class uh{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Ta(i),this.nonDisplayedMemory=new Ta(i),this.lastOutputScreen=new Ta(i),this.currRollUpRow=this.displayedMemory.rows[dt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[dt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,n=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=n[i]}this.logger.log(2,"MIDROW: "+we(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class dh{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=Zv(),this.logger=void 0;const n=this.logger=new zv;this.channels=[null,new uh(e,t,n),new uh(e+1,i,n)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const n=t[i]&127,r=t[i+1]&127;let a=!1,o=null;if(n===0&&r===0)continue;this.logger.log(3,()=>"["+fi([t[i],t[i+1]])+"] -> ("+fi([n,r])+")");const l=this.cmdHistory;if(n>=16&&n<=31){if(Xv(n,r,l)){_n(null,null,l),this.logger.log(3,()=>"Repeated command ("+fi([n,r])+") is dropped");continue}_n(n,r,this.cmdHistory),a=this.parseCmd(n,r),a||(a=this.parseMidrow(n,r)),a||(a=this.parsePAC(n,r)),a||(a=this.parseBackgroundAttributes(n,r))}else _n(null,null,l);if(!a&&(o=this.parseChars(n,r),o)){const u=this.currentChannel;u&&u>0?this.channels[u].insertChars(o):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!a&&!o&&this.logger.log(2,()=>"Couldn't parse cleaned data "+fi([n,r])+" orig: "+fi([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=33&&t<=35;if(!(i||n))return!1;const r=e===20||e===21||e===23?1:2,a=this.channels[r];return e===20||e===21||e===28||e===29?t===32?a.ccRCL():t===33?a.ccBS():t===34?a.ccAOF():t===35?a.ccAON():t===36?a.ccDER():t===37?a.ccRU(2):t===38?a.ccRU(3):t===39?a.ccRU(4):t===40?a.ccFON():t===41?a.ccRDC():t===42?a.ccTR():t===43?a.ccRTD():t===44?a.ccEDM():t===45?a.ccCR():t===46?a.ccENM():t===47&&a.ccEOC():a.ccTO(t-32),this.currentChannel=r,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const n=this.channels[i];return n?(n.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+fi([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const n=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,r=(e===16||e===24)&&t>=64&&t<=95;if(!(n||r))return!1;const a=e<=23?1:2;t>=64&&t<=95?i=a===1?qv[e]:Hv[e]:i=a===1?Kv[e]:Yv[e];const o=this.channels[a];return o?(o.setPAC(this.interpretPAC(i,t)),this.currentChannel=a,!0):!1}interpretPAC(e,t){let i;const n={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,n.underline=(i&1)===1,i<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(n.italics=!0,n.color="white"):n.indent=Math.floor((i-16)/2)*4,n}parseChars(e,t){let i,n=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let a;r===17?a=t+80:r===18?a=t+112:a=t+144,this.logger.log(2,()=>"Special char '"+lh(a)+"' in channel "+i),n=[a]}else e>=32&&e<=127&&(n=t===0?[e]:[e,t]);return n&&this.logger.log(3,()=>"Char codes =  "+fi(n).join(",")),n}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=45&&t<=47;if(!(i||n))return!1;let r;const a={};e===16||e===24?(r=Math.floor((t-32)/2),a.background=Wv[r],t%2===1&&(a.background=a.background+"_semi")):t===45?a.background="transparent":(a.foreground="black",t===47&&(a.underline=!0));const o=e<=23?1:2;return this.channels[o].setBkgData(a),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}_n(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function _n(s,e,t){t.a=s,t.b=e}function Xv(s,e,t){return t.a===s&&t.b===e}function Zv(){return{a:null,b:null}}var _a=function(){if(sn!=null&&sn.VTTCue)return self.VTTCue;const s=["","lr","rl"],e=["start","middle","end","left","right"];function t(o,l){if(typeof l!="string"||!Array.isArray(o))return!1;const c=l.toLowerCase();return~o.indexOf(c)?c:!1}function i(o){return t(s,o)}function n(o){return t(e,o)}function r(o,...l){let c=1;for(;c<arguments.length;c++){const u=arguments[c];for(const d in u)o[d]=u[d]}return o}function a(o,l,c){const u=this,d={enumerable:!0};u.hasBeenReset=!1;let f="",g=!1,p=o,v=l,S=c,b=null,I="",w=!0,_="auto",T="start",C=50,A="middle",k=50,D="middle";Object.defineProperty(u,"id",r({},d,{get:function(){return f},set:function(R){f=""+R}})),Object.defineProperty(u,"pauseOnExit",r({},d,{get:function(){return g},set:function(R){g=!!R}})),Object.defineProperty(u,"startTime",r({},d,{get:function(){return p},set:function(R){if(typeof R!="number")throw new TypeError("Start time must be set to a number.");p=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",r({},d,{get:function(){return v},set:function(R){if(typeof R!="number")throw new TypeError("End time must be set to a number.");v=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",r({},d,{get:function(){return S},set:function(R){S=""+R,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",r({},d,{get:function(){return b},set:function(R){b=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",r({},d,{get:function(){return I},set:function(R){const N=i(R);if(N===!1)throw new SyntaxError("An invalid or illegal string was specified.");I=N,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",r({},d,{get:function(){return w},set:function(R){w=!!R,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",r({},d,{get:function(){return _},set:function(R){if(typeof R!="number"&&R!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");_=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",r({},d,{get:function(){return T},set:function(R){const N=n(R);if(!N)throw new SyntaxError("An invalid or illegal string was specified.");T=N,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",r({},d,{get:function(){return C},set:function(R){if(R<0||R>100)throw new Error("Position must be between 0 and 100.");C=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",r({},d,{get:function(){return A},set:function(R){const N=n(R);if(!N)throw new SyntaxError("An invalid or illegal string was specified.");A=N,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",r({},d,{get:function(){return k},set:function(R){if(R<0||R>100)throw new Error("Size must be between 0 and 100.");k=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",r({},d,{get:function(){return D},set:function(R){const N=n(R);if(!N)throw new SyntaxError("An invalid or illegal string was specified.");D=N,this.hasBeenReset=!0}})),u.displayState=void 0}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a}();class ey{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function hh(s){function e(i,n,r,a){return(i|0)*3600+(n|0)*60+(r|0)+parseFloat(a||0)}const t=s.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class ty{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let n=0;n<i.length;++n)if(t===i[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function fh(s,e,t,i){const n=i?s.split(i):[s];for(const r in n){if(typeof n[r]!="string")continue;const a=n[r].split(t);if(a.length!==2)continue;const o=a[0],l=a[1];e(o,l)}}const xa=new _a(0,0,""),xn=xa.align==="middle"?"middle":"center";function iy(s,e,t){const i=s;function n(){const o=hh(s);if(o===null)throw new Error("Malformed timestamp: "+i);return s=s.replace(/^[^\sa-zA-Z-]+/,""),o}function r(o,l){const c=new ty;fh(o,function(f,g){let p;switch(f){case"region":for(let v=t.length-1;v>=0;v--)if(t[v].id===g){c.set(f,t[v].region);break}break;case"vertical":c.alt(f,g,["rl","lr"]);break;case"line":p=g.split(","),c.integer(f,p[0]),c.percent(f,p[0])&&c.set("snapToLines",!1),c.alt(f,p[0],["auto"]),p.length===2&&c.alt("lineAlign",p[1],["start",xn,"end"]);break;case"position":p=g.split(","),c.percent(f,p[0]),p.length===2&&c.alt("positionAlign",p[1],["start",xn,"end","line-left","line-right","auto"]);break;case"size":c.percent(f,g);break;case"align":c.alt(f,g,["start",xn,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let u=c.get("line","auto");u==="auto"&&xa.line===-1&&(u=-1),l.line=u,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",!0),l.size=c.get("size",100),l.align=c.get("align",xn);let d=c.get("position","auto");d==="auto"&&xa.position===50&&(d=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=d}function a(){s=s.replace(/^\s+/,"")}if(a(),e.startTime=n(),a(),s.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);s=s.slice(3),a(),e.endTime=n(),a(),r(s,e)}function ph(s){return s.replace(/<br(?: \/)?>/gi,`
`)}class sy{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new ey,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,a=0;for(r=ph(r);a<r.length&&r[a]!=="\r"&&r[a]!==`
`;)++a;const o=r.slice(0,a);return r[a]==="\r"&&++a,r[a]===`
`&&++a,t.buffer=r.slice(a),o}function n(r){fh(r,function(a,o){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const o=r.match(/^()?WEBVTT([ \t].*)?$/);if(!(o!=null&&o[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let a=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(a?a=!1:r=i(),t.state){case"HEADER":/:/.test(r)?n(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new _a(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{iy(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const o=r.indexOf("-->")!==-1;if(!r||o&&(a=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const ny=/\r\n|\n\r|\n|\r/g,Aa=function(e,t,i=0){return e.slice(i,i+t.length)===t},ry=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!J(t)||!J(i)||!J(n)||!J(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*n,t+=60*60*1e3*r,t};function Ia(s,e,t){return ls(s.toString())+ls(e.toString())+ls(t)}const ay=function(e,t,i){let n=e[t],r=e[n.prevCC];if(!r||!r.new&&n.new){e.ccOffset=e.presentationOffset=n.start,n.new=!1;return}for(;(a=r)!=null&&a.new;){var a;e.ccOffset+=n.start-r.start,n.new=!1,n=r,r=e[n.prevCC]}e.presentationOffset=i};function oy(s,e,t,i,n,r,a){const o=new sy,l=We(new Uint8Array(s)).trim().replace(ny,`
`).split(`
`),c=[],u=e?w0(e.baseTime,e.timescale):0;let d="00:00.000",f=0,g=0,p,v=!0;o.oncue=function(S){const b=t[i];let I=t.ccOffset;const w=(f-u)/9e4;if(b!=null&&b.new&&(g!==void 0?I=t.ccOffset=b.start:ay(t,i,w)),w){if(!e){p=new Error("Missing initPTS for VTT MPEGTS");return}I=w-t.presentationOffset}const _=S.endTime-S.startTime,T=st((S.startTime+I-g)*9e4,n*9e4)/9e4;S.startTime=Math.max(T,0),S.endTime=Math.max(T+_,0);const C=S.text.trim();S.text=decodeURIComponent(encodeURIComponent(C)),S.id||(S.id=Ia(S.startTime,S.endTime,C)),S.endTime>0&&c.push(S)},o.onparsingerror=function(S){p=S},o.onflush=function(){if(p){a(p);return}r(c)},l.forEach(S=>{if(v)if(Aa(S,"X-TIMESTAMP-MAP=")){v=!1,S.slice(16).split(",").forEach(b=>{Aa(b,"LOCAL:")?d=b.slice(6):Aa(b,"MPEGTS:")&&(f=parseInt(b.slice(7)))});try{g=ry(d)/1e3}catch(b){p=b}return}else S===""&&(v=!1);o.parse(S+`
`)}),o.flush()}const wa="stpp.ttml.im1t",gh=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,mh=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,ly={left:"start",center:"center",right:"end",start:"start",end:"end"};function vh(s,e,t,i){const n=ne(new Uint8Array(s),["mdat"]);if(n.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=n.map(o=>We(o)),a=I0(e.baseTime,1,e.timescale);try{r.forEach(o=>t(cy(o,a)))}catch(o){i(o)}}function cy(s,e){const n=new DOMParser().parseFromString(s,"text/xml").getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},a=Object.keys(r).reduce((d,f)=>(d[f]=n.getAttribute(`ttp:${f}`)||r[f],d),{}),o=n.getAttribute("xml:space")!=="preserve",l=yh(La(n,"styling","style")),c=yh(La(n,"layout","region")),u=La(n,"body","[begin]");return[].map.call(u,d=>{const f=Sh(d,o);if(!f||!d.hasAttribute("begin"))return null;const g=Ca(d.getAttribute("begin"),a),p=Ca(d.getAttribute("dur"),a);let v=Ca(d.getAttribute("end"),a);if(g===null)throw Eh(d);if(v===null){if(p===null)throw Eh(d);v=g+p}const S=new _a(g-e,v-e,f);S.id=Ia(S.startTime,S.endTime,S.text);const b=c[d.getAttribute("region")],I=l[d.getAttribute("style")],w=uy(b,I,l),{textAlign:_}=w;if(_){const T=ly[_];T&&(S.lineAlign=T),S.align=_}return Ae(S,w),S}).filter(d=>d!==null)}function La(s,e,t){const i=s.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function yh(s){return s.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function Sh(s,e){return[].slice.call(s.childNodes).reduce((t,i,n)=>{var r;return i.nodeName==="br"&&n?t+`
`:(r=i.childNodes)!=null&&r.length?Sh(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function uy(s,e,t){const i="http://www.w3.org/ns/ttml#styling";let n=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=s!=null&&s.hasAttribute("style")?s.getAttribute("style"):null;return a&&t.hasOwnProperty(a)&&(n=t[a]),r.reduce((o,l)=>{const c=ka(e,i,l)||ka(s,i,l)||ka(n,i,l);return c&&(o[l]=c),o},{})}function ka(s,e,t){return s&&s.hasAttributeNS(e,t)?s.getAttributeNS(e,t):null}function Eh(s){return new Error(`Could not parse ttml timestamp ${s}`)}function Ca(s,e){if(!s)return null;let t=hh(s);return t===null&&(gh.test(s)?t=dy(s,e):mh.test(s)&&(t=hy(s,e))),t}function dy(s,e){const t=gh.exec(s),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function hy(s,e){const t=mh.exec(s),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class An{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class fy{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=_h(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(E.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(E.FRAG_LOADING,this.onFragLoading,this),e.on(E.FRAG_LOADED,this.onFragLoaded,this),e.on(E.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(E.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(E.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(E.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(E.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(E.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(E.FRAG_LOADING,this.onFragLoading,this),e.off(E.FRAG_LOADED,this.onFragLoaded,this),e.off(E.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(E.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(E.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(E.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(E.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new An(this,"textTrack1"),t=new An(this,"textTrack2"),i=new An(this,"textTrack3"),n=new An(this,"textTrack4");this.cea608Parser1=new dh(1,e,t),this.cea608Parser2=new dh(3,i,n)}addCues(e,t,i,n,r){let a=!1;for(let o=r.length;o--;){const l=r[o],c=py(l[0],l[1],t,i);if(c>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),a=!0,c/(i-t)>.5))return}if(a||r.push([t,i]),this.config.renderTextTracksNatively){const o=this.captionsTracks[e];this.Cues.newCue(o,t,i,n)}else{const o=this.Cues.newCue(null,t,i,n);this.hls.trigger(E.CUES_PARSED,{type:"captions",cues:o,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:r}){const{unparsedVttFrags:a}=this;i===oe.MAIN&&(this.initPTS[t.cc]={baseTime:n,timescale:r}),a.length&&(this.unparsedVttFrags=[],a.forEach(o=>{this.onFragLoaded(E.FRAG_LOADED,o)}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let n=0;n<i.textTracks.length;n++){const r=i.textTracks[n];if(Th(r,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:n}=this,{label:r,languageCode:a}=t[e],o=this.getExistingTrack(r,a);if(o)i[e]=o,os(i[e]),Cv(i[e],n);else{const l=this.createTextTrack("captions",r,a);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,n={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(E.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,i){const n=this.media;if(n)return n.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:n}=this;Object.keys(n).forEach(r=>{os(n[r]),delete n[r]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=_h(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)os(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],n=i.some(r=>r.textCodec===wa);if(this.config.enableWebVTT||n&&this.config.enableIMSC1){if(Gd(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const a=this.media,o=a?bn(a.textTracks):null;if(this.tracks.forEach((l,c)=>{let u;if(o){let d=null;for(let f=0;f<o.length;f++)if(o[f]&&Th(o[f],l)){d=o[f],o[f]=null;break}d&&(u=d)}if(u)os(u);else{const d=bh(l);u=this.createTextTrack(d,l.name,l.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),o!=null&&o.length){const l=o.filter(c=>c!==null).map(c=>c.label);l.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const a=this.tracks.map(o=>({label:o.name,kind:o.type.toLowerCase(),default:o.default,subtitleTrack:o}));this.hls.trigger(E.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const n=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!n)return;const r=`textTrack${n[1]}`,a=this.captionsProperties[r];a&&(a.label=i.name,i.lang&&(a.languageCode=i.lang),a.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===oe.MAIN){var i,n;const{cea608Parser1:r,cea608Parser2:a,lastSn:o}=this,{cc:l,sn:c}=t.frag,u=(i=(n=t.part)==null?void 0:n.index)!=null?i:-1;r&&a&&(c!==o+1||c===o&&u!==this.lastPartIndex+1||l!==this.lastCc)&&(r.reset(),a.reset()),this.lastCc=l,this.lastSn=c,this.lastPartIndex=u}}onFragLoaded(e,t){const{frag:i,payload:n}=t;if(i.type===oe.SUBTITLE)if(n.byteLength){const r=i.decryptdata,a="stats"in t;if(r==null||!r.encrypted||a){const o=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),o&&o.textCodec===wa?this._parseIMSC1(i,n):this._parseVTTs(t)}}else this.hls.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;vh(t,this.initPTS[e.cc],n=>{this._appendCues(n,e.level),i.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},n=>{i.logger.log(`Failed to parse IMSC1: ${n}`),i.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:n})})}_parseVTTs(e){var t;const{frag:i,payload:n}=e,{initPTS:r,unparsedVttFrags:a}=this,o=r.length-1;if(!r[i.cc]&&o===-1){a.push(e);return}const l=this.hls,c=(t=i.initSegment)!=null&&t.data?tt(i.initSegment.data,new Uint8Array(n)).buffer:n;oy(c,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),l.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const d=u.message==="Missing initPTS for VTT MPEGTS";d?a.push(e):this._fallbackToIMSC1(i,n),l.logger.log(`Failed to parse VTT cue: ${u}`),!(d&&o>i.cc)&&l.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||vh(t,this.initPTS[e.cc],()=>{i.textCodec=wa,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||n.mode==="disabled")return;e.forEach(r=>ih(n,r))}else{const n=this.tracks[t];if(!n)return;const r=n.default?"default":"subtitles"+t;i.trigger(E.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===oe.SUBTITLE&&this.onFragLoaded(E.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:n}=t;if(!(i.type===oe.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let r=0;r<n.length;r++){const a=n[r].bytes;if(a){this.cea608Parser1||this.initCea608Parsers();const o=this.extractCea608Data(a);this.cea608Parser1.addData(n[r].pts,o[0]),this.cea608Parser2.addData(n[r].pts,o[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:n,type:r}){const{media:a}=this;if(!(!a||a.currentTime<i)){if(!r||r==="video"){const{captionsTracks:o}=this;Object.keys(o).forEach(l=>sh(o[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&n!==void 0){const{textTracks:o}=this;Object.keys(o).forEach(l=>sh(o[l],t,n))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let n=2;for(let r=0;r<i;r++){const a=e[n++],o=127&e[n++],l=127&e[n++];if(o===0&&l===0)continue;if((4&a)!==0){const u=3&a;(u===0||u===1)&&(t[u].push(o),t[u].push(l))}}return t}}function bh(s){return s.characteristics&&/transcribes-spoken-dialog/gi.test(s.characteristics)&&/describes-music-and-sound/gi.test(s.characteristics)?"captions":"subtitles"}function Th(s,e){return!!s&&s.kind===bh(e)&&pa(e,s)}function py(s,e,t,i){return Math.min(e,i)-Math.max(s,t)}function _h(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const gy=/\s/,my={newCue(s,e,t,i){const n=[];let r,a,o,l,c;const u=self.VTTCue||self.TextTrackCue;for(let f=0;f<i.rows.length;f++)if(r=i.rows[f],o=!0,l=0,c="",!r.isEmpty()){var d;for(let v=0;v<r.chars.length;v++)gy.test(r.chars[v].uchar)&&o?l++:(c+=r.chars[v].uchar,o=!1);r.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const g=ph(c.trim()),p=Ia(e,t,g);s!=null&&(d=s.cues)!=null&&d.getCueById(p)||(a=new u(e,t,g),a.id=p,a.line=f+1,a.align="left",a.position=10+Math.min(80,Math.floor(l*8/32)*10),n.push(a))}return s&&n.length&&(n.sort((f,g)=>f.line==="auto"||g.line==="auto"?0:f.line>8&&g.line>8?g.line-f.line:f.line-g.line),n.forEach(f=>ih(s,f))),n}},vy=/^age:\s*[\d.]+\s*$/im;class yy{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new mg,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,n=this.stats;n.loading.first=0,n.loaded=0,n.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return r(i,t.url)}).catch(a=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),r(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(a=>{var o;(o=this.callbacks)==null||o.onError({code:i.status,text:a.message},t,i,n)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const n=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:a}=i.loadPolicy;if(n)for(const o in n)e.setRequestHeader(o,n[o]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&J(r)?r:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const n=t.readyState,r=this.config;if(!i.aborted&&n>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),n===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const c=t.status,u=t.responseType==="text"?t.responseText:null;if(c>=200&&c<300){const p=u??t.response;if(p!=null){var a,o;i.loading.end=Math.max(self.performance.now(),i.loading.first);const v=t.responseType==="arraybuffer"?p.byteLength:p.length;i.loaded=i.total=v,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);const S=(a=this.callbacks)==null?void 0:a.onProgress;S&&S(i,e,p,t);const b={url:t.responseURL,data:p,code:c};(o=this.callbacks)==null||o.onSuccess(b,i,e,t);return}}const d=r.loadPolicy.errorRetry,f=i.retry,g={url:e.url,data:void 0,code:c};if(en(d,f,!1,g))this.retry(d);else{var l;Te.error(`${c} while loading ${e.url}`),(l=this.callbacks)==null||l.onError({code:c,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(en(e,t,!0))this.retry(e);else{var i;Te.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const n=this.callbacks;n&&(this.abortInternal(),n.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=Hr(e,i.retry),i.retry++,Te.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t==null?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&vy.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const Sy={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null};_e(_e({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:yy,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Xg,bufferController:V0,capLevelController:ma,errorController:sm,fpsController:kv,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:id,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:Sy},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},Ey()),{},{subtitleStreamController:jv,subtitleTrackController:Dv,timelineController:fy,audioStreamController:B0,audioTrackController:$0,emeController:Mi,cmcdController:Iv,contentSteeringController:Lv,interstitialsController:$v});function Ey(){return{cueHandler:my,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function by(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}(()=>{const s=by();try{s&&new s(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})(),window.initVapiWidget=function(s="vapi-widget",e=[]){const t="d3291bfe-9e60-4a16-9752-64438bbeb4b9",i=new Map(e.map(A=>[A.language,A.assistantId])),n=`
    .vapi-container {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      position: relative;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .vapi-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 50px;
      padding: clamp(8px, 2vw, 16px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      gap: clamp(8px, 2vw, 16px);
      width: 100%;
      max-width: 400px;
      min-width: 280px;
      height: auto;
      min-height: 60px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    @media (min-width: 480px) {
      .vapi-box {
        flex-direction: row;
        height: auto;
        min-height: 60px;
        padding: clamp(10px, 2.5vw, 20px);
      }
    }

    @media (min-width: 768px) {
      .vapi-box {
        max-width: 450px;
        padding: 14px 20px;
      }
    }

    .vapi-ring {
      width: clamp(30px, 8vw, 45px);
      height: clamp(30px, 8vw, 45px);
      border-radius: 50%;
      overflow: hidden;
      position: relative;
      flex-shrink: 0;
      animation: glowShadows 1s ease-in-out infinite alternate;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .vapi-ring.pulse-green {
      border-color: #22c55e;
      animation: pulse 1s infinite;
    }

    .vapi-ring.pulse-blue {
      border-color: #3b82f6;
      animation: pulse 1s infinite;
    }

    .vapi-ring.spin-yellow {
      border-color: #facc15;
      animation: spin 1s linear infinite;
    }

    .vapi-ring.gray {
      border-color: #d1d5db;
    }

    .vapi-status {
      font-size: clamp(10px, 2.5vw, 14px);
      color: #6b7280;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .vapi-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: clamp(110px, 25vw, 140px);
      padding: clamp(6px, 1.5vw, 10px) clamp(8px, 2vw, 12px);
      border-radius: 50px;
      font-size: clamp(12px, 3vw, 16px);
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      gap: clamp(4px, 1vw, 8px);
      flex-shrink: 0;
      white-space: nowrap;
    }

    .vapi-button svg {
      width: clamp(14px, 3.5vw, 18px);
      height: clamp(14px, 3.5vw, 18px);
      flex-shrink: 0;
    }

    .vapi-button.vapi-start {
      background-color: #000000;
      color: white;
    }

    .vapi-button.vapi-start:hover {
      background-color: #1f1f1f;
    }

    .vapi-button.vapi-end {
      background-color: #dc2626;
      color: white;
    }

    .vapi-button.vapi-end:hover {
      background-color: #b91c1c;
    }

    .vapi-lang-toggle {
      display: flex;
      align-items: center;
      border: 2px solid rgb(35, 104, 3);
      border-radius: 50px;
      background-color: white;
      padding: clamp(4px, 1vw, 8px);
      gap: clamp(2px, 0.5vw, 6px);
      cursor: pointer;
      width: clamp(80px, 18vw, 100px);
      height: clamp(28px, 7vw, 36px);
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .vapi-lang-toggle:hover {
      border-color: rgb(22, 78, 2);
      background-color: #f9f9f9;
    }

    .vapi-flag-circle {
      width: clamp(14px, 3.5vw, 18px);
      height: clamp(14px, 3.5vw, 18px);
      border: 1px solid rgb(35, 104, 3);
      border-radius: 50%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .vapi-flags {
      width: 150%;
      height: 150%;
      display: block;
    }

    .vapi-dropdown-icon {
      font-size: clamp(14px, 3.5vw, 18px);
      color: black;
      flex-shrink: 0;
    }

    .vapi-dropdown {
      position: absolute;
      margin-top: 8px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      z-index: 1000;
      width: clamp(120px, 30vw, 150px);
      max-height: 200px;
      overflow-y: auto;
    }

    .vapi-dropdown-up {
      bottom: 100%;
      top: auto;
      margin-bottom: 8px;
    }

    .vapi-dropdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: clamp(6px, 1.5vw, 10px) clamp(8px, 2vw, 12px);
      font-size: clamp(12px, 3vw, 14px);
      cursor: pointer;
      transition: background-color 0.1s ease;
    }

    .vapi-dropdown-item:hover {
      background-color: #f3f4f6;
    }

    .vapi-lang-label {
      color: black;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .vapi-flag {
      width: clamp(16px, 4vw, 20px);
      height: clamp(12px, 3vw, 14px);
      border-radius: 2px;
      flex-shrink: 0;
    }

    .vapi-orb {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      overflow: hidden;
    }

    .orb-core-gif {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
    }

    .orb-core-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      pointer-events: none;
    }

    .orb {
      --radius: 38%;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      background: linear-gradient(
        135deg,
        rgba(3, 255, 247, 0.992),
        rgba(35, 104, 3, 0.497),
        rgb(160, 190, 250)
      );
      background-size: 300% 300%;
      animation: colorCycle 12s ease-in-out infinite, glowShadow 1s ease-in-out infinite alternate;
      filter: saturate(1.2);
    }

    @keyframes glowShadows {
      0% {
        box-shadow: 0 0 clamp(6px, 1.5vw, 10px) 1px rgba(198, 218, 209, 0.5);
      }
      50% {
        box-shadow: 0 0 clamp(8px, 2vw, 14px) 2px rgba(198, 218, 209, 0.9);
      }
      100% {
        box-shadow: 0 0 clamp(6px, 1.5vw, 10px) 1px rgba(198, 218, 209, 0.7);
      }
    }

    @keyframes glowShadow {
      0% {
        box-shadow: inset 0 0 clamp(12px, 3vw, 18px) rgba(198, 218, 209, 0.7), 
                    0 clamp(3px, 0.75vw, 6px) clamp(8px, 2vw, 12px) rgba(198, 218, 209, 0.5);
      }
      50% {
        box-shadow: inset 0 0 clamp(16px, 4vw, 22px) rgba(198, 218, 209, 1), 
                    0 clamp(4px, 1vw, 7px) clamp(10px, 2.5vw, 14px) rgba(198, 218, 209, 0.9);
      }
      100% {
        box-shadow: inset 0 0 clamp(12px, 3vw, 18px) rgba(198, 218, 209, 0.944), 
                    0 clamp(3px, 0.75vw, 6px) clamp(8px, 2vw, 12px) rgba(198, 218, 209, 0.723);
      }
    }

    .orb::before,
    .orb::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 25%;
      left: 0;
      pointer-events: none;
      z-index: 2;
      filter: blur(clamp(3px, 1vw, 6px));
    }

    .orb::before {
      top: 0;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.45), transparent);
      border-top-left-radius: 50% 40%;
      border-top-right-radius: 50% 40%;
    }

    .orb::after {
      bottom: 0;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.35), transparent);
      border-bottom-left-radius: 50% 40%;
      border-bottom-right-radius: 50% 40%;
    }

    .waves-wrapper {
      position: absolute;
      inset: 0;
      filter: url('#filter');
    }

    .wave {
      position: absolute;
      width: var(--radius);
      height: var(--radius);
      top: calc(50% - var(--radius) / 2);
      left: calc(50% - var(--radius) / 2);
      border-radius: 50%;
      background: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.3),
        rgba(11, 51, 53, 0.9),
        rgba(66, 245, 84, 0.8)
      );
      filter: blur(clamp(2px, 1vw, 4px));
      mix-blend-mode: screen;
    }

    .wave:nth-child(1) {
      transform: translate(calc(-1.1 * var(--radius)));
      animation: x-axis-lateral 2s infinite alternate ease-in-out;
      background: rgba(180, 160, 240, 0.8);
    }

    .wave:nth-child(1)::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(180, 160, 240, 0.5);
      filter: blur(clamp(2px, 0.75vw, 3px));
      animation: y-axis-lateral 1s infinite 0.1s alternate ease-in-out;
    }

    .wave:nth-child(2) {
      animation: x-axis 2s infinite alternate ease-in-out;
      background: rgba(35, 104, 3, 0.8);
    }

    .wave:nth-child(2)::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(230, 160, 210, 0.5);
      filter: blur(clamp(2px, 0.75vw, 3px));
      animation: y-axis 1s infinite 0.5s alternate ease-in-out;
    }

    .wave:nth-child(3) {
      transform: translate(calc(1.1 * var(--radius)), calc(1.3 * var(--radius)));
      animation: x-axis-lateral 2s infinite alternate ease;
      background: rgba(160, 190, 250, 0.7);
    }

    .wave:nth-child(3)::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(160, 190, 250, 0.4);
      filter: blur(clamp(2px, 0.75vw, 3px));
      animation: y-axis-lateral 1s infinite 0.4s alternate ease-in-out;
    }

    @keyframes x-axis {
      0% { transform: translate(calc(-1.6 * var(--radius))); }
      100% { transform: translate(calc(1.6 * var(--radius))); }
    }

    @keyframes y-axis {
      0% { transform: translateY(calc(0.7 * var(--radius))); background:rgb(11, 51, 53); }
      100% { transform: translateY(calc(-1.1 * var(--radius))) scale(0.8); background:rgb(11, 51, 53); }
    }

    @keyframes x-axis-lateral {
      0% { transform: translate(calc(-0.6 * var(--radius))); }
      100% { transform: translate(calc(0.6 * var(--radius))); }
    }

    @keyframes y-axis-lateral {
      0% { transform: translateY(calc(var(--radius) / 5)); background:rgb(11, 51, 53); }
      100% { transform: translateY(calc(-1 * var(--radius))); background:rgb(11, 51, 53); }
    }

    @keyframes colorCycle {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .vapi-status-wrapper {
      position: relative;
      display: inline-block;
      flex: 1;
      min-width: 0;
    }

    .vapi-status-text {
      position: absolute;
      top: clamp(-18px, -4vw, -14px);
      left: 50%;
      transform: translateX(-50%);
      min-height: 12px;
      font-size: clamp(10px, 2.5vw, 12px);
      color: #555;
      width: clamp(120px, 30vw, 180px);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Prevent layout shift during embedding */
    .vapi-container * {
      box-sizing: border-box;
    }

    /* Container queries for better responsiveness */
    @container (max-width: 300px) {
      .vapi-box {
        flex-direction: column;
        gap: 8px;
        padding: 8px;
      }
      
      .vapi-button {
        width: 100px;
        font-size: 11px;
      }
      
      .vapi-lang-toggle {
        width: 70px;
        height: 26px;
      }
    }
  `,r=document.createElement("style");r.innerHTML=n,document.head.appendChild(r);const a=document.getElementById(s);if(!a){console.warn("Vapi widget container not found:",s);return}let o=!1,l=!1,c=!1,u=!1,d="",f=null,g="en-US",p=!1;const v=[{code:"en-US",flag:"https://flagcdn.com/us.svg",label:"English"},{code:"es-ES",flag:"https://flagcdn.com/es.svg",label:"Espaol"},{code:"fr-FR",flag:"https://flagcdn.com/fr.svg",label:"Franais"},{code:"de-DE",flag:"https://flagcdn.com/de.svg",label:"Deutsch"},{code:"it-IT",flag:"https://flagcdn.com/it.svg",label:"Italiano"},{code:"pt-PT",flag:"https://flagcdn.com/pt.svg",label:"Portugus"},{code:"zh-CN",flag:"https://flagcdn.com/cn.svg",label:""},{code:"ja-JP",flag:"https://flagcdn.com/jp.svg",label:""},{code:"ko-KR",flag:"https://flagcdn.com/kr.svg",label:""},{code:"ar-SA",flag:"https://flagcdn.com/sa.svg",label:""},{code:"ru-RU",flag:"https://flagcdn.com/ru.svg",label:""}],S=v.filter(A=>i.has(A.code)),b=document.createElement("div");b.className="vapi-container";function I(){let A="gray";c?A="pulse-green":u?A="pulse-blue":l&&(A="spin-yellow"),b.innerHTML=`
            <svg style="display:none">
                <defs>
                    <filter id="filter">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
                        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 28 -10" result="filter" />
                        <feComposite in="SourceGraphic" in2="filter" operator="atop" />
                    </filter>
                </defs>
            </svg>
            <div class="vapi-box">
                <div class="vapi-ring ${A}">
                    <div class="orb">
                        <div class="waves-wrapper">
                            <div class="wave"></div>
                            <div class="wave"></div>
                            <div class="wave"></div>
                        </div>
                    </div>
                </div>

                <div class="vapi-status-wrapper">
                    <div class="vapi-status-text">
                        ${d}
                    </div>

                    <button id="vapi-button" class="vapi-button ${o?"vapi-end":"vapi-start"}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" style="fill: white;" viewBox="0 0 16 16">
                            <path d="M3.654 1.328a.678.678 0 0 1 .58-.328h1.716c.236 0 .45.133.558.34l1.296 2.59a.678.678 0 0 1-.141.791L6.163 6.883a11.72 11.72 0 0 0 4.025 4.025l1.162-1.204a.678.678 0 0 1 .792-.14l2.59 1.296a.678.678 0 0 1 .34.558v1.716a.678.678 0 0 1-.328.58c-.758.478-1.66.724-2.568.724-5.418 0-9.817-4.4-9.817-9.818 0-.908.246-1.81.724-2.568z"/>
                        </svg>
                        ${o?"End":"Voice Call"}
                    </button>
                </div>

                <div style="position: relative;">
                    <div class="vapi-lang-toggle" id="vapi-lang-toggle">
                        <div class="vapi-flag-circle">
                            <img class="vapi-flags" src="${v.find(k=>k.code===g).flag}" alt="Flag" />
                        </div>
                        <svg class="vapi-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="darkgreen" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
                        </svg>
                    </div>

                    ${p?`<div class="vapi-dropdown vapi-dropdown-up">
                            ${S.map(k=>`
                                <div class="vapi-dropdown-item" data-lang="${k.code}">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="${k.flag}" class="vapi-flag" alt="${k.code}" />
                                        <span class="vapi-lang-label">${k.label}</span>
                                    </div>
                                    ${k.code===g?"":""}
                                </div>
                            `).join("")}
                        </div>`:""}
                </div>
            </div>
        `,a.innerHTML="",a.appendChild(b),document.getElementById("vapi-button").onclick=o?T:_,document.getElementById("vapi-lang-toggle").onclick=()=>{p=!p,I()},document.querySelectorAll(".vapi-dropdown-item").forEach(k=>{k.onclick=()=>{g=k.getAttribute("data-lang"),p=!1,I()}})}function w(A){d=A,I()}function _(){if(!f)return;l=!0,w("Connecting...");const A=i.get(g);if(!A){w("Assistant ID not found for language: "+g);return}f.start(A)}function T(){f&&(f.stop(),o=!1,c=!1,u=!1,w(""))}function C(){f=new ng(t),f.on("call-start",()=>{o=!0,l=!1,w("Connected")}),f.on("call-end",()=>{o=!1,w("")}),f.on("speech-start",()=>{c=!0,u=!1,w("Talk to interrupt")}),f.on("speech-end",()=>{c=!1,w("Listening...")}),f.on("transcript",A=>{A.isFinal?u=!1:(u=!0,c=!1,w("Listening..."))}),I()}C()}})();
