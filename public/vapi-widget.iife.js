var Yy=Object.defineProperty;var Wy=(Wt,Tt,tt)=>Tt in Wt?Yy(Wt,Tt,{enumerable:!0,configurable:!0,writable:!0,value:tt}):Wt[Tt]=tt;var oe=(Wt,Tt,tt)=>Wy(Wt,typeof Tt!="symbol"?Tt+"":Tt,tt);(function(){"use strict";function Wt(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function Tt(s){if(Object.prototype.hasOwnProperty.call(s,"__esModule"))return s;var e=s.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(s).forEach(function(i){var n=Object.getOwnPropertyDescriptor(s,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return s[i]}})}),t}var tt={};function Sa(s,e){if(s==null)return{};var t,i,n=function(a,o){if(a==null)return{};var l,c,u={},d=Object.keys(a);for(c=0;c<d.length;c++)l=d[c],o.indexOf(l)>=0||(u[l]=a[l]);return u}(s,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(s);for(i=0;i<r.length;i++)t=r[i],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(s,t)&&(n[t]=s[t])}return n}function it(s,e){if(!(s instanceof e))throw new TypeError("Cannot call a class as a function")}function me(s){return me=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},me(s)}function Ea(s){var e=function(t,i){if(me(t)!=="object"||t===null)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var r=n.call(t,i);if(me(r)!=="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(t)}(s,"string");return me(e)==="symbol"?e:String(e)}function Ta(s,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(s,Ea(i.key),i)}}function st(s,e,t){return e&&Ta(s.prototype,e),t&&Ta(s,t),Object.defineProperty(s,"prototype",{writable:!1}),s}function bt(s){if(s===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return s}function Ci(s,e){return Ci=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},Ci(s,e)}function ss(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,writable:!0,configurable:!0}}),Object.defineProperty(s,"prototype",{writable:!1}),e&&Ci(s,e)}function ns(s,e){if(e&&(me(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return bt(s)}function nt(s){return nt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},nt(s)}function _t(s,e,t){return(e=Ea(e))in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}function ba(s,e,t,i,n,r,a){try{var o=s[r](a),l=o.value}catch(c){return void t(c)}o.done?e(l):Promise.resolve(l).then(i,n)}function X(s){return function(){var e=this,t=arguments;return new Promise(function(i,n){var r=s.apply(e,t);function a(l){ba(r,i,n,a,o,"next",l)}function o(l){ba(r,i,n,a,o,"throw",l)}a(void 0)})}}function _a(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=s[t];return i}function dt(s,e){return function(t){if(Array.isArray(t))return t}(s)||function(t,i){var n=t==null?null:typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(n!=null){var r,a,o,l,c=[],u=!0,d=!1;try{if(o=(n=n.call(t)).next,i===0){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=o.call(n)).done)&&(c.push(r.value),c.length!==i);u=!0);}catch(f){d=!0,a=f}finally{try{if(!u&&n.return!=null&&(l=n.return(),Object(l)!==l))return}finally{if(d)throw a}}return c}}(s,e)||function(t,i){if(t){if(typeof t=="string")return _a(t,i);var n=Object.prototype.toString.call(t).slice(8,-1);return n==="Object"&&t.constructor&&(n=t.constructor.name),n==="Map"||n==="Set"?Array.from(t):n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_a(t,i):void 0}}(s,e)||function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}var xa,xt={},eh={get exports(){return xt},set exports(s){xt=s}},di=typeof Reflect=="object"?Reflect:null,Aa=di&&typeof di.apply=="function"?di.apply:function(s,e,t){return Function.prototype.apply.call(s,e,t)};xa=di&&typeof di.ownKeys=="function"?di.ownKeys:Object.getOwnPropertySymbols?function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:function(s){return Object.getOwnPropertyNames(s)};var Ia=Number.isNaN||function(s){return s!=s};function ve(){ve.init.call(this)}eh.exports=ve,xt.once=function(s,e){return new Promise(function(t,i){function n(a){s.removeListener(e,r),i(a)}function r(){typeof s.removeListener=="function"&&s.removeListener("error",n),t([].slice.call(arguments))}Oa(s,e,r,{once:!0}),e!=="error"&&function(a,o,l){typeof a.on=="function"&&Oa(a,"error",o,l)}(s,n,{once:!0})})},ve.EventEmitter=ve,ve.prototype._events=void 0,ve.prototype._eventsCount=0,ve.prototype._maxListeners=void 0;var wa=10;function rs(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}function La(s){return s._maxListeners===void 0?ve.defaultMaxListeners:s._maxListeners}function ka(s,e,t,i){var n,r,a,o;if(rs(t),(r=s._events)===void 0?(r=s._events=Object.create(null),s._eventsCount=0):(r.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),r=s._events),a=r[e]),a===void 0)a=r[e]=t,++s._eventsCount;else if(typeof a=="function"?a=r[e]=i?[t,a]:[a,t]:i?a.unshift(t):a.push(t),(n=La(s))>0&&a.length>n&&!a.warned){a.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=s,l.type=e,l.count=a.length,o=l,console&&console.warn&&console.warn(o)}return s}function th(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ca(s,e,t){var i={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},n=th.bind(i);return n.listener=t,i.wrapFn=n,n}function Ra(s,e,t){var i=s._events;if(i===void 0)return[];var n=i[e];return n===void 0?[]:typeof n=="function"?t?[n.listener||n]:[n]:t?function(r){for(var a=new Array(r.length),o=0;o<a.length;++o)a[o]=r[o].listener||r[o];return a}(n):Da(n,n.length)}function Pa(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}function Da(s,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=s[i];return t}function Oa(s,e,t,i){if(typeof s.on=="function")i.once?s.once(e,t):s.on(e,t);else{if(typeof s.addEventListener!="function")throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s);s.addEventListener(e,function n(r){i.once&&s.removeEventListener(e,n),t(r)})}}Object.defineProperty(ve,"defaultMaxListeners",{enumerable:!0,get:function(){return wa},set:function(s){if(typeof s!="number"||s<0||Ia(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");wa=s}}),ve.init=function(){this._events!==void 0&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},ve.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||Ia(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this},ve.prototype.getMaxListeners=function(){return La(this)},ve.prototype.emit=function(s){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var i=s==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var r;if(e.length>0&&(r=e[0]),r instanceof Error)throw r;var a=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw a.context=r,a}var o=n[s];if(o===void 0)return!1;if(typeof o=="function")Aa(o,this,e);else{var l=o.length,c=Da(o,l);for(t=0;t<l;++t)Aa(c[t],this,e)}return!0},ve.prototype.addListener=function(s,e){return ka(this,s,e,!1)},ve.prototype.on=ve.prototype.addListener,ve.prototype.prependListener=function(s,e){return ka(this,s,e,!0)},ve.prototype.once=function(s,e){return rs(e),this.on(s,Ca(this,s,e)),this},ve.prototype.prependOnceListener=function(s,e){return rs(e),this.prependListener(s,Ca(this,s,e)),this},ve.prototype.removeListener=function(s,e){var t,i,n,r,a;if(rs(e),(i=this._events)===void 0)return this;if((t=i[s])===void 0)return this;if(t===e||t.listener===e)--this._eventsCount==0?this._events=Object.create(null):(delete i[s],i.removeListener&&this.emit("removeListener",s,t.listener||e));else if(typeof t!="function"){for(n=-1,r=t.length-1;r>=0;r--)if(t[r]===e||t[r].listener===e){a=t[r].listener,n=r;break}if(n<0)return this;n===0?t.shift():function(o,l){for(;l+1<o.length;l++)o[l]=o[l+1];o.pop()}(t,n),t.length===1&&(i[s]=t[0]),i.removeListener!==void 0&&this.emit("removeListener",s,a||e)}return this},ve.prototype.off=ve.prototype.removeListener,ve.prototype.removeAllListeners=function(s){var e,t,i;if((t=this._events)===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[s]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete t[s]),this;if(arguments.length===0){var n,r=Object.keys(t);for(i=0;i<r.length;++i)(n=r[i])!=="removeListener"&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(typeof(e=t[s])=="function")this.removeListener(s,e);else if(e!==void 0)for(i=e.length-1;i>=0;i--)this.removeListener(s,e[i]);return this},ve.prototype.listeners=function(s){return Ra(this,s,!0)},ve.prototype.rawListeners=function(s){return Ra(this,s,!1)},ve.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):Pa.call(s,e)},ve.prototype.listenerCount=Pa,ve.prototype.eventNames=function(){return this._eventsCount>0?xa(this._events):[]};var Ma=Object.prototype.hasOwnProperty;function Fa(s,e,t){for(t of s.keys())if($e(t,e))return t}function $e(s,e){var t,i,n;if(s===e)return!0;if(s&&e&&(t=s.constructor)===e.constructor){if(t===Date)return s.getTime()===e.getTime();if(t===RegExp)return s.toString()===e.toString();if(t===Array){if((i=s.length)===e.length)for(;i--&&$e(s[i],e[i]););return i===-1}if(t===Set){if(s.size!==e.size)return!1;for(i of s)if((n=i)&&typeof n=="object"&&!(n=Fa(e,n))||!e.has(n))return!1;return!0}if(t===Map){if(s.size!==e.size)return!1;for(i of s)if((n=i[0])&&typeof n=="object"&&!(n=Fa(e,n))||!$e(i[1],e.get(n)))return!1;return!0}if(t===ArrayBuffer)s=new Uint8Array(s),e=new Uint8Array(e);else if(t===DataView){if((i=s.byteLength)===e.byteLength)for(;i--&&s.getInt8(i)===e.getInt8(i););return i===-1}if(ArrayBuffer.isView(s)){if((i=s.byteLength)===e.byteLength)for(;i--&&s[i]===e[i];);return i===-1}if(!t||typeof s=="object"){for(t in i=0,s)if(Ma.call(s,t)&&++i&&!Ma.call(e,t)||!(t in e)||!$e(s[t],e[t]))return!1;return Object.keys(e).length===i}}return s!=s&&e!=e}const ih={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},Na={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},we={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},Ue={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},Ot={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"};class F{static getFirstMatch(e,t){const i=t.match(e);return i&&i.length>0&&i[1]||""}static getSecondMatch(e,t){const i=t.match(e);return i&&i.length>1&&i[2]||""}static matchAndReturnConst(e,t,i){if(e.test(t))return i}static getWindowsVersionName(e){switch(e){case"NT":return"NT";case"XP":case"NT 5.1":return"XP";case"NT 5.0":return"2000";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}static getMacOSVersionName(e){const t=e.split(".").splice(0,2).map(i=>parseInt(i,10)||0);if(t.push(0),t[0]===10)switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}}static getAndroidVersionName(e){const t=e.split(".").splice(0,2).map(i=>parseInt(i,10)||0);if(t.push(0),!(t[0]===1&&t[1]<5))return t[0]===1&&t[1]<6?"Cupcake":t[0]===1&&t[1]>=6?"Donut":t[0]===2&&t[1]<2?"Eclair":t[0]===2&&t[1]===2?"Froyo":t[0]===2&&t[1]>2?"Gingerbread":t[0]===3?"Honeycomb":t[0]===4&&t[1]<1?"Ice Cream Sandwich":t[0]===4&&t[1]<4?"Jelly Bean":t[0]===4&&t[1]>=4?"KitKat":t[0]===5?"Lollipop":t[0]===6?"Marshmallow":t[0]===7?"Nougat":t[0]===8?"Oreo":t[0]===9?"Pie":void 0}static getVersionPrecision(e){return e.split(".").length}static compareVersions(e,t,i=!1){const n=F.getVersionPrecision(e),r=F.getVersionPrecision(t);let a=Math.max(n,r),o=0;const l=F.map([e,t],c=>{const u=a-F.getVersionPrecision(c),d=c+new Array(u+1).join(".0");return F.map(d.split("."),f=>new Array(20-f.length).join("0")+f).reverse()});for(i&&(o=a-Math.min(n,r)),a-=1;a>=o;){if(l[0][a]>l[1][a])return 1;if(l[0][a]===l[1][a]){if(a===o)return 0;a-=1}else if(l[0][a]<l[1][a])return-1}}static map(e,t){const i=[];let n;if(Array.prototype.map)return Array.prototype.map.call(e,t);for(n=0;n<e.length;n+=1)i.push(t(e[n]));return i}static find(e,t){let i,n;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(i=0,n=e.length;i<n;i+=1){const r=e[i];if(t(r,i))return r}}static assign(e,...t){const i=e;let n,r;if(Object.assign)return Object.assign(e,...t);for(n=0,r=t.length;n<r;n+=1){const a=t[n];typeof a=="object"&&a!==null&&Object.keys(a).forEach(o=>{i[o]=a[o]})}return e}static getBrowserAlias(e){return ih[e]}static getBrowserTypeByAlias(e){return Na[e]||""}}const Ee=/version\/(\d+(\.?_?\d+)+)/i,sh=[{test:[/googlebot/i],describe(s){const e={name:"Googlebot"},t=F.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/opera/i],describe(s){const e={name:"Opera"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/opr\/|opios/i],describe(s){const e={name:"Opera"},t=F.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/SamsungBrowser/i],describe(s){const e={name:"Samsung Internet for Android"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/Whale/i],describe(s){const e={name:"NAVER Whale Browser"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/MZBrowser/i],describe(s){const e={name:"MZ Browser"},t=F.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/focus/i],describe(s){const e={name:"Focus"},t=F.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/swing/i],describe(s){const e={name:"Swing"},t=F.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/coast/i],describe(s){const e={name:"Opera Coast"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe(s){const e={name:"Opera Touch"},t=F.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/yabrowser/i],describe(s){const e={name:"Yandex Browser"},t=F.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/ucbrowser/i],describe(s){const e={name:"UC Browser"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/Maxthon|mxios/i],describe(s){const e={name:"Maxthon"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/epiphany/i],describe(s){const e={name:"Epiphany"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/puffin/i],describe(s){const e={name:"Puffin"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/sleipnir/i],describe(s){const e={name:"Sleipnir"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/k-meleon/i],describe(s){const e={name:"K-Meleon"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/micromessenger/i],describe(s){const e={name:"WeChat"},t=F.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/qqbrowser/i],describe(s){const e={name:/qqbrowserlite/i.test(s)?"QQ Browser Lite":"QQ Browser"},t=F.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/msie|trident/i],describe(s){const e={name:"Internet Explorer"},t=F.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/\sedg\//i],describe(s){const e={name:"Microsoft Edge"},t=F.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/edg([ea]|ios)/i],describe(s){const e={name:"Microsoft Edge"},t=F.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/vivaldi/i],describe(s){const e={name:"Vivaldi"},t=F.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/seamonkey/i],describe(s){const e={name:"SeaMonkey"},t=F.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/sailfish/i],describe(s){const e={name:"Sailfish"},t=F.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,s);return t&&(e.version=t),e}},{test:[/silk/i],describe(s){const e={name:"Amazon Silk"},t=F.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/phantom/i],describe(s){const e={name:"PhantomJS"},t=F.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/slimerjs/i],describe(s){const e={name:"SlimerJS"},t=F.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(s){const e={name:"BlackBerry"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/(web|hpw)[o0]s/i],describe(s){const e={name:"WebOS Browser"},t=F.getFirstMatch(Ee,s)||F.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/bada/i],describe(s){const e={name:"Bada"},t=F.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/tizen/i],describe(s){const e={name:"Tizen"},t=F.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/qupzilla/i],describe(s){const e={name:"QupZilla"},t=F.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/firefox|iceweasel|fxios/i],describe(s){const e={name:"Firefox"},t=F.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/electron/i],describe(s){const e={name:"Electron"},t=F.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/MiuiBrowser/i],describe(s){const e={name:"Miui"},t=F.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/chromium/i],describe(s){const e={name:"Chromium"},t=F.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,s)||F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/chrome|crios|crmo/i],describe(s){const e={name:"Chrome"},t=F.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/GSA/i],describe(s){const e={name:"Google Search"},t=F.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test(s){const e=!s.test(/like android/i),t=s.test(/android/i);return e&&t},describe(s){const e={name:"Android Browser"},t=F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/playstation 4/i],describe(s){const e={name:"PlayStation 4"},t=F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/safari|applewebkit/i],describe(s){const e={name:"Safari"},t=F.getFirstMatch(Ee,s);return t&&(e.version=t),e}},{test:[/.*/i],describe(s){const e=s.search("\\(")!==-1?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:F.getFirstMatch(e,s),version:F.getSecondMatch(e,s)}}}];var nh=[{test:[/Roku\/DVP/],describe(s){const e=F.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,s);return{name:Ue.Roku,version:e}}},{test:[/windows phone/i],describe(s){const e=F.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,s);return{name:Ue.WindowsPhone,version:e}}},{test:[/windows /i],describe(s){const e=F.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,s),t=F.getWindowsVersionName(e);return{name:Ue.Windows,version:e,versionName:t}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(s){const e={name:Ue.iOS},t=F.getSecondMatch(/(Version\/)(\d[\d.]+)/,s);return t&&(e.version=t),e}},{test:[/macintosh/i],describe(s){const e=F.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,s).replace(/[_\s]/g,"."),t=F.getMacOSVersionName(e),i={name:Ue.MacOS,version:e};return t&&(i.versionName=t),i}},{test:[/(ipod|iphone|ipad)/i],describe(s){const e=F.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,s).replace(/[_\s]/g,".");return{name:Ue.iOS,version:e}}},{test(s){const e=!s.test(/like android/i),t=s.test(/android/i);return e&&t},describe(s){const e=F.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,s),t=F.getAndroidVersionName(e),i={name:Ue.Android,version:e};return t&&(i.versionName=t),i}},{test:[/(web|hpw)[o0]s/i],describe(s){const e=F.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,s),t={name:Ue.WebOS};return e&&e.length&&(t.version=e),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(s){const e=F.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,s)||F.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,s)||F.getFirstMatch(/\bbb(\d+)/i,s);return{name:Ue.BlackBerry,version:e}}},{test:[/bada/i],describe(s){const e=F.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,s);return{name:Ue.Bada,version:e}}},{test:[/tizen/i],describe(s){const e=F.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,s);return{name:Ue.Tizen,version:e}}},{test:[/linux/i],describe:()=>({name:Ue.Linux})},{test:[/CrOS/],describe:()=>({name:Ue.ChromeOS})},{test:[/PlayStation 4/],describe(s){const e=F.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,s);return{name:Ue.PlayStation4,version:e}}}],rh=[{test:[/googlebot/i],describe:()=>({type:"bot",vendor:"Google"})},{test:[/huawei/i],describe(s){const e=F.getFirstMatch(/(can-l01)/i,s)&&"Nova",t={type:we.mobile,vendor:"Huawei"};return e&&(t.model=e),t}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:()=>({type:we.tablet,vendor:"Nexus"})},{test:[/ipad/i],describe:()=>({type:we.tablet,vendor:"Apple",model:"iPad"})},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:()=>({type:we.tablet,vendor:"Apple",model:"iPad"})},{test:[/kftt build/i],describe:()=>({type:we.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"})},{test:[/silk/i],describe:()=>({type:we.tablet,vendor:"Amazon"})},{test:[/tablet(?! pc)/i],describe:()=>({type:we.tablet})},{test(s){const e=s.test(/ipod|iphone/i),t=s.test(/like (ipod|iphone)/i);return e&&!t},describe(s){const e=F.getFirstMatch(/(ipod|iphone)/i,s);return{type:we.mobile,vendor:"Apple",model:e}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:()=>({type:we.mobile,vendor:"Nexus"})},{test:[/[^-]mobi/i],describe:()=>({type:we.mobile})},{test:s=>s.getBrowserName(!0)==="blackberry",describe:()=>({type:we.mobile,vendor:"BlackBerry"})},{test:s=>s.getBrowserName(!0)==="bada",describe:()=>({type:we.mobile})},{test:s=>s.getBrowserName()==="windows phone",describe:()=>({type:we.mobile,vendor:"Microsoft"})},{test(s){const e=Number(String(s.getOSVersion()).split(".")[0]);return s.getOSName(!0)==="android"&&e>=3},describe:()=>({type:we.tablet})},{test:s=>s.getOSName(!0)==="android",describe:()=>({type:we.mobile})},{test:s=>s.getOSName(!0)==="macos",describe:()=>({type:we.desktop,vendor:"Apple"})},{test:s=>s.getOSName(!0)==="windows",describe:()=>({type:we.desktop})},{test:s=>s.getOSName(!0)==="linux",describe:()=>({type:we.desktop})},{test:s=>s.getOSName(!0)==="playstation 4",describe:()=>({type:we.tv})},{test:s=>s.getOSName(!0)==="roku",describe:()=>({type:we.tv})}],ah=[{test:s=>s.getBrowserName(!0)==="microsoft edge",describe(s){if(/\sedg\//i.test(s))return{name:Ot.Blink};const e=F.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,s);return{name:Ot.EdgeHTML,version:e}}},{test:[/trident/i],describe(s){const e={name:Ot.Trident},t=F.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:s=>s.test(/presto/i),describe(s){const e={name:Ot.Presto},t=F.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test(s){const e=s.test(/gecko/i),t=s.test(/like gecko/i);return e&&!t},describe(s){const e={name:Ot.Gecko},t=F.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}},{test:[/(apple)?webkit\/537\.36/i],describe:()=>({name:Ot.Blink})},{test:[/(apple)?webkit/i],describe(s){const e={name:Ot.WebKit},t=F.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,s);return t&&(e.version=t),e}}];class Ua{constructor(e,t=!1){if(e==null||e==="")throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},t!==!0&&this.parse()}getUA(){return this._ua}test(e){return e.test(this._ua)}parseBrowser(){this.parsedResult.browser={};const e=F.find(sh,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(i=>this.test(i));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.browser=e.describe(this.getUA())),this.parsedResult.browser}getBrowser(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()}getBrowserName(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""}getBrowserVersion(){return this.getBrowser().version}getOS(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()}parseOS(){this.parsedResult.os={};const e=F.find(nh,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(i=>this.test(i));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.os=e.describe(this.getUA())),this.parsedResult.os}getOSName(e){const{name:t}=this.getOS();return e?String(t).toLowerCase()||"":t||""}getOSVersion(){return this.getOS().version}getPlatform(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()}getPlatformType(e=!1){const{type:t}=this.getPlatform();return e?String(t).toLowerCase()||"":t||""}parsePlatform(){this.parsedResult.platform={};const e=F.find(rh,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(i=>this.test(i));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.platform=e.describe(this.getUA())),this.parsedResult.platform}getEngine(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()}getEngineName(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""}parseEngine(){this.parsedResult.engine={};const e=F.find(ah,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(i=>this.test(i));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.engine=e.describe(this.getUA())),this.parsedResult.engine}parse(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this}getResult(){return F.assign({},this.parsedResult)}satisfies(e){const t={};let i=0;const n={};let r=0;if(Object.keys(e).forEach(a=>{const o=e[a];typeof o=="string"?(n[a]=o,r+=1):typeof o=="object"&&(t[a]=o,i+=1)}),i>0){const a=Object.keys(t),o=F.find(a,c=>this.isOS(c));if(o){const c=this.satisfies(t[o]);if(c!==void 0)return c}const l=F.find(a,c=>this.isPlatform(c));if(l){const c=this.satisfies(t[l]);if(c!==void 0)return c}}if(r>0){const a=Object.keys(n),o=F.find(a,l=>this.isBrowser(l,!0));if(o!==void 0)return this.compareVersion(n[o])}}isBrowser(e,t=!1){const i=this.getBrowserName().toLowerCase();let n=e.toLowerCase();const r=F.getBrowserTypeByAlias(n);return t&&r&&(n=r.toLowerCase()),n===i}compareVersion(e){let t=[0],i=e,n=!1;const r=this.getBrowserVersion();if(typeof r=="string")return e[0]===">"||e[0]==="<"?(i=e.substr(1),e[1]==="="?(n=!0,i=e.substr(2)):t=[],e[0]===">"?t.push(1):t.push(-1)):e[0]==="="?i=e.substr(1):e[0]==="~"&&(n=!0,i=e.substr(1)),t.indexOf(F.compareVersions(r,i,n))>-1}isOS(e){return this.getOSName(!0)===String(e).toLowerCase()}isPlatform(e){return this.getPlatformType(!0)===String(e).toLowerCase()}isEngine(e){return this.getEngineName(!0)===String(e).toLowerCase()}is(e,t=!1){return this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)}some(e=[]){return e.some(t=>this.is(t))}}/*!
 * Bowser - a browser detector
 * https://github.com/lancedikson/bowser
 * MIT License | (c) Dustin Diaz 2012-2015
 * MIT License | (c) Denis Demchenko 2015-2019
 */class oh{static getParser(e,t=!1){if(typeof e!="string")throw new Error("UserAgent should be a string");return new Ua(e,t)}static parse(e){return new Ua(e).getResult()}static get BROWSER_MAP(){return Na}static get ENGINE_MAP(){return Ot}static get OS_MAP(){return Ue}static get PLATFORMS_MAP(){return we}}function as(){return Date.now()+Math.random().toString()}function Ri(){throw new Error("Method must be implemented in subclass")}function Ba(s,e){return e!=null&&e.proxyUrl?e.proxyUrl+(e.proxyUrl.slice(-1)==="/"?"":"/")+s.substring(8):s}function os(s){return s!=null&&s.callObjectBundleUrlOverride?s.callObjectBundleUrlOverride:Ba("https://c.daily.co/call-machine/versioned/".concat("0.75.2","/static/call-machine-object-bundle.js"),s)}function ls(s){try{new URL(s)}catch{return!1}return!0}const $a=Object.prototype.toString;function yn(s){switch($a.call(s)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return zt(s,Error)}}function hi(s,e){return $a.call(s)===`[object ${e}]`}function ja(s){return hi(s,"ErrorEvent")}function Ga(s){return hi(s,"DOMError")}function At(s){return hi(s,"String")}function vn(s){return typeof s=="object"&&s!==null&&"__sentry_template_string__"in s&&"__sentry_template_values__"in s}function Sn(s){return s===null||vn(s)||typeof s!="object"&&typeof s!="function"}function fi(s){return hi(s,"Object")}function cs(s){return typeof Event<"u"&&zt(s,Event)}function us(s){return!!(s&&s.then&&typeof s.then=="function")}function zt(s,e){try{return s instanceof e}catch{return!1}}function Va(s){return!(typeof s!="object"||s===null||!s.__isVue&&!s._isVue)}function pi(s,e=0){return typeof s!="string"||e===0||s.length<=e?s:`${s.slice(0,e)}...`}function qa(s,e){if(!Array.isArray(s))return"";const t=[];for(let i=0;i<s.length;i++){const n=s[i];try{Va(n)?t.push("[VueViewModel]"):t.push(String(n))}catch{t.push("[value cannot be serialized]")}}return t.join(e)}function lh(s,e,t=!1){return!!At(s)&&(hi(e,"RegExp")?e.test(s):!!At(e)&&(t?s===e:s.includes(e)))}function ds(s,e=[],t=!1){return e.some(i=>lh(s,i,t))}function ch(s,e,t=250,i,n,r,a){if(!(r.exception&&r.exception.values&&a&&zt(a.originalException,Error)))return;const o=r.exception.values.length>0?r.exception.values[r.exception.values.length-1]:void 0;var l,c;o&&(r.exception.values=(l=En(s,e,n,a.originalException,i,r.exception.values,o,0),c=t,l.map(u=>(u.value&&(u.value=pi(u.value,c)),u))))}function En(s,e,t,i,n,r,a,o){if(r.length>=t+1)return r;let l=[...r];if(zt(i[n],Error)){Ha(a,o);const c=s(e,i[n]),u=l.length;Ka(c,n,u,o),l=En(s,e,t,i[n],n,[c,...l],c,u)}return Array.isArray(i.errors)&&i.errors.forEach((c,u)=>{if(zt(c,Error)){Ha(a,o);const d=s(e,c),f=l.length;Ka(d,`errors[${u}]`,f,o),l=En(s,e,t,c,n,[d,...l],d,f)}}),l}function Ha(s,e){s.mechanism=s.mechanism||{type:"generic",handled:!0},s.mechanism={...s.mechanism,...s.type==="AggregateError"&&{is_exception_group:!0},exception_id:e}}function Ka(s,e,t,i){s.mechanism=s.mechanism||{type:"generic",handled:!0},s.mechanism={...s.mechanism,type:"chained",source:e,exception_id:t,parent_id:i}}function Ya(s){return s===void 0?void 0:s>=400&&s<500?"warning":s>=500?"error":void 0}const Jt="8.33.1",pe=globalThis;function hs(s,e,t){const i=pe,n=i.__SENTRY__=i.__SENTRY__||{},r=n[Jt]=n[Jt]||{};return r[s]||(r[s]=e())}const Tn=pe;function Wa(s,e={}){if(!s)return"<unknown>";try{let t=s;const i=5,n=[];let r=0,a=0;const o=" > ",l=o.length;let c;const u=Array.isArray(e)?e:e.keyAttrs,d=!Array.isArray(e)&&e.maxStringLength||80;for(;t&&r++<i&&(c=uh(t,u),!(c==="html"||r>1&&a+n.length*l+c.length>=d));)n.push(c),a+=c.length,t=t.parentNode;return n.reverse().join(o)}catch{return"<unknown>"}}function uh(s,e){const t=s,i=[];if(!t||!t.tagName)return"";if(Tn.HTMLElement&&t instanceof HTMLElement&&t.dataset){if(t.dataset.sentryComponent)return t.dataset.sentryComponent;if(t.dataset.sentryElement)return t.dataset.sentryElement}i.push(t.tagName.toLowerCase());const n=e&&e.length?e.filter(a=>t.getAttribute(a)).map(a=>[a,t.getAttribute(a)]):null;if(n&&n.length)n.forEach(a=>{i.push(`[${a[0]}="${a[1]}"]`)});else{t.id&&i.push(`#${t.id}`);const a=t.className;if(a&&At(a)){const o=a.split(/\s+/);for(const l of o)i.push(`.${l}`)}}const r=["aria-label","type","name","title","alt"];for(const a of r){const o=t.getAttribute(a);o&&i.push(`[${a}="${o}"]`)}return i.join("")}const Pi=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,bn=["debug","info","warn","error","log","assert","trace"],fs={};function _n(s){if(!("console"in pe))return s();const e=pe.console,t={},i=Object.keys(fs);i.forEach(n=>{const r=fs[n];t[n]=e[n],e[n]=r});try{return s()}finally{i.forEach(n=>{e[n]=t[n]})}}const ne=hs("logger",function(){let s=!1;const e={enable:()=>{s=!0},disable:()=>{s=!1},isEnabled:()=>s};return Pi?bn.forEach(t=>{e[t]=(...i)=>{s&&_n(()=>{pe.console[t](`Sentry Logger [${t}]:`,...i)})}}):bn.forEach(t=>{e[t]=()=>{}}),e}),dh=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+)?)?@)([\w.-]+)(?::(\d+))?\/(.+)/;function ps(s,e=!1){const{host:t,path:i,pass:n,port:r,projectId:a,protocol:o,publicKey:l}=s;return`${o}://${l}${e&&n?`:${n}`:""}@${t}${r?`:${r}`:""}/${i&&`${i}/`}${a}`}function za(s){return{protocol:s.protocol,publicKey:s.publicKey||"",pass:s.pass||"",host:s.host,port:s.port||"",path:s.path||"",projectId:s.projectId}}function hh(s){const e=typeof s=="string"?function(t){const i=dh.exec(t);if(!i)return void _n(()=>{console.error(`Invalid Sentry Dsn: ${t}`)});const[n,r,a="",o="",l="",c=""]=i.slice(1);let u="",d=c;const f=d.split("/");if(f.length>1&&(u=f.slice(0,-1).join("/"),d=f.pop()),d){const p=d.match(/^\d+/);p&&(d=p[0])}return za({host:o,pass:a,path:u,projectId:d,port:l,protocol:n,publicKey:r})}(s):za(s);if(e&&function(t){if(!Pi)return!0;const{port:i,projectId:n,protocol:r}=t;return!(["protocol","publicKey","host","projectId"].find(a=>!t[a]&&(ne.error(`Invalid Sentry Dsn: ${a} missing`),!0))||(n.match(/^\d+$/)?function(a){return a==="http"||a==="https"}(r)?i&&isNaN(parseInt(i,10))&&(ne.error(`Invalid Sentry Dsn: Invalid port ${i}`),1):(ne.error(`Invalid Sentry Dsn: Invalid protocol ${r}`),1):(ne.error(`Invalid Sentry Dsn: Invalid projectId ${n}`),1)))}(e))return e}class ht extends Error{constructor(e,t="warn"){super(e),this.message=e,this.name=new.target.prototype.constructor.name,Object.setPrototypeOf(this,new.target.prototype),this.logLevel=t}}function qe(s,e,t){if(!(e in s))return;const i=s[e],n=t(i);typeof n=="function"&&Ja(n,i),s[e]=n}function Qt(s,e,t){try{Object.defineProperty(s,e,{value:t,writable:!0,configurable:!0})}catch{Pi&&ne.log(`Failed to add non-enumerable property "${e}" to object`,s)}}function Ja(s,e){try{const t=e.prototype||{};s.prototype=e.prototype=t,Qt(s,"__sentry_original__",e)}catch{}}function xn(s){return s.__sentry_original__}function Qa(s){if(yn(s))return{message:s.message,name:s.name,stack:s.stack,...Za(s)};if(cs(s)){const e={type:s.type,target:Xa(s.target),currentTarget:Xa(s.currentTarget),...Za(s)};return typeof CustomEvent<"u"&&zt(s,CustomEvent)&&(e.detail=s.detail),e}return s}function Xa(s){try{return e=s,typeof Element<"u"&&zt(e,Element)?Wa(s):Object.prototype.toString.call(s)}catch{return"<unknown>"}var e}function Za(s){if(typeof s=="object"&&s!==null){const e={};for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(e[t]=s[t]);return e}return{}}function rt(s){return An(s,new Map)}function An(s,e){if(function(t){if(!fi(t))return!1;try{const i=Object.getPrototypeOf(t).constructor.name;return!i||i==="Object"}catch{return!0}}(s)){const t=e.get(s);if(t!==void 0)return t;const i={};e.set(s,i);for(const n of Object.getOwnPropertyNames(s))s[n]!==void 0&&(i[n]=An(s[n],e));return i}if(Array.isArray(s)){const t=e.get(s);if(t!==void 0)return t;const i=[];return e.set(s,i),s.forEach(n=>{i.push(An(n,e))}),i}return s}const Xt="?",eo=/\(error: (.*)\)/,to=/captureMessage|captureException/;function gs(s){return s[s.length-1]||{}}const io="<anonymous>";function Mt(s){try{return s&&typeof s=="function"&&s.name||io}catch{return io}}function so(s){const e=s.exception;if(e){const t=[];try{return e.values.forEach(i=>{i.stacktrace.frames&&t.push(...i.stacktrace.frames)}),t}catch{return}}}const ms={},no={};function Zt(s,e){ms[s]=ms[s]||[],ms[s].push(e)}function ei(s,e){no[s]||(e(),no[s]=!0)}function at(s,e){const t=s&&ms[s];if(t)for(const i of t)try{i(e)}catch(n){Pi&&ne.error(`Error while triggering instrumentation handler.
Type: ${s}
Name: ${Mt(i)}
Error:`,n)}}function fh(){"console"in pe&&bn.forEach(function(s){s in pe.console&&qe(pe.console,s,function(e){return fs[s]=e,function(...t){at("console",{args:t,level:s});const i=fs[s];i&&i.apply(pe.console,t)}})})}const In=pe;function wn(s){return s&&/^function\s+\w+\(\)\s+\{\s+\[native code\]\s+\}$/.test(s.toString())}function ph(){if(typeof EdgeRuntime=="string")return!0;if(!function(){if(!("fetch"in In))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch{return!1}}())return!1;if(wn(In.fetch))return!0;let s=!1;const e=In.document;if(e&&typeof e.createElement=="function")try{const t=e.createElement("iframe");t.hidden=!0,e.head.appendChild(t),t.contentWindow&&t.contentWindow.fetch&&(s=wn(t.contentWindow.fetch)),e.head.removeChild(t)}catch(t){Pi&&ne.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",t)}return s}function Di(){return Date.now()/1e3}const Ft=function(){const{performance:s}=pe;if(!s||!s.now)return Di;const e=Date.now()-s.now(),t=s.timeOrigin==null?e:s.timeOrigin;return()=>(t+s.now())/1e3}();function gh(s,e){const t="fetch";Zt(t,s),ei(t,()=>function(i,n=!1){n&&!ph()||qe(pe,"fetch",function(r){return function(...a){const{method:o,url:l}=function(d){if(d.length===0)return{method:"GET",url:""};if(d.length===2){const[p,g]=d;return{url:ro(p),method:Ln(g,"method")?String(g.method).toUpperCase():"GET"}}const f=d[0];return{url:ro(f),method:Ln(f,"method")?String(f.method).toUpperCase():"GET"}}(a),c={args:a,fetchData:{method:o,url:l},startTimestamp:1e3*Ft()};at("fetch",{...c});const u=new Error().stack;return r.apply(pe,a).then(async d=>(at("fetch",{...c,endTimestamp:1e3*Ft(),response:d}),d),d=>{throw at("fetch",{...c,endTimestamp:1e3*Ft(),error:d}),yn(d)&&d.stack===void 0&&(d.stack=u,Qt(d,"framesToPop",1)),d})}})}(void 0,e))}function Ln(s,e){return!!s&&typeof s=="object"&&!!s[e]}function ro(s){return typeof s=="string"?s:s?Ln(s,"url")?s.url:s.toString?s.toString():"":""}(()=>{const{performance:s}=pe;!s||!s.now||(s.now(),s.timing&&s.timing.navigationStart)})();let ys=null;function mh(){ys=pe.onerror,pe.onerror=function(s,e,t,i,n){return at("error",{column:i,error:n,line:t,msg:s,url:e}),!(!ys||ys.__SENTRY_LOADER__)&&ys.apply(this,arguments)},pe.onerror.__SENTRY_INSTRUMENTED__=!0}let vs=null;function yh(){vs=pe.onunhandledrejection,pe.onunhandledrejection=function(s){return at("unhandledrejection",s),!(vs&&!vs.__SENTRY_LOADER__)||vs.apply(this,arguments)},pe.onunhandledrejection.__SENTRY_INSTRUMENTED__=!0}function ot(){const s=pe,e=s.crypto||s.msCrypto;let t=()=>16*Math.random();try{if(e&&e.randomUUID)return e.randomUUID().replace(/-/g,"");e&&e.getRandomValues&&(t=()=>{const i=new Uint8Array(1);return e.getRandomValues(i),i[0]})}catch{}return("10000000100040008000"+1e11).replace(/[018]/g,i=>(i^(15&t())>>i/4).toString(16))}function ao(s){return s.exception&&s.exception.values?s.exception.values[0]:void 0}function Nt(s){const{message:e,event_id:t}=s;if(e)return e;const i=ao(s);return i?i.type&&i.value?`${i.type}: ${i.value}`:i.type||i.value||t||"<unknown>":t||"<unknown>"}function kn(s,e,t){const i=s.exception=s.exception||{},n=i.values=i.values||[],r=n[0]=n[0]||{};r.value||(r.value=e||""),r.type||(r.type="Error")}function Oi(s,e){const t=ao(s);if(!t)return;const i=t.mechanism;if(t.mechanism={type:"generic",handled:!0,...i,...e},e&&"data"in e){const n={...i&&i.data,...e.data};t.mechanism.data=n}}function oo(s){if(s&&s.__sentry_captured__)return!0;try{Qt(s,"__sentry_captured__",!0)}catch{}return!1}function Ut(s,e=100,t=1/0){try{return Cn("",s,e,t)}catch(i){return{ERROR:`**non-serializable** (${i})`}}}function lo(s,e=3,t=102400){const i=Ut(s,e);return n=i,function(r){return~-encodeURI(r).split(/%..|./).length}(JSON.stringify(n))>t?lo(s,e-1,t):i;var n}function Cn(s,e,t=1/0,i=1/0,n=function(){const r=typeof WeakSet=="function",a=r?new WeakSet:[];return[function(o){if(r)return!!a.has(o)||(a.add(o),!1);for(let l=0;l<a.length;l++)if(a[l]===o)return!0;return a.push(o),!1},function(o){if(r)a.delete(o);else for(let l=0;l<a.length;l++)if(a[l]===o){a.splice(l,1);break}}]}()){const[r,a]=n;if(e==null||["boolean","string"].includes(typeof e)||typeof e=="number"&&Number.isFinite(e))return e;const o=function(p,g){try{if(p==="domain"&&g&&typeof g=="object"&&g._events)return"[Domain]";if(p==="domainEmitter")return"[DomainEmitter]";if(typeof global<"u"&&g===global)return"[Global]";if(typeof window<"u"&&g===window)return"[Window]";if(typeof document<"u"&&g===document)return"[Document]";if(Va(g))return"[VueViewModel]";if(fi(y=g)&&"nativeEvent"in y&&"preventDefault"in y&&"stopPropagation"in y)return"[SyntheticEvent]";if(typeof g=="number"&&!Number.isFinite(g))return`[${g}]`;if(typeof g=="function")return`[Function: ${Mt(g)}]`;if(typeof g=="symbol")return`[${String(g)}]`;if(typeof g=="bigint")return`[BigInt: ${String(g)}]`;const S=function(T){const L=Object.getPrototypeOf(T);return L?L.constructor.name:"null prototype"}(g);return/^HTML(\w*)Element$/.test(S)?`[HTMLElement: ${S}]`:`[object ${S}]`}catch(S){return`**non-serializable** (${S})`}var y}(s,e);if(!o.startsWith("[object "))return o;if(e.__sentry_skip_normalization__)return e;const l=typeof e.__sentry_override_normalization_depth__=="number"?e.__sentry_override_normalization_depth__:t;if(l===0)return o.replace("object ","");if(r(e))return"[Circular ~]";const c=e;if(c&&typeof c.toJSON=="function")try{return Cn("",c.toJSON(),l-1,i,n)}catch{}const u=Array.isArray(e)?[]:{};let d=0;const f=Qa(e);for(const p in f){if(!Object.prototype.hasOwnProperty.call(f,p))continue;if(d>=i){u[p]="[MaxProperties ~]";break}const g=f[p];u[p]=Cn(p,g,l-1,i,n),d++}return a(e),u}var It;function ti(s){return new ze(e=>{e(s)})}function Ss(s){return new ze((e,t)=>{t(s)})}(function(s){s[s.PENDING=0]="PENDING",s[s.RESOLVED=1]="RESOLVED",s[s.REJECTED=2]="REJECTED"})(It||(It={}));class ze{constructor(e){ze.prototype.__init.call(this),ze.prototype.__init2.call(this),ze.prototype.__init3.call(this),ze.prototype.__init4.call(this),this._state=It.PENDING,this._handlers=[];try{e(this._resolve,this._reject)}catch(t){this._reject(t)}}then(e,t){return new ze((i,n)=>{this._handlers.push([!1,r=>{if(e)try{i(e(r))}catch(a){n(a)}else i(r)},r=>{if(t)try{i(t(r))}catch(a){n(a)}else n(r)}]),this._executeHandlers()})}catch(e){return this.then(t=>t,e)}finally(e){return new ze((t,i)=>{let n,r;return this.then(a=>{r=!1,n=a,e&&e()},a=>{r=!0,n=a,e&&e()}).then(()=>{r?i(n):t(n)})})}__init(){this._resolve=e=>{this._setResult(It.RESOLVED,e)}}__init2(){this._reject=e=>{this._setResult(It.REJECTED,e)}}__init3(){this._setResult=(e,t)=>{this._state===It.PENDING&&(us(t)?t.then(this._resolve,this._reject):(this._state=e,this._value=t,this._executeHandlers()))}}__init4(){this._executeHandlers=()=>{if(this._state===It.PENDING)return;const e=this._handlers.slice();this._handlers=[],e.forEach(t=>{t[0]||(this._state===It.RESOLVED&&t[1](this._value),this._state===It.REJECTED&&t[2](this._value),t[0]=!0)})}}}function vh(s){const e=[];function t(i){return e.splice(e.indexOf(i),1)[0]||Promise.resolve(void 0)}return{$:e,add:function(i){if(!(s===void 0||e.length<s))return Ss(new ht("Not adding Promise because buffer limit was reached."));const n=i();return e.indexOf(n)===-1&&e.push(n),n.then(()=>t(n)).then(null,()=>t(n).then(null,()=>{})),n},drain:function(i){return new ze((n,r)=>{let a=e.length;if(!a)return n(!0);const o=setTimeout(()=>{i&&i>0&&n(!1)},i);e.forEach(l=>{ti(l).then(()=>{--a||(clearTimeout(o),n(!0))},r)})})}}}function Rn(s){if(!s)return{};const e=s.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!e)return{};const t=e[6]||"",i=e[8]||"";return{host:e[4],path:e[5],protocol:e[2],search:t,hash:i,relative:e[5]+t+i}}const Sh=["fatal","error","warning","log","info","debug"];function Eh(s){return s==="warn"?"warning":Sh.includes(s)?s:"log"}const Th=/^sentry-/;function bh(s){const e=function(i){if(!(!i||!At(i)&&!Array.isArray(i)))return Array.isArray(i)?i.reduce((n,r)=>{const a=co(r);return Object.entries(a).forEach(([o,l])=>{n[o]=l}),n},{}):co(i)}(s);if(!e)return;const t=Object.entries(e).reduce((i,[n,r])=>(n.match(Th)&&(i[n.slice(7)]=r),i),{});return Object.keys(t).length>0?t:void 0}function co(s){return s.split(",").map(e=>e.split("=").map(t=>decodeURIComponent(t.trim()))).reduce((e,[t,i])=>(t&&i&&(e[t]=i),e),{})}function Mi(s,e=[]){return[s,e]}function _h(s,e){const[t,i]=s;return[t,[...i,e]]}function uo(s,e){const t=s[1];for(const i of t)if(e(i,i[0].type))return!0;return!1}function Pn(s){return pe.__SENTRY__&&pe.__SENTRY__.encodePolyfill?pe.__SENTRY__.encodePolyfill(s):new TextEncoder().encode(s)}function xh(s){const[e,t]=s;let i=JSON.stringify(e);function n(r){typeof i=="string"?i=typeof r=="string"?i+r:[Pn(i),r]:i.push(typeof r=="string"?Pn(r):r)}for(const r of t){const[a,o]=r;if(n(`
${JSON.stringify(a)}
`),typeof o=="string"||o instanceof Uint8Array)n(o);else{let l;try{l=JSON.stringify(o)}catch{l=JSON.stringify(Ut(o))}n(l)}}return typeof i=="string"?i:function(r){const a=r.reduce((c,u)=>c+u.length,0),o=new Uint8Array(a);let l=0;for(const c of r)o.set(c,l),l+=c.length;return o}(i)}function Ah(s){const e=typeof s.data=="string"?Pn(s.data):s.data;return[rt({type:"attachment",length:e.length,filename:s.filename,content_type:s.contentType,attachment_type:s.attachmentType}),e]}const Ih={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default",profile:"profile",profile_chunk:"profile",replay_event:"replay",replay_recording:"replay",check_in:"monitor",feedback:"feedback",span:"span",statsd:"metric_bucket"};function ho(s){return Ih[s]}function fo(s){if(!s||!s.sdk)return;const{name:e,version:t}=s.sdk;return{name:e,version:t}}function wh(s,{statusCode:e,headers:t},i=Date.now()){const n={...s},r=t&&t["x-sentry-rate-limits"],a=t&&t["retry-after"];if(r)for(const o of r.trim().split(",")){const[l,c,,,u]=o.split(":",5),d=parseInt(l,10),f=1e3*(isNaN(d)?60:d);if(c)for(const p of c.split(";"))p==="metric_bucket"&&u&&!u.split(";").includes("custom")||(n[p]=i+f);else n.all=i+f}else a?n.all=i+function(o,l=Date.now()){const c=parseInt(`${o}`,10);if(!isNaN(c))return 1e3*c;const u=Date.parse(`${o}`);return isNaN(u)?6e4:u-l}(a,i):e===429&&(n.all=i+6e4);return n}function po(){return{traceId:ot(),spanId:ot().substring(16)}}const Es=pe,_e=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__;function Ts(){return Dn(pe),pe}function Dn(s){const e=s.__SENTRY__=s.__SENTRY__||{};return e.version=e.version||Jt,e[Jt]=e[Jt]||{}}function On(s,e={}){if(e.user&&(!s.ipAddress&&e.user.ip_address&&(s.ipAddress=e.user.ip_address),s.did||e.did||(s.did=e.user.id||e.user.email||e.user.username)),s.timestamp=e.timestamp||Ft(),e.abnormal_mechanism&&(s.abnormal_mechanism=e.abnormal_mechanism),e.ignoreDuration&&(s.ignoreDuration=e.ignoreDuration),e.sid&&(s.sid=e.sid.length===32?e.sid:ot()),e.init!==void 0&&(s.init=e.init),!s.did&&e.did&&(s.did=`${e.did}`),typeof e.started=="number"&&(s.started=e.started),s.ignoreDuration)s.duration=void 0;else if(typeof e.duration=="number")s.duration=e.duration;else{const t=s.timestamp-s.started;s.duration=t>=0?t:0}e.release&&(s.release=e.release),e.environment&&(s.environment=e.environment),!s.ipAddress&&e.ipAddress&&(s.ipAddress=e.ipAddress),!s.userAgent&&e.userAgent&&(s.userAgent=e.userAgent),typeof e.errors=="number"&&(s.errors=e.errors),e.status&&(s.status=e.status)}const Mn="_sentrySpan";function go(s,e){e?Qt(s,Mn,e):delete s[Mn]}function mo(s){return s[Mn]}class Fn{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext=po()}clone(){const e=new Fn;return e._breadcrumbs=[...this._breadcrumbs],e._tags={...this._tags},e._extra={...this._extra},e._contexts={...this._contexts},e._user=this._user,e._level=this._level,e._session=this._session,e._transactionName=this._transactionName,e._fingerprint=this._fingerprint,e._eventProcessors=[...this._eventProcessors],e._requestSession=this._requestSession,e._attachments=[...this._attachments],e._sdkProcessingMetadata={...this._sdkProcessingMetadata},e._propagationContext={...this._propagationContext},e._client=this._client,e._lastEventId=this._lastEventId,go(e,mo(this)),e}setClient(e){this._client=e}setLastEventId(e){this._lastEventId=e}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&On(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}getRequestSession(){return this._requestSession}setRequestSession(e){return this._requestSession=e,this}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this._tags={...this._tags,[e]:t},this._notifyScopeListeners(),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return t===null?delete this._contexts[e]:this._contexts[e]=t,this._notifyScopeListeners(),this}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;const t=typeof e=="function"?e(this):e,[i,n]=t instanceof Bt?[t.getScopeData(),t.getRequestSession()]:fi(t)?[e,e.requestSession]:[],{tags:r,extra:a,user:o,contexts:l,level:c,fingerprint:u=[],propagationContext:d}=i||{};return this._tags={...this._tags,...r},this._extra={...this._extra,...a},this._contexts={...this._contexts,...l},o&&Object.keys(o).length&&(this._user=o),c&&(this._level=c),u.length&&(this._fingerprint=u),d&&(this._propagationContext=d),n&&(this._requestSession=n),this}clear(){return this._breadcrumbs=[],this._tags={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._requestSession=void 0,this._session=void 0,go(this,void 0),this._attachments=[],this._propagationContext=po(),this._notifyScopeListeners(),this}addBreadcrumb(e,t){const i=typeof t=="number"?t:100;if(i<=0)return this;const n={timestamp:Di(),...e},r=this._breadcrumbs;return r.push(n),this._breadcrumbs=r.length>i?r.slice(-i):r,this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:mo(this)}}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata={...this._sdkProcessingMetadata,...e},this}setPropagationContext(e){return this._propagationContext=e,this}getPropagationContext(){return this._propagationContext}captureException(e,t){const i=t&&t.event_id?t.event_id:ot();if(!this._client)return ne.warn("No client configured on scope - will not capture exception!"),i;const n=new Error("Sentry syntheticException");return this._client.captureException(e,{originalException:e,syntheticException:n,...t,event_id:i},this),i}captureMessage(e,t,i){const n=i&&i.event_id?i.event_id:ot();if(!this._client)return ne.warn("No client configured on scope - will not capture message!"),n;const r=new Error(e);return this._client.captureMessage(e,t,{originalException:e,syntheticException:r,...i,event_id:n},this),n}captureEvent(e,t){const i=t&&t.event_id?t.event_id:ot();return this._client?(this._client.captureEvent(e,{...t,event_id:i},this),i):(ne.warn("No client configured on scope - will not capture event!"),i)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(e=>{e(this)}),this._notifyingListeners=!1)}}const Bt=Fn;class Lh{constructor(e,t){let i,n;i=e||new Bt,n=t||new Bt,this._stack=[{scope:i}],this._isolationScope=n}withScope(e){const t=this._pushScope();let i;try{i=e(t)}catch(n){throw this._popScope(),n}return us(i)?i.then(n=>(this._popScope(),n),n=>{throw this._popScope(),n}):(this._popScope(),i)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const e=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:e}),e}_popScope(){return!(this._stack.length<=1)&&!!this._stack.pop()}}function gi(){const s=Dn(Ts());return s.stack=s.stack||new Lh(hs("defaultCurrentScope",()=>new Bt),hs("defaultIsolationScope",()=>new Bt))}function kh(s){return gi().withScope(s)}function Ch(s,e){const t=gi();return t.withScope(()=>(t.getStackTop().scope=s,e(s)))}function yo(s){return gi().withScope(()=>s(gi().getIsolationScope()))}function Nn(s){const e=Dn(s);return e.acs?e.acs:{withIsolationScope:yo,withScope:kh,withSetScope:Ch,withSetIsolationScope:(t,i)=>yo(i),getCurrentScope:()=>gi().getScope(),getIsolationScope:()=>gi().getIsolationScope()}}function Un(){return Nn(Ts()).getCurrentScope()}function vo(){return Nn(Ts()).getIsolationScope()}function je(){return Un().getClient()}function Rh(s){const e=s._sentryMetrics;if(!e)return;const t={};for(const[,[i,n]]of e)(t[i]||(t[i]=[])).push(rt(n));return t}function Ph(s){const{spanId:e,traceId:t}=s.spanContext(),{parent_span_id:i}=bs(s);return rt({parent_span_id:i,span_id:e,trace_id:t})}function So(s){return typeof s=="number"?Eo(s):Array.isArray(s)?s[0]+s[1]/1e9:s instanceof Date?Eo(s.getTime()):Ft()}function Eo(s){return s>9999999999?s/1e3:s}function bs(s){if(function(e){return typeof e.getSpanJSON=="function"}(s))return s.getSpanJSON();try{const{spanId:e,traceId:t}=s.spanContext();if(function(i){const n=i;return!!(n.attributes&&n.startTime&&n.name&&n.endTime&&n.status)}(s)){const{attributes:i,startTime:n,name:r,endTime:a,parentSpanId:o,status:l}=s;return rt({span_id:e,trace_id:t,data:i,description:r,parent_span_id:o,start_timestamp:So(n),timestamp:So(a)||void 0,status:Dh(l),op:i["sentry.op"],origin:i["sentry.origin"],_metrics_summary:Rh(s)})}return{span_id:e,trace_id:t}}catch{return{}}}function Dh(s){if(s&&s.code!==0)return s.code===1?"ok":s.message||"unknown_error"}function To(s){return s._sentryRootSpan||s}const bo="production";function _o(s,e){const t=e.getOptions(),{publicKey:i}=e.getDsn()||{},n=rt({environment:t.environment||bo,release:t.release,public_key:i,trace_id:s});return e.emit("createDsc",n),n}function Oh(s){const e=je();if(!e)return{};const t=_o(bs(s).trace_id||"",e),i=To(s),n=i._frozenDsc;if(n)return n;const r=i.spanContext().traceState,a=r&&r.get("sentry.dsc"),o=a&&bh(a);if(o)return o;const l=bs(i),c=l.data||{},u=c["sentry.sample_rate"];u!=null&&(t.sample_rate=`${u}`);const d=c["sentry.source"],f=l.description;return d!=="url"&&f&&(t.transaction=f),function(p){if(typeof __SENTRY_TRACING__=="boolean"&&!__SENTRY_TRACING__)return!1;const g=je(),y=g&&g.getOptions();return!!y&&(y.enableTracing||"tracesSampleRate"in y||"tracesSampler"in y)}()&&(t.sampled=String(function(p){const{traceFlags:g}=p.spanContext();return g===1}(i))),e.emit("createDsc",t,i),t}function Mh(s,e,t,i){const n=fo(t),r=s.type&&s.type!=="replay_event"?s.type:"event";(function(o,l){l&&(o.sdk=o.sdk||{},o.sdk.name=o.sdk.name||l.name,o.sdk.version=o.sdk.version||l.version,o.sdk.integrations=[...o.sdk.integrations||[],...l.integrations||[]],o.sdk.packages=[...o.sdk.packages||[],...l.packages||[]])})(s,t&&t.sdk);const a=function(o,l,c,u){const d=o.sdkProcessingMetadata&&o.sdkProcessingMetadata.dynamicSamplingContext;return{event_id:o.event_id,sent_at:new Date().toISOString(),...l&&{sdk:l},...!!c&&u&&{dsn:ps(u)},...d&&{trace:rt({...d})}}}(s,n,i,e);return delete s.sdkProcessingMetadata,Mi(a,[[{type:r},s]])}function Bn(s,e,t,i=0){return new ze((n,r)=>{const a=s[i];if(e===null||typeof a!="function")n(e);else{const o=a({...e},t);_e&&a.id&&o===null&&ne.log(`Event processor "${a.id}" dropped event`),us(o)?o.then(l=>Bn(s,l,t,i+1).then(n)).then(null,r):Bn(s,o,t,i+1).then(n).then(null,r)}})}function Fh(s,e){const{fingerprint:t,span:i,breadcrumbs:n,sdkProcessingMetadata:r}=e;(function(a,o){const{extra:l,tags:c,user:u,contexts:d,level:f,transactionName:p}=o,g=rt(l);g&&Object.keys(g).length&&(a.extra={...g,...a.extra});const y=rt(c);y&&Object.keys(y).length&&(a.tags={...y,...a.tags});const S=rt(u);S&&Object.keys(S).length&&(a.user={...S,...a.user});const T=rt(d);T&&Object.keys(T).length&&(a.contexts={...T,...a.contexts}),f&&(a.level=f),p&&a.type!=="transaction"&&(a.transaction=p)})(s,e),i&&function(a,o){a.contexts={trace:Ph(o),...a.contexts},a.sdkProcessingMetadata={dynamicSamplingContext:Oh(o),...a.sdkProcessingMetadata};const l=To(o),c=bs(l).description;c&&!a.transaction&&a.type==="transaction"&&(a.transaction=c)}(s,i),function(a,o){a.fingerprint=a.fingerprint?function(l){return Array.isArray(l)?l:[l]}(a.fingerprint):[],o&&(a.fingerprint=a.fingerprint.concat(o)),a.fingerprint&&!a.fingerprint.length&&delete a.fingerprint}(s,t),function(a,o){const l=[...a.breadcrumbs||[],...o];a.breadcrumbs=l.length?l:void 0}(s,n),function(a,o){a.sdkProcessingMetadata={...a.sdkProcessingMetadata,...o}}(s,r)}function xo(s,e){const{extra:t,tags:i,user:n,contexts:r,level:a,sdkProcessingMetadata:o,breadcrumbs:l,fingerprint:c,eventProcessors:u,attachments:d,propagationContext:f,transactionName:p,span:g}=e;Fi(s,"extra",t),Fi(s,"tags",i),Fi(s,"user",n),Fi(s,"contexts",r),Fi(s,"sdkProcessingMetadata",o),a&&(s.level=a),p&&(s.transactionName=p),g&&(s.span=g),l.length&&(s.breadcrumbs=[...s.breadcrumbs,...l]),c.length&&(s.fingerprint=[...s.fingerprint,...c]),u.length&&(s.eventProcessors=[...s.eventProcessors,...u]),d.length&&(s.attachments=[...s.attachments,...d]),s.propagationContext={...s.propagationContext,...f}}function Fi(s,e,t){if(t&&Object.keys(t).length){s[e]={...s[e]};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(s[e][i]=t[i])}}function Nh(s,e,t,i,n,r){const{normalizeDepth:a=3,normalizeMaxBreadth:o=1e3}=s,l={...e,event_id:e.event_id||t.event_id||ot(),timestamp:e.timestamp||Di()},c=t.integrations||s.integrations.map(g=>g.name);(function(g,y){const{environment:S,release:T,dist:L,maxValueLength:w=250}=y;"environment"in g||(g.environment="environment"in y?S:bo),g.release===void 0&&T!==void 0&&(g.release=T),g.dist===void 0&&L!==void 0&&(g.dist=L),g.message&&(g.message=pi(g.message,w));const x=g.exception&&g.exception.values&&g.exception.values[0];x&&x.value&&(x.value=pi(x.value,w));const b=g.request;b&&b.url&&(b.url=pi(b.url,w))})(l,s),function(g,y){y.length>0&&(g.sdk=g.sdk||{},g.sdk.integrations=[...g.sdk.integrations||[],...y])}(l,c),n&&n.emit("applyFrameMetadata",e),e.type===void 0&&function(g,y){const S=pe._sentryDebugIds;if(!S)return;let T;const L=Ao.get(y);L?T=L:(T=new Map,Ao.set(y,T));const w=Object.entries(S).reduce((x,[b,C])=>{let _;const k=T.get(b);k?_=k:(_=y(b),T.set(b,_));for(let D=_.length-1;D>=0;D--){const R=_[D];if(R.filename){x[R.filename]=C;break}}return x},{});try{g.exception.values.forEach(x=>{x.stacktrace.frames.forEach(b=>{b.filename&&(b.debug_id=w[b.filename])})})}catch{}}(l,s.stackParser);const u=function(g,y){if(!y)return g;const S=g?g.clone():new Bt;return S.update(y),S}(i,t.captureContext);t.mechanism&&Oi(l,t.mechanism);const d=n?n.getEventProcessors():[],f=hs("globalScope",()=>new Bt).getScopeData();r&&xo(f,r.getScopeData()),u&&xo(f,u.getScopeData());const p=[...t.attachments||[],...f.attachments];return p.length&&(t.attachments=p),Fh(l,f),Bn([...d,...f.eventProcessors],l,t).then(g=>(g&&function(y){const S={};try{y.exception.values.forEach(L=>{L.stacktrace.frames.forEach(w=>{w.debug_id&&(w.abs_path?S[w.abs_path]=w.debug_id:w.filename&&(S[w.filename]=w.debug_id),delete w.debug_id)})})}catch{}if(Object.keys(S).length===0)return;y.debug_meta=y.debug_meta||{},y.debug_meta.images=y.debug_meta.images||[];const T=y.debug_meta.images;Object.entries(S).forEach(([L,w])=>{T.push({type:"sourcemap",code_file:L,debug_id:w})})}(g),typeof a=="number"&&a>0?function(y,S,T){if(!y)return null;const L={...y,...y.breadcrumbs&&{breadcrumbs:y.breadcrumbs.map(w=>({...w,...w.data&&{data:Ut(w.data,S,T)}}))},...y.user&&{user:Ut(y.user,S,T)},...y.contexts&&{contexts:Ut(y.contexts,S,T)},...y.extra&&{extra:Ut(y.extra,S,T)}};return y.contexts&&y.contexts.trace&&L.contexts&&(L.contexts.trace=y.contexts.trace,y.contexts.trace.data&&(L.contexts.trace.data=Ut(y.contexts.trace.data,S,T))),y.spans&&(L.spans=y.spans.map(w=>({...w,...w.data&&{data:Ut(w.data,S,T)}}))),L}(g,a,o):g))}const Ao=new WeakMap;function zy(s){}function Io(s,e){return Un().captureEvent(s,e)}function Uh(s,e){return t={sentry_key:s.publicKey,sentry_version:"7",...e&&{sentry_client:`${e.name}/${e.version}`}},Object.keys(t).map(i=>`${encodeURIComponent(i)}=${encodeURIComponent(t[i])}`).join("&");var t}const wo=[];function Lo(s,e){for(const t of e)t&&t.afterAllSetup&&t.afterAllSetup(s)}function ko(s,e,t){if(t[e.name])_e&&ne.log(`Integration skipped because it was already installed: ${e.name}`);else{if(t[e.name]=e,wo.indexOf(e.name)===-1&&typeof e.setupOnce=="function"&&(e.setupOnce(),wo.push(e.name)),e.setup&&typeof e.setup=="function"&&e.setup(s),typeof e.preprocessEvent=="function"){const i=e.preprocessEvent.bind(e);s.on("preprocessEvent",(n,r)=>i(n,r,s))}if(typeof e.processEvent=="function"){const i=e.processEvent.bind(e),n=Object.assign((r,a)=>i(r,a,s),{id:e.name});s.addEventProcessor(n)}_e&&ne.log(`Integration installed: ${e.name}`)}}const Co="Not capturing exception because it's already been captured.";class Bh{constructor(e){if(this._options=e,this._integrations={},this._numProcessing=0,this._outcomes={},this._hooks={},this._eventProcessors=[],e.dsn?this._dsn=hh(e.dsn):_e&&ne.warn("No DSN provided, client will not send events."),this._dsn){const r=(t=this._dsn,i=e.tunnel,n=e._metadata?e._metadata.sdk:void 0,i||`${function(a){return`${function(o){const l=o.protocol?`${o.protocol}:`:"",c=o.port?`:${o.port}`:"";return`${l}//${o.host}${c}${o.path?`/${o.path}`:""}/api/`}(a)}${a.projectId}/envelope/`}(t)}?${Uh(t,n)}`);this._transport=e.transport({tunnel:this._options.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...e.transportOptions,url:r})}var t,i,n}captureException(e,t,i){const n=ot();if(oo(e))return _e&&ne.log(Co),n;const r={event_id:n,...t};return this._process(this.eventFromException(e,r).then(a=>this._captureEvent(a,r,i))),r.event_id}captureMessage(e,t,i,n){const r={event_id:ot(),...i},a=vn(e)?e:String(e),o=Sn(e)?this.eventFromMessage(a,t,r):this.eventFromException(e,r);return this._process(o.then(l=>this._captureEvent(l,r,n))),r.event_id}captureEvent(e,t,i){const n=ot();if(t&&t.originalException&&oo(t.originalException))return _e&&ne.log(Co),n;const r={event_id:n,...t},a=(e.sdkProcessingMetadata||{}).capturedSpanScope;return this._process(this._captureEvent(e,r,a||i)),r.event_id}captureSession(e){typeof e.release!="string"?_e&&ne.warn("Discarded session because of missing or non-string release"):(this.sendSession(e),On(e,{init:!1}))}getDsn(){return this._dsn}getOptions(){return this._options}getSdkMetadata(){return this._options._metadata}getTransport(){return this._transport}flush(e){const t=this._transport;return t?(this.emit("flush"),this._isClientDoneProcessing(e).then(i=>t.flush(e).then(n=>i&&n))):ti(!0)}close(e){return this.flush(e).then(t=>(this.getOptions().enabled=!1,this.emit("close"),t))}getEventProcessors(){return this._eventProcessors}addEventProcessor(e){this._eventProcessors.push(e)}init(){(this._isEnabled()||this._options.integrations.some(({name:e})=>e.startsWith("Spotlight")))&&this._setupIntegrations()}getIntegrationByName(e){return this._integrations[e]}addIntegration(e){const t=this._integrations[e.name];ko(this,e,this._integrations),t||Lo(this,[e])}sendEvent(e,t={}){this.emit("beforeSendEvent",e,t);let i=Mh(e,this._dsn,this._options._metadata,this._options.tunnel);for(const r of t.attachments||[])i=_h(i,Ah(r));const n=this.sendEnvelope(i);n&&n.then(r=>this.emit("afterSendEvent",e,r),null)}sendSession(e){const t=function(i,n,r,a){const o=fo(r);return Mi({sent_at:new Date().toISOString(),...o&&{sdk:o},...!!a&&n&&{dsn:ps(n)}},["aggregates"in i?[{type:"sessions"},i]:[{type:"session"},i.toJSON()]])}(e,this._dsn,this._options._metadata,this._options.tunnel);this.sendEnvelope(t)}recordDroppedEvent(e,t,i){if(this._options.sendClientReports){const n=typeof i=="number"?i:1,r=`${e}:${t}`;_e&&ne.log(`Recording outcome: "${r}"${n>1?` (${n} times)`:""}`),this._outcomes[r]=(this._outcomes[r]||0)+n}}on(e,t){const i=this._hooks[e]=this._hooks[e]||[];return i.push(t),()=>{const n=i.indexOf(t);n>-1&&i.splice(n,1)}}emit(e,...t){const i=this._hooks[e];i&&i.forEach(n=>n(...t))}sendEnvelope(e){return this.emit("beforeEnvelope",e),this._isEnabled()&&this._transport?this._transport.send(e).then(null,t=>(_e&&ne.error("Error while sending event:",t),t)):(_e&&ne.error("Transport disabled"),ti({}))}_setupIntegrations(){const{integrations:e}=this._options;this._integrations=function(t,i){const n={};return i.forEach(r=>{r&&ko(t,r,n)}),n}(this,e),Lo(this,e)}_updateSessionFromEvent(e,t){let i=!1,n=!1;const r=t.exception&&t.exception.values;if(r){n=!0;for(const o of r){const l=o.mechanism;if(l&&l.handled===!1){i=!0;break}}}const a=e.status==="ok";(a&&e.errors===0||a&&i)&&(On(e,{...i&&{status:"crashed"},errors:e.errors||Number(n||i)}),this.captureSession(e))}_isClientDoneProcessing(e){return new ze(t=>{let i=0;const n=setInterval(()=>{this._numProcessing==0?(clearInterval(n),t(!0)):(i+=1,e&&i>=e&&(clearInterval(n),t(!1)))},1)})}_isEnabled(){return this.getOptions().enabled!==!1&&this._transport!==void 0}_prepareEvent(e,t,i,n=vo()){const r=this.getOptions(),a=Object.keys(this._integrations);return!t.integrations&&a.length>0&&(t.integrations=a),this.emit("preprocessEvent",e,t),e.type||n.setLastEventId(e.event_id||t.event_id),Nh(r,e,t,i,this,n).then(o=>{if(o===null)return o;const l={...n.getPropagationContext(),...i?i.getPropagationContext():void 0};if(!(o.contexts&&o.contexts.trace)&&l){const{traceId:c,spanId:u,parentSpanId:d,dsc:f}=l;o.contexts={trace:rt({trace_id:c,span_id:u,parent_span_id:d}),...o.contexts};const p=f||_o(c,this);o.sdkProcessingMetadata={dynamicSamplingContext:p,...o.sdkProcessingMetadata}}return o})}_captureEvent(e,t={},i){return this._processEvent(e,t,i).then(n=>n.event_id,n=>{if(_e){const r=n;r.logLevel==="log"?ne.log(r.message):ne.warn(r)}})}_processEvent(e,t,i){const n=this.getOptions(),{sampleRate:r}=n,a=Po(e),o=Ro(e),l=e.type||"error",c=`before send for type \`${l}\``,u=r===void 0?void 0:function(p){if(typeof p=="boolean")return Number(p);const g=typeof p=="string"?parseFloat(p):p;if(!(typeof g!="number"||isNaN(g)||g<0||g>1))return g;_e&&ne.warn(`[Tracing] Given sample rate is invalid. Sample rate must be a boolean or a number between 0 and 1. Got ${JSON.stringify(p)} of type ${JSON.stringify(typeof p)}.`)}(r);if(o&&typeof u=="number"&&Math.random()>u)return this.recordDroppedEvent("sample_rate","error",e),Ss(new ht(`Discarding event because it's not included in the random sample (sampling rate = ${r})`,"log"));const d=l==="replay_event"?"replay":l,f=(e.sdkProcessingMetadata||{}).capturedSpanIsolationScope;return this._prepareEvent(e,t,i,f).then(p=>{if(p===null)throw this.recordDroppedEvent("event_processor",d,e),new ht("An event processor returned `null`, will not send event.","log");if(t.data&&t.data.__sentry__===!0)return p;const g=function(y,S,T,L){const{beforeSend:w,beforeSendTransaction:x,beforeSendSpan:b}=S;if(Ro(T)&&w)return w(T,L);if(Po(T)){if(T.spans&&b){const C=[];for(const _ of T.spans){const k=b(_);k?C.push(k):y.recordDroppedEvent("before_send","span")}T.spans=C}if(x){if(T.spans){const C=T.spans.length;T.sdkProcessingMetadata={...T.sdkProcessingMetadata,spanCountBeforeProcessing:C}}return x(T,L)}}return T}(this,n,p,t);return function(y,S){const T=`${S} must return \`null\` or a valid event.`;if(us(y))return y.then(L=>{if(!fi(L)&&L!==null)throw new ht(T);return L},L=>{throw new ht(`${S} rejected with ${L}`)});if(!fi(y)&&y!==null)throw new ht(T);return y}(g,c)}).then(p=>{if(p===null){if(this.recordDroppedEvent("before_send",d,e),a){const S=1+(e.spans||[]).length;this.recordDroppedEvent("before_send","span",S)}throw new ht(`${c} returned \`null\`, will not send event.`,"log")}const g=i&&i.getSession();if(!a&&g&&this._updateSessionFromEvent(g,p),a){const S=(p.sdkProcessingMetadata&&p.sdkProcessingMetadata.spanCountBeforeProcessing||0)-(p.spans?p.spans.length:0);S>0&&this.recordDroppedEvent("before_send","span",S)}const y=p.transaction_info;if(a&&y&&p.transaction!==e.transaction){const S="custom";p.transaction_info={...y,source:S}}return this.sendEvent(p,t),p}).then(null,p=>{throw p instanceof ht?p:(this.captureException(p,{data:{__sentry__:!0},originalException:p}),new ht(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.
Reason: ${p}`))})}_process(e){this._numProcessing++,e.then(t=>(this._numProcessing--,t),t=>(this._numProcessing--,t))}_clearOutcomes(){const e=this._outcomes;return this._outcomes={},Object.entries(e).map(([t,i])=>{const[n,r]=t.split(":");return{reason:n,category:r,quantity:i}})}_flushOutcomes(){_e&&ne.log("Flushing outcomes...");const e=this._clearOutcomes();if(e.length===0)return void(_e&&ne.log("No outcomes to send"));if(!this._dsn)return void(_e&&ne.log("No dsn provided, will not send outcomes"));_e&&ne.log("Sending outcomes:",e);const t=(i=e,Mi((n=this._options.tunnel&&ps(this._dsn))?{dsn:n}:{},[[{type:"client_report"},{timestamp:r||Di(),discarded_events:i}]]));var i,n,r;this.sendEnvelope(t)}}function Ro(s){return s.type===void 0}function Po(s){return s.type==="transaction"}function $h(s,e,t=vh(s.bufferSize||64)){let i={};return{send:function(n){const r=[];if(uo(n,(l,c)=>{const u=ho(c);if(function(d,f,p=Date.now()){return function(g,y){return g[y]||g.all||0}(d,f)>p}(i,u)){const d=Do(l,c);s.recordDroppedEvent("ratelimit_backoff",u,d)}else r.push(l)}),r.length===0)return ti({});const a=Mi(n[0],r),o=l=>{uo(a,(c,u)=>{const d=Do(c,u);s.recordDroppedEvent(l,ho(u),d)})};return t.add(()=>e({body:xh(a)}).then(l=>(l.statusCode!==void 0&&(l.statusCode<200||l.statusCode>=300)&&_e&&ne.warn(`Sentry responded with status code ${l.statusCode} to sent event.`),i=wh(i,l),l),l=>{throw o("network_error"),l})).then(l=>l,l=>{if(l instanceof ht)return _e&&ne.error("Skipped sending event because buffer is full."),o("queue_overflow"),ti({});throw l})},flush:n=>t.drain(n)}}function Do(s,e){if(e==="event"||e==="transaction")return Array.isArray(s)?s[1]:void 0}const jh=100;function ii(s,e){const t=je(),i=vo();if(!t)return;const{beforeBreadcrumb:n=null,maxBreadcrumbs:r=jh}=t.getOptions();if(r<=0)return;const a={timestamp:Di(),...s},o=n?_n(()=>n(a,e)):a;o!==null&&(t.emit&&t.emit("beforeAddBreadcrumb",o,e),i.addBreadcrumb(o,r))}let Oo;const Mo=new WeakMap,Gh=()=>({name:"FunctionToString",setupOnce(){Oo=Function.prototype.toString;try{Function.prototype.toString=function(...s){const e=xn(this),t=Mo.has(je())&&e!==void 0?e:this;return Oo.apply(t,s)}}catch{}},setup(s){Mo.set(s,!0)}}),Vh=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/,/^ResizeObserver loop completed with undelivered notifications.$/,/^Cannot redefine property: googletag$/,"undefined is not an object (evaluating 'a.L')",`can't redefine non-configurable property "solana"`,"vv().getRestrictions is not a function. (In 'vv().getRestrictions(1,a)', 'vv().getRestrictions' is undefined)","Can't find variable: _AutofillCallbackHandler"],qh=(s={})=>({name:"InboundFilters",processEvent(e,t,i){const n=i.getOptions(),r=function(a={},o={}){return{allowUrls:[...a.allowUrls||[],...o.allowUrls||[]],denyUrls:[...a.denyUrls||[],...o.denyUrls||[]],ignoreErrors:[...a.ignoreErrors||[],...o.ignoreErrors||[],...a.disableErrorDefaults?[]:Vh],ignoreTransactions:[...a.ignoreTransactions||[],...o.ignoreTransactions||[]],ignoreInternal:a.ignoreInternal===void 0||a.ignoreInternal}}(s,n);return function(a,o){return o.ignoreInternal&&function(l){try{return l.exception.values[0].type==="SentryError"}catch{}return!1}(a)?(_e&&ne.warn(`Event dropped due to being internal Sentry Error.
Event: ${Nt(a)}`),!0):function(l,c){return l.type||!c||!c.length?!1:function(u){const d=[];u.message&&d.push(u.message);let f;try{f=u.exception.values[u.exception.values.length-1]}catch{}return f&&f.value&&(d.push(f.value),f.type&&d.push(`${f.type}: ${f.value}`)),d}(l).some(u=>ds(u,c))}(a,o.ignoreErrors)?(_e&&ne.warn(`Event dropped due to being matched by \`ignoreErrors\` option.
Event: ${Nt(a)}`),!0):function(l){return l.type||!l.exception||!l.exception.values||l.exception.values.length===0?!1:!l.message&&!l.exception.values.some(c=>c.stacktrace||c.type&&c.type!=="Error"||c.value)}(a)?(_e&&ne.warn(`Event dropped due to not having an error message, error type or stacktrace.
Event: ${Nt(a)}`),!0):function(l,c){if(l.type!=="transaction"||!c||!c.length)return!1;const u=l.transaction;return!!u&&ds(u,c)}(a,o.ignoreTransactions)?(_e&&ne.warn(`Event dropped due to being matched by \`ignoreTransactions\` option.
Event: ${Nt(a)}`),!0):function(l,c){if(!c||!c.length)return!1;const u=_s(l);return!!u&&ds(u,c)}(a,o.denyUrls)?(_e&&ne.warn(`Event dropped due to being matched by \`denyUrls\` option.
Event: ${Nt(a)}.
Url: ${_s(a)}`),!0):function(l,c){if(!c||!c.length)return!0;const u=_s(l);return!u||ds(u,c)}(a,o.allowUrls)?!1:(_e&&ne.warn(`Event dropped due to not being matched by \`allowUrls\` option.
Event: ${Nt(a)}.
Url: ${_s(a)}`),!0)}(e,r)?null:e}});function _s(s){try{let e;try{e=s.exception.values[0].stacktrace.frames}catch{}return e?function(t=[]){for(let i=t.length-1;i>=0;i--){const n=t[i];if(n&&n.filename!=="<anonymous>"&&n.filename!=="[native code]")return n.filename||null}return null}(e):null}catch{return _e&&ne.error(`Cannot extract url for event ${Nt(s)}`),null}}const Hh=()=>{let s;return{name:"Dedupe",processEvent(e){if(e.type)return e;try{if(function(t,i){return i?!!(function(n,r){const a=n.message,o=r.message;return!(!a&&!o||a&&!o||!a&&o||a!==o||!No(n,r)||!Fo(n,r))}(t,i)||function(n,r){const a=Uo(r),o=Uo(n);return!(!a||!o||a.type!==o.type||a.value!==o.value||!No(n,r)||!Fo(n,r))}(t,i)):!1}(e,s))return _e&&ne.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{}return s=e}}};function Fo(s,e){let t=so(s),i=so(e);if(!t&&!i)return!0;if(t&&!i||!t&&i||i.length!==t.length)return!1;for(let n=0;n<i.length;n++){const r=i[n],a=t[n];if(r.filename!==a.filename||r.lineno!==a.lineno||r.colno!==a.colno||r.function!==a.function)return!1}return!0}function No(s,e){let t=s.fingerprint,i=e.fingerprint;if(!t&&!i)return!0;if(t&&!i||!t&&i)return!1;try{return t.join("")===i.join("")}catch{return!1}}function Uo(s){return s.exception&&s.exception.values&&s.exception.values[0]}const De=pe;let $n=0;function Bo(){return $n>0}function mi(s,e={},t){if(typeof s!="function")return s;try{const n=s.__sentry_wrapped__;if(n)return typeof n=="function"?n:s;if(xn(s))return s}catch{return s}const i=function(){const n=Array.prototype.slice.call(arguments);try{t&&typeof t=="function"&&t.apply(this,arguments);const r=n.map(a=>mi(a,e));return s.apply(this,r)}catch(r){throw $n++,setTimeout(()=>{$n--}),function(...a){const o=Nn(Ts());if(a.length===2){const[l,c]=a;return l?o.withSetScope(l,c):o.withScope(c)}o.withScope(a[0])}(a=>{var o;a.addEventProcessor(l=>(e.mechanism&&(kn(l,void 0),Oi(l,e.mechanism)),l.extra={...l.extra,arguments:n},l)),o=r,Un().captureException(o,void 0)}),r}};try{for(const n in s)Object.prototype.hasOwnProperty.call(s,n)&&(i[n]=s[n])}catch{}Ja(i,s),Qt(s,"__sentry_wrapped__",i);try{Object.getOwnPropertyDescriptor(i,"name").configurable&&Object.defineProperty(i,"name",{get:()=>s.name})}catch{}return i}const jn=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__;function Gn(s,e){const t=qn(s,e),i={type:e&&e.name,value:Wh(e)};return t.length&&(i.stacktrace={frames:t}),i.type===void 0&&i.value===""&&(i.value="Unrecoverable error caught"),i}function Kh(s,e,t,i){const n=je(),r=n&&n.getOptions().normalizeDepth,a=function(c){for(const u in c)if(Object.prototype.hasOwnProperty.call(c,u)){const d=c[u];if(d instanceof Error)return d}}(e),o={__serialized__:lo(e,r)};if(a)return{exception:{values:[Gn(s,a)]},extra:o};const l={exception:{values:[{type:cs(e)?e.constructor.name:i?"UnhandledRejection":"Error",value:zh(e,{isUnhandledRejection:i})}]},extra:o};if(t){const c=qn(s,t);c.length&&(l.exception.values[0].stacktrace={frames:c})}return l}function Vn(s,e){return{exception:{values:[Gn(s,e)]}}}function qn(s,e){const t=e.stacktrace||e.stack||"",i=function(r){return r&&Yh.test(r.message)?1:0}(e),n=function(r){return typeof r.framesToPop=="number"?r.framesToPop:0}(e);try{return s(t,i,n)}catch{}return[]}const Yh=/Minified React error #\d+;/i;function Wh(s){const e=s&&s.message;return e?e.error&&typeof e.error.message=="string"?e.error.message:e:"No error message"}function Hn(s,e,t,i,n){let r;if(ja(e)&&e.error)return Vn(s,e.error);if(Ga(e)||hi(e,"DOMException")){const a=e;if("stack"in e)r=Vn(s,e);else{const o=a.name||(Ga(a)?"DOMError":"DOMException"),l=a.message?`${o}: ${a.message}`:o;r=Kn(s,l,t,i),kn(r,l)}return"code"in a&&(r.tags={...r.tags,"DOMException.code":`${a.code}`}),r}return yn(e)?Vn(s,e):fi(e)||cs(e)?(r=Kh(s,e,t,n),Oi(r,{synthetic:!0}),r):(r=Kn(s,e,t,i),kn(r,`${e}`),Oi(r,{synthetic:!0}),r)}function Kn(s,e,t,i){const n={};if(i&&t){const r=qn(s,t);r.length&&(n.exception={values:[{value:e,stacktrace:{frames:r}}]})}if(vn(e)){const{__sentry_template_string__:r,__sentry_template_values__:a}=e;return n.logentry={message:r,params:a},n}return n.message=e,n}function zh(s,{isUnhandledRejection:e}){const t=function(n,r=40){const a=Object.keys(Qa(n));a.sort();const o=a[0];if(!o)return"[object has no keys]";if(o.length>=r)return pi(o,r);for(let l=a.length;l>0;l--){const c=a.slice(0,l).join(", ");if(!(c.length>r))return l===a.length?c:pi(c,r)}return""}(s),i=e?"promise rejection":"exception";return ja(s)?`Event \`ErrorEvent\` captured as ${i} with message \`${s.message}\``:cs(s)?`Event \`${function(n){try{const r=Object.getPrototypeOf(n);return r?r.constructor.name:void 0}catch{}}(s)}\` (type=${s.type}) captured as ${i}`:`Object captured as ${i} with keys: ${t}`}class Jh extends Bh{constructor(e){const t={parentSpanIsAlwaysRootSpan:!0,...e};(function(i,n,r=[n],a="npm"){const o=i._metadata||{};o.sdk||(o.sdk={name:`sentry.javascript.${n}`,packages:r.map(l=>({name:`${a}:@sentry/${l}`,version:Jt})),version:Jt}),i._metadata=o})(t,"browser",["browser"],De.SENTRY_SDK_SOURCE||"npm"),super(t),t.sendClientReports&&De.document&&De.document.addEventListener("visibilitychange",()=>{De.document.visibilityState==="hidden"&&this._flushOutcomes()})}eventFromException(e,t){return function(i,n,r,a){const o=Hn(i,n,r&&r.syntheticException||void 0,a);return Oi(o),o.level="error",r&&r.event_id&&(o.event_id=r.event_id),ti(o)}(this._options.stackParser,e,t,this._options.attachStacktrace)}eventFromMessage(e,t="info",i){return function(n,r,a="info",o,l){const c=Kn(n,r,o&&o.syntheticException||void 0,l);return c.level=a,o&&o.event_id&&(c.event_id=o.event_id),ti(c)}(this._options.stackParser,e,t,i,this._options.attachStacktrace)}captureUserFeedback(e){if(!this._isEnabled())return void(jn&&ne.warn("SDK not enabled, will not capture user feedback."));const t=function(i,{metadata:n,tunnel:r,dsn:a}){const o={event_id:i.event_id,sent_at:new Date().toISOString(),...n&&n.sdk&&{sdk:{name:n.sdk.name,version:n.sdk.version}},...!!r&&!!a&&{dsn:ps(a)}};return Mi(o,[function(c){return[{type:"user_report"},c]}(i)])}(e,{metadata:this.getSdkMetadata(),dsn:this.getDsn(),tunnel:this.getOptions().tunnel});this.sendEnvelope(t)}_prepareEvent(e,t,i){return e.platform=e.platform||"javascript",super._prepareEvent(e,t,i)}}const Qh=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,Me=pe;let $o,Yn,Wn,xs;function Xh(){if(!Me.document)return;const s=at.bind(null,"dom"),e=jo(s,!0);Me.document.addEventListener("click",e,!1),Me.document.addEventListener("keypress",e,!1),["EventTarget","Node"].forEach(t=>{const i=Me[t]&&Me[t].prototype;i&&i.hasOwnProperty&&i.hasOwnProperty("addEventListener")&&(qe(i,"addEventListener",function(n){return function(r,a,o){if(r==="click"||r=="keypress")try{const l=this,c=l.__sentry_instrumentation_handlers__=l.__sentry_instrumentation_handlers__||{},u=c[r]=c[r]||{refCount:0};if(!u.handler){const d=jo(s);u.handler=d,n.call(this,r,d,o)}u.refCount++}catch{}return n.call(this,r,a,o)}}),qe(i,"removeEventListener",function(n){return function(r,a,o){if(r==="click"||r=="keypress")try{const l=this,c=l.__sentry_instrumentation_handlers__||{},u=c[r];u&&(u.refCount--,u.refCount<=0&&(n.call(this,r,u.handler,o),u.handler=void 0,delete c[r]),Object.keys(c).length===0&&delete l.__sentry_instrumentation_handlers__)}catch{}return n.call(this,r,a,o)}}))})}function jo(s,e=!1){return t=>{if(!t||t._sentryCaptured)return;const i=function(r){try{return r.target}catch{return null}}(t);if(function(r,a){return r==="keypress"&&(!a||!a.tagName||a.tagName!=="INPUT"&&a.tagName!=="TEXTAREA"&&!a.isContentEditable)}(t.type,i))return;Qt(t,"_sentryCaptured",!0),i&&!i._sentryId&&Qt(i,"_sentryId",ot());const n=t.type==="keypress"?"input":t.type;(function(r){if(r.type!==Yn)return!1;try{if(!r.target||r.target._sentryId!==Wn)return!1}catch{}return!0})(t)||(s({event:t,name:n,global:e}),Yn=t.type,Wn=i?i._sentryId:void 0),clearTimeout($o),$o=Me.setTimeout(()=>{Wn=void 0,Yn=void 0},1e3)}}function Zh(){if(!function(){const t=Es.chrome,i=t&&t.app&&t.app.runtime,n="history"in Es&&!!Es.history.pushState&&!!Es.history.replaceState;return!i&&n}())return;const s=Me.onpopstate;function e(t){return function(...i){const n=i.length>2?i[2]:void 0;if(n){const r=xs,a=String(n);xs=a,at("history",{from:r,to:a})}return t.apply(this,i)}}Me.onpopstate=function(...t){const i=Me.location.href,n=xs;if(xs=i,at("history",{from:n,to:i}),s)try{return s.apply(this,t)}catch{}},qe(Me.history,"pushState",e),qe(Me.history,"replaceState",e)}const As={};function Go(s){As[s]=void 0}const Ni="__sentry_xhr_v3__";function ef(){if(!Me.XMLHttpRequest)return;const s=XMLHttpRequest.prototype;s.open=new Proxy(s.open,{apply(e,t,i){const n=1e3*Ft(),r=At(i[0])?i[0].toUpperCase():void 0,a=function(l){if(At(l))return l;try{return l.toString()}catch{}}(i[1]);if(!r||!a)return e.apply(t,i);t[Ni]={method:r,url:a,request_headers:{}},r==="POST"&&a.match(/sentry_key/)&&(t.__sentry_own_request__=!0);const o=()=>{const l=t[Ni];if(l&&t.readyState===4){try{l.status_code=t.status}catch{}at("xhr",{endTimestamp:1e3*Ft(),startTimestamp:n,xhr:t})}};return"onreadystatechange"in t&&typeof t.onreadystatechange=="function"?t.onreadystatechange=new Proxy(t.onreadystatechange,{apply:(l,c,u)=>(o(),l.apply(c,u))}):t.addEventListener("readystatechange",o),t.setRequestHeader=new Proxy(t.setRequestHeader,{apply(l,c,u){const[d,f]=u,p=c[Ni];return p&&At(d)&&At(f)&&(p.request_headers[d.toLowerCase()]=f),l.apply(c,u)}}),e.apply(t,i)}}),s.send=new Proxy(s.send,{apply(e,t,i){const n=t[Ni];return n?(i[0]!==void 0&&(n.body=i[0]),at("xhr",{startTimestamp:1e3*Ft(),xhr:t}),e.apply(t,i)):e.apply(t,i)}})}function tf(s,e=function(t){const i=As[t];if(i)return i;let n=Me[t];if(wn(n))return As[t]=n.bind(Me);const r=Me.document;if(r&&typeof r.createElement=="function")try{const a=r.createElement("iframe");a.hidden=!0,r.head.appendChild(a);const o=a.contentWindow;o&&o[t]&&(n=o[t]),r.head.removeChild(a)}catch(a){Qh&&ne.warn(`Could not create sandbox iframe for ${t} check, bailing to window.${t}: `,a)}return n&&(As[t]=n.bind(Me))}("fetch")){let t=0,i=0;return $h(s,function(n){const r=n.body.length;t+=r,i++;const a={body:n.body,method:"POST",referrerPolicy:"origin",headers:s.headers,keepalive:t<=6e4&&i<15,...s.fetchOptions};if(!e)return Go("fetch"),Ss("No fetch implementation available");try{return e(s.url,a).then(o=>(t-=r,i--,{statusCode:o.status,headers:{"x-sentry-rate-limits":o.headers.get("X-Sentry-Rate-Limits"),"retry-after":o.headers.get("Retry-After")}}))}catch(o){return Go("fetch"),t-=r,i--,Ss(o)}})}function zn(s,e,t,i){const n={filename:s,function:e==="<anonymous>"?Xt:e,in_app:!0};return t!==void 0&&(n.lineno=t),i!==void 0&&(n.colno=i),n}const sf=/^\s*at (\S+?)(?::(\d+))(?::(\d+))\s*$/i,nf=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,rf=/\((\S*)(?::(\d+))(?::(\d+))\)/,af=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,of=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,lf=function(...s){const e=s.sort((t,i)=>t[0]-i[0]).map(t=>t[1]);return(t,i=0,n=0)=>{const r=[],a=t.split(`
`);for(let o=i;o<a.length;o++){const l=a[o];if(l.length>1024)continue;const c=eo.test(l)?l.replace(eo,"$1"):l;if(!c.match(/\S*Error: /)){for(const u of e){const d=u(c);if(d){r.push(d);break}}if(r.length>=50+n)break}}return function(o){if(!o.length)return[];const l=Array.from(o);return/sentryWrapped/.test(gs(l).function||"")&&l.pop(),l.reverse(),to.test(gs(l).function||"")&&(l.pop(),to.test(gs(l).function||"")&&l.pop()),l.slice(0,50).map(c=>({...c,filename:c.filename||gs(l).filename,function:c.function||Xt}))}(r.slice(n))}}([30,s=>{const e=sf.exec(s);if(e){const[,i,n,r]=e;return zn(i,Xt,+n,+r)}const t=nf.exec(s);if(t){if(t[2]&&t[2].indexOf("eval")===0){const r=rf.exec(t[2]);r&&(t[2]=r[1],t[3]=r[2],t[4]=r[3])}const[i,n]=Vo(t[1]||Xt,t[2]);return zn(n,i,t[3]?+t[3]:void 0,t[4]?+t[4]:void 0)}}],[50,s=>{const e=af.exec(s);if(e){if(e[3]&&e[3].indexOf(" > eval")>-1){const n=of.exec(e[3]);n&&(e[1]=e[1]||"eval",e[3]=n[1],e[4]=n[2],e[5]="")}let t=e[3],i=e[1]||Xt;return[i,t]=Vo(i,t),zn(t,i,e[4]?+e[4]:void 0,e[5]?+e[5]:void 0)}}]),Vo=(s,e)=>{const t=s.indexOf("safari-extension")!==-1,i=s.indexOf("safari-web-extension")!==-1;return t||i?[s.indexOf("@")!==-1?s.split("@")[0]:Xt,t?`safari-extension:${e}`:`safari-web-extension:${e}`]:[s,e]},qo=1024,cf=(s={})=>{const e={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...s};return{name:"Breadcrumbs",setup(t){var i;e.console&&function(n){const r="console";Zt(r,n),ei(r,fh)}(function(n){return function(r){if(je()!==n)return;const a={category:"console",data:{arguments:r.args,logger:"console"},level:Eh(r.level),message:qa(r.args," ")};if(r.level==="assert"){if(r.args[0]!==!1)return;a.message=`Assertion failed: ${qa(r.args.slice(1)," ")||"console.assert"}`,a.data.arguments=r.args.slice(1)}ii(a,{input:r.args,level:r.level})}}(t)),e.dom&&(i=function(n,r){return function(a){if(je()!==n)return;let o,l,c=typeof r=="object"?r.serializeAttribute:void 0,u=typeof r=="object"&&typeof r.maxStringLength=="number"?r.maxStringLength:void 0;u&&u>qo&&(jn&&ne.warn(`\`dom.maxStringLength\` cannot exceed 1024, but a value of ${u} was configured. Sentry will use 1024 instead.`),u=qo),typeof c=="string"&&(c=[c]);try{const f=a.event,p=function(g){return!!g&&!!g.target}(f)?f.target:f;o=Wa(p,{keyAttrs:c,maxStringLength:u}),l=function(g){if(!Tn.HTMLElement)return null;let y=g;for(let S=0;S<5;S++){if(!y)return null;if(y instanceof HTMLElement){if(y.dataset.sentryComponent)return y.dataset.sentryComponent;if(y.dataset.sentryElement)return y.dataset.sentryElement}y=y.parentNode}return null}(p)}catch{o="<unknown>"}if(o.length===0)return;const d={category:`ui.${a.name}`,message:o};l&&(d.data={"ui.component_name":l}),ii(d,{event:a.event,name:a.name,global:a.global})}}(t,e.dom),Zt("dom",i),ei("dom",Xh)),e.xhr&&function(n){Zt("xhr",n),ei("xhr",ef)}(function(n){return function(r){if(je()!==n)return;const{startTimestamp:a,endTimestamp:o}=r,l=r.xhr[Ni];if(!a||!o||!l)return;const{method:c,url:u,status_code:d,body:f}=l,p={method:c,url:u,status_code:d},g={xhr:r.xhr,input:f,startTimestamp:a,endTimestamp:o};ii({category:"xhr",data:p,type:"http",level:Ya(d)},g)}}(t)),e.fetch&&gh(function(n){return function(r){if(je()!==n)return;const{startTimestamp:a,endTimestamp:o}=r;if(o&&(!r.fetchData.url.match(/sentry_key/)||r.fetchData.method!=="POST"))if(r.error)ii({category:"fetch",data:r.fetchData,level:"error",type:"http"},{data:r.error,input:r.args,startTimestamp:a,endTimestamp:o});else{const l=r.response,c={...r.fetchData,status_code:l&&l.status},u={input:r.args,response:l,startTimestamp:a,endTimestamp:o};ii({category:"fetch",data:c,type:"http",level:Ya(c.status_code)},u)}}}(t)),e.history&&function(n){const r="history";Zt(r,n),ei(r,Zh)}(function(n){return function(r){if(je()!==n)return;let a=r.from,o=r.to;const l=Rn(De.location.href);let c=a?Rn(a):void 0;const u=Rn(o);c&&c.path||(c=l),l.protocol===u.protocol&&l.host===u.host&&(o=u.relative),l.protocol===c.protocol&&l.host===c.host&&(a=c.relative),ii({category:"navigation",data:{from:a,to:o}})}}(t)),e.sentry&&t.on("beforeSendEvent",function(n){return function(r){je()===n&&ii({category:"sentry."+(r.type==="transaction"?"transaction":"event"),event_id:r.event_id,level:r.level,message:Nt(r)},{event:r})}}(t))}}},uf=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","BroadcastChannel","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","SharedWorker","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],df=(s={})=>{const e={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,...s};return{name:"BrowserApiErrors",setupOnce(){e.setTimeout&&qe(De,"setTimeout",Ho),e.setInterval&&qe(De,"setInterval",Ho),e.requestAnimationFrame&&qe(De,"requestAnimationFrame",hf),e.XMLHttpRequest&&"XMLHttpRequest"in De&&qe(XMLHttpRequest.prototype,"send",ff);const t=e.eventTarget;t&&(Array.isArray(t)?t:uf).forEach(pf)}}};function Ho(s){return function(...e){const t=e[0];return e[0]=mi(t,{mechanism:{data:{function:Mt(s)},handled:!1,type:"instrument"}}),s.apply(this,e)}}function hf(s){return function(e){return s.apply(this,[mi(e,{mechanism:{data:{function:"requestAnimationFrame",handler:Mt(s)},handled:!1,type:"instrument"}})])}}function ff(s){return function(...e){const t=this;return["onload","onerror","onprogress","onreadystatechange"].forEach(i=>{i in t&&typeof t[i]=="function"&&qe(t,i,function(n){const r={mechanism:{data:{function:i,handler:Mt(n)},handled:!1,type:"instrument"}},a=xn(n);return a&&(r.mechanism.data.handler=Mt(a)),mi(n,r)})}),s.apply(this,e)}}function pf(s){const e=De,t=e[s]&&e[s].prototype;t&&t.hasOwnProperty&&t.hasOwnProperty("addEventListener")&&(qe(t,"addEventListener",function(i){return function(n,r,a){try{typeof r.handleEvent=="function"&&(r.handleEvent=mi(r.handleEvent,{mechanism:{data:{function:"handleEvent",handler:Mt(r),target:s},handled:!1,type:"instrument"}}))}catch{}return i.apply(this,[n,mi(r,{mechanism:{data:{function:"addEventListener",handler:Mt(r),target:s},handled:!1,type:"instrument"}}),a])}}),qe(t,"removeEventListener",function(i){return function(n,r,a){const o=r;try{const l=o&&o.__sentry_wrapped__;l&&i.call(this,n,l,a)}catch{}return i.call(this,n,o,a)}}))}const gf=(s={})=>{const e={onerror:!0,onunhandledrejection:!0,...s};return{name:"GlobalHandlers",setupOnce(){Error.stackTraceLimit=50},setup(t){e.onerror&&(function(i){(function(n){const r="error";Zt(r,n),ei(r,mh)})(n=>{const{stackParser:r,attachStacktrace:a}=Yo();if(je()!==i||Bo())return;const{msg:o,url:l,line:c,column:u,error:d}=n,f=function(p,g,y,S){const T=p.exception=p.exception||{},L=T.values=T.values||[],w=L[0]=L[0]||{},x=w.stacktrace=w.stacktrace||{},b=x.frames=x.frames||[],C=isNaN(parseInt(S,10))?void 0:S,_=isNaN(parseInt(y,10))?void 0:y,k=At(g)&&g.length>0?g:function(){try{return Tn.document.location.href}catch{return""}}();return b.length===0&&b.push({colno:C,filename:k,function:Xt,in_app:!0,lineno:_}),p}(Hn(r,d||o,void 0,a,!1),l,c,u);f.level="error",Io(f,{originalException:d,mechanism:{handled:!1,type:"onerror"}})})}(t),Ko("onerror")),e.onunhandledrejection&&(function(i){(function(n){const r="unhandledrejection";Zt(r,n),ei(r,yh)})(n=>{const{stackParser:r,attachStacktrace:a}=Yo();if(je()!==i||Bo())return;const o=function(c){if(Sn(c))return c;try{if("reason"in c)return c.reason;if("detail"in c&&"reason"in c.detail)return c.detail.reason}catch{}return c}(n),l=Sn(o)?{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(o)}`}]}}:Hn(r,o,void 0,a,!0);l.level="error",Io(l,{originalException:o,mechanism:{handled:!1,type:"onunhandledrejection"}})})}(t),Ko("onunhandledrejection"))}}};function Ko(s){jn&&ne.log(`Global Handler attached: ${s}`)}function Yo(){const s=je();return s&&s.getOptions()||{stackParser:()=>[],attachStacktrace:!1}}const mf=()=>({name:"HttpContext",preprocessEvent(s){if(!De.navigator&&!De.location&&!De.document)return;const e=s.request&&s.request.url||De.location&&De.location.href,{referrer:t}=De.document||{},{userAgent:i}=De.navigator||{},n={...s.request&&s.request.headers,...t&&{Referer:t},...i&&{"User-Agent":i}},r={...s.request,...e&&{url:e},headers:n};s.request=r}}),yf=(s={})=>{const e=s.limit||5,t=s.key||"cause";return{name:"LinkedErrors",preprocessEvent(i,n,r){const a=r.getOptions();ch(Gn,a.stackParser,a.maxValueLength,t,e,i,n)}}};var Jn="new",Wo="loading",zo="loaded",Is="joining-meeting",$t="joined-meeting",jt="left-meeting",wt="error",vf="blocked",Sf="off",Ef="sendable",Tf="loading",bf="interrupted",Jo="playable",ws="unknown",Qo="full",_f="lobby",xf="none",Xo="base",Af="*",If="ejected",wf="nbf-room",Lf="nbf-token",kf="exp-room",Cf="exp-token",Qn="no-room",Rf="meeting-full",Zo="end-of-life",Pf="not-allowed",el="connection-error",Df="cam-in-use",Of="mic-in-use",Mf="cam-mic-in-use",Ff="permissions",Nf="undefined-mediadevices",Uf="not-found",Bf="constraints",$f="unknown",tl="iframe-ready-for-launch-config",il="iframe-launch-config",sl="theme-updated",nl="loading",rl="load-attempt-failed",Xn="loaded",al="started-camera",ol="camera-error",ll="joining-meeting",cl="joined-meeting",ul="left-meeting",dl="participant-joined",hl="participant-updated",fl="participant-left",pl="participant-counts-updated",gl="access-state-updated",ml="meeting-session-summary-updated",yl="meeting-session-state-updated",jf="meeting-session-data-error",vl="waiting-participant-added",Sl="waiting-participant-updated",El="waiting-participant-removed",Tl="track-started",bl="track-stopped",_l="transcription-started",xl="transcription-stopped",Al="transcription-error",Zn="recording-started",er="recording-stopped",Il="recording-stats",wl="recording-error",Ll="recording-upload-completed",kl="recording-data",Cl="app-message",Rl="transcription-message",Pl="remote-media-player-started",Dl="remote-media-player-updated",Ol="remote-media-player-stopped",Ml="local-screen-share-started",Fl="local-screen-share-stopped",Nl="local-screen-share-canceled",Ul="active-speaker-change",Bl="active-speaker-mode-change",$l="network-quality-change",jl="network-connection",Gl="cpu-load-change",Vl="face-counts-updated",Ui="fullscreen",Bi="exited-fullscreen",ql="live-streaming-started",Hl="live-streaming-updated",Kl="live-streaming-stopped",Yl="live-streaming-error",Wl="lang-updated",zl="receive-settings-updated",tr="input-settings-updated",ir="nonfatal-error",sr="error",nr=4096,Jl=102400,rr="iframe-call-message",Ql="local-screen-start",Xl="daily-method-update-live-streaming-endpoints",Ls="transmit-log",Lt="daily-custom-track",ks={NONE:"none",BGBLUR:"background-blur",BGIMAGE:"background-image",FACE_DETECTION:"face-detection"},Zl={NONE:"none",NOISE_CANCELLATION:"noise-cancellation"},ar={PLAY:"play",PAUSE:"pause"},or=["jpg","png","jpeg"],Gf="add-endpoints",Vf="remove-endpoints",ec="sip-call-transfer";function Je(){return!de()&&typeof window<"u"&&window.navigator&&window.navigator.userAgent?window.navigator.userAgent:""}function de(){return typeof navigator<"u"&&navigator.product&&navigator.product==="ReactNative"}function tc(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia}function qf(){return!!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)&&(function(s,e){if(!s||!e)return!0;switch(s){case"Chrome":return e.major>=75;case"Safari":return RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection")&&!(e.major===13&&e.minor===0&&e.point===0);case"Firefox":return e.major>=67}return!0}(si(),Cs())||de())}function ic(){if(de()||!document)return!1;var s=document.createElement("iframe");return!!s.requestFullscreen||!!s.webkitRequestFullscreen}var Hf=function(){try{var s=document.createElement("canvas"),e=s.getContext("webgl2")!=null;return s.remove(),e}catch{return!1}}();function sc(){var s=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return!de()&&!!Hf&&(s?function(){return oc()?!1:["Chrome","Firefox"].includes(si())}():function(){if(oc())return!1;var e=si();if(e==="Safari"){var t=cr();if(t.major<15||t.major===15&&t.minor<4)return!1}return e==="Chrome"?lr().major>=77:e==="Firefox"?ur().major>=97:["Chrome","Firefox","Safari"].includes(e)}())}function nc(){if(de()||ac()||typeof AudioWorkletNode>"u")return!1;switch(si()){case"Chrome":case"Firefox":return!0;case"Safari":var s=Cs();return s.major>17||s.major===17&&s.minor>=4}return!1}function rc(){return tc()&&!function(){var s,e=si();if(!Je())return!0;switch(e){case"Chrome":return(s=lr()).major&&s.major>0&&s.major<75;case"Firefox":return(s=ur()).major<91;case"Safari":return(s=cr()).major<13||s.major===13&&s.minor<1;default:return!0}}()}function ac(){return Je().match(/Linux; Android/)}function oc(){var s,e,t=Je(),i=t.match(/Mac/)&&(!de()&&typeof window<"u"&&(s=window)!==null&&s!==void 0&&(e=s.navigator)!==null&&e!==void 0&&e.maxTouchPoints?window.navigator.maxTouchPoints:0)>=5;return!!(t.match(/Mobi/)||t.match(/Android/)||i)||!!Je().match(/DailyAnd\//)||void 0}function si(){if(typeof window<"u"){var s=Je();return lc()?"Safari":s.indexOf("Edge")>-1?"Edge":s.match(/Chrome\//)?"Chrome":s.indexOf("Safari")>-1||cc()?"Safari":s.indexOf("Firefox")>-1?"Firefox":s.indexOf("MSIE")>-1||s.indexOf(".NET")>-1?"IE":"Unknown Browser"}}function Cs(){switch(si()){case"Chrome":return lr();case"Safari":return cr();case"Firefox":return ur();case"Edge":return function(){var s=0,e=0;if(typeof window<"u"){var t=Je().match(/Edge\/(\d+).(\d+)/);if(t)try{s=parseInt(t[1]),e=parseInt(t[2])}catch{}}return{major:s,minor:e}}()}}function lr(){var s=0,e=0,t=0,i=0,n=!1;if(typeof window<"u"){var r=Je(),a=r.match(/Chrome\/(\d+).(\d+).(\d+).(\d+)/);if(a)try{s=parseInt(a[1]),e=parseInt(a[2]),t=parseInt(a[3]),i=parseInt(a[4]),n=r.indexOf("OPR/")>-1}catch{}}return{major:s,minor:e,build:t,patch:i,opera:n}}function lc(){return!!Je().match(/iPad|iPhone|iPod/i)&&tc()}function cc(){return Je().indexOf("AppleWebKit/605.1.15")>-1}function cr(){var s=0,e=0,t=0;if(typeof window<"u"){var i=Je().match(/Version\/(\d+).(\d+)(.(\d+))?/);if(i)try{s=parseInt(i[1]),e=parseInt(i[2]),t=parseInt(i[4])}catch{}else(lc()||cc())&&(s=14,e=0,t=3)}return{major:s,minor:e,point:t}}function ur(){var s=0,e=0;if(typeof window<"u"){var t=Je().match(/Firefox\/(\d+).(\d+)/);if(t)try{s=parseInt(t[1]),e=parseInt(t[2])}catch{}}return{major:s,minor:e}}var uc=function(){function s(){it(this,s)}return st(s,[{key:"addListenerForMessagesFromCallMachine",value:function(e,t,i){Ri()}},{key:"addListenerForMessagesFromDailyJs",value:function(e,t,i){Ri()}},{key:"sendMessageToCallMachine",value:function(e,t,i,n){Ri()}},{key:"sendMessageToDailyJs",value:function(e,t){Ri()}},{key:"removeListener",value:function(e){Ri()}}]),s}();function dc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function dr(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?dc(Object(t),!0).forEach(function(i){_t(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):dc(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}function Kf(s){var e=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}();return function(){var t,i=nt(s);if(e){var n=nt(this).constructor;t=Reflect.construct(i,arguments,n)}else t=i.apply(this,arguments);return ns(this,t)}}var Yf=function(){ss(e,uc);var s=Kf(e);function e(){var t;return it(this,e),(t=s.call(this))._wrappedListeners={},t._messageCallbacks={},t}return st(e,[{key:"addListenerForMessagesFromCallMachine",value:function(t,i,n){var r=this,a=function(o){if(o.data&&o.data.what==="iframe-call-message"&&(!o.data.callClientId||o.data.callClientId===i)&&(!o.data.from||o.data.from!=="module")){var l=dr({},o.data);if(delete l.from,l.callbackStamp&&r._messageCallbacks[l.callbackStamp]){var c=l.callbackStamp;r._messageCallbacks[c].call(n,l),delete r._messageCallbacks[c]}delete l.what,delete l.callbackStamp,t.call(n,l)}};this._wrappedListeners[t]=a,window.addEventListener("message",a)}},{key:"addListenerForMessagesFromDailyJs",value:function(t,i,n){var r=function(a){var o;if(!(!a.data||a.data.what!==rr||!a.data.action||a.data.from&&a.data.from!=="module"||a.data.callClientId&&i&&a.data.callClientId!==i||a!=null&&(o=a.data)!==null&&o!==void 0&&o.callFrameId)){var l=a.data;t.call(n,l)}};this._wrappedListeners[t]=r,window.addEventListener("message",r)}},{key:"sendMessageToCallMachine",value:function(t,i,n,r){if(!n)throw new Error("undefined callClientId. Are you trying to use a DailyCall instance previously destroyed?");var a=dr({},t);if(a.what=rr,a.from="module",a.callClientId=n,i){var o=as();this._messageCallbacks[o]=i,a.callbackStamp=o}var l=r?r.contentWindow:window,c=this._callMachineTargetOrigin(r);c&&l.postMessage(a,c)}},{key:"sendMessageToDailyJs",value:function(t,i){t.what=rr,t.callClientId=i,t.from="embedded",window.postMessage(t,this._targetOriginFromWindowLocation())}},{key:"removeListener",value:function(t){var i=this._wrappedListeners[t];i&&(window.removeEventListener("message",i),delete this._wrappedListeners[t])}},{key:"forwardPackagedMessageToCallMachine",value:function(t,i,n){var r=dr({},t);r.callClientId=n;var a=i?i.contentWindow:window,o=this._callMachineTargetOrigin(i);o&&a.postMessage(r,o)}},{key:"addListenerForPackagedMessagesFromCallMachine",value:function(t,i){var n=function(r){if(r.data&&r.data.what==="iframe-call-message"&&(!r.data.callClientId||r.data.callClientId===i)&&(!r.data.from||r.data.from!=="module")){var a=r.data;t(a)}};return this._wrappedListeners[t]=n,window.addEventListener("message",n),t}},{key:"removeListenerForPackagedMessagesFromCallMachine",value:function(t){var i=this._wrappedListeners[t];i&&(window.removeEventListener("message",i),delete this._wrappedListeners[t])}},{key:"_callMachineTargetOrigin",value:function(t){return t?t.src?new URL(t.src).origin:void 0:this._targetOriginFromWindowLocation()}},{key:"_targetOriginFromWindowLocation",value:function(){return window.location.protocol==="file:"?"*":window.location.origin}}]),e}();function hc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function Wf(s){var e=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}();return function(){var t,i=nt(s);if(e){var n=nt(this).constructor;t=Reflect.construct(i,arguments,n)}else t=i.apply(this,arguments);return ns(this,t)}}var zf=function(){ss(e,uc);var s=Wf(e);function e(){var t;return it(this,e),t=s.call(this),global.callMachineToDailyJsEmitter=global.callMachineToDailyJsEmitter||new xt.EventEmitter,global.dailyJsToCallMachineEmitter=global.dailyJsToCallMachineEmitter||new xt.EventEmitter,t._wrappedListeners={},t._messageCallbacks={},t}return st(e,[{key:"addListenerForMessagesFromCallMachine",value:function(t,i,n){this._addListener(t,global.callMachineToDailyJsEmitter,i,n,"received call machine message")}},{key:"addListenerForMessagesFromDailyJs",value:function(t,i,n){this._addListener(t,global.dailyJsToCallMachineEmitter,i,n,"received daily-js message")}},{key:"sendMessageToCallMachine",value:function(t,i,n){this._sendMessage(t,global.dailyJsToCallMachineEmitter,n,i,"sending message to call machine")}},{key:"sendMessageToDailyJs",value:function(t,i){this._sendMessage(t,global.callMachineToDailyJsEmitter,i,null,"sending message to daily-js")}},{key:"removeListener",value:function(t){var i=this._wrappedListeners[t];i&&(global.callMachineToDailyJsEmitter.removeListener("message",i),global.dailyJsToCallMachineEmitter.removeListener("message",i),delete this._wrappedListeners[t])}},{key:"_addListener",value:function(t,i,n,r,a){var o=this,l=function(c){if(c.callClientId===n){if(c.callbackStamp&&o._messageCallbacks[c.callbackStamp]){var u=c.callbackStamp;o._messageCallbacks[u].call(r,c),delete o._messageCallbacks[u]}t.call(r,c)}};this._wrappedListeners[t]=l,i.addListener("message",l)}},{key:"_sendMessage",value:function(t,i,n,r,a){var o=function(c){for(var u=1;u<arguments.length;u++){var d=arguments[u]!=null?arguments[u]:{};u%2?hc(Object(d),!0).forEach(function(f){_t(c,f,d[f])}):Object.getOwnPropertyDescriptors?Object.defineProperties(c,Object.getOwnPropertyDescriptors(d)):hc(Object(d)).forEach(function(f){Object.defineProperty(c,f,Object.getOwnPropertyDescriptor(d,f))})}return c}({},t);if(o.callClientId=n,r){var l=as();this._messageCallbacks[l]=r,o.callbackStamp=l}i.emit("message",o)}}]),e}(),hr="replace",fr="shallow-merge",fc=[hr,fr],Jf=function(){function s(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e.data,i=e.mergeStrategy,n=i===void 0?hr:i;it(this,s),s._validateMergeStrategy(n),s._validateData(t,n),this.mergeStrategy=n,this.data=t}return st(s,[{key:"isNoOp",value:function(){return s.isNoOpUpdate(this.data,this.mergeStrategy)}}],[{key:"isNoOpUpdate",value:function(e,t){return Object.keys(e).length===0&&t===fr}},{key:"_validateMergeStrategy",value:function(e){if(!fc.includes(e))throw Error("Unrecognized mergeStrategy provided. Options are: [".concat(fc,"]"))}},{key:"_validateData",value:function(e,t){if(!function(o){if(o==null||me(o)!=="object")return!1;var l=Object.getPrototypeOf(o);return l==null||l===Object.prototype}(e))throw Error("Meeting session data must be a plain (map-like) object");var i;try{if(i=JSON.stringify(e),t===hr){var n=JSON.parse(i);$e(n,e)||console.warn("The meeting session data provided will be modified when serialized.",n,e)}else if(t===fr){for(var r in e)if(Object.hasOwnProperty.call(e,r)&&e[r]!==void 0){var a=JSON.parse(JSON.stringify(e[r]));$e(e[r],a)||console.warn("At least one key in the meeting session data provided will be modified when serialized.",a,e[r])}}}catch(o){throw Error("Meeting session data must be serializable to JSON: ".concat(o))}if(i.length>Jl)throw Error("Meeting session data is too large (".concat(i.length," characters). Maximum size suppported is ").concat(Jl,"."))}}]),s}();function pr(s,e,t){return pr=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}()?Reflect.construct.bind():function(i,n,r){var a=[null];a.push.apply(a,n);var o=new(Function.bind.apply(i,a));return r&&Ci(o,r.prototype),o},pr.apply(null,arguments)}function gr(s){var e=typeof Map=="function"?new Map:void 0;return gr=function(t){if(t===null||(i=t,Function.toString.call(i).indexOf("[native code]")===-1))return t;var i;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(e!==void 0){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return pr(t,arguments,nt(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Ci(n,t)},gr(s)}function Qf(s){var e=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}();return function(){var t,i=nt(s);if(e){var n=nt(this).constructor;t=Reflect.construct(i,arguments,n)}else t=i.apply(this,arguments);return ns(this,t)}}function pc(s){var e,t=(e=window._daily)===null||e===void 0?void 0:e.pendings;if(t){var i=t.indexOf(s);i!==-1&&t.splice(i,1)}}var Xf=function(){function s(e){it(this,s),this._currentLoad=null,this._callClientId=e}return st(s,[{key:"load",value:function(){var e,t=this,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;if(this.loaded)return window._daily.instances[this._callClientId].callMachine.reset(),void n(!0);e=this._callClientId,window._daily.pendings.push(e),this._currentLoad&&this._currentLoad.cancel(),this._currentLoad=new Zf(i,function(){n(!1)},function(a,o){o||pc(t._callClientId),r(a,o)}),this._currentLoad.start()}},{key:"cancel",value:function(){this._currentLoad&&this._currentLoad.cancel(),pc(this._callClientId)}},{key:"loaded",get:function(){return this._currentLoad&&this._currentLoad.succeeded}}]),s}(),Zf=function(){function s(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;it(this,s),this._attemptsRemaining=3,this._currentAttempt=null,this._dailyConfig=e,this._successCallback=t,this._failureCallback=i}return st(s,[{key:"start",value:function(){var e=this;this._currentAttempt||(this._currentAttempt=new gc(this._dailyConfig,this._successCallback,function t(i){e._currentAttempt.cancelled||(e._attemptsRemaining--,e._failureCallback(i,e._attemptsRemaining>0),e._attemptsRemaining<=0||setTimeout(function(){e._currentAttempt.cancelled||(e._currentAttempt=new gc(e._dailyConfig,e._successCallback,t),e._currentAttempt.start())},3e3))}),this._currentAttempt.start())}},{key:"cancel",value:function(){this._currentAttempt&&this._currentAttempt.cancel()}},{key:"cancelled",get:function(){return this._currentAttempt&&this._currentAttempt.cancelled}},{key:"succeeded",get:function(){return this._currentAttempt&&this._currentAttempt.succeeded}}]),s}(),mr=function(){ss(e,gr(Error));var s=Qf(e);function e(){return it(this,e),s.apply(this,arguments)}return st(e)}(),Rs=2e4,gc=function(){function s(t,i,n){it(this,s),this._loadAttemptImpl=de()||!t.avoidEval?new ep(t,i,n):new tp(t,i,n)}var e;return st(s,[{key:"start",value:(e=X(function*(){return this._loadAttemptImpl.start()}),function(){return e.apply(this,arguments)})},{key:"cancel",value:function(){this._loadAttemptImpl.cancel()}},{key:"cancelled",get:function(){return this._loadAttemptImpl.cancelled}},{key:"succeeded",get:function(){return this._loadAttemptImpl.succeeded}}]),s}(),ep=function(){function s(r,a,o){it(this,s),this.cancelled=!1,this.succeeded=!1,this._networkTimedOut=!1,this._networkTimeout=null,this._iosCache=typeof iOSCallObjectBundleCache<"u"&&iOSCallObjectBundleCache,this._refetchHeaders=null,this._dailyConfig=r,this._successCallback=a,this._failureCallback=o}var e,t,i,n;return st(s,[{key:"start",value:(n=X(function*(){var r=os(this._dailyConfig);!(yield this._tryLoadFromIOSCache(r))&&this._loadFromNetwork(r)}),function(){return n.apply(this,arguments)})},{key:"cancel",value:function(){clearTimeout(this._networkTimeout),this.cancelled=!0}},{key:"_tryLoadFromIOSCache",value:(i=X(function*(r){if(!this._iosCache)return!1;try{var a=yield this._iosCache.get(r);return!!this.cancelled||!!a&&(a.code?(Function('"use strict";'+a.code)(),this.succeeded=!0,this._successCallback(),!0):(this._refetchHeaders=a.refetchHeaders,!1))}catch{return!1}}),function(r){return i.apply(this,arguments)})},{key:"_loadFromNetwork",value:(t=X(function*(r){var a=this;this._networkTimeout=setTimeout(function(){a._networkTimedOut=!0,a._failureCallback({msg:"Timed out (>".concat(Rs," ms) when loading call object bundle ").concat(r),type:"timeout"})},Rs);try{var o=this._refetchHeaders?{headers:this._refetchHeaders}:{},l=yield fetch(r,o);if(clearTimeout(this._networkTimeout),this.cancelled||this._networkTimedOut)throw new mr;var c=yield this._getBundleCodeFromResponse(r,l);if(this.cancelled)throw new mr;Function('"use strict";'+c)(),this._iosCache&&this._iosCache.set(r,c,l.headers),this.succeeded=!0,this._successCallback()}catch(u){if(clearTimeout(this._networkTimeout),u instanceof mr||this.cancelled||this._networkTimedOut)return;this._failureCallback({msg:"Failed to load call object bundle ".concat(r,": ").concat(u),type:u.message})}}),function(r){return t.apply(this,arguments)})},{key:"_getBundleCodeFromResponse",value:(e=X(function*(r,a){if(a.ok)return yield a.text();if(this._iosCache&&a.status===304)return(yield this._iosCache.renew(r,a.headers)).code;throw new Error("Received ".concat(a.status," response"))}),function(r,a){return e.apply(this,arguments)})}]),s}(),tp=function(){function s(e,t,i){it(this,s),this.cancelled=!1,this.succeeded=!1,this._dailyConfig=e,this._successCallback=t,this._failureCallback=i,this._attemptId=as(),this._networkTimeout=null,this._scriptElement=null}return st(s,[{key:"start",value:function(){window._dailyCallMachineLoadWaitlist||(window._dailyCallMachineLoadWaitlist=new Set);var e=os(this._dailyConfig);(typeof document>"u"?"undefined":me(document))==="object"?this._startLoading(e):this._failureCallback({msg:"Call object bundle must be loaded in a DOM/web context",type:"missing context"})}},{key:"cancel",value:function(){this._stopLoading(),this.cancelled=!0}},{key:"_startLoading",value:function(e){var t=this;this._signUpForCallMachineLoadWaitlist(),this._networkTimeout=setTimeout(function(){t._stopLoading(),t._failureCallback({msg:"Timed out (>".concat(Rs," ms) when loading call object bundle ").concat(e),type:"timeout"})},Rs);var i=document.getElementsByTagName("head")[0],n=document.createElement("script");this._scriptElement=n,n.onload=function(){t._stopLoading(),t.succeeded=!0,t._successCallback()},n.onerror=function(r){t._stopLoading(),t._failureCallback({msg:"Failed to load call object bundle ".concat(r.target.src),type:r.message})},n.src=e,i.appendChild(n)}},{key:"_stopLoading",value:function(){this._withdrawFromCallMachineLoadWaitlist(),clearTimeout(this._networkTimeout),this._scriptElement&&(this._scriptElement.onload=null,this._scriptElement.onerror=null)}},{key:"_signUpForCallMachineLoadWaitlist",value:function(){window._dailyCallMachineLoadWaitlist.add(this._attemptId)}},{key:"_withdrawFromCallMachineLoadWaitlist",value:function(){window._dailyCallMachineLoadWaitlist.delete(this._attemptId)}}]),s}(),Ps=function(s,e,t){return sp(s.local,e,t)===!0},ip=function(s,e,t){return s.local.streams&&s.local.streams[e]&&s.local.streams[e].stream&&s.local.streams[e].stream["get".concat(t==="video"?"Video":"Audio","Tracks")]()[0]},yi=function(s,e,t,i){var n=np(s,e,t,i);return n&&n.pendingTrack},sp=function(s,e,t){if(!s)return!1;var i=function(r){switch(r){case"avatar":return!0;case"staged":return r;default:return!!r}},n=s.public.subscribedTracks;return n&&n[e]?["cam-audio","cam-video","screen-video","screen-audio","rmpAudio","rmpVideo"].indexOf(t)===-1&&n[e].custom?[!0,"staged"].includes(n[e].custom)?i(n[e].custom):i(n[e].custom[t]):i(n[e][t]):!n||i(n.ALL)},np=function(s,e,t,i){var n=Object.values(s.streams||{}).filter(function(r){return r.participantId===e&&r.type===t&&r.pendingTrack&&r.pendingTrack.kind===i}).sort(function(r,a){return new Date(a.starttime)-new Date(r.starttime)});return n&&n[0]},rp=function(s,e){var t=s.local.public.customTracks;if(t&&t[e])return t[e].track};function mc(s,e){for(var t=e.getState(),i=0,n=["cam","screen"];i<n.length;i++)for(var r=n[i],a=0,o=["video","audio"];a<o.length;a++){var l=o[a],c=r==="cam"?l:"screen".concat(l.charAt(0).toUpperCase()+l.slice(1)),u=s.tracks[c];if(u){var d=s.local?ip(t,r,l):yi(t,s.session_id,r,l);u.state==="playable"&&(u.track=d),u.persistentTrack=d}}}function yc(s,e){try{var t=e.getState();for(var i in s.tracks)if(!ap(i)){var n=s.tracks[i].kind;if(n){var r=s.tracks[i];if(r){var a=s.local?rp(t,i):yi(t,s.session_id,i,n);r.state==="playable"&&(s.tracks[i].track=a),r.persistentTrack=a}}else console.error("unknown type for custom track")}}catch(o){console.error(o)}}function ap(s){return["video","audio","screenVideo","screenAudio"].includes(s)}function vc(s,e,t){var i=t.getState();if(s.local){if(s.audio)try{s.audioTrack=i.local.streams.cam.stream.getAudioTracks()[0],s.audioTrack||(s.audio=!1)}catch{}if(s.video)try{s.videoTrack=i.local.streams.cam.stream.getVideoTracks()[0],s.videoTrack||(s.video=!1)}catch{}if(s.screen)try{s.screenVideoTrack=i.local.streams.screen.stream.getVideoTracks()[0],s.screenAudioTrack=i.local.streams.screen.stream.getAudioTracks()[0],s.screenVideoTrack||s.screenAudioTrack||(s.screen=!1)}catch{}}else{var n=!0;try{var r=i.participants[s.session_id];r&&r.public&&r.public.rtcType&&r.public.rtcType.impl==="peer-to-peer"&&r.private&&!["connected","completed"].includes(r.private.peeringState)&&(n=!1)}catch(u){console.error(u)}if(!n)return s.audio=!1,s.audioTrack=!1,s.video=!1,s.videoTrack=!1,s.screen=!1,void(s.screenTrack=!1);try{if(i.streams,s.audio&&Ps(i,s.session_id,"cam-audio")){var a=yi(i,s.session_id,"cam","audio");a&&(e&&e.audioTrack&&e.audioTrack.id===a.id?s.audioTrack=a:a.muted||(s.audioTrack=a)),s.audioTrack||(s.audio=!1)}if(s.video&&Ps(i,s.session_id,"cam-video")){var o=yi(i,s.session_id,"cam","video");o&&(e&&e.videoTrack&&e.videoTrack.id===o.id?s.videoTrack=o:o.muted||(s.videoTrack=o)),s.videoTrack||(s.video=!1)}if(s.screen&&Ps(i,s.session_id,"screen-audio")){var l=yi(i,s.session_id,"screen","audio");l&&(e&&e.screenAudioTrack&&e.screenAudioTrack.id===l.id?s.screenAudioTrack=l:l.muted||(s.screenAudioTrack=l))}if(s.screen&&Ps(i,s.session_id,"screen-video")){var c=yi(i,s.session_id,"screen","video");c&&(e&&e.screenVideoTrack&&e.screenVideoTrack.id===c.id?s.screenVideoTrack=c:c.muted||(s.screenVideoTrack=c))}s.screenVideoTrack||s.screenAudioTrack||(s.screen=!1)}catch(u){console.error("unexpected error matching up tracks",u)}}}function op(s,e){var t=typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=function(l,c){if(l){if(typeof l=="string")return Sc(l,c);var u=Object.prototype.toString.call(l).slice(8,-1);if(u==="Object"&&l.constructor&&(u=l.constructor.name),u==="Map"||u==="Set")return Array.from(l);if(u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u))return Sc(l,c)}}(s))||e){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r,a=!0,o=!1;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return a=l.done,l},e:function(l){o=!0,r=l},f:function(){try{a||t.return==null||t.return()}finally{if(o)throw r}}}}function Sc(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=s[t];return i}var ft=new Map,vi=null;function lp(s,e){var t=typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=function(l,c){if(l){if(typeof l=="string")return Ec(l,c);var u=Object.prototype.toString.call(l).slice(8,-1);if(u==="Object"&&l.constructor&&(u=l.constructor.name),u==="Map"||u==="Set")return Array.from(l);if(u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u))return Ec(l,c)}}(s))||e){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r,a=!0,o=!1;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return a=l.done,l},e:function(l){o=!0,r=l},f:function(){try{a||t.return==null||t.return()}finally{if(o)throw r}}}}function Ec(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=s[t];return i}var pt=new Map,$i=null;function cp(s){Tc()?function(e){ft.has(e)||(ft.set(e,{}),navigator.mediaDevices.enumerateDevices().then(function(t){ft.has(e)&&(ft.get(e).lastDevicesString=JSON.stringify(t),vi||(vi=function(){var i=X(function*(){var n,r=yield navigator.mediaDevices.enumerateDevices(),a=op(ft.keys());try{for(a.s();!(n=a.n()).done;){var o=n.value,l=JSON.stringify(r);l!==ft.get(o).lastDevicesString&&(ft.get(o).lastDevicesString=l,o(r))}}catch(c){a.e(c)}finally{a.f()}});return function(){return i.apply(this,arguments)}}(),navigator.mediaDevices.addEventListener("devicechange",vi)))}).catch(function(){}))}(s):function(e){pt.has(e)||(pt.set(e,{}),navigator.mediaDevices.enumerateDevices().then(function(t){pt.has(e)&&(pt.get(e).lastDevicesString=JSON.stringify(t),$i||($i=setInterval(X(function*(){var i,n=yield navigator.mediaDevices.enumerateDevices(),r=lp(pt.keys());try{for(r.s();!(i=r.n()).done;){var a=i.value,o=JSON.stringify(n);o!==pt.get(a).lastDevicesString&&(pt.get(a).lastDevicesString=o,a(n))}}catch(l){r.e(l)}finally{r.f()}}),3e3)))}))}(s)}function up(s){Tc()?function(e){ft.has(e)&&(ft.delete(e),ft.size===0&&vi&&(navigator.mediaDevices.removeEventListener("devicechange",vi),vi=null))}(s):function(e){pt.has(e)&&(pt.delete(e),pt.size===0&&$i&&(clearInterval($i),$i=null))}(s)}function Tc(){var s;return de()||((s=navigator.mediaDevices)===null||s===void 0?void 0:s.ondevicechange)!==void 0}var dp=new Set;function hp(s,e){return s&&s.readyState==="live"&&!function(t,i){return t.muted&&!dp.has(t.id)}(s)}var fp=["result"],pp=["preserveIframe"];function bc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function H(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?bc(Object(t),!0).forEach(function(i){_t(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):bc(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}function gp(s){var e=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}();return function(){var t,i=nt(s);if(e){var n=nt(this).constructor;t=Reflect.construct(i,arguments,n)}else t=i.apply(this,arguments);return ns(this,t)}}function _c(s,e){var t=typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=function(l,c){if(l){if(typeof l=="string")return xc(l,c);var u=Object.prototype.toString.call(l).slice(8,-1);if(u==="Object"&&l.constructor&&(u=l.constructor.name),u==="Map"||u==="Set")return Array.from(l);if(u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u))return xc(l,c)}}(s))||e){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r,a=!0,o=!1;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return a=l.done,l},e:function(l){o=!0,r=l},f:function(){try{a||t.return==null||t.return()}finally{if(o)throw r}}}}function xc(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=s[t];return i}var ni={},Ac="video",mp="voice",Ic=de()?{data:{}}:{data:{},topology:"none"},wc={present:0,hidden:0},Lc={maxBitrate:{min:1e5,max:25e5},maxFramerate:{min:1,max:30},scaleResolutionDownBy:{min:1,max:8}},yr=Object.keys(Lc),kc=["state","volume","simulcastEncodings"],Cc={androidInCallNotification:{title:"string",subtitle:"string",iconName:"string",disableForCustomOverride:"boolean"},disableAutoDeviceManagement:{audio:"boolean",video:"boolean"}},Ds={id:{iconPath:"string",iconPathDarkMode:"string",label:"string",tooltip:"string",visualState:"'default' | 'sidebar-open' | 'active'"}},vr={id:{allow:"string",controlledBy:"'*' | 'owners' | string[]",csp:"string",iconURL:"string",label:"string",loading:"'eager' | 'lazy'",location:"'main' | 'sidebar'",name:"string",referrerPolicy:"string",sandbox:"string",src:"string",srcdoc:"string",shared:"string[] | 'owners' | boolean"}},ri={customIntegrations:{validate:Bc,help:Nc()},customTrayButtons:{validate:Uc,help:"customTrayButtons should be a dictionary of the type ".concat(JSON.stringify(Ds))},url:{validate:function(s){return typeof s=="string"},help:"url should be a string"},baseUrl:{validate:function(s){return typeof s=="string"},help:"baseUrl should be a string"},token:{validate:function(s){return typeof s=="string"},help:"token should be a string",queryString:"t"},dailyConfig:{validate:function(s,e){try{return e.validateDailyConfig(s),!0}catch(t){console.error("Failed to validate dailyConfig",t)}return!1},help:"Unsupported dailyConfig. Check error logs for detailed info."},reactNativeConfig:{validate:function(s){return $c(s,Cc)},help:"reactNativeConfig should look like ".concat(JSON.stringify(Cc),", all fields optional")},lang:{validate:function(s){return["da","de","en-us","en","es","fi","fr","it","jp","ka","nl","no","pl","pt","pt-BR","ru","sv","tr","user"].includes(s)},help:"language not supported. Options are: da, de, en-us, en, es, fi, fr, it, jp, ka, nl, no, pl, pt, pt-BR, ru, sv, tr, user"},userName:!0,userData:{validate:function(s){try{return Rc(s),!0}catch(e){return console.error(e),!1}},help:"invalid userData type provided"},startVideoOff:!0,startAudioOff:!0,allowLocalVideo:!0,allowLocalAudio:!0,activeSpeakerMode:!0,showLeaveButton:!0,showLocalVideo:!0,showParticipantsBar:!0,showFullscreenButton:!0,showUserNameChangeUI:!0,iframeStyle:!0,customLayout:!0,cssFile:!0,cssText:!0,bodyClass:!0,videoSource:{validate:function(s,e){if(typeof s=="boolean")return e._preloadCache.allowLocalVideo=s,!0;var t;if(s instanceof MediaStreamTrack)e._sharedTracks.videoTrack=s,t={customTrack:Lt};else{if(delete e._sharedTracks.videoTrack,typeof s!="string")return console.error("videoSource must be a MediaStreamTrack, boolean, or a string"),!1;t={deviceId:s}}return e._updatePreloadCacheInputSettings({video:{settings:t}},!1),!0}},audioSource:{validate:function(s,e){if(typeof s=="boolean")return e._preloadCache.allowLocalAudio=s,!0;var t;if(s instanceof MediaStreamTrack)e._sharedTracks.audioTrack=s,t={customTrack:Lt};else{if(delete e._sharedTracks.audioTrack,typeof s!="string")return console.error("audioSource must be a MediaStreamTrack, boolean, or a string"),!1;t={deviceId:s}}return e._updatePreloadCacheInputSettings({audio:{settings:t}},!1),!0}},subscribeToTracksAutomatically:{validate:function(s,e){return e._preloadCache.subscribeToTracksAutomatically=s,!0}},theme:{validate:function(s){var e=["accent","accentText","background","backgroundAccent","baseText","border","mainAreaBg","mainAreaBgAccent","mainAreaText","supportiveText"],t=function(i){for(var n=0,r=Object.keys(i);n<r.length;n++){var a=r[n];if(!e.includes(a))return console.error('unsupported color "'.concat(a,'". Valid colors: ').concat(e.join(", "))),!1;if(!i[a].match(/^#[0-9a-f]{6}|#[0-9a-f]{3}$/i))return console.error("".concat(a,' theme color should be provided in valid hex color format. Received: "').concat(i[a],'"')),!1}return!0};return me(s)==="object"&&("light"in s&&"dark"in s||"colors"in s)?"light"in s&&"dark"in s?"colors"in s.light?"colors"in s.dark?t(s.light.colors)&&t(s.dark.colors):(console.error('Dark theme is missing "colors" property.',s),!1):(console.error('Light theme is missing "colors" property.',s),!1):t(s.colors):(console.error('Theme must contain either both "light" and "dark" properties, or "colors".',s),!1)},help:"unsupported theme configuration. Check error logs for detailed info."},layoutConfig:{validate:function(s){if("grid"in s){var e=s.grid;if("maxTilesPerPage"in e){if(!Number.isInteger(e.maxTilesPerPage))return console.error("grid.maxTilesPerPage should be an integer. You passed ".concat(e.maxTilesPerPage,".")),!1;if(e.maxTilesPerPage>49)return console.error("grid.maxTilesPerPage can't be larger than 49 without sacrificing browser performance. Please contact us at https://www.daily.co/contact to talk about your use case."),!1}if("minTilesPerPage"in e){if(!Number.isInteger(e.minTilesPerPage))return console.error("grid.minTilesPerPage should be an integer. You passed ".concat(e.minTilesPerPage,".")),!1;if(e.minTilesPerPage<1)return console.error("grid.minTilesPerPage can't be lower than 1."),!1;if("maxTilesPerPage"in e&&e.minTilesPerPage>e.maxTilesPerPage)return console.error("grid.minTilesPerPage can't be higher than grid.maxTilesPerPage."),!1}}return!0},help:"unsupported layoutConfig. Check error logs for detailed info."},receiveSettings:{validate:function(s){return Pc(s,{allowAllParticipantsKey:!1})},help:Fc({allowAllParticipantsKey:!1})},sendSettings:{validate:function(s,e){return!!function(t,i){try{return i.validateUpdateSendSettings(t),!0}catch(n){return console.error("Failed to validate send settings",n),!1}}(s,e)&&(e._preloadCache.sendSettings=s,!0)},help:"Invalid sendSettings provided. Check error logs for detailed info."},inputSettings:{validate:function(s,e){var t;return!!Dc(s)&&(e._inputSettings||(e._inputSettings={}),Oc(s,(t=e.properties)===null||t===void 0?void 0:t.dailyConfig,e._sharedTracks),e._updatePreloadCacheInputSettings(s,!0),!0)},help:Tr()},layout:{validate:function(s){return s==="custom-v1"||s==="browser"||s==="none"},help:'layout may only be set to "custom-v1"',queryString:"layout"},emb:{queryString:"emb"},embHref:{queryString:"embHref"},dailyJsVersion:{queryString:"dailyJsVersion"},proxy:{queryString:"proxy"},strictMode:!0,allowMultipleCallInstances:!0},Os={styles:{validate:function(s){for(var e in s)if(e!=="cam"&&e!=="screen")return!1;if(s.cam){for(var t in s.cam)if(t!=="div"&&t!=="video")return!1}if(s.screen){for(var i in s.screen)if(i!=="div"&&i!=="video")return!1}return!0},help:"styles format should be a subset of: { cam: {div: {}, video: {}}, screen: {div: {}, video: {}} }"},setSubscribedTracks:{validate:function(s,e){if(e._preloadCache.subscribeToTracksAutomatically)return!1;var t=[!0,!1,"staged"];if(t.includes(s)||!de()&&s==="avatar")return!0;var i=["audio","video","screenAudio","screenVideo","rmpAudio","rmpVideo"];return function n(r){var a=arguments.length>1&&arguments[1]!==void 0&&arguments[1];for(var o in r)if(o==="custom"){if(!t.includes(r[o])&&!n(r[o],!0))return!1}else{var l=!a&&!i.includes(o),c=!t.includes(r[o]);if(l||c)return!1}return!0}(s)},help:"setSubscribedTracks cannot be used when setSubscribeToTracksAutomatically is enabled, and should be of the form: "+"true".concat(de()?"":" | 'avatar'"," | false | 'staged' | { [audio: true|false|'staged'], [video: true|false|'staged'], [screenAudio: true|false|'staged'], [screenVideo: true|false|'staged'] }")},setAudio:!0,setVideo:!0,setScreenShare:{validate:function(s){return s===!1},help:"setScreenShare must be false, as it's only meant for stopping remote participants' screen shares"},eject:!0,updatePermissions:{validate:function(s){for(var e=0,t=Object.entries(s);e<t.length;e++){var i=dt(t[e],2),n=i[0],r=i[1];switch(n){case"hasPresence":if(typeof r!="boolean")return!1;break;case"canSend":if(r instanceof Set||r instanceof Array||Array.isArray(r)){var a,o=["video","audio","screenVideo","screenAudio","customVideo","customAudio"],l=_c(r);try{for(l.s();!(a=l.n()).done;){var c=a.value;if(!o.includes(c))return!1}}catch(g){l.e(g)}finally{l.f()}}else if(typeof r!="boolean")return!1;(r instanceof Array||Array.isArray(r))&&(s.canSend=new Set(r));break;case"canAdmin":if(r instanceof Set||r instanceof Array||Array.isArray(r)){var u,d=["participants","streaming","transcription"],f=_c(r);try{for(f.s();!(u=f.n()).done;){var p=u.value;if(!d.includes(p))return!1}}catch(g){f.e(g)}finally{f.f()}}else if(typeof r!="boolean")return!1;(r instanceof Array||Array.isArray(r))&&(s.canAdmin=new Set(r));break;default:return!1}}return!0},help:"updatePermissions can take hasPresence, canSend, and canAdmin permissions. hasPresence must be a boolean. canSend can be a boolean or an Array or Set of media types (video, audio, screenVideo, screenAudio, customVideo, customAudio). canAdmin can be a boolean or an Array or Set of admin types (participants, streaming, transcription)."}};Promise.any||(Promise.any=function(){var s=X(function*(e){return new Promise(function(t,i){var n=[];e.forEach(function(r){return Promise.resolve(r).then(function(a){t(a)}).catch(function(a){n.push(a),n.length===e.length&&i(n)})})})});return function(e){return s.apply(this,arguments)}}());var yp=function(){ss(z,xt);var s,e,t,i,n,r,a,o,l,c,u,d,f,p,g,y,S,T,L,w,x,b,C,_,k,D,R,N,G,ce,J,ae,se,q,fe,j,B,ee,Q=gp(z);function z(h){var v,m,I,A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(it(this,z),_t(bt(m=Q.call(this)),"startListeningForDeviceChanges",function(){cp(m.handleDeviceChange)}),_t(bt(m),"stopListeningForDeviceChanges",function(){up(m.handleDeviceChange)}),_t(bt(m),"handleDeviceChange",function(U){U=U.map(function(V){return JSON.parse(JSON.stringify(V))}),m.emitDailyJSEvent({action:"available-devices-updated",availableDevices:U})}),_t(bt(m),"handleNativeAppStateChange",function(){var U=X(function*(V){if(V==="destroyed")return console.warn("App has been destroyed before leaving the meeting. Cleaning up all the resources!"),void(yield m.destroy());var W=V==="active";m.disableReactNativeAutoDeviceManagement("video")||(W?m.camUnmutedBeforeLosingNativeActiveState&&m.setLocalVideo(!0):(m.camUnmutedBeforeLosingNativeActiveState=m.localVideo(),m.camUnmutedBeforeLosingNativeActiveState&&m.setLocalVideo(!1)))});return function(V){return U.apply(this,arguments)}}()),_t(bt(m),"handleNativeAudioFocusChange",function(U){m.disableReactNativeAutoDeviceManagement("audio")||(m._hasNativeAudioFocus=U,m.toggleParticipantAudioBasedOnNativeAudioFocus(),m._hasNativeAudioFocus?m.micUnmutedBeforeLosingNativeAudioFocus&&m.setLocalAudio(!0):(m.micUnmutedBeforeLosingNativeAudioFocus=m.localAudio(),m.setLocalAudio(!1)))}),_t(bt(m),"handleNativeSystemScreenCaptureStop",function(){m.stopScreenShare()}),m.strictMode=A.strictMode===void 0||A.strictMode,m.allowMultipleCallInstances=(v=A.allowMultipleCallInstances)!==null&&v!==void 0&&v,Object.keys(ni).length&&(m._logDuplicateInstanceAttempt(),!m.allowMultipleCallInstances)){if(m.strictMode)throw new Error("Duplicate DailyIframe instances are not allowed");console.warn("Using strictMode: false to allow multiple call instances is now deprecated. Set `allowMultipleCallInstances: true`")}if(window._daily||(window._daily={pendings:[],instances:{}}),m.callClientId=as(),I=bt(m),ni[I.callClientId]=I,window._daily.instances[m.callClientId]={},m._sharedTracks={},window._daily.instances[m.callClientId].tracks=m._sharedTracks,A.dailyJsVersion=z.version(),m._iframe=h,m._callObjectMode=A.layout==="none"&&!m._iframe,m._preloadCache={subscribeToTracksAutomatically:!0,outputDeviceId:null,inputSettings:null,sendSettings:null,videoTrackForNetworkConnectivityTest:null,videoTrackForConnectionQualityTest:null},A.showLocalVideo!==void 0?m._callObjectMode?console.error("showLocalVideo is not available in call object mode"):m._showLocalVideo=!!A.showLocalVideo:m._showLocalVideo=!0,A.showParticipantsBar!==void 0?m._callObjectMode?console.error("showParticipantsBar is not available in call object mode"):m._showParticipantsBar=!!A.showParticipantsBar:m._showParticipantsBar=!0,A.customIntegrations!==void 0?m._callObjectMode?console.error("customIntegrations is not available in call object mode"):m._customIntegrations=A.customIntegrations:m._customIntegrations={},A.customTrayButtons!==void 0?m._callObjectMode?console.error("customTrayButtons is not available in call object mode"):m._customTrayButtons=A.customTrayButtons:m._customTrayButtons={},A.activeSpeakerMode!==void 0?m._callObjectMode?console.error("activeSpeakerMode is not available in call object mode"):m._activeSpeakerMode=!!A.activeSpeakerMode:m._activeSpeakerMode=!1,A.receiveSettings?m._callObjectMode?m._receiveSettings=A.receiveSettings:console.error("receiveSettings is only available in call object mode"):m._receiveSettings={},m.validateProperties(A),m.properties=H({},A),m._inputSettings||(m._inputSettings={}),m._callObjectLoader=m._callObjectMode?new Xf(m.callClientId):null,m._callState=Jn,m._isPreparingToJoin=!1,m._accessState={access:ws},m._meetingSessionSummary={},m._finalSummaryOfPrevSession={},m._meetingSessionState=br(Ic,m._callObjectMode),m._nativeInCallAudioMode=Ac,m._participants={},m._isScreenSharing=!1,m._participantCounts=wc,m._rmpPlayerState={},m._waitingParticipants={},m._network={threshold:"good",quality:100},m._activeSpeaker={},m._localAudioLevel=0,m._isLocalAudioLevelObserverRunning=!1,m._remoteParticipantsAudioLevel={},m._isRemoteParticipantsAudioLevelObserverRunning=!1,m._maxAppMessageSize=nr,m._messageChannel=de()?new zf:new Yf,m._iframe&&(m._iframe.requestFullscreen?m._iframe.addEventListener("fullscreenchange",function(){document.fullscreenElement===m._iframe?(m.emitDailyJSEvent({action:Ui}),m.sendMessageToCallMachine({action:Ui})):(m.emitDailyJSEvent({action:Bi}),m.sendMessageToCallMachine({action:Bi}))}):m._iframe.webkitRequestFullscreen&&m._iframe.addEventListener("webkitfullscreenchange",function(){document.webkitFullscreenElement===m._iframe?(m.emitDailyJSEvent({action:Ui}),m.sendMessageToCallMachine({action:Ui})):(m.emitDailyJSEvent({action:Bi}),m.sendMessageToCallMachine({action:Bi}))})),de()){var O=m.nativeUtils();O.addAudioFocusChangeListener&&O.removeAudioFocusChangeListener&&O.addAppStateChangeListener&&O.removeAppStateChangeListener&&O.addSystemScreenCaptureStopListener&&O.removeSystemScreenCaptureStopListener||console.warn("expected (add|remove)(AudioFocusChange|AppActiveStateChange|SystemScreenCaptureStop)Listener to be available in React Native"),m._hasNativeAudioFocus=!0,O.addAudioFocusChangeListener(m.handleNativeAudioFocusChange),O.addAppStateChangeListener(m.handleNativeAppStateChange),O.addSystemScreenCaptureStopListener(m.handleNativeSystemScreenCaptureStop)}return m._callObjectMode&&m.startListeningForDeviceChanges(),m._messageChannel.addListenerForMessagesFromCallMachine(m.handleMessageFromCallMachine,m.callClientId,bt(m)),m}return st(z,[{key:"destroy",value:(ee=X(function*(){var h,v;try{yield this.leave()}catch{}var m=this._iframe;if(m){var I=m.parentElement;I&&I.removeChild(m)}if(this._messageChannel.removeListener(this.handleMessageFromCallMachine),de()){var A=this.nativeUtils();A.removeAudioFocusChangeListener(this.handleNativeAudioFocusChange),A.removeAppStateChangeListener(this.handleNativeAppStateChange),A.removeSystemScreenCaptureStopListener(this.handleNativeSystemScreenCaptureStop)}this._callObjectMode&&this.stopListeningForDeviceChanges(),this.resetMeetingDependentVars(),this._destroyed=!0,this.emitDailyJSEvent({action:"call-instance-destroyed"}),delete ni[this.callClientId],!((h=window)===null||h===void 0||(v=h._daily)===null||v===void 0)&&v.instances&&delete window._daily.instances[this.callClientId],this.strictMode&&(this.callClientId=void 0)}),function(){return ee.apply(this,arguments)})},{key:"isDestroyed",value:function(){return!!this._destroyed}},{key:"loadCss",value:function(h){var v=h.bodyClass,m=h.cssFile,I=h.cssText;return ue(),this.sendMessageToCallMachine({action:"load-css",cssFile:this.absoluteUrl(m),bodyClass:v,cssText:I}),this}},{key:"iframe",value:function(){return ue(),this._iframe}},{key:"meetingState",value:function(){return this._callState}},{key:"accessState",value:function(){return lt(this._callObjectMode,"accessState()"),this._accessState}},{key:"participants",value:function(){return this._participants}},{key:"participantCounts",value:function(){return this._participantCounts}},{key:"waitingParticipants",value:function(){return lt(this._callObjectMode,"waitingParticipants()"),this._waitingParticipants}},{key:"validateParticipantProperties",value:function(h,v){for(var m in v){if(!Os[m])throw new Error("unrecognized updateParticipant property ".concat(m));if(Os[m].validate&&!Os[m].validate(v[m],this,this._participants[h]))throw new Error(Os[m].help)}}},{key:"updateParticipant",value:function(h,v){return this._participants.local&&this._participants.local.session_id===h&&(h="local"),h&&v&&(this.validateParticipantProperties(h,v),this.sendMessageToCallMachine({action:"update-participant",id:h,properties:v})),this}},{key:"updateParticipants",value:function(h){var v=this._participants.local&&this._participants.local.session_id;for(var m in h)m===v&&(m="local"),m&&h[m]&&this.validateParticipantProperties(m,h[m]);return this.sendMessageToCallMachine({action:"update-participants",participants:h}),this}},{key:"updateWaitingParticipant",value:(B=X(function*(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",m=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(lt(this._callObjectMode,"updateWaitingParticipant()"),Te(this._callState,"updateWaitingParticipant()"),typeof v!="string"||me(m)!=="object")throw new Error("updateWaitingParticipant() must take an id string and a updates object");return new Promise(function(I,A){h.sendMessageToCallMachine({action:"daily-method-update-waiting-participant",id:v,updates:m},function(O){O.error&&A(O.error),O.id||A(new Error("unknown error in updateWaitingParticipant()")),I({id:O.id})})})}),function(){return B.apply(this,arguments)})},{key:"updateWaitingParticipants",value:(j=X(function*(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(lt(this._callObjectMode,"updateWaitingParticipants()"),Te(this._callState,"updateWaitingParticipants()"),me(v)!=="object")throw new Error("updateWaitingParticipants() must take a mapping between ids and update objects");return new Promise(function(m,I){h.sendMessageToCallMachine({action:"daily-method-update-waiting-participants",updatesById:v},function(A){A.error&&I(A.error),A.ids||I(new Error("unknown error in updateWaitingParticipants()")),m({ids:A.ids})})})}),function(){return j.apply(this,arguments)})},{key:"requestAccess",value:(fe=X(function*(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},m=v.access,I=m===void 0?{level:Qo}:m,A=v.name,O=A===void 0?"":A;return lt(this._callObjectMode,"requestAccess()"),Te(this._callState,"requestAccess()"),new Promise(function(U,V){h.sendMessageToCallMachine({action:"daily-method-request-access",access:I,name:O},function(W){W.error&&V(W.error),W.access||V(new Error("unknown error in requestAccess()")),U({access:W.access,granted:W.granted})})})}),function(){return fe.apply(this,arguments)})},{key:"localAudio",value:function(){return this._participants.local?!["blocked","off"].includes(this._participants.local.tracks.audio.state):null}},{key:"localVideo",value:function(){return this._participants.local?!["blocked","off"].includes(this._participants.local.tracks.video.state):null}},{key:"setLocalAudio",value:function(h){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return"forceDiscardTrack"in v&&(de()?(console.warn("forceDiscardTrack option not supported in React Native; ignoring"),v={}):h&&(console.warn("forceDiscardTrack option only supported when calling setLocalAudio(false); ignoring"),v={})),this.sendMessageToCallMachine({action:"local-audio",state:h,options:v}),this}},{key:"localScreenAudio",value:function(){return this._participants.local?!["blocked","off"].includes(this._participants.local.tracks.screenAudio.state):null}},{key:"localScreenVideo",value:function(){return this._participants.local?!["blocked","off"].includes(this._participants.local.tracks.screenVideo.state):null}},{key:"updateScreenShare",value:function(h){if(this._isScreenSharing)return this.sendMessageToCallMachine({action:"local-screen-update",options:h}),this;console.warn("There is no screen share in progress. Try calling startScreenShare first.")}},{key:"setLocalVideo",value:function(h){return this.sendMessageToCallMachine({action:"local-video",state:h}),this}},{key:"_setAllowLocalAudio",value:function(h){if(this._preloadCache.allowLocalAudio=h,this._callMachineInitialized)return this.sendMessageToCallMachine({action:"set-allow-local-audio",state:h}),this}},{key:"_setAllowLocalVideo",value:function(h){if(this._preloadCache.allowLocalVideo=h,this._callMachineInitialized)return this.sendMessageToCallMachine({action:"set-allow-local-video",state:h}),this}},{key:"getReceiveSettings",value:(q=X(function*(h){var v=this,m=(arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}).showInheritedValues,I=m!==void 0&&m;if(lt(this._callObjectMode,"getReceiveSettings()"),!this._callMachineInitialized)return this._receiveSettings;switch(me(h)){case"string":return new Promise(function(A){v.sendMessageToCallMachine({action:"get-single-participant-receive-settings",id:h,showInheritedValues:I},function(O){A(O.receiveSettings)})});case"undefined":return this._receiveSettings;default:throw new Error('first argument to getReceiveSettings() must be a participant id (or "base"), or there should be no arguments')}}),function(h){return q.apply(this,arguments)})},{key:"updateReceiveSettings",value:(se=X(function*(h){var v=this;if(lt(this._callObjectMode,"updateReceiveSettings()"),!Pc(h,{allowAllParticipantsKey:!0}))throw new Error(Fc({allowAllParticipantsKey:!0}));return Te(this._callState,"updateReceiveSettings()","To specify receive settings earlier, use the receiveSettings config property."),new Promise(function(m){v.sendMessageToCallMachine({action:"update-receive-settings",receiveSettings:h},function(I){m({receiveSettings:I.receiveSettings})})})}),function(h){return se.apply(this,arguments)})},{key:"_prepInputSettingsForSharing",value:function(h,v){if(h){var m={};if(h.audio){var I,A,O,U;h.audio.settings&&(!Object.keys(h.audio.settings).length&&v||(m.audio={settings:H({},h.audio.settings)})),v&&(I=m.audio)!==null&&I!==void 0&&(A=I.settings)!==null&&A!==void 0&&A.customTrack&&(m.audio.settings={customTrack:this._sharedTracks.audioTrack});var V=((O=h.audio.processor)===null||O===void 0?void 0:O.type)==="none"&&((U=h.audio.processor)===null||U===void 0?void 0:U._isDefaultWhenNone);if(h.audio.processor&&!V){var W=H({},h.audio.processor);delete W._isDefaultWhenNone,m.audio=H(H({},m.audio),{},{processor:W})}}if(h.video){var he,le,Re,ie;h.video.settings&&(!Object.keys(h.video.settings).length&&v||(m.video={settings:H({},h.video.settings)})),v&&(he=m.video)!==null&&he!==void 0&&(le=he.settings)!==null&&le!==void 0&&le.customTrack&&(m.video.settings={customTrack:this._sharedTracks.videoTrack});var Ae=((Re=h.video.processor)===null||Re===void 0?void 0:Re.type)==="none"&&((ie=h.video.processor)===null||ie===void 0?void 0:ie._isDefaultWhenNone);if(h.video.processor&&!Ae){var ke=H({},h.video.processor);delete ke._isDefaultWhenNone,m.video=H(H({},m.video),{},{processor:ke})}}return m}}},{key:"getInputSettings",value:function(){var h=this;return ue(),new Promise(function(v){v(h._getInputSettings())})}},{key:"_getInputSettings",value:function(){var h,v,m,I,A,O,U,V,W={processor:{type:"none",_isDefaultWhenNone:!0}};this._inputSettings?(h=((m=this._inputSettings)===null||m===void 0?void 0:m.video)||W,v=((I=this._inputSettings)===null||I===void 0?void 0:I.audio)||W):(h=((A=this._preloadCache)===null||A===void 0||(O=A.inputSettings)===null||O===void 0?void 0:O.video)||W,v=((U=this._preloadCache)===null||U===void 0||(V=U.inputSettings)===null||V===void 0?void 0:V.audio)||W);var he={audio:v,video:h};return this._prepInputSettingsForSharing(he,!0)}},{key:"_updatePreloadCacheInputSettings",value:function(h,v){var m=this._inputSettings||{},I={};if(h.video){var A,O,U;I.video={},h.video.settings?(I.video.settings={},v||h.video.settings.customTrack||(U=m.video)===null||U===void 0||!U.settings?I.video.settings=h.video.settings:I.video.settings=H(H({},m.video.settings),h.video.settings),Object.keys(I.video.settings).length||delete I.video.settings):(A=m.video)!==null&&A!==void 0&&A.settings&&(I.video.settings=m.video.settings),h.video.processor?I.video.processor=h.video.processor:(O=m.video)!==null&&O!==void 0&&O.processor&&(I.video.processor=m.video.processor)}else m.video&&(I.video=m.video);if(h.audio){var V,W,he;I.audio={},h.audio.settings?(I.audio.settings={},v||h.audio.settings.customTrack||(he=m.audio)===null||he===void 0||!he.settings?I.audio.settings=h.audio.settings:I.audio.settings=H(H({},m.audio.settings),h.audio.settings),Object.keys(I.audio.settings).length||delete I.audio.settings):(V=m.audio)!==null&&V!==void 0&&V.settings&&(I.audio.settings=m.audio.settings),h.audio.processor?I.audio.processor=h.audio.processor:(W=m.audio)!==null&&W!==void 0&&W.processor&&(I.audio.processor=m.audio.processor)}else m.audio&&(I.audio=m.audio);this._maybeUpdateInputSettings(I)}},{key:"_devicesFromInputSettings",value:function(h){var v,m,I,A,O=(h==null||(v=h.video)===null||v===void 0||(m=v.settings)===null||m===void 0?void 0:m.deviceId)||null,U=(h==null||(I=h.audio)===null||I===void 0||(A=I.settings)===null||A===void 0?void 0:A.deviceId)||null,V=this._preloadCache.outputDeviceId||null;return{camera:O?{deviceId:O}:{},mic:U?{deviceId:U}:{},speaker:V?{deviceId:V}:{}}}},{key:"updateInputSettings",value:(ae=X(function*(h){var v=this;return ue(),Dc(h)?h.video||h.audio?(Oc(h,this.properties.dailyConfig,this._sharedTracks),this._callObjectMode&&!this._callMachineInitialized?(this._updatePreloadCacheInputSettings(h,!0),this._getInputSettings()):new Promise(function(m,I){v.sendMessageToCallMachine({action:"update-input-settings",inputSettings:h},function(A){if(A.error)I(A.error);else{if(A.returnPreloadCache)return v._updatePreloadCacheInputSettings(h,!0),void m(v._getInputSettings());v._maybeUpdateInputSettings(A.inputSettings),m(v._prepInputSettingsForSharing(A.inputSettings,!0))}})})):this._getInputSettings():(console.error(Tr()),Promise.reject(Tr()))}),function(h){return ae.apply(this,arguments)})},{key:"setBandwidth",value:function(h){var v=h.kbs,m=h.trackConstraints;if(ue(),this._callMachineInitialized)return this.sendMessageToCallMachine({action:"set-bandwidth",kbs:v,trackConstraints:m}),this}},{key:"getDailyLang",value:function(){var h=this;if(ue(),this._callMachineInitialized)return new Promise(function(v){h.sendMessageToCallMachine({action:"get-daily-lang"},function(m){delete m.action,delete m.callbackStamp,v(m)})})}},{key:"setDailyLang",value:function(h){return ue(),this.sendMessageToCallMachine({action:"set-daily-lang",lang:h}),this}},{key:"setProxyUrl",value:function(h){return this.sendMessageToCallMachine({action:"set-proxy-url",proxyUrl:h}),this}},{key:"setIceConfig",value:function(h){return this.sendMessageToCallMachine({action:"set-ice-config",iceConfig:h}),this}},{key:"meetingSessionSummary",value:function(){return[jt,wt].includes(this._callState)?this._finalSummaryOfPrevSession:this._meetingSessionSummary}},{key:"getMeetingSession",value:(J=X(function*(){var h=this;return console.warn("getMeetingSession() is deprecated: use meetingSessionSummary(), which will return immediately"),Te(this._callState,"getMeetingSession()"),new Promise(function(v){h.sendMessageToCallMachine({action:"get-meeting-session"},function(m){delete m.action,delete m.callbackStamp,v(m)})})}),function(){return J.apply(this,arguments)})},{key:"meetingSessionState",value:function(){return Te(this._callState,"meetingSessionState"),this._meetingSessionState}},{key:"setMeetingSessionData",value:function(h){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"replace";lt(this._callObjectMode,"setMeetingSessionData()"),Te(this._callState,"setMeetingSessionData");try{(function(m,I){new Jf({data:m,mergeStrategy:I})})(h,v)}catch(m){throw console.error(m),m}try{this.sendMessageToCallMachine({action:"set-session-data",data:h,mergeStrategy:v})}catch(m){throw new Error("Error setting meeting session data: ".concat(m))}}},{key:"setUserName",value:function(h,v){var m=this;return this.properties.userName=h,new Promise(function(I){m.sendMessageToCallMachine({action:"set-user-name",name:h??"",thisMeetingOnly:de()||!!v&&!!v.thisMeetingOnly},function(A){delete A.action,delete A.callbackStamp,I(A)})})}},{key:"setUserData",value:(ce=X(function*(h){var v=this;try{Rc(h)}catch(m){throw console.error(m),m}if(this.properties.userData=h,this._callMachineInitialized)return new Promise(function(m){try{v.sendMessageToCallMachine({action:"set-user-data",userData:h},function(I){delete I.action,delete I.callbackStamp,m(I)})}catch(I){throw new Error("Error setting user data: ".concat(I))}})}),function(h){return ce.apply(this,arguments)})},{key:"validateAudioLevelInterval",value:function(h){if(h&&(h<100||typeof h!="number"))throw new Error("The interval must be a number greater than or equal to 100 milliseconds.")}},{key:"startLocalAudioLevelObserver",value:function(h){var v=this;if(typeof AudioWorkletNode>"u"&&!de())throw new Error("startLocalAudioLevelObserver() is not supported on this browser");if(this.validateAudioLevelInterval(h),this._callMachineInitialized)return this._isLocalAudioLevelObserverRunning=!0,new Promise(function(m,I){v.sendMessageToCallMachine({action:"start-local-audio-level-observer",interval:h},function(A){v._isLocalAudioLevelObserverRunning=!A.error,A.error?I({error:A.error}):m()})});this._preloadCache.localAudioLevelObserver={enabled:!0,interval:h}}},{key:"isLocalAudioLevelObserverRunning",value:function(){return this._isLocalAudioLevelObserverRunning}},{key:"stopLocalAudioLevelObserver",value:function(){this._preloadCache.localAudioLevelObserver=null,this._localAudioLevel=0,this._isLocalAudioLevelObserverRunning=!1,this.sendMessageToCallMachine({action:"stop-local-audio-level-observer"})}},{key:"startRemoteParticipantsAudioLevelObserver",value:function(h){var v=this;if(this.validateAudioLevelInterval(h),this._callMachineInitialized)return this._isRemoteParticipantsAudioLevelObserverRunning=!0,new Promise(function(m,I){v.sendMessageToCallMachine({action:"start-remote-participants-audio-level-observer",interval:h},function(A){v._isRemoteParticipantsAudioLevelObserverRunning=!A.error,A.error?I({error:A.error}):m()})});this._preloadCache.remoteParticipantsAudioLevelObserver={enabled:!0,interval:h}}},{key:"isRemoteParticipantsAudioLevelObserverRunning",value:function(){return this._isRemoteParticipantsAudioLevelObserverRunning}},{key:"stopRemoteParticipantsAudioLevelObserver",value:function(){this._preloadCache.remoteParticipantsAudioLevelObserver=null,this._remoteParticipantsAudioLevel={},this._isRemoteParticipantsAudioLevelObserverRunning=!1,this.sendMessageToCallMachine({action:"stop-remote-participants-audio-level-observer"})}},{key:"startCamera",value:(G=X(function*(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(lt(this._callObjectMode,"startCamera()"),Sr(this._callState,this._isPreparingToJoin,"startCamera()","Did you mean to use setLocalAudio() and/or setLocalVideo() instead?"),this.needsLoad())try{yield this.load(v)}catch(m){return Promise.reject(m)}else{if(this._didPreAuth){if(v.url&&v.url!==this.properties.url)return console.error("url in startCamera() is different than the one used in preAuth()"),Promise.reject();if(v.token&&v.token!==this.properties.token)return console.error("token in startCamera() is different than the one used in preAuth()"),Promise.reject()}this.validateProperties(v),this.properties=H(H({},this.properties),v)}return new Promise(function(m){h._preloadCache.inputSettings=h._prepInputSettingsForSharing(h._inputSettings,!1),h.sendMessageToCallMachine({action:"start-camera",properties:Si(h.properties,h.callClientId),preloadCache:Si(h._preloadCache,h.callClientId)},function(I){m({camera:I.camera,mic:I.mic,speaker:I.speaker})})})}),function(){return G.apply(this,arguments)})},{key:"validateCustomTrack",value:function(h,v,m){if(m&&m.length>50)throw new Error("Custom track `trackName` must not be more than 50 characters");if(v&&v!=="music"&&v!=="speech"&&!(v instanceof Object))throw new Error("Custom track `mode` must be either `music` | `speech` | `DailyMicAudioModeSettings` or `undefined`");if(m&&["cam-audio","cam-video","screen-video","screen-audio","rmpAudio","rmpVideo","customVideoDefaults"].includes(m))throw new Error("Custom track `trackName` must not match a track name already used by daily: cam-audio, cam-video, customVideoDefaults, screen-video, screen-audio, rmpAudio, rmpVideo");if(!(h instanceof MediaStreamTrack))throw new Error("Custom tracks provided must be instances of MediaStreamTrack")}},{key:"startCustomTrack",value:function(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{track,mode,trackName};return ue(),Te(this._callState,"startCustomTrack()"),this.validateCustomTrack(v.track,v.mode,v.trackName),new Promise(function(m,I){h._sharedTracks.customTrack=v.track,v.track=Lt,h.sendMessageToCallMachine({action:"start-custom-track",properties:v},function(A){A.error?I({error:A.error}):m(A.mediaTag)})})}},{key:"stopCustomTrack",value:function(h){var v=this;return ue(),Te(this._callState,"stopCustomTrack()"),new Promise(function(m){v.sendMessageToCallMachine({action:"stop-custom-track",mediaTag:h},function(I){m(I.mediaTag)})})}},{key:"setCamera",value:function(h){var v=this;return ji(),Fs(this._callMachineInitialized,"setCamera()"),new Promise(function(m){v.sendMessageToCallMachine({action:"set-camera",cameraDeviceId:h},function(I){m({device:I.device})})})}},{key:"setAudioDevice",value:(N=X(function*(h){return ji(),this.nativeUtils().setAudioDevice(h),{deviceId:yield this.nativeUtils().getAudioDevice()}}),function(h){return N.apply(this,arguments)})},{key:"cycleCamera",value:function(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return new Promise(function(m){h.sendMessageToCallMachine({action:"cycle-camera",properties:v},function(I){m({device:I.device})})})}},{key:"cycleMic",value:function(){var h=this;return ue(),new Promise(function(v){h.sendMessageToCallMachine({action:"cycle-mic"},function(m){v({device:m.device})})})}},{key:"getCameraFacingMode",value:function(){var h=this;return ji(),new Promise(function(v){h.sendMessageToCallMachine({action:"get-camera-facing-mode"},function(m){v(m.facingMode)})})}},{key:"setInputDevicesAsync",value:(R=X(function*(h){var v=this,m=h.audioDeviceId,I=h.videoDeviceId,A=h.audioSource,O=h.videoSource;if(ue(),A!==void 0&&(m=A),O!==void 0&&(I=O),typeof m=="boolean"&&(this._setAllowLocalAudio(m),m=void 0),typeof I=="boolean"&&(this._setAllowLocalVideo(I),I=void 0),!m&&!I)return yield this.getInputDevices();var U={};return m&&(m instanceof MediaStreamTrack?(this._sharedTracks.audioTrack=m,m=Lt,U.audio={settings:{customTrack:m}}):(delete this._sharedTracks.audioTrack,U.audio={settings:{deviceId:m}})),I&&(I instanceof MediaStreamTrack?(this._sharedTracks.videoTrack=I,I=Lt,U.video={settings:{customTrack:I}}):(delete this._sharedTracks.videoTrack,U.video={settings:{deviceId:I}})),this._callObjectMode&&this.needsLoad()?(this._updatePreloadCacheInputSettings(U,!1),this._devicesFromInputSettings(this._inputSettings)):new Promise(function(V){v.sendMessageToCallMachine({action:"set-input-devices",audioDeviceId:m,videoDeviceId:I},function(W){if(delete W.action,delete W.callbackStamp,W.returnPreloadCache)return v._updatePreloadCacheInputSettings(U,!1),void V(v._devicesFromInputSettings(v._inputSettings));V(W)})})}),function(h){return R.apply(this,arguments)})},{key:"setOutputDeviceAsync",value:(D=X(function*(h){var v=this,m=h.outputDeviceId;return ue(),m&&(this._preloadCache.outputDeviceId=m),this._callObjectMode&&this.needsLoad()?this._devicesFromInputSettings(this._inputSettings):new Promise(function(I){v.sendMessageToCallMachine({action:"set-output-device",outputDeviceId:m},function(A){delete A.action,delete A.callbackStamp,A.returnPreloadCache?I(v._devicesFromInputSettings(v._inputSettings)):I(A)})})}),function(h){return D.apply(this,arguments)})},{key:"getInputDevices",value:(k=X(function*(){var h=this;return this._callObjectMode&&this.needsLoad()?this._devicesFromInputSettings(this._inputSettings):new Promise(function(v){h.sendMessageToCallMachine({action:"get-input-devices"},function(m){m.returnPreloadCache?v(h._devicesFromInputSettings(h._inputSettings)):v({camera:m.camera,mic:m.mic,speaker:m.speaker})})})}),function(){return k.apply(this,arguments)})},{key:"nativeInCallAudioMode",value:function(){return ji(),this._nativeInCallAudioMode}},{key:"setNativeInCallAudioMode",value:function(h){if(ji(),[Ac,mp].includes(h)){if(h!==this._nativeInCallAudioMode)return this._nativeInCallAudioMode=h,!this.disableReactNativeAutoDeviceManagement("audio")&&Ms(this._callState,this._isPreparingToJoin)&&this.nativeUtils().setAudioMode(this._nativeInCallAudioMode),this}else console.error("invalid in-call audio mode specified: ",h)}},{key:"preAuth",value:(_=X(function*(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(lt(this._callObjectMode,"preAuth()"),Sr(this._callState,this._isPreparingToJoin,"preAuth()"),this.needsLoad()&&(yield this.load(v)),!v.url)throw new Error("preAuth() requires at least a url to be provided");return this.validateProperties(v),this.properties=H(H({},this.properties),v),new Promise(function(m,I){h._preloadCache.inputSettings=h._prepInputSettingsForSharing(h._inputSettings,!1),h.sendMessageToCallMachine({action:"daily-method-preauth",properties:Si(h.properties,h.callClientId),preloadCache:Si(h._preloadCache,h.callClientId)},function(A){return A.error?I(A.error):A.access?(h._didPreAuth=!0,void m({access:A.access})):I(new Error("unknown error in preAuth()"))})})}),function(){return _.apply(this,arguments)})},{key:"load",value:(C=X(function*(h){var v=this;if(this.needsLoad()){if(this._destroyed&&(this._logUseAfterDestroy(),this.strictMode))throw new Error("Use after destroy");if(h&&(this.validateProperties(h),this.properties=H(H({},this.properties),h)),!this._callObjectMode&&!this.properties.url)throw new Error("can't load iframe meeting because url property isn't set");return this._updateCallState(Wo),this.emitDailyJSEvent({action:nl}),this._callObjectMode?new Promise(function(m,I){v._callObjectLoader.cancel();var A=Date.now();v._callObjectLoader.load(v.properties.dailyConfig,function(O){v._bundleLoadTime=O?"no-op":Date.now()-A,v._updateCallState(zo),O&&v.emitDailyJSEvent({action:Xn}),m()},function(O,U){if(v.emitDailyJSEvent({action:rl}),!U){v._updateCallState(wt),v.resetMeetingDependentVars();var V={action:sr,errorMsg:O.msg,error:{type:"connection-error",msg:"Failed to load call object bundle.",details:{on:"load",sourceError:O,bundleUrl:os(v.properties.dailyConfig)}}};v._maybeSendToSentry(V),v.emitDailyJSEvent(V),I(O.msg)}})}):(this._iframe.src=Ba(this.assembleMeetingUrl(),this.properties.dailyConfig),new Promise(function(m,I){v._loadedCallback=function(A){v._callState!==wt?(v._updateCallState(zo),(v.properties.cssFile||v.properties.cssText)&&v.loadCss(v.properties),m()):I(A)}}))}}),function(h){return C.apply(this,arguments)})},{key:"join",value:(b=X(function*(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._testCallInProgress&&this.stopTestCallQuality();var m=!1;if(this.needsLoad()){this.updateIsPreparingToJoin(!0);try{yield this.load(v)}catch(I){return this.updateIsPreparingToJoin(!1),Promise.reject(I)}}else{if(m=!(!this.properties.cssFile&&!this.properties.cssText),this._didPreAuth){if(v.url&&v.url!==this.properties.url)return console.error("url in join() is different than the one used in preAuth()"),this.updateIsPreparingToJoin(!1),Promise.reject();if(v.token&&v.token!==this.properties.token)return console.error("token in join() is different than the one used in preAuth()"),this.updateIsPreparingToJoin(!1),Promise.reject()}if(v.url&&!this._callObjectMode&&v.url&&v.url!==this.properties.url)return console.error("url in join() is different than the one used in load() (".concat(this.properties.url," -> ").concat(v.url,")")),this.updateIsPreparingToJoin(!1),Promise.reject();this.validateProperties(v),this.properties=H(H({},this.properties),v)}return v.showLocalVideo!==void 0&&(this._callObjectMode?console.error("showLocalVideo is not available in callObject mode"):this._showLocalVideo=!!v.showLocalVideo),v.showParticipantsBar!==void 0&&(this._callObjectMode?console.error("showParticipantsBar is not available in callObject mode"):this._showParticipantsBar=!!v.showParticipantsBar),this._callState===$t||this._callState===Is?(console.warn("already joined meeting, call leave() before joining again"),void this.updateIsPreparingToJoin(!1)):(this._updateCallState(Is,!1),this.emitDailyJSEvent({action:ll}),this._preloadCache.inputSettings=this._prepInputSettingsForSharing(this._inputSettings||{},!1),this.sendMessageToCallMachine({action:"join-meeting",properties:Si(this.properties,this.callClientId),preloadCache:Si(this._preloadCache,this.callClientId)}),new Promise(function(I,A){h._joinedCallback=function(O,U){if(h._callState!==wt){if(h._updateCallState($t),O)for(var V in O){if(h._callObjectMode){var W=h._callMachine().store;mc(O[V],W),yc(O[V],W),vc(O[V],h._participants[V],W)}h._participants[V]=H({},O[V]),h.toggleParticipantAudioBasedOnNativeAudioFocus()}m&&h.loadCss(h.properties),I(O)}else A(U)}}))}),function(){return b.apply(this,arguments)})},{key:"leave",value:(x=X(function*(){var h=this;return this._testCallInProgress&&this.stopTestCallQuality(),new Promise(function(v){h._callState===jt||h._callState===wt?v():h._callObjectLoader&&!h._callObjectLoader.loaded?(h._callObjectLoader.cancel(),h._updateCallState(jt),h.resetMeetingDependentVars(),h.emitDailyJSEvent({action:jt}),v()):(h._resolveLeave=v,h.sendMessageToCallMachine({action:"leave-meeting"}))})}),function(){return x.apply(this,arguments)})},{key:"startScreenShare",value:(w=X(function*(){var h=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(Fs(this._callMachineInitialized,"startScreenShare()"),v.screenVideoSendSettings&&this._validateVideoSendSettings("screenVideo",v.screenVideoSendSettings),v.mediaStream&&(this._sharedTracks.screenMediaStream=v.mediaStream,v.mediaStream=Lt),typeof DailyNativeUtils<"u"&&DailyNativeUtils.isIOS!==void 0&&DailyNativeUtils.isIOS){var m=this.nativeUtils();if(yield m.isScreenBeingCaptured())return void this.emitDailyJSEvent({action:ir,type:"screen-share-error",errorMsg:"Could not start the screen sharing. The screen is already been captured!"});m.setSystemScreenCaptureStartCallback(function(){m.setSystemScreenCaptureStartCallback(null),h.sendMessageToCallMachine({action:Ql,captureOptions:v})}),m.presentSystemScreenCapturePrompt()}else this.sendMessageToCallMachine({action:Ql,captureOptions:v})}),function(){return w.apply(this,arguments)})},{key:"stopScreenShare",value:function(){Fs(this._callMachineInitialized,"stopScreenShare()"),this.sendMessageToCallMachine({action:"local-screen-stop"})}},{key:"startRecording",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},v=h.type;if(v&&v!=="cloud"&&v!=="raw-tracks"&&v!=="local")throw new Error("invalid type: ".concat(v,", allowed values 'cloud', 'raw-tracks', or 'local'"));this.sendMessageToCallMachine(H({action:"local-recording-start"},h))}},{key:"updateRecording",value:function(h){var v=h.layout,m=v===void 0?{preset:"default"}:v,I=h.instanceId;this.sendMessageToCallMachine({action:"daily-method-update-recording",layout:m,instanceId:I})}},{key:"stopRecording",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.sendMessageToCallMachine(H({action:"local-recording-stop"},h))}},{key:"startLiveStreaming",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.sendMessageToCallMachine(H({action:"daily-method-start-live-streaming"},h))}},{key:"updateLiveStreaming",value:function(h){var v=h.layout,m=v===void 0?{preset:"default"}:v,I=h.instanceId;this.sendMessageToCallMachine({action:"daily-method-update-live-streaming",layout:m,instanceId:I})}},{key:"addLiveStreamingEndpoints",value:function(h){var v=h.endpoints,m=h.instanceId;this.sendMessageToCallMachine({action:Xl,endpointsOp:Gf,endpoints:v,instanceId:m})}},{key:"removeLiveStreamingEndpoints",value:function(h){var v=h.endpoints,m=h.instanceId;this.sendMessageToCallMachine({action:Xl,endpointsOp:Vf,endpoints:v,instanceId:m})}},{key:"stopLiveStreaming",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.sendMessageToCallMachine(H({action:"daily-method-stop-live-streaming"},h))}},{key:"validateDailyConfig",value:function(h){h.camSimulcastEncodings&&(console.warn("camSimulcastEncodings is deprecated. Use sendSettings, found in DailyCallOptions, to provide camera simulcast settings."),this.validateSimulcastEncodings(h.camSimulcastEncodings)),h.screenSimulcastEncodings&&console.warn("screenSimulcastEncodings is deprecated. Use sendSettings, found in DailyCallOptions, to provide screen simulcast settings."),ac()&&h.noAutoDefaultDeviceChange&&console.warn("noAutoDefaultDeviceChange is not supported on Android, and will be ignored.")}},{key:"validateSimulcastEncodings",value:function(h){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null,m=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(h){if(!(h instanceof Array||Array.isArray(h)))throw new Error("encodings must be an Array");if(!Vc(h.length,1,3))throw new Error("encodings must be an Array with between 1 to ".concat(3," layers"));for(var I=0;I<h.length;I++){var A=h[I];for(var O in this._validateEncodingLayerHasValidProperties(A),A)if(yr.includes(O)){if(typeof A[O]!="number")throw new Error("".concat(O," must be a number"));if(v){var U=v[O],V=U.min,W=U.max;if(!Vc(A[O],V,W))throw new Error("".concat(O," value not in range. valid range: ").concat(V," to ").concat(W))}}else if(!["active","scalabilityMode"].includes(O))throw new Error("Invalid key ".concat(O,", valid keys are:")+Object.values(yr));if(m&&!A.hasOwnProperty("maxBitrate"))throw new Error("maxBitrate is not specified")}}}},{key:"startRemoteMediaPlayer",value:(L=X(function*(h){var v=this,m=h.url,I=h.settings,A=I===void 0?{state:ar.PLAY}:I;try{(function(O){if(typeof O!="string")throw new Error('url parameter must be "string" type')})(m),Gc(A),function(O){for(var U in O)if(!kc.includes(U))throw new Error("Invalid key ".concat(U,", valid keys are: ").concat(kc));O.simulcastEncodings&&this.validateSimulcastEncodings(O.simulcastEncodings,Lc,!0)}(A)}catch(O){throw console.error("invalid argument Error: ".concat(O)),console.error(`startRemoteMediaPlayer arguments must be of the form:
  { url: "playback url",
  settings?:
  {state: "play"|"pause", simulcastEncodings?: [{}] } }`),O}return new Promise(function(O,U){v.sendMessageToCallMachine({action:"daily-method-start-remote-media-player",url:m,settings:A},function(V){V.error?U({error:V.error,errorMsg:V.errorMsg}):O({session_id:V.session_id,remoteMediaPlayerState:{state:V.state,settings:V.settings}})})})}),function(h){return L.apply(this,arguments)})},{key:"stopRemoteMediaPlayer",value:(T=X(function*(h){var v=this;if(typeof h!="string")throw new Error(" remotePlayerID must be of type string");return new Promise(function(m,I){v.sendMessageToCallMachine({action:"daily-method-stop-remote-media-player",session_id:h},function(A){A.error?I({error:A.error,errorMsg:A.errorMsg}):m()})})}),function(h){return T.apply(this,arguments)})},{key:"updateRemoteMediaPlayer",value:(S=X(function*(h){var v=this,m=h.session_id,I=h.settings;try{Gc(I)}catch(A){throw console.error("invalid argument Error: ".concat(A)),console.error(`updateRemoteMediaPlayer arguments must be of the form:
  session_id: "participant session",
  { settings?: {state: "play"|"pause"} }`),A}return new Promise(function(A,O){v.sendMessageToCallMachine({action:"daily-method-update-remote-media-player",session_id:m,settings:I},function(U){U.error?O({error:U.error,errorMsg:U.errorMsg}):A({session_id:U.session_id,remoteMediaPlayerState:{state:U.state,settings:U.settings}})})})}),function(h){return S.apply(this,arguments)})},{key:"startTranscription",value:function(h){Te(this._callState,"startTranscription()"),this.sendMessageToCallMachine(H({action:"daily-method-start-transcription"},h))}},{key:"updateTranscription",value:function(h){if(Te(this._callState,"updateTranscription()"),!h)throw new Error("updateTranscription Error: options is mandatory");if(me(h)!=="object")throw new Error("updateTranscription Error: options must be object type");if(h.participants&&!Array.isArray(h.participants))throw new Error("updateTranscription Error: participants must be an array");this.sendMessageToCallMachine(H({action:"daily-method-update-transcription"},h))}},{key:"stopTranscription",value:function(h){if(Te(this._callState,"stopTranscription()"),h&&me(h)!=="object")throw new Error("stopTranscription Error: options must be object type");if(h&&!h.instanceId)throw new Error('"instanceId" not provided');this.sendMessageToCallMachine(H({action:"daily-method-stop-transcription"},h))}},{key:"startDialOut",value:(y=X(function*(h){var v=this;Te(this._callState,"startDialOut()");var m=function(I){if(I){if(!Array.isArray(I))throw new Error("Error starting dial out: audio codec must be an array");if(I.length<=0)throw new Error("Error starting dial out: audio codec array specified but empty");I.forEach(function(A){if(typeof A!="string")throw new Error("Error starting dial out: audio codec must be a string");if(A!=="OPUS"&&A!=="PCMU"&&A!=="PCMA"&&A!=="G722")throw new Error("Error starting dial out: audio codec must be one of OPUS, PCMU, PCMA, G722")})}};if(!h.sipUri&&!h.phoneNumber)throw new Error("Error starting dial out: either a sip uri or phone number must be provided");if(h.sipUri&&h.phoneNumber)throw new Error("Error starting dial out: only one of sip uri or phone number must be provided");if(h.sipUri){if(typeof h.sipUri!="string")throw new Error("Error starting dial out: sipUri must be a string");if(!h.sipUri.startsWith("sip:"))throw new Error("Error starting dial out: Invalid SIP URI, must start with 'sip:'");if(h.video&&typeof h.video!="boolean")throw new Error("Error starting dial out: video must be a boolean value");(function(I){if(I&&(m(I.audio),I.video)){if(!Array.isArray(I.video))throw new Error("Error starting dial out: video codec must be an array");if(I.video.length<=0)throw new Error("Error starting dial out: video codec array specified but empty");I.video.forEach(function(A){if(typeof A!="string")throw new Error("Error starting dial out: video codec must be a string");if(A!=="H264"&&A!=="VP8")throw new Error("Error starting dial out: video codec must be H264 or VP8")})}})(h.codecs)}if(h.phoneNumber){if(typeof h.phoneNumber!="string")throw new Error("Error starting dial out: phoneNumber must be a string");if(!/^\+\d{1,}$/.test(h.phoneNumber))throw new Error("Error starting dial out: Invalid phone number, must be valid phone number as per E.164");h.codecs&&m(h.codecs.audio)}if(h.callerId){if(typeof h.callerId!="string")throw new Error("Error starting dial out: callerId must be a string");if(h.sipUri)throw new Error("Error starting dial out: callerId not allowed with sipUri")}if(h.displayName){if(typeof h.displayName!="string")throw new Error("Error starting dial out: displayName must be a string");if(h.displayName.length>=200)throw new Error("Error starting dial out: displayName length must be less than 200")}if(h.userId){if(typeof h.userId!="string")throw new Error("Error starting dial out: userId must be a string");if(h.userId.length>36)throw new Error("Error starting dial out: userId length must be less than or equal to 36")}return new Promise(function(I,A){v.sendMessageToCallMachine(H({action:"dialout-start"},h),function(O){O.error?A(O.error):I(O)})})}),function(h){return y.apply(this,arguments)})},{key:"stopDialOut",value:function(h){var v=this;return Te(this._callState,"stopDialOut()"),new Promise(function(m,I){v.sendMessageToCallMachine(H({action:"dialout-stop"},h),function(A){A.error?I(A.error):m(A)})})}},{key:"sipCallTransfer",value:(g=X(function*(h){var v=this;if(Te(this._callState,"sipCallTransfer()"),!h)throw new Error("sipCallTransfer() requires a sessionId and toEndPoint");return h.useSipRefer=!1,jc(h,"sipCallTransfer"),new Promise(function(m,I){v.sendMessageToCallMachine(H({action:ec},h),function(A){A.error?I(A.error):m(A)})})}),function(h){return g.apply(this,arguments)})},{key:"sipRefer",value:(p=X(function*(h){var v=this;if(Te(this._callState,"sipRefer()"),!h)throw new Error("sessionId and toEndPoint are mandatory parameter");return h.useSipRefer=!0,jc(h,"sipRefer"),new Promise(function(m,I){v.sendMessageToCallMachine(H({action:ec},h),function(A){A.error?I(A.error):m(A)})})}),function(h){return p.apply(this,arguments)})},{key:"sendDTMF",value:(f=X(function*(h){var v=this;return Te(this._callState,"sendDTMF()"),function(m){var I=m.sessionId,A=m.tones;if(!I||!A)throw new Error("sessionId and tones are mandatory parameter");if(typeof I!="string"||typeof A!="string")throw new Error("sessionId and tones should be of string type");if(A.length>20)throw new Error("tones string must be upto 20 characters");var O=/[^0-9A-D*#]/g,U=A.match(O);if(U&&U[0])throw new Error("".concat(U[0]," is not valid DTMF tone"))}(h),new Promise(function(m,I){v.sendMessageToCallMachine(H({action:"send-dtmf"},h),function(A){A.error?I(A.error):m(A)})})}),function(h){return f.apply(this,arguments)})},{key:"getNetworkStats",value:function(){var h=this;return this._callState!==$t?{stats:{latest:{}}}:new Promise(function(v){h.sendMessageToCallMachine({action:"get-calc-stats"},function(m){v(H({stats:m.stats},h._network))})})}},{key:"testWebsocketConnectivity",value:(d=X(function*(){var h=this;if(Er(this._testCallInProgress,"testWebsocketConnectivity()"),this.needsLoad())try{yield this.load()}catch(v){return Promise.reject(v)}return new Promise(function(v,m){h.sendMessageToCallMachine({action:"test-websocket-connectivity"},function(I){I.error?m(I.error):v(I.results)})})}),function(){return d.apply(this,arguments)})},{key:"abortTestWebsocketConnectivity",value:function(){this.sendMessageToCallMachine({action:"abort-test-websocket-connectivity"})}},{key:"_validateVideoTrackForNetworkTests",value:function(h){return h?h instanceof MediaStreamTrack?!!hp(h)||(console.error("Video track is not playable. This test needs a live video track."),!1):(console.error("Video track needs to be of type `MediaStreamTrack`."),!1):(console.error("Missing video track. You must provide a video track in order to run this test."),!1)}},{key:"testCallQuality",value:(u=X(function*(){var h=this;ue(),lt(this._callObjectMode,"testCallQuality()"),Fs(this._callMachineInitialized,"testCallQuality()",null,!0),Sr(this._callState,this._isPreparingToJoin,"testCallQuality()");var v=this._testCallAlreadyInProgress,m=function(A){v||(h._testCallInProgress=A)};if(m(!0),this.needsLoad())try{var I=this._callState;yield this.load(),this._callState=I}catch(A){return m(!1),Promise.reject(A)}return new Promise(function(A){h.sendMessageToCallMachine({action:"test-call-quality",dailyJsVersion:h.properties.dailyJsVersion},function(O){var U=O.results,V=U.result,W=Sa(U,fp);if(V==="failed"){var he,le=H({},W);(he=W.error)!==null&&he!==void 0&&he.details?(W.error.details=JSON.parse(W.error.details),le.error=H(H({},le.error),{},{details:H({},le.error.details)}),le.error.details.duringTest="testCallQuality"):(le.error=le.error?H({},le.error):{},le.error.details={duringTest:"testCallQuality"}),h._maybeSendToSentry(le)}m(!1),A(H({result:V},W))})})}),function(){return u.apply(this,arguments)})},{key:"stopTestCallQuality",value:function(){this.sendMessageToCallMachine({action:"stop-test-call-quality"})}},{key:"testConnectionQuality",value:(c=X(function*(h){var v;de()?(console.warn("testConnectionQuality() is deprecated: use testPeerToPeerCallQuality() instead"),v=yield this.testPeerToPeerCallQuality(h)):(console.warn("testConnectionQuality() is deprecated: use testCallQuality() instead"),v=yield this.testCallQuality());var m={result:v.result,secondsElapsed:v.secondsElapsed};return v.data&&(m.data={maxRTT:v.data.maxRoundTripTime,packetLoss:v.data.avgRecvPacketLoss}),m}),function(h){return c.apply(this,arguments)})},{key:"testPeerToPeerCallQuality",value:(l=X(function*(h){var v=this;if(Er(this._testCallInProgress,"testPeerToPeerCallQuality()"),this.needsLoad())try{yield this.load()}catch(A){return Promise.reject(A)}var m=h.videoTrack,I=h.duration;if(!this._validateVideoTrackForNetworkTests(m))throw new Error("Video track error");return this._sharedTracks.videoTrackForConnectionQualityTest=m,new Promise(function(A,O){v.sendMessageToCallMachine({action:"test-p2p-call-quality",duration:I},function(U){U.error?O(U.error):A(U.results)})})}),function(h){return l.apply(this,arguments)})},{key:"stopTestConnectionQuality",value:function(){de()?(console.warn("stopTestConnectionQuality() is deprecated: use testPeerToPeerCallQuality() and stopTestPeerToPeerCallQuality() instead"),this.stopTestPeerToPeerCallQuality()):(console.warn("stopTestConnectionQuality() is deprecated: use testCallQuality() and stopTestCallQuality() instead"),this.stopTestCallQuality())}},{key:"stopTestPeerToPeerCallQuality",value:function(){this.sendMessageToCallMachine({action:"stop-test-p2p-call-quality"})}},{key:"testNetworkConnectivity",value:(o=X(function*(h){var v=this;if(Er(this._testCallInProgress,"testNetworkConnectivity()"),this.needsLoad())try{yield this.load()}catch(m){return Promise.reject(m)}if(!this._validateVideoTrackForNetworkTests(h))throw new Error("Video track error");return this._sharedTracks.videoTrackForNetworkConnectivityTest=h,new Promise(function(m,I){v.sendMessageToCallMachine({action:"test-network-connectivity"},function(A){A.error?I(A.error):m(A.results)})})}),function(h){return o.apply(this,arguments)})},{key:"abortTestNetworkConnectivity",value:function(){this.sendMessageToCallMachine({action:"abort-test-network-connectivity"})}},{key:"getCpuLoadStats",value:function(){var h=this;return new Promise(function(v){h._callState===$t?h.sendMessageToCallMachine({action:"get-cpu-load-stats"},function(m){v(m.cpuStats)}):v({cpuLoadState:void 0,cpuLoadStateReason:void 0,stats:{}})})}},{key:"_validateEncodingLayerHasValidProperties",value:function(h){var v;if(!(((v=Object.keys(h))===null||v===void 0?void 0:v.length)>0))throw new Error("Empty encoding is not allowed. At least one of these valid keys should be specified:"+Object.values(yr))}},{key:"_validateVideoSendSettings",value:function(h,v){var m=h==="screenVideo"?["default-screen-video","detail-optimized","motion-optimized","motion-and-detail-balanced"]:["default-video","bandwidth-optimized","bandwidth-and-quality-balanced","quality-optimized","adaptive-2-layers","adaptive-3-layers"],I="Video send settings should be either an object or one of the supported presets: ".concat(m.join());if(typeof v=="string"){if(!m.includes(v))throw new Error(I)}else{if(me(v)!=="object")throw new Error(I);if(!v.maxQuality&&!v.encodings&&v.allowAdaptiveLayers===void 0)throw new Error("Video send settings must contain at least maxQuality, allowAdaptiveLayers or encodings attribute");if(v.maxQuality&&["low","medium","high"].indexOf(v.maxQuality)===-1)throw new Error("maxQuality must be either low, medium or high");if(v.encodings){var A=!1;switch(Object.keys(v.encodings).length){case 1:A=!v.encodings.low;break;case 2:A=!v.encodings.low||!v.encodings.medium;break;case 3:A=!v.encodings.low||!v.encodings.medium||!v.encodings.high;break;default:A=!0}if(A)throw new Error("Encodings must be defined as: low, low and medium, or low, medium and high.");v.encodings.low&&this._validateEncodingLayerHasValidProperties(v.encodings.low),v.encodings.medium&&this._validateEncodingLayerHasValidProperties(v.encodings.medium),v.encodings.high&&this._validateEncodingLayerHasValidProperties(v.encodings.high)}}}},{key:"validateUpdateSendSettings",value:function(h){var v=this;if(!h||Object.keys(h).length===0)throw new Error("Send settings must contain at least information for one track!");Object.entries(h).forEach(function(m){var I=dt(m,2),A=I[0],O=I[1];v._validateVideoSendSettings(A,O)})}},{key:"updateSendSettings",value:function(h){var v=this;return this.validateUpdateSendSettings(h),this.needsLoad()?(this._preloadCache.sendSettings=h,{sendSettings:this._preloadCache.sendSettings}):new Promise(function(m,I){v.sendMessageToCallMachine({action:"update-send-settings",sendSettings:h},function(A){A.error?I(A.error):m(A.sendSettings)})})}},{key:"getSendSettings",value:function(){return this._sendSettings||this._preloadCache.sendSettings}},{key:"getLocalAudioLevel",value:function(){return this._localAudioLevel}},{key:"getRemoteParticipantsAudioLevel",value:function(){return this._remoteParticipantsAudioLevel}},{key:"getActiveSpeaker",value:function(){return ue(),this._activeSpeaker}},{key:"setActiveSpeakerMode",value:function(h){return ue(),this.sendMessageToCallMachine({action:"set-active-speaker-mode",enabled:h}),this}},{key:"activeSpeakerMode",value:function(){return ue(),this._activeSpeakerMode}},{key:"subscribeToTracksAutomatically",value:function(){return this._preloadCache.subscribeToTracksAutomatically}},{key:"setSubscribeToTracksAutomatically",value:function(h){return Te(this._callState,"setSubscribeToTracksAutomatically()","Use the subscribeToTracksAutomatically configuration property."),this._preloadCache.subscribeToTracksAutomatically=h,this.sendMessageToCallMachine({action:"daily-method-subscribe-to-tracks-automatically",enabled:h}),this}},{key:"enumerateDevices",value:(a=X(function*(){var h=this;if(this._callObjectMode){var v=yield navigator.mediaDevices.enumerateDevices();return si()==="Firefox"&&Cs().major>115&&Cs().major<123&&(v=v.filter(function(m){return m.kind!=="audiooutput"})),{devices:v.map(function(m){var I=JSON.parse(JSON.stringify(m));if(!de()&&m.kind==="videoinput"&&m.getCapabilities){var A,O=m.getCapabilities();I.facing=(O==null||(A=O.facingMode)===null||A===void 0?void 0:A.length)>=1?O.facingMode[0]:void 0}return I})}}return new Promise(function(m){h.sendMessageToCallMachine({action:"enumerate-devices"},function(I){m({devices:I.devices})})})}),function(){return a.apply(this,arguments)})},{key:"sendAppMessage",value:function(h){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"*";if(Te(this._callState,"sendAppMessage()"),JSON.stringify(h).length>this._maxAppMessageSize)throw new Error("Message data too large. Max size is "+this._maxAppMessageSize);return this.sendMessageToCallMachine({action:"app-msg",data:h,to:v}),this}},{key:"addFakeParticipant",value:function(h){return ue(),Te(this._callState,"addFakeParticipant()"),this.sendMessageToCallMachine(H({action:"add-fake-participant"},h)),this}},{key:"setShowNamesMode",value:function(h){return He(this._callObjectMode,"setShowNamesMode()"),ue(),h&&h!=="always"&&h!=="never"?(console.error('setShowNamesMode argument should be "always", "never", or false'),this):(this.sendMessageToCallMachine({action:"set-show-names",mode:h}),this)}},{key:"setShowLocalVideo",value:function(){var h=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return He(this._callObjectMode,"setShowLocalVideo()"),ue(),Te(this._callState,"setShowLocalVideo()"),typeof h!="boolean"?(console.error("setShowLocalVideo only accepts a boolean value"),this):(this.sendMessageToCallMachine({action:"set-show-local-video",show:h}),this._showLocalVideo=h,this)}},{key:"showLocalVideo",value:function(){return He(this._callObjectMode,"showLocalVideo()"),ue(),this._showLocalVideo}},{key:"setShowParticipantsBar",value:function(){var h=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return He(this._callObjectMode,"setShowParticipantsBar()"),ue(),Te(this._callState,"setShowParticipantsBar()"),typeof h!="boolean"?(console.error("setShowParticipantsBar only accepts a boolean value"),this):(this.sendMessageToCallMachine({action:"set-show-participants-bar",show:h}),this._showParticipantsBar=h,this)}},{key:"showParticipantsBar",value:function(){return He(this._callObjectMode,"showParticipantsBar()"),ue(),this._showParticipantsBar}},{key:"customIntegrations",value:function(){return ue(),He(this._callObjectMode,"customIntegrations()"),this._customIntegrations}},{key:"setCustomIntegrations",value:function(h){return ue(),He(this._callObjectMode,"setCustomIntegrations()"),Te(this._callState,"setCustomIntegrations()"),Bc(h)?(this.sendMessageToCallMachine({action:"set-custom-integrations",integrations:h}),this._customIntegrations=h,this):this}},{key:"startCustomIntegrations",value:function(h){var v=this;if(ue(),He(this._callObjectMode,"startCustomIntegrations()"),Te(this._callState,"startCustomIntegrations()"),Array.isArray(h)&&h.some(function(A){return typeof A!="string"})||!Array.isArray(h)&&typeof h!="string")return console.error("startCustomIntegrations() only accepts string | string[]"),this;var m=typeof h=="string"?[h]:h,I=m.filter(function(A){return!(A in v._customIntegrations)});return I.length?(console.error(`Can't find custom integration(s): "`.concat(I.join(", "),'"')),this):(this.sendMessageToCallMachine({action:"start-custom-integrations",ids:m}),this)}},{key:"stopCustomIntegrations",value:function(h){var v=this;if(ue(),He(this._callObjectMode,"stopCustomIntegrations()"),Te(this._callState,"stopCustomIntegrations()"),Array.isArray(h)&&h.some(function(A){return typeof A!="string"})||!Array.isArray(h)&&typeof h!="string")return console.error("stopCustomIntegrations() only accepts string | string[]"),this;var m=typeof h=="string"?[h]:h,I=m.filter(function(A){return!(A in v._customIntegrations)});return I.length?(console.error(`Can't find custom integration(s): "`.concat(I.join(", "),'"')),this):(this.sendMessageToCallMachine({action:"stop-custom-integrations",ids:m}),this)}},{key:"customTrayButtons",value:function(){return He(this._callObjectMode,"customTrayButtons()"),ue(),this._customTrayButtons}},{key:"updateCustomTrayButtons",value:function(h){return He(this._callObjectMode,"updateCustomTrayButtons()"),ue(),Te(this._callState,"updateCustomTrayButtons()"),Uc(h)?(this.sendMessageToCallMachine({action:"update-custom-tray-buttons",btns:h}),this._customTrayButtons=h,this):(console.error("updateCustomTrayButtons only accepts a dictionary of the type ".concat(JSON.stringify(Ds))),this)}},{key:"theme",value:function(){return He(this._callObjectMode,"theme()"),this.properties.theme}},{key:"setTheme",value:function(h){var v=this;return He(this._callObjectMode,"setTheme()"),new Promise(function(m,I){try{v.validateProperties({theme:h}),v.properties.theme=H({},h),v.sendMessageToCallMachine({action:"set-theme",theme:v.properties.theme});try{v.emitDailyJSEvent({action:sl,theme:v.properties.theme})}catch(A){console.log("could not emit 'theme-updated'",A)}m(v.properties.theme)}catch(A){I(A)}})}},{key:"requestFullscreen",value:(r=X(function*(){if(ue(),this._iframe&&!document.fullscreenElement&&ic())try{(yield this._iframe.requestFullscreen)?this._iframe.requestFullscreen():this._iframe.webkitRequestFullscreen()}catch(h){console.log("could not make video call fullscreen",h)}}),function(){return r.apply(this,arguments)})},{key:"exitFullscreen",value:function(){ue(),document.fullscreenElement?document.exitFullscreen():document.webkitFullscreenElement&&document.webkitExitFullscreen()}},{key:"getSidebarView",value:(n=X(function*(){var h=this;return this._callObjectMode?(console.error("getSidebarView is not available in callObject mode"),Promise.resolve(null)):new Promise(function(v){h.sendMessageToCallMachine({action:"get-sidebar-view"},function(m){v(m.view)})})}),function(){return n.apply(this,arguments)})},{key:"setSidebarView",value:function(h){return this._callObjectMode?(console.error("setSidebarView is not available in callObject mode"),this):(this.sendMessageToCallMachine({action:"set-sidebar-view",view:h}),this)}},{key:"room",value:(i=X(function*(){var h=this,v=(arguments.length>0&&arguments[0]!==void 0?arguments[0]:{}).includeRoomConfigDefaults,m=v===void 0||v;return this._accessState.access===ws||this.needsLoad()?this.properties.url?{roomUrlPendingJoin:this.properties.url}:null:new Promise(function(I){h.sendMessageToCallMachine({action:"lib-room-info",includeRoomConfigDefaults:m},function(A){delete A.action,delete A.callbackStamp,I(A)})})}),function(){return i.apply(this,arguments)})},{key:"geo",value:(t=X(function*(){try{var h=yield fetch("https://gs.daily.co/_ks_/x-swsl/:");return{current:(yield h.json()).geo}}catch(v){return console.error("geo lookup failed",v),{current:""}}}),function(){return t.apply(this,arguments)})},{key:"setNetworkTopology",value:(e=X(function*(h){var v=this;return ue(),Te(this._callState,"setNetworkTopology()"),new Promise(function(m,I){v.sendMessageToCallMachine({action:"set-network-topology",opts:h},function(A){A.error?I({error:A.error}):m({workerId:A.workerId})})})}),function(h){return e.apply(this,arguments)})},{key:"getNetworkTopology",value:(s=X(function*(){var h=this;return new Promise(function(v,m){h.needsLoad()&&v({topology:"none"}),h.sendMessageToCallMachine({action:"get-network-topology"},function(I){I.error?m({error:I.error}):v({topology:I.topology})})})}),function(){return s.apply(this,arguments)})},{key:"setPlayNewParticipantSound",value:function(h){if(ue(),typeof h!="number"&&h!==!0&&h!==!1)throw new Error("argument to setShouldPlayNewParticipantSound should be true, false, or a number, but is ".concat(h));this.sendMessageToCallMachine({action:"daily-method-set-play-ding",arg:h})}},{key:"on",value:function(h,v){return xt.prototype.on.call(this,h,v)}},{key:"once",value:function(h,v){return xt.prototype.once.call(this,h,v)}},{key:"off",value:function(h,v){return xt.prototype.off.call(this,h,v)}},{key:"validateProperties",value:function(h){var v,m;if(h!=null&&(v=h.dailyConfig)!==null&&v!==void 0&&v.userMediaAudioConstraints){var I,A,O;de()||console.warn("userMediaAudioConstraints is deprecated. You can override constraints with inputSettings.audio.settings, found in DailyCallOptions.");var U=h.inputSettings||{};U.audio=((I=h.inputSettings)===null||I===void 0?void 0:I.audio)||{},U.audio.settings=((A=h.inputSettings)===null||A===void 0||(O=A.audio)===null||O===void 0?void 0:O.settings)||{},U.audio.settings=H(H({},U.audio.settings),h.dailyConfig.userMediaAudioConstraints),h.inputSettings=U,delete h.dailyConfig.userMediaAudioConstraints}if(h!=null&&(m=h.dailyConfig)!==null&&m!==void 0&&m.userMediaVideoConstraints){var V,W,he;de()||console.warn("userMediaVideoConstraints is deprecated. You can override constraints with inputSettings.video.settings, found in DailyCallOptions.");var le=h.inputSettings||{};le.video=((V=h.inputSettings)===null||V===void 0?void 0:V.video)||{},le.video.settings=((W=h.inputSettings)===null||W===void 0||(he=W.video)===null||he===void 0?void 0:he.settings)||{},le.video.settings=H(H({},le.video.settings),h.dailyConfig.userMediaVideoConstraints),h.inputSettings=le,delete h.dailyConfig.userMediaVideoConstraints}for(var Re in h){if(!ri[Re])throw new Error("unrecognized property '".concat(Re,"'"));if(ri[Re].validate&&!ri[Re].validate(h[Re],this))throw new Error("property '".concat(Re,"': ").concat(ri[Re].help))}}},{key:"assembleMeetingUrl",value:function(){var h,v,m=H(H({},this.properties),{},{emb:this.callClientId,embHref:encodeURIComponent(window.location.href),proxy:(h=this.properties.dailyConfig)!==null&&h!==void 0&&h.proxyUrl?encodeURIComponent((v=this.properties.dailyConfig)===null||v===void 0?void 0:v.proxyUrl):void 0}),I=m.url.match(/\?/)?"&":"?";return m.url+I+Object.keys(ri).filter(function(A){return ri[A].queryString&&m[A]!==void 0}).map(function(A){return"".concat(ri[A].queryString,"=").concat(m[A])}).join("&")}},{key:"needsLoad",value:function(){return[Jn,Wo,jt,wt].includes(this._callState)}},{key:"sendMessageToCallMachine",value:function(h,v){if(this._destroyed&&(this._logUseAfterDestroy(),this.strictMode))throw new Error("Use after destroy");this._messageChannel.sendMessageToCallMachine(h,v,this.callClientId,this._iframe)}},{key:"forwardPackagedMessageToCallMachine",value:function(h){this._messageChannel.forwardPackagedMessageToCallMachine(h,this._iframe,this.callClientId)}},{key:"addListenerForPackagedMessagesFromCallMachine",value:function(h){return this._messageChannel.addListenerForPackagedMessagesFromCallMachine(h,this.callClientId)}},{key:"removeListenerForPackagedMessagesFromCallMachine",value:function(h){this._messageChannel.removeListenerForPackagedMessagesFromCallMachine(h)}},{key:"handleMessageFromCallMachine",value:function(h){switch(h.action){case tl:this.sendMessageToCallMachine(H({action:il},this.properties));break;case"call-machine-initialized":this._callMachineInitialized=!0;var v={action:Ls,level:"log",code:1011,stats:{event:"bundle load",time:this._bundleLoadTime==="no-op"?0:this._bundleLoadTime,preLoaded:this._bundleLoadTime==="no-op",url:os(this.properties.dailyConfig)}};this.sendMessageToCallMachine(v),this._delayDuplicateInstanceLog&&this._logDuplicateInstanceAttempt();break;case Xn:this._loadedCallback&&(this._loadedCallback(),this._loadedCallback=null),this.emitDailyJSEvent(h);break;case cl:var m,I=H({},h);delete I.internal,this._maxAppMessageSize=((m=h.internal)===null||m===void 0?void 0:m._maxAppMessageSize)||nr,this._joinedCallback&&(this._joinedCallback(h.participants),this._joinedCallback=null),this.emitDailyJSEvent(I);break;case dl:case hl:if(this._callState===jt)return;if(h.participant&&h.participant.session_id){var A=h.participant.local?"local":h.participant.session_id;if(this._callObjectMode){var O=this._callMachine().store;mc(h.participant,O),yc(h.participant,O),vc(h.participant,this._participants[A],O)}try{this.maybeParticipantTracksStopped(this._participants[A],h.participant),this.maybeParticipantTracksStarted(this._participants[A],h.participant),this.maybeEventRecordingStopped(this._participants[A],h.participant),this.maybeEventRecordingStarted(this._participants[A],h.participant)}catch(Yt){console.error("track events error",Yt)}this.compareEqualForParticipantUpdateEvent(h.participant,this._participants[A])||(this._participants[A]=H({},h.participant),this.toggleParticipantAudioBasedOnNativeAudioFocus(),this.emitDailyJSEvent(h))}break;case fl:if(h.participant&&h.participant.session_id){var U=this._participants[h.participant.session_id];U&&this.maybeParticipantTracksStopped(U,null),delete this._participants[h.participant.session_id],this.emitDailyJSEvent(h)}break;case pl:$e(this._participantCounts,h.participantCounts)||(this._participantCounts=h.participantCounts,this.emitDailyJSEvent(h));break;case gl:var V={access:h.access};h.awaitingAccess&&(V.awaitingAccess=h.awaitingAccess),$e(this._accessState,V)||(this._accessState=V,this.emitDailyJSEvent(h));break;case ml:if(h.meetingSession){this._meetingSessionSummary=h.meetingSession,this.emitDailyJSEvent(h);var W=H(H({},h),{},{action:"meeting-session-updated"});this.emitDailyJSEvent(W)}break;case sr:var he;this._iframe&&!h.preserveIframe&&(this._iframe.src=""),this._updateCallState(wt),this.resetMeetingDependentVars(),this._loadedCallback&&(this._loadedCallback(h.errorMsg),this._loadedCallback=null),h.preserveIframe;var le=Sa(h,pp);le!=null&&(he=le.error)!==null&&he!==void 0&&he.details&&(le.error.details=JSON.parse(le.error.details)),this._maybeSendToSentry(h),this._joinedCallback&&(this._joinedCallback(null,le),this._joinedCallback=null),this.emitDailyJSEvent(le);break;case ul:this._callState!==wt&&this._updateCallState(jt),this.resetMeetingDependentVars(),this._resolveLeave&&(this._resolveLeave(),this._resolveLeave=null),this.emitDailyJSEvent(h);break;case"selected-devices-updated":h.devices&&this.emitDailyJSEvent(h);break;case $l:var Re=h.threshold,ie=h.quality;Re===this._network.threshold&&ie===this._network.quality||(this._network.quality=ie,this._network.threshold=Re,this.emitDailyJSEvent(h));break;case Gl:h&&h.cpuLoadState&&this.emitDailyJSEvent(h);break;case Vl:h&&h.faceCounts!==void 0&&this.emitDailyJSEvent(h);break;case Ul:var Ae=h.activeSpeaker;this._activeSpeaker.peerId!==Ae.peerId&&(this._activeSpeaker.peerId=Ae.peerId,this.emitDailyJSEvent({action:h.action,activeSpeaker:this._activeSpeaker}));break;case"show-local-video-changed":if(this._callObjectMode)return;var ke=h.show;this._showLocalVideo=ke,this.emitDailyJSEvent({action:h.action,show:ke});break;case Bl:var We=h.enabled;this._activeSpeakerMode!==We&&(this._activeSpeakerMode=We,this.emitDailyJSEvent({action:h.action,enabled:this._activeSpeakerMode}));break;case vl:case Sl:case El:this._waitingParticipants=h.allWaitingParticipants,this.emitDailyJSEvent({action:h.action,participant:h.participant});break;case zl:$e(this._receiveSettings,h.receiveSettings)||(this._receiveSettings=h.receiveSettings,this.emitDailyJSEvent({action:h.action,receiveSettings:h.receiveSettings}));break;case tr:this._maybeUpdateInputSettings(h.inputSettings);break;case"send-settings-updated":$e(this._sendSettings,h.sendSettings)||(this._sendSettings=h.sendSettings,this._preloadCache.sendSettings=null,this.emitDailyJSEvent({action:h.action,sendSettings:h.sendSettings}));break;case"local-audio-level":this._localAudioLevel=h.audioLevel,this._preloadCache.localAudioLevelObserver=null,this.emitDailyJSEvent(h);break;case"remote-participants-audio-level":this._remoteParticipantsAudioLevel=h.participantsAudioLevel,this._preloadCache.remoteParticipantsAudioLevelObserver=null,this.emitDailyJSEvent(h);break;case Pl:var Se=h.session_id;this._rmpPlayerState[Se]=h.playerState,this.emitDailyJSEvent(h);break;case Ol:delete this._rmpPlayerState[h.session_id],this.emitDailyJSEvent(h);break;case Dl:var Oe=h.session_id,Be=this._rmpPlayerState[Oe];Be&&this.compareEqualForRMPUpdateEvent(Be,h.remoteMediaPlayerState)||(this._rmpPlayerState[Oe]=h.remoteMediaPlayerState,this.emitDailyJSEvent(h));break;case"custom-button-click":case"sidebar-view-changed":this.emitDailyJSEvent(h);break;case yl:var ui=this._meetingSessionState.topology!==(h.meetingSessionState&&h.meetingSessionState.topology);this._meetingSessionState=br(h.meetingSessionState,this._callObjectMode),(this._callObjectMode||ui)&&this.emitDailyJSEvent(h);break;case Ml:this._isScreenSharing=!0,this.emitDailyJSEvent(h);break;case Fl:case Nl:this._isScreenSharing=!1,this.emitDailyJSEvent(h);break;case Zn:case er:case Il:case wl:case Ll:case _l:case xl:case Al:case al:case ol:case Cl:case Rl:case"test-completed":case jl:case kl:case ql:case Hl:case Kl:case Yl:case ir:case Wl:case"dialin-ready":case"dialin-connected":case"dialin-error":case"dialin-stopped":case"dialin-warning":case"dialout-connected":case"dialout-answered":case"dialout-error":case"dialout-stopped":case"dialout-warning":this.emitDailyJSEvent(h);break;case"request-fullscreen":this.requestFullscreen();break;case"request-exit-fullscreen":this.exitFullscreen()}}},{key:"maybeEventRecordingStopped",value:function(h,v){var m="record";h&&(v.local||v[m]!==!1||h[m]===v[m]||this.emitDailyJSEvent({action:er}))}},{key:"maybeEventRecordingStarted",value:function(h,v){var m="record";h&&(v.local||v[m]!==!0||h[m]===v[m]||this.emitDailyJSEvent({action:Zn}))}},{key:"_trackStatePlayable",value:function(h){return!(!h||h.state!==Jo)}},{key:"_trackChanged",value:function(h,v){return(h==null?void 0:h.id)!==(v==null?void 0:v.id)}},{key:"maybeEventTrackStopped",value:function(h,v,m){var I,A,O=(I=v==null?void 0:v.tracks[h])!==null&&I!==void 0?I:null,U=(A=m==null?void 0:m.tracks[h])!==null&&A!==void 0?A:null,V=O==null?void 0:O.track;if(V){var W=this._trackStatePlayable(O),he=this._trackStatePlayable(U),le=this._trackChanged(V,U==null?void 0:U.track);W&&(he&&!le||this.emitDailyJSEvent({action:bl,track:V,participant:m??v,type:h}))}}},{key:"maybeEventTrackStarted",value:function(h,v,m){var I,A,O=(I=v==null?void 0:v.tracks[h])!==null&&I!==void 0?I:null,U=(A=m==null?void 0:m.tracks[h])!==null&&A!==void 0?A:null,V=U==null?void 0:U.track;if(V){var W=this._trackStatePlayable(O),he=this._trackStatePlayable(U),le=this._trackChanged(O==null?void 0:O.track,V);he&&(W&&!le||this.emitDailyJSEvent({action:Tl,track:V,participant:m,type:h}))}}},{key:"maybeParticipantTracksStopped",value:function(h,v){if(h)for(var m in h.tracks)this.maybeEventTrackStopped(m,h,v)}},{key:"maybeParticipantTracksStarted",value:function(h,v){if(v)for(var m in v.tracks)this.maybeEventTrackStarted(m,h,v)}},{key:"compareEqualForRMPUpdateEvent",value:function(h,v){var m,I;return h.state===v.state&&((m=h.settings)===null||m===void 0?void 0:m.volume)===((I=v.settings)===null||I===void 0?void 0:I.volume)}},{key:"emitDailyJSEvent",value:function(h){try{h.callClientId=this.callClientId,this.emit(h.action,h)}catch(v){console.log("could not emit",h,v)}}},{key:"compareEqualForParticipantUpdateEvent",value:function(h,v){return!!$e(h,v)&&(!h.videoTrack||!v.videoTrack||h.videoTrack.id===v.videoTrack.id&&h.videoTrack.muted===v.videoTrack.muted&&h.videoTrack.enabled===v.videoTrack.enabled)&&(!h.audioTrack||!v.audioTrack||h.audioTrack.id===v.audioTrack.id&&h.audioTrack.muted===v.audioTrack.muted&&h.audioTrack.enabled===v.audioTrack.enabled)}},{key:"nativeUtils",value:function(){return de()?typeof DailyNativeUtils>"u"?(console.warn("in React Native, DailyNativeUtils is expected to be available"),null):DailyNativeUtils:null}},{key:"updateIsPreparingToJoin",value:function(h){this._updateCallState(this._callState,h)}},{key:"_updateCallState",value:function(h){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this._isPreparingToJoin;if(h!==this._callState||v!==this._isPreparingToJoin){var m=this._callState,I=this._isPreparingToJoin;this._callState=h,this._isPreparingToJoin=v;var A=this._callState===$t;this.updateShowAndroidOngoingMeetingNotification(A);var O=Ms(m,I),U=Ms(this._callState,this._isPreparingToJoin);O!==U&&(this.updateKeepDeviceAwake(U),this.updateDeviceAudioMode(U),this.updateNoOpRecordingEnsuringBackgroundContinuity(U))}}},{key:"resetMeetingDependentVars",value:function(){this._participants={},this._participantCounts=wc,this._waitingParticipants={},this._activeSpeaker={},this._activeSpeakerMode=!1,this._didPreAuth=!1,this._accessState={access:ws},this._finalSummaryOfPrevSession=this._meetingSessionSummary,this._meetingSessionSummary={},this._meetingSessionState=br(Ic,this._callObjectMode),this._isScreenSharing=!1,this._receiveSettings={},this._inputSettings=void 0,this._sendSettings={},this._localAudioLevel=0,this._isLocalAudioLevelObserverRunning=!1,this._remoteParticipantsAudioLevel={},this._isRemoteParticipantsAudioLevelObserverRunning=!1,this._maxAppMessageSize=nr,this._callMachineInitialized=!1,this._bundleLoadTime=void 0,this._preloadCache}},{key:"updateKeepDeviceAwake",value:function(h){de()&&this.nativeUtils().setKeepDeviceAwake(h,this.callClientId)}},{key:"updateDeviceAudioMode",value:function(h){if(de()&&!this.disableReactNativeAutoDeviceManagement("audio")){var v=h?this._nativeInCallAudioMode:"idle";this.nativeUtils().setAudioMode(v)}}},{key:"updateShowAndroidOngoingMeetingNotification",value:function(h){if(de()&&this.nativeUtils().setShowOngoingMeetingNotification){var v,m,I,A;if(this.properties.reactNativeConfig&&this.properties.reactNativeConfig.androidInCallNotification){var O=this.properties.reactNativeConfig.androidInCallNotification;v=O.title,m=O.subtitle,I=O.iconName,A=O.disableForCustomOverride}A&&(h=!1),this.nativeUtils().setShowOngoingMeetingNotification(h,v,m,I,this.callClientId)}}},{key:"updateNoOpRecordingEnsuringBackgroundContinuity",value:function(h){de()&&this.nativeUtils().enableNoOpRecordingEnsuringBackgroundContinuity&&this.nativeUtils().enableNoOpRecordingEnsuringBackgroundContinuity(h)}},{key:"toggleParticipantAudioBasedOnNativeAudioFocus",value:function(){var h,v;if(de()){var m=(h=this._callMachine())===null||h===void 0||(v=h.store)===null||v===void 0?void 0:v.getState();for(var I in m==null?void 0:m.streams){var A=m.streams[I];A&&A.pendingTrack&&A.pendingTrack.kind==="audio"&&(A.pendingTrack.enabled=this._hasNativeAudioFocus)}}}},{key:"disableReactNativeAutoDeviceManagement",value:function(h){return this.properties.reactNativeConfig&&this.properties.reactNativeConfig.disableAutoDeviceManagement&&this.properties.reactNativeConfig.disableAutoDeviceManagement[h]}},{key:"absoluteUrl",value:function(h){if(h!==void 0){var v=document.createElement("a");return v.href=h,v.href}}},{key:"sayHello",value:function(){var h="hello, world.";return console.log(h),h}},{key:"_logUseAfterDestroy",value:function(){var h=Object.values(ni)[0];if(this.needsLoad())if(h&&!h.needsLoad()){var v={action:Ls,level:"error",code:this.strictMode?9995:9997};h.sendMessageToCallMachine(v)}else this.strictMode||console.error("You are are attempting to use a call instance that was previously destroyed, which is unsupported. Please remove `strictMode: false` from your constructor properties to enable strict mode to track down and fix this unsupported usage.");else{var m={action:Ls,level:"error",code:this.strictMode?9995:9997};this._messageChannel.sendMessageToCallMachine(m,null,this.callClientId,this._iframe)}}},{key:"_logDuplicateInstanceAttempt",value:function(){for(var h=0,v=Object.values(ni);h<v.length;h++){var m=v[h];m._callMachineInitialized?(m.sendMessageToCallMachine({action:Ls,level:"warn",code:this.allowMultipleCallInstances?9993:9992}),m._delayDuplicateInstanceLog=!1):m._delayDuplicateInstanceLog=!0}}},{key:"_maybeSendToSentry",value:function(h){var v,m,I,A,O,U;if(!((v=h.error)!==null&&v!==void 0&&v.type&&(![el,Zo,Qn].includes(h.error.type)||h.error.type===Qn&&h.error.msg.includes("deleted")))){var V=(m=this.properties)!==null&&m!==void 0&&m.url?new URL(this.properties.url):void 0,W="production";V&&V.host.includes(".staging.daily")&&(W="staging");var he,le,Re,ie,Ae,ke=[qh(),Gh(),df(),cf(),gf(),yf(),Hh(),mf()].filter(function(mn){return!["BrowserApiErrors","Breadcrumbs","GlobalHandlers"].includes(mn.name)}),We=new Jh({dsn:"https://f10f1c81e5d44a4098416c0867a8b740@o77906.ingest.sentry.io/168844",transport:tf,stackParser:lf,integrations:ke,environment:W}),Se=new Bt;if(Se.setClient(We),We.init(),this.session_id&&Se.setExtra("sessionId",this.session_id),this.properties){var Oe=H({},this.properties);Oe.userName=Oe.userName?"[Filtered]":void 0,Oe.userData=Oe.userData?"[Filtered]":void 0,Oe.token=Oe.token?"[Filtered]":void 0,Se.setExtra("properties",Oe)}if(V){var Be=V.searchParams.get("domain");if(!Be){var ui=V.host.match(/(.*?)\./);Be=ui&&ui[1]||""}Be&&Se.setTag("domain",Be)}h.error&&(Se.setTag("fatalErrorType",h.error.type),Se.setExtra("errorDetails",h.error.details),!((he=h.error.details)===null||he===void 0)&&he.uri&&Se.setTag("serverAddress",h.error.details.uri),!((le=h.error.details)===null||le===void 0)&&le.workerGroup&&Se.setTag("workerGroup",h.error.details.workerGroup),!((Re=h.error.details)===null||Re===void 0)&&Re.geoGroup&&Se.setTag("geoGroup",h.error.details.geoGroup),!((ie=h.error.details)===null||ie===void 0)&&ie.on&&Se.setTag("connectionAttempt",h.error.details.on),(Ae=h.error.details)!==null&&Ae!==void 0&&Ae.bundleUrl&&(Se.setTag("bundleUrl",h.error.details.bundleUrl),Se.setTag("bundleError",h.error.details.sourceError.type))),Se.setTags({callMode:this._callObjectMode?de()?"reactNative":(I=this.properties)!==null&&I!==void 0&&(A=I.dailyConfig)!==null&&A!==void 0&&(O=A.callMode)!==null&&O!==void 0&&O.includes("prebuilt")?this.properties.dailyConfig.callMode:"custom":"prebuilt-frame",version:z.version()});var Yt=((U=h.error)===null||U===void 0?void 0:U.msg)||h.errorMsg;Se.captureException(new Error(Yt))}}},{key:"_callMachine",value:function(){var h,v,m;return(h=window._daily)===null||h===void 0||(v=h.instances)===null||v===void 0||(m=v[this.callClientId])===null||m===void 0?void 0:m.callMachine}},{key:"_maybeUpdateInputSettings",value:function(h){if(!$e(this._inputSettings,h)){var v=this._getInputSettings();this._inputSettings=h;var m=this._getInputSettings();$e(v,m)||this.emitDailyJSEvent({action:tr,inputSettings:m})}}}],[{key:"supportedBrowser",value:function(){if(de())return{supported:!0,mobile:!0,name:"React Native",version:null,supportsScreenShare:!0,supportsSfu:!0,supportsVideoProcessing:!1,supportsAudioProcessing:!1};var h=oh.getParser(Je());return{supported:!!rc(),mobile:h.getPlatformType()==="mobile",name:h.getBrowserName(),version:h.getBrowserVersion(),supportsFullscreen:!!ic(),supportsScreenShare:!!qf(),supportsSfu:!!rc(),supportsVideoProcessing:sc(),supportsAudioProcessing:nc()}}},{key:"version",value:function(){return"0.75.2"}},{key:"createCallObject",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return h.layout="none",new z(null,h)}},{key:"wrap",value:function(h){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(ue(),!h||!h.contentWindow||typeof h.src!="string")throw new Error("DailyIframe::Wrap needs an iframe-like first argument");return v.layout||(v.customLayout?v.layout="custom-v1":v.layout="browser"),new z(h,v)}},{key:"createFrame",value:function(h,v){var m,I;ue(),h&&v?(m=h,I=v):h&&h.append?(m=h,I={}):(m=document.body,I=h||{});var A=I.iframeStyle;A||(A=m===document.body?{position:"fixed",border:"1px solid black",backgroundColor:"white",width:"375px",height:"450px",right:"1em",bottom:"1em"}:{border:0,width:"100%",height:"100%"});var O=document.createElement("iframe");window.navigator&&window.navigator.userAgent.match(/Chrome\/61\./)?O.allow="microphone, camera":O.allow="microphone; camera; autoplay; display-capture; screen-wake-lock",O.style.visibility="hidden",m.appendChild(O),O.style.visibility=null,Object.keys(A).forEach(function(U){return O.style[U]=A[U]}),I.layout||(I.customLayout?I.layout="custom-v1":I.layout="browser");try{return new z(O,I)}catch(U){throw m.removeChild(O),U}}},{key:"createTransparentFrame",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};ue();var v=document.createElement("iframe");return v.allow="microphone; camera; autoplay",v.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
      pointer-events: none;
    `,document.body.appendChild(v),h.layout||(h.layout="custom-v1"),z.wrap(v,h)}},{key:"getCallInstance",value:function(){var h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:void 0;return h?ni[h]:Object.values(ni)[0]}}]),z}();function Si(s,e){var t={};for(var i in s)if(s[i]instanceof MediaStreamTrack)console.warn("MediaStreamTrack found in props or cache.",i),t[i]=Lt;else if(i==="dailyConfig"){if(s[i].modifyLocalSdpHook){var n=window._daily.instances[e].customCallbacks||{};n.modifyLocalSdpHook=s[i].modifyLocalSdpHook,window._daily.instances[e].customCallbacks=n,delete s[i].modifyLocalSdpHook}if(s[i].modifyRemoteSdpHook){var r=window._daily.instances[e].customCallbacks||{};r.modifyRemoteSdpHook=s[i].modifyRemoteSdpHook,window._daily.instances[e].customCallbacks=r,delete s[i].modifyRemoteSdpHook}t[i]=s[i]}else t[i]=s[i];return t}function Te(s){var e=arguments.length>2?arguments[2]:void 0;if(s!==$t){var t="".concat(arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method"," only supported after join.");throw e&&(t+=" ".concat(e)),console.error(t),new Error(t)}}function Ms(s,e){return[Is,$t].includes(s)||e}function Sr(s,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"This daily-js method",i=arguments.length>3?arguments[3]:void 0;if(Ms(s,e)){var n="".concat(t," not supported after joining a meeting.");throw i&&(n+=" ".concat(i)),console.error(n),new Error(n)}}function Fs(s){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method",t=arguments.length>2?arguments[2]:void 0;if(!s){var i="".concat(e,arguments.length>3&&arguments[3]!==void 0&&arguments[3]?" requires preAuth() or startCamera() to initialize call state.":" requires preAuth(), startCamera(), or join() to initialize call state.");throw t&&(i+=" ".concat(t)),console.error(i),new Error(i)}}function Er(s){if(s){var e="A pre-call quality test is in progress. Please try ".concat(arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method"," again once testing has completed. Use stopTestCallQuality() to end it early.");throw console.error(e),new Error(e)}}function lt(s){if(!s){var e="".concat(arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method"," is only supported on custom callObject instances");throw console.error(e),new Error(e)}}function He(s){if(s){var e="".concat(arguments.length>1&&arguments[1]!==void 0?arguments[1]:"This daily-js method"," is only supported as part of Daily's Prebuilt");throw console.error(e),new Error(e)}}function ue(){if(de())throw new Error("This daily-js method is not currently supported in React Native")}function ji(){if(!de())throw new Error("This daily-js method is only supported in React Native")}function Rc(s){if(s===void 0)return!0;var e;if(typeof s=="string")e=s;else try{e=JSON.stringify(s),$e(JSON.parse(e),s)||console.warn("The userData provided will be modified when serialized.")}catch(t){throw Error("userData must be serializable to JSON: ".concat(t))}if(e.length>4096)throw Error("userData is too large (".concat(e.length," characters). Maximum size suppported is ").concat(4096,"."));return!0}function Pc(s,e){for(var t=e.allowAllParticipantsKey,i=function(d){var f=["local"];return t||f.push("*"),d&&!f.includes(d)},n=function(d){return!!(d.layer===void 0||Number.isInteger(d.layer)&&d.layer>=0||d.layer==="inherit")},r=function(d){return!!d&&!(d.video&&!n(d.video))&&!(d.screenVideo&&!n(d.screenVideo))},a=0,o=Object.entries(s);a<o.length;a++){var l=dt(o[a],2),c=l[0],u=l[1];if(!i(c)||!r(u))return!1}return!0}function Dc(s){if(me(s)!=="object")return!1;for(var e=0,t=Object.entries(s);e<t.length;e++){var i=dt(t[e],2),n=i[0],r=i[1];switch(n){case"video":if(me(r)!=="object")return!1;for(var a=0,o=Object.entries(r);a<o.length;a++){var l=dt(o[a],2),c=l[0],u=l[1];switch(c){case"processor":if(!Sp(u))return!1;break;case"settings":if(!Mc(u))return!1;break;default:return!1}}break;case"audio":if(me(r)!=="object")return!1;for(var d=0,f=Object.entries(r);d<f.length;d++){var p=dt(f[d],2),g=p[0],y=p[1];switch(g){case"processor":if(!vp(y))return!1;break;case"settings":if(!Mc(y))return!1;break;default:return!1}}break;default:return!1}}return!0}function Oc(s,e,t){var i,n=[];s.video&&s.video.processor&&(sc((i=e==null?void 0:e.useLegacyVideoProcessor)!==null&&i!==void 0&&i)||(s.video.settings?delete s.video.processor:delete s.video,n.push("video"))),s.audio&&s.audio.processor&&(nc()||(s.audio.settings?delete s.audio.processor:delete s.audio,n.push("audio"))),n.length>0&&console.error("Ignoring settings for browser- or platform-unsupported input processor(s): ".concat(n.join(", "))),s.audio&&s.audio.settings&&(s.audio.settings.customTrack?(t.audioTrack=s.audio.settings.customTrack,s.audio.settings={customTrack:Lt}):delete t.audioTrack),s.video&&s.video.settings&&(s.video.settings.customTrack?(t.videoTrack=s.video.settings.customTrack,s.video.settings={customTrack:Lt}):delete t.videoTrack)}function vp(s){if(de())return console.warn("Video processing is not yet supported in React Native"),!1;var e=["type"];return!!s&&me(s)==="object"&&(Object.keys(s).filter(function(t){return!e.includes(t)}).forEach(function(t){console.warn("invalid key inputSettings -> audio -> processor : ".concat(t)),delete s[t]}),!!function(t){return typeof t!="string"?!1:Object.values(Zl).includes(t)?!0:(console.error("inputSettings audio processor type invalid"),!1)}(s.type))}function Sp(s){if(de())return console.warn("Video processing is not yet supported in React Native"),!1;var e=["type","config"];return!s||me(s)!=="object"||!function(t){return typeof t!="string"?!1:Object.values(ks).includes(t)?!0:(console.error("inputSettings video processor type invalid"),!1)}(s.type)||s.config&&(me(s.config)!=="object"||!function(t,i){var n=Object.keys(i);if(n.length===0)return!0;var r="invalid object in inputSettings -> video -> processor -> config";switch(t){case ks.BGBLUR:return n.length>1||n[0]!=="strength"?(console.error(r),!1):!(typeof i.strength!="number"||i.strength<=0||i.strength>1||isNaN(i.strength))||(console.error("".concat(r,"; expected: {0 < strength <= 1}, got: ").concat(i.strength)),!1);case ks.BGIMAGE:return!(i.source!==void 0&&!function(a){if(a.source==="default")return a.type="default",!0;if(a.source instanceof ArrayBuffer)return!0;if(ls(a.source))return a.type="url",!!function(c){var u=new URL(c),d=u.pathname;if(u.protocol==="data:")try{var f=d.substring(d.indexOf(":")+1,d.indexOf(";")).split("/")[1];return or.includes(f)}catch(g){return console.error("failed to deduce blob content type",g),!1}var p=d.split(".").at(-1).toLowerCase().trim();return or.includes(p)}(a.source)||(console.error("invalid image type; supported types: [".concat(or.join(", "),"]")),!1);return o=a.source,l=Number(o),isNaN(l)||!Number.isInteger(l)||l<=0||l>10?(console.error("invalid image selection; must be an int, > 0, <= ".concat(10)),!1):(a.type="daily-preselect",!0);var o,l}(i));default:return!0}}(s.type,s.config))?!1:(Object.keys(s).filter(function(t){return!e.includes(t)}).forEach(function(t){console.warn("invalid key inputSettings -> video -> processor : ".concat(t)),delete s[t]}),!0)}function Mc(s){return me(s)==="object"&&(!s.customTrack||s.customTrack instanceof MediaStreamTrack)}function Tr(){var s=Object.values(ks).join(" | "),e=Object.values(Zl).join(" | ");return"inputSettings must be of the form: { video?: { processor?: { type: [ ".concat(s," ], config?: {} } }, audio?: { processor: {type: [ ").concat(e," ] } } }")}function Fc(s){var e=s.allowAllParticipantsKey;return"receiveSettings must be of the form { [<remote participant id> | ".concat(Xo).concat(e?' | "'.concat("*",'"'):"","]: ")+'{ [video: [{ layer: [<non-negative integer> | "inherit"] } | "inherit"]], [screenVideo: [{ layer: [<non-negative integer> | "inherit"] } | "inherit"]] }}}'}function Nc(){return"customIntegrations should be an object of type ".concat(JSON.stringify(vr),".")}function Uc(s){if(s&&me(s)!=="object"||Array.isArray(s))return console.error("customTrayButtons should be an Object of the type ".concat(JSON.stringify(Ds),".")),!1;if(s)for(var e=0,t=Object.entries(s);e<t.length;e++)for(var i=dt(t[e],1)[0],n=0,r=Object.entries(s[i]);n<r.length;n++){var a=dt(r[n],2),o=a[0],l=a[1],c=Ds.id[o];if(!c)return console.error("customTrayButton does not support key ".concat(o)),!1;switch(o){case"iconPath":case"iconPathDarkMode":if(!ls(l))return console.error("customTrayButton ".concat(o," should be a url.")),!1;break;case"visualState":if(!["default","sidebar-open","active"].includes(l))return console.error("customTrayButton ".concat(o," should be ").concat(c,". Got: ").concat(l)),!1;break;default:if(me(l)!==c)return console.error("customTrayButton ".concat(o," should be a ").concat(c,".")),!1}}return!0}function Bc(s){if(!s||s&&me(s)!=="object"||Array.isArray(s))return console.error(Nc()),!1;for(var e=function(d){return"".concat(d," should be ").concat(vr.id[d])},t=function(d,f){return console.error("customIntegration ".concat(d,": ").concat(f))},i=0,n=Object.entries(s);i<n.length;i++){var r=dt(n[i],1)[0];if(!("label"in s[r]))return t(r,"label is required"),!1;if(!("location"in s[r]))return t(r,"location is required"),!1;if(!("src"in s[r])&&!("srcdoc"in s[r]))return t(r,"src or srcdoc is required"),!1;for(var a=0,o=Object.entries(s[r]);a<o.length;a++){var l=dt(o[a],2),c=l[0],u=l[1];switch(c){case"allow":case"csp":case"name":case"referrerPolicy":case"sandbox":if(typeof u!="string")return t(r,e(c)),!1;break;case"iconURL":if(!ls(u))return t(r,"".concat(c," should be a url")),!1;break;case"src":if("srcdoc"in s[r])return t(r,"cannot have both src and srcdoc"),!1;if(!ls(u))return t(r,'src "'.concat(u,'" is not a valid URL')),!1;break;case"srcdoc":if("src"in s[r])return t(r,"cannot have both src and srcdoc"),!1;if(typeof u!="string")return t(r,e(c)),!1;break;case"location":if(!["main","sidebar"].includes(u))return t(r,e(c)),!1;break;case"controlledBy":if(u!=="*"&&u!=="owners"&&(!Array.isArray(u)||u.some(function(d){return typeof d!="string"})))return t(r,e(c)),!1;break;case"shared":if((!Array.isArray(u)||u.some(function(d){return typeof d!="string"}))&&u!=="owners"&&typeof u!="boolean")return t(r,e(c)),!1;break;default:if(!vr.id[c])return console.error("customIntegration does not support key ".concat(c)),!1}}}return!0}function $c(s,e){if(e===void 0)return!1;switch(me(e)){case"string":return me(s)===e;case"object":if(me(s)!=="object")return!1;for(var t in s)if(!$c(s[t],e[t]))return!1;return!0;default:return!1}}function jc(s,e){var t=s.sessionId,i=s.toEndPoint,n=s.useSipRefer;if(!t||!i)throw new Error("".concat(e,"() requires a sessionId and toEndPoint"));if(typeof t!="string"||typeof i!="string")throw new Error("Invalid paramater: sessionId and toEndPoint must be of type string");if(n&&!i.startsWith("sip:"))throw new Error('"toEndPoint" must be a "sip" address');if(!i.startsWith("sip:")&&!i.startsWith("+"))throw new Error("toEndPoint: ".concat(i,' must starts with either "sip:" or "+"'))}function Gc(s){if(me(s)!=="object")throw new Error('RemoteMediaPlayerSettings: must be "object" type');if(s.state&&!Object.values(ar).includes(s.state))throw new Error("Invalid value for RemoteMediaPlayerSettings.state, valid values are: "+JSON.stringify(ar));if(s.volume){if(typeof s.volume!="number")throw new Error('RemoteMediaPlayerSettings.volume: must be "number" type');if(s.volume<0||s.volume>2)throw new Error("RemoteMediaPlayerSettings.volume: must be between 0.0 - 2.0")}}function Vc(s,e,t){return!(typeof s!="number"||s<e||s>t)}function br(s,e){return s&&!e&&delete s.data,s}const Ep=Tt(Object.freeze(Object.defineProperty({__proto__:null,DAILY_ACCESS_LEVEL_FULL:Qo,DAILY_ACCESS_LEVEL_LOBBY:_f,DAILY_ACCESS_LEVEL_NONE:xf,DAILY_ACCESS_UNKNOWN:ws,DAILY_CAMERA_ERROR_CAM_AND_MIC_IN_USE:Mf,DAILY_CAMERA_ERROR_CAM_IN_USE:Df,DAILY_CAMERA_ERROR_CONSTRAINTS:Bf,DAILY_CAMERA_ERROR_MIC_IN_USE:Of,DAILY_CAMERA_ERROR_NOT_FOUND:Uf,DAILY_CAMERA_ERROR_PERMISSIONS:Ff,DAILY_CAMERA_ERROR_UNDEF_MEDIADEVICES:Nf,DAILY_CAMERA_ERROR_UNKNOWN:$f,DAILY_EVENT_ACCESS_STATE_UPDATED:gl,DAILY_EVENT_ACTIVE_SPEAKER_CHANGE:Ul,DAILY_EVENT_ACTIVE_SPEAKER_MODE_CHANGE:Bl,DAILY_EVENT_APP_MSG:Cl,DAILY_EVENT_CAMERA_ERROR:ol,DAILY_EVENT_CPU_LOAD_CHANGE:Gl,DAILY_EVENT_ERROR:sr,DAILY_EVENT_EXIT_FULLSCREEN:Bi,DAILY_EVENT_FACE_COUNTS_UPDATED:Vl,DAILY_EVENT_FULLSCREEN:Ui,DAILY_EVENT_IFRAME_LAUNCH_CONFIG:il,DAILY_EVENT_IFRAME_READY_FOR_LAUNCH_CONFIG:tl,DAILY_EVENT_INPUT_SETTINGS_UPDATED:tr,DAILY_EVENT_JOINED_MEETING:cl,DAILY_EVENT_JOINING_MEETING:ll,DAILY_EVENT_LANG_UPDATED:Wl,DAILY_EVENT_LEFT_MEETING:ul,DAILY_EVENT_LIVE_STREAMING_ERROR:Yl,DAILY_EVENT_LIVE_STREAMING_STARTED:ql,DAILY_EVENT_LIVE_STREAMING_STOPPED:Kl,DAILY_EVENT_LIVE_STREAMING_UPDATED:Hl,DAILY_EVENT_LOADED:Xn,DAILY_EVENT_LOADING:nl,DAILY_EVENT_LOAD_ATTEMPT_FAILED:rl,DAILY_EVENT_LOCAL_SCREEN_SHARE_CANCELED:Nl,DAILY_EVENT_LOCAL_SCREEN_SHARE_STARTED:Ml,DAILY_EVENT_LOCAL_SCREEN_SHARE_STOPPED:Fl,DAILY_EVENT_MEETING_SESSION_DATA_ERROR:jf,DAILY_EVENT_MEETING_SESSION_STATE_UPDATED:yl,DAILY_EVENT_MEETING_SESSION_SUMMARY_UPDATED:ml,DAILY_EVENT_NETWORK_CONNECTION:jl,DAILY_EVENT_NETWORK_QUALITY_CHANGE:$l,DAILY_EVENT_NONFATAL_ERROR:ir,DAILY_EVENT_PARTICIPANT_COUNTS_UPDATED:pl,DAILY_EVENT_PARTICIPANT_JOINED:dl,DAILY_EVENT_PARTICIPANT_LEFT:fl,DAILY_EVENT_PARTICIPANT_UPDATED:hl,DAILY_EVENT_RECEIVE_SETTINGS_UPDATED:zl,DAILY_EVENT_RECORDING_DATA:kl,DAILY_EVENT_RECORDING_ERROR:wl,DAILY_EVENT_RECORDING_STARTED:Zn,DAILY_EVENT_RECORDING_STATS:Il,DAILY_EVENT_RECORDING_STOPPED:er,DAILY_EVENT_RECORDING_UPLOAD_COMPLETED:Ll,DAILY_EVENT_REMOTE_MEDIA_PLAYER_STARTED:Pl,DAILY_EVENT_REMOTE_MEDIA_PLAYER_STOPPED:Ol,DAILY_EVENT_REMOTE_MEDIA_PLAYER_UPDATED:Dl,DAILY_EVENT_STARTED_CAMERA:al,DAILY_EVENT_THEME_UPDATED:sl,DAILY_EVENT_TRACK_STARTED:Tl,DAILY_EVENT_TRACK_STOPPED:bl,DAILY_EVENT_TRANSCRIPTION_ERROR:Al,DAILY_EVENT_TRANSCRIPTION_MSG:Rl,DAILY_EVENT_TRANSCRIPTION_STARTED:_l,DAILY_EVENT_TRANSCRIPTION_STOPPED:xl,DAILY_EVENT_WAITING_PARTICIPANT_ADDED:vl,DAILY_EVENT_WAITING_PARTICIPANT_REMOVED:El,DAILY_EVENT_WAITING_PARTICIPANT_UPDATED:Sl,DAILY_FATAL_ERROR_CONNECTION:el,DAILY_FATAL_ERROR_EJECTED:If,DAILY_FATAL_ERROR_EOL:Zo,DAILY_FATAL_ERROR_EXP_ROOM:kf,DAILY_FATAL_ERROR_EXP_TOKEN:Cf,DAILY_FATAL_ERROR_MEETING_FULL:Rf,DAILY_FATAL_ERROR_NBF_ROOM:wf,DAILY_FATAL_ERROR_NBF_TOKEN:Lf,DAILY_FATAL_ERROR_NOT_ALLOWED:Pf,DAILY_FATAL_ERROR_NO_ROOM:Qn,DAILY_RECEIVE_SETTINGS_ALL_PARTICIPANTS_KEY:Af,DAILY_RECEIVE_SETTINGS_BASE_KEY:Xo,DAILY_STATE_ERROR:wt,DAILY_STATE_JOINED:$t,DAILY_STATE_JOINING:Is,DAILY_STATE_LEFT:jt,DAILY_STATE_NEW:Jn,DAILY_TRACK_STATE_BLOCKED:vf,DAILY_TRACK_STATE_INTERRUPTED:bf,DAILY_TRACK_STATE_LOADING:Tf,DAILY_TRACK_STATE_OFF:Sf,DAILY_TRACK_STATE_PLAYABLE:Jo,DAILY_TRACK_STATE_SENDABLE:Ef,default:yp},Symbol.toStringTag,{value:"Module"})));var Ns={exports:{}},qc;function Tp(){if(qc)return Ns.exports;qc=1;var s=typeof Reflect=="object"?Reflect:null,e=s&&typeof s.apply=="function"?s.apply:function(b,C,_){return Function.prototype.apply.call(b,C,_)},t;s&&typeof s.ownKeys=="function"?t=s.ownKeys:Object.getOwnPropertySymbols?t=function(b){return Object.getOwnPropertyNames(b).concat(Object.getOwnPropertySymbols(b))}:t=function(b){return Object.getOwnPropertyNames(b)};function i(x){console&&console.warn&&console.warn(x)}var n=Number.isNaN||function(b){return b!==b};function r(){r.init.call(this)}Ns.exports=r,Ns.exports.once=T,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._eventsCount=0,r.prototype._maxListeners=void 0;var a=10;function o(x){if(typeof x!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof x)}Object.defineProperty(r,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(x){if(typeof x!="number"||x<0||n(x))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+x+".");a=x}}),r.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},r.prototype.setMaxListeners=function(b){if(typeof b!="number"||b<0||n(b))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+b+".");return this._maxListeners=b,this};function l(x){return x._maxListeners===void 0?r.defaultMaxListeners:x._maxListeners}r.prototype.getMaxListeners=function(){return l(this)},r.prototype.emit=function(b){for(var C=[],_=1;_<arguments.length;_++)C.push(arguments[_]);var k=b==="error",D=this._events;if(D!==void 0)k=k&&D.error===void 0;else if(!k)return!1;if(k){var R;if(C.length>0&&(R=C[0]),R instanceof Error)throw R;var N=new Error("Unhandled error."+(R?" ("+R.message+")":""));throw N.context=R,N}var G=D[b];if(G===void 0)return!1;if(typeof G=="function")e(G,this,C);else for(var ce=G.length,J=g(G,ce),_=0;_<ce;++_)e(J[_],this,C);return!0};function c(x,b,C,_){var k,D,R;if(o(C),D=x._events,D===void 0?(D=x._events=Object.create(null),x._eventsCount=0):(D.newListener!==void 0&&(x.emit("newListener",b,C.listener?C.listener:C),D=x._events),R=D[b]),R===void 0)R=D[b]=C,++x._eventsCount;else if(typeof R=="function"?R=D[b]=_?[C,R]:[R,C]:_?R.unshift(C):R.push(C),k=l(x),k>0&&R.length>k&&!R.warned){R.warned=!0;var N=new Error("Possible EventEmitter memory leak detected. "+R.length+" "+String(b)+" listeners added. Use emitter.setMaxListeners() to increase limit");N.name="MaxListenersExceededWarning",N.emitter=x,N.type=b,N.count=R.length,i(N)}return x}r.prototype.addListener=function(b,C){return c(this,b,C,!1)},r.prototype.on=r.prototype.addListener,r.prototype.prependListener=function(b,C){return c(this,b,C,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(x,b,C){var _={fired:!1,wrapFn:void 0,target:x,type:b,listener:C},k=u.bind(_);return k.listener=C,_.wrapFn=k,k}r.prototype.once=function(b,C){return o(C),this.on(b,d(this,b,C)),this},r.prototype.prependOnceListener=function(b,C){return o(C),this.prependListener(b,d(this,b,C)),this},r.prototype.removeListener=function(b,C){var _,k,D,R,N;if(o(C),k=this._events,k===void 0)return this;if(_=k[b],_===void 0)return this;if(_===C||_.listener===C)--this._eventsCount===0?this._events=Object.create(null):(delete k[b],k.removeListener&&this.emit("removeListener",b,_.listener||C));else if(typeof _!="function"){for(D=-1,R=_.length-1;R>=0;R--)if(_[R]===C||_[R].listener===C){N=_[R].listener,D=R;break}if(D<0)return this;D===0?_.shift():y(_,D),_.length===1&&(k[b]=_[0]),k.removeListener!==void 0&&this.emit("removeListener",b,N||C)}return this},r.prototype.off=r.prototype.removeListener,r.prototype.removeAllListeners=function(b){var C,_,k;if(_=this._events,_===void 0)return this;if(_.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):_[b]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete _[b]),this;if(arguments.length===0){var D=Object.keys(_),R;for(k=0;k<D.length;++k)R=D[k],R!=="removeListener"&&this.removeAllListeners(R);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(C=_[b],typeof C=="function")this.removeListener(b,C);else if(C!==void 0)for(k=C.length-1;k>=0;k--)this.removeListener(b,C[k]);return this};function f(x,b,C){var _=x._events;if(_===void 0)return[];var k=_[b];return k===void 0?[]:typeof k=="function"?C?[k.listener||k]:[k]:C?S(k):g(k,k.length)}r.prototype.listeners=function(b){return f(this,b,!0)},r.prototype.rawListeners=function(b){return f(this,b,!1)},r.listenerCount=function(x,b){return typeof x.listenerCount=="function"?x.listenerCount(b):p.call(x,b)},r.prototype.listenerCount=p;function p(x){var b=this._events;if(b!==void 0){var C=b[x];if(typeof C=="function")return 1;if(C!==void 0)return C.length}return 0}r.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function g(x,b){for(var C=new Array(b),_=0;_<b;++_)C[_]=x[_];return C}function y(x,b){for(;b+1<x.length;b++)x[b]=x[b+1];x.pop()}function S(x){for(var b=new Array(x.length),C=0;C<b.length;++C)b[C]=x[C].listener||x[C];return b}function T(x,b){return new Promise(function(C,_){function k(R){x.removeListener(b,D),_(R)}function D(){typeof x.removeListener=="function"&&x.removeListener("error",k),C([].slice.call(arguments))}w(x,b,D,{once:!0}),b!=="error"&&L(x,k,{once:!0})})}function L(x,b,C){typeof x.on=="function"&&w(x,"error",b,C)}function w(x,b,C,_){if(typeof x.on=="function")_.once?x.once(b,C):x.on(b,C);else if(typeof x.addEventListener=="function")x.addEventListener(b,function k(D){_.once&&x.removeEventListener(b,k),C(D)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof x)}return Ns.exports}var Gi={},kt={},Hc;function bp(){if(Hc)return kt;Hc=1,Object.defineProperty(kt,"__esModule",{value:!0}),kt.Api=kt.HttpClient=kt.ContentType=void 0;var s;(function(i){i.Json="application/json",i.FormData="multipart/form-data",i.UrlEncoded="application/x-www-form-urlencoded",i.Text="text/plain"})(s||(kt.ContentType=s={}));class e{constructor(n={}){oe(this,"baseUrl","https://api.vapi.ai");oe(this,"securityData",null);oe(this,"securityWorker");oe(this,"abortControllers",new Map);oe(this,"customFetch",(...n)=>fetch(...n));oe(this,"baseApiParams",{credentials:"same-origin",headers:{},redirect:"follow",referrerPolicy:"no-referrer"});oe(this,"setSecurityData",n=>{this.securityData=n});oe(this,"contentFormatters",{[s.Json]:n=>n!==null&&(typeof n=="object"||typeof n=="string")?JSON.stringify(n):n,[s.Text]:n=>n!==null&&typeof n!="string"?JSON.stringify(n):n,[s.FormData]:n=>Object.keys(n||{}).reduce((r,a)=>{const o=n[a];return r.append(a,o instanceof Blob?o:typeof o=="object"&&o!==null?JSON.stringify(o):`${o}`),r},new FormData),[s.UrlEncoded]:n=>this.toQueryString(n)});oe(this,"createAbortSignal",n=>{if(this.abortControllers.has(n)){const a=this.abortControllers.get(n);return a?a.signal:void 0}const r=new AbortController;return this.abortControllers.set(n,r),r.signal});oe(this,"abortRequest",n=>{const r=this.abortControllers.get(n);r&&(r.abort(),this.abortControllers.delete(n))});oe(this,"request",async({body:n,secure:r,path:a,type:o,query:l,format:c,baseUrl:u,cancelToken:d,...f})=>{const p=(typeof r=="boolean"?r:this.baseApiParams.secure)&&this.securityWorker&&await this.securityWorker(this.securityData)||{},g=this.mergeRequestParams(f,p),y=l&&this.toQueryString(l),S=this.contentFormatters[o||s.Json],T=c||g.format;return this.customFetch(`${u||this.baseUrl||""}${a}${y?`?${y}`:""}`,{...g,headers:{...g.headers||{},...o&&o!==s.FormData?{"Content-Type":o}:{}},signal:(d?this.createAbortSignal(d):g.signal)||null,body:typeof n>"u"||n===null?null:S(n)}).then(async L=>{const w=L;w.data=null,w.error=null;const x=T?await L[T]().then(b=>(w.ok?w.data=b:w.error=b,w)).catch(b=>(w.error=b,w)):w;if(d&&this.abortControllers.delete(d),!L.ok)throw x;return x})});Object.assign(this,n)}encodeQueryParam(n,r){return`${encodeURIComponent(n)}=${encodeURIComponent(typeof r=="number"?r:`${r}`)}`}addQueryParam(n,r){return this.encodeQueryParam(r,n[r])}addArrayQueryParam(n,r){return n[r].map(o=>this.encodeQueryParam(r,o)).join("&")}toQueryString(n){const r=n||{};return Object.keys(r).filter(o=>typeof r[o]<"u").map(o=>Array.isArray(r[o])?this.addArrayQueryParam(r,o):this.addQueryParam(r,o)).join("&")}addQueryParams(n){const r=this.toQueryString(n);return r?`?${r}`:""}mergeRequestParams(n,r){return{...this.baseApiParams,...n,...r||{},headers:{...this.baseApiParams.headers||{},...n.headers||{},...r&&r.headers||{}}}}}kt.HttpClient=e;class t extends e{constructor(){super(...arguments);oe(this,"call",{callControllerCreate:(r,a={})=>this.request({path:"/call",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),callControllerFindAll:(r,a={})=>this.request({path:"/call",method:"GET",query:r,secure:!0,format:"json",...a}),callControllerFindOne:(r,a={})=>this.request({path:`/call/${r}`,method:"GET",secure:!0,format:"json",...a}),callControllerUpdate:(r,a,o={})=>this.request({path:`/call/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),callControllerDeleteCallData:(r,a={})=>this.request({path:`/call/${r}`,method:"DELETE",secure:!0,format:"json",...a}),callControllerCreatePhoneCall:(r,a={})=>this.request({path:"/call/phone",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),callControllerCreateWebCall:(r,a={})=>this.request({path:"/call/web",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a})});oe(this,"v2",{callControllerFindAllPaginated:(r,a={})=>this.request({path:"/v2/call",method:"GET",query:r,secure:!0,format:"json",...a}),callControllerFindAllMetadataPaginated:(r,a={})=>this.request({path:"/v2/call/metadata",method:"GET",query:r,secure:!0,format:"json",...a}),assistantControllerFindAllPaginated:(r,a={})=>this.request({path:"/v2/assistant",method:"GET",query:r,secure:!0,format:"json",...a}),phoneNumberControllerFindAllPaginated:(r,a={})=>this.request({path:"/v2/phone-number",method:"GET",query:r,secure:!0,format:"json",...a})});oe(this,"chat",{chatController:(r={})=>this.request({path:"/chat",method:"POST",secure:!0,format:"json",...r}),chatControllerChatCompletions:(r,a={})=>this.request({path:"/chat/completions",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a})});oe(this,"assistant",{assistantControllerCreate:(r,a={})=>this.request({path:"/assistant",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),assistantControllerFindAll:(r,a={})=>this.request({path:"/assistant",method:"GET",query:r,secure:!0,format:"json",...a}),assistantControllerFindOne:(r,a={})=>this.request({path:`/assistant/${r}`,method:"GET",secure:!0,format:"json",...a}),assistantControllerUpdate:(r,a,o={})=>this.request({path:`/assistant/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),assistantControllerReplace:(r,a,o={})=>this.request({path:`/assistant/${r}`,method:"PUT",body:a,secure:!0,type:s.Json,format:"json",...o}),assistantControllerRemove:(r,a={})=>this.request({path:`/assistant/${r}`,method:"DELETE",secure:!0,format:"json",...a}),assistantControllerFindVersions:(r,a,o={})=>this.request({path:`/assistant/${r}/version`,method:"GET",query:a,secure:!0,format:"json",...o})});oe(this,"phoneNumber",{phoneNumberControllerImportTwilio:(r,a={})=>this.request({path:"/phone-number/import/twilio",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),phoneNumberControllerImportVonage:(r,a={})=>this.request({path:"/phone-number/import/vonage",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),phoneNumberControllerCreate:(r,a={})=>this.request({path:"/phone-number",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),phoneNumberControllerFindAll:(r,a={})=>this.request({path:"/phone-number",method:"GET",query:r,secure:!0,format:"json",...a}),phoneNumberControllerFindOne:(r,a={})=>this.request({path:`/phone-number/${r}`,method:"GET",secure:!0,format:"json",...a}),phoneNumberControllerUpdate:(r,a,o={})=>this.request({path:`/phone-number/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),phoneNumberControllerRemove:(r,a={})=>this.request({path:`/phone-number/${r}`,method:"DELETE",secure:!0,format:"json",...a})});oe(this,"tool",{toolControllerCreate:(r,a={})=>this.request({path:"/tool",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),toolControllerFindAll:(r,a={})=>this.request({path:"/tool",method:"GET",query:r,secure:!0,format:"json",...a}),toolControllerFindOne:(r,a={})=>this.request({path:`/tool/${r}`,method:"GET",secure:!0,format:"json",...a}),toolControllerUpdate:(r,a,o={})=>this.request({path:`/tool/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),toolControllerRemove:(r,a={})=>this.request({path:`/tool/${r}`,method:"DELETE",secure:!0,format:"json",...a})});oe(this,"file",{fileControllerCreateDeprecated:(r,a={})=>this.request({path:"/file/upload",method:"POST",body:r,secure:!0,type:s.FormData,format:"json",...a}),fileControllerCreate:(r,a={})=>this.request({path:"/file",method:"POST",body:r,secure:!0,type:s.FormData,format:"json",...a}),fileControllerFindAll:(r={})=>this.request({path:"/file",method:"GET",secure:!0,format:"json",...r}),fileControllerFindOne:(r,a={})=>this.request({path:`/file/${r}`,method:"GET",secure:!0,format:"json",...a}),fileControllerUpdate:(r,a,o={})=>this.request({path:`/file/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),fileControllerRemove:(r,a={})=>this.request({path:`/file/${r}`,method:"DELETE",secure:!0,format:"json",...a})});oe(this,"knowledgeBase",{knowledgeBaseControllerCreate:(r,a={})=>this.request({path:"/knowledge-base",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),knowledgeBaseControllerFindAll:(r,a={})=>this.request({path:"/knowledge-base",method:"GET",query:r,secure:!0,format:"json",...a}),knowledgeBaseControllerFindOne:(r,a={})=>this.request({path:`/knowledge-base/${r}`,method:"GET",secure:!0,format:"json",...a}),knowledgeBaseControllerUpdate:(r,a,o={})=>this.request({path:`/knowledge-base/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),knowledgeBaseControllerRemove:(r,a={})=>this.request({path:`/knowledge-base/${r}`,method:"DELETE",secure:!0,format:"json",...a})});oe(this,"workflow",{workflowControllerFindAll:(r={})=>this.request({path:"/workflow",method:"GET",secure:!0,format:"json",...r}),workflowControllerCreate:(r,a={})=>this.request({path:"/workflow",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),workflowControllerFindOne:(r,a={})=>this.request({path:`/workflow/${r}`,method:"GET",secure:!0,format:"json",...a}),workflowControllerDelete:(r,a={})=>this.request({path:`/workflow/${r}`,method:"DELETE",secure:!0,format:"json",...a}),workflowControllerUpdate:(r,a,o={})=>this.request({path:`/workflow/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o})});oe(this,"squad",{squadControllerCreate:(r,a={})=>this.request({path:"/squad",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),squadControllerFindAll:(r,a={})=>this.request({path:"/squad",method:"GET",query:r,secure:!0,format:"json",...a}),squadControllerFindOne:(r,a={})=>this.request({path:`/squad/${r}`,method:"GET",secure:!0,format:"json",...a}),squadControllerUpdate:(r,a,o={})=>this.request({path:`/squad/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),squadControllerRemove:(r,a={})=>this.request({path:`/squad/${r}`,method:"DELETE",secure:!0,format:"json",...a})});oe(this,"testSuite",{testSuiteControllerFindAllPaginated:(r,a={})=>this.request({path:"/test-suite",method:"GET",query:r,secure:!0,format:"json",...a}),testSuiteControllerCreate:(r,a={})=>this.request({path:"/test-suite",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),testSuiteControllerFindOne:(r,a={})=>this.request({path:`/test-suite/${r}`,method:"GET",secure:!0,format:"json",...a}),testSuiteControllerUpdate:(r,a,o={})=>this.request({path:`/test-suite/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),testSuiteControllerRemove:(r,a={})=>this.request({path:`/test-suite/${r}`,method:"DELETE",secure:!0,format:"json",...a}),testSuiteTestControllerFindAllPaginated:(r,a,o={})=>this.request({path:`/test-suite/${r}/test`,method:"GET",query:a,secure:!0,format:"json",...o}),testSuiteTestControllerCreate:(r,a,o={})=>this.request({path:`/test-suite/${r}/test`,method:"POST",body:a,secure:!0,type:s.Json,format:"json",...o}),testSuiteTestControllerFindOne:(r,a,o={})=>this.request({path:`/test-suite/${r}/test/${a}`,method:"GET",secure:!0,format:"json",...o}),testSuiteTestControllerUpdate:(r,a,o,l={})=>this.request({path:`/test-suite/${r}/test/${a}`,method:"PATCH",body:o,secure:!0,type:s.Json,format:"json",...l}),testSuiteTestControllerRemove:(r,a,o={})=>this.request({path:`/test-suite/${r}/test/${a}`,method:"DELETE",secure:!0,format:"json",...o}),testSuiteRunControllerFindAllPaginated:(r,a,o={})=>this.request({path:`/test-suite/${r}/run`,method:"GET",query:a,secure:!0,format:"json",...o}),testSuiteRunControllerCreate:(r,a,o={})=>this.request({path:`/test-suite/${r}/run`,method:"POST",body:a,secure:!0,type:s.Json,format:"json",...o}),testSuiteRunControllerFindOne:(r,a,o={})=>this.request({path:`/test-suite/${r}/run/${a}`,method:"GET",secure:!0,format:"json",...o}),testSuiteRunControllerUpdate:(r,a,o,l={})=>this.request({path:`/test-suite/${r}/run/${a}`,method:"PATCH",body:o,secure:!0,type:s.Json,format:"json",...l}),testSuiteRunControllerRemove:(r,a,o={})=>this.request({path:`/test-suite/${r}/run/${a}`,method:"DELETE",secure:!0,format:"json",...o})});oe(this,"metrics",{analyticsControllerFindAllDeprecated:(r,a={})=>this.request({path:"/metrics",method:"GET",query:r,secure:!0,format:"json",...a})});oe(this,"analytics",{analyticsControllerQuery:(r,a={})=>this.request({path:"/analytics",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a})});oe(this,"log",{loggingControllerCallLogsQuery:(r,a={})=>this.request({path:"/log",method:"GET",query:r,secure:!0,format:"json",...a}),loggingControllerCallLogsDeleteQuery:(r,a={})=>this.request({path:"/log",method:"DELETE",query:r,secure:!0,...a})});oe(this,"logs",{loggingControllerLogsQuery:(r,a={})=>this.request({path:"/logs",method:"GET",query:r,secure:!0,format:"json",...a}),loggingControllerLogsDeleteQuery:(r,a={})=>this.request({path:"/logs",method:"DELETE",query:r,secure:!0,...a})});oe(this,"org",{orgControllerCreate:(r,a={})=>this.request({path:"/org",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),orgControllerFindAll:(r={})=>this.request({path:"/org",method:"GET",secure:!0,format:"json",...r}),orgControllerFindOne:(r,a={})=>this.request({path:`/org/${r}`,method:"GET",secure:!0,format:"json",...a}),orgControllerUpdate:(r,a,o={})=>this.request({path:`/org/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),orgControllerDeleteOrg:(r,a={})=>this.request({path:`/org/${r}`,method:"DELETE",secure:!0,...a}),orgControllerFindAllUsers:(r,a={})=>this.request({path:`/org/${r}/user`,method:"GET",secure:!0,format:"json",...a}),orgControllerOrgLeave:(r,a={})=>this.request({path:`/org/${r}/leave`,method:"DELETE",secure:!0,...a}),orgControllerOrgRemoveUser:(r,a,o={})=>this.request({path:`/org/${r}/member/${a}/leave`,method:"DELETE",secure:!0,...o}),orgControllerUsersInvite:(r,a,o={})=>this.request({path:`/org/${r}/invite`,method:"POST",body:a,secure:!0,type:s.Json,...o}),orgControllerUserUpdate:(r,a,o={})=>this.request({path:`/org/${r}/role`,method:"PATCH",body:a,secure:!0,type:s.Json,...o}),orgControllerOrgToken:(r,a={})=>this.request({path:`/org/${r}/auth`,method:"GET",secure:!0,format:"json",...a})});oe(this,"token",{tokenControllerCreate:(r,a={})=>this.request({path:"/token",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),tokenControllerFindAll:(r,a={})=>this.request({path:"/token",method:"GET",query:r,secure:!0,format:"json",...a}),tokenControllerFindOne:(r,a={})=>this.request({path:`/token/${r}`,method:"GET",secure:!0,format:"json",...a}),tokenControllerUpdate:(r,a,o={})=>this.request({path:`/token/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),tokenControllerRemove:(r,a={})=>this.request({path:`/token/${r}`,method:"DELETE",secure:!0,format:"json",...a})});oe(this,"credential",{credentialControllerCreate:(r,a={})=>this.request({path:"/credential",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),credentialControllerFindAll:(r,a={})=>this.request({path:"/credential",method:"GET",query:r,secure:!0,format:"json",...a}),credentialControllerFindOne:(r,a={})=>this.request({path:`/credential/${r}`,method:"GET",secure:!0,format:"json",...a}),credentialControllerUpdate:(r,a,o={})=>this.request({path:`/credential/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),credentialControllerRemove:(r,a={})=>this.request({path:`/credential/${r}`,method:"DELETE",secure:!0,format:"json",...a}),credentialControllerGenerateSession:(r,a={})=>this.request({path:"/credential/session",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),credentialControllerHandleWebhook:(r,a={})=>this.request({path:"/credential/webhook",method:"POST",body:r,type:s.Json,...a}),credentialControllerTriggerCredentialAction:(r,a={})=>this.request({path:"/credential/trigger",method:"POST",body:r,secure:!0,type:s.Json,...a})});oe(this,"template",{templateControllerCreate:(r,a={})=>this.request({path:"/template",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),templateControllerFindAll:(r,a={})=>this.request({path:"/template",method:"GET",query:r,secure:!0,format:"json",...a}),templateControllerFindAllPinned:(r={})=>this.request({path:"/template/pinned",method:"GET",secure:!0,format:"json",...r}),templateControllerFindOne:(r,a={})=>this.request({path:`/template/${r}`,method:"GET",secure:!0,format:"json",...a}),templateControllerUpdate:(r,a,o={})=>this.request({path:`/template/${r}`,method:"PATCH",body:a,secure:!0,type:s.Json,format:"json",...o}),templateControllerRemove:(r,a={})=>this.request({path:`/template/${r}`,method:"DELETE",secure:!0,format:"json",...a})});oe(this,"voiceLibrary",{voiceLibraryControllerVoiceGetByProvider:(r,a,o={})=>this.request({path:`/voice-library/${r}`,method:"GET",query:a,secure:!0,format:"json",...o}),voiceLibraryControllerVoiceGetAccentsByProvider:(r,a={})=>this.request({path:`/voice-library/${r}/accents`,method:"GET",secure:!0,format:"json",...a}),voiceLibraryControllerVoiceLibrarySyncByProvider:(r,a={})=>this.request({path:`/voice-library/sync/${r}`,method:"POST",secure:!0,format:"json",...a}),voiceLibraryControllerVoiceLibrarySyncDefaultVoices:(r,a={})=>this.request({path:"/voice-library/sync",method:"POST",body:r,secure:!0,type:s.Json,format:"json",...a}),voiceLibraryControllerVoiceLibraryCreateSesameVoice:(r,a={})=>this.request({path:"/voice-library/create-sesame-voice",method:"POST",body:r,secure:!0,type:s.Json,...a})});oe(this,"provider",{providerControllerGetWorkflows:(r,a,o={})=>this.request({path:`/${r}/workflows`,method:"GET",query:a,secure:!0,format:"json",...o}),providerControllerGetWorkflowTriggerHook:(r,a,o={})=>this.request({path:`/${r}/workflows/${a}/hooks`,method:"GET",secure:!0,format:"json",...o}),providerControllerGetLocations:(r,a={})=>this.request({path:`/${r}/locations`,method:"GET",secure:!0,format:"json",...a}),voiceProviderControllerSearchVoices:(r,a,o={})=>this.request({path:`/${r}/voices/search`,method:"GET",query:a,secure:!0,format:"json",...o}),voiceProviderControllerSearchVoice:(r,a,o={})=>this.request({path:`/${r}/voice/search`,method:"GET",query:a,secure:!0,format:"json",...o}),voiceProviderControllerAddVoices:(r,a,o={})=>this.request({path:`/${r}/voices/add`,method:"POST",body:a,secure:!0,type:s.Json,format:"json",...o}),voiceProviderControllerAddVoice:(r,a,o={})=>this.request({path:`/${r}/voice/add`,method:"POST",body:a,secure:!0,type:s.Json,format:"json",...o})});oe(this,"v11Labs",{voiceProviderControllerCloneVoices:(r,a={})=>this.request({path:"/11labs/voice/clone",method:"POST",body:r,secure:!0,type:s.FormData,...a})})}}return kt.Api=t,kt}var Kc;function _p(){if(Kc)return Gi;Kc=1,Object.defineProperty(Gi,"__esModule",{value:!0}),Gi.client=void 0;const s=bp(),e=new s.Api({baseUrl:"https://api.vapi.ai",baseApiParams:{secure:!0},securityWorker:async t=>{if(t)return{headers:{Authorization:`Bearer ${t}`}}}});return Gi.client=e,Gi}var Yc;function xp(){if(Yc)return tt;Yc=1;var s=tt&&tt.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(tt,"__esModule",{value:!0});const e=s(Ep),t=s(Tp()),i=_p();async function n(u,d){u.muted=!1,u.autoplay=!0,d!=null&&(u.srcObject=new MediaStream([d]),await u.play())}async function r(u,d){const f=document.createElement("audio");return f.dataset.participantId=d,document.body.appendChild(f),await n(f,u),f}function a(u){const d=document.querySelector(`audio[data-participant-id="${u}"]`);d==null||d.remove()}function o(u,d,f,p){u.participant.local||d.updateParticipant(u.participant.session_id,{setSubscribedTracks:{audio:!0,video:f||p}})}class l extends t.default{on(d,f){return super.on(d,f),this}once(d,f){return super.once(d,f),this}emit(d,...f){return super.emit(d,...f)}removeListener(d,f){return super.removeListener(d,f),this}removeAllListeners(d){return super.removeAllListeners(d),this}}class c extends l{constructor(f,p,g,y){super();oe(this,"started",!1);oe(this,"call",null);oe(this,"speakingTimeout",null);oe(this,"dailyCallConfig",{});oe(this,"dailyCallObject",{});oe(this,"hasEmittedCallEndedStatus",!1);i.client.baseUrl=p??"https://api.vapi.ai",i.client.setSecurityData(f),this.dailyCallConfig=g??{},this.dailyCallObject=y??{}}cleanup(){var f;this.started=!1,this.hasEmittedCallEndedStatus=!1,(f=this.call)==null||f.destroy(),this.call=null,this.speakingTimeout=null}isMobileDevice(){if(typeof navigator>"u")return!1;const f=navigator.userAgent;return/android|iphone|ipad|ipod|iemobile|blackberry|bada/i.test(f.toLowerCase())}async sleep(f){return new Promise(p=>setTimeout(p,f))}async start(f,p,g,y){var S,T,L,w;if(!f&&!g&&!y)throw new Error("Assistant or Squad or Workflow must be provided.");if(this.started)return null;this.started=!0;try{const x=(await i.client.call.callControllerCreateWebCall({assistant:typeof f=="string"?void 0:f,assistantId:typeof f=="string"?f:void 0,assistantOverrides:p,squad:typeof g=="string"?void 0:g,squadId:typeof g=="string"?g:void 0,workflow:typeof y=="string"?void 0:y,workflowId:typeof y=="string"?y:void 0})).data;this.call&&this.cleanup();const b=((S=x==null?void 0:x.artifactPlan)==null?void 0:S.videoRecordingEnabled)??!1,C=((L=(T=x==null?void 0:x.assistant)==null?void 0:T.voice)==null?void 0:L.provider)==="tavus";if(this.call=e.default.createCallObject({audioSource:this.dailyCallObject.audioSource??!0,videoSource:this.dailyCallObject.videoSource??b,dailyConfig:this.dailyCallConfig}),(w=this.call.iframe())==null||w.style.setProperty("display","none"),this.call.on("left-meeting",()=>{var _;this.emit("call-end"),this.hasEmittedCallEndedStatus||(this.emit("message",{type:"status-update",status:"ended",endedReason:"customer-ended-call"}),this.hasEmittedCallEndedStatus=!0),b&&((_=this.call)==null||_.stopRecording()),this.cleanup()}),this.call.on("error",_=>{var k;this.emit("error",_),b&&((k=this.call)==null||k.stopRecording())}),this.call.on("camera-error",_=>{this.emit("error",_)}),this.call.on("track-started",async _=>{var k,D,R;!_||!_.participant||(k=_.participant)!=null&&k.local||((D=_.participant)==null?void 0:D.user_name)==="Vapi Speaker"&&(_.track.kind==="video"&&this.emit("video",_.track),_.track.kind==="audio"&&await r(_.track,_.participant.session_id),(R=this.call)==null||R.sendAppMessage("playable"))}),this.call.on("participant-joined",_=>{!_||!this.call||o(_,this.call,b,C)}),this.call.on("participant-updated",_=>{_&&this.emit("daily-participant-updated",_.participant)}),this.call.on("participant-left",_=>{_&&a(_.participant.session_id)}),this.isMobileDevice()&&await this.sleep(1e3),await this.call.join({url:x.webCallUrl,subscribeToTracksAutomatically:!1}),b){const _=new Date().getTime();this.call.startRecording({width:1280,height:720,backgroundColor:"#FF1F2D3D",layout:{preset:"default"}}),this.call.on("recording-started",()=>{this.send({type:"control",control:"say-first-message",videoRecordingStartDelaySeconds:(new Date().getTime()-_)/1e3})})}return this.call.startRemoteParticipantsAudioLevelObserver(100),this.call.on("remote-participants-audio-level",_=>{_&&this.handleRemoteParticipantsAudioLevel(_)}),this.call.on("app-message",_=>this.onAppMessage(_)),this.call.on("nonfatal-error",_=>{var k;(_==null?void 0:_.type)==="audio-processor-error"&&((k=this.call)==null||k.updateInputSettings({audio:{processor:{type:"none"}}}).then(()=>{var D;(D=this.call)==null||D.setLocalAudio(!0)}))}),this.call.updateInputSettings({audio:{processor:{type:"noise-cancellation"}}}),x}catch(x){return console.error(x),this.emit("error",x),this.cleanup(),null}}onAppMessage(f){if(f)try{if(f.data==="listening")return this.emit("call-start");try{const p=JSON.parse(f.data);this.emit("message",p),p&&"type"in p&&"status"in p&&p.type==="status-update"&&p.status==="ended"&&(this.hasEmittedCallEndedStatus=!0)}catch(p){console.log("Error parsing message data: ",p)}}catch(p){console.error(p)}}handleRemoteParticipantsAudioLevel(f){const p=Object.values(f.participantsAudioLevel).reduce((y,S)=>y+S,0);this.emit("volume-level",Math.min(1,p/.15)),p>.01&&(this.speakingTimeout?(clearTimeout(this.speakingTimeout),this.speakingTimeout=null):this.emit("speech-start"),this.speakingTimeout=setTimeout(()=>{this.emit("speech-end"),this.speakingTimeout=null},1e3))}stop(){var f;this.started=!1,(f=this.call)==null||f.destroy(),this.call=null}send(f){var p;(p=this.call)==null||p.sendAppMessage(JSON.stringify(f))}setMuted(f){if(!this.call)throw new Error("Call object is not available.");this.call.setLocalAudio(!f)}isMuted(){return this.call?this.call.localAudio()===!1:!1}say(f,p,g){this.send({type:"say",message:f,endCallAfterSpoken:p,interruptionsEnabled:g??!1})}setInputDevicesAsync(f){var p;(p=this.call)==null||p.setInputDevicesAsync(f)}async increaseMicLevel(f){if(!this.call)throw new Error("Call object is not available.");try{const p=await navigator.mediaDevices.getUserMedia({audio:!0}),g=new AudioContext,y=g.createMediaStreamSource(p),S=g.createGain();S.gain.value=f,y.connect(S);const T=g.createMediaStreamDestination();S.connect(T);const[L]=T.stream.getAudioTracks();await this.call.setInputDevicesAsync({audioSource:L})}catch(p){console.error("Error adjusting microphone level:",p)}}setOutputDeviceAsync(f){var p;(p=this.call)==null||p.setOutputDeviceAsync(f)}getDailyCallObject(){return this.call}startScreenSharing(f,p){var g;(g=this.call)==null||g.startScreenShare({displayMediaOptions:f,screenVideoSendSettings:p})}stopScreenSharing(){var f;(f=this.call)==null||f.stopScreenShare()}}return tt.default=c,tt}var Ap=xp();const Ip=Wt(Ap),K=Number.isFinite||function(s){return typeof s=="number"&&isFinite(s)},wp=Number.isSafeInteger||function(s){return typeof s=="number"&&Math.abs(s)<=Lp},Lp=Number.MAX_SAFE_INTEGER||9007199254740991;let Z=function(s){return s.NETWORK_ERROR="networkError",s.MEDIA_ERROR="mediaError",s.KEY_SYSTEM_ERROR="keySystemError",s.MUX_ERROR="muxError",s.OTHER_ERROR="otherError",s}({}),M=function(s){return s.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",s.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",s.KEY_SYSTEM_NO_SESSION="keySystemNoSession",s.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",s.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",s.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",s.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",s.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",s.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",s.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",s.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",s.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",s.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",s.MANIFEST_LOAD_ERROR="manifestLoadError",s.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",s.MANIFEST_PARSING_ERROR="manifestParsingError",s.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",s.LEVEL_EMPTY_ERROR="levelEmptyError",s.LEVEL_LOAD_ERROR="levelLoadError",s.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",s.LEVEL_PARSING_ERROR="levelParsingError",s.LEVEL_SWITCH_ERROR="levelSwitchError",s.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",s.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",s.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",s.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",s.FRAG_LOAD_ERROR="fragLoadError",s.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",s.FRAG_DECRYPT_ERROR="fragDecryptError",s.FRAG_PARSING_ERROR="fragParsingError",s.FRAG_GAP="fragGap",s.REMUX_ALLOC_ERROR="remuxAllocError",s.KEY_LOAD_ERROR="keyLoadError",s.KEY_LOAD_TIMEOUT="keyLoadTimeOut",s.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",s.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",s.BUFFER_APPEND_ERROR="bufferAppendError",s.BUFFER_APPENDING_ERROR="bufferAppendingError",s.BUFFER_STALLED_ERROR="bufferStalledError",s.BUFFER_FULL_ERROR="bufferFullError",s.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",s.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",s.ASSET_LIST_LOAD_ERROR="assetListLoadError",s.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",s.ASSET_LIST_PARSING_ERROR="assetListParsingError",s.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",s.INTERNAL_EXCEPTION="internalException",s.INTERNAL_ABORTED="aborted",s.ATTACH_MEDIA_ERROR="attachMediaError",s.UNKNOWN="unknown",s}({}),E=function(s){return s.MEDIA_ATTACHING="hlsMediaAttaching",s.MEDIA_ATTACHED="hlsMediaAttached",s.MEDIA_DETACHING="hlsMediaDetaching",s.MEDIA_DETACHED="hlsMediaDetached",s.MEDIA_ENDED="hlsMediaEnded",s.STALL_RESOLVED="hlsStallResolved",s.BUFFER_RESET="hlsBufferReset",s.BUFFER_CODECS="hlsBufferCodecs",s.BUFFER_CREATED="hlsBufferCreated",s.BUFFER_APPENDING="hlsBufferAppending",s.BUFFER_APPENDED="hlsBufferAppended",s.BUFFER_EOS="hlsBufferEos",s.BUFFERED_TO_END="hlsBufferedToEnd",s.BUFFER_FLUSHING="hlsBufferFlushing",s.BUFFER_FLUSHED="hlsBufferFlushed",s.MANIFEST_LOADING="hlsManifestLoading",s.MANIFEST_LOADED="hlsManifestLoaded",s.MANIFEST_PARSED="hlsManifestParsed",s.LEVEL_SWITCHING="hlsLevelSwitching",s.LEVEL_SWITCHED="hlsLevelSwitched",s.LEVEL_LOADING="hlsLevelLoading",s.LEVEL_LOADED="hlsLevelLoaded",s.LEVEL_UPDATED="hlsLevelUpdated",s.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",s.LEVELS_UPDATED="hlsLevelsUpdated",s.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",s.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",s.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",s.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",s.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",s.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",s.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",s.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",s.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",s.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",s.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",s.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",s.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",s.CUES_PARSED="hlsCuesParsed",s.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",s.INIT_PTS_FOUND="hlsInitPtsFound",s.FRAG_LOADING="hlsFragLoading",s.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",s.FRAG_LOADED="hlsFragLoaded",s.FRAG_DECRYPTED="hlsFragDecrypted",s.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",s.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",s.FRAG_PARSING_METADATA="hlsFragParsingMetadata",s.FRAG_PARSED="hlsFragParsed",s.FRAG_BUFFERED="hlsFragBuffered",s.FRAG_CHANGED="hlsFragChanged",s.FPS_DROP="hlsFpsDrop",s.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",s.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",s.ERROR="hlsError",s.DESTROYING="hlsDestroying",s.KEY_LOADING="hlsKeyLoading",s.KEY_LOADED="hlsKeyLoaded",s.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",s.BACK_BUFFER_REACHED="hlsBackBufferReached",s.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",s.ASSET_LIST_LOADING="hlsAssetListLoading",s.ASSET_LIST_LOADED="hlsAssetListLoaded",s.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",s.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",s.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",s.INTERSTITIAL_STARTED="hlsInterstitialStarted",s.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",s.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",s.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",s.INTERSTITIAL_ENDED="hlsInterstitialEnded",s.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",s.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",s.EVENT_CUE_ENTER="hlsEventCueEnter",s}({});var Ct={AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},re={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class Ei{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class kp{constructor(e,t,i,n=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Ei(e),this.fast_=new Ei(t),this.defaultTTFB_=n,this.ttfb_=new Ei(e)}update(e,t){const{slow_:i,fast_:n,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new Ei(e,i.getEstimate(),i.getTotalWeight())),n.halfLife!==t&&(this.fast_=new Ei(t,n.getEstimate(),n.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new Ei(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,n=e/1e3,r=i/n;this.fast_.sample(n,r),this.slow_.sample(n,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function Cp(s,e,t){return(e=Pp(e))in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}function Ie(){return Ie=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(s[i]=t[i])}return s},Ie.apply(null,arguments)}function Wc(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function xe(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Wc(Object(t),!0).forEach(function(i){Cp(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Wc(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}function Rp(s,e){if(typeof s!="object"||!s)return s;var t=s[Symbol.toPrimitive];if(t!==void 0){var i=t.call(s,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(s)}function Pp(s){var e=Rp(s,"string");return typeof e=="symbol"?e:e+""}class Rt{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=ai,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const ai=function(){},Dp={trace:ai,debug:ai,log:ai,warn:ai,info:ai,error:ai};function Op(){return Ie({},Dp)}const ye=Op();function Vi(s=!0){return typeof self>"u"?void 0:(s||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function Mp(s){return typeof self<"u"&&s===self.ManagedMediaSource}function zc(s,e){const t=Object.keys(s),i=Object.keys(e),n=t.length,r=i.length;return!n||!r||n===r&&!t.some(a=>i.indexOf(a)===-1)}function Ke(s,e=!1){if(typeof TextDecoder<"u"){const c=new TextDecoder("utf-8").decode(s);if(e){const u=c.indexOf("\0");return u!==-1?c.substring(0,u):c}return c.replace(/\0/g,"")}const t=s.length;let i,n,r,a="",o=0;for(;o<t;){if(i=s[o++],i===0&&e)return a;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(i);break;case 12:case 13:n=s[o++],a+=String.fromCharCode((i&31)<<6|n&63);break;case 14:n=s[o++],r=s[o++],a+=String.fromCharCode((i&15)<<12|(n&63)<<6|(r&63)<<0);break}}return a}const gt={hexDump:function(s){let e="";for(let t=0;t<s.length;t++){let i=s[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}};function Fp(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var _r={exports:{}},Jc;function Np(){return Jc||(Jc=1,function(s,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,c,u){if(u=u||{},l=l.trim(),c=c.trim(),!c){if(!u.alwaysNormalize)return l;var d=o.parseURL(l);if(!d)throw new Error("Error trying to parse base URL.");return d.path=o.normalizePath(d.path),o.buildURLFromParts(d)}var f=o.parseURL(c);if(!f)throw new Error("Error trying to parse relative URL.");if(f.scheme)return u.alwaysNormalize?(f.path=o.normalizePath(f.path),o.buildURLFromParts(f)):c;var p=o.parseURL(l);if(!p)throw new Error("Error trying to parse base URL.");if(!p.netLoc&&p.path&&p.path[0]!=="/"){var g=n.exec(p.path);p.netLoc=g[1],p.path=g[2]}p.netLoc&&!p.path&&(p.path="/");var y={scheme:p.scheme,netLoc:f.netLoc,path:null,params:f.params,query:f.query,fragment:f.fragment};if(!f.netLoc&&(y.netLoc=p.netLoc,f.path[0]!=="/"))if(!f.path)y.path=p.path,f.params||(y.params=p.params,f.query||(y.query=p.query));else{var S=p.path,T=S.substring(0,S.lastIndexOf("/")+1)+f.path;y.path=o.normalizePath(T)}return y.path===null&&(y.path=u.alwaysNormalize?o.normalizePath(f.path):f.path),o.buildURLFromParts(y)},parseURL:function(l){var c=i.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(r,"");l.length!==(l=l.replace(a,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};s.exports=o})()}(_r)),_r.exports}Np();class Up{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var Fe={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};function Ye(s){return s.sn!=="initSegment"}const Us=Math.pow(2,32)-1,Bp=[].push,Qc={video:1,audio:2,id3:3,text:4};function Ce(s){return String.fromCharCode.apply(null,s)}function Xc(s,e){const t=s[e]<<8|s[e+1];return t<0?65536+t:t}function Y(s,e){const t=eu(s,e);return t<0?4294967296+t:t}function Zc(s,e){let t=Y(s,e);return t*=Math.pow(2,32),t+=Y(s,e+4),t}function eu(s,e){return s[e]<<24|s[e+1]<<16|s[e+2]<<8|s[e+3]}function xr(s,e,t){s[e]=t>>24,s[e+1]=t>>16&255,s[e+2]=t>>8&255,s[e+3]=t&255}function $p(s){const e=s.byteLength;for(let t=0;t<e;){const i=Y(s,t);if(i>8&&s[t+4]===109&&s[t+5]===111&&s[t+6]===111&&s[t+7]===102)return!0;t=i>1?t+i:e}return!1}function te(s,e){const t=[];if(!e.length)return t;const i=s.byteLength;for(let n=0;n<i;){const r=Y(s,n),a=Ce(s.subarray(n+4,n+8)),o=r>1?n+r:i;if(a===e[0])if(e.length===1)t.push(s.subarray(n+8,o));else{const l=te(s.subarray(n+8,o),e.slice(1));l.length&&Bp.apply(t,l)}n=o}return t}function jp(s){const e=[],t=s[0];let i=8;const n=Y(s,i);i+=4;let r=0,a=0;t===0?(r=Y(s,i),a=Y(s,i+4),i+=8):(r=Zc(s,i),a=Zc(s,i+8),i+=16),i+=2;let o=s.length+a;const l=Xc(s,i);i+=2;for(let c=0;c<l;c++){let u=i;const d=Y(s,u);u+=4;const f=d&2147483647;if((d&2147483648)>>>31===1)return ye.warn("SIDX has hierarchical references (not supported)"),null;const g=Y(s,u);u+=4,e.push({referenceSize:f,subsegmentDuration:g,info:{duration:g/n,start:o,end:o+f-1}}),o+=f,u+=4,i=u}return{earliestPresentationTime:r,timescale:n,version:t,referencesCount:l,references:e}}function tu(s){const e=[],t=te(s,["moov","trak"]);for(let n=0;n<t.length;n++){const r=t[n],a=te(r,["tkhd"])[0];if(a){let o=a[0];const l=Y(a,o===0?12:20),c=te(r,["mdia","mdhd"])[0];if(c){o=c[0];const u=Y(c,o===0?12:20),d=te(r,["mdia","hdlr"])[0];if(d){const f=Ce(d.subarray(8,12)),p={soun:Fe.AUDIO,vide:Fe.VIDEO}[f],g=te(r,["mdia","minf","stbl","stsd"])[0],y=Gp(g);p?(e[l]={timescale:u,type:p,stsd:y},e[p]=xe({timescale:u,id:l},y)):e[l]={timescale:u,type:f,stsd:y}}}}}return te(s,["moov","mvex","trex"]).forEach(n=>{const r=Y(n,4),a=e[r];a&&(a.default={duration:Y(n,12),flags:Y(n,20)})}),e}function Gp(s){const e=s.subarray(8),t=e.subarray(86),i=Ce(e.subarray(4,8));let n=i,r;const a=i==="enca"||i==="encv";if(a){const c=te(e,[i])[0].subarray(i==="enca"?28:78);te(c,["sinf"]).forEach(d=>{const f=te(d,["schm"])[0];if(f){const p=Ce(f.subarray(4,8));if(p==="cbcs"||p==="cenc"){const g=te(d,["frma"])[0];g&&(n=Ce(g))}}})}const o=n;switch(n){case"avc1":case"avc2":case"avc3":case"avc4":{const l=te(t,["avcC"])[0];l&&l.length>3&&(n+="."+$s(l[1])+$s(l[2])+$s(l[3]),r=Bs(o==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const l=te(e,[i])[0],c=te(l.subarray(28),["esds"])[0];if(c&&c.length>7){let u=4;if(c[u++]!==3)break;u=Ar(c,u),u+=2;const d=c[u++];if(d&128&&(u+=2),d&64&&(u+=c[u++]),c[u++]!==4)break;u=Ar(c,u);const f=c[u++];if(f===64)n+="."+$s(f);else break;if(u+=12,c[u++]!==5)break;u=Ar(c,u);const p=c[u++];let g=(p&248)>>3;g===31&&(g+=1+((p&7)<<3)+((c[u]&224)>>5)),n+="."+g}break}case"hvc1":case"hev1":{const l=te(t,["hvcC"])[0];if(l&&l.length>12){const c=l[1],u=["","A","B","C"][c>>6],d=c&31,f=Y(l,2),p=(c&32)>>5?"H":"L",g=l[12],y=l.subarray(6,12);n+="."+u+d,n+="."+f.toString(16).toUpperCase(),n+="."+p+g;let S="";for(let T=y.length;T--;){const L=y[T];(L||S)&&(S="."+L.toString(16).toUpperCase()+S)}n+=S}r=Bs(o=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{n=Bs(n,t)||n;break}case"vp09":{const l=te(t,["vpcC"])[0];if(l&&l.length>6){const c=l[4],u=l[5],d=l[6]>>4&15;n+="."+mt(c)+"."+mt(u)+"."+mt(d)}break}case"av01":{const l=te(t,["av1C"])[0];if(l&&l.length>2){const c=l[1]>>>5,u=l[1]&31,d=l[2]>>>7?"H":"M",f=(l[2]&64)>>6,p=(l[2]&32)>>5,g=c===2&&f?p?12:10:f?10:8,y=(l[2]&16)>>4,S=(l[2]&8)>>3,T=(l[2]&4)>>2,L=l[2]&3;n+="."+c+"."+mt(u)+d+"."+mt(g)+"."+y+"."+S+T+L+"."+mt(1)+"."+mt(1)+"."+mt(1)+"."+0,r=Bs("dav1",t)}break}}return{codec:n,encrypted:a,supplemental:r}}function Bs(s,e){const t=te(e,["dvvC"]),i=t.length?t[0]:te(e,["dvcC"])[0];if(i){const n=i[2]>>1&127,r=i[2]<<5&32|i[3]>>3&31;return s+"."+mt(n)+"."+mt(r)}}function Ar(s,e){const t=e+5;for(;s[e++]&128&&e<t;);return e}function $s(s){return("0"+s.toString(16).toUpperCase()).slice(-2)}function mt(s){return(s<10?"0":"")+s}function Vp(s,e){if(!s||!e)return s;const t=e.keyId;return t&&e.isCommonEncryption&&te(s,["moov","trak"]).forEach(n=>{const a=te(n,["mdia","minf","stbl","stsd"])[0].subarray(8);let o=te(a,["enca"]);const l=o.length>0;l||(o=te(a,["encv"])),o.forEach(c=>{const u=l?c.subarray(28):c.subarray(78);te(u,["sinf"]).forEach(f=>{const p=iu(f);if(p){const g=p.subarray(8,24);g.some(y=>y!==0)||(ye.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${gt.hexDump(g)} -> ${gt.hexDump(t)}`),p.set(t,8))}})})}),s}function iu(s){const e=te(s,["schm"])[0];if(e){const t=Ce(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return te(s,["schi","tenc"])[0]}return null}function qp(s,e){return te(e,["moof","traf"]).reduce((t,i)=>{const n=te(i,["tfdt"])[0],r=n[0],a=te(i,["tfhd"]).reduce((o,l)=>{const c=Y(l,4),u=s[c];if(u){let d=Y(n,4);if(r===1){if(d===Us)return ye.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),o;d*=Us+1,d+=Y(n,8)}const f=u.timescale||9e4,p=d/f;if(K(p)&&(o===null||p<o))return p}return o},null);return a!==null&&K(a)&&(t===null||a<t)?a:t},null)}function Hp(s,e){let t=0,i=0,n=0;const r=te(s,["moof","traf"]);for(let a=0;a<r.length;a++){const o=r[a],l=te(o,["tfhd"])[0],c=Y(l,4),u=e[c];if(!u)continue;const d=u.default,f=Y(l,0)|(d==null?void 0:d.flags);let p=d==null?void 0:d.duration;f&8&&(f&2?p=Y(l,12):p=Y(l,8));const g=u.timescale||9e4,y=te(o,["trun"]);for(let S=0;S<y.length;S++){if(t=Kp(y[S]),!t&&p){const T=Y(y[S],4);t=p*T}u.type===Fe.VIDEO?i+=t/g:u.type===Fe.AUDIO&&(n+=t/g)}}if(i===0&&n===0){let a=1/0,o=0,l=0;const c=te(s,["sidx"]);for(let u=0;u<c.length;u++){const d=jp(c[u]);if(d!=null&&d.references){a=Math.min(a,d.earliestPresentationTime/d.timescale);const f=d.references.reduce((p,g)=>p+g.info.duration||0,0);o=Math.max(o,f+d.earliestPresentationTime/d.timescale),l=o-a}}if(l&&K(l))return l}return i||n}function Kp(s){const e=Y(s,0);let t=8;e&1&&(t+=4),e&4&&(t+=4);let i=0;const n=Y(s,4);for(let r=0;r<n;r++){if(e&256){const a=Y(s,t);i+=a,t+=4}e&512&&(t+=4),e&1024&&(t+=4),e&2048&&(t+=4)}return i}function Yp(s,e,t){te(e,["moof","traf"]).forEach(i=>{te(i,["tfhd"]).forEach(n=>{const r=Y(n,4),a=s[r];if(!a)return;const o=a.timescale||9e4;te(i,["tfdt"]).forEach(l=>{const c=l[0],u=t*o;if(u){let d=Y(l,4);if(c===0)d-=u,d=Math.max(d,0),xr(l,4,d);else{d*=Math.pow(2,32),d+=Y(l,8),d-=u,d=Math.max(d,0);const f=Math.floor(d/(Us+1)),p=Math.floor(d%(Us+1));xr(l,4,f),xr(l,8,p)}}})})})}function Wp(s){const e={valid:null,remainder:null},t=te(s,["moof"]);if(t.length<2)return e.remainder=s,e;const i=t[t.length-1];return e.valid=s.slice(0,i.byteOffset-8),e.remainder=s.slice(i.byteOffset-8),e}function Qe(s,e){const t=new Uint8Array(s.length+e.length);return t.set(s),t.set(e,s.length),t}function su(s,e){const t=[],i=e.samples,n=e.timescale,r=e.id;let a=!1;return te(i,["moof"]).map(l=>{const c=l.byteOffset-8;te(l,["traf"]).map(d=>{const f=te(d,["tfdt"]).map(p=>{const g=p[0];let y=Y(p,4);return g===1&&(y*=Math.pow(2,32),y+=Y(p,8)),y/n})[0];return f!==void 0&&(s=f),te(d,["tfhd"]).map(p=>{const g=Y(p,4),y=Y(p,0)&16777215,S=(y&1)!==0,T=(y&2)!==0,L=(y&8)!==0;let w=0;const x=(y&16)!==0;let b=0;const C=(y&32)!==0;let _=8;g===r&&(S&&(_+=8),T&&(_+=4),L&&(w=Y(p,_),_+=4),x&&(b=Y(p,_),_+=4),C&&(_+=4),e.type==="video"&&(a=js(e.codec)),te(d,["trun"]).map(k=>{const D=k[0],R=Y(k,0)&16777215,N=(R&1)!==0;let G=0;const ce=(R&4)!==0,J=(R&256)!==0;let ae=0;const se=(R&512)!==0;let q=0;const fe=(R&1024)!==0,j=(R&2048)!==0;let B=0;const ee=Y(k,4);let Q=8;N&&(G=Y(k,Q),Q+=4),ce&&(Q+=4);let z=G+c;for(let h=0;h<ee;h++){if(J?(ae=Y(k,Q),Q+=4):ae=w,se?(q=Y(k,Q),Q+=4):q=b,fe&&(Q+=4),j&&(D===0?B=Y(k,Q):B=eu(k,Q),Q+=4),e.type===Fe.VIDEO){let v=0;for(;v<q;){const m=Y(i,z);if(z+=4,zp(a,i[z])){const I=i.subarray(z,z+m);Ir(I,a?2:1,s+B/n,t)}z+=m,v+=m+4}}s+=ae/n}}))})})}),t}function js(s){if(!s)return!1;const e=s.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function zp(s,e){if(s){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function Ir(s,e,t,i){const n=nu(s);let r=0;r+=e;let a=0,o=0,l=0;for(;r<n.length;){a=0;do{if(r>=n.length)break;l=n[r++],a+=l}while(l===255);o=0;do{if(r>=n.length)break;l=n[r++],o+=l}while(l===255);const c=n.length-r;let u=r;if(o<c)r+=o;else if(o>c){ye.error(`Malformed SEI payload. ${o} is too small, only ${c} bytes left to parse.`);break}if(a===4){if(n[u++]===181){const f=Xc(n,u);if(u+=2,f===49){const p=Y(n,u);if(u+=4,p===1195456820){const g=n[u++];if(g===3){const y=n[u++],S=31&y,T=64&y,L=T?2+S*3:0,w=new Uint8Array(L);if(T){w[0]=y;for(let x=1;x<L;x++)w[x]=n[u++]}i.push({type:g,payloadType:a,pts:t,bytes:w})}}}}}else if(a===5&&o>16){const d=[];for(let g=0;g<16;g++){const y=n[u++].toString(16);d.push(y.length==1?"0"+y:y),(g===3||g===5||g===7||g===9)&&d.push("-")}const f=o-16,p=new Uint8Array(f);for(let g=0;g<f;g++)p[g]=n[u++];i.push({payloadType:a,pts:t,uuid:d.join(""),userData:Ke(p),userDataBytes:p})}}}function nu(s){const e=s.byteLength,t=[];let i=1;for(;i<e-2;)s[i]===0&&s[i+1]===0&&s[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return s;const n=e-t.length,r=new Uint8Array(n);let a=0;for(i=0;i<n;a++,i++)a===t[0]&&(a++,t.shift()),r[i]=s[a];return r}function Jp(s){const e=s[0];let t="",i="",n=0,r=0,a=0,o=0,l=0,c=0;if(e===0){for(;Ce(s.subarray(c,c+1))!=="\0";)t+=Ce(s.subarray(c,c+1)),c+=1;for(t+=Ce(s.subarray(c,c+1)),c+=1;Ce(s.subarray(c,c+1))!=="\0";)i+=Ce(s.subarray(c,c+1)),c+=1;i+=Ce(s.subarray(c,c+1)),c+=1,n=Y(s,12),r=Y(s,16),o=Y(s,20),l=Y(s,24),c=28}else if(e===1){c+=4,n=Y(s,c),c+=4;const d=Y(s,c);c+=4;const f=Y(s,c);for(c+=4,a=2**32*d+f,wp(a)||(a=Number.MAX_SAFE_INTEGER,ye.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=Y(s,c),c+=4,l=Y(s,c),c+=4;Ce(s.subarray(c,c+1))!=="\0";)t+=Ce(s.subarray(c,c+1)),c+=1;for(t+=Ce(s.subarray(c,c+1)),c+=1;Ce(s.subarray(c,c+1))!=="\0";)i+=Ce(s.subarray(c,c+1)),c+=1;i+=Ce(s.subarray(c,c+1)),c+=1}const u=s.subarray(c,s.byteLength);return{schemeIdUri:t,value:i,timeScale:n,presentationTime:a,presentationTimeDelta:r,eventDuration:o,id:l,payload:u}}function Qp(s,...e){const t=e.length;let i=8,n=t;for(;n--;)i+=e[n].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(s,4),n=0,i=8;n<t;n++)r.set(e[n],i),i+=e[n].byteLength;return r}function Xp(s,e,t){if(s.byteLength!==16)throw new RangeError("Invalid system id");let i,n;i=0,n=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const a=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(a.buffer).setUint32(0,t.byteLength,!1),Qp([112,115,115,104],new Uint8Array([i,0,0,0]),s,r,n,a,t||new Uint8Array)}function Zp(s){const e=[];if(s instanceof ArrayBuffer){const t=s.byteLength;let i=0;for(;i+32<t;){const n=new DataView(s,i),r=eg(n);e.push(r),i+=r.size}}return e}function eg(s){const e=s.getUint32(0),t=s.byteOffset,i=s.byteLength;if(i<e)return{offset:t,size:i};if(s.getUint32(4)!==1886614376)return{offset:t,size:e};const r=s.getUint32(8)>>>24;if(r!==0&&r!==1)return{offset:t,size:e};const a=s.buffer,o=gt.hexDump(new Uint8Array(a,t+12,16)),l=s.getUint32(28);let c=null,u=null;if(r===0){if(e-32<l||l<22)return{offset:t,size:e};u=new Uint8Array(a,t+32,l)}else if(r===1){if(!l||i<t+32+l*16+16)return{offset:t,size:e};c=[];for(let d=0;d<l;d++)c.push(new Uint8Array(a,t+32+d*16,16))}return{version:r,systemId:o,kids:c,data:u,offset:t,size:e}}const ru=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),wr={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function tg(s,e){const t=wr[e];return!!t&&!!t[s.slice(0,4)]}function ig(s,e,t=!0){return!s.split(",").some(i=>!au(i,e,t))}function au(s,e,t=!0){var i;const n=Vi(t);return(i=n==null?void 0:n.isTypeSupported(Lr(s,e)))!=null?i:!1}function Lr(s,e){return`${e}/mp4;codecs=${s}`}function ou(s){const e=ru();return s.split(",").reduce((t,i)=>{const r=e&&js(i)?9:wr.video[i];return r?(r*2+t)/(t?3:2):(wr.audio[i]+t)/(t?2:1)},0)}const kr={};function sg(s,e=!0){if(kr[s])return kr[s];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[s];for(let n=0;n<t.length;n++){var i;if(au(t[n],"audio",e))return kr[s]=t[n],t[n];if(t[n]==="mp3"&&(i=Vi(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return s}const ng=/flac|opus|mp4a\.40\.34/i;function Cr(s,e=!0){return s.replace(ng,t=>sg(t.toLowerCase(),e))}function rg(s,e){const t=[];if(s){const i=s.split(",");for(let n=0;n<i.length;n++)tg(i[n],"video")||t.push(i[n])}return e&&t.push(e),t.join(",")}function Rr(s,e){if(s&&(s.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(s)!==-1))return s;if(e){const t=e.split(",");if(t.length>1){if(s){for(let i=t.length;i--;)if(t[i].substring(0,4)===s.substring(0,4))return t[i]}return t[0]}}return e||s}function ag(s){if(s.startsWith("av01.")){const e=s.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return s}function lu(s){const e=Vi(s)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function cu(s){return s.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const uu={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function og(s,e){return{supported:!1,configurations:e,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:s}}const du={};function lg(s,e,t,i,n,r){const a=s.audioCodec?s.audioGroups:null,o=r==null?void 0:r.audioCodec,l=r==null?void 0:r.channels,c=l?parseInt(l):o?1/0:2;let u=null;if(a!=null&&a.length)try{a.length===1&&a[0]?u=e.groups[a[0]].channels:u=a.reduce((d,f)=>{if(f){const p=e.groups[f];if(!p)throw new Error(`Audio track group ${f} not found`);Object.keys(p.channels).forEach(g=>{d[g]=(d[g]||0)+p.channels[g]})}return d},{2:0})}catch{return!0}return s.videoCodec!==void 0&&(s.width>1920&&s.height>1088||s.height>1920&&s.width>1088||s.frameRate>Math.max(i,30)||s.videoRange!=="SDR"&&s.videoRange!==t||s.bitrate>Math.max(n,8e6))||!!u&&K(c)&&Object.keys(u).some(d=>parseInt(d)>c)}function cg(s,e,t){const i=s.videoCodec,n=s.audioCodec;if(!i&&!n||!t)return Promise.resolve(uu);const r=[];if(i){const a={width:s.width,height:s.height,bitrate:Math.ceil(Math.max(s.bitrate*.9,s.averageBitrate)),framerate:s.frameRate||30},o=s.videoRange;o!=="SDR"&&(a.transferFunction=o.toLowerCase());const l=i.split(","),c=navigator.userAgent;if(l.some(u=>js(u))&&ru())return Promise.resolve(og(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: (${c})`),r));r.push.apply(r,l.map(u=>({type:"media-source",video:xe(xe({},a),{},{contentType:Lr(ag(u),"video")})})))}return n&&s.audioGroups&&s.audioGroups.forEach(a=>{var o;a&&((o=e.groups[a])==null||o.tracks.forEach(l=>{if(l.groupId===a){const c=l.channels||"",u=parseFloat(c);K(u)&&u>2&&r.push.apply(r,n.split(",").map(d=>({type:"media-source",audio:{contentType:Lr(d,"audio"),channels:""+u}})))}}))}),Promise.all(r.map(a=>{const o=ug(a);return du[o]||(du[o]=t.decodingInfo(a))})).then(a=>({supported:!a.some(o=>!o.supported),configurations:r,decodingInfoResults:a})).catch(a=>({supported:!1,configurations:r,decodingInfoResults:[],error:a}))}function ug(s){const{audio:e,video:t}=s,i=t||e;if(i){const n=cu(i.contentType);if(t)return`r${t.height}x${t.width}f${Math.ceil(t.framerate)}${t.transferFunction||"sd"}_${n}_${Math.ceil(t.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${n}`}return""}const hu=["NONE","TYPE-0","TYPE-1",null],dg=["SDR","PQ","HLG"];var Gs={No:"",Yes:"YES",v2:"v2"};function fu(s){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=s,n=i<e/2;return e&&n?t?Gs.v2:Gs.Yes:Gs.No}class pu{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Vs{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return gu(this._audioGroups,e)}hasSubtitleGroup(e){return gu(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function gu(s,e){return!e||!s?!1:s.indexOf(e)!==-1}function hg(){if(typeof matchMedia=="function"){const s=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(s.media!==e.media)return s.matches===!0}return!1}function fg(s,e){let t=!1,i=[];if(s&&(t=s!=="SDR",i=[s]),e){i=e.allowedVideoRanges||dg.slice(0);const n=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:n&&hg(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}const pg=s=>{const e=new WeakSet;return(t,i)=>{if(s&&(i=s(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},Le=(s,e)=>JSON.stringify(s,pg(e));function gg(s,e,t,i,n){const r=Object.keys(s),a=i==null?void 0:i.channels,o=i==null?void 0:i.audioCodec,l=n==null?void 0:n.videoCodec,c=a&&parseInt(a)===2;let u=!1,d=!1,f=1/0,p=1/0,g=1/0,y=1/0,S=0,T=[];const{preferHDR:L,allowedVideoRanges:w}=fg(e,n);for(let k=r.length;k--;){const D=s[r[k]];u||(u=D.channels[2]>0),f=Math.min(f,D.minHeight),p=Math.min(p,D.minFramerate),g=Math.min(g,D.minBitrate),w.filter(N=>D.videoRanges[N]>0).length>0&&(d=!0)}f=K(f)?f:0,p=K(p)?p:0;const x=Math.max(1080,f),b=Math.max(30,p);g=K(g)?g:t,t=Math.max(g,t),d||(e=void 0);const C=r.length>1;return{codecSet:r.reduce((k,D)=>{const R=s[D];if(D===k)return k;if(T=d?w.filter(N=>R.videoRanges[N]>0):[],C){if(R.minBitrate>t)return yt(D,`min bitrate of ${R.minBitrate} > current estimate of ${t}`),k;if(!R.hasDefaultAudio)return yt(D,"no renditions with default or auto-select sound found"),k;if(o&&D.indexOf(o.substring(0,4))%5!==0)return yt(D,`audio codec preference "${o}" not found`),k;if(a&&!c){if(!R.channels[a])return yt(D,`no renditions with ${a} channel sound found (channels options: ${Object.keys(R.channels)})`),k}else if((!o||c)&&u&&R.channels[2]===0)return yt(D,"no renditions with stereo sound found"),k;if(R.minHeight>x)return yt(D,`min resolution of ${R.minHeight} > maximum of ${x}`),k;if(R.minFramerate>b)return yt(D,`min framerate of ${R.minFramerate} > maximum of ${b}`),k;if(!T.some(N=>R.videoRanges[N]>0))return yt(D,`no variants with VIDEO-RANGE of ${Le(T)} found`),k;if(l&&D.indexOf(l.substring(0,4))%5!==0)return yt(D,`video codec preference "${l}" not found`),k;if(R.maxScore<S)return yt(D,`max score of ${R.maxScore} < selected max of ${S}`),k}return k&&(ou(D)>=ou(k)||R.fragmentError>s[k].fragmentError)?k:(y=R.minIndex,S=R.maxScore,D)},void 0),videoRanges:T,preferHDR:L,minFramerate:p,minBitrate:g,minIndex:y}}function yt(s,e){ye.log(`[abr] start candidates with "${s}" ignored because ${e}`)}function mg(s){return s.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const n=t.channels||"2";return i.channels[n]=(i.channels[n]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function yg(s,e,t,i){return s.slice(t,i+1).reduce((n,r,a)=>{if(!r.codecSet)return n;const o=r.audioGroups;let l=n[r.codecSet];l||(n[r.codecSet]=l={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:a,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!o,fragmentError:0}),l.minBitrate=Math.min(l.minBitrate,r.bitrate);const c=Math.min(r.height,r.width);return l.minHeight=Math.min(l.minHeight,c),l.minFramerate=Math.min(l.minFramerate,r.frameRate),l.minIndex=Math.min(l.minIndex,a),l.maxScore=Math.max(l.maxScore,r.score),l.fragmentError+=r.fragmentError,l.videoRanges[r.videoRange]=(l.videoRanges[r.videoRange]||0)+1,o&&o.forEach(u=>{if(!u)return;const d=e.groups[u];d&&(l.hasDefaultAudio=l.hasDefaultAudio||e.hasDefaultAudio?d.hasDefault:d.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(d.channels).forEach(f=>{l.channels[f]=(l.channels[f]||0)+d.channels[f]}))}),n},{})}function mu(s){if(!s)return s;const{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:r}=s;return{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:r}}function vt(s,e,t){if("attrs"in s){const i=e.indexOf(s);if(i!==-1)return i}for(let i=0;i<e.length;i++){const n=e[i];if(oi(s,n,t))return i}return-1}function oi(s,e,t){const{groupId:i,name:n,lang:r,assocLang:a,default:o}=s,l=s.forced;return(i===void 0||e.groupId===i)&&(n===void 0||e.name===n)&&(r===void 0||vg(r,e.lang))&&(r===void 0||e.assocLang===a)&&(o===void 0||e.default===o)&&(l===void 0||e.forced===l)&&(!("characteristics"in s)||Sg(s.characteristics||"",e.characteristics))&&(t===void 0||t(s,e))}function vg(s,e="--"){return s.length===e.length?s===e:s.startsWith(e)||e.startsWith(s)}function Sg(s,e=""){const t=s.split(","),i=e.split(",");return t.length===i.length&&!t.some(n=>i.indexOf(n)===-1)}function li(s,e){const{audioCodec:t,channels:i}=s;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function Eg(s,e,t,i,n){const r=e[i],o=e.reduce((f,p,g)=>{const y=p.uri;return(f[y]||(f[y]=[])).push(g),f},{})[r.uri];o.length>1&&(i=Math.max.apply(Math,o));const l=r.videoRange,c=r.frameRate,u=r.codecSet.substring(0,4),d=yu(e,i,f=>{if(f.videoRange!==l||f.frameRate!==c||f.codecSet.substring(0,4)!==u)return!1;const p=f.audioGroups,g=t.filter(y=>!p||p.indexOf(y.groupId)!==-1);return vt(s,g,n)>-1});return d>-1?d:yu(e,i,f=>{const p=f.audioGroups,g=t.filter(y=>!p||p.indexOf(y.groupId)!==-1);return vt(s,g,n)>-1})}function yu(s,e,t){for(let i=e;i>-1;i--)if(t(s[i]))return i;for(let i=e+1;i<s.length;i++)if(t(s[i]))return i;return-1}function vu(s,e){var t;return!!s&&s!==((t=e.loadLevelObj)==null?void 0:t.uri)}class Tg extends Rt{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;const{fragCurrent:n,partCurrent:r,hls:a}=this,{autoLevelEnabled:o,media:l}=a;if(!n||!l)return;const c=performance.now(),u=r?r.stats:n.stats,d=r?r.duration:n.duration,f=c-u.loading.start,p=a.minAutoLevel,g=n.level,y=this._nextAutoLevel;if(u.aborted||u.loaded&&u.loaded===u.total||g<=p){this.clearTimer(),this._nextAutoLevel=-1;return}if(!o)return;const S=y>-1&&y!==g,T=!!t||S;if(!T&&(l.paused||!l.playbackRate||!l.readyState))return;const L=a.mainForwardBufferInfo;if(!T&&L===null)return;const w=this.bwEstimator.getEstimateTTFB(),x=Math.abs(l.playbackRate);if(f<=Math.max(w,1e3*(d/(x*2))))return;const b=L?L.len/x:0,C=u.loading.first?u.loading.first-u.loading.start:-1,_=u.loaded&&C>-1,k=this.getBwEstimate(),D=a.levels,R=D[g],N=Math.max(u.loaded,Math.round(d*(n.bitrate||R.averageBitrate)/8));let G=_?f-C:f;G<1&&_&&(G=Math.min(f,u.loaded*8/k));const ce=_?u.loaded*1e3/G:0,J=w/1e3,ae=ce?(N-u.loaded)/ce:N*8/k+J;if(ae<=b)return;const se=ce?ce*8:k,q=((i=(t==null?void 0:t.details)||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,fe=this.hls.config.abrBandWidthUpFactor;let j=Number.POSITIVE_INFINITY,B;for(B=g-1;B>p;B--){const h=D[B].maxBitrate,v=!D[B].details||q;if(j=this.getTimeToLoadFrag(J,se,d*h,v),j<Math.min(b,d+J))break}if(j>=ae||j>d*10)return;_?this.bwEstimator.sample(f-Math.min(w,C),u.loaded):this.bwEstimator.sampleTTFB(f);const ee=D[B].maxBitrate;this.getBwEstimate()*fe>ee&&this.resetEstimator(ee);const Q=this.findBestLevel(ee,p,B,0,b,1,1);Q>-1&&(B=Q),this.warn(`Fragment ${n.sn}${r?" part "+r.index:""} of level ${g} is loading too slowly;
      Fragment duration: ${n.duration.toFixed(3)}
      Time to underbuffer: ${b.toFixed(3)} s
      Estimated load time for current fragment: ${ae.toFixed(3)} s
      Estimated load time for down switch fragment: ${j.toFixed(3)} s
      TTFB estimate: ${C|0} ms
      Current BW estimate: ${K(k)?k|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${B} @ ${ee|0} bps`),a.nextLoadLevel=a.nextAutoLevel=B,this.clearTimer();const z=()=>{if(this.clearTimer(),this.fragCurrent===n&&this.hls.loadLevel===B&&B>0){const h=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${B>0?"and switching down":""}
      Fragment duration: ${n.duration.toFixed(3)} s
      Time to underbuffer: ${h.toFixed(3)} s`),n.abortRequests(),this.fragCurrent=this.partCurrent=null,B>p){let v=this.findBestLevel(this.hls.levels[p].bitrate,p,B,0,h,1,1);v===-1&&(v=p),this.hls.nextLoadLevel=this.hls.nextAutoLevel=v,this.resetEstimator(this.hls.levels[v].bitrate)}}};S||ae>j*2?z():this.timer=self.setInterval(z,j*1e3),a.trigger(E.FRAG_LOAD_EMERGENCY_ABORTED,{frag:n,part:r,stats:u})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new kp(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.FRAG_LOADING,this.onFragLoading,this),e.on(E.FRAG_LOADED,this.onFragLoaded,this),e.on(E.FRAG_BUFFERED,this.onFragBuffered,this),e.on(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(E.LEVEL_LOADED,this.onLevelLoaded,this),e.on(E.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(E.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.FRAG_LOADING,this.onFragLoading,this),e.off(E.FRAG_LOADED,this.onFragLoaded,this),e.off(E.FRAG_BUFFERED,this.onFragBuffered,this),e.off(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(E.LEVEL_LOADED,this.onLevelLoaded,this),e.off(E.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(E.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(E.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var n;this.fragCurrent=i,this.partCurrent=(n=t.part)!=null?n:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case M.BUFFER_ADD_CODEC_ERROR:case M.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case M.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:n,partCurrent:r}=this;if(i&&n&&i.sn===n.sn&&i.level===n.level){const a=performance.now(),o=r?r.stats:i.stats,l=a-o.loading.start,c=o.loading.first?o.loading.first-o.loading.start:-1;if(o.loaded&&c>-1){const d=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(d,c),o.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(e,t,i,n){const r=e+i/t,a=n?e+this.lastLevelLoadSec:0;return r+a}onLevelLoaded(e,t){const i=this.hls.config,{loading:n}=t.stats,r=n.end-n.first;K(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const n=i?i.stats:t.stats;if(t.type===re.MAIN&&this.bwEstimator.sampleTTFB(n.loading.first-n.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,a=this.hls.levels[t.level],o=(a.loaded?a.loaded.bytes:0)+n.loaded,l=(a.loaded?a.loaded.duration:0)+r;a.loaded={bytes:o,duration:l},a.realBitrate=Math.round(8*o/l)}if(t.bitrateTest){const r={stats:n,frag:t,part:i,id:t.type};this.onFragBuffered(E.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:n}=t,r=n!=null&&n.stats.loaded?n.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const a=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==re.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),n=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,n,1,1);if(r>-1)return r;const a=this.hls.firstLevel,o=Math.min(Math.max(a,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!n||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const r=i&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const a=this.hls.levels;if(a.length>Math.max(e,r)&&a[e].loadError<=a[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:n,config:r,minAutoLevel:a}=i,o=t?t.duration:e?e.duration:0,l=this.getBwEstimate(),c=this.getStarvationDelay();let u=r.abrBandWidthFactor,d=r.abrBandWidthUpFactor;if(c){const S=this.findBestLevel(l,a,n,c,0,u,d);if(S>=0)return this.rebufferNotice=-1,S}let f=o?Math.min(o,r.maxStarvationDelay):r.maxStarvationDelay;if(!c){const S=this.bitrateTestDelay;S&&(f=(o?Math.min(o,r.maxLoadingDelay):r.maxLoadingDelay)-S,this.info(`bitrate test took ${Math.round(1e3*S)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),u=d=1)}const p=this.findBestLevel(l,a,n,c,f,u,d);if(this.rebufferNotice!==p&&(this.rebufferNotice=p,this.info(`${c?"rebuffering expected":"buffer is empty"}, optimal quality level ${p}`)),p>-1)return p;const g=i.levels[a],y=i.loadLevelObj;return y&&(g==null?void 0:g.bitrate)<y.bitrate?a:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,n=e.mainForwardBufferInfo;return(n?n.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,n,r,a,o){var l;const c=n+r,u=this.lastLoadedFragLevel,d=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:p}=this,{levels:g,allAudioTracks:y,loadLevel:S,config:T}=this.hls;if(g.length===1)return 0;const L=g[d],w=!!((l=this.hls.latestLevelDetails)!=null&&l.live),x=S===-1||u===-1;let b,C="SDR",_=(L==null?void 0:L.frameRate)||0;const{audioPreference:k,videoPreference:D}=T,R=this.audioTracksByGroup||(this.audioTracksByGroup=mg(y));let N=-1;if(x){if(this.firstSelection!==-1)return this.firstSelection;const se=this.codecTiers||(this.codecTiers=yg(g,R,t,i)),q=gg(se,C,e,k,D),{codecSet:fe,videoRanges:j,minFramerate:B,minBitrate:ee,minIndex:Q,preferHDR:z}=q;N=Q,b=fe,C=z?j[j.length-1]:j[0],_=B,e=Math.max(e,ee),this.log(`picked start tier ${Le(q)}`)}else b=L==null?void 0:L.codecSet,C=L==null?void 0:L.videoRange;const G=p?p.duration:f?f.duration:0,ce=this.bwEstimator.getEstimateTTFB()/1e3,J=[];for(let se=i;se>=t;se--){var ae;const q=g[se],fe=se>d;if(!q)continue;if(T.useMediaCapabilities&&!q.supportedResult&&!q.supportedPromise){const v=navigator.mediaCapabilities;typeof(v==null?void 0:v.decodingInfo)=="function"&&(lg(q,R,C,_,e,k)||js(q.videoCodec))?(q.supportedPromise=cg(q,R,v),q.supportedPromise.then(m=>{if(!this.hls)return;q.supportedResult=m;const I=this.hls.levels,A=I.indexOf(q);m.error?this.warn(`MediaCapabilities decodingInfo error: "${m.error}" for level ${A} ${Le(m)}`):m.supported||(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${A} ${Le(m)}`),A>-1&&I.length>1&&(this.log(`Removing unsupported level ${A}`),this.hls.removeLevel(A),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))})):q.supportedResult=uu}if((b&&q.codecSet!==b||C&&q.videoRange!==C||fe&&_>q.frameRate||!fe&&_>0&&_<q.frameRate||q.supportedResult&&!((ae=q.supportedResult.decodingInfoResults)!=null&&ae[0].smooth))&&(!x||se!==N)){J.push(se);continue}const j=q.details,B=(p?j==null?void 0:j.partTarget:j==null?void 0:j.averagetargetduration)||G;let ee;fe?ee=o*e:ee=a*e;const Q=G&&n>=G*2&&r===0?q.averageBitrate:q.maxBitrate,z=this.getTimeToLoadFrag(ce,ee,Q*B,j===void 0);if(ee>=Q&&(se===u||q.loadError===0&&q.fragmentError===0)&&(z<=ce||!K(z)||w&&!this.bitrateTestDelay||z<c)){const v=this.forcedAutoLevel;return se!==S&&(v===-1||v!==S)&&(J.length&&this.trace(`Skipped level(s) ${J.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${g[J[0]].codecs}" ${g[J[0]].videoRange}; not compatible with "${b}" ${C}`),this.info(`switch candidate:${d}->${se} adjustedbw(${Math.round(ee)})-bitrate=${Math.round(ee-Q)} ttfb:${ce.toFixed(1)} avgDuration:${B.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${z.toFixed(1)} firstSelection:${x} codecSet:${q.codecSet} videoRange:${q.videoRange} hls.loadLevel:${S}`)),x&&(this.firstSelection=se),se}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}}const Pr={search:function(s,e){let t=0,i=s.length-1,n=null,r=null;for(;t<=i;){n=(t+i)/2|0,r=s[n];const a=e(r);if(a>0)t=n+1;else if(a<0)i=n-1;else return r}return null}};function bg(s,e,t){if(e===null||!Array.isArray(s)||!s.length||!K(e))return null;const i=s[0].programDateTime;if(e<(i||0))return null;const n=s[s.length-1].endProgramDateTime;if(e>=(n||0))return null;t=t||0;for(let r=0;r<s.length;++r){const a=s[r];if(xg(e,t,a))return a}return null}function Ti(s,e,t=0,i=0,n=.005){let r=null;if(s){r=e[1+s.sn-e[0].sn]||null;const o=s.endDTS-t;o>0&&o<15e-7&&(t+=15e-7),r&&s.level!==r.level&&r.end<=s.end&&(r=e[2+s.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(r=e[0]);if(r&&((!s||s.level===r.level)&&Su(t,i,r)===0||_g(r,s,Math.min(n,i))))return r;const a=Pr.search(e,Su.bind(null,t,i));return a&&(a!==s||!r)?a:r}function _g(s,e,t){if(e&&e.start===0&&e.level<s.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((n,r)=>(r[0]==="INF"&&(n+=parseFloat(r[1])),n),t);return s.start<=i}return!1}function Su(s=0,e=0,t){if(t.start<=s&&t.start+t.duration>s)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=s?1:t.start-i>s&&t.start?-1:0}function xg(s,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>s}function Eu(s,e){return Pr.search(s,t=>t.cc<e?1:t.cc>e?-1:0)}function Ag(s,e,t){if(s&&s.startCC<=e&&s.endCC>=e){const i=t.start,n=t.end;let r=s.fragments;if(!t.relurl){const{fragmentHint:a}=s;a&&(r=r.concat(a))}return Pr.search(r,a=>a.cc<e||a.end<=i?1:a.cc>e||a.start>=n?-1:0)}return null}function qs(s){switch(s.details){case M.FRAG_LOAD_TIMEOUT:case M.KEY_LOAD_TIMEOUT:case M.LEVEL_LOAD_TIMEOUT:case M.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Tu(s,e){const t=qs(e);return s.default[`${t?"timeout":"error"}Retry`]}function Dr(s,e){const t=s.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*s.retryDelayMs,s.maxRetryDelayMs)}function bu(s){return xe(xe({},s),{errorRetry:null,timeoutRetry:null})}function Hs(s,e,t,i){if(!s)return!1;const n=i==null?void 0:i.code,r=e<s.maxNumRetry&&(Ig(n)||!!t);return s.shouldRetry?s.shouldRetry(s,e,t,i,r):r}function Ig(s){return s===0&&navigator.onLine===!1||!!s&&(s<400||s>499)}var Ne={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},ct={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2};class wg extends Rt{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(E.ERROR,this.onError,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(E.ERROR,this.onError,this),e.off(E.ERROR,this.onErrorOut,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===re.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const n=this.hls,r=t.context;switch(t.details){case M.FRAG_LOAD_ERROR:case M.FRAG_LOAD_TIMEOUT:case M.KEY_LOAD_ERROR:case M.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case M.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=qi();return}case M.FRAG_GAP:case M.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=Ne.SendAlternateToPenaltyBox;return}case M.LEVEL_EMPTY_ERROR:case M.LEVEL_PARSING_ERROR:{var a,o;const c=t.parent===re.MAIN?t.level:n.loadLevel;t.details===M.LEVEL_EMPTY_ERROR&&((a=t.context)!=null&&(o=a.levelDetails)!=null&&o.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,c):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,c))}return;case M.LEVEL_LOAD_ERROR:case M.LEVEL_LOAD_TIMEOUT:typeof(r==null?void 0:r.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.level));return;case M.AUDIO_TRACK_LOAD_ERROR:case M.AUDIO_TRACK_LOAD_TIMEOUT:case M.SUBTITLE_LOAD_ERROR:case M.SUBTITLE_TRACK_LOAD_TIMEOUT:if(r){const c=n.loadLevelObj;if(c&&(r.type===Ct.AUDIO_TRACK&&c.hasAudioGroup(r.groupId)||r.type===Ct.SUBTITLE_TRACK&&c.hasSubtitleGroup(r.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.loadLevel),t.errorAction.action=Ne.SendAlternateToPenaltyBox,t.errorAction.flags=ct.MoveAllAlternatesMatchingHost;return}}return;case M.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const c=n.loadLevelObj,u=c==null?void 0:c.attrs["HDCP-LEVEL"];u?t.errorAction={action:Ne.SendAlternateToPenaltyBox,flags:ct.MoveAllAlternatesMatchingHDCP,hdcpLevel:u}:this.keySystemError(t)}return;case M.BUFFER_ADD_CODEC_ERROR:case M.REMUX_ALLOC_ERROR:case M.BUFFER_APPEND_ERROR:if(!t.errorAction){var l;t.errorAction=this.getLevelSwitchAction(t,(l=t.level)!=null?l:n.loadLevel)}return;case M.INTERNAL_EXCEPTION:case M.BUFFER_APPENDING_ERROR:case M.BUFFER_FULL_ERROR:case M.LEVEL_SWITCH_ERROR:case M.BUFFER_STALLED_ERROR:case M.BUFFER_SEEK_OVER_HOLE:case M.BUFFER_NUDGE_ON_STALL:t.errorAction=qi();return}t.type===Z.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,n=Tu(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(Hs(n,r,qs(e),e.response))return{action:Ne.RetryRequest,flags:ct.None,retryConfig:n,retryCount:r};const o=this.getLevelSwitchAction(e,t);return n&&(o.retryConfig=n,o.retryCount=r),o}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),n=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:a}=t.config,o=Tu(e.details.startsWith("key")?a:r,e),l=t.levels.reduce((u,d)=>u+d.fragmentError,0);if(n&&(e.details!==M.FRAG_GAP&&n.fragmentError++,Hs(o,l,qs(e),e.response)))return{action:Ne.RetryRequest,flags:ct.None,retryConfig:o,retryCount:l};const c=this.getLevelSwitchAction(e,i);return o&&(c.retryConfig=o,c.retryCount=l),c}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const n=this.hls.levels[t];if(n){var r,a;const c=e.details;n.loadError++,c===M.BUFFER_APPEND_ERROR&&n.fragmentError++;let u=-1;const{levels:d,loadLevel:f,minAutoLevel:p,maxAutoLevel:g}=i;i.autoLevelEnabled||(i.loadLevel=-1);const y=(r=e.frag)==null?void 0:r.type,T=(y===re.AUDIO&&c===M.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(c===M.BUFFER_ADD_CODEC_ERROR||c===M.BUFFER_APPEND_ERROR))&&d.some(({audioCodec:C})=>n.audioCodec!==C),w=e.sourceBufferName==="video"&&(c===M.BUFFER_ADD_CODEC_ERROR||c===M.BUFFER_APPEND_ERROR)&&d.some(({codecSet:C,audioCodec:_})=>n.codecSet!==C&&n.audioCodec===_),{type:x,groupId:b}=(a=e.context)!=null?a:{};for(let C=d.length;C--;){const _=(C+f)%d.length;if(_!==f&&_>=p&&_<=g&&d[_].loadError===0){var o,l;const k=d[_];if(c===M.FRAG_GAP&&y===re.MAIN&&e.frag){const D=d[_].details;if(D){const R=Ti(e.frag,D.fragments,e.frag.start);if(R!=null&&R.gap)continue}}else{if(x===Ct.AUDIO_TRACK&&k.hasAudioGroup(b)||x===Ct.SUBTITLE_TRACK&&k.hasSubtitleGroup(b))continue;if(y===re.AUDIO&&(o=n.audioGroups)!=null&&o.some(D=>k.hasAudioGroup(D))||y===re.SUBTITLE&&(l=n.subtitleGroups)!=null&&l.some(D=>k.hasSubtitleGroup(D))||T&&n.audioCodec===k.audioCodec||!T&&n.audioCodec!==k.audioCodec||w&&n.codecSet===k.codecSet)continue}u=_;break}}if(u>-1&&i.loadLevel!==u)return e.levelRetry=!0,this.playlistError=0,{action:Ne.SendAlternateToPenaltyBox,flags:ct.None,nextAutoLevel:u}}return{action:Ne.SendAlternateToPenaltyBox,flags:ct.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case Ne.DoNothing:break;case Ne.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==M.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:n,hdcpLevel:r,nextAutoLevel:a}=i;switch(n){case ct.None:this.switchLevel(e,a);break;case ct.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=hu[hu.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,a)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===M.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const i=cu(e.mimeType),n=this.hls.levels;for(let r=n.length;r--;)n[r][`${e.sourceBufferName}Codec`]===i&&this.hls.removeLevel(r)}}}function qi(s){const e={action:Ne.DoNothing,flags:ct.None};return s&&(e.resolved=!0),e}var Xe={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"},Gt={cbc:0,ctr:1};class Lg{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case Gt.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case Gt.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function kg(s){const e=s.byteLength,t=e&&new DataView(s.buffer).getUint8(e-1);return t?s.slice(0,e-t):s}class Cg{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let n=0;n<4;n++)i[n]=t.getUint32(n*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,n=i[0],r=i[1],a=i[2],o=i[3],l=this.invSubMix,c=l[0],u=l[1],d=l[2],f=l[3],p=new Uint32Array(256);let g=0,y=0,S=0;for(S=0;S<256;S++)S<128?p[S]=S<<1:p[S]=S<<1^283;for(S=0;S<256;S++){let T=y^y<<1^y<<2^y<<3^y<<4;T=T>>>8^T&255^99,e[g]=T,t[T]=g;const L=p[g],w=p[L],x=p[w];let b=p[T]*257^T*16843008;n[g]=b<<24|b>>>8,r[g]=b<<16|b>>>16,a[g]=b<<8|b>>>24,o[g]=b,b=x*16843009^w*65537^L*257^g*16843008,c[T]=b<<24|b>>>8,u[T]=b<<16|b>>>16,d[T]=b<<8|b>>>24,f[T]=b,g?(g=L^p[p[p[x^L]]],y^=p[p[y]]):g=y=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,n=0;for(;n<t.length&&i;)i=t[n]===this.key[n],n++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const a=this.ksRows=(r+6+1)*4;let o,l;const c=this.keySchedule=new Uint32Array(a),u=this.invKeySchedule=new Uint32Array(a),d=this.sBox,f=this.rcon,p=this.invSubMix,g=p[0],y=p[1],S=p[2],T=p[3];let L,w;for(o=0;o<a;o++){if(o<r){L=c[o]=t[o];continue}w=L,o%r===0?(w=w<<8|w>>>24,w=d[w>>>24]<<24|d[w>>>16&255]<<16|d[w>>>8&255]<<8|d[w&255],w^=f[o/r|0]<<24):r>6&&o%r===4&&(w=d[w>>>24]<<24|d[w>>>16&255]<<16|d[w>>>8&255]<<8|d[w&255]),c[o]=L=(c[o-r]^w)>>>0}for(l=0;l<a;l++)o=a-l,l&3?w=c[o]:w=c[o-4],l<4||o<=4?u[l]=w:u[l]=g[d[w>>>24]]^y[d[w>>>16&255]]^S[d[w>>>8&255]]^T[d[w&255]],u[l]=u[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const n=this.keySize+6,r=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,l=o[0],c=o[1],u=o[2],d=o[3],f=this.uint8ArrayToUint32Array_(i);let p=f[0],g=f[1],y=f[2],S=f[3];const T=new Int32Array(e),L=new Int32Array(T.length);let w,x,b,C,_,k,D,R,N,G,ce,J,ae,se;const q=this.networkToHostOrderSwap;for(;t<T.length;){for(N=q(T[t]),G=q(T[t+1]),ce=q(T[t+2]),J=q(T[t+3]),_=N^r[0],k=J^r[1],D=ce^r[2],R=G^r[3],ae=4,se=1;se<n;se++)w=l[_>>>24]^c[k>>16&255]^u[D>>8&255]^d[R&255]^r[ae],x=l[k>>>24]^c[D>>16&255]^u[R>>8&255]^d[_&255]^r[ae+1],b=l[D>>>24]^c[R>>16&255]^u[_>>8&255]^d[k&255]^r[ae+2],C=l[R>>>24]^c[_>>16&255]^u[k>>8&255]^d[D&255]^r[ae+3],_=w,k=x,D=b,R=C,ae=ae+4;w=a[_>>>24]<<24^a[k>>16&255]<<16^a[D>>8&255]<<8^a[R&255]^r[ae],x=a[k>>>24]<<24^a[D>>16&255]<<16^a[R>>8&255]<<8^a[_&255]^r[ae+1],b=a[D>>>24]<<24^a[R>>16&255]<<16^a[_>>8&255]<<8^a[k&255]^r[ae+2],C=a[R>>>24]<<24^a[_>>16&255]<<16^a[k>>8&255]<<8^a[D&255]^r[ae+3],L[t]=q(w^p),L[t+1]=q(C^g),L[t+2]=q(b^y),L[t+3]=q(x^S),p=N,g=G,y=ce,S=J,t=t+4}return L.buffer}}class Rg{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=Pg(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function Pg(s){switch(s){case Gt.cbc:return"AES-CBC";case Gt.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${s}`)}}const Dg=16;class Or{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?kg(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,n){return this.useSoftware?new Promise((r,a)=>{const o=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(o,t,i,n);const l=this.flush();l?r(l.buffer):a(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,n)}softwareDecrypt(e,t,i,n){const{currentIV:r,currentResult:a,remainderData:o}=this;if(n!==Gt.cbc||t.byteLength!==16)return ye.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),o&&(e=Qe(o,e),this.remainderData=null);const l=this.getValidChunk(e);if(!l.length)return null;r&&(i=r);let c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new Cg),c.expandKey(t);const u=a;return this.currentResult=c.decrypt(l.buffer,0,i),this.currentIV=l.slice(-16).buffer,u||null}webCryptoDecrypt(e,t,i,n){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,n));this.key=t,this.fastAesKey=new Rg(this.subtle,t,n)}return this.fastAesKey.expandKey().then(r=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new Lg(this.subtle,new Uint8Array(i),n).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(ye.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i,n)))}onWebCryptoError(e,t,i,n){const r=this.enableSoftwareAES;if(r){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,n);const a=this.flush();if(a)return a.buffer}throw new Error("WebCrypto"+(r?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%Dg;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(ye.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const _u=Math.pow(2,17);class Og{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new Vt({type:Z.NETWORK_ERROR,details:M.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const n=this.config,r=n.fLoader,a=n.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(g=>g[0]==="GAP")){l(Au(e));return}else e.gap=!1;const c=this.loader=r?new r(n):new a(n),u=xu(e);e.loader=c;const d=bu(n.fragLoadPolicy.default),f={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:_u};e.stats=c.stats;const p={onSuccess:(g,y,S,T)=>{this.resetLoader(e,c);let L=g.data;S.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(L.slice(0,16)),L=L.slice(16)),o({frag:e,part:null,payload:L,networkDetails:T})},onError:(g,y,S,T)=>{this.resetLoader(e,c),l(new Vt({type:Z.NETWORK_ERROR,details:M.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:xe({url:i,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:S,stats:T}))},onAbort:(g,y,S)=>{this.resetLoader(e,c),l(new Vt({type:Z.NETWORK_ERROR,details:M.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:S,stats:g}))},onTimeout:(g,y,S)=>{this.resetLoader(e,c),l(new Vt({type:Z.NETWORK_ERROR,details:M.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:S,stats:g}))}};t&&(p.onProgress=(g,y,S,T)=>t({frag:e,part:null,payload:S,networkDetails:T})),c.load(u,f,p)})}loadPart(e,t,i){this.abort();const n=this.config,r=n.fLoader,a=n.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(Au(e,t));return}const c=this.loader=r?new r(n):new a(n),u=xu(e,t);e.loader=c;const d=bu(n.fragLoadPolicy.default),f={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:_u};t.stats=c.stats,c.load(u,f,{onSuccess:(p,g,y,S)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const T={frag:e,part:t,payload:p.data,networkDetails:S};i(T),o(T)},onError:(p,g,y,S)=>{this.resetLoader(e,c),l(new Vt({type:Z.NETWORK_ERROR,details:M.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:xe({url:u.url,data:void 0},p),error:new Error(`HTTP Error ${p.code} ${p.text}`),networkDetails:y,stats:S}))},onAbort:(p,g,y)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),l(new Vt({type:Z.NETWORK_ERROR,details:M.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:y,stats:p}))},onTimeout:(p,g,y)=>{this.resetLoader(e,c),l(new Vt({type:Z.NETWORK_ERROR,details:M.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:y,stats:p}))}})})}updateStatsFromPart(e,t){const i=e.stats,n=t.stats,r=n.total;if(i.loaded+=n.loaded,r){const l=Math.round(e.duration/t.duration),c=Math.min(Math.round(i.loaded/r),l),d=(l-c)*Math.round(i.loaded/c);i.total=i.loaded+d}else i.total=Math.max(i.loaded,i.total);const a=i.loading,o=n.loading;a.start?a.first+=o.first-o.start:(a.start=o.start,a.first=o.first),a.end=o.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function xu(s,e=null){const t=e||s,i={frag:s,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},n=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(K(n)&&K(r)){var a;let o=n,l=r;if(s.sn==="initSegment"&&Mg((a=s.decryptdata)==null?void 0:a.method)){const c=r-n;c%16&&(l=r+(16-c%16)),n!==0&&(i.resetIV=!0,o=n-16)}i.rangeStart=o,i.rangeEnd=l}return i}function Au(s,e){const t=new Error(`GAP ${s.gap?"tag":"attribute"} found`),i={type:Z.MEDIA_ERROR,details:M.FRAG_GAP,fatal:!1,frag:s,error:t,networkDetails:null};return e&&(i.part=e),(e||s).stats.aborted=!0,new Vt(i)}function Mg(s){return s==="AES-128"||s==="AES-256"}class Vt extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Fg extends Rt{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Iu{constructor(e,t,i,n=0,r=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Ks(),this.buffering={audio:Ks(),video:Ks(),audiovideo:Ks()},this.level=e,this.sn=t,this.id=i,this.size=n,this.part=r,this.partial=a}}function Ks(){return{start:0,executeStart:0,executeEnd:0,end:0}}const wu={length:0,start:()=>0,end:()=>0};class be{static isBuffered(e,t){if(e){const i=be.getBuffered(e);for(let n=i.length;n--;)if(t>=i.start(n)&&t<=i.end(n))return!0}return!1}static bufferedRanges(e){if(e){const t=be.getBuffered(e);return be.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const n=be.bufferedRanges(e);if(n.length)return be.bufferedInfo(n,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((u,d)=>u.start-d.start||d.end-u.end);let n=-1,r=[];if(i)for(let u=0;u<e.length;u++){t>=e[u].start&&t<=e[u].end&&(n=u);const d=r.length;if(d){const f=r[d-1].end;e[u].start-f<i?e[u].end>f&&(r[d-1].end=e[u].end):r.push(e[u])}else r.push(e[u])}else r=e;let a=0,o,l=t,c=t;for(let u=0;u<r.length;u++){const d=r[u].start,f=r[u].end;if(n===-1&&t>=d&&t<=f&&(n=u),t+i>=d&&t<f)l=d,c=f,a=c-t;else if(t+i<d){o=d;break}}return{len:a,start:l||0,end:c||0,nextStart:o,buffered:e,bufferedIndex:n}}static getBuffered(e){try{return e.buffered||wu}catch(t){return ye.log("failed to get media.buffered",t),wu}}}const Ng=/\{\$([a-zA-Z0-9-_]+)\}/g;function Ug(s,e){if(s.variableList!==null||s.hasVariableRefs){const t=s.variableList;return e.replace(Ng,i=>{const n=i.substring(2,i.length-1),r=t==null?void 0:t[n];return r===void 0?(s.playlistParsingError||(s.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${n}"`)),i):r})}return e}const Bg=/^(\d+)x(\d+)$/,Lu=/(.+?)=(".*?"|.*?)(?:,|$)/g;class Hi{constructor(e,t){typeof e=="string"&&(e=Hi.parseAttrList(e,t)),Ie(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let n=0;n<t.length/2;n++)i[n]=parseInt(t.slice(n*2,n*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((n,r)=>(n[r.toLowerCase()]=!0,n),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=Bg.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const n={},r='"';for(Lu.lastIndex=0;(i=Lu.exec(e))!==null;){const a=i[1].trim();let o=i[2];const l=o.indexOf(r)===0&&o.lastIndexOf(r)===o.length-1;let c=!1;if(l)o=o.slice(1,-1);else switch(a){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":c=!0}if(t&&(l||c))o=Ug(t,o);else if(!c&&!l)switch(a){case"CLOSED-CAPTIONS":if(o==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":ye.warn(`${e}: attribute ${a} is missing quotes`)}n[a]=o}return n}}const $g="com.apple.hls.interstitial";class jg{constructor(e,t,i=0){var n;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(t==null?void 0:t.tagAnchor)||null,this.tagOrder=(n=t==null?void 0:t.tagOrder)!=null?n:i,t){const r=t.attr;for(const a in r)if(Object.prototype.hasOwnProperty.call(e,a)&&e[a]!==r[a]){ye.warn(`DATERANGE tag attribute: "${a}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=a;break}e=Ie(new Hi({}),r,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const r=(t==null?void 0:t.endDate)||new Date(this.attr["END-DATE"]);K(r.getTime())&&(this._endDate=r)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(ye.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(K(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===$g}get isValid(){return!!this.id&&!this._badValueForSameId&&K(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}function bi(s){return s==="AES-128"||s==="AES-256"||s==="AES-256-CTR"}function Mr(s){switch(s){case"AES-128":case"AES-256":return Gt.cbc;case"AES-256-CTR":return Gt.ctr;default:throw new Error(`invalid full segment method ${s}`)}}function Fr(s){return Uint8Array.from(atob(s),e=>e.charCodeAt(0))}function Nr(s){return Uint8Array.from(unescape(encodeURIComponent(s)),e=>e.charCodeAt(0))}function Gg(s){const e=Nr(s).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function Vg(s){const e=function(i,n,r){const a=i[n];i[n]=i[r],i[r]=a};e(s,0,3),e(s,1,2),e(s,4,5),e(s,6,7)}function qg(s){const e=s.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),n=i[i.length-1].split(",");if(n.length===2){const r=n[0]==="base64",a=n[1];r?(i.splice(-1,1),t=Fr(a)):t=Gg(a)}}return t}const Ys=typeof self<"u"?self:void 0;var ge={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Ge={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Ur(s){switch(s){case Ge.FAIRPLAY:return ge.FAIRPLAY;case Ge.PLAYREADY:return ge.PLAYREADY;case Ge.WIDEVINE:return ge.WIDEVINE;case Ge.CLEARKEY:return ge.CLEARKEY}}var Ws={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Br(s){if(s===Ws.WIDEVINE)return ge.WIDEVINE;if(s===Ws.PLAYREADY)return ge.PLAYREADY;if(s===Ws.CENC||s===Ws.CLEARKEY)return ge.CLEARKEY}function $r(s){switch(s){case ge.FAIRPLAY:return Ge.FAIRPLAY;case ge.PLAYREADY:return Ge.PLAYREADY;case ge.WIDEVINE:return Ge.WIDEVINE;case ge.CLEARKEY:return Ge.CLEARKEY}}function zs(s){const{drmSystems:e,widevineLicenseUrl:t}=s,i=e?[ge.FAIRPLAY,ge.WIDEVINE,ge.PLAYREADY,ge.CLEARKEY].filter(n=>!!e[n]):[];return!i[ge.WIDEVINE]&&t&&i.push(ge.WIDEVINE),i}const ku=function(s){return Ys!=null&&(s=Ys.navigator)!=null&&s.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function Hg(s,e,t,i){let n;switch(s){case ge.FAIRPLAY:n=["cenc","sinf"];break;case ge.WIDEVINE:case ge.PLAYREADY:n=["cenc"];break;case ge.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${s}`)}return Kg(n,e,t,i)}function Kg(s,e,t,i){return[{initDataTypes:s,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs=${r}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs=${r}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function Yg(s){var e;return s.sessionType==="persistent-license"||!!((e=s.sessionTypes)!=null&&e.some(t=>t==="persistent-license"))}function Cu(s){const e=new Uint16Array(s.buffer,s.byteOffset,s.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),a=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(a){const o=a.childNodes[0]?a.childNodes[0].nodeValue:a.getAttribute("VALUE");if(o){const l=Fr(o).subarray(0,16);return Vg(l),l}}return null}let Js={};class Qs{static clearKeyUriToKeyIdMap(){Js={}}constructor(e,t,i,n=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=n,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!bi(e)}isSupported(){if(this.method){if(bi(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Ge.FAIRPLAY:case Ge.WIDEVINE:case Ge.PLAYREADY:case Ge.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(bi(this.method)&&this.uri&&!this.iv){typeof e!="number"&&(ye.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=Wg(e);return new Qs(this.method,this.uri,"identity",this.keyFormatVersions,i)}const t=qg(this.uri);if(t)switch(this.keyFormat){case Ge.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case Ge.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Xp(i,null,t),this.keyId=Cu(t);break}default:{let i=t.subarray(0,16);if(i.length!==16){const n=new Uint8Array(16);n.set(i,16-i.length),i=n}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=Js[this.uri];if(!i){const n=Object.keys(Js).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,n),Js[this.uri]=i}this.keyId=i}return this}}function Wg(s){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=s>>8*(15-t)&255;return e}function zg(s,e){const t=s.length,i=s[t-1],n=e.live?1/0:e.totalduration,r=Object.keys(e.dateRanges);for(let a=r.length;a--;){const o=e.dateRanges[r[a]],l=o.startDate.getTime();o.tagAnchor=i.ref;for(let c=t;c--;){const u=Jg(e,l,s,c,n);if(u!==-1){o.tagAnchor=e.fragments[u].ref;break}}}}function Jg(s,e,t,i,n){const r=t[i];if(r){const o=r.programDateTime;if(e>=o||i===0){var a;const l=(((a=t[i+1])==null?void 0:a.start)||n)-r.start;if(e<=o+l*1e3){const c=t[i].sn-s.startSN,u=s.fragments;if(u.length>t.length){const f=(t[i+1]||u[u.length-1]).sn-s.startSN;for(let p=f;p>c;p--){const g=u[p].programDateTime;if(e>=g&&e<g+u[p].duration*1e3)return p}}return c}}}return-1}function Qg(s,e,t){s.rawProgramDateTime?t.push(s):e!=null&&e.programDateTime&&(s.programDateTime=e.endProgramDateTime)}function jr(s,e){const t=e.startPTS;if(K(t)){let i=0,n;e.sn>s.sn?(i=t-s.start,n=s):(i=s.start-t,n=e),n.duration!==i&&n.setDuration(i)}else e.sn>s.sn?s.cc===e.cc&&s.minEndPTS?e.setStart(s.start+(s.minEndPTS-s.start)):e.setStart(s.start+s.duration):e.setStart(Math.max(s.start-e.duration,0))}function Ru(s,e,t,i,n,r){i-t<=0&&(ye.warn("Fragment should have a positive duration",e),i=t+e.duration,r=n+e.duration);let o=t,l=i;const c=e.startPTS,u=e.endPTS;if(K(c)){const S=Math.abs(c-t);K(e.deltaPTS)?e.deltaPTS=Math.max(S,e.deltaPTS):e.deltaPTS=S,o=Math.max(t,c),t=Math.min(t,c),n=Math.min(n,e.startDTS),l=Math.min(i,u),i=Math.max(i,u),r=Math.max(r,e.endDTS)}const d=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=o,e.startDTS=n,e.endPTS=i,e.minEndPTS=l,e.endDTS=r;const f=e.sn;if(!s||f<s.startSN||f>s.endSN)return 0;let p;const g=f-s.startSN,y=s.fragments;for(y[g]=e,p=g;p>0;p--)jr(y[p],y[p-1]);for(p=g;p<y.length-1;p++)jr(y[p],y[p+1]);return s.fragmentHint&&jr(y[y.length-1],s.fragmentHint),s.PTSKnown=s.alignedSliding=!0,d}function Xg(s,e){if(s===e)return;let t=null;const i=s.fragments;for(let l=i.length-1;l>=0;l--){const c=i[l].initSegment;if(c){t=c;break}}s.fragmentHint&&delete s.fragmentHint.endPTS;let n;tm(s,e,(l,c,u,d)=>{if(!e.startCC&&c.cc!==l.cc){var f,p;const g=l.cc-c.cc;for(let y=u;y<d.length;y++)d[y].cc+=g;e.startCC=(f=(p=Ou(s,e.startSN-1))==null?void 0:p.cc)!=null?f:d[0].cc,e.endCC=d[d.length-1].cc}K(l.startPTS)&&K(l.endPTS)&&(c.setStart(c.startPTS=l.startPTS),c.startDTS=l.startDTS,c.maxStartPTS=l.maxStartPTS,c.endPTS=l.endPTS,c.endDTS=l.endDTS,c.minEndPTS=l.minEndPTS,c.setDuration(l.endPTS-l.startPTS),c.duration&&(n=c),e.PTSKnown=e.alignedSliding=!0),l.hasStreams&&(c.elementaryStreams=l.elementaryStreams),c.loader=l.loader,l.hasStats&&(c.stats=l.stats),l.initSegment&&(c.initSegment=l.initSegment,t=l.initSegment)});const r=e.fragments,a=e.fragmentHint?r.concat(e.fragmentHint):r;if(t&&a.forEach(l=>{var c;l&&(!l.initSegment||l.initSegment.relurl===((c=t)==null?void 0:c.relurl))&&(l.initSegment=t)}),e.skippedSegments)if(e.deltaUpdateFailed=r.some(l=>!l),e.deltaUpdateFailed){ye.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=e.skippedSegments;l--;)r.shift();e.startSN=r[0].sn}else{e.endCC=r[r.length-1].cc,e.canSkipDateRanges&&(e.dateRanges=Zg(s.dateRanges,e));const l=s.fragments.filter(c=>c.rawProgramDateTime);if(s.hasProgramDateTime&&!e.hasProgramDateTime)for(let c=1;c<a.length;c++)a[c].programDateTime===null&&Qg(a[c],a[c-1],l);zg(l,e)}em(s.partList,e.partList,(l,c)=>{c.elementaryStreams=l.elementaryStreams,c.stats=l.stats}),n?Ru(e,n,n.startPTS,n.endPTS,n.startDTS,n.endDTS):Du(s,e),r.length&&(e.totalduration=e.edge-r[0].start),e.driftStartTime=s.driftStartTime,e.driftStart=s.driftStart;const o=e.advancedDateTime;if(e.advanced&&o){const l=e.edge;e.driftStart||(e.driftStartTime=o,e.driftStart=l),e.driftEndTime=o,e.driftEnd=l}else e.driftEndTime=s.driftEndTime,e.driftEnd=s.driftEnd,e.advancedDateTime=s.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=s.requestScheduled)}function Zg(s,e){const{dateRanges:t,recentlyRemovedDateranges:i}=e,n=Ie({},s);i&&i.forEach(o=>{delete n[o]});const a=Object.keys(n).length;return a&&Object.keys(t).forEach(o=>{const l=n[o],c=new jg(t[o].attr,l);c.isValid?(n[o]=c,l||(c.tagOrder+=a)):ye.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${Le(t[o].attr)}"`)}),n}function em(s,e,t){if(s&&e){let i=0;for(let n=0,r=s.length;n<=r;n++){const a=s[n],o=e[n+i];a&&o&&a.index===o.index&&a.fragment.sn===o.fragment.sn?t(a,o):i--}}}function tm(s,e,t){const i=e.skippedSegments,n=Math.max(s.startSN,e.startSN)-e.startSN,r=(s.fragmentHint?1:0)+(i?e.endSN:Math.min(s.endSN,e.endSN))-e.startSN,a=e.startSN-s.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=s.fragmentHint?s.fragments.concat(s.fragmentHint):s.fragments;for(let c=n;c<=r;c++){const u=l[a+c];let d=o[c];if(i&&!d&&u&&(d=e.fragments[c]=u),u&&d){if(t(u,d,c,o),u.url&&u.url!==d.url){e.playlistParsingError=Pu(`media sequence mismatch ${d.sn}:`,s,e,u,d);return}else if(u.cc!==d.cc){e.playlistParsingError=Pu(`discontinuity sequence mismatch (${u.cc}!=${d.cc})`,s,e,u,d);return}}}}function Pu(s,e,t,i,n){return new Error(`${s} ${n.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function Du(s,e,t=!0){const i=e.startSN+e.skippedSegments-s.startSN,n=s.fragments,r=i>=0;let a=0;if(r&&i<n.length)a=n[i].start;else if(r&&e.startSN===s.endSN+1)a=s.fragmentEnd;else if(r&&t)a=s.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)a=s.fragmentStart;else return;Gr(e,a)}function Gr(s,e){if(e){const t=s.fragments;for(let i=s.skippedSegments;i<t.length;i++)t[i].addStart(e);s.fragmentHint&&s.fragmentHint.addStart(e)}}function im(s,e=1/0){let t=1e3*s.targetduration;if(s.updated){const i=s.fragments;if(i.length&&t*4>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function Ou(s,e,t){if(!s)return null;let i=s.fragments[e-s.startSN];return i||(i=s.fragmentHint,i&&i.sn===e)?i:e<s.startSN&&t&&t.sn===e?t:null}function Mu(s,e,t){return s?Fu(s.partList,e,t):null}function Fu(s,e,t){if(s)for(let i=s.length;i--;){const n=s[i];if(n.index===t&&n.fragment.sn===e)return n}return null}function sm(s){s.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(n=>{n.level=t,n.initSegment&&(n.initSegment.level=t)})})}function Ki(s,e){for(let i=0,n=s.length;i<n;i++){var t;if(((t=s[i])==null?void 0:t.cc)===e)return s[i]}return null}function nm(s,e){return!!(s&&e.startCC<s.endCC&&e.endCC>s.startCC)}function Nu(s,e){if(s){const t=s.start+e;s.start=s.startPTS=t,s.endPTS=t+s.duration}}function Uu(s,e){const t=e.fragments;for(let i=0,n=t.length;i<n;i++)Nu(t[i],s);e.fragmentHint&&Nu(e.fragmentHint,s),e.alignedSliding=!0}function rm(s,e){s&&(Bu(e,s),!e.alignedSliding&&s&&Xs(e,s),!e.alignedSliding&&s&&!e.skippedSegments&&Du(s,e,!1))}function Bu(s,e){if(!nm(e,s))return;const t=Math.min(e.endCC,s.endCC),i=Ki(e.fragments,t),n=Ki(s.fragments,t);if(!i||!n)return;ye.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const r=i.start-n.start;Uu(r,s)}function Xs(s,e){if(!s.hasProgramDateTime||!e.hasProgramDateTime)return;const t=s.fragments,i=e.fragments;if(!t.length||!i.length)return;let n,r;const a=Math.min(e.endCC,s.endCC);e.startCC<a&&s.startCC<a&&(n=Ki(i,a),r=Ki(t,a)),(!n||!r)&&(n=i[Math.floor(i.length/2)],r=Ki(t,n.cc)||t[Math.floor(t.length/2)]);const o=n.programDateTime,l=r.programDateTime;if(!o||!l)return;const c=(l-o)/1e3-(r.start-n.start);Uu(c,s)}const am={toString:function(s){let e="";const t=s.length;for(let i=0;i<t;i++)e+=`[${s.start(i).toFixed(3)}-${s.end(i).toFixed(3)}]`;return e}},$={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class $u extends Fg{constructor(e,t,i,n,r){super(n,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=$.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:a,fragCurrent:o,media:l,mediaBuffer:c,state:u}=this,d=l?l.currentTime:0,f=be.bufferInfo(c||l,d,a.maxBufferHole);if(this.log(`media seeking to ${K(d)?d.toFixed(3):d}, state: ${u}`),this.state===$.ENDED)this.resetLoadingState();else if(o){const p=a.maxFragLookUpTolerance,g=o.start-p,y=o.start+o.duration+p;if(!f.len||y<f.start||g>f.end){const S=d>y;(d<g||S)&&(S&&o.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),o.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(l){this.fragmentTracker.removeFragmentsInRange(d,1/0,this.playlistType,!0);const p=this.lastCurrentTime;if(d>p&&(this.lastCurrentTime=d),!this.loadingParts){const g=Math.max(f.end,d),y=this.shouldLoadParts(this.getLevelDetails(),g);y&&(this.log(`LL-Part loading ON after seeking to ${d.toFixed(2)} with buffer @${g.toFixed(2)}`),this.loadingParts=y)}}!this.hls.hasEnoughToStart&&!f.len&&(this.log(`setting startPosition to ${d} because of seek before start`),this.nextLoadPosition=this.startPosition=d),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=r,this.hls=e,this.fragmentLoader=new Og(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Or(e.config)}registerListeners(){const{hls:e}=this;e.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(E.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===$.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=$.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,n=this.config.timelineOffset||0;if(i<=n)return!1;const r=e.nextStart;if(r&&r>n&&r<t.edge||this.media.currentTime<e.start)return!1;const o=t.partList;if(o!=null&&o.length){const c=o[o.length-1];return be.isBuffered(this.media,c.start+c.duration/2)}const l=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(l)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);const n=this.config;this.levels&&n.autoStartLoad&&this.state===$.STOPPED&&this.startLoad(n.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(n!==null){if(n.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),n.removeEventListener("seeking",this.onMediaSeeking),n.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=$.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const n=r=>{const a=r.frag;if(this.fragContextChanged(a)){this.warn(`${a.type} sn: ${a.sn}${r.part?" part: "+r.part.index:""} of ${this.fragInfo(a,!1,r.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(a);return}a.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,n).then(r=>{if(!r)return;const a=this.state,o=r.frag;if(this.fragContextChanged(o)){(a===$.FRAG_LOADING||!this.fragCurrent&&a===$.PARSING)&&(this.fragmentTracker.removeFragment(o),this.state=$.IDLE);return}"payload"in r&&(this.log(`Loaded ${o.type} sn: ${o.sn} of ${this.playlistLabel()} ${o.level}`),this.hls.trigger(E.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===$.STOPPED||this.state===$.ERROR||(this.warn(`Frag error: ${(r==null?void 0:r.message)||r}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===Xe.APPENDING){const r=e.type,a=this.getFwdBufferInfo(this.mediaBuffer,r),o=Math.max(e.duration,a?a.len:this.config.maxBufferLength),l=this.backtrackFragment;((l?e.sn-l.sn:0)===1||this.reduceMaxBufferLength(o,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===Xe.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return(t==null?void 0:t.live)&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const n={startOffset:e,endOffset:t,type:i};this.hls.trigger(E.BUFFER_FLUSHING,n)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{const n=i==null?void 0:i.frag;if(!n||this.fragContextChanged(n)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:n}=this,{frag:r,payload:a}=i,o=r.decryptdata;if(a&&a.byteLength>0&&o!=null&&o.key&&o.iv&&bi(o.method)){const l=self.performance.now();return this.decrypter.decrypt(new Uint8Array(a),o.key.buffer,o.iv.buffer,Mr(o.method)).catch(c=>{throw n.trigger(E.ERROR,{type:Z.MEDIA_ERROR,details:M.FRAG_DECRYPT_ERROR,fatal:!1,error:c,reason:c.message,frag:r}),c}).then(c=>{const u=self.performance.now();return n.trigger(E.FRAG_DECRYPTED,{frag:r,payload:c,stats:{tstart:l,tdecrypt:u}}),i.payload=c,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===$.STOPPED||this.state===$.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==$.STOPPED&&(this.state=$.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?am.toString(be.getBuffered(i)):"(detached)"})`),Ye(e)){var n;if(e.type!==re.SUBTITLE){const a=e.elementaryStreams;if(!Object.keys(a).some(o=>!!a[o])){this.state=$.IDLE;return}}const r=(n=this.levels)==null?void 0:n[e.level];r!=null&&r.fragmentError&&(this.log(`Resetting level fragment error count of ${r.fragmentError} on frag buffered`),r.fragmentError=0)}this.state=$.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:n,partsLoaded:r}=e,a=!r||r.length===0||r.some(l=>!l),o=new Iu(i.level,i.sn,i.stats.chunkCount+1,0,n?n.index:-1,!a);t.flush(o)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,n){var r;this.fragCurrent=e;const a=t==null?void 0:t.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let o=null;e.encrypted&&!((r=e.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${e.sn} of [${a.startSN}-${a.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=$.KEY_LOADING,this.fragCurrent=e,o=this.keyLoader.load(e).then(d=>{if(!this.fragContextChanged(d.frag))return this.hls.trigger(E.KEY_LOADED,d),this.state===$.KEY_LOADING&&(this.state=$.IDLE),d}),this.hls.trigger(E.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&a.encryptedFragments.length&&this.keyLoader.loadClear(e,a.encryptedFragments);const l=this.fragPrevious;if(Ye(e)&&(!l||e.sn!==l.sn)){const d=this.shouldLoadParts(t.details,e.end);d!==this.loadingParts&&(this.log(`LL-Part loading ${d?"ON":"OFF"} loading sn ${l==null?void 0:l.sn}->${e.sn}`),this.loadingParts=d)}if(i=Math.max(e.start,i||0),this.loadingParts&&Ye(e)){const d=a.partList;if(d&&n){i>e.end&&a.fragmentHint&&(e=a.fragmentHint);const f=this.getNextPart(d,e,i);if(f>-1){const p=d[f];e=this.fragCurrent=p.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${p.index} (${f}/${d.length-1}) of ${this.fragInfo(e,!1,p)}) cc: ${e.cc} [${a.startSN}-${a.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=p.start+p.duration,this.state=$.FRAG_LOADING;let g;return o?g=o.then(y=>!y||this.fragContextChanged(y.frag)?null:this.doFragPartsLoad(e,p,t,n)).catch(y=>this.handleFragLoadError(y)):g=this.doFragPartsLoad(e,p,t,n).catch(y=>this.handleFragLoadError(y)),this.hls.trigger(E.FRAG_LOADING,{frag:e,part:p,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}else if(!e.url||this.loadedEndOfParts(d,i))return Promise.resolve(null)}}if(Ye(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${a?"["+a.startSN+"-"+a.endSN+"]":""}, target: ${parseFloat(i.toFixed(3))}`),K(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=$.FRAG_LOADING;const c=this.config.progressive;let u;return c&&o?u=o.then(d=>!d||this.fragContextChanged(d==null?void 0:d.frag)?null:this.fragmentLoader.load(e,n)).catch(d=>this.handleFragLoadError(d)):u=Promise.all([this.fragmentLoader.load(e,c?n:void 0),o]).then(([d])=>(!c&&d&&n&&n(d),d)).catch(d=>this.handleFragLoadError(d)),this.hls.trigger(E.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):u}doFragPartsLoad(e,t,i,n){return new Promise((r,a)=>{var o;const l=[],c=(o=i.details)==null?void 0:o.partList,u=d=>{this.fragmentLoader.loadPart(e,d,n).then(f=>{l[d.index]=f;const p=f.part;this.hls.trigger(E.FRAG_LOADED,f);const g=Mu(i.details,e.sn,d.index+1)||Fu(c,e.sn,d.index+1);if(g)u(g);else return r({frag:e,part:p,partsLoaded:l})}).catch(a)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===M.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(E.ERROR,t)}else this.hls.trigger(E.ERROR,{type:Z.OTHER_ERROR,details:M.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==$.PARSING){!this.fragCurrent&&this.state!==$.STOPPED&&this.state!==$.ERROR&&(this.state=$.IDLE);return}const{frag:i,part:n,level:r}=t,a=self.performance.now();i.stats.parsing.end=a,n&&(n.stats.parsing.end=a);const o=this.getLevelDetails(),c=o&&i.sn>o.endSN||this.shouldLoadParts(o,i.end);c!==this.loadingParts&&(this.log(`LL-Part loading ${c?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=c),this.updateLevelTiming(i,n,r,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e!=null&&e.partList){var i;const r=e.partList[0],a=r.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=a){var n;if((this.hls.hasEnoughToStart?((n=this.media)==null?void 0:n.currentTime)||this.lastCurrentTime:this.getLoadPosition())>r.start-r.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:n,sn:r,part:a}=e;if(!(t!=null&&t[n]))return this.warn(`Levels object was unset while buffering fragment ${r} of ${this.playlistLabel()} ${n}. The current chunk will not be buffered.`),null;const o=t[n],l=o.details,c=a>-1?Mu(l,r,a):null,u=c?c.fragment:Ou(l,r,i);return u?(i&&i!==u&&(u.stats=i.stats),{frag:u,part:c,level:o}):null}bufferFragmentData(e,t,i,n,r){var a;if(!e||this.state!==$.PARSING)return;const{data1:o,data2:l}=e;let c=o;if(o&&l&&(c=Qe(o,l)),!((a=c)!=null&&a.length))return;const u={type:e.type,frag:t,part:i,chunkMeta:n,parent:t.type,data:c};if(this.hls.trigger(E.BUFFER_APPENDING,u),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!be.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,n=be.bufferInfo(t,i,0),r=e.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),o=Math.max(Math.min(e.start-a,n.end-a),i+a);e.start-o>a&&this.flushMainBuffer(o,e.start)}getFwdBufferInfo(e,t){var i;const n=this.getLoadPosition();if(!K(n))return null;const a=this.lastCurrentTime>n||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,n,t,a)}getFwdBufferInfoAtPos(e,t,i,n){const r=be.bufferInfo(e,t,n);if(r.len===0&&r.nextStart!==void 0){const a=this.fragmentTracker.getBufferedFrag(t,i);if(a&&(r.nextStart<=a.end||a.gap)){const o=Math.max(Math.min(r.nextStart,a.end)-t,n);return be.bufferInfo(e,t,o)}}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,n=Math.max(Math.min(e-t,i.maxBufferLength),t),r=Math.max(e-t*3,i.maxMaxBufferLength/2,n);return r>=n?(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0):!1}getAppendedFrag(e,t=re.MAIN){var i;const n=(i=this.fragmentTracker)==null?void 0:i.getAppendedFrag(e,t);return n&&"fragment"in n?n.fragment:n}getNextFragment(e,t){const i=t.fragments,n=i.length;if(!n)return null;const{config:r}=this,a=i[0].start,o=r.lowLatencyMode&&!!t.partList;let l=null;if(t.live){const d=r.initialLiveManifestSize;if(n<d)return this.warn(`Not enough fragments to start playback (have: ${n}, need: ${d})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<a){var c;o&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),l=this.getInitialLiveFragment(t,i);const f=this.hls.startPosition,p=this.hls.liveSyncPosition,g=l?(f!==-1&&f>=a?f:p)||l.start:e;this.log(`Setting startPosition to ${g} to match start frag at live edge. mainStart: ${f} liveSyncPosition: ${p} frag.start: ${(c=l)==null?void 0:c.start}`),this.startPosition=this.nextLoadPosition=g}}else e<=a&&(l=i[0]);if(!l){const d=this.loadingParts?t.partEnd:t.fragmentEnd;l=this.getFragmentAtPosition(e,d,t)}let u=this.filterReplacedPrimary(l,t);if(!u&&l){const d=l.sn-t.startSN;u=this.filterReplacedPrimary(i[d+1]||null,t)}return this.mapToInitFragWhenRequired(u)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===Xe.OK||i===Xe.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,n,r){let a=null;if(e.gap&&(a=this.getNextFragment(this.nextLoadPosition,t),a&&!a.gap&&i.nextStart)){const o=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,n,0);if(o!==null&&i.len+o.len>=r){const l=a.sn;return this.loopSn!==l&&(this.log(`buffer full after gaps in "${n}" playlist starting at sn: ${l}`),this.loopSn=l),null}}return this.loopSn=void 0,a}get primaryPrefetch(){if(ju(this.hls.config)){var e,t;if((e=this.hls.interstitialsManager)==null||(t=e.playingItem)==null?void 0:t.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(ju(this.hls.config)&&e.type!==re.SUBTITLE){const i=this.hls.interstitialsManager,n=i==null?void 0:i.bufferingItem;if(n){const a=n.event;if(a){if(a.appendInPlace||Math.abs(e.start-n.start)>1||n.start===0)return null}else if(e.end<=n.start&&(t==null?void 0:t.live)===!1||e.start>n.end&&n.nextEvent&&(n.nextEvent.appendInPlace||e.start-n.end>1))return null}const r=i==null?void 0:i.playerQueue;if(r)for(let a=r.length;a--;){const o=r[a].interstitial;if(o.appendInPlace&&e.start>=o.startTime&&e.end<=o.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let n=-1,r=!1,a=!0;for(let o=0,l=e.length;o<l;o++){const c=e[o];if(a=a&&!c.independent,n>-1&&i<c.start)break;const u=c.loaded;u?n=-1:(r||c.independent||a)&&c.fragment===t&&(n=o),r=u}return n}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let n=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),n=bg(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const a=t[r-e.startSN];i.cc===a.cc&&(n=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${n.sn}`))}n||(n=Eu(t,i.cc),n&&this.log(`Live playlist, switching playlist, load frag with same CC: ${n.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(n=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}getFragmentAtPosition(e,t,i){const{config:n}=this;let{fragPrevious:r}=this,{fragments:a,endSN:o}=i;const{fragmentHint:l}=i,{maxFragLookUpTolerance:c}=n,u=i.partList,d=!!(this.loadingParts&&u!=null&&u.length&&l);d&&l&&!this.bitrateTest&&u[u.length-1].fragment.sn===l.sn&&(a=a.concat(l),o=l.sn);let f;if(e<t){var p;const y=e<this.lastCurrentTime||e>t-c||(p=this.media)!=null&&p.paused||!this.startFragRequested?0:c;f=Ti(r,a,e,y)}else f=a[a.length-1];if(f){const g=f.sn-i.startSN,y=this.fragmentTracker.getState(f);if((y===Xe.OK||y===Xe.PARTIAL&&f.gap)&&(r=f),r&&f.sn===r.sn&&(!d||u[0].fragment.sn>f.sn||!i.live&&!d)&&r&&f.level===r.level){const T=a[g+1];f.sn<o&&this.fragmentTracker.getState(T)!==Xe.OK?f=T:f=null}}return f}alignPlaylists(e,t,i){const n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;const r=e.fragmentStart,a=!t,o=e.alignedSliding&&K(r);if(a||!o&&!r){rm(i,e);const l=e.fragmentStart;return this.log(`Live playlist sliding: ${l.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${n}`),l}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const n=this.timelineOffset;if(i===-1){const r=this.startTimeOffset!==null,a=r?this.startTimeOffset:e.startTimeOffset;a!==null&&K(a)?(i=t+a,a<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${a} found in ${r?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+n}this.nextLoadPosition=i+n}getLoadPosition(){var e;const{media:t}=this;let i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&Ye(e)&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==$.FRAG_LOADING_WAITING_RETRY)&&(this.state=$.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const g=this.getCurrentContext(t.chunkMeta);g&&(t.frag=g.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var n;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(n=this.fragCurrent)==null?void 0:n.url}`);return}const r=t.details===M.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const a=t.errorAction,{action:o,flags:l,retryCount:c=0,retryConfig:u}=a||{},d=!!a&&!!u,f=d&&o===Ne.RetryRequest,p=d&&!a.resolved&&l===ct.MoveAllAlternatesMatchingHost;if(!f&&p&&Ye(i)&&!i.endList)this.resetFragmentErrors(e),this.treatAsGap(i),a.resolved=!0;else if((f||p)&&c<u.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const g=Dr(u,c);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${c+1}/${u.maxNumRetry} in ${g}ms`),a.resolved=!0,this.retryDate=self.performance.now()+g,this.state=$.FRAG_LOADING_WAITING_RETRY}else if(u&&a)if(this.resetFragmentErrors(e),c<u.maxNumRetry)!r&&o!==Ne.RemoveAlternatePermanently&&(a.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${c})`);return}else o===Ne.SendAlternateToPenaltyBox?this.state=$.WAITING_LEVEL:this.state=$.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===$.PARSING||this.state===$.PARSED){const t=e.frag,i=e.parent,n=this.getFwdBufferInfo(this.mediaBuffer,i),r=n&&n.len>.5;r&&this.reduceMaxBufferLength(n.len,(t==null?void 0:t.duration)||10);const a=!r;return a&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),a}return!1}resetFragmentErrors(e){e===re.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==$.STOPPED&&(this.state=$.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const n=be.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,i),this.state===$.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==$.STOPPED&&(this.state=$.IDLE)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,n){const r=i.details;if(!r){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,c)=>{const u=e.elementaryStreams[c];if(u){const d=u.endPTS-u.startPTS;if(d<=0)return this.warn(`Could not parse fragment ${e.sn} ${c} duration reliably (${d})`),l||!1;const f=n?0:Ru(r,e,u.startPTS,u.endPTS,u.startDTS,u.endDTS);return this.hls.trigger(E.LEVEL_PTS_UPDATED,{details:r,level:i,drift:f,type:c,frag:e,start:u.startPTS,end:u.endPTS}),!0}return l},!1)){var o;if(i.fragmentError===0&&this.treatAsGap(e,i),((o=this.transmuxer)==null?void 0:o.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(E.ERROR,{type:Z.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=$.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(E.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===re.MAIN?"level":"track"}fragInfo(e,t=!0,i){var n,r;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((n=t&&!i?e.startPTS:(i||e).start)!=null?n:NaN).toFixed(3)}-${((r=t&&!i?e.endPTS:(i||e).end)!=null?r:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function ju(s){return!!s.interstitialsController&&s.enableInterstitialPlayback!==!1}class om{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=lm(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function lm(s,e){const t=new Uint8Array(e);let i=0;for(let n=0;n<s.length;n++){const r=s[n];t.set(r,i),i+=r.length}return t}var Vr={exports:{}},Gu;function cm(){return Gu||(Gu=1,function(s){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function n(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function r(l,c,u,d,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var p=new n(u,d||l,f),g=t?t+c:c;return l._events[g]?l._events[g].fn?l._events[g]=[l._events[g],p]:l._events[g].push(p):(l._events[g]=p,l._eventsCount++),l}function a(l,c){--l._eventsCount===0?l._events=new i:delete l._events[c]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],u,d;if(this._eventsCount===0)return c;for(d in u=this._events)e.call(u,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},o.prototype.listeners=function(c){var u=t?t+c:c,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var f=0,p=d.length,g=new Array(p);f<p;f++)g[f]=d[f].fn;return g},o.prototype.listenerCount=function(c){var u=t?t+c:c,d=this._events[u];return d?d.fn?1:d.length:0},o.prototype.emit=function(c,u,d,f,p,g){var y=t?t+c:c;if(!this._events[y])return!1;var S=this._events[y],T=arguments.length,L,w;if(S.fn){switch(S.once&&this.removeListener(c,S.fn,void 0,!0),T){case 1:return S.fn.call(S.context),!0;case 2:return S.fn.call(S.context,u),!0;case 3:return S.fn.call(S.context,u,d),!0;case 4:return S.fn.call(S.context,u,d,f),!0;case 5:return S.fn.call(S.context,u,d,f,p),!0;case 6:return S.fn.call(S.context,u,d,f,p,g),!0}for(w=1,L=new Array(T-1);w<T;w++)L[w-1]=arguments[w];S.fn.apply(S.context,L)}else{var x=S.length,b;for(w=0;w<x;w++)switch(S[w].once&&this.removeListener(c,S[w].fn,void 0,!0),T){case 1:S[w].fn.call(S[w].context);break;case 2:S[w].fn.call(S[w].context,u);break;case 3:S[w].fn.call(S[w].context,u,d);break;case 4:S[w].fn.call(S[w].context,u,d,f);break;default:if(!L)for(b=1,L=new Array(T-1);b<T;b++)L[b-1]=arguments[b];S[w].fn.apply(S[w].context,L)}}return!0},o.prototype.on=function(c,u,d){return r(this,c,u,d,!1)},o.prototype.once=function(c,u,d){return r(this,c,u,d,!0)},o.prototype.removeListener=function(c,u,d,f){var p=t?t+c:c;if(!this._events[p])return this;if(!u)return a(this,p),this;var g=this._events[p];if(g.fn)g.fn===u&&(!f||g.once)&&(!d||g.context===d)&&a(this,p);else{for(var y=0,S=[],T=g.length;y<T;y++)(g[y].fn!==u||f&&!g[y].once||d&&g[y].context!==d)&&S.push(g[y]);S.length?this._events[p]=S.length===1?S[0]:S:a(this,p)}return this},o.prototype.removeAllListeners=function(c){var u;return c?(u=t?t+c:c,this._events[u]&&a(this,u)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,s.exports=o}(Vr)),Vr.exports}var um=cm(),Vu=Fp(um);const Zs="1.6.2",_i={};function dm(){return typeof __HLS_WORKER_BUNDLE__=="function"}function hm(){const s=_i[Zs];if(s)return s.clientCount++,s;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),n={worker:new self.Worker(t),objectURL:t,clientCount:1};return _i[Zs]=n,n}function fm(s){const e=_i[s];if(e)return e.clientCount++,e;const t=new self.URL(s,self.location.href).href,n={worker:new self.Worker(t),scriptURL:t,clientCount:1};return _i[s]=n,n}function pm(s){const e=_i[s||Zs];if(e&&e.clientCount--===1){const{worker:i,objectURL:n}=e;delete _i[s||Zs],n&&self.URL.revokeObjectURL(n),i.terminate()}}function qu(s,e){return e+10<=s.length&&s[e]===51&&s[e+1]===68&&s[e+2]===73&&s[e+3]<255&&s[e+4]<255&&s[e+6]<128&&s[e+7]<128&&s[e+8]<128&&s[e+9]<128}function qr(s,e){return e+10<=s.length&&s[e]===73&&s[e+1]===68&&s[e+2]===51&&s[e+3]<255&&s[e+4]<255&&s[e+6]<128&&s[e+7]<128&&s[e+8]<128&&s[e+9]<128}function en(s,e){let t=0;return t=(s[e]&127)<<21,t|=(s[e+1]&127)<<14,t|=(s[e+2]&127)<<7,t|=s[e+3]&127,t}function Yi(s,e){const t=e;let i=0;for(;qr(s,e);){i+=10;const n=en(s,e+6);i+=n,qu(s,e+10)&&(i+=10),e+=i}if(i>0)return s.subarray(t,t+i)}function gm(s,e,t,i){const n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],r=e[t+2],a=r>>2&15;if(a>12){const p=new Error(`invalid ADTS sampling index:${a}`);s.emit(E.ERROR,E.ERROR,{type:Z.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,fatal:!0,error:p,reason:p.message});return}const o=(r>>6&3)+1,l=e[t+3]>>6&3|(r&1)<<2,c="mp4a.40."+o,u=n[a];let d=a;(o===5||o===29)&&(d-=3);const f=[o<<3|(d&14)>>1,(d&1)<<7|l<<3];return ye.log(`manifest codec:${i}, parsed codec:${c}, channels:${l}, rate:${u} (ADTS object type:${o} sampling index:${a})`),{config:f,samplerate:u,channelCount:l,codec:c,parsedCodec:c,manifestCodec:i}}function Hu(s,e){return s[e]===255&&(s[e+1]&246)===240}function Ku(s,e){return s[e+1]&1?7:9}function Hr(s,e){return(s[e+3]&3)<<11|s[e+4]<<3|(s[e+5]&224)>>>5}function mm(s,e){return e+5<s.length}function tn(s,e){return e+1<s.length&&Hu(s,e)}function ym(s,e){return mm(s,e)&&Hu(s,e)&&Hr(s,e)<=s.length-e}function vm(s,e){if(tn(s,e)){const t=Ku(s,e);if(e+t>=s.length)return!1;const i=Hr(s,e);if(i<=t)return!1;const n=e+i;return n===s.length||tn(s,n)}return!1}function Yu(s,e,t,i,n){if(!s.samplerate){const r=gm(e,t,i,n);if(!r)return;Ie(s,r)}}function Wu(s){return 1024*9e4/s}function Sm(s,e){const t=Ku(s,e);if(e+t<=s.length){const i=Hr(s,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function zu(s,e,t,i,n){const r=Wu(s.samplerate),a=i+n*r,o=Sm(e,t);let l;if(o){const{frameLength:d,headerLength:f}=o,p=f+d,g=Math.max(0,t+p-e.length);g?(l=new Uint8Array(p-f),l.set(e.subarray(t+f,e.length),0)):l=e.subarray(t+f,t+p);const y={unit:l,pts:a};return g||s.samples.push(y),{sample:y,length:p,missing:g}}const c=e.length-t;return l=new Uint8Array(c),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:a},length:c,missing:-1}}function Em(s,e){return qr(s,e)&&en(s,e+6)+10<=s.length-e}function Tm(s){if(s.size<2)return;const e=Ke(s.data,!0),t=new Uint8Array(s.data.subarray(e.length+1));return{key:s.type,info:e,data:t.buffer}}function bm(s){if(s.size<2)return;if(s.type==="TXXX"){let t=1;const i=Ke(s.data.subarray(t),!0);t+=i.length+1;const n=Ke(s.data.subarray(t));return{key:s.type,info:i,data:n}}const e=Ke(s.data.subarray(1));return{key:s.type,info:"",data:e}}function _m(s){if(s.type==="WXXX"){if(s.size<2)return;let t=1;const i=Ke(s.data.subarray(t),!0);t+=i.length+1;const n=Ke(s.data.subarray(t));return{key:s.type,info:i,data:n}}const e=Ke(s.data);return{key:s.type,info:"",data:e}}function xm(s){return btoa(String.fromCharCode(...s))}function Ju(s,e){if(s<0)return-Ju(-s,e);const t=Math.pow(10,e);if(Math.abs(s*t%1-.5)<Number.EPSILON){const n=Math.floor(s*t);return(n%2===0?n:n+1)/t}else return Math.round(s*t)/t}function Am(s,e){const t=new URL(s),i=new URL(e);if(t.origin!==i.origin)return s;const n=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;n[0]===r[0];)n.shift(),r.shift();for(;r.length;)r.shift(),n.unshift("..");return n.join("/")}function Im(s){return s instanceof ArrayBuffer?s:s.byteOffset==0&&s.byteLength==s.buffer.byteLength?s.buffer:new Uint8Array(s).buffer}function Kr(s,e=0,t=1/0){return wm(s,e,t,Uint8Array)}function wm(s,e,t,i){const n=Lm(s);let r=1;"BYTES_PER_ELEMENT"in i&&(r=i.BYTES_PER_ELEMENT);const a=km(s)?s.byteOffset:0,o=(a+s.byteLength)/r,l=(a+e)/r,c=Math.floor(Math.max(0,Math.min(l,o))),u=Math.floor(Math.min(c+Math.max(t,0),o));return new i(n,c,u-c)}function Lm(s){return s instanceof ArrayBuffer?s:s.buffer}function km(s){return s&&s.buffer instanceof ArrayBuffer&&s.byteLength!==void 0&&s.byteOffset!==void 0}function Cm(s){const e={key:s.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(s.size<2)return;if(s.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const i=s.data.subarray(1).indexOf(0);if(i===-1)return;const n=Ke(Kr(s.data,1,i)),r=s.data[2+i],a=s.data.subarray(3+i).indexOf(0);if(a===-1)return;const o=Ke(Kr(s.data,3+i,a));let l;return n==="-->"?l=Ke(Kr(s.data,4+i+a)):l=Im(s.data.subarray(4+i+a)),e.mimeType=n,e.pictureType=r,e.description=o,e.data=l,e}function Rm(s){return s.type==="PRIV"?Tm(s):s.type[0]==="W"?_m(s):s.type==="APIC"?Cm(s):bm(s)}function Pm(s){const e=String.fromCharCode(s[0],s[1],s[2],s[3]),t=en(s,4),i=10;return{type:e,size:t,data:s.subarray(i,i+t)}}const sn=10,Dm=10;function Om(s){let e=0;const t=[];for(;qr(s,e);){const i=en(s,e+6);s[e+5]>>6&1&&(e+=sn),e+=sn;const n=e+i;for(;e+Dm<n;){const r=Pm(s.subarray(e)),a=Rm(r);a&&t.push(a),e+=r.size+sn}qu(s,e)&&(e+=sn)}return t}function Mm(s){return s&&s.key==="PRIV"&&s.info==="com.apple.streaming.transportStreamTimestamp"}function Fm(s){if(s.data.byteLength===8){const e=new Uint8Array(s.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function Yr(s){const e=Om(s);for(let t=0;t<e.length;t++){const i=e[t];if(Mm(i))return Fm(i)}}let xi=function(s){return s.audioId3="org.id3",s.dateRange="com.apple.quicktime.HLS",s.emsg="https://aomedia.org/emsg/ID3",s.misbklv="urn:misb:KLV:bin:1910.1",s}({});function St(s="",e=9e4){return{type:s,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class Wr{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=Qe(this.cachedData,e),this.cachedData=null);let i=Yi(e,0),n=i?i.length:0,r;const a=this._audioTrack,o=this._id3Track,l=i?Yr(i):void 0,c=e.length;for((this.basePTS===null||this.frameIndex===0&&K(l))&&(this.basePTS=Nm(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:xi.audioId3,duration:Number.POSITIVE_INFINITY});n<c;){if(this.canParse(e,n)){const u=this.appendFrame(a,e,n);u?(this.frameIndex++,this.lastPTS=u.sample.pts,n+=u.length,r=n):n=c}else Em(e,n)?(i=Yi(e,n),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:xi.audioId3,duration:Number.POSITIVE_INFINITY}),n+=i.length,r=n):n++;if(n===c&&r!==c){const u=e.slice(r);this.cachedData?this.cachedData=Qe(this.cachedData,u):this.cachedData=u}}return{audioTrack:a,videoTrack:St(),id3Track:o,textTrack:St()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:St(),id3Track:this._id3Track,textTrack:St()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const Nm=(s,e,t)=>{if(K(s))return s*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};let nn=null;const Um=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],Bm=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],$m=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],jm=[0,1,1,4];function Qu(s,e,t,i,n){if(t+24>e.length)return;const r=Xu(e,t);if(r&&t+r.frameLength<=e.length){const a=r.samplesPerFrame*9e4/r.sampleRate,o=i+n*a,l={unit:e.subarray(t,t+r.frameLength),pts:o,dts:o};return s.config=[],s.channelCount=r.channelCount,s.samplerate=r.sampleRate,s.samples.push(l),{sample:l,length:r.frameLength,missing:0}}}function Xu(s,e){const t=s[e+1]>>3&3,i=s[e+1]>>1&3,n=s[e+2]>>4&15,r=s[e+2]>>2&3;if(t!==1&&n!==0&&n!==15&&r!==3){const a=s[e+2]>>1&1,o=s[e+3]>>6,l=t===3?3-i:i===3?3:4,c=Um[l*14+n-1]*1e3,d=Bm[(t===3?0:t===2?1:2)*3+r],f=o===3?1:2,p=$m[t][i],g=jm[i],y=p*8*g,S=Math.floor(p*c/d+a)*g;if(nn===null){const w=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);nn=w?parseInt(w[1]):0}return!!nn&&nn<=87&&i===2&&c>=224e3&&o===0&&(s[e+3]=s[e+3]|128),{sampleRate:d,channelCount:f,frameLength:S,samplesPerFrame:y}}}function zr(s,e){return s[e]===255&&(s[e+1]&224)===224&&(s[e+1]&6)!==0}function Zu(s,e){return e+1<s.length&&zr(s,e)}function Gm(s,e){return zr(s,e)&&4<=s.length-e}function ed(s,e){if(e+1<s.length&&zr(s,e)){const i=Xu(s,e);let n=4;i!=null&&i.frameLength&&(n=i.frameLength);const r=e+n;return r===s.length||Zu(s,r)}return!1}class Vm extends Wr{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=Yi(e,0);let n=(i==null?void 0:i.length)||0;if(ed(e,n))return!1;for(let r=e.length;n<r;n++)if(vm(e,n))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return ym(e,t)}appendFrame(e,t,i){Yu(e,this.observer,t,i,e.manifestCodec);const n=zu(e,t,i,this.basePTS,this.frameIndex);if(n&&n.missing===0)return n}}const td=(s,e)=>{let t=0,i=5;e+=i;const n=new Uint32Array(1),r=new Uint32Array(1),a=new Uint8Array(1);for(;i>0;){a[0]=s[e];const o=Math.min(i,8),l=8-o;r[0]=4278190080>>>24+l<<l,n[0]=(a[0]&r[0])>>l,t=t?t<<o|n[0]:n[0],e+=1,i-=o}return t};class qm extends Wr{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const n=id(e,t,i,this.basePTS,this.frameIndex);if(n!==-1)return{sample:e.samples[e.samples.length-1],length:n,missing:0}}static probe(e){if(!e)return!1;const t=Yi(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&Yr(t)!==void 0&&td(e,i)<16}}function id(s,e,t,i,n){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const r=e[t+4]>>6;if(r>=3)return-1;const o=[48e3,44100,32e3][r],l=e[t+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+r]*2;if(t+u>e.length)return-1;const d=e[t+6]>>5;let f=0;d===2?f+=2:(d&1&&d!==1&&(f+=2),d&4&&(f+=2));const p=(e[t+6]<<8|e[t+7])>>12-f&1,y=[2,1,2,3,3,4,4,5][d]+p,S=e[t+5]>>3,T=e[t+5]&7,L=new Uint8Array([r<<6|S<<1|T>>2,(T&3)<<6|d<<3|p<<2|l>>4,l<<4&224]),w=1536/o*9e4,x=i+n*w,b=e.subarray(t,t+u);return s.config=L,s.channelCount=y,s.samplerate=o,s.samples.push({unit:b,pts:x}),u}class Hm extends Wr{resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Yi(e,0);let i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&Yr(t)!==void 0&&td(e,i)<=16)return!1;for(let n=e.length;i<n;i++)if(ed(e,i))return ye.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return Gm(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return Qu(e,t,i,this.basePTS,this.frameIndex)}}const Km=/\/emsg[-/]ID3/i;class Ym{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,n){const r=this.videoTrack=St("video",1),a=this.audioTrack=St("audio",1),o=this.txtTrack=St("text",1);if(this.id3Track=St("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=tu(e);if(l.video){const{id:c,timescale:u,codec:d,supplemental:f}=l.video;r.id=c,r.timescale=o.timescale=u,r.codec=d,r.supplemental=f}if(l.audio){const{id:c,timescale:u,codec:d}=l.audio;a.id=c,a.timescale=u,a.codec=d}o.id=Qc.text,r.sampleDuration=0,r.duration=a.duration=n}resetContiguity(){this.remainderData=null}static probe(e){return $p(e)}demux(e,t){this.timeOffset=t;let i=e;const n=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Qe(this.remainderData,e));const o=Wp(i);this.remainderData=o.remainder,n.samples=o.valid||new Uint8Array}else n.samples=i;const a=this.extractID3Track(n,t);return r.samples=su(t,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const n=this.extractID3Track(t,this.timeOffset);return i.samples=su(e,t),{videoTrack:t,audioTrack:St(),id3Track:n,textTrack:St()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const n=te(e.samples,["emsg"]);n&&n.forEach(r=>{const a=Jp(r);if(Km.test(a.schemeIdUri)){const o=sd(a,t);let l=a.eventDuration===4294967295?Number.POSITIVE_INFINITY:a.eventDuration/a.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=a.payload;i.samples.push({data:c,len:c.byteLength,dts:o,pts:o,type:xi.emsg,duration:l})}else if(this.config.enableEmsgKLVMetadata&&a.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const o=sd(a,t);i.samples.push({data:a.payload,len:a.payload.byteLength,dts:o,pts:o,type:xi.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function sd(s,e){return K(s.presentationTime)?s.presentationTime/s.timeScale:e+s.presentationTimeDelta/s.timeScale}class Wm{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Or(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,Gt.cbc)}decryptAacSample(e,t,i){const n=e[t].unit;if(n.length<=16)return;const r=n.subarray(16,n.length-n.length%16),a=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(a).then(o=>{const l=new Uint8Array(o);n.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let n=0;for(let r=32;r<e.length-16;r+=160,n+=16)i.set(e.subarray(r,r+16),n);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let n=0;for(let r=32;r<e.length-16;r+=160,n+=16)e.set(i.subarray(n,n+16),r);return e}decryptAvcSample(e,t,i,n,r){const a=nu(r.data),o=this.getAvcEncryptedData(a);this.decryptBuffer(o.buffer).then(l=>{r.data=this.getAvcDecryptedUnit(a,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,n)})}decryptAvcSamples(e,t,i,n){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){n();return}const r=e[t].units;for(;!(i>=r.length);i++){const a=r[i];if(!(a.data.length<=48||a.type!==1&&a.type!==5)&&(this.decryptAvcSample(e,t,i,n,a),!this.decrypter.isSync()))return}}}}class nd{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,n;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;n=r[r.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,n=i.length;if(n){const r=i[n-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){const n=t.byteLength;let r=e.naluState||0;const a=r,o=[];let l=0,c,u,d,f=-1,p=0;for(r===-1&&(f=0,p=this.getNALuType(t,0),r=0,l=1);l<n;){if(c=t[l++],!r){r=c?0:1;continue}if(r===1){r=c?0:2;continue}if(!c)r=3;else if(c===1){if(u=l-r-1,f>=0){const g={data:t.subarray(f,u),type:p};o.push(g)}else{const g=this.getLastNalUnit(e.samples);g&&(a&&l<=4-a&&g.state&&(g.data=g.data.subarray(0,g.data.byteLength-a)),u>0&&(g.data=Qe(g.data,t.subarray(0,u)),g.state=0))}l<n?(d=this.getNALuType(t,l),f=l,p=d,r=0):r=-1}else r=0}if(f>=0&&r>=0){const g={data:t.subarray(f,n),type:p,state:r};o.push(g)}if(o.length===0){const g=this.getLastNalUnit(e.samples);g&&(g.data=Qe(g.data,t))}return e.naluState=r,o}}class Wi{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,n=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");n.set(e.subarray(i,i+r)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&ye.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class rd extends nd{parsePES(e,t,i,n){const r=this.parseNALu(e,i.data,n);let a=this.VideoSample,o,l=!1;i.data=null,a&&r.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(c=>{var u,d;switch(c.type){case 1:{let y=!1;o=!0;const S=c.data;if(l&&S.length>4){const T=this.readSliceType(S);(T===2||T===4||T===7||T===9)&&(y=!0)}if(y){var f;(f=a)!=null&&f.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null)}a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.frame=!0,a.key=y;break}case 5:o=!0,(u=a)!=null&&u.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 6:{o=!0,Ir(c.data,1,i.pts,t.samples);break}case 7:{var p,g;o=!0,l=!0;const y=c.data,S=this.readSPS(y);if(!e.sps||e.width!==S.width||e.height!==S.height||((p=e.pixelRatio)==null?void 0:p[0])!==S.pixelRatio[0]||((g=e.pixelRatio)==null?void 0:g[1])!==S.pixelRatio[1]){e.width=S.width,e.height=S.height,e.pixelRatio=S.pixelRatio,e.sps=[y];const T=y.subarray(1,4);let L="avc1.";for(let w=0;w<3;w++){let x=T[w].toString(16);x.length<2&&(x="0"+x),L+=x}e.codec=L}break}case 8:o=!0,e.pps=[c.data];break;case 9:o=!0,e.audFound=!0,(d=a)!=null&&d.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:o=!0;break;default:o=!1;break}a&&o&&a.units.push(c)}),n&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new Wi(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,n=8,r;for(let a=0;a<e;a++)n!==0&&(r=t.readEG(),n=(i+r+256)%256),i=n===0?i:n}readSPS(e){const t=new Wi(e);let i=0,n=0,r=0,a=0,o,l,c;const u=t.readUByte.bind(t),d=t.readBits.bind(t),f=t.readUEG.bind(t),p=t.readBoolean.bind(t),g=t.skipBits.bind(t),y=t.skipEG.bind(t),S=t.skipUEG.bind(t),T=this.skipScalingList.bind(this);u();const L=u();if(d(5),g(3),u(),S(),L===100||L===110||L===122||L===244||L===44||L===83||L===86||L===118||L===128){const k=f();if(k===3&&g(1),S(),S(),g(1),p())for(l=k!==3?8:12,c=0;c<l;c++)p()&&(c<6?T(16,t):T(64,t))}S();const w=f();if(w===0)f();else if(w===1)for(g(1),y(),y(),o=f(),c=0;c<o;c++)y();S(),g(1);const x=f(),b=f(),C=d(1);C===0&&g(1),g(1),p()&&(i=f(),n=f(),r=f(),a=f());let _=[1,1];if(p()&&p())switch(u()){case 1:_=[1,1];break;case 2:_=[12,11];break;case 3:_=[10,11];break;case 4:_=[16,11];break;case 5:_=[40,33];break;case 6:_=[24,11];break;case 7:_=[20,11];break;case 8:_=[32,11];break;case 9:_=[80,33];break;case 10:_=[18,11];break;case 11:_=[15,11];break;case 12:_=[64,33];break;case 13:_=[160,99];break;case 14:_=[4,3];break;case 15:_=[3,2];break;case 16:_=[2,1];break;case 255:{_=[u()<<8|u(),u()<<8|u()];break}}return{width:Math.ceil((x+1)*16-i*2-n*2),height:(2-C)*(b+1)*16-(C?2:4)*(r+a),pixelRatio:_}}}class ad extends nd{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,n){const r=this.parseNALu(e,i.data,n);let a=this.VideoSample,o,l=!1;i.data=null,a&&r.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(c=>{var u,d;switch(c.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),a.frame=!0,o=!0;break;case 16:case 17:case 18:case 21:if(o=!0,l){var f;(f=a)!=null&&f.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null)}a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 19:case 20:o=!0,(u=a)!=null&&u.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0,a.frame=!0;break;case 39:o=!0,Ir(c.data,2,i.pts,t.samples);break;case 32:o=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=Ie(e.params,this.readVPS(c.data)),this.initVPS=c.data),e.vps=[c.data];break;case 33:if(o=!0,l=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],c.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const p=this.readSPS(c.data);e.width=p.width,e.height=p.height,e.pixelRatio=p.pixelRatio,e.codec=p.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const g in p.params)e.params[g]=p.params[g]}this.pushParameterSet(e.sps,c.data,e.vps),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),a.key=!0;break;case 34:if(o=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const p=this.readPPS(c.data);for(const g in p)e.params[g]=p[g]}this.pushParameterSet(e.pps,c.data,e.vps)}break;case 35:o=!0,e.audFound=!0,(d=a)!=null&&d.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:o=!1;break}a&&o&&a.units.push(c)}),n&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let n=0;n<e.byteLength;n++)n>=2&&e[n]===3&&e[n-1]===0&&e[n-2]===0||(t[i]=e[n],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new Wi(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const i=t.readBits(3),n=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:n}}readSPS(e){const t=new Wi(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const n=t.readBits(2),r=t.readBoolean(),a=t.readBits(5),o=t.readUByte(),l=t.readUByte(),c=t.readUByte(),u=t.readUByte(),d=t.readUByte(),f=t.readUByte(),p=t.readUByte(),g=t.readUByte(),y=t.readUByte(),S=t.readUByte(),T=t.readUByte(),L=[],w=[];for(let ie=0;ie<i;ie++)L.push(t.readBoolean()),w.push(t.readBoolean());if(i>0)for(let ie=i;ie<8;ie++)t.readBits(2);for(let ie=0;ie<i;ie++)L[ie]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),w[ie]&&t.readUByte();t.readUEG();const x=t.readUEG();x==3&&t.skipBits(1);const b=t.readUEG(),C=t.readUEG(),_=t.readBoolean();let k=0,D=0,R=0,N=0;_&&(k+=t.readUEG(),D+=t.readUEG(),R+=t.readUEG(),N+=t.readUEG());const G=t.readUEG(),ce=t.readUEG(),J=t.readUEG(),ae=t.readBoolean();for(let ie=ae?0:i;ie<=i;ie++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let Ae=0;Ae<4;Ae++)for(let ke=0;ke<(Ae===3?2:6);ke++)if(!t.readBoolean())t.readUEG();else{const Se=Math.min(64,1<<4+(Ae<<1));Ae>1&&t.readEG();for(let Oe=0;Oe<Se;Oe++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const fe=t.readUEG();let j=0;for(let ie=0;ie<fe;ie++){let Ae=!1;if(ie!==0&&(Ae=t.readBoolean()),Ae){ie===fe&&t.readUEG(),t.readBoolean(),t.readUEG();let ke=0;for(let We=0;We<=j;We++){const Se=t.readBoolean();let Oe=!1;Se||(Oe=t.readBoolean()),(Se||Oe)&&ke++}j=ke}else{const ke=t.readUEG(),We=t.readUEG();j=ke+We;for(let Se=0;Se<ke;Se++)t.readUEG(),t.readBoolean();for(let Se=0;Se<We;Se++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const ie=t.readUEG();for(let Ae=0;Ae<ie;Ae++){for(let ke=0;ke<J+4;ke++)t.readBits(1);t.readBits(1)}}let ee=0,Q=1,z=1,h=!0,v=1,m=0;t.readBoolean(),t.readBoolean();let I=!1;if(t.readBoolean()){if(t.readBoolean()){const Be=t.readUByte(),ui=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],Yt=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Be>0&&Be<16?(Q=ui[Be-1],z=Yt[Be-1]):Be===255&&(Q=t.readBits(16),z=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),I=t.readBoolean(),I&&(k+=t.readUEG(),D+=t.readUEG(),R+=t.readUEG(),N+=t.readUEG()),t.readBoolean()&&(v=t.readBits(32),m=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const Yt=t.readBoolean(),mn=t.readBoolean();let ts=!1;(Yt||mn)&&(ts=t.readBoolean(),ts&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),ts&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let Qd=0;Qd<=i;Qd++){h=t.readBoolean();const Ky=h||t.readBoolean();let Xd=!1;Ky?t.readEG():Xd=t.readBoolean();const Zd=Xd?1:t.readUEG()+1;if(Yt)for(let is=0;is<Zd;is++)t.readUEG(),t.readUEG(),ts&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(mn)for(let is=0;is<Zd;is++)t.readUEG(),t.readUEG(),ts&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),ee=t.readUEG())}let O=b,U=C;if(_||I){let ie=1,Ae=1;x===1?ie=Ae=2:x==2&&(ie=2),O=b-ie*D-ie*k,U=C-Ae*N-Ae*R}const V=n?["A","B","C"][n]:"",W=o<<24|l<<16|c<<8|u;let he=0;for(let ie=0;ie<32;ie++)he=(he|(W>>ie&1)<<31-ie)>>>0;let le=he.toString(16);return a===1&&le==="2"&&(le="6"),{codecString:`hvc1.${V}${a}.${le}.${r?"H":"L"}${T}.B0`,params:{general_tier_flag:r,general_profile_idc:a,general_profile_space:n,general_profile_compatibility_flags:[o,l,c,u],general_constraint_indicator_flags:[d,f,p,g,y,S],general_level_idc:T,bit_depth:G+8,bit_depth_luma_minus8:G,bit_depth_chroma_minus8:ce,min_spatial_segmentation_idc:ee,chroma_format_idc:x,frame_rate:{fixed:h,fps:m/v}},width:O,height:U,pixelRatio:[Q,z]}}readPPS(e){const t=new Wi(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const n=t.readBoolean(),r=t.readBoolean();let a=1;return r&&n?a=0:r?a=3:n&&(a=2),{parallelismType:a}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const Pe=188;class qt{constructor(e,t,i,n){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.videoParser=null}static probe(e,t){const i=qt.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){const t=e.length;let i=Math.min(Pe*5,t-Pe)+1,n=0;for(;n<i;){let r=!1,a=-1,o=0;for(let l=n;l<t;l+=Pe)if(e[l]===71&&(t-l===Pe||e[l+Pe]===71)){if(o++,a===-1&&(a=l,a!==0&&(i=Math.min(a+Pe*99,e.length-Pe)+1)),r||(r=Jr(e,l)===0),r&&o>1&&(a===0&&o>2||l+Pe>i))return a}else{if(o)return-1;break}n++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Qc[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,n){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=qt.createTrack("video"),this._videoTrack.duration=n,this._audioTrack=qt.createTrack("audio",n),this._id3Track=qt.createTrack("id3"),this._txtTrack=qt.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,n=!1){i||(this.sampleAes=null);let r;const a=this._videoTrack,o=this._audioTrack,l=this._id3Track,c=this._txtTrack;let u=a.pid,d=a.pesData,f=o.pid,p=l.pid,g=o.pesData,y=l.pesData,S=null,T=this.pmtParsed,L=this._pmtId,w=e.length;if(this.remainderData&&(e=Qe(this.remainderData,e),w=e.length,this.remainderData=null),w<Pe&&!n)return this.remainderData=e,{audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};const x=Math.max(0,qt.syncOffset(e));w-=(w-x)%Pe,w<e.byteLength&&!n&&(this.remainderData=new Uint8Array(e.buffer,w,e.buffer.byteLength-w));let b=0;for(let _=x;_<w;_+=Pe)if(e[_]===71){const k=!!(e[_+1]&64),D=Jr(e,_),R=(e[_+3]&48)>>4;let N;if(R>1){if(N=_+5+e[_+4],N===_+Pe)continue}else N=_+4;switch(D){case u:if(k){if(d&&(r=Ai(d,this.logger))){if(this.videoParser===null)switch(a.segmentCodec){case"avc":this.videoParser=new rd;break;case"hevc":this.videoParser=new ad;break}this.videoParser!==null&&this.videoParser.parsePES(a,c,r,!1)}d={data:[],size:0}}d&&(d.data.push(e.subarray(N,_+Pe)),d.size+=_+Pe-N);break;case f:if(k){if(g&&(r=Ai(g,this.logger)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,r);break;case"mp3":this.parseMPEGPES(o,r);break;case"ac3":this.parseAC3PES(o,r);break}g={data:[],size:0}}g&&(g.data.push(e.subarray(N,_+Pe)),g.size+=_+Pe-N);break;case p:k&&(y&&(r=Ai(y,this.logger))&&this.parseID3PES(l,r),y={data:[],size:0}),y&&(y.data.push(e.subarray(N,_+Pe)),y.size+=_+Pe-N);break;case 0:k&&(N+=e[N]+1),L=this._pmtId=zm(e,N);break;case L:{k&&(N+=e[N]+1);const G=Jm(e,N,this.typeSupported,i,this.observer,this.logger);u=G.videoPid,u>0&&(a.pid=u,a.segmentCodec=G.segmentVideoCodec),f=G.audioPid,f>0&&(o.pid=f,o.segmentCodec=G.segmentAudioCodec),p=G.id3Pid,p>0&&(l.pid=p),S!==null&&!T&&(this.logger.warn(`MPEG-TS PMT found at ${_} after unknown PID '${S}'. Backtracking to sync byte @${x} to parse all TS packets.`),S=null,_=x-188),T=this.pmtParsed=!0;break}case 17:case 8191:break;default:S=D;break}}else b++;b>0&&Qr(this.observer,new Error(`Found ${b} TS packet/s that do not start with 0x47`),void 0,this.logger),a.pesData=d,o.pesData=g,l.pesData=y;const C={audioTrack:o,videoTrack:a,id3Track:l,textTrack:c};return n&&this.extractRemainingSamples(C),C}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:n,textTrack:r}=e,a=i.pesData,o=t.pesData,l=n.pesData;let c;if(a&&(c=Ai(a,this.logger))){if(this.videoParser===null)switch(i.segmentCodec){case"avc":this.videoParser=new rd;break;case"hevc":this.videoParser=new ad;break}this.videoParser!==null&&(this.videoParser.parsePES(i,r,c,!0),i.pesData=null)}else i.pesData=a;if(o&&(c=Ai(o,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,c);break;case"mp3":this.parseMPEGPES(t,c);break;case"ac3":this.parseAC3PES(t,c);break}t.pesData=null}else o!=null&&o.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=o;l&&(c=Ai(l,this.logger))?(this.parseID3PES(n,c),n.pesData=null):n.pesData=l}demuxSampleAes(e,t,i){const n=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new Wm(this.observer,this.config,t);return this.decrypt(n,r)}decrypt(e,t){return new Promise(i=>{const{audioTrack:n,videoTrack:r}=e;n.samples&&n.segmentCodec==="aac"?t.decryptAacSamples(n.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const n=this.aacOverFlow;let r=t.data;if(n){this.aacOverFlow=null;const d=n.missing,f=n.sample.unit.byteLength;if(d===-1)r=Qe(n.sample.unit,r);else{const p=f-d;n.sample.unit.set(r.subarray(0,d),p),e.samples.push(n.sample),i=n.missing}}let a,o;for(a=i,o=r.length;a<o-1&&!tn(r,a);a++);if(a!==i){let d;const f=a<o-1;if(f?d=`AAC PES did not start with ADTS header,offset:${a}`:d="No ADTS header found in AAC PES",Qr(this.observer,new Error(d),f,this.logger),!f)return}Yu(e,this.observer,r,a,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(n){const d=Wu(e.samplerate);l=n.sample.pts+d}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,u;for(;a<o;)if(u=zu(e,r,a,l,c),a+=u.length,u.missing){this.aacOverFlow=u;break}else for(c++;a<o-1&&!tn(r,a);a++);}parseMPEGPES(e,t){const i=t.data,n=i.length;let r=0,a=0;const o=t.pts;if(o===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<n;)if(Zu(i,a)){const l=Qu(e,i,a,o,r);if(l)a+=l.length,r++;else break}else a++}parseAC3PES(e,t){{const i=t.data,n=t.pts;if(n===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let a=0,o=0,l;for(;o<r&&(l=id(e,i,o,n,a++))>0;)o+=l}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=Ie({},t,{type:this._videoTrack?xi.emsg:xi.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function Jr(s,e){return((s[e+1]&31)<<8)+s[e+2]}function zm(s,e){return(s[e+10]&31)<<8|s[e+11]}function Jm(s,e,t,i,n,r){const a={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},o=(s[e+1]&15)<<8|s[e+2],l=e+3+o-4,c=(s[e+10]&15)<<8|s[e+11];for(e+=12+c;e<l;){const u=Jr(s,e),d=(s[e+3]&15)<<8|s[e+4];switch(s[e]){case 207:if(!i){Xr("ADTS AAC",r);break}case 15:a.audioPid===-1&&(a.audioPid=u);break;case 21:a.id3Pid===-1&&(a.id3Pid=u);break;case 219:if(!i){Xr("H.264",r);break}case 27:a.videoPid===-1&&(a.videoPid=u);break;case 3:case 4:!t.mpeg&&!t.mp3?r.log("MPEG audio found, not supported in this browser"):a.audioPid===-1&&(a.audioPid=u,a.segmentAudioCodec="mp3");break;case 193:if(!i){Xr("AC-3",r);break}case 129:t.ac3?a.audioPid===-1&&(a.audioPid=u,a.segmentAudioCodec="ac3"):r.log("AC-3 audio found, not supported in this browser");break;case 6:if(a.audioPid===-1&&d>0){let f=e+5,p=d;for(;p>2;){switch(s[f]){case 106:t.ac3!==!0?r.log("AC-3 audio found, not supported in this browser for now"):(a.audioPid=u,a.segmentAudioCodec="ac3");break}const y=s[f+1]+2;f+=y,p-=y}}break;case 194:case 135:return Qr(n,new Error("Unsupported EC-3 in M2TS found"),void 0,r),a;case 36:a.videoPid===-1&&(a.videoPid=u,a.segmentVideoCodec="hevc",r.log("HEVC in M2TS found"));break}e+=d+5}return a}function Qr(s,e,t,i){i.warn(`parsing error: ${e.message}`),s.emit(E.ERROR,E.ERROR,{type:Z.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function Xr(s,e){e.log(`${s} with AES-128-CBC encryption found in unencrypted stream`)}function Ai(s,e){let t=0,i,n,r,a,o;const l=s.data;if(!s||s.size===0)return null;for(;l[0].length<19&&l.length>1;)l[0]=Qe(l[0],l[1]),l.splice(1,1);if(i=l[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(n=(i[4]<<8)+i[5],n&&n>s.size-6)return null;const u=i[7];u&192&&(a=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,u&64?(o=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,a-o>60*9e4&&(e.warn(`${Math.round((a-o)/9e4)}s delta between PTS and DTS, align them`),a=o)):o=a),r=i[8];let d=r+9;if(s.size<=d)return null;s.size-=d;const f=new Uint8Array(s.size);for(let p=0,g=l.length;p<g;p++){i=l[p];let y=i.byteLength;if(d)if(d>y){d-=y;continue}else i=i.subarray(d),y-=d,d=0;f.set(i,t),t+=y}return n&&(n-=r+3),{data:f,pts:a,dts:o,len:n}}return null}class Qm{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Ht=Math.pow(2,32)-1;class P{static init(){P.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in P.types)P.types.hasOwnProperty(e)&&(P.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);P.HDLR_TYPES={video:t,audio:i};const n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);P.STTS=P.STSC=P.STCO=r,P.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),P.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),P.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),P.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const a=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);P.FTYP=P.box(P.types.ftyp,a,l,a,o),P.DINF=P.box(P.types.dinf,P.box(P.types.dref,n))}static box(e,...t){let i=8,n=t.length;const r=n;for(;n--;)i+=t[n].byteLength;const a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=i&255,a.set(e,4),n=0,i=8;n<r;n++)a.set(t[n],i),i+=t[n].byteLength;return a}static hdlr(e){return P.box(P.types.hdlr,P.HDLR_TYPES[e])}static mdat(e){return P.box(P.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(Ht+1)),n=Math.floor(t%(Ht+1));return P.box(P.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,85,196,0,0]))}static mdia(e){return P.box(P.types.mdia,P.mdhd(e.timescale||0,e.duration||0),P.hdlr(e.type),P.minf(e))}static mfhd(e){return P.box(P.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?P.box(P.types.minf,P.box(P.types.smhd,P.SMHD),P.DINF,P.stbl(e)):P.box(P.types.minf,P.box(P.types.vmhd,P.VMHD),P.DINF,P.stbl(e))}static moof(e,t,i){return P.box(P.types.moof,P.mfhd(e),P.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=P.trak(e[t]);return P.box.apply(null,[P.types.moov,P.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(P.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=P.trex(e[t]);return P.box.apply(null,[P.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(Ht+1)),n=Math.floor(t%(Ht+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return P.box(P.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let n,r;for(n=0;n<t.length;n++)r=t[n].flags,i[n+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return P.box(P.types.sdtp,i)}static stbl(e){return P.box(P.types.stbl,P.stsd(e),P.box(P.types.stts,P.STTS),P.box(P.types.stsc,P.STSC),P.box(P.types.stsz,P.STSZ),P.box(P.types.stco,P.STCO))}static avc1(e){let t=[],i=[],n,r,a;for(n=0;n<e.sps.length;n++)r=e.sps[n],a=r.byteLength,t.push(a>>>8&255),t.push(a&255),t=t.concat(Array.prototype.slice.call(r));for(n=0;n<e.pps.length;n++)r=e.pps[n],a=r.byteLength,i.push(a>>>8&255),i.push(a&255),i=i.concat(Array.prototype.slice.call(r));const o=P.box(P.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,c=e.height,u=e.pixelRatio[0],d=e.pixelRatio[1];return P.box(P.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,P.box(P.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),P.box(P.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,d>>24,d>>16&255,d>>8&255,d&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return P.box(P.types.mp4a,P.audioStsd(e),P.box(P.types.esds,P.esds(e)))}static mp3(e){return P.box(P.types[".mp3"],P.audioStsd(e))}static ac3(e){return P.box(P.types["ac-3"],P.audioStsd(e),P.box(P.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return P.box(P.types.stsd,P.STSD,P.mp4a(e));if(t==="ac3"&&e.config)return P.box(P.types.stsd,P.STSD,P.ac3(e));if(t==="mp3"&&e.codec==="mp3")return P.box(P.types.stsd,P.STSD,P.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return P.box(P.types.stsd,P.STSD,P.avc1(e));if(t==="hevc"&&e.vps)return P.box(P.types.stsd,P.STSD,P.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),n=e.width||0,r=e.height||0,a=Math.floor(i/(Ht+1)),o=Math.floor(i%(Ht+1));return P.box(P.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,n&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=P.sdtp(e),n=e.id,r=Math.floor(t/(Ht+1)),a=Math.floor(t%(Ht+1));return P.box(P.types.traf,P.box(P.types.tfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255])),P.box(P.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,a>>24,a>>16&255,a>>8&255,a&255])),P.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,P.box(P.types.trak,P.tkhd(e),P.mdia(e))}static trex(e){const t=e.id;return P.box(P.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],n=i.length,r=12+16*n,a=new Uint8Array(r);let o,l,c,u,d,f;for(t+=8+r,a.set([e.type==="video"?1:0,0,15,1,n>>>24&255,n>>>16&255,n>>>8&255,n&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),o=0;o<n;o++)l=i[o],c=l.duration,u=l.size,d=l.flags,f=l.cts,a.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,d.degradPrio&61440,d.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*o);return P.box(P.types.trun,a)}static initSegment(e){P.types||P.init();const t=P.moov(e);return Qe(P.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],n=4,r=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),n-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let a=r.length;for(let g=0;g<i.length;g+=1){a+=3;for(let y=0;y<i[g].length;y+=1)a+=2+i[g][y].length}const o=new Uint8Array(a);o.set(r,0),a=r.length;const l=i.length-1;for(let g=0;g<i.length;g+=1){o.set(new Uint8Array([32+g|(g===l?128:0),0,i[g].length]),a),a+=3;for(let y=0;y<i[g].length;y+=1)o.set(new Uint8Array([i[g][y].length>>8,i[g][y].length&255]),a),a+=2,o.set(i[g][y],a),a+=i[g][y].length}const c=P.box(P.types.hvcC,o),u=e.width,d=e.height,f=e.pixelRatio[0],p=e.pixelRatio[1];return P.box(P.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,d>>8&255,d&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,P.box(P.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),P.box(P.types.pasp,new Uint8Array([f>>24,f>>16&255,f>>8&255,f&255,p>>24,p>>16&255,p>>8&255,p&255])))}}P.types=void 0,P.HDLR_TYPES=void 0,P.STTS=void 0,P.STSC=void 0,P.STCO=void 0,P.STSZ=void 0,P.VMHD=void 0,P.SMHD=void 0,P.STSD=void 0,P.FTYP=void 0,P.DINF=void 0;const od=9e4;function Zr(s,e,t=1,i=!1){const n=s*e*t;return i?Math.round(n):n}function Xm(s,e,t=1,i=!1){return Zr(s,e,1/t,i)}function zi(s,e=!1){return Zr(s,1e3,1/od,e)}function Zm(s,e=1){return Zr(s,od,1/e)}const e0=10*1e3,t0=1024,i0=1152,s0=1536;let Ii=null,ea=null;function ld(s,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:s?2:1,isNonSync:s?0:1}}}class rn{constructor(e,t,i,n){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.ISGenerated=!1,Ii===null){const a=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Ii=a?parseInt(a[1]):0}if(ea===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);ea=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,n=e.reduce((r,a)=>{let o=a.pts,l=o-r;return l<-4294967296&&(t=!0,o=Ze(o,i),l=o-r),l>0?r:o},i);return t&&this.logger.debug("PTS rollover detected"),n}remux(e,t,i,n,r,a,o,l){let c,u,d,f,p,g,y=r,S=r;const T=e.pid>-1,L=t.pid>-1,w=t.samples.length,x=e.samples.length>0,b=o&&w>0||w>1;if((!T||x)&&(!L||b)||this.ISGenerated||o){if(this.ISGenerated){var _,k,D,R;const J=this.videoTrackConfig;(J&&(t.width!==J.width||t.height!==J.height||((_=t.pixelRatio)==null?void 0:_[0])!==((k=J.pixelRatio)==null?void 0:k[0])||((D=t.pixelRatio)==null?void 0:D[1])!==((R=J.pixelRatio)==null?void 0:R[1]))||!J&&b||this.nextAudioPts===null&&x)&&this.resetInitSegment()}this.ISGenerated||(d=this.generateIS(e,t,r,a));const N=this.isVideoContiguous;let G=-1,ce;if(b&&(G=n0(t.samples),!N&&this.config.forceKeyFrameOnDiscontinuity))if(g=!0,G>0){this.logger.warn(`[mp4-remuxer]: Dropped ${G} out of ${w} video samples due to a missing keyframe`);const J=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(G),t.dropped+=G,S+=(t.samples[0].pts-J)/t.inputTimeScale,ce=S}else G===-1&&(this.logger.warn(`[mp4-remuxer]: No keyframe found out of ${w} video samples`),g=!1);if(this.ISGenerated){if(x&&b){const J=this.getVideoStartPts(t.samples),se=(Ze(e.samples[0].pts,J)-J)/t.inputTimeScale;y+=Math.max(0,se),S+=Math.max(0,-se)}if(x){if(e.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(e,t,r,a)),u=this.remuxAudio(e,y,this.isAudioContiguous,a,L||b||l===re.AUDIO?S:void 0),b){const J=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(e,t,r,a)),c=this.remuxVideo(t,S,N,J)}}else b&&(c=this.remuxVideo(t,S,N,0));c&&(c.firstKeyFrame=G,c.independent=G!==-1,c.firstKeyFramePTS=ce)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(p=cd(i,r,this._initPTS,this._initDTS)),n.samples.length&&(f=ud(n,r,this._initPTS))),{audio:u,video:c,initSegment:d,independent:g,text:f,id3:p}}generateIS(e,t,i,n){const r=e.samples,a=t.samples,o=this.typeSupported,l={},c=this._initPTS;let u=!c||n,d="audio/mp4",f,p,g;if(u&&(f=p=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":o.mpeg?(d="audio/mpeg",e.codec=""):o.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}l.audio={id:"audio",container:d,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):P.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(g=e.inputTimeScale,!c||g!==c.timescale?f=p=r[0].pts-Math.round(g*i):u=!1)}if(t.sps&&t.pps&&a.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:P.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(g=t.inputTimeScale,!c||g!==c.timescale){const y=this.getVideoStartPts(a),S=Math.round(g*i);p=Math.min(p,Ze(a[0].dts,y)-S),f=Math.min(f,y-S)}else u=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:f,timescale:g},this._initDTS={baseTime:p,timescale:g}):f=g=void 0,{tracks:l,initPTS:f,timescale:g}}remuxVideo(e,t,i,n){const r=e.inputTimeScale,a=e.samples,o=[],l=a.length,c=this._initPTS;let u=this.nextAvcDts,d=8,f=this.videoSampleDuration,p,g,y=Number.POSITIVE_INFINITY,S=Number.NEGATIVE_INFINITY,T=!1;if(!i||u===null){const j=t*r,B=a[0].pts-Ze(a[0].dts,a[0].pts);Ii&&u!==null&&Math.abs(j-B-u)<15e3?i=!0:u=j-B}const L=c.baseTime*r/c.timescale;for(let j=0;j<l;j++){const B=a[j];B.pts=Ze(B.pts-L,u),B.dts=Ze(B.dts-L,u),B.dts<a[j>0?j-1:j].dts&&(T=!0)}T&&a.sort(function(j,B){const ee=j.dts-B.dts,Q=j.pts-B.pts;return ee||Q}),p=a[0].dts,g=a[a.length-1].dts;const w=g-p,x=w?Math.round(w/(l-1)):f||e.inputTimeScale/30;if(i){const j=p-u,B=j>x,ee=j<-1;if((B||ee)&&(B?this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${zi(j,!0)} ms (${j}dts) hole between fragments detected at ${t.toFixed(3)}`):this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${zi(-j,!0)} ms (${j}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!ee||u>=a[0].pts||Ii)){p=u;const Q=a[0].pts-j;if(B)a[0].dts=p,a[0].pts=Q;else{let z=!0;for(let h=0;h<a.length&&!(a[h].dts>Q&&z);h++){const v=a[h].pts;if(a[h].dts-=j,a[h].pts-=j,h<a.length-1){const m=a[h+1].pts,I=a[h].pts,A=m<=I,O=m<=v;z=A==O}}}this.logger.log(`Video: Initial PTS/DTS adjusted: ${zi(Q,!0)}/${zi(p,!0)}, delta: ${zi(j,!0)} ms`)}}p=Math.max(0,p);let b=0,C=0,_=p;for(let j=0;j<l;j++){const B=a[j],ee=B.units,Q=ee.length;let z=0;for(let h=0;h<Q;h++)z+=ee[h].data.length;C+=z,b+=Q,B.length=z,B.dts<_?(B.dts=_,_+=x/4|0||1):_=B.dts,y=Math.min(B.pts,y),S=Math.max(B.pts,S)}g=a[l-1].dts;const k=C+4*b+8;let D;try{D=new Uint8Array(k)}catch(j){this.observer.emit(E.ERROR,E.ERROR,{type:Z.MUX_ERROR,details:M.REMUX_ALLOC_ERROR,fatal:!1,error:j,bytes:k,reason:`fail allocating video mdat ${k}`});return}const R=new DataView(D.buffer);R.setUint32(0,k),D.set(P.types.mdat,4);let N=!1,G=Number.POSITIVE_INFINITY,ce=Number.POSITIVE_INFINITY,J=Number.NEGATIVE_INFINITY,ae=Number.NEGATIVE_INFINITY;for(let j=0;j<l;j++){const B=a[j],ee=B.units;let Q=0;for(let v=0,m=ee.length;v<m;v++){const I=ee[v],A=I.data,O=I.data.byteLength;R.setUint32(d,O),d+=4,D.set(A,d),d+=O,Q+=4+O}let z;if(j<l-1)f=a[j+1].dts-B.dts,z=a[j+1].pts-B.pts;else{const v=this.config,m=j>0?B.dts-a[j-1].dts:x;if(z=j>0?B.pts-a[j-1].pts:x,v.stretchShortVideoTrack&&this.nextAudioPts!==null){const I=Math.floor(v.maxBufferHole*r),A=(n?y+n*r:this.nextAudioPts)-B.pts;A>I?(f=A-m,f<0?f=m:N=!0,this.logger.log(`[mp4-remuxer]: It is approximately ${A/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=m}else f=m}const h=Math.round(B.pts-B.dts);G=Math.min(G,f),J=Math.max(J,f),ce=Math.min(ce,z),ae=Math.max(ae,z),o.push(ld(B.key,f,Q,h))}if(o.length){if(Ii){if(Ii<70){const j=o[0].flags;j.dependsOn=2,j.isNonSync=0}}else if(ea&&ae-ce<J-G&&x/J<.025&&o[0].cts===0){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let j=p;for(let B=0,ee=o.length;B<ee;B++){const Q=j+o[B].duration,z=j+o[B].cts;if(B<ee-1){const h=Q+o[B+1].cts;o[B].duration=h-z}else o[B].duration=B?o[B-1].duration:x;o[B].cts=0,j=Q}}}f=N||!f?x:f,this.nextAvcDts=u=g+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const fe={data1:P.moof(e.sequenceNumber++,p,Ie(e,{samples:o})),data2:D,startPTS:y/r,endPTS:(S+f)/r,startDTS:p/r,endDTS:u/r,type:"video",hasAudio:!1,hasVideo:!0,nb:o.length,dropped:e.dropped};return e.samples=[],e.dropped=0,fe}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return i0;case"ac3":return s0;default:return t0}}remuxAudio(e,t,i,n,r){const a=e.inputTimeScale,o=e.samplerate?e.samplerate:a,l=a/o,c=this.getSamplesPerFrame(e),u=c*l,d=this._initPTS,f=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,p=[],g=r!==void 0;let y=e.samples,S=f?0:8,T=this.nextAudioPts||-1;const L=t*a,w=d.baseTime*a/d.timescale;if(this.isAudioContiguous=i=i||y.length&&T>0&&(n&&Math.abs(L-T)<9e3||Math.abs(Ze(y[0].pts-w,L)-T)<20*u),y.forEach(function(se){se.pts=Ze(se.pts-w,L)}),!i||T<0){if(y=y.filter(se=>se.pts>=0),!y.length)return;r===0?T=0:n&&!g?T=Math.max(0,L):T=y[0].pts}if(e.segmentCodec==="aac"){const se=this.config.maxAudioFramesDrift;for(let q=0,fe=T;q<y.length;q++){const j=y[q],B=j.pts,ee=B-fe,Q=Math.abs(1e3*ee/a);if(ee<=-se*u&&g)q===0&&(this.logger.warn(`Audio frame @ ${(B/a).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*ee/a)} ms.`),this.nextAudioPts=T=fe=B);else if(ee>=se*u&&Q<e0&&g){let z=Math.round(ee/u);fe=B-z*u,fe<0&&(z--,fe+=u),q===0&&(this.nextAudioPts=T=fe),this.logger.warn(`[mp4-remuxer]: Injecting ${z} audio frame @ ${(fe/a).toFixed(3)}s due to ${Math.round(1e3*ee/a)} ms gap.`);for(let h=0;h<z;h++){const v=Math.max(fe,0);let m=Qm.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);m||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),m=j.unit.subarray()),y.splice(q,0,{unit:m,pts:v}),fe+=u,q++}}j.pts=fe,fe+=u}}let x=null,b=null,C,_=0,k=y.length;for(;k--;)_+=y[k].unit.byteLength;for(let se=0,q=y.length;se<q;se++){const fe=y[se],j=fe.unit;let B=fe.pts;if(b!==null){const Q=p[se-1];Q.duration=Math.round((B-b)/l)}else if(i&&e.segmentCodec==="aac"&&(B=T),x=B,_>0){_+=S;try{C=new Uint8Array(_)}catch(Q){this.observer.emit(E.ERROR,E.ERROR,{type:Z.MUX_ERROR,details:M.REMUX_ALLOC_ERROR,fatal:!1,error:Q,bytes:_,reason:`fail allocating audio mdat ${_}`});return}f||(new DataView(C.buffer).setUint32(0,_),C.set(P.types.mdat,4))}else return;C.set(j,S);const ee=j.byteLength;S+=ee,p.push(ld(!0,c,ee,0)),b=B}const D=p.length;if(!D)return;const R=p[p.length-1];this.nextAudioPts=T=b+l*R.duration;const N=f?new Uint8Array(0):P.moof(e.sequenceNumber++,x/l,Ie({},e,{samples:p}));e.samples=[];const G=x/a,ce=T/a,ae={data1:N,data2:C,startPTS:G,endPTS:ce,startDTS:G,endDTS:ce,type:"audio",hasAudio:!0,hasVideo:!1,nb:D};return this.isAudioContiguous=!0,ae}}function Ze(s,e){let t;if(e===null)return s;for(e<s?t=-8589934592:t=8589934592;Math.abs(s-e)>4294967296;)s+=t;return s}function n0(s){for(let e=0;e<s.length;e++)if(s[e].key)return e;return-1}function cd(s,e,t,i){const n=s.samples.length;if(!n)return;const r=s.inputTimeScale;for(let o=0;o<n;o++){const l=s.samples[o];l.pts=Ze(l.pts-t.baseTime*r/t.timescale,e*r)/r,l.dts=Ze(l.dts-i.baseTime*r/i.timescale,e*r)/r}const a=s.samples;return s.samples=[],{samples:a}}function ud(s,e,t){const i=s.samples.length;if(!i)return;const n=s.inputTimeScale;for(let a=0;a<i;a++){const o=s.samples[a];o.pts=Ze(o.pts-t.baseTime*n/t.timescale,e*n)/n}s.samples.sort((a,o)=>a.pts-o.pts);const r=s.samples;return s.samples=[],{samples:r}}class r0{constructor(e,t,i,n){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.logger=n}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,i,n){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(Vp(e,n)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const n=this.initData=tu(e);n.audio&&(t=dd(n.audio,Fe.AUDIO)),n.video&&(i=dd(n.video,Fe.VIDEO));const r={};n.audio&&n.video?r.audiovideo={container:"video/mp4",codec:t+","+i,supplemental:n.video.supplemental,initSegment:e,id:"main"}:n.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:n.video?r.video={container:"video/mp4",codec:i,supplemental:n.video.supplemental,initSegment:e,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,n,r,a){var o,l;let{initPTS:c,lastEndTime:u}=this;const d={audio:void 0,video:void 0,text:n,id3:i,initSegment:void 0};K(u)||(u=this.lastEndTime=r||0);const f=t.samples;if(!(f!=null&&f.length))return d;const p={initPTS:void 0,timescale:1};let g=this.initData;if((o=g)!=null&&o.length||(this.generateInitSegment(f),g=this.initData),!((l=g)!=null&&l.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),d;this.emitInitSegment&&(p.tracks=this.initTracks,this.emitInitSegment=!1);const y=Hp(f,g),S=qp(g,f),T=S===null?r:S;(a||!c)&&(a0(c,T,r,y)||p.timescale!==c.timescale)&&(p.initPTS=T-r,c&&c.timescale===1&&this.logger.warn(`Adjusting initPTS @${r} from ${c.baseTime/c.timescale} to ${p.initPTS}`),this.initPTS=c={baseTime:p.initPTS,timescale:1});const L=e?T-c.baseTime/c.timescale:u,w=L+y;Yp(g,f,c.baseTime/c.timescale),y>0?this.lastEndTime=w:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const x=!!g.audio,b=!!g.video;let C="";x&&(C+="audio"),b&&(C+="video");const _={data1:f,startPTS:L,startDTS:L,endPTS:w,endDTS:w,type:C,hasAudio:x,hasVideo:b,nb:1,dropped:0};return d.audio=_.type==="audio"?_:void 0,d.video=_.type!=="audio"?_:void 0,d.initSegment=p,d.id3=cd(i,r,c,c),n.samples.length&&(d.text=ud(n,r,c)),d}}function a0(s,e,t,i){if(s===null)return!0;const n=Math.max(i,1),r=e-s.baseTime/s.timescale;return Math.abs(r-t)>n}function dd(s,e){const t=s==null?void 0:s.codec;return t&&t.length>4?t:e===Fe.AUDIO?t==="ec-3"||t==="ac-3"||t==="alac"?t:t==="fLaC"||t==="Opus"?Cr(t,!1):(ye.warn(`Unhandled audio codec "${t}" in mp4 MAP`),t||"mp4a"):(ye.warn(`Unhandled video codec "${t}" in mp4 MAP`),t||"avc1")}let Pt;try{Pt=self.performance.now.bind(self.performance)}catch{Pt=Date.now}const an=[{demux:Ym,remux:r0},{demux:qt,remux:rn},{demux:Vm,remux:rn},{demux:Hm,remux:rn}];an.splice(2,0,{demux:qm,remux:rn});class hd{constructor(e,t,i,n,r,a){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=r,this.logger=a}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,n){const r=i.transmuxing;r.executeStart=Pt();let a=new Uint8Array(e);const{currentTransmuxState:o,transmuxConfig:l}=this;n&&(this.currentTransmuxState=n);const{contiguous:c,discontinuity:u,trackSwitch:d,accurateTimeOffset:f,timeOffset:p,initSegmentChange:g}=n||o,{audioCodec:y,videoCodec:S,defaultInitPts:T,duration:L,initSegmentData:w}=l,x=o0(a,t);if(x&&bi(x.method)){const k=this.getDecrypter(),D=Mr(x.method);if(k.isSync()){let R=k.softwareDecrypt(a,x.key.buffer,x.iv.buffer,D);if(i.part>-1){const G=k.flush();R=G&&G.buffer}if(!R)return r.executeEnd=Pt(),ta(i);a=new Uint8Array(R)}else return this.asyncResult=!0,this.decryptionPromise=k.webCryptoDecrypt(a,x.key.buffer,x.iv.buffer,D).then(R=>{const N=this.push(R,null,i);return this.decryptionPromise=null,N}),this.decryptionPromise}const b=this.needsProbing(u,d);if(b){const k=this.configureTransmuxer(a);if(k)return this.logger.warn(`[transmuxer] ${k.message}`),this.observer.emit(E.ERROR,E.ERROR,{type:Z.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,fatal:!1,error:k,reason:k.message}),r.executeEnd=Pt(),ta(i)}(u||d||g||b)&&this.resetInitSegment(w,y,S,L,t),(u||g||b)&&this.resetInitialTimestamp(T),c||this.resetContiguity();const C=this.transmux(a,x,p,f,i);this.asyncResult=on(C);const _=this.currentTransmuxState;return _.contiguous=!0,_.discontinuity=!1,_.trackSwitch=!1,r.executeEnd=Pt(),C}flush(e){const t=e.transmuxing;t.executeStart=Pt();const{decrypter:i,currentTransmuxState:n,decryptionPromise:r}=this;if(r)return this.asyncResult=!0,r.then(()=>this.flush(e));const a=[],{timeOffset:o}=n;if(i){const d=i.flush();d&&a.push(this.push(d.buffer,null,e))}const{demuxer:l,remuxer:c}=this;if(!l||!c){t.executeEnd=Pt();const d=[ta(e)];return this.asyncResult?Promise.resolve(d):d}const u=l.flush(o);return on(u)?(this.asyncResult=!0,u.then(d=>(this.flushRemux(a,d,e),a))):(this.flushRemux(a,u,e),this.asyncResult?Promise.resolve(a):a)}flushRemux(e,t,i){const{audioTrack:n,videoTrack:r,id3Track:a,textTrack:o}=t,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===re.MAIN?"level":"track"} ${i.level}`);const u=this.remuxer.remux(n,r,a,o,c,l,!0,this.id);e.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=Pt()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,n,r){const{demuxer:a,remuxer:o}=this;!a||!o||(a.resetInitSegment(e,t,i,n),o.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,n,r){let a;return t&&t.method==="SAMPLE-AES"?a=this.transmuxSampleAes(e,t,i,n,r):a=this.transmuxUnencrypted(e,i,n,r),a}transmuxUnencrypted(e,t,i,n){const{audioTrack:r,videoTrack:a,id3Track:o,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,a,o,l,t,i,!1,this.id),chunkMeta:n}}transmuxSampleAes(e,t,i,n,r){return this.demuxer.demuxSampleAes(e,t,i).then(a=>({remuxResult:this.remuxer.remux(a.audioTrack,a.videoTrack,a.id3Track,a.textTrack,i,n,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:n}=this;let r;for(let d=0,f=an.length;d<f;d++){var a;if((a=an[d].demux)!=null&&a.probe(e,this.logger)){r=an[d];break}}if(!r)return new Error("Failed to find demuxer by probing fragment data");const o=this.demuxer,l=this.remuxer,c=r.remux,u=r.demux;(!l||!(l instanceof c))&&(this.remuxer=new c(i,t,n,this.logger)),(!o||!(o instanceof u))&&(this.demuxer=new u(i,t,n,this.logger),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Or(this.config)),e}}function o0(s,e){let t=null;return s.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const ta=s=>({remuxResult:{},chunkMeta:s});function on(s){return"then"in s&&s.then instanceof Function}class l0{constructor(e,t,i,n,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=n,this.defaultInitPts=r||null}}class c0{constructor(e,t,i,n,r,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=r,this.initSegmentChange=a}}let fd=0;class u0{constructor(e,t,i,n){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=fd++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=l=>{const c=l.data,u=this.hls;if(!(!u||!(c!=null&&c.event)||c.instanceNo!==this.instanceNo))switch(c.event){case"init":{var d;const f=(d=this.workerContext)==null?void 0:d.objectURL;f&&self.URL.revokeObjectURL(f);break}case"transmuxComplete":{this.handleTransmuxComplete(c.data);break}case"flush":{this.onFlush(c.data);break}case"workerLog":{u.logger[c.data.logType]&&u.logger[c.data.logType](c.data.message);break}default:{c.data=c.data||{},c.data.frag=this.frag,c.data.part=this.part,c.data.id=this.id,u.trigger(c.event,c.data);break}}},this.onWorkerError=l=>{if(!this.hls)return;const c=new Error(`${l.message}  (${l.filename}:${l.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(E.ERROR,{type:Z.OTHER_ERROR,details:M.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:c})};const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=n;const a=(l,c)=>{c=c||{},c.frag=this.frag||void 0,l===E.ERROR&&(c=c,c.parent=this.id,c.part=this.part,this.error=c.error),this.hls.trigger(l,c)};this.observer=new Vu,this.observer.on(E.FRAG_DECRYPTED,a),this.observer.on(E.ERROR,a);const o=lu(r.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const l=this.hls.logger;if(r.workerPath||dm()){try{r.workerPath?(l.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=fm(r.workerPath)):(l.log(`injecting Web Worker for "${t}"`),this.workerContext=hm());const{worker:u}=this.workerContext;u.addEventListener("message",this.onWorkerMessage),u.addEventListener("error",this.onWorkerError),u.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:o,id:t,config:Le(r)})}catch(u){l.warn(`Error setting up "${t}" Web Worker, fallback to inline`,u),this.terminateWorker(),this.error=null,this.transmuxer=new hd(this.observer,o,r,"",t,e.logger)}return}}this.transmuxer=new hd(this.observer,o,r,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=fd++;const t=this.hls.config,i=lu(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:Le(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),pm(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,n,r,a,o,l,c,u){var d,f;c.transmuxing.start=self.performance.now();const{instanceNo:p,transmuxer:g}=this,y=a?a.start:r.start,S=r.decryptdata,T=this.frag,L=!(T&&r.cc===T.cc),w=!(T&&c.level===T.level),x=T?c.sn-T.sn:-1,b=this.part?c.part-this.part.index:-1,C=x===0&&c.id>1&&c.id===(T==null?void 0:T.stats.chunkCount),_=!w&&(x===1||x===0&&(b===1||C&&b<=0)),k=self.performance.now();(w||x||r.stats.parsing.start===0)&&(r.stats.parsing.start=k),a&&(b||!_)&&(a.stats.parsing.start=k);const D=!(T&&((d=r.initSegment)==null?void 0:d.url)===((f=T.initSegment)==null?void 0:f.url)),R=new c0(L,_,l,w,y,D);if(!_||L||D){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${r.type} sn: ${c.sn}${c.part>-1?" part: "+c.part:""} ${this.id===re.MAIN?"level":"track"}: ${c.level} id: ${c.id}
        discontinuity: ${L}
        trackSwitch: ${w}
        contiguous: ${_}
        accurateTimeOffset: ${l}
        timeOffset: ${y}
        initSegmentChange: ${D}`);const N=new l0(i,n,t,o,u);this.configureTransmuxer(N)}if(this.frag=r,this.part=a,this.workerContext)this.workerContext.worker.postMessage({instanceNo:p,cmd:"demux",data:e,decryptdata:S,chunkMeta:c,state:R},e instanceof ArrayBuffer?[e]:[]);else if(g){const N=g.push(e,S,c,R);on(N)?N.then(G=>{this.handleTransmuxComplete(G)}).catch(G=>{this.transmuxerError(G,c,"transmuxer-interface push error")}):this.handleTransmuxComplete(N)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const n=i.flush(e);on(n)?n.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")}):this.handleFlushResult(n,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(E.ERROR,{type:Z.MEDIA_ERROR,details:M.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const pd=100;class d0 extends $u{constructor(e,t,i){super(e,t,i,"audio-stream-controller",re.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(E.LEVEL_LOADED,this.onLevelLoaded,this),e.on(E.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(E.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(E.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(E.BUFFER_RESET,this.onBufferReset,this),e.on(E.BUFFER_CREATED,this.onBufferCreated,this),e.on(E.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(E.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(E.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(E.FRAG_LOADING,this.onFragLoading,this),e.on(E.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(E.LEVEL_LOADED,this.onLevelLoaded,this),e.off(E.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(E.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(E.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(E.BUFFER_RESET,this.onBufferReset,this),e.off(E.BUFFER_CREATED,this.onBufferCreated,this),e.off(E.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(E.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(E.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(E.FRAG_LOADING,this.onFragLoading,this),e.off(E.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:r}){if(i===re.MAIN){const a=t.cc,o=this.fragCurrent;if(this.initPTS[a]={baseTime:n,timescale:r},this.log(`InitPTS for cc: ${a} found from main: ${n}/${r}`),this.mainAnchor=t,this.state===$.WAITING_INIT_PTS){const l=this.waitingData;(!l&&!this.loadingParts||l&&l.frag.cc!==a)&&(this.nextLoadPosition=this.findSyncFrag(t).start),this.tick()}else!this.hls.hasEnoughToStart&&o&&o.cc!==a?(this.startFragRequested=!1,this.nextLoadPosition=this.findSyncFrag(t).start,o.abortRequests(),this.resetLoadingState()):this.state===$.IDLE&&this.tick()}}findSyncFrag(e){const t=this.getLevelDetails(),i=e.cc;return Ag(t,i,e)||t&&Eu(t.fragments,i)||e}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=$.STOPPED;return}const i=this.lastCurrentTime;this.stopLoad(),this.setInterval(pd),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=$.IDLE):this.state=$.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case $.IDLE:this.doTickIdle();break;case $.WAITING_TRACK:{const{levels:t,trackId:i}=this,n=t==null?void 0:t[i],r=n==null?void 0:n.details;if(r&&!this.waitForLive(n)){if(this.waitForCdnTuneIn(r))break;this.state=$.WAITING_INIT_PTS}break}case $.FRAG_LOADING_WAITING_RETRY:{var e;const t=performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:n,trackId:r}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((n==null?void 0:n[r])||null),this.state=$.IDLE}break}case $.WAITING_INIT_PTS:{const t=this.waitingData;if(t){const{frag:i,part:n,cache:r,complete:a}=t,o=this.mainAnchor;if(this.initPTS[i.cc]!==void 0){this.waitingData=null,this.state=$.FRAG_LOADING;const l=r.flush().buffer,c={frag:i,part:n,payload:l,networkDetails:null};this._handleFragmentLoadProgress(c),a&&super._handleFragmentLoadComplete(c)}else o&&o.cc!==t.frag.cc&&(this.log(`Waiting fragment cc (${i.cc}) cancelled because video is at cc ${o.cc}`),this.nextLoadPosition=this.findSyncFrag(o).start,this.clearWaitingFragment())}else this.state=$.IDLE}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.state!==$.STOPPED&&(this.state=$.IDLE))}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:n,trackId:r}=this,a=t.config;if(!this.buffering||!n&&!this.primaryPrefetch&&(this.startFragRequested||!a.startFragPrefetch)||!(i!=null&&i[r]))return;const o=i[r],l=o.details;if(!l||this.waitForLive(o)||this.waitForCdnTuneIn(l)){this.state=$.WAITING_TRACK,this.startFragRequested=!1;return}const c=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&c&&(this.bufferFlushed=!1,this.afterBufferFlushed(c,Fe.AUDIO,re.AUDIO));const u=this.getFwdBufferInfo(c,re.AUDIO);if(u===null)return;if(!this.switchingTrack&&this._streamEnded(u,l)){t.trigger(E.BUFFER_EOS,{type:"audio"}),this.state=$.ENDED;return}const d=u.len,f=t.maxBufferLength,p=l.fragments,g=p[0].start,y=this.getLoadPosition(),S=this.flushing?y:u.end;if(this.switchingTrack&&n){const w=y;l.PTSKnown&&w<g&&(u.end>g||u.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=g+.05)}if(d>=f&&!this.switchingTrack&&S<p[p.length-1].start)return;let T=this.getNextFragment(S,l);if(T&&this.isLoopLoading(T,S)&&(T=this.getNextFragmentLoopLoading(T,l,u,re.MAIN,f)),!T){this.bufferFlushed=!0;return}let L=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&L&&Ye(T)&&!T.endList&&(!l.live||!this.loadingParts&&S<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(L)===Xe.OK&&(this.mainFragLoading=L=null),L&&Ye(L))){if(T.start>L.end){const x=this.fragmentTracker.getFragAtPos(S,re.MAIN);x&&x.end>L.end&&(L=x,this.mainFragLoading={frag:x,targetBufferTime:null})}if(T.start>L.end)return}this.loadFragment(T,o,S)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new Vs(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:n}=this;n&&(n.abortRequests(),this.removeUnbufferedFrags(n.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==$.STOPPED&&(this.setInterval(pd),this.state=$.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(E.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:n}=this,{details:r,id:a,groupId:o,track:l}=t;if(!n){this.warn(`Audio tracks reset while loading track ${a} "${l.name}" of "${o}"`);return}const c=this.mainDetails;if(!c||r.endCC>c.endCC||c.expired){this.cachedTrackLoadedData=t,this.state!==$.STOPPED&&(this.state=$.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${a} "${l.name}" of "${o}" loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const u=n[a];let d=0;if(r.live||(i=u.details)!=null&&i.live){if(this.checkLiveUpdate(r),r.deltaUpdateFailed)return;if(u.details){var f;d=this.alignPlaylists(r,u.details,(f=this.levelLastLoaded)==null?void 0:f.details)}r.alignedSliding||(Bu(r,c),r.alignedSliding||Xs(r,c),d=r.fragmentStart)}u.details=r,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(c,d),this.hls.trigger(E.AUDIO_TRACK_UPDATED,{details:r,id:a,groupId:t.groupId}),this.state===$.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=$.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:r}=e,{config:a,trackId:o,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const c=l[o];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const u=c.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const d=a.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let f=this.transmuxer;f||(f=this.transmuxer=new u0(this.hls,re.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const p=this.initPTS[i.cc],g=(t=i.initSegment)==null?void 0:t.data;if(p!==void 0){const S=n?n.index:-1,T=S!==-1,L=new Iu(i.level,i.sn,i.stats.chunkCount,r.byteLength,S,T);f.push(r,g,d,"",i,n,u.totalduration,!1,L,p)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${o}`);const{cache:y}=this.waitingData=this.waitingData||{frag:i,part:n,cache:new om,complete:!1};y.push(new Uint8Array(r)),this.state!==$.STOPPED&&(this.state=$.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===re.MAIN&&Ye(t.frag)&&(this.mainFragLoading=t,this.state===$.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:i,part:n}=t;if(i.type!==re.AUDIO){!this.audioOnly&&i.type===re.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(Ye(i)){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(E.AUDIO_TRACK_SWITCHED,xe({},r)))}this.fragBufferedComplete(i,n),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=$.ERROR;return}switch(t.details){case M.FRAG_GAP:case M.FRAG_PARSING_ERROR:case M.FRAG_DECRYPT_ERROR:case M.FRAG_LOAD_ERROR:case M.FRAG_LOAD_TIMEOUT:case M.KEY_LOAD_ERROR:case M.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(re.AUDIO,t);break;case M.AUDIO_TRACK_LOAD_ERROR:case M.AUDIO_TRACK_LOAD_TIMEOUT:case M.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===$.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===Ct.AUDIO_TRACK&&(this.state=$.IDLE);break;case M.BUFFER_ADD_CODEC_ERROR:case M.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.resetLoadingState();break;case M.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case M.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==Fe.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==Fe.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===$.ENDED&&(this.state=$.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,re.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:n}=this,{remuxResult:r,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}const{frag:l,part:c,level:u}=o,{details:d}=u,{audio:f,text:p,id3:g,initSegment:y}=r;if(this.fragContextChanged(l)||!d){this.fragmentTracker.removeFragment(l);return}if(this.state=$.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),y!=null&&y.tracks){const S=l.initSegment||l;this._bufferInitSegment(u,y.tracks,S,a),n.trigger(E.FRAG_PARSING_INIT_SEGMENT,{frag:S,id:i,tracks:y.tracks})}if(f){const{startPTS:S,endPTS:T,startDTS:L,endDTS:w}=f;c&&(c.elementaryStreams[Fe.AUDIO]={startPTS:S,endPTS:T,startDTS:L,endDTS:w}),l.setElementaryStreamInfo(Fe.AUDIO,S,T,L,w),this.bufferFragmentData(f,l,c,a)}if(g!=null&&(t=g.samples)!=null&&t.length){const S=Ie({id:i,frag:l,details:d},g);n.trigger(E.FRAG_PARSING_METADATA,S)}if(p){const S=Ie({id:i,frag:l,details:d},p);n.trigger(E.FRAG_PARSING_USERDATA,S)}}_bufferInitSegment(e,t,i,n){if(this.state!==$.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const r=t.audio;r.id=re.AUDIO;const a=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${a}/${r.codec}]`),a&&a.split(",").length===1&&(r.levelCodec=a),this.hls.trigger(E.BUFFER_CODECS,t);const o=r.initSegment;if(o!=null&&o.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:n,parent:i.type,data:o};this.hls.trigger(E.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);if(this.switchingTrack||n===Xe.NOT_LOADED||n===Xe.PARTIAL){var r;if(!Ye(e))this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=$.WAITING_INIT_PTS;const a=this.mainDetails;a&&a.fragmentStart!==t.details.fragmentStart&&Xs(t.details,a)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:o}=this.bufferedTrack;oi({name:t,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:o},e,li)||(vu(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(E.AUDIO_TRACK_SWITCHED,xe({},e))}}class gd extends Rt{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const n=t==null?void 0:t.renditionReports;if(n){let r=-1;for(let a=0;a<n.length;a++){const o=n[a];let l;try{l=new self.URL(o.URI,t.url).href}catch(c){this.warn(`Could not construct new URL for Rendition Report: ${c}`),l=o.URI||""}if(l===e){r=a;break}else l===e.substring(0,l.length)&&(r=a)}if(r!==-1){const a=n[r],o=parseInt(a["LAST-MSN"])||(t==null?void 0:t.lastPartSn);let l=parseInt(a["LAST-PART"])||(t==null?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const u=Math.min(t.age-t.partTarget,t.targetduration);l>=0&&u>t.partTarget&&(l+=1)}const c=i&&fu(i);return new pu(o,l>=0?l:void 0,c)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){const{details:n,stats:r}=t,a=self.performance.now(),o=r.loading.first?Math.max(0,a-r.loading.first):0;n.advancedDateTime=Date.now()-o;const l=this.hls.config.timelineOffset;if(l!==n.appliedTimelineOffset){const u=Math.max(l||0,0);n.appliedTimelineOffset=u,n.fragments.forEach(d=>{d.start=d.playlistOffset+u})}if(n.live||i!=null&&i.live){const u="levelInfo"in t?t.levelInfo:t.track;if(n.reloaded(i),i&&n.fragments.length>0){Xg(i,n);const L=n.playlistParsingError;if(L){this.warn(L);const w=this.hls;if(!w.config.ignorePlaylistParsingErrors){var c;const{networkDetails:x}=t;w.trigger(E.ERROR,{type:Z.NETWORK_ERROR,details:M.LEVEL_PARSING_ERROR,fatal:!1,url:n.url,error:L,reason:L.message,level:t.level||void 0,parent:(c=n.fragments[0])==null?void 0:c.type,networkDetails:x,stats:r});return}n.playlistParsingError=null}}n.requestScheduled===-1&&(n.requestScheduled=r.loading.start);const d=this.hls.mainForwardBufferInfo,f=d?d.end-d.len:0,p=(n.edge-f)*1e3,g=im(n,p);if(n.requestScheduled+g<a?n.requestScheduled=a:n.requestScheduled+=g,this.log(`live playlist ${e} ${n.advanced?"REFRESHED "+n.lastPartSn+"-"+n.lastPartIndex:n.updated?"UPDATED":"MISSED"}`),!this.canLoad||!n.live)return;let y,S,T;if(n.canBlockReload&&n.endSN&&n.advanced){const L=this.hls.config.lowLatencyMode,w=n.lastPartSn,x=n.endSN,b=n.lastPartIndex,C=b!==-1,_=w===x;C?_?(S=x+1,T=L?0:b):(S=w,T=L?b+1:n.maxPartIndex):S=x+1;const k=n.age,D=k+n.ageHeader;let R=Math.min(D-n.partTarget,n.targetduration*1.5);if(R>0){if(D>n.targetduration*3)this.log(`Playlist last advanced ${k.toFixed(2)}s ago. Omitting segment and part directives.`),S=void 0,T=void 0;else if(i!=null&&i.tuneInGoal&&D-n.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${R} with playlist age: ${n.age}`),R=0;else{const N=Math.floor(R/n.targetduration);if(S+=N,T!==void 0){const G=Math.round(R%n.targetduration/n.partTarget);T+=G}this.log(`CDN Tune-in age: ${n.ageHeader}s last advanced ${k.toFixed(2)}s goal: ${R} skip sn ${N} to part ${T}`)}n.tuneInGoal=R}if(y=this.getDeliveryDirectives(n,t.deliveryDirectives,S,T),L||!_){n.requestScheduled=a,this.loadingPlaylist(u,y);return}}else(n.canBlockReload||n.canSkipUntil)&&(y=this.getDeliveryDirectives(n,t.deliveryDirectives,S,T));y&&S!==void 0&&n.canBlockReload&&(n.requestScheduled=r.loading.first+Math.max(g-o*2,g/2)),this.scheduleLoading(u,y,n)}else this.clearTimer()}scheduleLoading(e,t,i){const n=i||e.details;if(!n){this.loadingPlaylist(e,t);return}const r=self.performance.now(),a=n.requestScheduled;if(r>=a){this.loadingPlaylist(e,t);return}const o=a-r;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(o)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),o)}getDeliveryDirectives(e,t,i,n){let r=fu(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,n=t.part,r=Gs.No),new pu(i,n,r)}checkRetry(e){const t=e.details,i=qs(e),n=e.errorAction,{action:r,retryCount:a=0,retryConfig:o}=n||{},l=!!n&&!!o&&(r===Ne.RetryRequest||!n.resolved&&r===Ne.SendAlternateToPenaltyBox);if(l){var c;if(a>=o.maxNumRetry)return!1;if(i&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const u=Dr(o,a);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" in ${u}ms`)}e.levelRetry=!0,n.resolved=!0}return l}}function md(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!Ji(s[t].attrs,e[t].attrs))return!1;return!0}function Ji(s,e,t){const i=s["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(n=>s[n]!==e[n])}function ia(s,e){return e.label.toLowerCase()===s.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(s.lang||"").toLowerCase())}class h0 extends gd{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.LEVEL_LOADING,this.onLevelLoading,this),e.on(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(E.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.LEVEL_LOADING,this.onLevelLoading,this),e.off(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(E.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(E.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:n,details:r}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==n){this.warn(`Audio track with id:${i} and group:${n} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Audio track ${i} "${a.name}" lang:${a.lang} group:${n} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,n=this.groupIds;let r=this.currentTrack;if(!i||(n==null?void 0:n.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(n==null?void 0:n.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(f=>!i||i.indexOf(f.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(f=>f.default)&&(this.selectDefaultTrack=!1),o.forEach((f,p)=>{f.id=p});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const l=this.hls.config.audioPreference;if(!r&&l){const f=vt(l,o,li);if(f>-1)r=o[f];else{const p=vt(l,this.tracks);r=this.tracks[p]}}let c=this.findTrackId(r);c===-1&&r&&(c=this.findTrackId(null));const u={audioTracks:o};this.log(`Updating audio tracks, ${o.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(E.AUDIO_TRACKS_UPDATED,u);const d=this.trackId;if(c!==-1&&d===-1)this.setAudioTrack(c);else if(o.length&&d===-1){var a;const f=new Error(`No audio track selected for current audio group-ID(s): ${(a=this.groupIds)==null?void 0:a.join(",")} track count: ${o.length}`);this.warn(f.message),this.hls.trigger(E.ERROR,{type:Z.MEDIA_ERROR,details:M.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:f})}}}onError(e,t){t.fatal||!t.context||t.context.type===Ct.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const n=this.currentTrack;if(n&&oi(e,n,li))return n;const r=vt(e,this.tracksInGroup,li);if(r>-1){const a=this.tracksInGroup[r];return this.setAudioTrack(r),a}else if(n){let a=t.loadLevel;a===-1&&(a=t.firstAutoLevel);const o=Eg(e,t.levels,i,a,li);if(o===-1)return null;t.nextLoadLevel=o}if(e.channels||e.audioCodec){const a=vt(e,i);if(a>-1)return i[a]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e],r=n.details&&!n.details.live;if(e===this.trackId&&n===i&&r||(this.log(`Switching to audio-track ${e} "${n.name}" lang:${n.lang} group:${n.groupId} channels:${n.channels}`),this.trackId=e,this.currentTrack=n,this.hls.trigger(E.AUDIO_TRACK_SWITCHING,xe({},n)),r))return;const a=this.switchParams(n.url,i==null?void 0:i.details,n.details);this.loadPlaylist(a)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(!(this.selectDefaultTrack&&!n.default)&&(!e||oi(e,n,li)))return i}if(e){const{name:i,lang:n,assocLang:r,characteristics:a,audioCodec:o,channels:l}=e;for(let c=0;c<t.length;c++){const u=t[c];if(oi({name:i,lang:n,assocLang:r,characteristics:a,audioCodec:o,channels:l},u,li))return c}for(let c=0;c<t.length;c++){const u=t[c];if(Ji(e.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<t.length;c++){const u=t[c];if(Ji(e.attrs,u.attrs,["LANGUAGE"]))return c}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&vu(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,r=this.getUrlWithDirectives(e.url,t),a=e.details,o=a==null?void 0:a.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${n}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${o&&a.live?" age "+o.toFixed(1)+(a.type&&" "+a.type||""):""} ${r}`),this.hls.trigger(E.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:n,deliveryDirectives:t||null,track:e})}}class f0{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;const n=this.queues[t];n.push(e),n.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const n=t[0];try{n.execute()}catch(r){var i;if(n.onError(r),this.queues===null||this.tracks===null)return;const a=(i=this.tracks[e])==null?void 0:i.buffer;a!=null&&a.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=(t=this.tracks)==null?void 0:t[e],n=i==null?void 0:i.buffer;return n?`SourceBuffer${n.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}}const yd=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,vd="HlsJsTrackRemovedError";class p0 extends Error{constructor(e){super(e),this.name=vd}}class g0 extends Rt{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var n;this.hls&&((n=this.mediaSource)==null?void 0:n.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{const{media:n,mediaSource:r}=this;i&&this.log("Media source opened"),!(!n||!r)&&(r.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(E.MEDIA_ATTACHED,{media:n,mediaSource:r}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:n}=this;i!==n&&this.error(`Media element src was set while attaching MediaSource (${n} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=Mp(Vi(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.BUFFER_RESET,this.onBufferReset,this),e.on(E.BUFFER_APPENDING,this.onBufferAppending,this),e.on(E.BUFFER_CODECS,this.onBufferCodecs,this),e.on(E.BUFFER_EOS,this.onBufferEos,this),e.on(E.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(E.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(E.FRAG_PARSED,this.onFragParsed,this),e.on(E.FRAG_CHANGED,this.onFragChanged,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.BUFFER_RESET,this.onBufferReset,this),e.off(E.BUFFER_APPENDING,this.onBufferAppending,this),e.off(E.BUFFER_CODECS,this.onBufferCodecs,this),e.off(E.BUFFER_EOS,this.onBufferEos,this),e.off(E.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(E.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(E.FRAG_PARSED,this.onFragParsed,this),e.off(E.FRAG_CHANGED,this.onFragChanged,this),e.off(E.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const r=this.isUpdating();r||this.operationQueue.removeBlockers();const a=this.isQueued();(r||a)&&this.warn(`Transfering MediaSource with${a?" operations in queue":""}${r?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const n=this.transferData;return!this.sourceBufferCount&&n&&n.mediaSource===t?Ie(i,n.tracks):this.sourceBuffers.forEach(r=>{const[a]=r;a&&(i[a]=Ie({},this.tracks[a]),this.removeBuffer(a)),r[0]=r[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsTotal=n,this.log(`${n} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&n&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media,n=Vi(this.appendSource);if(this.transferData=this.overrides=void 0,i&&n){const r=!!t.mediaSource;(r||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const a=this.mediaSource=t.mediaSource||new n;if(this.assignMediaSource(a),r)this._objectUrl=i.src,this.attachTransferred();else{const o=this._objectUrl=self.URL.createObjectURL(a);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&a instanceof l,Sd(i),m0(i,o),i.load()}catch{i.src=o}else i.src=o}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,n=t.tracks,r=n?Object.keys(n):null,a=r?r.length:0,o=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(n&&r&&a){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${Le(i,(l,c)=>l==="initSegment"?void 0:c)};
transfer tracks: ${Le(n,(l,c)=>l==="initSegment"?void 0:c)}}`),!zc(n,i)){t.mediaSource=null,t.tracks=void 0;const l=e.currentTime,c=this.details,u=Math.max(l,(c==null?void 0:c.fragments[0].start)||0);if(u-l>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${l} -> ${u}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(n)}"->"${Object.keys(i)}") start time: ${u} currentTime: ${l}`),this.onMediaDetaching(E.MEDIA_DETACHING,{}),this.onMediaAttaching(E.MEDIA_ATTACHING,t),e.currentTime=u;return}this.transferData=void 0,r.forEach(l=>{const c=l,u=n[c];if(u){const d=u.buffer;if(d){const f=this.fragmentTracker,p=u.id;if(f.hasFragments(p)||f.hasParts(p)){const S=be.getBuffered(d);f.detectEvictedFragments(c,S,p,null,!0)}const g=sa(c),y=[c,d];this.sourceBuffers[g]=y,d.updating&&this.operationQueue&&this.operationQueue.prependBlocker(c),this.trackSourceBuffer(c,u)}}}),o(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),o()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:n,mediaSource:r,_objectUrl:a}=this;if(r){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([o])=>{o&&this.removeBuffer(o)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const o=r.readyState==="open";try{const l=r.sourceBuffers;for(let c=l.length;c--;)o&&l[c].abort(),r.removeSourceBuffer(l[c]);o&&r.endOfStream()}catch(l){this.warn(`onMediaDetaching: ${l.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(r.removeEventListener("startstreaming",this._onStartStreaming),r.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}n&&(n.removeEventListener("emptied",this._onMediaEmptied),i||(a&&self.URL.revokeObjectURL(a),this.mediaSrc===a?(n.removeAttribute("src"),this.appendSource&&Sd(n),n.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(E.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var n;(n=this.mediaSource)!=null&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(r){this.warn(`onBufferReset ${e}`,r)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[sa(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new f0(this.tracks)}onBufferCodecs(e,t){const i=this.tracks,n=Object.keys(t);this.log(`BUFFER_CODECS: "${n}" (current SB count ${this.sourceBufferCount})`);const r="audiovideo"in t&&(i.audio||i.video)||i.audiovideo&&("audio"in t||"video"in t),a=!r&&this.sourceBufferCount&&this.media&&n.some(o=>!i[o]);if(r||a){this.warn(`Unsupported transition between "${Object.keys(i)}" and "${n}" SourceBuffers`);return}n.forEach(o=>{var l,c,u;const d=t[o],{id:f,codec:p,levelCodec:g,container:y,metadata:S,supplemental:T}=d;let L=i[o];const w=(l=this.transferData)==null||(c=l.tracks)==null?void 0:c[o],x=w!=null&&w.buffer?w:L,b=(x==null?void 0:x.pendingCodec)||(x==null?void 0:x.codec),C=x==null?void 0:x.levelCodec;L||(L=i[o]={buffer:void 0,listeners:[],codec:p,supplemental:T,container:y,levelCodec:g,metadata:S,id:f});const _=Rr(b,C),k=_==null?void 0:_.replace(yd,"$1");let D=Rr(p,g);const R=(u=D)==null?void 0:u.replace(yd,"$1");D&&_&&k!==R&&(o.slice(0,5)==="audio"&&(D=Cr(D,this.appendSource)),this.log(`switching codec ${b} to ${D}`),D!==(L.pendingCodec||L.codec)&&(L.pendingCodec=D),L.container=y,this.appendChangeType(o,y,D))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const n=`${t};codecs=${i}`,r={label:`change-type=${n}`,execute:()=>{const a=this.tracks[e];if(a){const o=a.buffer;o!=null&&o.changeType&&(this.log(`changing ${e} sourceBuffer type to ${n}`),o.changeType(n),a.codec=i,a.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn(`Failed to change ${e} SourceBuffer type`,a)}};this.append(r,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,n=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,re.MAIN))==null?void 0:t.gap)===!0)return;const a={label:"block-audio",execute:()=>{var o;const l=this.tracks.video;(this.lastVideoAppendEnd>n||l!=null&&l.buffer&&be.isBuffered(l.buffer,n)||((o=this.fragmentTracker.getAppendedFrag(n,re.MAIN))==null?void 0:o.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn("Error executing block-audio operation",o)}};this.blockedAudioAppend={op:a,frag:e},this.append(a,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:n,type:r,parent:a,frag:o,part:l,chunkMeta:c}=t,u=c.buffering[r],d=o.sn,f=self.performance.now();u.start=f;const p=o.stats.buffering,g=l?l.stats.buffering:null;p.start===0&&(p.start=f),g&&g.start===0&&(g.start=f);const y=i.audio;let S=!1;r==="audio"&&(y==null?void 0:y.container)==="audio/mpeg"&&(S=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const T=this.tracks.video,L=T==null?void 0:T.buffer;if(L&&d!=="initSegment"){const b=l||o,C=this.blockedAudioAppend;if(r==="audio"&&a!=="main"&&!this.blockedAudioAppend){const k=b.start+b.duration*.05,D=L.buffered,R=this.currentOp("video");!D.length&&!R?this.blockAudio(b):!R&&!be.isBuffered(L,k)&&this.lastVideoAppendEnd<k&&this.blockAudio(b)}else if(r==="video"){const _=b.end;if(C){const k=C.frag.start;(_>k||_<this.lastVideoAppendEnd||be.isBuffered(L,k))&&this.unblockAudio()}this.lastVideoAppendEnd=_}}const w=(l||o).start,x={label:`append-${r}`,execute:()=>{if(u.executeStart=self.performance.now(),S){const b=this.tracks[r];if(b){const C=b.buffer;if(C){const _=w-C.timestampOffset;Math.abs(_)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${w} (delta: ${_}) sn: ${d})`),C.timestampOffset=w)}}}this.appendExecutor(n,r)},onStart:()=>{},onComplete:()=>{const b=self.performance.now();u.executeEnd=u.end=b,p.first===0&&(p.first=b),g&&g.first===0&&(g.first=b);const C={};this.sourceBuffers.forEach(([_,k])=>{_&&(C[_]=be.getBuffered(k))}),this.appendErrors[r]=0,r==="audio"||r==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(E.BUFFER_APPENDED,{type:r,frag:o,part:l,chunkMeta:c,parent:o.type,timeRanges:C})},onError:b=>{var C;const _={type:Z.MEDIA_ERROR,parent:o.type,details:M.BUFFER_APPEND_ERROR,sourceBufferName:r,frag:o,part:l,chunkMeta:c,error:b,err:b,fatal:!1},k=(C=this.media)==null?void 0:C.error;if(b.code===DOMException.QUOTA_EXCEEDED_ERR)_.details=M.BUFFER_FULL_ERROR;else if(b.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!k)_.errorAction=qi(!0);else if(b.name===vd&&this.sourceBufferCount===0)_.errorAction=qi(!0);else{const D=++this.appendErrors[r];this.warn(`Failed ${D}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${r}" sourceBuffer (${k||"no media error"})`),(D>=this.hls.config.appendErrorMaxRetry||k)&&(_.fatal=!0)}this.hls.trigger(E.ERROR,_)}};this.append(x,r,this.isPending(this.tracks[r]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(E.BUFFER_FLUSHED,{type:e})},onError:n=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,n)}}}onBufferFlushing(e,t){const{type:i,startOffset:n,endOffset:r}=t;i?this.append(this.getFlushOp(i,n,r),i):this.sourceBuffers.forEach(([a])=>{a&&this.append(this.getFlushOp(a,n,r),a)})}onFragParsed(e,t){const{frag:i,part:n}=t,r=[],a=n?n.elementaryStreams:i.elementaryStreams;a[Fe.AUDIOVIDEO]?r.push("audiovideo"):(a[Fe.AUDIO]&&r.push("audio"),a[Fe.VIDEO]&&r.push("video"));const o=()=>{const l=self.performance.now();i.stats.buffering.end=l,n&&(n.stats.buffering.end=l);const c=n?n.stats:i.stats;this.hls.trigger(E.FRAG_BUFFERED,{frag:i,part:n,stats:c,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(o,r).catch(l=>{this.warn(`Fragment buffered callback ${l}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t,i;return e&&(!((t=this.tracks[e])!=null&&t.ended)||((i=this.tracks[e])==null?void 0:i.ending))})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([a])=>{if(a){const o=this.tracks[a];(!t.type||t.type===a)&&(o.ending=!0,o.ended||(o.ended=!0,this.log(`${a} buffer reached EOS`)))}});const n=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([a])=>{var o;return a&&!((o=this.tracks[a])!=null&&o.ended)})&&(n?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:a}=this;if(!a||a.readyState!=="open"){a&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${a.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),a.endOfStream(),this.hls.trigger(E.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(E.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){const e=this.getDurationAndRange();e&&this.blockUntilOpen(()=>this.updateMediaSource(e))}onError(e,t){if(t.details===M.BUFFER_APPEND_ERROR&&t.frag){var i;const n=(i=t.errorAction)==null?void 0:i.nextAutoLevel;K(n)&&n!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;const n=e.config,r=i.currentTime,a=t.levelTargetDuration,o=t.live&&n.liveBackBufferLength!==null?n.liveBackBufferLength:n.backBufferLength;if(K(o)&&o>=0){const l=Math.max(o,a),c=Math.floor(r/a)*a-l;this.flushBackBuffer(r,a,c)}if(K(n.frontBufferFlushThreshold)&&n.frontBufferFlushThreshold>0){const l=Math.max(n.maxBufferLength,n.frontBufferFlushThreshold),c=Math.max(l,a),u=Math.floor(r/a)*a+c;this.flushFrontBuffer(r,a,u)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([n,r])=>{if(r){const o=be.getBuffered(r);if(o.length>0&&i>o.start(0)){var a;this.hls.trigger(E.BACK_BUFFER_REACHED,{bufferEnd:i});const l=this.tracks[n];if((a=this.details)!=null&&a.live)this.hls.trigger(E.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l!=null&&l.ended){this.log(`Cannot flush ${n} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(E.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:n})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([n,r])=>{if(r){const a=be.getBuffered(r),o=a.length;if(o<2)return;const l=a.start(o-1),c=a.end(o-1);if(i>l||e>=l&&e<=c)return;this.hls.trigger(E.BUFFER_FLUSHING,{startOffset:l,endOffset:1/0,type:n})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||(i==null?void 0:i.readyState)!=="open")return null;const n=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&t.live&&i.setLiveSeekableRange){const c=Math.max(0,t.fragmentStart),u=Math.max(c,n);return{duration:1/0,start:c,end:u}}return{duration:1/0}}const r=(e=this.overrides)==null?void 0:e.duration;if(r)return K(r)?{duration:r}:null;const a=this.media.duration,o=K(i.duration)?i.duration:0;return n>o&&n>a||!K(a)?{duration:n}:null}updateMediaSource({duration:e,start:t,end:i}){const n=this.mediaSource;!this.media||!n||n.readyState!=="open"||(n.duration!==e&&(K(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),n.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${n.duration}. Setting seekable range to ${t}-${i}.`),n.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${Le(i)}`),this.tracksReady){var n;const r=(n=this.transferData)==null?void 0:n.tracks;r&&Object.keys(r).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const n=this.tracks[t];e[t]={buffer:i,container:n.container,codec:n.codec,supplemental:n.supplemental,levelCodec:n.levelCodec,id:n.id,metadata:n.metadata}}}),this.hls.trigger(E.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(E.ERROR,{type:Z.MEDIA_ERROR,details:M.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const r in e){const a=r,o=e[a];if(this.isPending(o)){const l=this.getTrackCodec(o,a),c=`${o.container};codecs=${l}`;o.codec=l,this.log(`creating sourceBuffer(${c})${this.currentOp(a)?" Queued":""} ${Le(o)}`);try{const u=i.addSourceBuffer(c),d=sa(a),f=[a,u];t[d]=f,o.buffer=u}catch(u){var n;this.error(`error while trying to add sourceBuffer: ${u.message}`),this.shiftAndExecuteNext(a),(n=this.operationQueue)==null||n.removeBlockers(),delete this.tracks[a],this.hls.trigger(E.ERROR,{type:Z.MEDIA_ERROR,details:M.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:u,sourceBufferName:a,mimeType:c,parent:o.id});return}this.trackSourceBuffer(a,o)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let n=e.codec;i&&(t==="video"||t==="audiovideo")&&ig(i,"video")&&(n=rg(n,i));const r=Rr(n,e.levelCodec);return r?t.slice(0,5)==="audio"?Cr(r,this.appendSource):r:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const n=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:n,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(r,a)=>{const o=a.removedRanges;o!=null&&o.length&&this.hls.trigger(E.BUFFER_FLUSHED,{type:r})})}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i==null?void 0:i.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const n=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${n}`,t),this.hls.trigger(E.ERROR,{type:Z.MEDIA_ERROR,details:M.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});const r=this.currentOp(e);r&&r.onError(n)}removeExecutor(e,t,i){const{media:n,mediaSource:r}=this,a=this.tracks[e],o=a==null?void 0:a.buffer;if(!n||!r||!o){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const l=K(n.duration)?n.duration:1/0,c=K(r.duration)?r.duration:1/0,u=Math.max(0,t),d=Math.min(i,l,c);d>u&&(!a.ending||a.ended)?(a.ended=!1,this.log(`Removing [${u},${d}] from the ${e} SourceBuffer`),o.remove(u,d)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],n=i==null?void 0:i.buffer;if(!n)throw new p0(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,n.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,n=t.map(a=>this.appendBlocker(a));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(n).then(a=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;const n=(i=this.tracks[t])==null?void 0:i.buffer;!n||n.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const n=this.tracks[e];if(!n)return;const r=n.buffer;if(!r)return;const a=i.bind(this,e);n.listeners.push({event:t,listener:a}),r.addEventListener(t,a)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(n=>{i.removeEventListener(n.event,n.listener)}),t.listeners.length=0)}}function Sd(s){const e=s.querySelectorAll("source");[].slice.call(e).forEach(t=>{s.removeChild(t)})}function m0(s,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,s.appendChild(t)}function sa(s){return s==="audio"?1:0}class na{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(E.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(E.BUFFER_CODECS,this.onBufferCodecs,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(E.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(E.BUFFER_CODECS,this.onBufferCodecs,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&K(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((n,r)=>this.isLevelAllowed(n)&&r<=e);return this.clientRect=null,na.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const n=(o,l)=>l?o.width!==l.width||o.height!==l.height:!0;let r=e.length-1;const a=Math.max(t,i);for(let o=0;o<e.length;o+=1){const l=e[o];if((l.width>=a||l.height>=a)&&n(l,e[o+1])){r=o;break}}return r}}const Ve={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},y0={HLS:"h"},Qi={OBJECT:"CMCD-Object",REQUEST:"CMCD-Request",SESSION:"CMCD-Session",STATUS:"CMCD-Status"},v0={[Qi.OBJECT]:["br","d","ot","tb"],[Qi.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[Qi.SESSION]:["cid","pr","sf","sid","st","v"],[Qi.STATUS]:["bs","rtp"]};class wi{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof wi?i:new wi(i))),this.value=e,this.params=t}}const S0="Dict";function E0(s){return Array.isArray(s)?JSON.stringify(s):s instanceof Map?"Map{}":s instanceof Set?"Set{}":typeof s=="object"?JSON.stringify(s):String(s)}function T0(s,e,t,i){return new Error(`failed to ${s} "${E0(e)}" as ${t}`,{cause:i})}function Et(s,e,t){return T0("serialize",s,e,t)}class Ed{constructor(e){this.description=e}}const Td="Bare Item",b0="Boolean";function _0(s){if(typeof s!="boolean")throw Et(s,b0);return s?"?1":"?0"}const x0="Byte Sequence";function A0(s){if(ArrayBuffer.isView(s)===!1)throw Et(s,x0);return`:${xm(s)}:`}const I0="Integer";function w0(s){return s<-999999999999999||999999999999999<s}function bd(s){if(w0(s))throw Et(s,I0);return s.toString()}function L0(s){return`@${bd(s.getTime()/1e3)}`}const k0="Decimal";function C0(s){const e=Ju(s,3);if(Math.floor(Math.abs(e)).toString().length>12)throw Et(s,k0);const t=e.toString();return t.includes(".")?t:`${t}.0`}const R0="String",P0=/[\x00-\x1f\x7f]+/;function D0(s){if(P0.test(s))throw Et(s,R0);return`"${s.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function O0(s){return s.description||s.toString().slice(7,-1)}const M0="Token";function _d(s){const e=O0(s);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw Et(e,M0);return e}function ra(s){switch(typeof s){case"number":if(!K(s))throw Et(s,Td);return Number.isInteger(s)?bd(s):C0(s);case"string":return D0(s);case"symbol":return _d(s);case"boolean":return _0(s);case"object":if(s instanceof Date)return L0(s);if(s instanceof Uint8Array)return A0(s);if(s instanceof Ed)return _d(s);default:throw Et(s,Td)}}const F0="Key";function aa(s){if(/^[a-z*][a-z0-9\-_.*]*$/.test(s)===!1)throw Et(s,F0);return s}function oa(s){return s==null?"":Object.entries(s).map(([e,t])=>t===!0?`;${aa(e)}`:`;${aa(e)}=${ra(t)}`).join("")}function xd(s){return s instanceof wi?`${ra(s.value)}${oa(s.params)}`:ra(s)}function N0(s){return`(${s.value.map(xd).join(" ")})${oa(s.params)}`}function U0(s,e={whitespace:!0}){if(typeof s!="object")throw Et(s,S0);const t=s instanceof Map?s.entries():Object.entries(s),i=e!=null&&e.whitespace?" ":"";return Array.from(t).map(([n,r])=>{r instanceof wi||(r=new wi(r));let a=aa(n);return r.value===!0?a+=oa(r.params):(a+="=",Array.isArray(r.value)?a+=N0(r):a+=xd(r)),a}).join(`,${i}`)}function B0(s,e){return U0(s,e)}function $0(s){return s==="ot"||s==="sf"||s==="st"}function j0(s){return typeof s=="number"?K(s):s!=null&&s!==""&&s!==!1}const ln=s=>Math.round(s),G0=(s,e)=>(e!=null&&e.baseUrl&&(s=Am(s,e.baseUrl)),encodeURIComponent(s)),cn=s=>ln(s/100)*100,V0={br:ln,d:ln,bl:cn,dl:cn,mtp:cn,nor:G0,rtp:cn,tb:ln};function q0(s,e){const t={};if(s==null||typeof s!="object")return t;const i=Object.keys(s).sort(),n=Ie({},V0,e==null?void 0:e.formatters),r=e==null?void 0:e.filter;return i.forEach(a=>{if(r!=null&&r(a))return;let o=s[a];const l=n[a];l&&(o=l(o,e)),!(a==="v"&&o===1)&&(a=="pr"&&o===1||j0(o)&&($0(a)&&typeof o=="string"&&(o=new Ed(o)),t[a]=o))}),t}function Ad(s,e={}){return s?B0(q0(s,e),Ie({whitespace:!1},e)):""}function H0(s,e={}){const t={};if(!s)return t;const i=Object.entries(s),n=Object.entries(v0).concat(Object.entries((e==null?void 0:e.customHeaderMap)||{})),r=i.reduce((a,o)=>{var l,c;const[u,d]=o,f=((l=n.find(p=>p[1].includes(u)))===null||l===void 0?void 0:l[0])||Qi.REQUEST;return(c=a[f])!==null&&c!==void 0||(a[f]={}),a[f][u]=d,a},{});return Object.entries(r).reduce((a,[o,l])=>(a[o]=Ad(l,e),a),t)}function K0(s,e,t){return Ie(s,H0(e,t))}const Y0="CMCD";function W0(s,e={}){if(!s)return"";const t=Ad(s,e);return`${Y0}=${encodeURIComponent(t)}`}const Id=/CMCD=[^&#]+/;function z0(s,e,t){const i=W0(e,t);if(!i)return s;if(Id.test(s))return s.replace(Id,i);const n=s.includes("?")?"&":"?";return`${s}${n}${i}`}class J0{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=n=>{try{this.apply(n,{ot:Ve.MANIFEST,su:!this.initialized})}catch(r){this.hls.logger.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=n=>{try{const{frag:r,part:a}=n,o=this.hls.levels[r.level],l=this.getObjectType(r),c={d:(a||r).duration*1e3,ot:l};(l===Ve.VIDEO||l===Ve.AUDIO||l==Ve.MUXED)&&(c.br=o.bitrate/1e3,c.tb=this.getTopBandwidth(l)/1e3,c.bl=this.getBufferLength(l));const u=a?this.getNextPart(a):this.getNextFrag(r);u!=null&&u.url&&u.url!==r.url&&(c.nor=u.url),this.apply(n,c)}catch(r){this.hls.logger.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(E.MEDIA_DETACHED,this.onMediaDetached,this),e.on(E.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(E.MEDIA_DETACHED,this.onMediaDetached,this),e.off(E.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,n;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(n=t.tracks.video)==null?void 0:n.buffer}createData(){var e;return{v:1,sf:y0.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){Ie(t,this.createData());const i=t.ot===Ve.INIT||t.ot===Ve.VIDEO||t.ot===Ve.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:n}=this;n&&(t=Object.keys(t).reduce((a,o)=>(n.includes(o)&&(a[o]=t[o]),a),{}));const r={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),K0(e.headers,t,r)):e.url=z0(e.url,t,r)}getNextFrag(e){var t;const i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){const n=e.sn-i.startSN;return i.fragments[n+1]}}getNextPart(e){var t,i;const{index:n,fragment:r}=e,a=(t=this.hls.levels[r.level])==null||(i=t.details)==null?void 0:i.partList;if(a){const{sn:o}=r;for(let l=a.length-1;l>=0;l--){const c=a[l];if(c.index===n&&c.fragment.sn===o)return a[l+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return Ve.TIMED_TEXT;if(e.sn==="initSegment")return Ve.INIT;if(t==="audio")return Ve.AUDIO;if(t==="main")return this.hls.audioTracks.length?Ve.VIDEO:Ve.MUXED}getTopBandwidth(e){let t=0,i;const n=this.hls;if(e===Ve.AUDIO)i=n.audioTracks;else{const r=n.maxAutoLevel,a=r>-1?r+1:n.levels.length;i=n.levels.slice(0,a)}for(const r of i)r.bitrate>t&&(t=r.bitrate);return t>0?t:NaN}getBufferLength(e){const t=this.media,i=e===Ve.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:be.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,a,o){t(r),this.loader.load(r,a,o)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,a,o){t(r),this.loader.load(r,a,o)}}}}const Q0=3e5;class X0 extends Rt{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===Ne.SendAlternateToPenaltyBox&&i.flags===ct.MoveAllAlternatesMatchingHost){const n=this.levels;let r=this._pathwayPriority,a=this.pathwayId;if(t.context){const{groupId:o,pathwayId:l,type:c}=t.context;o&&n?a=this.getPathwayForGroupId(o,c,a):l&&(a=l)}a in this.penalizedPathways||(this.penalizedPathways[a]=performance.now()),!r&&n&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==a),i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${a} levels: ${n&&n.length} priorities: ${Le(r)} penalized: ${Le(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const i=this.penalizedPathways,n=performance.now();Object.keys(i).forEach(r=>{n-i[r]>Q0&&delete i[r]});for(let r=0;r<e.length;r++){const a=e[r];if(a in i)continue;if(a===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(t=this.getLevelsForPathway(a),t.length>0){this.log(`Setting Pathway to "${a}"`),this.pathwayId=a,sm(t),this.hls.trigger(E.LEVELS_UPDATED,{levels:t});const c=this.hls.levels[o];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=o);break}}}getPathwayForGroupId(e,t,i){const n=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<n.length;r++)if(t===Ct.AUDIO_TRACK&&n[r].hasAudioGroup(e)||t===Ct.SUBTITLE_TRACK&&n[r].hasSubtitleGroup(e))return n[r].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},n={};e.forEach(r=>{const{ID:a,"BASE-ID":o,"URI-REPLACEMENT":l}=r;if(t.some(u=>u.pathwayId===a))return;const c=this.getLevelsForPathway(o).map(u=>{const d=new Hi(u.attrs);d["PATHWAY-ID"]=a;const f=d.AUDIO&&`${d.AUDIO}_clone_${a}`,p=d.SUBTITLES&&`${d.SUBTITLES}_clone_${a}`;f&&(i[d.AUDIO]=f,d.AUDIO=f),p&&(n[d.SUBTITLES]=p,d.SUBTITLES=p);const g=Ld(u.uri,d["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),y=new Vs({attrs:d,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:g,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let S=1;S<u.audioGroups.length;S++)y.addGroupId("audio",`${u.audioGroups[S]}_clone_${a}`);if(u.subtitleGroups)for(let S=1;S<u.subtitleGroups.length;S++)y.addGroupId("text",`${u.subtitleGroups[S]}_clone_${a}`);return y});t.push(...c),wd(this.audioTracks,i,l,a),wd(this.subtitleTracks,n,l,a)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let n;try{n=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(n.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;n.searchParams.set("_HLS_pathway",this.pathwayId),n.searchParams.set("_HLS_throughput",""+u)}const r={responseType:"json",url:n.href},a=t.steeringManifestLoadPolicy.default,o=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(u,d,f,p)=>{this.log(`Loaded steering manifest: "${n}"`);const g=u.data;if((g==null?void 0:g.VERSION)!==1){this.log(`Steering VERSION ${g.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=g.TTL;const{"RELOAD-URI":y,"PATHWAY-CLONES":S,"PATHWAY-PRIORITY":T}=g;if(y)try{this.uri=new self.URL(y,n).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${y}`);return}this.scheduleRefresh(this.uri||f.url),S&&this.clonePathways(S);const L={steeringManifest:g,url:n.toString()};this.hls.trigger(E.STEERING_MANIFEST_LOADED,L),T&&this.updatePathwayPriority(T)},onError:(u,d,f,p)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${d.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${d.url} no longer available`);return}let g=this.timeToLoad*1e3;if(u.code===429){const y=this.loader;if(typeof(y==null?void 0:y.getResponseHeader)=="function"){const S=y.getResponseHeader("Retry-After");S&&(g=parseFloat(S)*1e3)}this.log(`Steering manifest ${d.url} rate limited`);return}this.scheduleRefresh(this.uri||d.url,g)},onTimeout:(u,d,f)=>{this.log(`Timeout loading steering manifest (${d.url})`),this.scheduleRefresh(this.uri||d.url)}};this.log(`Requesting steering manifest: ${n}`),this.loader.load(r,l,c)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const n=(i=this.hls)==null?void 0:i.media;if(n&&!n.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function wd(s,e,t,i){s&&Object.keys(e).forEach(n=>{const r=s.filter(a=>a.groupId===n).map(a=>{const o=Ie({},a);return o.details=void 0,o.attrs=new Hi(o.attrs),o.url=o.attrs.URI=Ld(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),o.groupId=o.attrs["GROUP-ID"]=e[n],o.attrs["PATHWAY-ID"]=i,o});s.push(...r)})}function Ld(s,e,t,i){const{HOST:n,PARAMS:r,[t]:a}=i;let o;e&&(o=a==null?void 0:a[e],o&&(s=o));const l=new self.URL(s);return n&&!o&&(l.host=n),r&&Object.keys(r).sort().forEach(c=>{c&&l.searchParams.set(c,r[c])}),l.href}class Li extends Rt{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=Li.CDMCleanupPromise?[Li.CDMCleanupPromise]:[],this.onMediaEncrypted=t=>{const{initDataType:i,initData:n}=t,r=`"${t.type}" event: init data type: "${i}"`;if(this.debug(r),n!==null){if(!this.keyFormatPromise){let a=Object.keys(this.keySystemAccessPromises);a.length||(a=zs(this.config));const o=a.map($r).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(o)}this.keyFormatPromise.then(a=>{const o=Ur(a);let l,c;if(i==="sinf"){if(o!==ge.FAIRPLAY){this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${i}" for selected key-system ${o}`);return}const g=Ce(new Uint8Array(n));try{const y=Fr(JSON.parse(g).sinf),S=iu(y);if(!S)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=new Uint8Array(S.subarray(8,24)),c=ge.FAIRPLAY}catch(y){this.warn(`${r} Failed to parse sinf: ${y}`);return}}else{if(o!==ge.WIDEVINE&&o!==ge.PLAYREADY){this.warn(`Ignoring unexpected "${t.type}" event with init data type: "${i}" for selected key-system ${o}`);return}const g=Zp(n),y=g.filter(T=>!!T.systemId&&Br(T.systemId)===o);y.length>1&&this.warn(`${r} Using first of ${y.length} pssh found for selected key-system ${o}`);const S=y[0];if(!S){g.length===0||g.some(T=>!T.systemId)?this.warn(`${r} contains incomplete or invalid pssh data`):this.log(`ignoring ${r} for ${g.map(T=>Br(T.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(c=Br(S.systemId),S.version===0&&S.data)if(c===ge.WIDEVINE){const T=S.data.length-22;l=new Uint8Array(S.data.subarray(T,T+16))}else c===ge.PLAYREADY&&(l=Cu(S.data))}if(!c||!l)return;const u=gt.hexDump(l),{keyIdToKeySessionPromise:d,mediaKeySessions:f}=this;let p=d[u];for(let g=0;g<f.length;g++){const y=f[g],S=y.decryptdata;if(!S.keyId)continue;const T=gt.hexDump(S.keyId);if(u===T||S.uri.replace(/-/g,"").indexOf(u)!==-1){if(p=d[T],S.pssh)break;delete d[T],S.pssh=new Uint8Array(n),S.keyId=l,p=d[u]=p.then(()=>this.generateRequestWithPreferredKeySession(y,i,n,"encrypted-event-key-match")),p.catch(L=>this.handleError(L));break}}if(!p){if(c!==o){this.log(`Ignoring "${t.type}" event with ${c} init data for selected key-system ${o}`);return}p=d[u]=this.getKeySystemSelectionPromise([c]).then(({keySystem:g,mediaKeys:y})=>{var S;this.throwIfDestroyed();const T=new Qs("ISO-23001-7",u,(S=$r(g))!=null?S:"");return T.pssh=new Uint8Array(n),T.keyId=l,this.attemptSetMediaKeys(g,y).then(()=>{this.throwIfDestroyed();const L=this.createMediaKeySessionContext({decryptdata:T,keySystem:g,mediaKeys:y});return this.generateRequestWithPreferredKeySession(L,i,n,"encrypted-event-no-match")})}),p.catch(g=>this.handleError(g))}})}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){const e=this.media;this.unregisterListeners(),this.onMediaDetached(),this._clear(e);const t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(E.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(E.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(E.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(E.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(E.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(E.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,n=t[e];if(n)return n.licenseUrl;if(e===ge.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(a,o,l)=>!!a&&l.indexOf(a)===o,n=t.map(a=>a.audioCodec).filter(i),r=t.map(a=>a.videoCodec).filter(i);return n.length+r.length===0&&r.push("avc1.42e01e"),new Promise((a,o)=>{const l=c=>{const u=c.shift();this.getMediaKeysPromise(u,n,r).then(d=>a({keySystem:u,mediaKeys:d})).catch(d=>{c.length?l(c):d instanceof et?o(d):o(new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_NO_ACCESS,error:d,fatal:!0},d.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let n=`Configured requestMediaKeySystemAccess is not a function ${i}`;return ku===null&&self.location.protocol==="http:"&&(n=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(n))}return i(e,t)}getMediaKeysPromise(e,t,i){const n=Hg(e,t,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[e];let a=r==null?void 0:r.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${Le(n)}`),a=this.requestMediaKeySystemAccess(e,n);const o=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const c=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),o.mediaKeys=l.createMediaKeys().then(u=>(this.log(`Media-keys created for "${e}"`),c.then(d=>d?this.setMediaKeysServerCertificate(u,e,d):u))),o.mediaKeys.catch(u=>{this.error(`Failed to create media-keys for "${e}"}: ${u}`)}),o.mediaKeys})}return a.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${gt.hexDump(e.keyId||[])}`);const n=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:n,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),n=this.getKeyIdString(t),r="cenc";this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(i,r,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return gt.hexDump(e.keyId)}updateKeySession(e,t){var i;const n=e.mediaKeysSession;return this.log(`Updating key-session "${n.sessionId}" for keyID ${gt.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),n.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise((t,i)=>{const n=zs(this.config),r=e.map(Ur).filter(a=>!!a&&n.indexOf(a)!==-1);return this.getKeySystemSelectionPromise(r).then(({keySystem:a})=>{const o=$r(a);o?t(o):i(new Error(`Unable to find format for key-system "${a}"`))}).catch(i)})}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),n=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${n}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.getKeySystemForKeyPromise(t).then(({keySystem:o,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${n}`),this.attemptSetMediaKeys(o,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:o,mediaKeys:l,decryptdata:t}))))),(this.keyIdToKeySessionPromise[i]=r.then(o=>{const l="cenc",c=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(o,l,c,"playlist-key")})).catch(o=>this.handleError(o))),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof et?this.hls.trigger(E.ERROR,e.data):this.hls.trigger(E.ERROR,{type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const n=Ur(e.keyFormat),r=n?[n]:zs(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=zs(this.config)),e.length===0)throw new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${Le({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const n=Promise.all(i).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(n),n.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(n),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,n){var r,a;const o=(r=this.config.drmSystems)==null||(a=r[e.keySystem])==null?void 0:a.generateRequest;if(o)try{const g=o.call(this.hls,t,i,e);if(!g)throw new Error("Invalid response from configured generateRequest filter");t=g.initDataType,i=g.initData?g.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(g){var l;if(this.warn(g.message),(l=this.hls)!=null&&l.config.debug)throw g}if(i===null)return this.log(`Skipping key-session request for "${n}" (no initData)`),Promise.resolve(e);const c=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${n}": ${c} (init data type: ${t} length: ${i?i.byteLength:null})`);const u=new Vu,d=e._onmessage=g=>{const y=e.mediaKeysSession;if(!y){u.emit("error",new Error("invalid state"));return}const{messageType:S,message:T}=g;this.log(`"${S}" message event for session "${y.sessionId}" message size: ${T.byteLength}`),S==="license-request"||S==="license-renewal"?this.renewLicense(e,T).catch(L=>{u.eventNames().length?u.emit("error",L):this.handleError(L)}):S==="license-release"?e.keySystem===ge.FAIRPLAY&&(this.updateKeySession(e,Nr("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${S}"`)},f=e._onkeystatuseschange=g=>{if(!e.mediaKeysSession){u.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const S=e.keyStatus;u.emit("keyStatus",S),S==="expired"&&(this.warn(`${e.keySystem} expired for key ${c}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",d),e.mediaKeysSession.addEventListener("keystatuseschange",f);const p=new Promise((g,y)=>{u.on("error",y),u.on("keyStatus",S=>{S.startsWith("usable")?g():S==="output-restricted"?y(new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):S==="internal-error"?y(new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${S}"`)):S==="expired"?y(new Error("key expired while generating request")):this.warn(`unhandled key status change "${S}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var g;this.log(`Request generated for key-session "${(g=e.mediaKeysSession)==null?void 0:g.sessionId}" keyId: ${c}`)}).catch(g=>{throw new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_NO_SESSION,error:g,fatal:!1},`Error generating key-session request: ${g}`)}).then(()=>p).catch(g=>{throw u.removeAllListeners(),this.removeSession(e),g}).then(()=>(u.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{if(typeof i=="string"&&typeof t=="object"){const n=i;i=t,t=n}this.log(`key status change "${t}" for keyStatuses keyId: ${gt.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${gt.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,n=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((a,o)=>{const l={responseType:"arraybuffer",url:r},c=t.certLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(f,p,g,y)=>{a(f.data)},onError:(f,p,g,y)=>{o(new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:g,response:xe({url:l.url,data:void 0},f)},`"${e}" certificate request failed (${r}). Status: ${f.code} (${f.text})`))},onTimeout:(f,p,g)=>{o(new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:g,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(f,p,g)=>{o(new Error("aborted"))}};n.load(l,u,d)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((n,r)=>{e.setServerCertificate(i).then(a=>{this.log(`setServerCertificate ${a?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${t}"`),n(e)}).catch(a=>{r(new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:a,fatal:!0},a.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(n=>{throw new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:n,fatal:!0},n.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const n=new DOMParser().parseFromString(i,"application/xml"),r=n.querySelectorAll("HttpHeader");if(r.length>0){let u;for(let d=0,f=r.length;d<f;d++){var a,o;u=r[d];const p=(a=u.querySelector("name"))==null?void 0:a.textContent,g=(o=u.querySelector("value"))==null?void 0:o.textContent;p&&g&&e.setRequestHeader(p,g)}}const l=n.querySelector("Challenge"),c=l==null?void 0:l.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return Nr(atob(c))}setupLicenseXHR(e,t,i,n){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,n)}).catch(a=>{if(!i.decryptdata)throw a;return e.open("POST",t,!0),r.call(this.hls,e,t,i,n)}).then(a=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:a||n})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:n}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((n,r)=>{const a=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${a}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let l=o.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,o,a,e)}catch(u){this.error(u)}n(l)}else{const l=i.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||o.status>=400&&o.status<500)r(new et({type:Z.KEY_SYSTEM_ERROR,details:M.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:a,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${a}). Status: ${o.status} (${o.statusText})`));else{const u=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(e,t).then(n,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,this.setupLicenseXHR(o,a,e,t).then(({xhr:l,licenseChallenge:c})=>{e.keySystem==ge.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c)})})}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,i.removeEventListener("encrypted",this.onMediaEncrypted),i.removeEventListener("waitingforkey",this.onWaitingForKey),i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null)}_clear(e){var t;const i=this.mediaKeySessions;this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Qs.clearKeyUriToKeyIdMap();const n=i.length;Li.CDMCleanupPromise=Promise.all(i.map(r=>this.removeSession(r)).concat(e==null||(t=e.setMediaKeys(null))==null?void 0:t.catch(r=>{var a;this.log(`Could not clear media keys: ${r}`),(a=this.hls)==null||a.trigger(E.ERROR,{type:Z.OTHER_ERROR,details:M.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${r}`)})}))).then(()=>{n&&(this.log("finished closing key sessions and clearing media keys"),i.length=0)}).catch(r=>{var a;this.log(`Could not close sessions and clear media keys: ${r}`),(a=this.hls)==null||a.trigger(E.ERROR,{type:Z.OTHER_ERROR,details:M.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${r}`)})})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((n,r)=>(n.indexOf(r.keyFormat)===-1&&n.push(r.keyFormat),n),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const n=this.mediaKeySessions.indexOf(e);n>-1&&this.mediaKeySessions.splice(n,1);const{drmSystemOptions:r}=this.config;return(Yg(r)?new Promise((o,l)=>{self.setTimeout(()=>l(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(o)}):Promise.resolve()).catch(o=>{var l;this.log(`Could not remove session: ${o}`),(l=this.hls)==null||l.trigger(E.ERROR,{type:Z.OTHER_ERROR,details:M.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${o}`)})}).then(()=>t.close()).catch(o=>{var l;this.log(`Could not close session: ${o}`),(l=this.hls)==null||l.trigger(E.ERROR,{type:Z.OTHER_ERROR,details:M.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${o}`)})})}}}Li.CDMCleanupPromise=void 0;class et extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}class Z0{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(E.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(E.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const n=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=n,n&&typeof n.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const n=performance.now();if(t){if(this.lastTime){const r=n-this.lastTime,a=i-this.lastDroppedFrames,o=t-this.lastDecodedFrames,l=1e3*a/r,c=this.hls;if(c.trigger(E.FPS_DROP,{currentDropped:a,currentDecoded:o,totalDroppedFrames:i}),l>0&&a>c.config.fpsDroppedMonitoringThreshold*o){let u=c.currentLevel;c.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=u)&&(u=u-1,c.trigger(E.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:c.currentLevel}),c.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=n,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function ey(s,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=s,e.dispatchEvent(t)}function kd(s,e){const t=s.mode;if(t==="disabled"&&(s.mode="hidden"),s.cues&&!s.cues.getCueById(e.id))try{if(s.addCue(e),!s.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){ye.debug(`[texttrack-utils]: ${i}`);try{const n=new self.TextTrackCue(e.startTime,e.endTime,e.text);n.id=e.id,s.addCue(n)}catch(n){ye.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${n}`)}}t==="disabled"&&(s.mode=t)}function Xi(s,e){const t=s.mode;if(t==="disabled"&&(s.mode="hidden"),s.cues)for(let i=s.cues.length;i--;)s.removeCue(s.cues[i]);t==="disabled"&&(s.mode=t)}function Cd(s,e,t,i){const n=s.mode;if(n==="disabled"&&(s.mode="hidden"),s.cues&&s.cues.length>0){const r=iy(s.cues,e,t);for(let a=0;a<r.length;a++)s.removeCue(r[a])}n==="disabled"&&(s.mode=n)}function ty(s,e){if(e<=s[0].startTime)return 0;const t=s.length-1;if(e>s[t].endTime)return-1;let i=0,n=t,r;for(;i<=n;)if(r=Math.floor((n+i)/2),e<s[r].startTime)n=r-1;else if(e>s[r].startTime&&i<t)i=r+1;else return r;return s[i].startTime-e<e-s[n].startTime?i:n}function iy(s,e,t){const i=[],n=ty(s,e);if(n>-1)for(let r=n,a=s.length;r<a;r++){const o=s[r];if(o.startTime>=e&&o.endTime<=t)i.push(o);else if(o.startTime>t)return i}return i}function un(s){const e=[];for(let t=0;t<s.length;t++){const i=s[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(s[t])}return e}class sy extends gd{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=un(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}const n=this.findTrackForTextTrack(t);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_PARSED,this.onManifestParsed,this),e.on(E.LEVEL_LOADING,this.onLevelLoading,this),e.on(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(E.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(E.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_PARSED,this.onManifestParsed,this),e.off(E.LEVEL_LOADING,this.onLevelLoading,this),e.off(E.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(E.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(E.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const n=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,n)return;un(i.textTracks).forEach(a=>{Xi(a)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:n,details:r}=t,a=this.tracksInGroup[i];if(!a||a.groupId!==n){this.warn(`Subtitle track with id:${i} and group:${n} not found in active group ${a==null?void 0:a.groupId}`);return}const o=a.details;a.details=t.details,this.log(`Subtitle track ${i} "${a.name}" lang:${a.lang} group:${n} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,n=this.groupIds;let r=this.currentTrack;if(!i||(n==null?void 0:n.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(n==null?void 0:n.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(u=>u.default)&&(this.selectDefaultTrack=!1),a.forEach((u,d)=>{u.id=d});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const o=this.hls.config.subtitlePreference;if(!r&&o){this.selectDefaultTrack=!1;const u=vt(o,a);if(u>-1)r=a[u];else{const d=vt(o,this.tracks);r=this.tracks[d]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const c={subtitleTracks:a};this.log(`Updating subtitle tracks, ${a.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(E.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let n=0;n<t.length;n++){const r=t[n];if(!(i&&!r.default||!i&&!e)&&(!e||oi(r,e)))return n}if(e){for(let n=0;n<t.length;n++){const r=t[n];if(Ji(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const r=t[n];if(Ji(e.attrs,r.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(ia(n,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Ct.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&oi(e,i))return i;const n=vt(e,this.tracksInGroup);if(n>-1){const r=this.tracksInGroup[n];return this.setSubtitleTrack(n),r}else{if(i)return null;{const r=vt(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,r=this.getUrlWithDirectives(e.url,t),a=e.details,o=a==null?void 0:a.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${n}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${o&&a.live?" age "+o.toFixed(1)+(a.type&&" "+a.type||""):""} ${r}`),this.hls.trigger(E.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:n,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=un(e.textTracks),i=this.currentTrack;let n;if(i&&(n=t.filter(r=>ia(i,r))[0],n||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==n&&(r.mode="disabled")}),n){const r=this.subtitleDisplay?"showing":"hidden";n.mode!==r&&(n.mode=r)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!K(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e]||null;if(this.trackId=e,this.currentTrack=n,this.toggleTrackModes(),!n){this.hls.trigger(E.SUBTITLE_TRACK_SWITCH,{id:e});return}const r=!!n.details&&!n.details.live;if(e===this.trackId&&n===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(n?` "${n.name}" lang:${n.lang} group:${n.groupId}`:""));const{id:a,groupId:o="",name:l,type:c,url:u}=n;this.hls.trigger(E.SUBTITLE_TRACK_SWITCH,{id:a,groupId:o,name:l,type:c,url:u});const d=this.switchParams(n.url,i==null?void 0:i.details,n.details);this.loadPlaylist(d)}}function Zi(s){let e=5381,t=s.length;for(;t;)e=e*33^s.charCodeAt(--t);return(e>>>0).toString()}const ki=.025;let dn=function(s){return s[s.Point=0]="Point",s[s.Range=1]="Range",s}({});function ny(s,e,t){return`${s.identifier}-${t+1}-${Zi(e)}`}class ry{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){if(e>=this.assetList.length)return!0;const t=this.playoutLimit;return e<=0||isNaN(t)?!1:this.assetList[e].startOffset>t}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return la(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,i=la(t,e);return t-i<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=K(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return la(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<ki))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?dn.Range:dn.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return ay(this)}}function la(s,e){return s-e.start<e.duration/2&&!(Math.abs(s-(e.start+e.duration))<ki)?e.start:e.start+e.duration}function Rd(s,e,t){const i=new self.URL(s,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function ay(s){return`["${s.identifier}" ${s.cue.pre?"<pre>":s.cue.post?"<post>":""}${s.timelineStart.toFixed(2)}-${s.resumeTime.toFixed(2)}]`}function ca(s){const e=s.timelineStart,t=s.duration||0;return`["${s.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class oy{constructor(e,t,i,n){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{const c=this.interstitial.playoutLimit,u=this.currentTime;this.startOffset+u>=c&&this.hls.trigger(E.PLAYOUT_LIMIT_REACHED,{})};const r=this.hls=new e(t);this.interstitial=i,this.assetItem=n;let a=n.uri;try{a=Rd(a,r.sessionId).href}catch{}r.loadSource(a);const o=()=>{this.hasDetails=!0};r.once(E.LEVEL_LOADED,o),r.once(E.AUDIO_TRACK_LOADED,o),r.once(E.SUBTITLE_TRACK_LOADED,o),r.on(E.MEDIA_ATTACHING,(l,{media:c})=>{this.removeMediaListeners(),this.mediaAttached=c,this.interstitial.playoutLimit&&c.addEventListener("timeupdate",this.checkPlayout)})}bufferedInPlaceToEnd(e){var t;if(!this.interstitial.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;const i=this.timelineOffset,n=be.bufferInfo(e,i,0);return this.getAssetTime(n.end)>=this._bufferedEosTime-.02}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=be.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;return e||0}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}on(e,t,i){this.hls.on(e,t)}once(e,t,i){this.hls.once(e,t)}off(e,t,i){this.hls.off(e,t)}toString(){var e,t;return`HlsAssetPlayer: ${ca(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${(t=this.interstitial)!=null&&t.appendInPlace?"append-in-place":""}`}}const Pd=.033;class ly extends Rt{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,n)=>e<=n.startOffset&&t>n.startOffset?(delete n.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const n=this.items;if(n)for(n[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(r=n[i])!=null&&r.event;){var r;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let n=0;n<i.length;n++){let r=i[n];if(t&&t!=="primary"&&(r=r[t]),e===r.start||e>r.start&&e<r.end)return n}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let n=e;n<=t&&i[n];n++){const r=i[n].event;if(r!=null&&r.restrictions.jump&&!r.appendInPlace)return n}return-1}findEventIndex(e){const t=this.items;if(t)for(let n=t.length;n--;){var i;if(((i=t[n].event)==null?void 0:i.identifier)===e)return n}return-1}findAssetIndex(e,t){const i=e.assetList,n=i.length;if(n>1)for(let r=0;r<n;r++){const a=i[r];if(!a.error){const o=a.timelineStart;if(t===o||t>o&&t<o+(a.duration||0))return r}}return 0}get assetIdAtEnd(){var e,t;const i=(e=this.items)==null||(t=e[this.length-1])==null?void 0:t.event;if(i){const n=i.assetList,r=n[n.length-1];if(r)return r.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:n}=i,r=this.events,a=this.parseDateRanges(n,{url:i.url},t),o=Object.keys(n),l=r?r.filter(c=>!o.includes(c.identifier)):[];a.length&&a.sort((c,u)=>{const d=c.cue.pre,f=c.cue.post,p=u.cue.pre,g=u.cue.post;if(d&&!p)return-1;if(p&&!d||f&&!g)return 1;if(g&&!f)return-1;if(!d&&!p&&!f&&!g){const y=c.startTime,S=u.startTime;if(y!==S)return y-S}return c.dateRange.tagOrder-u.dateRange.tagOrder}),this.events=a,l.forEach(c=>{this.removeEvent(c)}),this.updateSchedule(e,l)}updateSchedule(e,t=[]){const i=this.events||[];if(i.length||t.length||this.length<2){const n=this.items,r=this.parseSchedule(i,e);(t.length||(n==null?void 0:n.length)!==r.length||r.some((o,l)=>Math.abs(o.playout.start-n[l].playout.start)>.005||Math.abs(o.playout.end-n[l].playout.end)>.005))&&(this.items=r,this.onScheduleUpdate(t,n))}}parseDateRanges(e,t,i){const n=[],r=Object.keys(e);for(let a=0;a<r.length;a++){const o=r[a],l=e[o];if(l.isInterstitial){let c=this.eventMap[o];c?c.setDateRange(l):(c=new ry(l,t),this.eventMap[o]=c,i===!1&&(c.appendInPlace=i)),n.push(c)}}return n}parseSchedule(e,t){const i=[],n=t.main.details,r=n.live?1/0:n.edge;let a=0;if(e=e.filter(l=>!l.error&&!(l.cue.once&&l.hasPlayed)),e.length){this.resolveOffsets(e,t);let l=0,c=0;if(e.forEach((u,d)=>{const f=u.cue.pre,p=u.cue.post,g=e[d-1]||null,y=u.appendInPlace,S=p?r:u.startOffset,T=u.duration,L=u.timelineOccupancy===dn.Range?T:0,w=u.resumptionOffset,x=(g==null?void 0:g.startTime)===S,b=S+u.cumulativeDuration;let C=y?b+T:S+w;if(f||!p&&S<=0){const k=c;c+=L,u.timelineStart=b;const D=a;a+=T,i.push({event:u,start:b,end:C,playout:{start:D,end:a},integrated:{start:k,end:c}})}else if(S<=r){if(!x){const R=S-l;if(R>Pd){const N=l,G=c;c+=R;const ce=a;a+=R;const J={previousEvent:e[d-1]||null,nextEvent:u,start:N,end:N+R,playout:{start:ce,end:a},integrated:{start:G,end:c}};i.push(J)}else R>0&&g&&(g.cumulativeDuration+=R,i[i.length-1].end=S)}p&&(C=b),u.timelineStart=b;const k=c;c+=L;const D=a;a+=T,i.push({event:u,start:b,end:C,playout:{start:D,end:a},integrated:{start:k,end:c}})}else return;const _=u.resumeTime;p||_>r?l=r:l=_}),l<r){var o;const u=l,d=c,f=r-l;c+=f;const p=a;a+=f,i.push({previousEvent:((o=i[i.length-1])==null?void 0:o.event)||null,nextEvent:null,start:l,end:u+f,playout:{start:p,end:a},integrated:{start:d,end:c}})}this.setDurations(r,a,c)}else i.push({previousEvent:null,nextEvent:null,start:0,end:r,playout:{start:0,end:r},integrated:{start:0,end:r}}),this.setDurations(r,r,r);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,n=i.live?1/0:i.edge;let r=0,a=-1;e.forEach((o,l)=>{const c=o.cue.pre,u=o.cue.post,d=c?0:u?n:o.startTime;this.updateAssetDurations(o),a===d?o.cumulativeDuration=r:(r=0,a=d),!u&&o.snapOptions.in&&(o.resumeAnchor=Ti(null,i.fragments,o.startOffset+o.resumptionOffset,0,0)||void 0),o.appendInPlace&&!o.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(o,t)||(o.appendInPlace=!1)),!o.appendInPlace&&l+1<e.length&&e[l+1].startTime-e[l].resumeTime<Pd&&(e[l+1].appendInPlace=!1,e[l+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${o}`));const p=K(o.resumeOffset)?o.resumeOffset:o.duration;r+=p})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,n=e.startTime+e.resumptionOffset;return Math.abs(i-n)>ki?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${n}`),!1):t?!Object.keys(t).some(a=>{const o=t[a].details,l=o.edge;if(i>=l)return this.log(`"${e.identifier}" resumption ${i} past ${a} playlist end ${l}`),!1;const c=Ti(null,o.fragments,i);if(!c)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${a} playlist (${o.fragStart}-${o.fragmentEnd})`),!0;const u=a==="audio"?.175:0;return Math.abs(c.start-i)<ki+u||Math.abs(c.end-i)<ki+u?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${a} fragment bounds (${c.start}-${c.end} sn: ${c.sn} cc: ${c.cc})`),!0)}):(this.log(`"${e.identifier}" resumption ${i} can not be aligned with media (none selected)`),!1)}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,n=!1,r=!1;e.assetList.forEach((a,o)=>{const l=t+i;a.startOffset=i,a.timelineStart=l,n||(n=a.duration===null),r||(r=!!a.error);const c=a.error?0:a.duration||0;i+=c}),n&&!r?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function Kt(s){return`[${s.event?'"'+s.event.identifier+'"':"primary"}: ${s.start.toFixed(2)}-${s.end.toFixed(2)}]`}class cy{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let n;try{n=Rd(i,this.hls.sessionId,e.baseUrl)}catch(f){const p=this.assignAssetListError(e,M.ASSET_LIST_LOAD_ERROR,f,i);this.hls.trigger(E.ERROR,p);return}t&&n.protocol!=="data:"&&n.searchParams.set("_HLS_start_offset",""+t);const r=this.hls.config,a=r.loader,o=new a(r),l={responseType:"json",url:n.href},c=r.interstitialAssetListLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(f,p,g,y)=>{const S=f.data,T=S==null?void 0:S.ASSETS;if(!Array.isArray(T)){const L=this.assignAssetListError(e,M.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),g.url,p,y);this.hls.trigger(E.ERROR,L);return}e.assetListResponse=S,this.hls.trigger(E.ASSET_LIST_LOADED,{event:e,assetListResponse:S,networkDetails:y})},onError:(f,p,g,y)=>{const S=this.assignAssetListError(e,M.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${f.code} ${f.text} (${p.url})`),p.url,y,g);this.hls.trigger(E.ERROR,S)},onTimeout:(f,p,g)=>{const y=this.assignAssetListError(e,M.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${p.url})`),p.url,f,g);this.hls.trigger(E.ERROR,y)}};return o.load(l,u,d),this.hls.trigger(E.ASSET_LIST_LOADING,{event:e}),o}assignAssetListError(e,t,i,n,r,a){return e.error=i,{type:Z.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:n,error:i,networkDetails:a,stats:r}}}function hn(s,e,t){es(s,e,t),s.addEventListener(e,t)}function es(s,e,t){s.removeEventListener(e,t)}function Dd(s){s==null||s.play().catch(()=>{})}class uy extends Rt{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;const n=i-this.timelinePos;if(Math.abs(n)<1/7056e5)return;const a=n<=-.01;this.timelinePos=i,this.bufferedPos=i;const o=this.playingItem;if(!o){this.checkBuffer();return}if(a&&this.schedule.resetErrorsInRange(i,i-n)&&this.updateSchedule(),this.checkBuffer(),a&&i<o.start||i>=o.end){var l;const f=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(o)&&(l=this.media)!=null&&l.paused&&(this.shouldPlay=!1),!a){const p=this.findItemIndex(o);if(f>p){const g=this.schedule.findJumpRestrictedIndex(p+1,f);if(g>p){this.setSchedulePosition(g);return}}}this.setSchedulePosition(f);return}const c=this.playingAsset;if(!c){if(this.playingLastItem&&this.isInterstitial(o)){const f=o.event.assetList[0];f&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,f))}return}const u=c.timelineStart,d=c.duration||0;(a&&i<u||i>=u+d)&&this.setScheduleToAssetAtTime(i,c)},this.onTimeupdate=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;const n=this.playingItem;if(!n||this.playingLastItem)return;if(i>=n.end){this.timelinePos=n.end;const o=this.findItemIndex(n);this.setSchedulePosition(o+1)}const r=this.playingAsset;if(!r)return;const a=r.timelineStart+(r.duration||0);i>=a&&this.setScheduleToAssetAtTime(i,r)},this.onScheduleUpdate=(i,n)=>{const r=this.schedule,a=this.playingItem,o=r.events||[],l=r.items||[],c=r.durations,u=i.map(p=>p.identifier),d=!!(o.length||u.length);if(d&&this.log(`INTERSTITIALS_UPDATED (${o.length}): ${o}
Schedule: ${l.map(p=>Kt(p))}`),u.length&&this.log(`Removed events ${u}`),this.playerQueue.forEach(p=>{if(p.interstitial.appendInPlace){const g=p.assetItem.timelineStart,y=p.timelineOffset-g;if(y)try{p.timelineOffset=g}catch(S){Math.abs(y)>ki&&this.warn(`${S} ("${p.assetId}" ${p.timelineOffset}->${g})`)}}}),a){const p=this.updateItem(a,this.timelinePos);this.itemsMatch(a,p)&&(this.playingItem=p,this.waitingItem=this.endedItem=null)}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const f=this.bufferingItem;if(f){const p=this.updateItem(f,this.bufferedPos);this.itemsMatch(f,p)?this.bufferingItem=p:f.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(f.event,null))}if(i.forEach(p=>{p.assetList.forEach(g=>{this.clearAssetPlayer(g.identifier,null)})}),d||n){if(this.hls.trigger(E.INTERSTITIALS_UPDATED,{events:o.slice(0),schedule:l.slice(0),durations:c,removedIds:u}),this.isInterstitial(a)&&u.includes(a.event.identifier)){this.warn(`Interstitial "${a.event.identifier}" removed while playing`),this.primaryFallback(a.event);return}this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new cy(e),this.schedule=new ly(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(E.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(E.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(E.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(E.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(E.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(E.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(E.BUFFER_APPENDED,this.onBufferAppended,this),e.on(E.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(E.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(E.MEDIA_ENDED,this.onMediaEnded,this),e.on(E.ERROR,this.onError,this),e.on(E.DESTROYING,this.onDestroying,this)}unregisterListeners(){const e=this.hls;e&&(e.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(E.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(E.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(E.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(E.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(E.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(E.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(E.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(E.BUFFER_CODECS,this.onBufferCodecs,this),e.off(E.BUFFER_APPENDED,this.onBufferAppended,this),e.off(E.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(E.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(E.MEDIA_ENDED,this.onMediaEnded,this),e.off(E.ERROR,this.onError,this),e.off(E.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){es(e,"play",this.onPlay),es(e,"pause",this.onPause),es(e,"seeking",this.onSeeking),es(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;hn(i,"seeking",this.onSeeking),hn(i,"timeupdate",this.onTimeupdate),hn(i,"play",this.onPlay),hn(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,n=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!n){this.clearScheduleState();const r=this.findItemIndex(i);this.setSchedulePosition(r)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(this.media=null,!i&&(n&&this.removeMediaListeners(n),this.detachedData)){const r=this.getBufferingPlayer();r&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,r.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=d=>d&&e.getAssetPlayer(d.identifier),n=(d,f,p,g,y)=>{if(d){let S=d[f].start;const T=d.event;if(T){if(f==="playout"||T.timelineOccupancy!==dn.Point){const L=i(p);(L==null?void 0:L.interstitial)===T&&(S+=L.assetItem.startOffset+L[y])}}else{const L=g==="bufferedPos"?a():e[g];S+=L-d.start}return S}return 0},r=(d,f)=>{if(d!==0&&f!=="primary"&&e.schedule.length){var p;const g=e.schedule.findItemIndexAtTime(d),y=(p=e.schedule.items)==null?void 0:p[g];if(y){const S=y[f].start-y.start;return d+S}}return d},a=()=>{const d=e.bufferedPos;return d===Number.MAX_VALUE?o("primary"):Math.max(d,0)},o=d=>{var f;return(f=e.primaryDetails)!=null&&f.live?e.primaryDetails.edge:e.schedule.durations[d]},l=(d,f)=>{var p,g;const y=e.effectivePlayingItem;if(y!=null&&(p=y.event)!=null&&p.restrictions.skip)return;e.log(`seek to ${d} "${f}"`);const S=e.effectivePlayingItem,T=e.schedule.findItemIndexAtTime(d,f),L=(g=e.schedule.items)==null?void 0:g[T],w=e.getBufferingPlayer(),x=w==null?void 0:w.interstitial,b=x==null?void 0:x.appendInPlace,C=S&&e.itemsMatch(S,L);if(S&&(b||C)){const k=i(e.playingAsset),D=(k==null?void 0:k.media)||e.primaryMedia;if(D){const R=f==="primary"?D.currentTime:n(S,f,e.playingAsset,"timelinePos","currentTime"),N=d-R,G=(b?R:D.currentTime)+N;if(G>=0&&(!k||b||G<=k.duration)){D.currentTime=G;return}}}if(L){let k=d;if(f!=="primary"){const R=L[f].start,N=d-R;k=L.start+N}const D=!e.isInterstitial(L);if((!e.isInterstitial(S)||S.event.appendInPlace)&&(D||L.event.appendInPlace)){const R=e.media||(b?w==null?void 0:w.media:null);R&&(R.currentTime=k)}else if(S){const R=e.findItemIndex(S);if(T>R){const G=e.schedule.findJumpRestrictedIndex(R+1,T);if(G>R){e.setSchedulePosition(G);return}}let N=0;if(D)e.timelinePos=k,e.checkBuffer();else{var _;const G=L==null||(_=L.event)==null?void 0:_.assetList;if(G){const ce=d-(L[f]||L).start;for(let J=G.length;J--;){const ae=G[J];if(ae.duration&&ce>=ae.startOffset&&ce<ae.startOffset+ae.duration){N=J;break}}}}e.setSchedulePosition(T,N)}}},c=()=>{const d=e.effectivePlayingItem;if(e.isInterstitial(d))return d;const f=t();return e.isInterstitial(f)?f:null},u={get currentTime(){const d=c(),f=e.effectivePlayingItem;return f&&f===d?n(f,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-f.playout.start:0},set currentTime(d){const f=c(),p=e.effectivePlayingItem;p&&p===f&&l(d+p.playout.start,"playout")},get duration(){const d=c();return d?d.playout.end-d.playout.start:0},get assetPlayers(){var d;const f=(d=c())==null?void 0:d.event.assetList;return f?f.map(p=>e.getAssetPlayer(p.identifier)):[]},get playingIndex(){var d;const f=(d=c())==null?void 0:d.event;return f&&e.effectivePlayingAsset?f.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return c()}};this.manager={get events(){var d,f;return((d=e.schedule)==null||(f=d.events)==null?void 0:f.slice(0))||[]},get schedule(){var d,f;return((d=e.schedule)==null||(f=d.items)==null?void 0:f.slice(0))||[]},get interstitialPlayer(){return c()?u:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const d=t();return e.findItemIndex(d)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const d=e.effectivePlayingItem;return e.findItemIndex(d)},primary:{get bufferedEnd(){return a()},get currentTime(){const d=e.timelinePos;return d>0?d:0},set currentTime(d){l(d,"primary")},get duration(){return o("primary")},get seekableStart(){var d;return((d=e.primaryDetails)==null?void 0:d.fragmentStart)||0}},integrated:{get bufferedEnd(){return n(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return n(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(d){l(d,"integrated")},get duration(){return o("integrated")},get seekableStart(){var d;return r(((d=e.primaryDetails)==null?void 0:d.fragmentStart)||0,"integrated")}},skip:()=>{const d=e.effectivePlayingItem,f=d==null?void 0:d.event;if(f&&!f.restrictions.skip){const p=e.findItemIndex(d);if(f.appendInPlace){const g=d.playout.start+d.event.duration;l(g+.001,"playout")}else e.advanceAfterAssetEnded(f,p,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t,i;if(this.mediaSelection===null)return;const n=this.waitingItem||this.playingItem;if(this.isInterstitial(n)&&!n.event.appendInPlace)return;let r=this.media;!r&&(e=this.bufferingItem)!=null&&(t=e.event)!=null&&t.appendInPlace&&(r=this.primaryMedia);const a=(i=r)==null?void 0:i.currentTime;if(!(a===void 0||!K(a)))return a}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,n=e.media;if(i&&n===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&n){this.detachedData={media:n};return}const r=e.transferMedia();this.log(`transfer MediaSource from ${e} ${Le(r)}`),this.detachedData=r}else t&&n&&(this.shouldPlay||(this.shouldPlay=!n.paused))}transferMediaTo(e,t){var i,n;if(e.media===t)return;let r=null;const a=this.hls,o=e!==a,l=o&&e.interstitial.appendInPlace,c=(i=this.detachedData)==null?void 0:i.mediaSource;let u;if(a.media)l&&(r=a.transferMedia(),this.detachedData=r),u="Primary";else if(c){const p=this.getBufferingPlayer();p?(r=p.transferMedia(),u=`${p}`):u="detached MediaSource"}else u="detached media";if(!r){if(c)r=this.detachedData,this.log(`using detachedData: MediaSource ${Le(r)}`);else if(!this.detachedData||a.media===t){const p=this.playerQueue;p.length>1&&p.forEach(g=>{if(o&&g.interstitial.appendInPlace!==l){const y=g.interstitial;this.clearInterstitial(g.interstitial,null),y.appendInPlace=!1,y.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${y}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const d=r&&"mediaSource"in r&&((n=r.mediaSource)==null?void 0:n.readyState)!=="closed",f=d&&r?r:t;if(this.log(`${d?"transfering MediaSource":"attaching media"} to ${o?e:"Primary"} from ${u}`),f===r){const p=o&&e.assetId===this.schedule.assetIdAtEnd;f.overrides={duration:this.schedule.duration,endOfStream:!o||p,cueRemoval:!o}}e.attachMedia(f)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const i=this.timelinePos,n=this.effectivePlayingItem;if(i===-1){const r=this.hls.startPosition;if(this.timelinePos=r,t.length&&t[0].cue.pre){const a=e.findEventIndex(t[0].identifier);this.setSchedulePosition(a)}else if(r>=0||!this.primaryLive){const a=this.timelinePos=r>0?r:0,o=e.findItemIndexAtTime(a);this.setSchedulePosition(o)}}else if(n&&!this.playingItem){const r=e.findItemIndex(n);this.setSchedulePosition(r)}}advanceAfterAssetEnded(e,t,i){const n=i+1;if(!e.isAssetPastPlayoutLimit(n)&&!e.assetList[n].error)this.setSchedulePosition(t,n);else{const r=this.schedule.items;if(r){const a=t+1,o=r.length;if(a>=o){this.setSchedulePosition(-1);return}const l=e.resumeTime;this.timelinePos<l&&(this.timelinePos=l,this.checkBuffer()),this.setSchedulePosition(a)}}}setScheduleToAssetAtTime(e,t){const i=this.schedule,n=t.parentIdentifier,r=i.getEvent(n);if(r){const a=i.findEventIndex(n),o=i.findAssetIndex(r,e);this.setSchedulePosition(a,o)}}setSchedulePosition(e,t){const i=this.schedule.items;if(!i||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${t}`);const n=e>=0?i[e]:null,r=this.playingItem,a=this.playingLastItem;if(this.isInterstitial(r)){var o;const c=r.event,u=this.playingAsset,d=u==null?void 0:u.identifier,f=d?this.getAssetPlayer(d):null;if(f&&d&&(!this.eventItemsMatch(r,n)||t!==void 0&&d!==((o=c.assetList)==null?void 0:o[t].identifier))){var l;const p=c.findAssetIndex(u);this.log(`INTERSTITIAL_ASSET_ENDED ${p+1}/${c.assetList.length} ${ca(u)}`),this.endedAsset=u,this.playingAsset=null,this.hls.trigger(E.INTERSTITIAL_ASSET_ENDED,{asset:u,assetListIndex:p,event:c,schedule:i.slice(0),scheduleIndex:e,player:f}),this.retreiveMediaSource(d,n),f.media&&!((l=this.detachedData)!=null&&l.mediaSource)&&f.detachMedia()}if(!this.eventItemsMatch(r,n)&&(this.endedItem=r,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${c} ${Kt(r)}`),c.hasPlayed=!0,this.hls.trigger(E.INTERSTITIAL_ENDED,{event:c,schedule:i.slice(0),scheduleIndex:e}),c.cue.once)){this.updateSchedule();const p=this.schedule.items;if(n&&p){const g=this.schedule.findItemIndex(n);this.advanceSchedule(g,p,t,r,a)}return}}this.advanceSchedule(e,i,t,r,a)}advanceSchedule(e,t,i,n,r){const a=e>=0?t[e]:null,o=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(c=>{const u=c.interstitial,d=this.schedule.findEventIndex(u.identifier);(d<e||d>e+1)&&this.clearInterstitial(u,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);const c=a.event;i===void 0&&(i=this.schedule.findAssetIndex(c,this.timelinePos));const u=this.waitingItem;this.assetsBuffered(a,o)||this.setBufferingItem(a);let d=this.preloadAssets(c,i);if(this.eventItemsMatch(a,u||n)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${Kt(a)} ${c.appendInPlace?"append in place":""}`),this.hls.trigger(E.INTERSTITIAL_STARTED,{event:c,schedule:t.slice(0),scheduleIndex:e})),!c.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${c}`);return}if(c.assetListLoader&&(c.assetListLoader.destroy(),c.assetListLoader=void 0),!o){this.log(`Waiting for attachMedia to start Interstitial ${c}`);return}this.waitingItem=this.endedItem=null,this.playingItem=a;const f=c.assetList[i];if(!f){const p=t[e+1],g=this.media;p&&g&&!this.isInterstitial(p)&&g.currentTime<p.start&&(g.currentTime=this.timelinePos=p.start),this.advanceAfterAssetEnded(c,e,i||0);return}if(d||(d=this.getAssetPlayer(f.identifier)),d===null||d.destroyed){const p=c.assetList.length;this.warn(`asset ${i+1}/${p} player destroyed ${c}`),d=this.createAssetPlayer(c,f,i)}if(!this.eventItemsMatch(a,this.bufferingItem)&&c.appendInPlace&&this.isAssetBuffered(f))return;this.startAssetPlayer(d,i,t,e,o),this.shouldPlay&&Dd(d.media)}else a!==null?(this.resumePrimary(a,e,n),this.shouldPlay&&Dd(this.hls.media)):r&&this.isInterstitial(n)&&(this.endedItem=null,this.playingItem=n,n.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e,t;return(e=this.mediaSelection)==null||(t=e.main)==null?void 0:t.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var n;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Kt(e)}`),!((n=this.detachedData)!=null&&n.mediaSource)){let a=this.timelinePos;(a<e.start||a>=e.end)&&(a=this.getPrimaryResumption(e,t),this.timelinePos=a),this.attachPrimary(a,e)}if(!i)return;const r=this.schedule.items;r&&(this.log(`resumed ${Kt(e)}`),this.hls.trigger(E.INTERSTITIALS_PRIMARY_RESUMED,{schedule:r.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const n=this.primaryDetails;if(t===0)return this.hls.startPosition;if(n&&(i<n.fragmentStart||i>n.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:be.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const n=this.primaryMedia;if(!n)return;const r=this.hls;r.media?this.checkBuffer():(this.transferMediaTo(r,n),i&&this.startLoadingPrimaryAt(e,i)),i||(this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const n=this.hls;!n.loadingEnabled||!n.media||Math.abs((((i=n.mainForwardBufferInfo)==null?void 0:i.start)||n.media.currentTime)-e)>.5?n.startLoad(e,t):n.bufferingEnabled||n.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(E.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(E.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1)return;const i=this.hls.levels[t.level],n=xe(xe({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=n,this.schedule.parseInterstitialDateRanges(n,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=xe(xe({},this.altSelection),{},{audio:i});return}const r=xe(xe({},n),{},{audio:i});this.mediaSelection=r}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=xe(xe({},this.altSelection),{},{subtitles:i});return}const r=xe(xe({},n),{},{subtitles:i});this.mediaSelection=r}onAudioTrackSwitching(e,t){const i=mu(t);this.playerQueue.forEach(n=>n.hls.setAudioOption(t)||n.hls.setAudioOption(i))}onSubtitleTrackSwitch(e,t){const i=mu(t);this.playerQueue.forEach(n=>n.hls.setSubtitleOption(t)||t.id!==-1&&n.hls.setSubtitleOption(i))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const n=this.timelinePos;this.bufferedPos=n,this.checkBuffer()}}onBufferedToEnd(e){const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let n=0;n<t.length;n++){const r=t[n];if(r.cue.post){var i;const a=this.schedule.findEventIndex(r.identifier),o=(i=this.schedule.items)==null?void 0:i[a];this.isInterstitial(o)&&this.eventItemsMatch(o,this.bufferingItem)&&this.bufferedToItem(o,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){const i=this.schedule.items;if(e&&i){const n=this.findItemIndex(e,t);return i[n]||null}return null}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e?this.schedule.findItemIndex(e,t):-1}updateSchedule(){const e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){const t=this.schedule.items;if(!t)return;const i=be.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,t,e)}updateBufferedPos(e,t,i){const n=this.schedule,r=this.bufferingItem;if(this.bufferedPos>e)return;if(t.length===1&&this.itemsMatch(t[0],r)){this.bufferedPos=e;return}const a=this.playingItem,o=this.findItemIndex(a);let l=n.findItemIndexAtTime(e);if(this.bufferedPos<e){var c,u;const d=this.findItemIndex(r),f=Math.min(d+1,t.length-1),p=t[f];if((l===-1&&r&&e>=r.end||(c=p.event)!=null&&c.appendInPlace&&e+.01>=p.start)&&(l=f),f-o>1&&(r==null||(u=r.event)==null?void 0:u.appendInPlace)===!1)return;if(this.bufferedPos=e,l>d&&l>o)this.bufferedToItem(p);else{const g=this.primaryDetails;this.primaryLive&&g&&e>g.edge-g.targetduration&&p.start<g.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(p)&&this.preloadAssets(p.event,0)}}else i&&a&&!this.itemsMatch(a,r)&&(l===o?this.bufferedToItem(a):l===o+1&&this.bufferedToItem(t[l]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(n=>{const r=this.getAssetPlayer(n.identifier);return!(r!=null&&r.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(this.itemsMatch(e,t))this.bufferingItem!==e&&(this.bufferingItem=e);else{const{items:n,events:r}=i;if(!n||!r)return t;const a=this.isInterstitial(e),o=this.getBufferingPlayer();if(this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos)),!this.playbackDisabled){const l=o?o.remaining:t?t.end-this.timelinePos:0;this.log(`buffered to boundary ${Kt(e)}`+(t?` (${l.toFixed(2)} remaining)`:"")),a?e.event.assetList.forEach(c=>{const u=this.getAssetPlayer(c.identifier);u&&u.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(c=>c.pauseBuffering()))}this.hls.trigger(E.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:r.slice(0),schedule:n.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;const n=this.detachedData;n?n.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,n=i.assetList.length===0&&!i.assetListLoader,r=i.cue.once;if(n||!r){const a=this.preloadAssets(i,t);if(a!=null&&a.interstitial.appendInPlace){const o=i.assetList[t],l=this.primaryMedia;o&&l&&this.bufferAssetPlayer(a,l)}}}preloadAssets(e,t){const i=e.assetUrl,n=e.assetList.length,r=n===0&&!e.assetListLoader,a=e.cue.once;if(r){const l=e.timelineStart;if(e.appendInPlace){var o;const f=this.playingItem;!this.isInterstitial(f)&&(f==null||(o=f.nextEvent)==null?void 0:o.identifier)===e.identifier&&this.flushFrontBuffer(l+.25)}let c,u=0;if(!this.playingItem&&this.primaryLive&&(u=this.hls.startPosition,u===-1&&(u=this.hls.liveSyncPosition||0)),u&&!(e.cue.pre||e.cue.post)){const f=u-l;f>0&&(c=Math.round(f*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:n} ${e}${c?` live-start: ${u} start-offset: ${c}`:""}`),i)return this.createAsset(e,0,0,l,e.duration,i);const d=this.assetListLoader.loadAssetList(e,c);d&&(e.assetListLoader=d)}else if(!a&&n){for(let l=t;l<n;l++){const c=e.assetList[l],u=this.getAssetPlayerQueueIndex(c.identifier);(u===-1||this.playerQueue[u].destroyed)&&!c.error&&this.createAssetPlayer(e,c,l)}return this.getAssetPlayer(e.assetList[t].identifier)}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(n=>{this.hls.trigger(E.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:n})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,n,r,a){const o={parentIdentifier:e.identifier,identifier:ny(e,a,t),duration:r,startOffset:i,timelineStart:n,uri:a};return this.createAssetPlayer(e,o,t)}createAssetPlayer(e,t,i){this.log(`create HLSAssetPlayer for ${ca(t)}`);const n=this.hls,r=n.userConfig;let a=r.videoPreference;const o=n.loadLevelObj||n.levels[n.currentLevel];(a||o)&&(a=Ie({},a),o.videoCodec&&(a.videoCodec=o.videoCodec),o.videoRange&&(a.allowedVideoRanges=[o.videoRange]));const l=n.audioTracks[n.audioTrack],c=n.subtitleTracks[n.subtitleTrack];let u=0;if(this.primaryLive||e.appendInPlace){const w=this.timelinePos-t.timelineStart;if(w>1){const x=t.duration;x&&w<x&&(u=w)}}const d=t.identifier,f=xe(xe({},r),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:n.sessionId,assetPlayerId:d,abrEwmaDefaultEstimate:n.bandwidthEstimate,interstitialsController:void 0,startPosition:u,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:a,audioPreference:l||r.audioPreference,subtitlePreference:c||r.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(f.timelineOffset=t.timelineStart));const p=f.cmcd;p!=null&&p.sessionId&&p.contentId&&(f.cmcd=Ie({},p,{contentId:Zi(t.uri)})),this.getAssetPlayer(d)&&this.warn(`Duplicate date range identifier ${e} and asset ${d}`);const g=new oy(this.HlsPlayerClass,f,e,t);this.playerQueue.push(g),e.assetList[i]=t;const y=w=>{if(w.live){const C=new Error(`Interstitials MUST be VOD assets ${e}`),_={fatal:!0,type:Z.OTHER_ERROR,details:M.INTERSTITIAL_ASSET_ITEM_ERROR,error:C};this.handleAssetItemError(_,e,this.schedule.findEventIndex(e.identifier),i,C.message);return}const x=w.edge-w.fragmentStart,b=t.duration;(b===null||x>b)&&(this.log(`Interstitial asset "${d}" duration change ${b} > ${x}`),t.duration=x,this.updateSchedule())};g.on(E.LEVEL_UPDATED,(w,{details:x})=>y(x)),g.on(E.LEVEL_PTS_UPDATED,(w,{details:x})=>y(x));const S=(w,x)=>{const b=this.getAssetPlayer(d);if(b&&x.tracks){b.off(E.BUFFER_CODECS,S),b.tracks=x.tracks;const C=this.primaryMedia;this.bufferingAsset===b.assetItem&&C&&!b.media&&this.bufferAssetPlayer(b,C)}};g.on(E.BUFFER_CODECS,S);const T=()=>{var w;const x=this.getAssetPlayer(d);if(this.log(`buffered to end of asset ${x}`),!x)return;const b=this.schedule.findEventIndex(e.identifier),C=e.findAssetIndex(t),_=C+1,k=(w=this.schedule.items)==null?void 0:w[b];if(this.isInterstitial(k))if(C!==-1&&!e.isAssetPastPlayoutLimit(_)&&!e.assetList[_].error)this.bufferedToItem(k,_);else{var D;const R=(D=this.schedule.items)==null?void 0:D[b+1];R&&this.bufferedToItem(R)}};g.on(E.BUFFERED_TO_END,T);const L=w=>()=>{if(!this.getAssetPlayer(d))return;this.shouldPlay=!0;const b=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,b,w)};return g.once(E.MEDIA_ENDED,L(i)),g.once(E.PLAYOUT_LIMIT_REACHED,L(1/0)),g.on(E.ERROR,(w,x)=>{const b=this.getAssetPlayer(d);if(x.details===M.BUFFER_STALLED_ERROR){if(b!=null&&b.media){const C=b.currentTime,_=b.duration-C;C&&e.appendInPlace&&_/b.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${d} ${e} at ${b.media.currentTime}`),T()):(this.warn(`Stalled at ${C} of ${C+_} in asset ${d} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}return}this.handleAssetItemError(x,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${x.error} ${e}`)}),g.on(E.DESTROYING,()=>{if(!this.getAssetPlayer(d))return;const x=new Error(`Asset player destroyed unexpectedly ${d}`),b={fatal:!0,type:Z.OTHER_ERROR,details:M.INTERSTITIAL_ASSET_ITEM_ERROR,error:x};this.handleAssetItemError(b,e,this.schedule.findEventIndex(e.identifier),i,x.message)}),this.hls.trigger(E.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:g}),g}clearInterstitial(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)}),e.reset()}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(i!==-1){this.log(`clearAssetPlayer "${e}" toSegment: ${t&&Kt(t)}`);const n=this.playerQueue[i];this.transferMediaFromPlayer(n,t),this.playerQueue.splice(i,1),n.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,n,r){const{interstitial:a,assetItem:o,assetId:l}=e,c=a.assetList.length,u=this.playingAsset;this.endedAsset=null,this.playingAsset=o,(!u||u.identifier!==l)&&(u&&(this.clearAssetPlayer(u.identifier,i[n]),delete u.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${c} ${e}`),this.hls.trigger(E.INTERSTITIAL_ASSET_STARTED,{asset:o,assetListIndex:t,event:a,schedule:i.slice(0),scheduleIndex:n,player:e})),this.bufferAssetPlayer(e,r)}bufferAssetPlayer(e,t){var i,n;const{interstitial:r,assetItem:a,assetId:o}=e,l=this.schedule.findEventIndex(r.identifier),c=(i=this.schedule.items)==null?void 0:i[l];if(!c)return;this.setBufferingItem(c),this.bufferingAsset=a;const u=this.getBufferingPlayer();if(u===e)return;const d=r.appendInPlace;if(d&&(u==null?void 0:u.interstitial.appendInPlace)===!1)return;const f=(u==null?void 0:u.tracks)||((n=this.detachedData)==null?void 0:n.tracks)||this.requiredTracks;if(d&&a!==this.playingAsset){if(!e.tracks)return;if(f&&!zc(f,e.tracks)){const p=new Error(`Asset "${o}" SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(f)}')`),g={fatal:!0,type:Z.OTHER_ERROR,details:M.INTERSTITIAL_ASSET_ITEM_ERROR,error:p},y=r.findAssetIndex(a);this.handleAssetItemError(g,r,l,y,p.message);return}}this.transferMediaTo(e,t)}handleAssetItemError(e,t,i,n,r){if(e.details===M.BUFFER_STALLED_ERROR)return;const a=t.assetList[n]||null;let o=null;if(a){const d=this.getAssetPlayerQueueIndex(a.identifier);o=this.playerQueue[d]||null}const l=this.schedule.items,c=Ie({},e,{fatal:!1,errorAction:qi(!0),asset:a,assetListIndex:n,event:t,schedule:l,scheduleIndex:i,player:o});if(this.warn(`Asset item error: ${e.error}`),this.hls.trigger(E.INTERSTITIAL_ASSET_ERROR,c),!e.fatal)return;const u=new Error(r);a&&(this.playingAsset!==a&&this.clearAssetPlayer(a.identifier,null),a.error=u),t.assetList.some(d=>!d.error)?t.appendInPlace&&(t.error=u):t.error=u,this.primaryFallback(t)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;if(this.updateSchedule(),i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${i?Kt(i):"<none>"} error: ${e.error}`),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));let n=this.timelinePos;n===-1&&(n=this.hls.startPosition);const r=this.updateItem(i,n);if(this.itemsMatch(i,r))this.clearInterstitial(e,null);else{const a=this.schedule.findItemIndexAtTime(n);this.setSchedulePosition(a)}}else this.checkStart()}onAssetListLoaded(e,t){var i;const n=t.event,r=n.identifier,a=t.assetListResponse.ASSETS;if(!this.schedule.hasEvent(r))return;const o=n.timelineStart,l=n.duration;let c=0;a.forEach((g,y)=>{const S=parseFloat(g.DURATION);this.createAsset(n,y,c,o+c,S,g.URI),c+=S}),n.duration=c,this.log(`Loaded asset-list with duration: ${c} (was: ${l}) ${n}`);const u=this.waitingItem,d=(u==null?void 0:u.event.identifier)===r;this.updateSchedule();const f=(i=this.bufferingItem)==null?void 0:i.event;if(d){var p;const g=this.schedule.findEventIndex(r),y=(p=this.schedule.items)==null?void 0:p[g];if(y){if(!this.playingItem&&this.timelinePos>y.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==g){n.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${n}`),this.primaryFallback(n);return}this.setBufferingItem(y)}this.setSchedulePosition(g)}else if((f==null?void 0:f.identifier)===r&&f.appendInPlace){const g=n.assetList[0],y=this.getAssetPlayer(g.identifier),S=this.primaryMedia;g&&y&&S&&this.bufferAssetPlayer(y,S)}}onError(e,t){switch(t.details){case M.ASSET_LIST_PARSING_ERROR:case M.ASSET_LIST_LOAD_ERROR:case M.ASSET_LIST_LOAD_TIMEOUT:{const i=t.interstitial;i&&this.primaryFallback(i);break}case M.BUFFER_STALLED_ERROR:{this.onTimeupdate(),this.checkBuffer(!0);break}}}}const Od=500;class dy extends $u{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",re.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(E.LEVEL_LOADED,this.onLevelLoaded,this),e.on(E.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(E.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(E.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(E.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(E.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(E.LEVEL_LOADED,this.onLevelLoaded,this),e.off(E.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(E.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(E.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(E.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(E.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=$.IDLE,this.setInterval(Od),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:n}=t;if(Ye(i)&&(this.fragPrevious=i),this.state=$.IDLE,!n)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let a;const o=i.start;for(let c=0;c<r.length;c++)if(o>=r[c].start&&o<=r[c].end){a=r[c];break}const l=i.start+i.duration;a?a.end=l:(a={start:o,end:l},r.push(a)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:n}=t;if(i===0&&n!==Number.POSITIVE_INFINITY){const r=n-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(a=>{for(let o=0;o<a.length;){if(a[o].end<=r){a.shift();continue}else if(a[o].start<r)a[o].start=r;else break;o++}}),this.fragmentTracker.removeFragmentsInRange(i,r,re.SUBTITLE)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===re.SUBTITLE&&(t.details===M.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==$.STOPPED&&(this.state=$.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&md(this.levels,t)){this.levels=t.map(i=>new Vs(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const n=new Vs(i);return this.tracksBuffered[n.id]=[],n}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,re.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const n=this.levels[this.currentTrackId];n!=null&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.state!==$.STOPPED&&this.setInterval(Od)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:n,levels:r}=this,{details:a,id:o}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${o}`);return}const l=r[o];if(o>=r.length||!l)return;this.log(`Subtitle track ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(a.live||(i=l.details)!=null&&i.live){const d=this.mainDetails;if(a.deltaUpdateFailed||!d)return;const f=d.fragments[0];if(!l.details)a.hasProgramDateTime&&d.hasProgramDateTime?(Xs(a,d),c=a.fragmentStart):f&&(c=f.start,Gr(a,c));else{var u;c=this.alignPlaylists(a,l.details,(u=this.levelLastLoaded)==null?void 0:u.details),c===0&&f&&(c=f.start,Gr(a,c))}}l.details=a,this.levelLastLoaded=l,o===n&&(this.hls.trigger(E.SUBTITLE_TRACK_UPDATED,{details:a,id:o,groupId:t.groupId}),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===$.IDLE&&(Ti(null,a.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,n=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&n!=null&&n.key&&n.iv&&bi(n.method)){const a=performance.now();this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer,Mr(n.method)).catch(o=>{throw r.trigger(E.ERROR,{type:Z.MEDIA_ERROR,details:M.FRAG_DECRYPT_ERROR,fatal:!1,error:o,reason:o.message,frag:t}),o}).then(o=>{const l=performance.now();r.trigger(E.FRAG_DECRYPTED,{frag:t,payload:o,stats:{tstart:a,tdecrypt:l}})}).catch(o=>{this.warn(`${o.name}: ${o.message}`),this.state=$.IDLE})}}doTick(){if(!this.media){this.state=$.IDLE;return}if(this.state===$.IDLE){const{currentTrackId:e,levels:t}=this,i=t==null?void 0:t[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;const{config:n}=this,r=this.getLoadPosition(),a=be.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,n.maxBufferHole),{end:o,len:l}=a,c=i.details,u=this.hls.maxBufferLength+c.levelTargetDuration;if(l>u)return;const d=c.fragments,f=d.length,p=c.edge;let g=null;const y=this.fragPrevious;if(o<p){const L=n.maxFragLookUpTolerance,w=o>p-L?0:L;g=Ti(y,d,Math.max(d[0].start,o),w),!g&&y&&y.start<d[0].start&&(g=d[0])}else g=d[f-1];if(g=this.filterReplacedPrimary(g,i.details),!g)return;const S=g.sn-c.startSN,T=d[S-1];if(T&&T.cc===g.cc&&this.fragmentTracker.getState(T)===Xe.NOT_LOADED&&(g=T),this.fragmentTracker.getState(g)===Xe.NOT_LOADED){const L=this.mapToInitFragWhenRequired(g);L&&this.loadFragment(L,i,o)}}}loadFragment(e,t,i){Ye(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new hy(this.tracksBuffered[this.currentTrackId]||[])}}class hy{constructor(e){this.buffered=void 0;const t=(i,n,r)=>{if(n=n>>>0,n>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${r})`);return e[n][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const fy={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Md=s=>String.fromCharCode(fy[s]||s),ut=15,Dt=100,py={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},gy={17:2,18:4,21:6,22:8,23:10,19:13,20:15},my={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},yy={25:2,26:4,29:6,30:8,31:10,27:13,28:15},vy=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class Sy{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;ye.log(`${this.time} [${e}] ${i}`)}}}const ci=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class Fd{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const n=t[i];e.hasOwnProperty(n)&&(this[n]=e[n])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Ey{constructor(){this.uchar=" ",this.penState=new Fd}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class Ty{constructor(e){this.chars=[],this.pos=0,this.currPenState=new Fd,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<Dt;t++)this.chars.push(new Ey);this.logger=e}equals(e){for(let t=0;t<Dt;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<Dt;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<Dt;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Dt&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Dt)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Md(e);if(this.pos>=Dt){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<Dt;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<Dt;i++){const n=this.chars[i].uchar;n!==" "&&(t=!1),e.push(n)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class ua{constructor(e){this.rows=[],this.currRow=ut-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<ut;t++)this.rows.push(new Ty(e));this.logger=e}reset(){for(let e=0;e<ut;e++)this.rows[e].clear();this.currRow=ut-1}equals(e){let t=!0;for(let i=0;i<ut;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<ut;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<ut;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+Le(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let o=0;o<ut;o++)this.rows[o].clear();const r=this.currRow+1-this.nrRollUpRows,a=this.lastOutputScreen;if(a){const o=a.rows[r].cueStartTime,l=this.logger.time;if(o!==null&&l!==null&&o<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(a.rows[r+c])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,a=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[a].penState.foreground}const n={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+Le(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",n=-1;for(let r=0;r<ut;r++){const a=this.rows[r].getTextString();a&&(n=r+1,e?t.push("Row "+n+": '"+a+"'"):t.push(a.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class Nd{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new ua(i),this.nonDisplayedMemory=new ua(i),this.lastOutputScreen=new ua(i),this.currRollUpRow=this.displayedMemory.rows[ut-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[ut-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,n=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=n[i]}this.logger.log(2,"MIDROW: "+Le(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Ud{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=_y(),this.logger=void 0;const n=this.logger=new Sy;this.channels=[null,new Nd(e,t,n),new Nd(e+1,i,n)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const n=t[i]&127,r=t[i+1]&127;let a=!1,o=null;if(n===0&&r===0)continue;this.logger.log(3,()=>"["+ci([t[i],t[i+1]])+"] -> ("+ci([n,r])+")");const l=this.cmdHistory;if(n>=16&&n<=31){if(by(n,r,l)){fn(null,null,l),this.logger.log(3,()=>"Repeated command ("+ci([n,r])+") is dropped");continue}fn(n,r,this.cmdHistory),a=this.parseCmd(n,r),a||(a=this.parseMidrow(n,r)),a||(a=this.parsePAC(n,r)),a||(a=this.parseBackgroundAttributes(n,r))}else fn(null,null,l);if(!a&&(o=this.parseChars(n,r),o)){const u=this.currentChannel;u&&u>0?this.channels[u].insertChars(o):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!a&&!o&&this.logger.log(2,()=>"Couldn't parse cleaned data "+ci([n,r])+" orig: "+ci([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=33&&t<=35;if(!(i||n))return!1;const r=e===20||e===21||e===23?1:2,a=this.channels[r];return e===20||e===21||e===28||e===29?t===32?a.ccRCL():t===33?a.ccBS():t===34?a.ccAOF():t===35?a.ccAON():t===36?a.ccDER():t===37?a.ccRU(2):t===38?a.ccRU(3):t===39?a.ccRU(4):t===40?a.ccFON():t===41?a.ccRDC():t===42?a.ccTR():t===43?a.ccRTD():t===44?a.ccEDM():t===45?a.ccCR():t===46?a.ccENM():t===47&&a.ccEOC():a.ccTO(t-32),this.currentChannel=r,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const n=this.channels[i];return n?(n.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+ci([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const n=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,r=(e===16||e===24)&&t>=64&&t<=95;if(!(n||r))return!1;const a=e<=23?1:2;t>=64&&t<=95?i=a===1?py[e]:my[e]:i=a===1?gy[e]:yy[e];const o=this.channels[a];return o?(o.setPAC(this.interpretPAC(i,t)),this.currentChannel=a,!0):!1}interpretPAC(e,t){let i;const n={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,n.underline=(i&1)===1,i<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(n.italics=!0,n.color="white"):n.indent=Math.floor((i-16)/2)*4,n}parseChars(e,t){let i,n=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let a;r===17?a=t+80:r===18?a=t+112:a=t+144,this.logger.log(2,()=>"Special char '"+Md(a)+"' in channel "+i),n=[a]}else e>=32&&e<=127&&(n=t===0?[e]:[e,t]);return n&&this.logger.log(3,()=>"Char codes =  "+ci(n).join(",")),n}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=45&&t<=47;if(!(i||n))return!1;let r;const a={};e===16||e===24?(r=Math.floor((t-32)/2),a.background=vy[r],t%2===1&&(a.background=a.background+"_semi")):t===45?a.background="transparent":(a.foreground="black",t===47&&(a.underline=!0));const o=e<=23?1:2;return this.channels[o].setBkgData(a),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}fn(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function fn(s,e,t){t.a=s,t.b=e}function by(s,e,t){return t.a===s&&t.b===e}function _y(){return{a:null,b:null}}var da=function(){if(Ys!=null&&Ys.VTTCue)return self.VTTCue;const s=["","lr","rl"],e=["start","middle","end","left","right"];function t(o,l){if(typeof l!="string"||!Array.isArray(o))return!1;const c=l.toLowerCase();return~o.indexOf(c)?c:!1}function i(o){return t(s,o)}function n(o){return t(e,o)}function r(o,...l){let c=1;for(;c<arguments.length;c++){const u=arguments[c];for(const d in u)o[d]=u[d]}return o}function a(o,l,c){const u=this,d={enumerable:!0};u.hasBeenReset=!1;let f="",p=!1,g=o,y=l,S=c,T=null,L="",w=!0,x="auto",b="start",C=50,_="middle",k=50,D="middle";Object.defineProperty(u,"id",r({},d,{get:function(){return f},set:function(R){f=""+R}})),Object.defineProperty(u,"pauseOnExit",r({},d,{get:function(){return p},set:function(R){p=!!R}})),Object.defineProperty(u,"startTime",r({},d,{get:function(){return g},set:function(R){if(typeof R!="number")throw new TypeError("Start time must be set to a number.");g=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",r({},d,{get:function(){return y},set:function(R){if(typeof R!="number")throw new TypeError("End time must be set to a number.");y=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",r({},d,{get:function(){return S},set:function(R){S=""+R,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",r({},d,{get:function(){return T},set:function(R){T=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",r({},d,{get:function(){return L},set:function(R){const N=i(R);if(N===!1)throw new SyntaxError("An invalid or illegal string was specified.");L=N,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",r({},d,{get:function(){return w},set:function(R){w=!!R,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",r({},d,{get:function(){return x},set:function(R){if(typeof R!="number"&&R!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");x=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",r({},d,{get:function(){return b},set:function(R){const N=n(R);if(!N)throw new SyntaxError("An invalid or illegal string was specified.");b=N,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",r({},d,{get:function(){return C},set:function(R){if(R<0||R>100)throw new Error("Position must be between 0 and 100.");C=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",r({},d,{get:function(){return _},set:function(R){const N=n(R);if(!N)throw new SyntaxError("An invalid or illegal string was specified.");_=N,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",r({},d,{get:function(){return k},set:function(R){if(R<0||R>100)throw new Error("Size must be between 0 and 100.");k=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",r({},d,{get:function(){return D},set:function(R){const N=n(R);if(!N)throw new SyntaxError("An invalid or illegal string was specified.");D=N,this.hasBeenReset=!0}})),u.displayState=void 0}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a}();class xy{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function Bd(s){function e(i,n,r,a){return(i|0)*3600+(n|0)*60+(r|0)+parseFloat(a||0)}const t=s.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class Ay{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let n=0;n<i.length;++n)if(t===i[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function $d(s,e,t,i){const n=i?s.split(i):[s];for(const r in n){if(typeof n[r]!="string")continue;const a=n[r].split(t);if(a.length!==2)continue;const o=a[0],l=a[1];e(o,l)}}const ha=new da(0,0,""),pn=ha.align==="middle"?"middle":"center";function Iy(s,e,t){const i=s;function n(){const o=Bd(s);if(o===null)throw new Error("Malformed timestamp: "+i);return s=s.replace(/^[^\sa-zA-Z-]+/,""),o}function r(o,l){const c=new Ay;$d(o,function(f,p){let g;switch(f){case"region":for(let y=t.length-1;y>=0;y--)if(t[y].id===p){c.set(f,t[y].region);break}break;case"vertical":c.alt(f,p,["rl","lr"]);break;case"line":g=p.split(","),c.integer(f,g[0]),c.percent(f,g[0])&&c.set("snapToLines",!1),c.alt(f,g[0],["auto"]),g.length===2&&c.alt("lineAlign",g[1],["start",pn,"end"]);break;case"position":g=p.split(","),c.percent(f,g[0]),g.length===2&&c.alt("positionAlign",g[1],["start",pn,"end","line-left","line-right","auto"]);break;case"size":c.percent(f,p);break;case"align":c.alt(f,p,["start",pn,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let u=c.get("line","auto");u==="auto"&&ha.line===-1&&(u=-1),l.line=u,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",!0),l.size=c.get("size",100),l.align=c.get("align",pn);let d=c.get("position","auto");d==="auto"&&ha.position===50&&(d=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=d}function a(){s=s.replace(/^\s+/,"")}if(a(),e.startTime=n(),a(),s.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);s=s.slice(3),a(),e.endTime=n(),a(),r(s,e)}function jd(s){return s.replace(/<br(?: \/)?>/gi,`
`)}class wy{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new xy,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,a=0;for(r=jd(r);a<r.length&&r[a]!=="\r"&&r[a]!==`
`;)++a;const o=r.slice(0,a);return r[a]==="\r"&&++a,r[a]===`
`&&++a,t.buffer=r.slice(a),o}function n(r){$d(r,function(a,o){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const o=r.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(o!=null&&o[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let a=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(a?a=!1:r=i(),t.state){case"HEADER":/:/.test(r)?n(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new da(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{Iy(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const o=r.indexOf("-->")!==-1;if(!r||o&&(a=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const Ly=/\r\n|\n\r|\n|\r/g,fa=function(e,t,i=0){return e.slice(i,i+t.length)===t},ky=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!K(t)||!K(i)||!K(n)||!K(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*n,t+=60*60*1e3*r,t};function pa(s,e,t){return Zi(s.toString())+Zi(e.toString())+Zi(t)}const Cy=function(e,t,i){let n=e[t],r=e[n.prevCC];if(!r||!r.new&&n.new){e.ccOffset=e.presentationOffset=n.start,n.new=!1;return}for(;(a=r)!=null&&a.new;){var a;e.ccOffset+=n.start-r.start,n.new=!1,n=r,r=e[n.prevCC]}e.presentationOffset=i};function Ry(s,e,t,i,n,r,a){const o=new wy,l=Ke(new Uint8Array(s)).trim().replace(Ly,`
`).split(`
`),c=[],u=e?Zm(e.baseTime,e.timescale):0;let d="00:00.000",f=0,p=0,g,y=!0;o.oncue=function(S){const T=t[i];let L=t.ccOffset;const w=(f-u)/9e4;if(T!=null&&T.new&&(p!==void 0?L=t.ccOffset=T.start:Cy(t,i,w)),w){if(!e){g=new Error("Missing initPTS for VTT MPEGTS");return}L=w-t.presentationOffset}const x=S.endTime-S.startTime,b=Ze((S.startTime+L-p)*9e4,n*9e4)/9e4;S.startTime=Math.max(b,0),S.endTime=Math.max(b+x,0);const C=S.text.trim();S.text=decodeURIComponent(encodeURIComponent(C)),S.id||(S.id=pa(S.startTime,S.endTime,C)),S.endTime>0&&c.push(S)},o.onparsingerror=function(S){g=S},o.onflush=function(){if(g){a(g);return}r(c)},l.forEach(S=>{if(y)if(fa(S,"X-TIMESTAMP-MAP=")){y=!1,S.slice(16).split(",").forEach(T=>{fa(T,"LOCAL:")?d=T.slice(6):fa(T,"MPEGTS:")&&(f=parseInt(T.slice(7)))});try{p=ky(d)/1e3}catch(T){g=T}return}else S===""&&(y=!1);o.parse(S+`
`)}),o.flush()}const ga="stpp.ttml.im1t",Gd=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Vd=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Py={left:"start",center:"center",right:"end",start:"start",end:"end"};function qd(s,e,t,i){const n=te(new Uint8Array(s),["mdat"]);if(n.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=n.map(o=>Ke(o)),a=Xm(e.baseTime,1,e.timescale);try{r.forEach(o=>t(Dy(o,a)))}catch(o){i(o)}}function Dy(s,e){const n=new DOMParser().parseFromString(s,"text/xml").getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},a=Object.keys(r).reduce((d,f)=>(d[f]=n.getAttribute(`ttp:${f}`)||r[f],d),{}),o=n.getAttribute("xml:space")!=="preserve",l=Hd(ma(n,"styling","style")),c=Hd(ma(n,"layout","region")),u=ma(n,"body","[begin]");return[].map.call(u,d=>{const f=Kd(d,o);if(!f||!d.hasAttribute("begin"))return null;const p=va(d.getAttribute("begin"),a),g=va(d.getAttribute("dur"),a);let y=va(d.getAttribute("end"),a);if(p===null)throw Yd(d);if(y===null){if(g===null)throw Yd(d);y=p+g}const S=new da(p-e,y-e,f);S.id=pa(S.startTime,S.endTime,S.text);const T=c[d.getAttribute("region")],L=l[d.getAttribute("style")],w=Oy(T,L,l),{textAlign:x}=w;if(x){const b=Py[x];b&&(S.lineAlign=b),S.align=x}return Ie(S,w),S}).filter(d=>d!==null)}function ma(s,e,t){const i=s.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function Hd(s){return s.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function Kd(s,e){return[].slice.call(s.childNodes).reduce((t,i,n)=>{var r;return i.nodeName==="br"&&n?t+`
`:(r=i.childNodes)!=null&&r.length?Kd(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function Oy(s,e,t){const i="http://www.w3.org/ns/ttml#styling";let n=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=s!=null&&s.hasAttribute("style")?s.getAttribute("style"):null;return a&&t.hasOwnProperty(a)&&(n=t[a]),r.reduce((o,l)=>{const c=ya(e,i,l)||ya(s,i,l)||ya(n,i,l);return c&&(o[l]=c),o},{})}function ya(s,e,t){return s&&s.hasAttributeNS(e,t)?s.getAttributeNS(e,t):null}function Yd(s){return new Error(`Could not parse ttml timestamp ${s}`)}function va(s,e){if(!s)return null;let t=Bd(s);return t===null&&(Gd.test(s)?t=My(s,e):Vd.test(s)&&(t=Fy(s,e))),t}function My(s,e){const t=Gd.exec(s),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function Fy(s,e){const t=Vd.exec(s),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class gn{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class Ny{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Jd(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(E.MANIFEST_LOADING,this.onManifestLoading,this),e.on(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(E.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(E.FRAG_LOADING,this.onFragLoading,this),e.on(E.FRAG_LOADED,this.onFragLoaded,this),e.on(E.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(E.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(E.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(E.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(E.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(E.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(E.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(E.MANIFEST_LOADING,this.onManifestLoading,this),e.off(E.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(E.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(E.FRAG_LOADING,this.onFragLoading,this),e.off(E.FRAG_LOADED,this.onFragLoaded,this),e.off(E.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(E.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(E.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(E.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(E.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new gn(this,"textTrack1"),t=new gn(this,"textTrack2"),i=new gn(this,"textTrack3"),n=new gn(this,"textTrack4");this.cea608Parser1=new Ud(1,e,t),this.cea608Parser2=new Ud(3,i,n)}addCues(e,t,i,n,r){let a=!1;for(let o=r.length;o--;){const l=r[o],c=Uy(l[0],l[1],t,i);if(c>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),a=!0,c/(i-t)>.5))return}if(a||r.push([t,i]),this.config.renderTextTracksNatively){const o=this.captionsTracks[e];this.Cues.newCue(o,t,i,n)}else{const o=this.Cues.newCue(null,t,i,n);this.hls.trigger(E.CUES_PARSED,{type:"captions",cues:o,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:r}){const{unparsedVttFrags:a}=this;i===re.MAIN&&(this.initPTS[t.cc]={baseTime:n,timescale:r}),a.length&&(this.unparsedVttFrags=[],a.forEach(o=>{this.onFragLoaded(E.FRAG_LOADED,o)}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let n=0;n<i.textTracks.length;n++){const r=i.textTracks[n];if(zd(r,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:n}=this,{label:r,languageCode:a}=t[e],o=this.getExistingTrack(r,a);if(o)i[e]=o,Xi(i[e]),ey(i[e],n);else{const l=this.createTextTrack("captions",r,a);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,n={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(E.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,i){const n=this.media;if(n)return n.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:n}=this;Object.keys(n).forEach(r=>{Xi(n[r]),delete n[r]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Jd(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)Xi(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],n=i.some(r=>r.textCodec===ga);if(this.config.enableWebVTT||n&&this.config.enableIMSC1){if(md(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const a=this.media,o=a?un(a.textTracks):null;if(this.tracks.forEach((l,c)=>{let u;if(o){let d=null;for(let f=0;f<o.length;f++)if(o[f]&&zd(o[f],l)){d=o[f],o[f]=null;break}d&&(u=d)}if(u)Xi(u);else{const d=Wd(l);u=this.createTextTrack(d,l.name,l.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),o!=null&&o.length){const l=o.filter(c=>c!==null).map(c=>c.label);l.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const a=this.tracks.map(o=>({label:o.name,kind:o.type.toLowerCase(),default:o.default,subtitleTrack:o}));this.hls.trigger(E.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const n=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!n)return;const r=`textTrack${n[1]}`,a=this.captionsProperties[r];a&&(a.label=i.name,i.lang&&(a.languageCode=i.lang),a.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===re.MAIN){var i,n;const{cea608Parser1:r,cea608Parser2:a,lastSn:o}=this,{cc:l,sn:c}=t.frag,u=(i=(n=t.part)==null?void 0:n.index)!=null?i:-1;r&&a&&(c!==o+1||c===o&&u!==this.lastPartIndex+1||l!==this.lastCc)&&(r.reset(),a.reset()),this.lastCc=l,this.lastSn=c,this.lastPartIndex=u}}onFragLoaded(e,t){const{frag:i,payload:n}=t;if(i.type===re.SUBTITLE)if(n.byteLength){const r=i.decryptdata,a="stats"in t;if(r==null||!r.encrypted||a){const o=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),o&&o.textCodec===ga?this._parseIMSC1(i,n):this._parseVTTs(t)}}else this.hls.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;qd(t,this.initPTS[e.cc],n=>{this._appendCues(n,e.level),i.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},n=>{i.logger.log(`Failed to parse IMSC1: ${n}`),i.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:n})})}_parseVTTs(e){var t;const{frag:i,payload:n}=e,{initPTS:r,unparsedVttFrags:a}=this,o=r.length-1;if(!r[i.cc]&&o===-1){a.push(e);return}const l=this.hls,c=(t=i.initSegment)!=null&&t.data?Qe(i.initSegment.data,new Uint8Array(n)).buffer:n;Ry(c,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),l.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const d=u.message==="Missing initPTS for VTT MPEGTS";d?a.push(e):this._fallbackToIMSC1(i,n),l.logger.log(`Failed to parse VTT cue: ${u}`),!(d&&o>i.cc)&&l.trigger(E.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||qd(t,this.initPTS[e.cc],()=>{i.textCodec=ga,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||n.mode==="disabled")return;e.forEach(r=>kd(n,r))}else{const n=this.tracks[t];if(!n)return;const r=n.default?"default":"subtitles"+t;i.trigger(E.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===re.SUBTITLE&&this.onFragLoaded(E.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:n}=t;if(!(i.type===re.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let r=0;r<n.length;r++){const a=n[r].bytes;if(a){this.cea608Parser1||this.initCea608Parsers();const o=this.extractCea608Data(a);this.cea608Parser1.addData(n[r].pts,o[0]),this.cea608Parser2.addData(n[r].pts,o[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:n,type:r}){const{media:a}=this;if(!(!a||a.currentTime<i)){if(!r||r==="video"){const{captionsTracks:o}=this;Object.keys(o).forEach(l=>Cd(o[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&n!==void 0){const{textTracks:o}=this;Object.keys(o).forEach(l=>Cd(o[l],t,n))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let n=2;for(let r=0;r<i;r++){const a=e[n++],o=127&e[n++],l=127&e[n++];if(o===0&&l===0)continue;if((4&a)!==0){const u=3&a;(u===0||u===1)&&(t[u].push(o),t[u].push(l))}}return t}}function Wd(s){return s.characteristics&&/transcribes-spoken-dialog/gi.test(s.characteristics)&&/describes-music-and-sound/gi.test(s.characteristics)?"captions":"subtitles"}function zd(s,e){return!!s&&s.kind===Wd(e)&&ia(e,s)}function Uy(s,e,t,i){return Math.min(e,i)-Math.max(s,t)}function Jd(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const By=/\s/,$y={newCue(s,e,t,i){const n=[];let r,a,o,l,c;const u=self.VTTCue||self.TextTrackCue;for(let f=0;f<i.rows.length;f++)if(r=i.rows[f],o=!0,l=0,c="",!r.isEmpty()){var d;for(let y=0;y<r.chars.length;y++)By.test(r.chars[y].uchar)&&o?l++:(c+=r.chars[y].uchar,o=!1);r.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const p=jd(c.trim()),g=pa(e,t,p);s!=null&&(d=s.cues)!=null&&d.getCueById(g)||(a=new u(e,t,p),a.id=g,a.line=f+1,a.align="left",a.position=10+Math.min(80,Math.floor(l*8/32)*10),n.push(a))}return s&&n.length&&(n.sort((f,p)=>f.line==="auto"||p.line==="auto"?0:f.line>8&&p.line>8?p.line-f.line:f.line-p.line),n.forEach(f=>kd(s,f))),n}},jy=/^age:\s*[\d.]+\s*$/im;class Gy{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new Up,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,n=this.stats;n.loading.first=0,n.loaded=0,n.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return r(i,t.url)}).catch(a=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),r(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(a=>{var o;(o=this.callbacks)==null||o.onError({code:i.status,text:a.message},t,i,n)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const n=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:a}=i.loadPolicy;if(n)for(const o in n)e.setRequestHeader(o,n[o]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&K(r)?r:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const n=t.readyState,r=this.config;if(!i.aborted&&n>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),n===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const c=t.status,u=t.responseType==="text"?t.responseText:null;if(c>=200&&c<300){const g=u??t.response;if(g!=null){var a,o;i.loading.end=Math.max(self.performance.now(),i.loading.first);const y=t.responseType==="arraybuffer"?g.byteLength:g.length;i.loaded=i.total=y,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);const S=(a=this.callbacks)==null?void 0:a.onProgress;S&&S(i,e,g,t);const T={url:t.responseURL,data:g,code:c};(o=this.callbacks)==null||o.onSuccess(T,i,e,t);return}}const d=r.loadPolicy.errorRetry,f=i.retry,p={url:e.url,data:void 0,code:c};if(Hs(d,f,!1,p))this.retry(d);else{var l;ye.error(`${c} while loading ${e.url}`),(l=this.callbacks)==null||l.onError({code:c,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Hs(e,t,!0))this.retry(e);else{var i;ye.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const n=this.callbacks;n&&(this.abortInternal(),n.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=Dr(e,i.retry),i.retry++,ye.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t==null?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&jy.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const Vy={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null};xe(xe({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:Gy,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Tg,bufferController:g0,capLevelController:na,errorController:wg,fpsController:Z0,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:ku,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,certLoadPolicy:{default:Vy},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},qy()),{},{subtitleStreamController:dy,subtitleTrackController:sy,timelineController:Ny,audioStreamController:d0,audioTrackController:h0,emeController:Li,cmcdController:J0,contentSteeringController:X0,interstitialsController:uy});function qy(){return{cueHandler:$y,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function Hy(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}(()=>{const s=Hy();try{s&&new s(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})(),window.initVapiWidget=function(s="vapi-widget",e=[]){const t="d3291bfe-9e60-4a16-9752-64438bbeb4b9",i=new Map(e.map(_=>[_.language,_.assistantId])),n=`
    .vapi-container {
      font-family: sans-serif;
      position: relative;
    }

    .vapi-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: white;
      border-radius: 9999px;
      padding: 10px 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      gap: 12px;
      width: 250px;
      height: 45px;
    }

    @media (min-width: 640px) {
      .vapi-box {
        flex-direction: row;
      }
    }

  .vapi-ring {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  overflow: hidden; /* clip video edges */
  position: relative;
  animation: glowShadows 1s ease-in-out infinite alternate;
}


    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .vapi-ring.pulse-green {
      border-color: #22c55e;
      animation: pulse 1s infinite;
    }

    .vapi-ring.pulse-blue {
      border-color: #3b82f6;
      animation: pulse 1s infinite;
    }

    .vapi-ring.spin-yellow {
      border-color: #facc15;
      animation: spin 1s linear infinite;
    }

    .vapi-ring.gray {
      border-color: #d1d5db;
    }

    .vapi-status {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }

    .vapi-button {
 display: inline-flex;
      /* Center horizontally */
  align-items: center;         /* Center vertically */
  width: 130px;
  padding: 8px 8px;
  border-radius: 9999px;
  
  font-size: 14px;
  cursor: pointer;
 
  border: none;
  transition: all 0.2s ease;
  gap: 8px;
}

.vapi-button.no-icon {
  gap: 0;  /* Remove space if there's no icon */
}


    .vapi-button.vapi-start {
      background-color: black;
      color: white;
    }

    .vapi-button.vapi-end {
      background-color: #dc2626;
      color: white;
    }

   .vapi-lang-toggle {
  display: flex;
  align-items: center;
  border: 2px solid rgb(35, 104, 3);
  border-radius: 9999px;
  background-color: white;
  padding: 6px 4px;
  gap: 4px;
  cursor: pointer;
  width: 100%;
  
}
  .vapi-flag-circle {
  width: 16px;
  height: 16px;
  border: 1px solid rgb(35, 104, 3);
  border-radius: 50%;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.vapi-flags {
  width: 150%;
  height: 150%;
  display: block;
}

.vapi-dropdown-icon {
  font-size: 18px;
  color: black;
}


    .vapi-dropdown {
      position: absolute;
      
      margin-top: 8px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      width: 120px;
    }
    .vapi-dropdown-up {
  bottom: 100%;
  top: auto;
  margin-bottom: 4px;
}

    .vapi-dropdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .vapi-dropdown-item:hover {
      background-color: #f3f4f6;
    }

    .vapi-lang-label {
      color: black;
    }

    .vapi-flag {
      width: 20px;
      height: 14px;
      border-radius: 2px;
    }
  
   .vapi-orb {
  position: relative;
  width: 120px; /* adjust size as needed */
  height: 120px;
  border-radius: 50%;
  overflow: hidden;
}

.orb-core-gif {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  pointer-events: none;
}
.orb-core-video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
  pointer-events: none;
}
.orb {
  --radius: 38%; /* responsive wave size */
  width: 100%;
  height: 100%;
  border-radius: 50%;
  position: relative;
  overflow: hidden;
  background: linear-gradient(
    135deg,
    rgba(3, 255, 247, 0.992),
    rgba(35, 104, 3, 0.497),
    rgb(160, 190, 250)
  );
  background-size: 300% 300%;
  animation: colorCycle 12s ease-in-out infinite, glowShadow 1s ease-in-out infinite alternate;
  filter: saturate(1.2);
}
 @keyframes glowShadows {
  0% {
    box-shadow: 0 0 8px 1px rgba(198, 218, 209, 0.5);
  }
  50% {
    box-shadow: 0 0 12px 2px rgba(198, 218, 209, 0.9);
  }
  100% {
    box-shadow: 0 0 8px 1px rgba(198, 218, 209, 0.7);
  }
}


    @keyframes glowShadow {
      0% {
        box-shadow: inset 0 0 18px rgba(198, 218, 209, 0.7), 0 4px 10px rgba(198, 218, 209, 0.5);
      }
      50% {
        box-shadow: inset 0 0 22px rgba(198, 218, 209, 1), 0 5px 12px rgba(198, 218, 209, 0.9);
      }
      100% {
        box-shadow: inset 0 0 18px rgba(198, 218, 209, 0.944), 0 4px 10px rgba(198, 218, 209, 0.723);
      }
    }

    .orb::before,
    .orb::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 25%;
      left: 0;
      pointer-events: none;
      z-index: 2;
      filter: blur(6px);
    }

    .orb::before {
      top: 0;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.45), transparent);
      border-top-left-radius: 50% 40%;
      border-top-right-radius: 50% 40%;
    }

    .orb::after {
      bottom: 0;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.35), transparent);
      border-bottom-left-radius: 50% 40%;
      border-bottom-right-radius: 50% 40%;
    }

    .waves-wrapper {
      position: absolute;
      inset: 0;
      filter: url('#filter');
    }

   .wave {
  position: absolute;
  width: var(--radius);
  height: var(--radius);
  top: calc(50% - var(--radius) / 2);
  left: calc(50% - var(--radius) / 2);
  border-radius: 50%;
  background: linear-gradient(
    45deg,
    rgba(255, 255, 255, 0.3),
    rgba(11, 51, 53, 0.9),
    rgba(66, 245, 84, 0.8)
  );
  filter: blur(4px);
  mix-blend-mode: screen;
}


    .wave:nth-child(1) {
      transform: translate(calc(-1.1 * var(--radius)));
      animation: x-axis-lateral 2s infinite alternate ease-in-out;
      background: rgba(180, 160, 240, 0.8);
    }

    .wave:nth-child(1)::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(180, 160, 240, 0.5);
      filter: blur(3px);
      animation: y-axis-lateral 1s infinite 0.1s alternate ease-in-out;
    }

    .wave:nth-child(2) {
      animation: x-axis 2s infinite alternate ease-in-out;
      background: rgba(35, 104, 3, 0.8);
    }

    .wave:nth-child(2)::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(230, 160, 210, 0.5);
      filter: blur(3px);
      animation: y-axis 1s infinite 0.5s alternate ease-in-out;
    }

    .wave:nth-child(3) {
      transform: translate(calc(1.1 * var(--radius)), calc(1.3 * var(--radius)));
      animation: x-axis-lateral 2s infinite alternate ease;
      background: rgba(160, 190, 250, 0.7);
    }

    .wave:nth-child(3)::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(160, 190, 250, 0.4);
      filter: blur(3px);
      animation: y-axis-lateral 1s infinite 0.4s alternate ease-in-out;
    }

    @keyframes x-axis {
      0% { transform: translate(calc(-1.6 * var(--radius))); }
      100% { transform: translate(calc(1.6 * var(--radius))); }
    }

    @keyframes y-axis {
      0% { transform: translateY(calc(0.7 * var(--radius))); background:rgb(11, 51, 53); }
      100% { transform: translateY(calc(-1.1 * var(--radius))) scale(0.8); background:rgb(11, 51, 53); }
    }

    @keyframes x-axis-lateral {
      0% { transform: translate(calc(-0.6 * var(--radius))); }
      100% { transform: translate(calc(0.6 * var(--radius))); }
    }

    @keyframes y-axis-lateral {
      0% { transform: translateY(calc(var(--radius) / 5)); background:rgb(11, 51, 53); }
      100% { transform: translateY(calc(-1 * var(--radius))); background:rgb(11, 51, 53); }
    }

    @keyframes colorCycle {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  `,r=document.createElement("style");r.innerHTML=n,document.head.appendChild(r);const a=document.getElementById(s);if(!a){console.warn("Vapi widget container not found:",s);return}let o=!1,l=!1,c=!1,u=!1,d="",f=null,p="en-US",g=!1;const y=[{code:"en-US",flag:"https://flagcdn.com/us.svg",label:"English"},{code:"es-ES",flag:"https://flagcdn.com/es.svg",label:"Español"},{code:"fr-FR",flag:"https://flagcdn.com/fr.svg",label:"Français"},{code:"de-DE",flag:"https://flagcdn.com/de.svg",label:"Deutsch"},{code:"it-IT",flag:"https://flagcdn.com/it.svg",label:"Italiano"},{code:"pt-PT",flag:"https://flagcdn.com/pt.svg",label:"Português"},{code:"zh-CN",flag:"https://flagcdn.com/cn.svg",label:"中文"},{code:"ja-JP",flag:"https://flagcdn.com/jp.svg",label:"日本語"},{code:"ko-KR",flag:"https://flagcdn.com/kr.svg",label:"한국어"},{code:"ar-SA",flag:"https://flagcdn.com/sa.svg",label:"العربية"},{code:"ru-RU",flag:"https://flagcdn.com/ru.svg",label:"Русский"}],S=y.filter(_=>i.has(_.code)),T=document.createElement("div");T.className="vapi-container";function L(){let _="gray";c?_="pulse-green":u?_="pulse-blue":l&&(_="spin-yellow"),T.innerHTML=`
       <svg style="display:none">
    <defs>
      <filter id="filter">
        <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 28 -10" result="filter" />
        <feComposite in="SourceGraphic" in2="filter" operator="atop" />
      </filter>
    </defs>
  </svg>
      <div class="vapi-box">
        <div class="vapi-ring ${_}">
        <div class="orb">
    <div class="waves-wrapper">
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>
  </div>
    </div>

        <div style="position: relative; display: inline-block;">
  <div class="vapi-status" style="
    position: absolute;
    top: -16px; /* Adjust to control vertical spacing */
    left: 50%;
    transform: translateX(-50%);
    min-height: 10px;
    font-size: 12px;
    color: #555;
    width: 150px;
    text-align: center;
  ">
    ${d}
  </div>

  <button id="vapi-button" class="vapi-button ${o?"vapi-end":"vapi-start"} ">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" style="fill: white; margin-right: 1px;" viewBox="0 0 16 16">
    <path d="M3.654 1.328a.678.678 0 0 1 .58-.328h1.716c.236 0 .45.133.558.34l1.296 2.59a.678.678 0 0 1-.141.791L6.163 6.883a11.72 11.72 0 0 0 4.025 4.025l1.162-1.204a.678.678 0 0 1 .792-.14l2.59 1.296a.678.678 0 0 1 .34.558v1.716a.678.678 0 0 1-.328.58c-.758.478-1.66.724-2.568.724-5.418 0-9.817-4.4-9.817-9.818 0-.908.246-1.81.724-2.568z"/>
  </svg>
    ${o?"&nbsp;&nbsp;&nbsp;&nbsp;End":"Voice Call"}
  </button>
</div>

        <div style="position: relative;">
          
          <div class="vapi-lang-toggle" id="vapi-lang-toggle">
  <div class="vapi-flag-circle">
    <img class="vapi-flags" src="${y.find(k=>k.code===p).flag}" alt="Flag" />
  </div>
  <svg class="vapi-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="darkgreen" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
  </svg>
</div>

          ${g?`<div class="vapi-dropdown vapi-dropdown-up">
                ${S.map(k=>`
                  <div class="vapi-dropdown-item" data-lang="${k.code}">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <img src="${k.flag}" class="vapi-flag" alt="${k.code}" />
                      <span class="vapi-lang-label">${k.label}</span>
                    </div>
                    ${k.code===p?"✔":""}
                  </div>
                `).join("")}
              </div>`:""}
        </div>
      </div>
    `,a.innerHTML="",a.appendChild(T),document.getElementById("vapi-button").onclick=o?b:x,document.getElementById("vapi-lang-toggle").onclick=()=>{g=!g,L()},document.querySelectorAll(".vapi-dropdown-item").forEach(k=>{k.onclick=()=>{p=k.getAttribute("data-lang"),g=!1,L()}})}function w(_){d=_,L()}function x(){if(!f)return;l=!0,w("Connecting...");const _=i.get(p);if(!_){w("Assistant ID not found for language: "+p);return}f.start(_)}function b(){f&&(f.stop(),o=!1,c=!1,u=!1,w(""))}function C(){f=new Ip(t),f.on("call-start",()=>{o=!0,l=!1,w("Connected")}),f.on("call-end",()=>{o=!1,w("")}),f.on("speech-start",()=>{c=!0,u=!1,w("Talk to interrupt")}),f.on("speech-end",()=>{c=!1,w("Listening...")}),f.on("transcript",_=>{_.isFinal?u=!1:(u=!0,c=!1,w("Listening..."))}),L()}C()}})();
